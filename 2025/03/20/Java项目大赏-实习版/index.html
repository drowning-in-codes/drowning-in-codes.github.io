<!doctypehtml><html lang=zh-CN><script defer src=/live2d-widget/autoload.js></script><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content="Hexo 5.4.0" name=generator><link href=/images/blog_32px.png rel=apple-touch-icon sizes=180x180><link href=/images/blog_32px.png rel=icon sizes=32x32 type=image/png><link href=/images/blog_16px.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><meta content=EPrJAp11bJwHULpQUaSNSZ8_3RcvTsPDAEGOME4pl1w name=google-site-verification><!-- Google tag (gtag.js) --><!-- 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB21D8MKKW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VB21D8MKKW');
</script> --><!-- google adsense in head.swig --><script async crossorigin=anonymous src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123></script><meta content=7226864CE87CE9DE8C008385273846FF name=msvalidate.01><meta content=code-fjFXVtiL7j name=baidu-site-verification><link href=/css/main.css rel=stylesheet><link as=style href=https://fonts.googleapis.com/css?family=Roboto%20Mono,Roboto:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext onload=this.rel='stylesheet' rel=preload><link as=style href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css onload=this.rel='stylesheet' rel=preload><link href=https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap rel=stylesheet><link href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/pace-js@1/pace.min.js></script><script id=hexo-configurations>var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.sekyoro.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":240,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"0F9LEEVW82","apiKey":"78839e9f9be09d081c5c4da81975cd19","indexName":"sekyoblog_sec","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};</script><link href=//cdn.bootcss.com/animate.css/3.5.0/animate.min.css rel=stylesheet><meta content=æœ€è¿‘åœ¨å‡†å¤‡å®ä¹ ,æ‰¾ä¸€äº›çƒ‚å¤§è¡—ç»å…¸é¡¹ç›®ç»ƒç»ƒæ‰‹. name=description><meta content=article property=og:type><meta content=Javaé¡¹ç›®å¤§èµ(å®ä¹ ç‰ˆ) property=og:title><meta content=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/index.html property=og:url><meta content=Sekyoroçš„åšå®¢å°å±‹ property=og:site_name><meta content=æœ€è¿‘åœ¨å‡†å¤‡å®ä¹ ,æ‰¾ä¸€äº›çƒ‚å¤§è¡—ç»å…¸é¡¹ç›®ç»ƒç»ƒæ‰‹. property=og:description><meta content=zh_CN property=og:locale><meta content=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png property=og:image><meta content=https://s2.loli.net/2025/04/22/QKmht3v8O4pyAPC.png property=og:image><meta content=https://s2.loli.net/2025/04/23/28JgwEfF7bZNsQz.png property=og:image><meta content=https://s2.loli.net/2025/04/29/J3v6auIHbXNZxkT.png property=og:image><meta content=https://s2.loli.net/2025/04/30/iE9YtUfMhqRXn46.png property=og:image><meta content=https://s2.loli.net/2025/04/12/TEPKoIHGYOma4Jy.png property=og:image><meta content=https://s2.loli.net/2025/04/13/IPJL4xzF2aGAOfN.png property=og:image><meta content=https://s2.loli.net/2025/04/13/VKJzFQulyvWTSfa.png property=og:image><meta content=https://s2.loli.net/2025/03/20/VqbA8F34U17C9xZ.png property=og:image><meta content=https://s2.loli.net/2025/04/14/xZREAUpPzkQBiVF.png property=og:image><meta content=https://s2.loli.net/2025/04/14/bVvPz25pxkyMqB9.png property=og:image><meta content=https://s2.loli.net/2025/07/15/5lLUKEwJnexXoua.png property=og:image><meta content=https://s2.loli.net/2025/04/14/36voF12n9YepEkI.png property=og:image><meta content=https://s2.loli.net/2025/04/14/sUTIzrhMgqNpR7H.png property=og:image><meta content=https://s2.loli.net/2025/04/14/HTdpXizlnASGQqv.png property=og:image><meta content=https://s2.loli.net/2025/04/14/jc9OQH8oFwMLz5K.png property=og:image><meta content=https://s2.loli.net/2025/04/15/p72NIzH9MfZaxnR.png property=og:image><meta content=https://s2.loli.net/2025/04/15/y7bowaDxTL2f8GJ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/TU3KbireNcB4G67.png property=og:image><meta content=https://s2.loli.net/2025/04/15/CFEZY2mKqnwljAW.png property=og:image><meta content=https://s2.loli.net/2025/04/15/LqgUJKSZD9Gfad6.png property=og:image><meta content=https://s2.loli.net/2025/04/15/MozbdO6Ly2aCI4E.png property=og:image><meta content=https://s2.loli.net/2025/04/15/aujZnwSzgiUxloL.png property=og:image><meta content=https://s2.loli.net/2025/04/15/xBTlfUn6WmDpwIJ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/Tcd5tCruUKo6wvM.png property=og:image><meta content=https://s2.loli.net/2025/04/15/x5ayubhtcrSK8qQ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/EBpdcml8I7tLvxU.png property=og:image><meta content=https://s2.loli.net/2025/04/15/3LSmM7p8e5gfXcN.png property=og:image><meta content=https://s2.loli.net/2025/04/15/tXm5rvyNMhbxeYL.png property=og:image><meta content=https://s2.loli.net/2025/04/16/zTXyB8Uo7RKWmc2.png property=og:image><meta content=https://s2.loli.net/2025/04/16/9QRuCerNJpmcHaf.png property=og:image><meta content=https://s2.loli.net/2025/04/16/3tu9mqXVNyoDZYT.png property=og:image><meta content=https://s2.loli.net/2025/04/16/eCKmRn4QDs7pSLA.png property=og:image><meta content=https://s2.loli.net/2025/04/17/t4sZY1NizPOvRcX.png property=og:image><meta content=https://s2.loli.net/2025/04/17/JBC3Xe1HPmpfnwa.png property=og:image><meta content=https://s2.loli.net/2025/04/17/X7GMsSg59QjnaRf.png property=og:image><meta content=https://s2.loli.net/2025/04/17/AG1vHk7s2u6FexB.png property=og:image><meta content=https://s2.loli.net/2025/04/17/2jkGcgNIYylmQL8.png property=og:image><meta content=https://s2.loli.net/2025/04/17/lytxPu8ZirBRH5s.png property=og:image><meta content=https://s2.loli.net/2025/04/17/EYhwIoeVBgmkHfU.png property=og:image><meta content=https://s2.loli.net/2025/04/17/UiIyGpJA4RoP7Dh.png property=og:image><meta content=https://s2.loli.net/2025/04/18/cn3NCI9O24upUlg.png property=og:image><meta content=https://s2.loli.net/2025/04/18/IRiKpLMBV1cCUs3.png property=og:image><meta content=https://s2.loli.net/2025/04/18/bS3QAUKsTHoRY1q.png property=og:image><meta content=https://s2.loli.net/2025/04/18/ayrfSevJ8TdGUF3.png property=og:image><meta content=https://s2.loli.net/2025/04/18/9ih5CDwLBlKNERW.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2014/11/pubsub2.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2014/11/pubsub1.png property=og:image><meta content=https://s2.loli.net/2025/04/18/7LEADu5klUBta8Q.png property=og:image><meta content=https://s2.loli.net/2025/04/18/2lE9g7iU3WBpsIy.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2020/09/en-us_image_0167982791.png property=og:image><meta content=https://s2.loli.net/2025/04/18/N41xhBcZ6qTWUiG.png property=og:image><meta content=https://s2.loli.net/2025/04/18/JE9ZNCxDHaBWpw1.png property=og:image><meta content=https://s2.loli.net/2025/04/18/oTspnQeVrkqgOcv.png property=og:image><meta content=https://s2.loli.net/2025/04/18/sVrCm1K7YTewhaq.png property=og:image><meta content=https://s2.loli.net/2025/04/18/ay8uA5fSi3RvTMV.png property=og:image><meta content=https://s2.loli.net/2025/04/19/4rg9LteAzoDlaWb.png property=og:image><meta content=https://s2.loli.net/2025/04/19/muwJasz9gGTxAHK.png property=og:image><meta content=https://s2.loli.net/2025/04/20/p92Zqc4evEjimXY.png property=og:image><meta content=https://s2.loli.net/2025/04/20/Y2jI3QHEemkOBvi.png property=og:image><meta content=https://s2.loli.net/2025/04/20/OqkUF4G21LYZM5K.png property=og:image><meta content=https://s2.loli.net/2025/04/20/hNcu5avy2WmPBMk.png property=og:image><meta content=https://s2.loli.net/2025/04/20/thV71ZUKQlaqs3i.png property=og:image><meta content=https://s2.loli.net/2025/04/20/gCqrxOB86TdfhLb.png property=og:image><meta content=https://s2.loli.net/2025/04/21/8wXL5PpFBWu1c6K.png property=og:image><meta content=https://s2.loli.net/2025/04/21/9IYeW5iocs3u1PB.png property=og:image><meta content=https://s2.loli.net/2025/04/22/61cqOWxZMwnfemh.png property=og:image><meta content=https://s2.loli.net/2025/04/22/aGspbuONkSMdqxf.png property=og:image><meta content=https://s2.loli.net/2025/04/22/dfuNzSwYlVOsJD1.png property=og:image><meta content=https://s2.loli.net/2025/04/22/MEm6zF5nt28TBch.png property=og:image><meta content=https://s2.loli.net/2025/04/22/ztXRO9DFqkU68xV.png property=og:image><meta content=https://s2.loli.net/2025/05/02/C8LFUSamDZfsJPA.png property=og:image><meta content=https://s2.loli.net/2025/05/02/WABFut1yEYeLSPa.png property=og:image><meta content=https://s2.loli.net/2025/05/02/XZeaDzgW8tl5LMA.png property=og:image><meta content=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png property=og:image><meta content=https://s2.loli.net/2025/07/22/XnkZECm7cG23dlD.png property=og:image><meta content=https://s2.loli.net/2025/05/05/vODxw84bH7LguBa.png property=og:image><meta content=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png property=og:image><meta content=https://s2.loli.net/2025/07/21/qXQrNahUbLdZw5p.png property=og:image><meta content=https://s2.loli.net/2025/07/21/Mf9eRWBC2mu1plw.png property=og:image><meta content=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png property=og:image><meta content=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png property=og:image><meta content=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png property=og:image><meta content=https://s2.loli.net/2025/07/21/y6cuUbi5AOKPRVr.png property=og:image><meta content=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png property=og:image><meta content=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png property=og:image><meta content=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png property=og:image><meta content=https://s2.loli.net/2025/05/14/Wpwxn17jzJYgNiZ.png property=og:image><meta content=https://s2.loli.net/2025/05/14/IouNVMneLkvw5xd.png property=og:image><meta content=https://s2.loli.net/2025/05/14/fHxKr3uUjsJwGTV.png property=og:image><meta content=https://s2.loli.net/2025/05/14/VIFQjYLmdoMyuT4.png property=og:image><meta content=https://s2.loli.net/2025/05/14/AYdCIP8NLceGyig.png property=og:image><meta content=https://s2.loli.net/2025/05/14/gfJ2BtnGVdkwj4a.png property=og:image><meta content=https://s2.loli.net/2025/05/14/PWJutmFC9iZyXNn.png property=og:image><meta content=https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/logback-6ba1b465-5533-49dd-b875-48a10ba29f8e.png property=og:image><meta content=https://s2.loli.net/2025/07/22/Udzg4jYavtVsL3Z.png property=og:image><meta content=2025-03-20T09:38:06.000Z property=article:published_time><meta content=2025-07-24T09:40:39.045Z property=article:modified_time><meta content=Sekyoro property=article:author><meta content=Java property=article:tag><meta content=summary name=twitter:card><meta content=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png name=twitter:image><link href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ rel=canonical><script id=page-configurations>// https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };</script><title>Javaé¡¹ç›®å¤§èµ(å®ä¹ ç‰ˆ) | Sekyoroçš„åšå®¢å°å±‹</title><noscript><style>.use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }</style></noscript><link href=/atom.xml rel=alternate title=Sekyoroçš„åšå®¢å°å±‹ type=application/atom+xml><body itemscope itemtype=http://schema.org/WebPage><canvas style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" class=fireworks></canvas><script defer src=https://cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script defer src=/js/src/fireworks.js></script><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div aria-label=åˆ‡æ¢å¯¼èˆªæ  class=toggle><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <span class=logo-line-before><i></i></span> <h1 class=site-title>Sekyoroçš„åšå®¢å°å±‹</h1> <span class=logo-line-after><i></i></span> </a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu" id=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>å…³äº</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a><li class="menu-item menu-item-bangumis"><a href=/bangumis/ rel=section><i class="fa fa-film fa-fw"></i>è¿½ç•ª</a><li class="menu-item menu-item-resume"><a href=/resume/ rel=section><i class="fa fa-file-pdf fa-fw"></i>ç®€å†</a><li class="menu-item menu-item-materials"><a href=/materials/ rel=section><i class="fa fa-book fa-fw"></i>å­¦ä¹ èµ„æ–™</a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>ç«™ç‚¹åœ°å›¾</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>æœç´¢ </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container></div><span class=popup-btn-close> <i class="fa fa-times-circle"></i> </span></div><div class=algolia-results><div id=algolia-stats></div><div id=algolia-hits></div><div class=algolia-pagination id=algolia-pagination></div></div></div></div></div></header><a class="book-mark-link book-mark-link-fixed" role=button></a><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article class=post-block itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg itemprop=image> <meta content=Sekyoro itemprop=name> <meta content=ä»€ä¹ˆä¹Ÿæ— æ³•èˆå¼ƒçš„äººï¼Œä»€ä¹ˆä¹Ÿåšä¸äº†. itemprop=description> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=Sekyoroçš„åšå®¢å°å±‹ itemprop=name> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Javaé¡¹ç›®å¤§èµ(å®ä¹ ç‰ˆ)</h1><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>å‘è¡¨äº</span> <time itemprop="dateCreated datePublished" title="åˆ›å»ºæ—¶é—´ï¼š2025-03-20 17:38:06" datetime=2025-03-20T17:38:06+08:00>2025-03-20</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-07-24 17:40:39" datetime=2025-07-24T17:40:39+08:00 itemprop=dateModified>2025-07-24</time> </span><span style="display: none;" class=post-meta-item id=busuanzi_container_page_pv title=é˜…è¯»æ¬¡æ•°> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=post-meta-item-text>é˜…è¯»æ¬¡æ•°ï¼š</span> <span id=busuanzi_value_page_pv></span> </span><br><span class=post-meta-item title=æœ¬æ–‡å­—æ•°> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>æœ¬æ–‡å­—æ•°ï¼š</span> <span>69k</span> </span><span class=post-meta-item title=é˜…è¯»æ—¶é•¿> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>é˜…è¯»æ—¶é•¿ â‰ˆ</span> <span>1:03</span> </span></div></header><div class=post-body itemprop=articleBody><p>æœ€è¿‘åœ¨å‡†å¤‡å®ä¹ ,æ‰¾ä¸€äº›<del>çƒ‚å¤§è¡—</del>ç»å…¸é¡¹ç›®ç»ƒç»ƒæ‰‹.<br><span id=more></span><h1 id=è‹ç©¹å¤–å–><a class=headerlink href=#è‹ç©¹å¤–å– title=è‹ç©¹å¤–å–></a>è‹ç©¹å¤–å–</h1><p>ä¸€ä¸ªé¡¹ç›®é€šå¸¸åŒ…å«å…¬å…±ç±»(å¸¸é‡,å·¥å…·ä»¥åŠå¼‚å¸¸)éƒ¨åˆ†ä»¥åŠå®ä½“ç±»éƒ¨åˆ†<p><img alt=image-20250422144407360 data-src=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png><p>æ­¤å¤–è¿˜æœ‰service,controller,mapper(repository)å±‚ä»¥åŠä¸€äº›é…ç½®ç±»,æ‹¦æˆªå™¨ç­‰<h4 id=Jwtç™»å½•éªŒè¯><a class=headerlink href=#Jwtç™»å½•éªŒè¯ title=Jwtç™»å½•éªŒè¯></a>Jwtç™»å½•éªŒè¯</h4><ol><li>ç”¨æˆ·ç™»å½•è¯·æ±‚</ol><p>å®¢æˆ·ç«¯ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨æˆ–Appï¼‰å‘é€åŒ…å«ç”¨æˆ·åå’Œå¯†ç çš„ç™»å½•è¯·æ±‚åˆ°åç«¯ã€‚<ol><li>æœåŠ¡ç«¯éªŒè¯èº«ä»½</ol><p>åç«¯æ¥æ”¶è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®ï¼š<ul><li>æ­£ç¡®ï¼šç”Ÿæˆ JWTï¼Œè¿”å›ç»™å®¢æˆ·ç«¯<li>é”™è¯¯ï¼šè¿”å›è®¤è¯å¤±è´¥å“åº”</ul><ol><li>æœåŠ¡ç«¯ç”Ÿæˆ JWT</ol><p>æœåŠ¡ç«¯ä½¿ç”¨ <strong>å¯†é’¥</strong> å¯¹ payload è¿›è¡Œç­¾åï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ tokenï¼š<figure class="highlight gcode"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>bashCopyEditeyJhbGciOiJIUzI<span class=number>1</span><span class=symbol>NiIsInR5</span>cCI<span class=number>6</span>IkpX<span class=attr>VCJ9</span>.    <span class=attr># Header</span></span><br><span class=line><span class=attr>eyJ1</span>c<span class=number>2</span>VySWQiOjEyMywidX<span class=symbol>Nlcm5</span>hbWUiOiJ<span class=number>0</span>b<span class=number>20</span>iLCJleHAiOjE<span class=number>3</span>MT<span class=name>M1</span><span class=symbol>NjgwMDB9</span>.  <span class=attr># Payload</span></span><br><span class=line><span class=attr>SflKxwRJSMeKKF2</span>QT<span class=number>4</span>fwpMeJf<span class=number>36</span>POk<span class=number>6</span>yJV_adQssw<span class=number>5</span>c  <span class=attr># Signature</span></span><br></pre></table></figure><blockquote><p>æœåŠ¡ç«¯æ­¤å <strong>ä¸å†ä¿å­˜ç”¨æˆ·çŠ¶æ€</strong>ï¼Œæ‰€æœ‰è®¤è¯ä¿¡æ¯éƒ½ç”± token è‡ªå¸¦ã€‚</blockquote><ol><li>å®¢æˆ·ç«¯ä¿å­˜ JWT</ol><p>å®¢æˆ·ç«¯æ”¶åˆ° token åï¼Œé€šå¸¸å°†å…¶å­˜å‚¨åœ¨ï¼š<ul><li><code>localStorage</code> / <code>sessionStorage</code><li>cookieï¼ˆæ…ç”¨ï¼Œéœ€è®¾ç½® <code>HttpOnly</code> å’Œ <code>Secure</code>ï¼‰</ul><ol><li>å®¢æˆ·ç«¯æºå¸¦ JWT è®¿é—®èµ„æº</ol><p>å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚å—ä¿æŠ¤çš„èµ„æºæ—¶ï¼Œåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ tokenï¼š<figure class="highlight dts"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=symbol>Authorization:</span> Bearer <span class=params>&LTtoken></span></span><br></pre></table></figure><ol><li>æœåŠ¡ç«¯éªŒè¯ JWT</ol><ul><li>æœåŠ¡ç«¯æå– tokenï¼ŒéªŒè¯ç­¾åæ˜¯å¦åˆæ³•ã€æ˜¯å¦è¿‡æœŸã€‚<li>è‹¥åˆæ³•ï¼Œè§£æ payloadï¼Œæ‹¿åˆ° <code>userId</code> ç­‰ä¿¡æ¯ï¼Œå¹¶æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</ul><h3 id=ğŸ”-JWT-çš„ç»“æ„><a title="ğŸ” JWT çš„ç»“æ„" class=headerlink href=#ğŸ”-JWT-çš„ç»“æ„></a>ğŸ” JWT çš„ç»“æ„</h3><p>JWT æ˜¯ä¸€ä¸ªç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œç”¨ <code>.</code> åˆ†éš”ï¼š<ol><li>Headerï¼ˆå¤´éƒ¨ï¼‰</ol><p>æè¿°ç­¾åçš„ç®—æ³•åŠç±»å‹ï¼Œé€šå¸¸æ˜¯è¿™æ ·çš„ï¼š<figure class="highlight mipsasm"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>jsonCopyEdit{</span></span><br><span class=line><span class=keyword></span>  <span class=string>"alg"</span>: <span class=string>"HS256"</span>,</span><br><span class=line>  <span class=string>"typ"</span>: <span class=string>"JWT"</span></span><br><span class=line>}</span><br></pre></table></figure><ol><li>Payloadï¼ˆæœ‰æ•ˆè½½è·ï¼‰</ol><p>å­˜æ”¾ä¸šåŠ¡æ•°æ®ï¼Œä¸åº”åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå› ä¸ºå®ƒæ˜¯æ˜æ–‡çš„ã€‚å¸¸è§å­—æ®µï¼š<div class=table-container><table><thead><tr><th>å­—æ®µ<th>å«ä¹‰<tbody><tr><td><code>sub</code><td>ä¸»é¢˜ï¼ˆSubjectï¼‰<tr><td><code>exp</code><td>è¿‡æœŸæ—¶é—´ï¼ˆExpiration Timeï¼‰<tr><td><code>iat</code><td>ç­¾å‘æ—¶é—´ï¼ˆIssued Atï¼‰<tr><td><code>userId</code><td>è‡ªå®šä¹‰å­—æ®µï¼Œé€šå¸¸æ˜¯ç”¨æˆ·å”¯ä¸€æ ‡è¯†<tr><td><code>roles</code><td>è‡ªå®šä¹‰å­—æ®µï¼Œè¡¨ç¤ºç”¨æˆ·æƒé™è§’è‰²</table></div><p>ç¤ºä¾‹ï¼š<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>{</span><br><span class=line>  <span class=attr>"userId"</span>: <span class=number>123</span>,</span><br><span class=line>  <span class=attr>"username"</span>: <span class=string>"tom"</span>,</span><br><span class=line>  <span class=attr>"exp"</span>: <span class=number>1713568000</span></span><br><span class=line>}</span><br></pre></table></figure><ol><li>Signatureï¼ˆç­¾åï¼‰</ol><p>ç”± header å’Œ payload ä½¿ç”¨å¯†é’¥ <code>secret</code> ç­¾åç”Ÿæˆï¼Œç”¨äºé˜²ç¯¡æ”¹ã€‚<figure class="highlight lisp"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>javaCopyEditHMACSHA256(</span><br><span class=line>  <span class=name>base64UrlEncode</span>(<span class=name>header</span>) + <span class=string>"."</span> + base64UrlEncode(<span class=name>payload</span>),</span><br><span class=line>  secret</span><br><span class=line>)</span><br></pre></table></figure><p><strong>ğŸ§¾ JWT ä¼˜ç‚¹</strong><ul><li>æ— éœ€åœ¨æœåŠ¡ç«¯å­˜å‚¨ Sessionï¼Œå®ç° <strong>æ— çŠ¶æ€è®¤è¯</strong><li>å¯è·¨æœåŠ¡ã€è·¨åŸŸä½¿ç”¨ï¼ˆé€‚åˆå¾®æœåŠ¡ï¼‰<li>è‡ªå¸¦ç”¨æˆ·ä¿¡æ¯ï¼Œå‡å°‘æŸ¥åº“å‹åŠ›<li>æ˜“æ‰©å±•ï¼Œå¯åŠ å…¥æƒé™ã€ç»„ç»‡ã€å¹³å°ç­‰å­—æ®µ</ul><p><strong>âš ï¸ å®‰å…¨å»ºè®®</strong><ul><li><strong>token ä¸è¦æ”¾æ•æ„Ÿä¿¡æ¯</strong>ï¼ˆæ˜æ–‡å¯è¯»ï¼‰<li>è®¾ç½®åˆç†çš„ <strong>è¿‡æœŸæ—¶é—´</strong><li>é€šè¿‡ <code>HTTPS</code> ä¼ è¾“ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»<li>ä½¿ç”¨ <code>HttpOnly + Secure</code> çš„ cookie ä¿å­˜ï¼ˆå¦‚ SSRï¼‰</ul><h4 id=æ¥å£æ–‡æ¡£><a class=headerlink href=#æ¥å£æ–‡æ¡£ title=æ¥å£æ–‡æ¡£></a>æ¥å£æ–‡æ¡£</h4><p>å¼€æ”¾æ¥å£è§„èŒƒæœ‰Swagger(springfox)å’Œ<strong>OpenAPI</strong>(ç›®å‰å¸¸ç”¨).<p>å¯ä»¥ä½¿ç”¨springdoc-openapiæˆ–Knife4jå·¥å…·é€šè¿‡æ·»åŠ æ³¨è§£ç”Ÿæˆè§„èŒƒ<p><a href=https://github.com/springdoc/springdoc-openapi rel=noopener target=_blank>springdoc/springdoc-openapi: Library for OpenAPI 3 with spring-boot</a><p><a href=https://doc.xiaominfo.com/docs/quick-start rel=noopener target=_blank>å¿«é€Ÿå¼€å§‹ | Knife4j</a><p><img alt=image-20250422195017608 data-src=https://s2.loli.net/2025/04/22/QKmht3v8O4pyAPC.png><h4 id=æ–°å¢å‘˜å·¥><a class=headerlink href=#æ–°å¢å‘˜å·¥ title=æ–°å¢å‘˜å·¥></a>æ–°å¢å‘˜å·¥</h4><p>å¢åŠ mapperçš„æ’å…¥è¯­å¥å¢åŠ å‘˜å·¥ä¿¡æ¯,æ³¨æ„æ’å…¥é”™è¯¯å¤„ç†.<p>ä»¥åŠé€šè¿‡interceptor,threadlocalå­˜å‚¨ç™»å½•ä¿¡æ¯.<h4 id=åˆ†é¡µæŸ¥è¯¢å‘˜å·¥><a class=headerlink href=#åˆ†é¡µæŸ¥è¯¢å‘˜å·¥ title=åˆ†é¡µæŸ¥è¯¢å‘˜å·¥></a>åˆ†é¡µæŸ¥è¯¢å‘˜å·¥</h4><p>åˆ©ç”¨mybatisçš„pagehelperæ’ä»¶,å…¶é€šè¿‡æ‹¦æˆªæ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥ä¿®æ”¹å…¶ä¸­çš„LIMITè¿”å›ç»“æœ.é¦–å…ˆè®¾ç½®é¡µå¤§å°å’Œéœ€è¦æŸ¥è¯¢çš„é¡µ.<ol><li><code>PageHelper.startPage(pageNum, pageSize)</code></ol><p>ç”¨äºè®¾ç½®å½“å‰é¡µç å’Œæ¯é¡µæ¡æ•°ï¼Œ<strong>å¿…é¡»åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰è°ƒç”¨</strong>ã€‚<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>PageHelper.startPage(<span class=number>1</span>, <span class=number>10</span>); <span class=comment>// ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡</span></span><br><span class=line>List&LTUser> users = userMapper.selectAll();</span><br><span class=line>PageInfo&LTUser> pageInfo = <span class=keyword>new</span> PageInfo<>(users);</span><br></pre></table></figure><ol><li><code>PageHelper.offsetPage(offset, limit)</code></ol><p>æŒ‰åç§»é‡æ–¹å¼åˆ†é¡µï¼Œé€‚åˆæµå¼åŠ è½½ç­‰åœºæ™¯ã€‚<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>PageHelper.offsetPage(<span class=number>20</span>, <span class=number>10</span>); <span class=comment>// è·³è¿‡å‰20æ¡ï¼ŒæŸ¥è¯¢10æ¡</span></span><br><span class=line>List&LTUser> users = userMapper.selectAll();</span><br></pre></table></figure><p>ç„¶ååœ¨mapperä¸­çš„sqlè¯­å¥ä¸­ç›´æ¥å†™æŸ¥è¯¢æ¡ä»¶,è¿”å›Pageç»“æœ.<div class=table-container><table><thead><tr><th>é—®é¢˜/æ³¨æ„ç‚¹<th>è¯´æ˜<tbody><tr><td>startPage å¿…é¡»ç´§è·ŸæŸ¥è¯¢è¯­å¥<td>å¦åˆ™åˆ†é¡µä¸èµ·ä½œç”¨ï¼ˆå»ºè®®ä¸è¦æœ‰ä¸­é—´å¤„ç†é€»è¾‘ï¼‰<tr><td>ä¸æ”¯æŒå¤šçº¿ç¨‹å…±äº«åˆ†é¡µä¸Šä¸‹æ–‡<td>æ¯æ¬¡åˆ†é¡µåªä½œç”¨äºå½“å‰çº¿ç¨‹</table></div><p><code>Page&LTT></code>ï¼šç»§æ‰¿è‡ª <code>ArrayList&LTT></code>ï¼Œç›´æ¥åŒ…å«ç»“æœæ•°æ® + åˆ†é¡µä¿¡æ¯ï¼›<p><code>PageInfo&LTT></code>ï¼šæ˜¯ä¸€ä¸ªé¢å¤–å°è£…ç±»ï¼ŒåŒ…å«åˆ†é¡µä¿¡æ¯ï¼ˆé€‚åˆè¿”å›ç»™å‰ç«¯ï¼‰ï¼›<h4 id=POJOä¸­æ—¥æœŸåºåˆ—åŒ–><a class=headerlink href=#POJOä¸­æ—¥æœŸåºåˆ—åŒ– title=POJOä¸­æ—¥æœŸåºåˆ—åŒ–></a>POJOä¸­æ—¥æœŸåºåˆ—åŒ–</h4><p><img alt=image-20250423140945684 data-src=https://s2.loli.net/2025/04/23/28JgwEfF7bZNsQz.png><p>åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Jacksonï¼ˆSpring Boot é»˜è®¤çš„ JSON åºåˆ—åŒ–åº“ï¼‰ï¼Œ<strong>å¯ä»¥é€šè¿‡é…ç½® <code>ObjectMapper</code> æˆ– <code>application.yml</code> æ¥è‡ªå®šä¹‰ <code>LocalDateTime</code> / <code>LocalDate</code> / <code>LocalTime</code> çš„åºåˆ—åŒ–æ ¼å¼</strong>ã€‚<p>âœ… æ–¹æ³•ä¸€ï¼šåœ¨å…¨å±€ <code>ObjectMapper</code> ä¸­æ³¨å†Œæ—¶é—´æ¨¡å—ï¼ˆæ¨èï¼‰<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JacksonConfig</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@Primary</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> ObjectMapper <span class=title>objectMapper</span><span class=params>()</span> </span>{</span><br><span class=line>        ObjectMapper mapper = <span class=keyword>new</span> ObjectMapper();</span><br><span class=line></span><br><span class=line>        JavaTimeModule javaTimeModule = <span class=keyword>new</span> JavaTimeModule();</span><br><span class=line>        <span class=comment>// LocalDateTime</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalDateTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateTimeSerializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalDateTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateTimeDeserializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class=line></span><br><span class=line>        <span class=comment>// LocalDate</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalDate.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd"</span>)));</span><br><span class=line></span><br><span class=line>        <span class=comment>// LocalTime</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(<span class=string>"HH:mm:ss"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(<span class=string>"HH:mm:ss"</span>)));</span><br><span class=line></span><br><span class=line>        mapper.registerModule(javaTimeModule);</span><br><span class=line>        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); <span class=comment>// é˜²æ­¢åºåˆ—åŒ–ä¸ºæ—¶é—´æˆ³</span></span><br><span class=line></span><br><span class=line>        <span class=keyword>return</span> mapper;</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>âœ… æ–¹æ³•äºŒï¼šä½¿ç”¨ <code>@JsonFormat</code> æ³¨è§£åœ¨å­—æ®µä¸Šå±€éƒ¨é…ç½®<p>é€‚åˆåªå¯¹ä¸ªåˆ«å­—æ®µæ ¼å¼åŒ–æ—¶ä½¿ç”¨ï¼š<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=meta>@Data</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MyDto</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span></span><br><span class=line>    <span class=keyword>private</span> LocalDateTime createdTime;</span><br><span class=line></span><br><span class=line>    <span class=meta>@JsonFormat(pattern = "yyyy-MM-dd")</span></span><br><span class=line>    <span class=keyword>private</span> LocalDate date;</span><br><span class=line>}</span><br></pre></table></figure><h3 id=Spring-Cache><a title="Spring Cache" class=headerlink href=#Spring-Cache></a>Spring Cache</h3><p><img alt=image-20250429162721846 data-src=https://s2.loli.net/2025/04/29/J3v6auIHbXNZxkT.png><h3 id=Spring-Task><a title="Spring Task" class=headerlink href=#Spring-Task></a>Spring Task</h3><p><img alt=image-20250430210633413 data-src=https://s2.loli.net/2025/04/30/iE9YtUfMhqRXn46.png><h3 id=Websocketä¸»åŠ¨æ¨é€è®¢å•æ¶ˆæ¯><a class=headerlink href=#Websocketä¸»åŠ¨æ¨é€è®¢å•æ¶ˆæ¯ title=Websocketä¸»åŠ¨æ¨é€è®¢å•æ¶ˆæ¯></a>Websocketä¸»åŠ¨æ¨é€è®¢å•æ¶ˆæ¯</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> org.springframework.context.annotation.Bean;</span><br><span class=line><span class=keyword>import</span> org.springframework.context.annotation.Configuration;</span><br><span class=line><span class=keyword>import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class=line></span><br><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>WebSocketConfig</span> </span>{</span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> ServerEndpointExporter <span class=title>serverEndpointExporter</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> ServerEndpointExporter();</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>ServerEndpointExporter ä¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰ @ServerEndpoint æ³¨è§£çš„ç±»ã€‚<p>æ³¨å†Œåˆ° Servlet å®¹å™¨çš„ WebSocket è¿è¡Œæ—¶ï¼ˆServerContainerï¼‰<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> javax.websocket.*;</span><br><span class=line><span class=keyword>import</span> javax.websocket.server.ServerEndpoint;</span><br><span class=line><span class=keyword>import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=line><span class=keyword>import</span> org.springframework.stereotype.Component;</span><br><span class=line><span class=keyword>import</span> java.io.IOException;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.CopyOnWriteArraySet;</span><br><span class=line></span><br><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@ServerEndpoint("/ws/students")</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>StudentWebSocketEndpoint</span> </span>{</span><br><span class=line>    <span class=comment>// å­˜å‚¨æ‰€æœ‰è¿æ¥çš„ä¼šè¯ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> CopyOnWriteArraySet&LTSession> sessions = <span class=keyword>new</span> CopyOnWriteArraySet<>();</span><br><span class=line>    <span class=meta>@Autowired</span></span><br><span class=line>    <span class=keyword>private</span> StudentService studentService;</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnOpen</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onOpen</span><span class=params>(Session session)</span> </span>{</span><br><span class=line>        sessions.add(session);</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            session.getBasicRemote().sendText(<span class=string>"Connected to Student WebSocket"</span>);</span><br><span class=line>        } <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>            e.printStackTrace();</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnMessage</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onMessage</span><span class=params>(String message, Session session)</span> <span class=keyword>throws</span> IOException </span>{</span><br><span class=line>        <span class=comment>// æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯ï¼Œå¹¿æ’­ç»™æ‰€æœ‰è¿æ¥</span></span><br><span class=line>        <span class=keyword>for</span> (Session s : sessions) {</span><br><span class=line>            s.getBasicRemote().sendText(<span class=string>"Message: "</span> + message);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnClose</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onClose</span><span class=params>(Session session)</span> </span>{</span><br><span class=line>        sessions.remove(session);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnError</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onError</span><span class=params>(Session session, Throwable throwable)</span> </span>{</span><br><span class=line>        throwable.printStackTrace();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// å¹¿æ’­å­¦ç”Ÿæ›´æ–°</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>broadcastStudentUpdate</span><span class=params>(String message)</span> </span>{</span><br><span class=line>        <span class=keyword>for</span> (Session session : sessions) {</span><br><span class=line>            <span class=keyword>try</span> {</span><br><span class=line>                session.getBasicRemote().sendText(message);</span><br><span class=line>            } <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>                e.printStackTrace();</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=Apache-Echartså±•ç¤ºä¿¡æ¯><a title="Apache Echartså±•ç¤ºä¿¡æ¯" class=headerlink href=#Apache-Echartså±•ç¤ºä¿¡æ¯></a>Apache Echartså±•ç¤ºä¿¡æ¯</h3><h3 id=Apache-POI><a title="Apache POI" class=headerlink href=#Apache-POI></a>Apache POI</h3><h1 id=é»‘é©¬ç‚¹è¯„><a class=headerlink href=#é»‘é©¬ç‚¹è¯„ title=é»‘é©¬ç‚¹è¯„></a>é»‘é©¬ç‚¹è¯„</h1><p>ç¼“å­˜ä½œç”¨: é™ä½åç«¯è´Ÿè½½,æå‡è¯»å†™é€Ÿåº¦<p>å¼€å‘æˆæœ¬å’Œç»´æŠ¤ä¸€è‡´æ€§é—®é¢˜<h3 id=Rediså­¦ä¹ ><a class=headerlink href=#Rediså­¦ä¹  title=Rediså­¦ä¹ ></a>Rediså­¦ä¹ </h3><p><a href=https://redis.io/docs/latest/develop/clients/jedis/ rel=noopener target=_blank>Jedis guide (Java) | Docs</a><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>redis.clients<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>jedis<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>version</span>></span>5.2.0<span class=tag>&LT/<span class=name>version</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JedisTest</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> Jedis jedis;</span><br><span class=line></span><br><span class=line>    <span class=meta>@BeforeEach</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>setUp</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=comment>// åˆå§‹åŒ– Jedis è¿æ¥</span></span><br><span class=line>        jedis = <span class=keyword>new</span> Jedis(<span class=string>"localhost"</span>, <span class=number>6379</span>); <span class=comment>// å‡è®¾ Redis æœåŠ¡è¿è¡Œåœ¨æœ¬åœ°ï¼Œé»˜è®¤ç«¯å£ä¸º 6379</span></span><br><span class=line>        System.out.println(<span class=string>"Connected to Redis"</span>);</span><br><span class=line>        <span class=comment>// æ¸…ç©º Redis æ•°æ®åº“ï¼Œç¡®ä¿æµ‹è¯•ç¯å¢ƒå¹²å‡€</span></span><br><span class=line>        jedis.flushAll();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œä¹‹åè¿è¡Œ</span></span><br><span class=line>    <span class=meta>@AfterEach</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>tearDown</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=comment>// å…³é—­ Jedis è¿æ¥</span></span><br><span class=line>        <span class=keyword>if</span> (jedis != <span class=keyword>null</span>) {</span><br><span class=line>            jedis.close();</span><br><span class=line>            System.out.println(<span class=string>"Disconnected from Redis"</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Test</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>testString</span><span class=params>()</span> </span>{</span><br><span class=line>        String result = jedis.set(<span class=string>"name"</span>,<span class=string>"proanimer"</span>);</span><br><span class=line>        System.out.println(<span class=string>"result = "</span> + result);</span><br><span class=line>        String name = jedis.get(<span class=string>"name"</span>);</span><br><span class=line>        System.out.println(<span class=string>"name = "</span> + name);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Test</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>testHash</span><span class=params>()</span> </span>{</span><br><span class=line>        jedis.hset(<span class=string>"user:1"</span>,<span class=string>"name"</span>,<span class=string>"proanimer"</span>);</span><br><span class=line>        jedis.hset(<span class=string>"user:2"</span>, <span class=string>"age"</span>, <span class=string>"24"</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><p><img style="zoom: 50%;" alt=image-20250412221454173 data-src=https://s2.loli.net/2025/04/12/TEPKoIHGYOma4Jy.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JedisConnectionFactory</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> JedisPool jedisPool;</span><br><span class=line>    <span class=keyword>static</span> {</span><br><span class=line>        <span class=comment>//é…ç½®è¿æ¥æ± </span></span><br><span class=line>        JedisPoolConfig jedisPoolConfig = <span class=keyword>new</span> JedisPoolConfig();</span><br><span class=line>        jedisPoolConfig.setMaxIdle(<span class=number>10</span>);</span><br><span class=line>        jedisPoolConfig.setMaxTotal(<span class=number>10</span>);</span><br><span class=line>        jedisPoolConfig.setMinIdle(<span class=number>0</span>);</span><br><span class=line>        jedisPoolConfig.setMaxWait(Duration.of(<span class=number>10</span>, ChronoUnit.SECONDS));</span><br><span class=line>        <span class=comment>// åˆ›å»ºè¿æ¥æ± </span></span><br><span class=line>        jedisPool = <span class=keyword>new</span> JedisPool(jedisPoolConfig,<span class=string>"127.0.0.1"</span>,<span class=number>6379</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>static</span> Jedis <span class=title>getJedis</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=keyword>return</span> jedisPool.getResource();</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=Spring-Data-Redis><a title="Spring Data Redis" class=headerlink href=#Spring-Data-Redis></a>Spring Data Redis</h3><p><a href=https://spring.io/projects/spring-data-redis rel=noopener target=_blank>Spring Data Redis</a><p><img alt=image-20250413141133598 data-src=https://s2.loli.net/2025/04/13/IPJL4xzF2aGAOfN.png style=zoom:50%;><h4 id=åºåˆ—åŒ–å™¨><a class=headerlink href=#åºåˆ—åŒ–å™¨ title=åºåˆ—åŒ–å™¨></a>åºåˆ—åŒ–å™¨</h4><p>åœ¨ä½¿ç”¨ Spring Data Redis æ—¶ï¼Œåºåˆ—åŒ–å™¨ï¼ˆSerializerï¼‰ç”¨äº<strong>å°† Java å¯¹è±¡è½¬æ¢ä¸ºé€‚åˆå­˜å‚¨åœ¨ Redis ä¸­çš„æ ¼å¼</strong>ï¼ˆå¦‚å­—èŠ‚æ•°ç»„ï¼‰ï¼Œå¹¶åœ¨ä» Redis è¯»å–æ•°æ®æ—¶å°†å…¶ååºåˆ—åŒ–å› Java å¯¹è±¡ã€‚é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–å™¨å¯¹äºç¡®ä¿æ•°æ®æ­£ç¡®æ€§ä»¥åŠä¼˜åŒ–æ€§èƒ½éå¸¸é‡è¦ã€‚é»˜è®¤åºåˆ—åŒ–å™¨æ˜¯JDKåºåˆ—åŒ–å™¨.<ol><li><code>JdkSerializationRedisSerializer</code></ol><ul><li><strong>æè¿°</strong>ï¼šè¿™æ˜¯é»˜è®¤çš„åºåˆ—åŒ–å™¨ï¼Œä½¿ç”¨ Java çš„åºåˆ—åŒ–æœºåˆ¶æ¥å¤„ç†å¯¹è±¡ã€‚<li><strong>ä¼˜ç‚¹</strong>ï¼šæ”¯æŒä»»æ„ç±»å‹çš„ Java å¯¹è±¡ã€‚<li><strong>ç¼ºç‚¹</strong>ï¼šç”Ÿæˆçš„æ•°æ®è¾ƒå¤§ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå¹¶ä¸”åªæœ‰åœ¨åŒä¸€ JVM ç¯å¢ƒä¸‹æ‰èƒ½æ­£ç¡®ååºåˆ—åŒ–ã€‚</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> JdkSerializationRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>StringRedisSerializer</code></ol><ul><li><strong>æè¿°</strong>ï¼šä¸“é—¨ç”¨äºå­—ç¬¦ä¸²çš„åºåˆ—åŒ–å™¨ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®ã€‚<li><strong>ä¼˜ç‚¹</strong>ï¼šç®€å•ã€å¿«é€Ÿï¼Œé€‚ç”¨äºå¤§å¤šæ•°é”®å€¼å¯¹åœºæ™¯ã€‚<li><strong>ç¼ºç‚¹</strong>ï¼šä»…é™äºå­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®ã€‚</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, String> <span class=title>stringRedisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    StringRedisTemplate template = <span class=keyword>new</span> StringRedisTemplate();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>GenericJackson2JsonRedisSerializer</code></ol><ul><li><strong>æè¿°</strong>ï¼šä½¿ç”¨ Jackson åº“å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON æ ¼å¼ã€‚<li><strong>ä¼˜ç‚¹</strong>ï¼šæ˜“äºé˜…è¯»å’Œè°ƒè¯•ï¼Œæ”¯æŒå¤æ‚å¯¹è±¡ç»“æ„ã€‚<li><strong>ç¼ºç‚¹</strong>ï¼šç›¸å¯¹äºå…¶ä»–äºŒè¿›åˆ¶æ ¼å¼ï¼ˆå¦‚ Protocol Buffersï¼‰ï¼ŒJSON çš„ä½“ç§¯æ›´å¤§ï¼Œè§£æé€Ÿåº¦è¾ƒæ…¢ã€‚</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> GenericJackson2JsonRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>Jackson2JsonRedisSerializer</code></ol><ul><li><strong>æè¿°</strong>ï¼šç±»ä¼¼äº <code>GenericJackson2JsonRedisSerializer</code>ï¼Œä½†å®ƒå…è®¸ä½ æŒ‡å®šåºåˆ—åŒ–çš„å…·ä½“ç±»å‹ã€‚<li><strong>ä¼˜ç‚¹</strong>ï¼šå¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶åºåˆ—åŒ–è¿‡ç¨‹ã€‚<li><strong>ç¼ºç‚¹</strong>ï¼šéœ€è¦æå‰çŸ¥é“åºåˆ—åŒ–å¯¹è±¡çš„ç¡®åˆ‡ç±»å‹ã€‚</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, MyObject> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, MyObject> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    Jackson2JsonRedisSerializer&LTMyObject> serializer = <span class=keyword>new</span> Jackson2JsonRedisSerializer<>(MyObject.class);</span><br><span class=line>    template.setValueSerializer(serializer);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>OxmSerializer</code></ol><ul><li><strong>æè¿°</strong>ï¼šç”¨äº XML æ•°æ®çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚<li><strong>ä¼˜ç‚¹</strong>ï¼šé€‚ç”¨äºéœ€è¦ä»¥ XML æ ¼å¼å­˜å‚¨æ•°æ®çš„åœºæ™¯ã€‚<li><strong>ç¼ºç‚¹</strong>ï¼šXML æ•°æ®é€šå¸¸æ¯” JSON æ›´å¤§ï¼Œå¤„ç†é€Ÿåº¦ä¹Ÿè¾ƒæ…¢ã€‚</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    OxmSerializer serializer = <span class=keyword>new</span> Jaxb2Marshaller(); <span class=comment>// ç¤ºä¾‹ä½¿ç”¨ JAXB</span></span><br><span class=line>    template.setValueSerializer(serializer);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li>è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</ol><p>æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„åºåˆ—åŒ–å™¨ï¼Œåªéœ€è¦å®ç° <code>RedisSerializer&LTT></code> æ¥å£å³å¯ã€‚<p>ç¤ºä¾‹ä»£ç ï¼š<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomRedisSerializer</span> <span class=keyword>implements</span> <span class=title>RedisSerializer</span><<span class=title>MyCustomType</span>> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>byte</span>[] serialize(MyCustomType t) <span class=keyword>throws</span> SerializationException {</span><br><span class=line>        <span class=comment>// å®ç°åºåˆ—åŒ–é€»è¾‘</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> <span class=keyword>byte</span>[<span class=number>0</span>];</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> MyCustomType <span class=title>deserialize</span><span class=params>(<span class=keyword>byte</span>[] bytes)</span> <span class=keyword>throws</span> SerializationException </span>{</span><br><span class=line>        <span class=comment>// å®ç°ååºåˆ—åŒ–é€»è¾‘</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>null</span>;</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>// åœ¨é…ç½®ä¸­ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</span></span><br><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, MyCustomType> <span class=title>customRedisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, MyCustomType> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> CustomRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><p><img alt=image-20250413160821439 data-src=https://s2.loli.net/2025/04/13/VKJzFQulyvWTSfa.png><h3 id=åŸºäºSessionçš„ç™»é™†><a class=headerlink href=#åŸºäºSessionçš„ç™»é™† title=åŸºäºSessionçš„ç™»é™†></a>åŸºäºSessionçš„ç™»é™†</h3><p><img alt=image-20250320175751672 data-src=https://s2.loli.net/2025/03/20/VqbA8F34U17C9xZ.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br></pre><td class=code><pre><span class=line> <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> Result <span class=title>sendCode</span><span class=params>(String phone, HttpSession session)</span> </span>{</span><br><span class=line><span class=comment>//        1.æ ¡éªŒ</span></span><br><span class=line>      <span class=comment>/*  String phoneRegex = "^1[3-9]\\d{9}$";</span></span><br><span class=line><span class=comment>        if (!phone.matches(phoneRegex)) {</span></span><br><span class=line><span class=comment>            return Result.fail("æ‰‹æœºå·æ ¼å¼é”™è¯¯");</span></span><br><span class=line><span class=comment>        }*/</span></span><br><span class=line>        <span class=keyword>boolean</span> phoneInvalid = RegexUtils.isPhoneInvalid(phone);</span><br><span class=line><span class=comment>//        2.å¦‚æœä¸ç¬¦åˆ</span></span><br><span class=line>        <span class=keyword>if</span> (phoneInvalid) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"æ‰‹æœºå·æ ¼å¼é”™è¯¯"</span>);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        3.ç¬¦åˆ,ç”ŸæˆéªŒè¯ç </span></span><br><span class=line>        String code = RandomUtil.randomNumbers(<span class=number>6</span>);</span><br><span class=line><span class=comment>//        4.ä¿å­˜éªŒè¯ç åˆ°session</span></span><br><span class=line>        session.setAttribute(<span class=string>"code"</span>, code);</span><br><span class=line><span class=comment>//        5.å‘é€éªŒè¯ç </span></span><br><span class=line>        log.debug(StrUtil.format(<span class=string>"å‘é€éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}"</span>, code));</span><br><span class=line><span class=comment>//        è¿”å›ok</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> Result <span class=title>login</span><span class=params>(LoginFormDTO loginForm, HttpSession session)</span> </span>{</span><br><span class=line><span class=comment>//        1.æ ¡éªŒæ‰‹æœºå·å’ŒéªŒè¯ç </span></span><br><span class=line>        String phone = loginForm.getPhone();</span><br><span class=line>        <span class=keyword>boolean</span> phoneInvalid = RegexUtils.isPhoneInvalid(phone);</span><br><span class=line>        <span class=keyword>if</span> (phoneInvalid) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"æ‰‹æœºå·æ ¼å¼é”™è¯¯"</span>);</span><br><span class=line>        }</span><br><span class=line>        String code = loginForm.getCode();</span><br><span class=line>        String codeInSession = (String) session.getAttribute(<span class=string>"code"</span>);</span><br><span class=line>        <span class=keyword>if</span> (!code.equals(codeInSession)) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"éªŒè¯ç é”™è¯¯"</span>);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        2.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class=line>        User user = query().eq(<span class=string>"phone"</span>, phone).one();</span><br><span class=line>        <span class=keyword>if</span> (user == <span class=keyword>null</span>) {</span><br><span class=line><span class=comment>//            ä¸å­˜åœ¨ åˆ›å»ºç”¨æˆ·</span></span><br><span class=line>            user = createUserWithPhone(phone);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        3.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°session</span></span><br><span class=line>        session.setAttribute(<span class=string>"user"</span>, BeanUtil.copyProperties(user, UserDTO.class));</span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> User <span class=title>createUserWithPhone</span><span class=params>(String phone)</span> </span>{</span><br><span class=line>        User user = <span class=keyword>new</span> User();</span><br><span class=line>        user.setPhone(phone);</span><br><span class=line>        user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomNumbers(<span class=number>8</span>));</span><br><span class=line>        save(user);</span><br><span class=line>        <span class=keyword>return</span> user;</span><br><span class=line>    }</span><br></pre></table></figure><p>æ³¨å†Œç™»å½•é—®é¢˜,å¯ä»¥ä½¿ç”¨æ‹¦æˆªå™¨æ–¹ä¾¿æ³¨å†Œç™»é™†ä»¥åŠæ ¡éªŒæƒé™, ä»åŸºäºsessionåˆ°åŸºäºredis<p>åŸºäºsessionçš„ç™»é™†, éªŒè¯ç å­˜åœ¨sessionä¸­,åœ¨æ‹¦æˆªå™¨ä¸­è·å–sessionæˆ–è€…è¯·æ±‚å¤´ä¸­çš„ä¿¡æ¯,<p>å¯ä»¥ä½¿ç”¨ThreadLocal,åœ¨æ‹¦æˆªå™¨æ–¹æ³•ä¸­å­˜å‚¨ç”¨æˆ·ä¿¡æ¯é¿å…å…¶ä»–çº¿ç¨‹è®¿é—®. ç™»é™†æˆåŠŸå°†å‘é€ç”Ÿæˆçš„tokenç»™å®¢æˆ·ç«¯,å¹¶ä¸”å­˜åœ¨æœåŠ¡ç«¯sessionä¸­.<p>æ¯æ¬¡è®¿é—®,åœ¨è¿›è¡Œæƒé™æ ¡éªŒä¸­,æ ¹æ®tokenåœ¨sessionå¾—åˆ°ç”¨æˆ·ä¿¡æ¯,å¦‚æœæœ‰å°±é€šè¿‡æƒé™æ ¡éªŒ.<p>é€šè¿‡é‡å†™WebMvcConfigureç±»æ·»åŠ æ‹¦æˆªå™¨ä¸è·¯å¾„,é‡å†™Interceptorç±»<blockquote><p>WebMvcConfigureç±»å¯ä»¥ç”¨äºæ·»åŠ æ‹¦æˆªå™¨ä¸é™æ€èµ„æºå¤„ç†ä»¥åŠCORSç­‰ç­‰.<p>Interceptorç±»å…è®¸ä½ åœ¨è¯·æ±‚è¢« <strong>Controller å¤„ç†ä¹‹å‰</strong>ã€<strong>Controller å¤„ç†ä¹‹åä½†åœ¨è§†å›¾æ¸²æŸ“ä¹‹å‰</strong>ã€ä»¥åŠ<strong>æ•´ä¸ªè¯·æ±‚å¤„ç†å®Œæˆä¹‹å</strong>è¿›è¡Œæ‹¦æˆªå’Œå¤„ç†ã€‚å®ƒæä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†å’Œåå¤„ç†ï¼Œè€Œæ— éœ€ä¿®æ”¹ Controller æˆ–ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚<p><code>HandlerInterceptor</code> çš„ä¸»è¦ä½œç”¨æ˜¯å®ç° AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰çš„ç†å¿µï¼Œå¯¹ Web è¯·æ±‚å¤„ç†æµç¨‹è¿›è¡Œ<strong>æ¨ªå‘åˆ‡å‰²</strong>ï¼Œç”¨äºå®ç°ä¸€äº›é€šç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š<ol><li><strong>æƒé™æ ¡éªŒ/èº«ä»½è®¤è¯ï¼š</strong> åœ¨è¯·æ±‚åˆ°è¾¾ Controller ä¹‹å‰ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•æˆ–æ˜¯å¦æœ‰æƒé™è®¿é—®æŸä¸ªèµ„æºã€‚<li><strong>æ—¥å¿—è®°å½•ï¼š</strong> è®°å½•è¯·æ±‚çš„è¿›å…¥ã€é€€å‡ºæ—¶é—´ï¼Œä»¥åŠè¯·æ±‚å‚æ•°ã€å“åº”çŠ¶æ€ç­‰ä¿¡æ¯ã€‚<li><strong>æ€§èƒ½ç›‘æ§ï¼š</strong> è®¡ç®—è¯·æ±‚çš„å¤„ç†æ—¶é—´ï¼Œè¿›è¡Œæ€§èƒ½åˆ†æã€‚<li><strong>æ•°æ®é¢„å¤„ç†ï¼š</strong> åœ¨ Controller å¤„ç†ä¹‹å‰å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œä¸€äº›ç»Ÿä¸€çš„æ ¼å¼åŒ–æˆ–æ ¡éªŒã€‚<li><strong>è·¨åŸŸå¤„ç†ï¼š</strong> æ·»åŠ æˆ–ä¿®æ”¹å“åº”å¤´ï¼Œå¤„ç† CORS ç›¸å…³çš„é€»è¾‘ã€‚<li><strong>å›½é™…åŒ–ï¼š</strong> æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„è¯­è¨€è®¾ç½®ï¼Œåˆ‡æ¢å¯¹åº”çš„è¯­è¨€ç¯å¢ƒã€‚<li><strong>ä¼šè¯ç®¡ç†ï¼š</strong> æ£€æŸ¥ä¼šè¯çŠ¶æ€ï¼Œæˆ–è¿›è¡Œä¼šè¯ç»­æœŸã€‚</ol></blockquote><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RefreshTokenInterceptor</span> <span class=keyword>implements</span> <span class=title>HandlerInterceptor</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=title>RefreshTokenInterceptor</span><span class=params>(StringRedisTemplate stringRedisTemplate)</span> </span>{</span><br><span class=line>        <span class=keyword>this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>boolean</span> <span class=title>preHandle</span><span class=params>(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class=keyword>throws</span> Exception </span>{</span><br><span class=line>        <span class=comment>// 1.è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class=line>        String token = request.getHeader(<span class=string>"authorization"</span>);</span><br><span class=line>        <span class=keyword>if</span> (StrUtil.isBlank(token)) {</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=comment>// 2.åŸºäºTOKENè·å–redisä¸­çš„ç”¨æˆ·</span></span><br><span class=line>        String key  = LOGIN_USER_KEY + token;</span><br><span class=line>        Map&LTObject, Object> userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class=line>        <span class=comment>// 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class=line>        <span class=keyword>if</span> (userMap.isEmpty()) {</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=comment>// 5.å°†æŸ¥è¯¢åˆ°çš„hashæ•°æ®è½¬ä¸ºUserDTO</span></span><br><span class=line>        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, <span class=keyword>new</span> UserDTO(), <span class=keyword>false</span>);</span><br><span class=line>        <span class=comment>// 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal</span></span><br><span class=line>        UserHolder.saveUser(userDTO);</span><br><span class=line>        <span class=comment>// 7.åˆ·æ–°tokenæœ‰æ•ˆæœŸ</span></span><br><span class=line>        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class=line>        <span class=comment>// 8.æ”¾è¡Œ</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCompletion</span><span class=params>(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class=keyword>throws</span> Exception </span>{</span><br><span class=line>        <span class=comment>// ç§»é™¤ç”¨æˆ·</span></span><br><span class=line>        UserHolder.removeUser();</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=é›†ç¾¤çš„sessionå…±äº«é—®é¢˜><a class=headerlink href=#é›†ç¾¤çš„sessionå…±äº«é—®é¢˜ title=é›†ç¾¤çš„sessionå…±äº«é—®é¢˜></a>é›†ç¾¤çš„sessionå…±äº«é—®é¢˜</h4><p><img alt=image-20250414154105418 data-src=https://s2.loli.net/2025/04/14/xZREAUpPzkQBiVF.png><h4 id=åŸºäºRedisçš„çŸ­ä¿¡ç™»é™†><a class=headerlink href=#åŸºäºRedisçš„çŸ­ä¿¡ç™»é™† title=åŸºäºRedisçš„çŸ­ä¿¡ç™»é™†></a>åŸºäºRedisçš„çŸ­ä¿¡ç™»é™†</h4><p><img alt=image-20250414161242250 data-src=https://s2.loli.net/2025/04/14/bVvPz25pxkyMqB9.png><p>åŸºäºsessionçš„é—®é¢˜ å¤šå°tomcatä¸å…±äº«session<p>ä½¿ç”¨åŸºäºredisçš„ç™»é™†æ³¨å†Œ<p>å½“ç™»é™†æ—¶ï¼Œå¦‚æœä½¿ç”¨è´¦å·+æ‰‹æœºéªŒè¯ç å½¢å¼ï¼Œå½“å‰ç«¯å‘é€éªŒè¯ç è¯·æ±‚ï¼Œå°†æ‰‹æœºå·ç å’Œç”Ÿæˆçš„æ‰‹æœºéªŒè¯ç å­˜åœ¨å¯¹åº”çš„ç¼“å­˜ä¸­ï¼Œç„¶åç™»é™†æ—¶æ ¡éªŒã€‚æˆåŠŸå°±è¿”å›ä¸€ä¸ªtokenï¼Œç„¶åå°†tokenå­˜åœ¨ç¼“å­˜ä¸­.å¯ä»¥ä½¿ç”¨user_idä½œkey.<p>åœ¨ä½¿ç”¨sessionç™»é™†æ—¶,å­˜å‚¨ä¿¡æ¯ç›´æ¥åˆ©ç”¨äº†servlet,tomcatæä¾›çš„sessionæœºåˆ¶,æœåŠ¡å™¨ä¼šåˆ›å»ºå¯¹åº”ä¼šè¯çš„sessionå¹¶è¿”å›JSESSIONIDç»™å®¢æˆ·ç«¯,å®¢æˆ·ç«¯ä¼šä¸»åŠ¨æºå¸¦è¯¥id,æœåŠ¡å™¨ç›´æ¥è®¿é—®å¯¹åº”çš„sessionå¯¹è±¡åŠå…¶åŒ…å«å±æ€§å³å¯.<p>è€Œä½¿ç”¨redisç™»é™†,ç¡®å®šç¼“å­˜çš„å€¼å¯¹è±¡ç±»å‹<p><img alt=image-20250715141126358 data-src=https://s2.loli.net/2025/07/15/5lLUKEwJnexXoua.png><p>å½“è¿›å…¥ç”¨æˆ·æƒé™ç½‘é¡µæ—¶,è¯»å–httpservletRequestä¸­çš„å‚æ•°,ä»è¯·æ±‚ä¸­è·å–token,åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾,æ‰¾åˆ°å°±æ»¡è¶³. å®¢æˆ·ç«¯å°†tokenæ”¾åœ¨sessionStorageä¸­è¿›è¡Œä¿å­˜,è¯·æ±‚æ—¶æ”¾åœ¨headerä¸­çš„<code>authorization</code>å¤´ä¸­,æœåŠ¡ç«¯åœ¨å¯¹åº”è¯·æ±‚å¤´ä¸­æ‹¿åˆ°token.<h4 id=ä¼˜åŒ–æ‹¦æˆªå™¨><a class=headerlink href=#ä¼˜åŒ–æ‹¦æˆªå™¨ title=ä¼˜åŒ–æ‹¦æˆªå™¨></a>ä¼˜åŒ–æ‹¦æˆªå™¨</h4><p><img alt=image-20250414210106336 data-src=https://s2.loli.net/2025/04/14/36voF12n9YepEkI.png><p>åŸæœ¬çš„æ‹¦æˆªå™¨åªæ‹¦æˆªéœ€è¦æƒé™çš„controller,ä½†æ˜¯å¦‚æœå·²ç»æœ‰cookieçš„ç”¨æˆ·åªè®¿é—®ä¸éœ€è¦æƒé™çš„controllerå°±ä¸ä¼šæ›´æ–°redis. ä¹Ÿå°±æ˜¯è¯´å·²ç™»é™†ç”¨æˆ·è®¿é—®ä¸éœ€è¦æƒé™çš„ç½‘é¡µä¸ä¼šæ›´æ–°ç¼“å­˜,å¯¼è‡´ä¸€æ®µæ—¶é—´åå¤±æ•ˆ.<p><img alt=image-20250414210226312 data-src=https://s2.loli.net/2025/04/14/sUTIzrhMgqNpR7H.png><p>å› æ­¤æ·»åŠ å…¨å±€æ‹¦æˆªå™¨,è®¿é—®æ‰€æœ‰é¡µé¢,å¦‚æœæ˜¯å·²ç™»é™†ç”¨æˆ·,æ›´æ–°ç¼“å­˜ä¸­TTL,å¦åˆ™ä»€ä¹ˆä¹Ÿä¸åš,ç›´æ¥æ”¾è¡Œ,å¯¹äºéœ€è¦æƒé™çš„æ‹¦æˆªå™¨è¿›è¡Œæ£€æµ‹.<h4 id=ç™»é™†ä»¥åŠæƒé™æ ¡éªŒå…³é”®é—®é¢˜><a class=headerlink href=#ç™»é™†ä»¥åŠæƒé™æ ¡éªŒå…³é”®é—®é¢˜ title=ç™»é™†ä»¥åŠæƒé™æ ¡éªŒå…³é”®é—®é¢˜></a>ç™»é™†ä»¥åŠæƒé™æ ¡éªŒå…³é”®é—®é¢˜</h4><p><strong>åŸºäºsessionæˆ–è€…åŸºäºredisç¼“å­˜</strong><p>sessionå­˜åœ¨tomcaté›†ç¾¤ä¸å…±äº«çš„é—®é¢˜,å½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±<p><strong>æ‹¦æˆªå™¨é…ç½® é€šè¿‡interceptoræˆ–è€…è‡ªå·±é€šè¿‡AOPå®ç°æ ¡éªŒ</strong><p>é€šè¿‡æ‹¦æˆªå™¨,åœ¨è¯·æ±‚æˆ–è€…sessionä¸­æ‹¿åˆ°æ ¡éªŒä¿¡æ¯<p>å¯ä»¥ä½¿ç”¨ThreadLocalåœ¨æ‹¦æˆªå™¨ä¸­ç›´æ¥åœ¨sessionæˆ–è€…redisä¸­è·å¾—ä¿¡æ¯<p><strong>æ­¤å¤–è¿˜æœ‰åŸºäºJWTçš„æ— çŠ¶æ€è®¤è¯æœºåˆ¶,æœåŠ¡å™¨æœ¬èº«ä¸å­˜å‚¨session.</strong><p>åœ¨ç™»é™†æˆåŠŸå,å®¢æˆ·ç«¯æ¯æ¬¡æºå¸¦jwt,JWTæœ¬èº«å­˜å‚¨äº†ç”¨æˆ·çš„ä¸€äº›å…³é”®ä¿¡æ¯,å…·ä½“æ¥è¯´,JWTåŒ…å«å¤´éƒ¨,è´Ÿè½½,ç­¾å.<p>å¤´éƒ¨åŒ…å«ç®—æ³•ç±»å‹,è´Ÿè½½åŒ…æ‹¬æ³¨å†Œå£°æ˜ã€å…¬å…±å£°æ˜ä»¥åŠç§æœ‰å£°æ˜. ç­¾åæ˜¯é€šè¿‡å¯†é’¥åŠ å¯†åçš„å¤´éƒ¨å’Œè´Ÿè½½åŠ å¯†.<blockquote><p>Payload éƒ¨åˆ†æ˜¯ Base64url ç¼–ç çš„ï¼Œä¸æ˜¯åŠ å¯†çš„ã€‚è¿™æ„å‘³ç€ä»»ä½•äººéƒ½å¯ä»¥è§£ç  Payload å¹¶è¯»å–å…¶ä¸­çš„å†…å®¹ã€‚å› æ­¤ï¼Œç»ä¸èƒ½åœ¨ Payload ä¸­å­˜æ”¾æ•æ„Ÿä¿¡æ¯</blockquote><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>{</span><br><span class=line>  <span class=attr>"alg"</span>: <span class=string>"HS256"</span>,</span><br><span class=line>  <span class=attr>"typ"</span>: <span class=string>"JWT"</span>,</span><br><span class=line>  </span><br><span class=line>   <span class=attr>"sub"</span>: <span class=string>"user_123"</span>,        <span class=comment>// ç”¨æˆ·ID</span></span><br><span class=line>  <span class=attr>"name"</span>: <span class=string>"Alice Smith"</span>,    <span class=comment>// ç”¨æˆ·å</span></span><br><span class=line>  <span class=attr>"roles"</span>: [<span class=string>"admin"</span>, <span class=string>"user"</span>], <span class=comment>// ç”¨æˆ·è§’è‰²</span></span><br><span class=line>  <span class=attr>"exp"</span>: <span class=number>1752496261</span>,        <span class=comment>// è¿‡æœŸæ—¶é—´æˆ³</span></span><br><span class=line>  <span class=attr>"iat"</span>: <span class=number>1752492661</span>         <span class=comment>// ç­¾å‘æ—¶é—´æˆ³  //æ³¨æ„è¿™äº›éƒ¨åˆ†éƒ½ä¼šè¿›è¡Œbase64ç¼–ç </span></span><br><span class=line>  </span><br><span class=line>  <span class=string>"signature"</span>:HMACSHA256(base64UrlEncode(header) + <span class=string>"."</span> + base64UrlEncode(payload), secret) <span class=comment>//ä½¿ç”¨ Header ä¸­æŒ‡å®šçš„ç®—æ³•ï¼ˆå¦‚ HS256 æˆ– RS256ï¼‰å’ŒæœåŠ¡å™¨ç«¯çš„å¯†é’¥ (Secret Key)ï¼ˆå¯¹äºå¯¹ç§°åŠ å¯†ï¼Œå¦‚ HS256ï¼‰æˆ–ç§é’¥ï¼ˆå¯¹äºéå¯¹ç§°åŠ å¯†ï¼Œå¦‚ RS256ï¼‰å¯¹è¿æ¥åçš„å­—ç¬¦ä¸²è¿›è¡Œç­¾åã€‚</span></span><br><span class=line>}</span><br></pre></table></figure><p>æœ€ç»ˆï¼Œè¿™ä¸‰éƒ¨åˆ†ç”¨ç‚¹è¿æ¥èµ·æ¥ï¼Œå°±æ„æˆäº†å®Œæ•´çš„ JWT å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code><h3 id=å•†æˆ·æŸ¥è¯¢ç¼“å­˜><a class=headerlink href=#å•†æˆ·æŸ¥è¯¢ç¼“å­˜ title=å•†æˆ·æŸ¥è¯¢ç¼“å­˜></a>å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h3><p><img alt=image-20250414220321389 data-src=https://s2.loli.net/2025/04/14/HTdpXizlnASGQqv.png><p><img alt=image-20250414233753517 data-src=https://s2.loli.net/2025/04/14/jc9OQH8oFwMLz5K.png><h3 id=ç¼“å­˜æ›´æ–°ç­–ç•¥><a class=headerlink href=#ç¼“å­˜æ›´æ–°ç­–ç•¥ title=ç¼“å­˜æ›´æ–°ç­–ç•¥></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p><img alt=image-20250415103603707 data-src=https://s2.loli.net/2025/04/15/p72NIzH9MfZaxnR.png><p><img alt=image-20250415103926298 data-src=https://s2.loli.net/2025/04/15/y7bowaDxTL2f8GJ.png><div class=table-container><table><thead><tr><th>ç­–ç•¥<th>è¯»æ“ä½œ<th>å†™æ“ä½œ<th>ä¼˜ç‚¹<th>ç¼ºç‚¹<th>é€‚ç”¨åœºæ™¯<tbody><tr><td><strong>Cache Aside</strong><td>å…ˆæŸ¥ç¼“å­˜ï¼Œå†æŸ¥æ•°æ®åº“<td>æ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜<td>ç®€å•ã€çµæ´»ã€ä¸€è‡´æ€§è¾ƒå¥½<td>å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´ã€æœªå‘½ä¸­æ—¶æ€§èƒ½è¾ƒå·®<td>æ•°æ®è¯»å¤šå†™å°‘ã€ä¸€è‡´æ€§è¦æ±‚ä¸é«˜<tr><td><strong>Read/Write Through</strong><td>ç¼“å­˜è´Ÿè´£æœªå‘½ä¸­å¤„ç†<td>ç¼“å­˜è´Ÿè´£åŒæ­¥åˆ°æ•°æ®åº“<td>é€æ˜æ€§å¥½ã€ä¸€è‡´æ€§å¥½<td>å¤æ‚æ€§é«˜ã€å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ<td>æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜<tr><td><strong>Write Behind Caching</strong><td>å…ˆæŸ¥ç¼“å­˜ï¼Œå†æŸ¥æ•°æ®åº“<td>å¼‚æ­¥æ‰¹é‡å†™å›æ•°æ®åº“<td>å†™æ€§èƒ½é«˜ã€ååé‡å¤§<td>æ•°æ®ä¸¢å¤±é£é™©ã€ä¸€è‡´æ€§å·®<td>æ•°æ®å†™å¤šè¯»å°‘ã€ä¸€è‡´æ€§è¦æ±‚ä½</table></div><p><img alt=image-20250415105910579 data-src=https://s2.loli.net/2025/04/15/TU3KbireNcB4G67.png><p><img alt=image-20250415111429325 data-src=https://s2.loli.net/2025/04/15/CFEZY2mKqnwljAW.png><p><img alt=image-20250415111703513 data-src=https://s2.loli.net/2025/04/15/LqgUJKSZD9Gfad6.png><div class=table-container><table><thead><tr><th>åç§°<th>è§¦å‘åœºæ™¯<th>ç»“æœ<th>å¸¸è§è§£å†³æ–¹æ¡ˆ<tbody><tr><td>ç¼“å­˜ç©¿é€<td>è¯·æ±‚çš„æ•°æ®æœ¬å°±ä¸å­˜åœ¨ï¼ˆDB ä¹Ÿæ— ï¼‰<td>æ¯æ¬¡è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“<td>ç¼“å­˜ç©ºå€¼ã€å¸ƒéš†è¿‡æ»¤å™¨<tr><td>ç¼“å­˜å‡»ç©¿<td>æŸä¸ªçƒ­ç‚¹ key æ°å¥½è¿‡æœŸäº†<td>å¤§é‡è¯·æ±‚åŒæ—¶è®¿é—® DBï¼Œç¬æ—¶å‹åŠ›å¤§<td>åŠ äº’æ–¥é”ã€çƒ­ç‚¹é¢„çƒ­<tr><td>ç¼“å­˜é›ªå´©<td>å¤§é‡ key åœ¨åŒä¸€æ—¶é—´è¿‡æœŸ<td>ç¼“å­˜å¤±æ•ˆï¼Œæ•°æ®åº“å‹åŠ›æ¿€å¢<td>åŠ éšæœºè¿‡æœŸæ—¶é—´ã€é™æµã€é™çº§</table></div><p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯åŸºäºä¸€ä¸ª <strong>bit æ•°ç»„</strong> + å¤šä¸ª <strong>å“ˆå¸Œå‡½æ•°</strong>ï¼š<ol><li>åˆå§‹åˆ›å»ºä¸€ä¸ªå¾ˆå¤§çš„ bit æ•°ç»„ï¼ˆå¦‚ 1 äº¿ä½ï¼Œå…¨æ˜¯ 0ï¼‰ã€‚<li>æ’å…¥å…ƒç´ æ—¶ï¼Œç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å“ˆå¸Œï¼Œå¾—åˆ°å¤šä¸ªä¸‹æ ‡ä½ç½®ï¼ŒæŠŠè¿™äº›ä½ç½®è®¾ä¸º 1ã€‚<li>æŸ¥è¯¢æ—¶ï¼Œå¯¹å¾…æŸ¥å…ƒç´ ç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°æ±‚ä¸‹æ ‡ï¼š<ul><li>è‹¥æ‰€æœ‰å¯¹åº” bit ä½éƒ½æ˜¯ 1 â†’ å¯èƒ½å­˜åœ¨<li>æœ‰ä»»æ„ä¸€ä¸ª bit æ˜¯ 0 â†’ ä¸€å®šä¸å­˜åœ¨</ul></ol><p><img alt=image-20250415133050673 data-src=https://s2.loli.net/2025/04/15/MozbdO6Ly2aCI4E.png><p><img alt=image-20250415143221507 data-src=https://s2.loli.net/2025/04/15/aujZnwSzgiUxloL.png><p><img alt=image-20250415144016106 data-src=https://s2.loli.net/2025/04/15/xBTlfUn6WmDpwIJ.png><p><img alt=image-20250415144408811 data-src=https://s2.loli.net/2025/04/15/Tcd5tCruUKo6wvM.png><p><img alt=image-20250415144944179 data-src=https://s2.loli.net/2025/04/15/x5ayubhtcrSK8qQ.png><p><img alt=image-20250415145118864 data-src=https://s2.loli.net/2025/04/15/EBpdcml8I7tLvxU.png><h3 id=ä¼˜æƒ åˆ¸ç§’æ€><a class=headerlink href=#ä¼˜æƒ åˆ¸ç§’æ€ title=ä¼˜æƒ åˆ¸ç§’æ€></a>ä¼˜æƒ åˆ¸ç§’æ€</h3><p>å…¨å±€IDç”Ÿæˆå™¨,åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·.<p>æ»¡è¶³:å”¯ä¸€æ€§,é«˜å¯ç”¨,é«˜æ€§èƒ½,é€’å¢æ€§,å®‰å…¨æ€§.<p><img alt=image-20250415194042557 data-src=https://s2.loli.net/2025/04/15/3LSmM7p8e5gfXcN.png><p><img alt=image-20250415231649294 data-src=https://s2.loli.net/2025/04/15/tXm5rvyNMhbxeYL.png style=zoom:67%;><p><img alt=image-20250416162534054 data-src=https://s2.loli.net/2025/04/16/zTXyB8Uo7RKWmc2.png style=zoom:67%;><h4 id=æ‚²è§‚é”-ä¹è§‚é”><a title="æ‚²è§‚é”  ä¹è§‚é”" class=headerlink href=#æ‚²è§‚é”-ä¹è§‚é”></a>æ‚²è§‚é” ä¹è§‚é”</h4><p><img alt=image-20250416192913692 data-src=https://s2.loli.net/2025/04/16/9QRuCerNJpmcHaf.png><p>ä¹è§‚é”çš„å…³é”®æ˜¯åˆ¤æ–­ä¹‹å‰æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹è¿‡.å¸¸è§æ–¹å¼:<ol><li>ç‰ˆæœ¬å·æ³•</ol><p>ç»™æ•°æ®æ·»åŠ ç‰ˆæœ¬å·,æ¯æ¬¡æ›´æ–°çš„æ—¶å€™æŸ¥è¯¢æ•°æ®å¯¹åº”çš„ç‰ˆæœ¬,å¦‚æœç‰ˆæœ¬å·è·Ÿä¹‹å‰çš„ä¸åŒåˆ™è¡¨æ˜æ›´æ–°è¿‡äº†.<p><img alt=image-20250416194812142 data-src=https://s2.loli.net/2025/04/16/3tu9mqXVNyoDZYT.png><ol><li>CASæ³•</ol><p><img alt=image-20250416212059026 data-src=https://s2.loli.net/2025/04/16/eCKmRn4QDs7pSLA.png style=zoom:67%;><p>ä¸€äººä¸€å•,ä½¿ç”¨æ‚²è§‚é”,åŠ é”. ä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹,å¤šä¸ªå®ä¾‹ä¸‹è¿›ç¨‹ä¸ç›¸å¹²,æ— æ³•è¿›è¡Œçº¿ç¨‹åŒæ­¥,éœ€è¦å®ç°åˆ†å¸ƒå¼é”.<p>åˆ†å¸ƒå¼é”:æ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”<p><img alt=image-20250417095719500 data-src=https://s2.loli.net/2025/04/17/t4sZY1NizPOvRcX.png><p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”<p>ä½¿ç”¨<code>setnx</code><p><img alt=image-20250417124148443 data-src=https://s2.loli.net/2025/04/17/JBC3Xe1HPmpfnwa.png><p>æ³¨æ„å¦‚æœå‡ºç°ä¸šåŠ¡è€—æ—¶è¶…è¿‡keyçš„ttl,å¯¼è‡´å…¶ä»–çº¿ç¨‹æ‹¿åˆ°é”,åœ¨åˆ é™¤é”æ—¶æ£€æŸ¥valueæ˜¯å¦ä¸€è‡´ã€‚<p>redis luaè„šæœ¬<p><img alt=image-20250417133641854 data-src=https://s2.loli.net/2025/04/17/X7GMsSg59QjnaRf.png><p><img alt=image-20250417143320701 data-src=https://s2.loli.net/2025/04/17/AG1vHk7s2u6FexB.png><h4 id=Redissonå¯é‡å…¥é”><a class=headerlink href=#Redissonå¯é‡å…¥é” title=Redissonå¯é‡å…¥é”></a>Redissonå¯é‡å…¥é”</h4><p><img alt=image-20250417152425433 data-src=https://s2.loli.net/2025/04/17/2jkGcgNIYylmQL8.png><h4 id=å¯é‡è¯•-æ›´æ–°è¶…æ—¶æ—¶é—´><a class=headerlink href=#å¯é‡è¯•-æ›´æ–°è¶…æ—¶æ—¶é—´ title=å¯é‡è¯•/æ›´æ–°è¶…æ—¶æ—¶é—´></a>å¯é‡è¯•/æ›´æ–°è¶…æ—¶æ—¶é—´</h4><p><img alt=image-20250417181249028 data-src=https://s2.loli.net/2025/04/17/lytxPu8ZirBRH5s.png><p><img alt=image-20250417181558824 data-src=https://s2.loli.net/2025/04/17/EYhwIoeVBgmkHfU.png><p>æ‰€ä»¥åˆ©ç”¨redisç¼“å­˜ä½œåˆ†å¸ƒå¼é”çš„éœ€è¦æ ¸å¿ƒè§£å†³çš„<strong>å¯é‡å…¥</strong>å’Œ<strong>è¶…æ—¶é‡è¯•æœºåˆ¶</strong>.<h4 id=ä¸»ä»ä¸€è‡´æ€§é—®é¢˜><a class=headerlink href=#ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ title=ä¸»ä»ä¸€è‡´æ€§é—®é¢˜></a>ä¸»ä»ä¸€è‡´æ€§é—®é¢˜</h4><p>ä¸€ã€å•æœºå¤šå®ä¾‹ï¼ˆé€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒï¼‰<p>é…ç½®ä¸åŒçš„å®ä¾‹ç«¯å£,å¤šä¸ªé…ç½®æ–‡ä»¶å¯åŠ¨å¤šä¸ªå®ä¾‹.<p>äºŒã€å¤šæœºé›†ç¾¤,åœ¨æ¯å°æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ª Redis é…ç½®æ–‡ä»¶ï¼ˆå¦‚ <code>redis-cluster.conf</code>ï¼‰ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>port 6379</span><br><span class=line>cluster-enabled yes</span><br><span class=line>cluster-config-file nodes.conf</span><br><span class=line>cluster-node-timeout 5000</span><br><span class=line>appendonly yes</span><br></pre></table></figure><ul><li><code>cluster-enabled yes</code>ï¼šå¯ç”¨é›†ç¾¤æ¨¡å¼ã€‚<li><code>cluster-config-file nodes.conf</code>ï¼šæŒ‡å®šé›†ç¾¤èŠ‚ç‚¹é…ç½®æ–‡ä»¶ã€‚<li><code>cluster-node-timeout 5000</code>ï¼šè®¾ç½®èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</ul><p><img alt=image-20250417232039727 data-src=https://s2.loli.net/2025/04/17/UiIyGpJA4RoP7Dh.png><p><img alt=image-20250418111401540 data-src=https://s2.loli.net/2025/04/18/cn3NCI9O24upUlg.png><p><img alt=image-20250418143910127 data-src=https://s2.loli.net/2025/04/18/IRiKpLMBV1cCUs3.png><p><img alt=image-20250418182224084 data-src=https://s2.loli.net/2025/04/18/bS3QAUKsTHoRY1q.png><h4 id=Redisæ¶ˆæ¯é˜Ÿåˆ—><a class=headerlink href=#Redisæ¶ˆæ¯é˜Ÿåˆ— title=Redisæ¶ˆæ¯é˜Ÿåˆ—></a>Redisæ¶ˆæ¯é˜Ÿåˆ—</h4><p><img alt=image-20250418200244539 data-src=https://s2.loli.net/2025/04/18/ayrfSevJ8TdGUF3.png><h4 id=åŸºäºlistæ•°æ®ç»“æ„><a class=headerlink href=#åŸºäºlistæ•°æ®ç»“æ„ title=åŸºäºlistæ•°æ®ç»“æ„></a>åŸºäºlistæ•°æ®ç»“æ„</h4><p>Redisåˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨çš„å¤´éƒ¨ï¼ˆå·¦è¾¹ï¼‰æˆ–è€…å°¾éƒ¨ï¼ˆå³è¾¹ï¼‰ä¸€ä¸ªåˆ—è¡¨æœ€å¤šå¯ä»¥åŒ…å« 2^32^ -1ä¸ªå…ƒç´ ã€‚ä¸»è¦åˆ©ç”¨<code>BRPOP</code>ç§»é™¤åˆ—è¡¨å…ƒç´ ,å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢. åŒæ—¶é€šè¿‡<code>LPUSH</code>æ·»åŠ å€¼.<p><img alt=image-20250418203901472 data-src=https://s2.loli.net/2025/04/18/9ih5CDwLBlKNERW.png><h5 id=pubsub-ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¶ˆæ¯æ¨¡å‹><a title="pubsub ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¶ˆæ¯æ¨¡å‹" class=headerlink href=#pubsub-ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¶ˆæ¯æ¨¡å‹></a>pubsub ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¶ˆæ¯æ¨¡å‹</h5><p>Redis å‘å¸ƒè®¢é˜… (pub/sub) æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€… (pub) å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€… (sub) æ¥æ”¶æ¶ˆæ¯ã€‚<p>Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚<p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2014/11/pubsub2.png><p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2014/11/pubsub1.png><p><img alt=image-20250418210559430 data-src=https://s2.loli.net/2025/04/18/7LEADu5klUBta8Q.png><p><img alt=image-20250418210832702 data-src=https://s2.loli.net/2025/04/18/2lE9g7iU3WBpsIy.png><h5 id=Stream><a class=headerlink href=#Stream title=Stream></a>Stream</h5><p>Redis Stream æ˜¯ Redis 5.0 ç‰ˆæœ¬æ–°å¢åŠ çš„æ•°æ®ç»“æ„ã€‚<p>Redis Stream ä¸»è¦ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—(MQï¼ŒMessage Queue),Redis æœ¬èº«æ˜¯æœ‰ä¸€ä¸ª Redis å‘å¸ƒè®¢é˜… (pub/sub) æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œä½†å®ƒæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ¶ˆ<strong>æ¯æ— æ³•æŒä¹…åŒ–ï¼Œå¦‚æœå‡ºç°ç½‘ç»œæ–­å¼€ã€Redis å®•æœºç­‰ï¼Œæ¶ˆæ¯å°±ä¼šè¢«ä¸¢å¼ƒ</strong>ã€‚<p>ç®€å•æ¥è¯´å‘å¸ƒè®¢é˜… (pub/sub) å¯ä»¥åˆ†å‘æ¶ˆæ¯ï¼Œä½†<strong>æ— æ³•è®°å½•å†å²æ¶ˆæ¯ã€‚</strong><p><strong>è€Œ Redis Stream æä¾›äº†æ¶ˆæ¯çš„æŒä¹…åŒ–å’Œä¸»å¤‡å¤åˆ¶åŠŸèƒ½</strong>ï¼Œå¯ä»¥è®©ä»»ä½•å®¢æˆ·ç«¯è®¿é—®ä»»ä½•æ—¶åˆ»çš„æ•°æ®ï¼Œå¹¶ä¸”èƒ½è®°ä½æ¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è®¿é—®ä½ç½®ï¼Œè¿˜èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚<p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2020/09/en-us_image_0167982791.png><ul><li><strong>Stream</strong>: åœ¨ Redis ä¸­ï¼Œä¸€ä¸ª Stream å°±æ˜¯ä¸€ä¸ªè¿½åŠ æ—¥å¿—ç±»å‹çš„é”®å€¼å¯¹é›†åˆã€‚<li><strong>Entry</strong>: æ¯ä¸ªæµä¸­çš„å…ƒç´ ç§°ä¸º Entry æˆ–è€… Messageï¼Œç”±å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆIDï¼‰å’Œæ•°æ®å­—æ®µç»„æˆã€‚<li><strong>Consumer Group</strong>: å…è®¸ä¸åŒçš„æ¶ˆè´¹è€…ç»„ä»åŒä¸€ä¸ªæµä¸­è¯»å–æ¶ˆæ¯ï¼Œæ¯ä¸ªç»„å¯ä»¥ç‹¬ç«‹åœ°è·Ÿè¸ªè‡ªå·±å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯ä½ç½®ã€‚<li><strong>ID</strong>: æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œæ ¼å¼ä¸º <code>&LTtimestamp>-&LTsequence></code>ï¼Œå…¶ä¸­æ—¶é—´æˆ³æ˜¯æ¶ˆæ¯æ·»åŠ æ—¶çš„æ—¶é—´ï¼Œåºåˆ—å·ç”¨äºåŒºåˆ†åŒä¸€æ¯«ç§’å†…æ·»åŠ çš„æ¶ˆæ¯ã€‚</ul><p><img alt=image-20250418223626722 data-src=https://s2.loli.net/2025/04/18/N41xhBcZ6qTWUiG.png><p><img style="zoom: 33%;" alt=image-20250418224505431 data-src=https://s2.loli.net/2025/04/18/JE9ZNCxDHaBWpw1.png><h5 id=åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„><a class=headerlink href=#åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„ title=åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„></a>åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</h5><p><img alt=image-20250418225321965 data-src=https://s2.loli.net/2025/04/18/oTspnQeVrkqgOcv.png><p>ç»™æ¶ˆè´¹è€…åˆ†ç±»,æ¶ˆæ¯æ¼è¯»,æ¶ˆæ¯ç¡®è®¤é¿å…æ¶ˆæ¯ä¸¢å¤±.<div class=table-container><table><thead><tr><th>å‘½ä»¤<th>ä½œç”¨<tbody><tr><td><code>XADD</code><td>æ·»åŠ æ¶ˆæ¯åˆ° Stream<tr><td><code>XRANGE</code> / <code>XREVRANGE</code><td>èŒƒå›´è¯»å–æ¶ˆæ¯ï¼ˆæ­£/åå‘ï¼‰<tr><td><code>XREAD</code><td>é˜»å¡æˆ–éé˜»å¡è¯»å–æ¶ˆæ¯<tr><td><code>XGROUP CREATE</code><td>åˆ›å»ºæ¶ˆè´¹è€…ç»„<tr><td><code>XREADGROUP</code><td>æŒ‰æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯<tr><td><code>XACK</code><td>ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†<tr><td><code>XPENDING</code><td>æŸ¥çœ‹å¾…å¤„ç†ï¼ˆæœª ackï¼‰æ¶ˆæ¯<tr><td><code>XDEL</code><td>åˆ é™¤æŒ‡å®šæ¶ˆæ¯<tr><td><code>XTRIM</code><td>è£å‰ªæ—§æ¶ˆæ¯ï¼Œæ§åˆ¶ Stream å¤§å°<tr><td><code>XLEN</code><td>è·å– Stream é•¿åº¦<tr><td><code>XINFO</code><td>è·å– Stream / Consumer è¯¦ç»†ä¿¡æ¯</table></div><h4 id=åˆ›å»ºç»„><a class=headerlink href=#åˆ›å»ºç»„ title=åˆ›å»ºç»„></a>åˆ›å»ºç»„</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XGROUP CREATE mystream mygroup $ MKSTREAM</span><br></pre></table></figure><blockquote><p>åˆ›å»ºåä¸º <code>mygroup</code> çš„æ¶ˆè´¹è€…ç»„ï¼Œ<code>$</code> ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œ<code>MKSTREAM</code> å¯è‡ªåŠ¨åˆ›å»º Streamã€‚</blockquote><h4 id=è¯»å–æ¶ˆæ¯><a class=headerlink href=#è¯»å–æ¶ˆæ¯ title=è¯»å–æ¶ˆæ¯></a>è¯»å–æ¶ˆæ¯</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XREADGROUP GROUP mygroup consumer1 COUNT 2 STREAMS mystream ></span><br></pre></table></figure><blockquote><p><code>></code> è¡¨ç¤ºè¯»å–å°šæœªåˆ†é…çš„æ¶ˆæ¯ï¼ˆæ–°æ¶ˆæ¯ï¼‰ã€‚</blockquote><h4 id=æ¶ˆæ¯ç¡®è®¤><a class=headerlink href=#æ¶ˆæ¯ç¡®è®¤ title=æ¶ˆæ¯ç¡®è®¤></a>æ¶ˆæ¯ç¡®è®¤</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XACK mystream mygroup 1686900000000-0</span><br></pre></table></figure><h4 id=æŸ¥çœ‹æœªç¡®è®¤æ¶ˆæ¯><a class=headerlink href=#æŸ¥çœ‹æœªç¡®è®¤æ¶ˆæ¯ title=æŸ¥çœ‹æœªç¡®è®¤æ¶ˆæ¯></a>æŸ¥çœ‹æœªç¡®è®¤æ¶ˆæ¯</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XPENDING mystream mygroup</span><br></pre></table></figure><div class=table-container><table><thead><tr><th>å‘½ä»¤<th>è¯´æ˜<tbody><tr><td><code>XINFO STREAM mystream</code><td>æŸ¥çœ‹ stream æœ¬ä½“ä¿¡æ¯<tr><td><code>XINFO GROUPS mystream</code><td>æŸ¥çœ‹æ‰€æœ‰æ¶ˆè´¹è€…ç»„ä¿¡æ¯<tr><td><code>XINFO CONSUMERS mystream mygroup</code><td>æŸ¥çœ‹æŸä¸ªæ¶ˆè´¹è€…ç»„ä¸­å„ä¸ªæ¶ˆè´¹è€…çŠ¶æ€</table></div><p><img alt=image-20250418233032176 data-src=https://s2.loli.net/2025/04/18/sVrCm1K7YTewhaq.png><p>æ¶ˆè´¹è€…ç»„ä¸­çš„å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ä½“ç°åœ¨<p>åœ¨ Redis Stream ä¸­ä½¿ç”¨ <strong>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰</strong> æ—¶ï¼Œæœ‰ä¸ªå…³é”®çš„æœºåˆ¶æ˜¯ï¼š<blockquote><p>â¤ <strong>åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…ï¼Œä¸€ä¸ªæ¶ˆæ¯åªä¼šè¢«åˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ã€‚</strong></blockquote><p>è¿™æ„å‘³ç€ï¼š<ul><li><p>å¦‚æœæ¶ˆè´¹è€… A <strong>å·²ç»è¯»å–å¹¶ ackï¼ˆç¡®è®¤ï¼‰äº†ä¸€æ¡æ¶ˆæ¯</strong>ï¼Œé‚£ä¹ˆï¼š</p> <ul><li>åŒç»„å†…çš„æ¶ˆè´¹è€… B æ˜¯ <strong>æ— æ³•å†è¯»å–è¿™æ¡æ¶ˆæ¯</strong> çš„ã€‚<li>é™¤éä½ ä¸“é—¨æŒ‡å®šæ¶ˆæ¯ ID é‡æ–°è¯»å–ï¼ˆä¾‹å¦‚ç”¨ <code>XREADGROUP</code> + æŒ‡å®š IDï¼‰ã€‚</ul><li><p>å¦‚æœä½ å¸Œæœ› <strong>æ¶ˆè´¹è€… B</strong> èƒ½â€œè¯»åˆ°ä¹‹å‰è¢«å…¶ä»–æ¶ˆè´¹è€…å·²å¤„ç†çš„æ¶ˆæ¯â€ï¼Œä½ å¿…é¡»æ˜¾å¼æŒ‡å®š IDï¼Œå¹¶è¯¥æ¶ˆæ¯<strong>æœªè¢« ack</strong>æˆ–ä½¿ç”¨ <code>XPENDING</code> æŸ¥æ‰¾ã€‚</p> <h5 id=âœ…å¦‚ä½•è®©æ¶ˆè´¹è€…è¯»å–â€œå†å²æ¶ˆæ¯â€ï¼Ÿ><a class=headerlink href=#âœ…å¦‚ä½•è®©æ¶ˆè´¹è€…è¯»å–â€œå†å²æ¶ˆæ¯â€ï¼Ÿ title=âœ…å¦‚ä½•è®©æ¶ˆè´¹è€…è¯»å–â€œå†å²æ¶ˆæ¯â€ï¼Ÿ></a>âœ…å¦‚ä½•è®©æ¶ˆè´¹è€…è¯»å–â€œå†å²æ¶ˆæ¯â€ï¼Ÿ</h5><p>åœºæ™¯ 1ï¼šæ¶ˆæ¯è¿˜æœªè¢« ackï¼ˆpendingï¼‰</p> <p>å¯ä»¥é€šè¿‡ <code>XPENDING</code> + <code>XCLAIM</code> æŠŠæ¶ˆæ¯â€œæŠ¢è¿‡æ¥â€ï¼š</p> <figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>javaCopyEditPendingMessages pending = stringRedisTemplate.ops<span class=constructor>ForStream()</span></span><br><span class=line>    .pending(<span class=string>"mystream"</span>, <span class=string>"mygroup"</span>, <span class=module-access><span class=module><span class=identifier>Range</span>.</span></span>unbounded<span class=literal>()</span>, <span class=number>10</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>for</span> (PendingMessage message : pending) {</span><br><span class=line>    <span class=comment>// æŠŠæœª ack çš„æ¶ˆæ¯äº¤ç»™å½“å‰æ¶ˆè´¹è€…</span></span><br><span class=line>    List&LTMapRecord&LTString, Object, Object>> records = stringRedisTemplate.ops<span class=constructor>ForStream()</span>.claim(</span><br><span class=line>        <span class=module-access><span class=module><span class=identifier>Consumer</span>.</span></span>from(<span class=string>"mygroup"</span>, <span class=string>"consumer2"</span>),</span><br><span class=line>        <span class=module-access><span class=module><span class=identifier>Duration</span>.</span></span><span class=keyword>of</span><span class=constructor>Seconds(5)</span>,</span><br><span class=line>        message.get<span class=constructor>Id()</span></span><br><span class=line>    );</span><br><span class=line>}</span><br></pre></table></figure> <p>åœºæ™¯ 2ï¼šæ¶ˆæ¯å·²è¢« ackï¼Œæƒ³é‡å¤è¯»å–</p> <p>Redis é»˜è®¤è®¾è®¡ä¸‹æ˜¯ä¸ä¼šè®©ä½ â€œé‡å¤æ¶ˆè´¹â€è¢« ack çš„æ¶ˆæ¯çš„ï¼Œ<strong>ä½†ä½ å¯ä»¥æ‰‹åŠ¨è¯»å–å®ƒï¼ˆä¸æ˜¯ group æ¨¡å¼ï¼‰</strong>ï¼š</p> <figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// ä¸ä½¿ç”¨æ¶ˆè´¹è€…ç»„ï¼Œç›´æ¥ç”¨ XREAD + ID</span></span><br><span class=line>List&LTMapRecord&LTString, Object, Object>> records = stringRedisTemplate.opsForStream()</span><br><span class=line>    .read(StreamOffset.fromStart(<span class=string>"mystream"</span>)); <span class=comment>// æˆ–è€…ç”¨å…·ä½“ ID</span></span><br></pre></table></figure> <p>ä¹Ÿå¯ä»¥ç”¨ <code>XRANGE</code> æ¥ç²¾ç¡®è¯»å–ï¼š</p> <figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// è·å–æŸæ¡å†å²æ¶ˆæ¯</span></span><br><span class=line>stringRedisTemplate.opsForStream()</span><br><span class=line>    .range(<span class=string>"mystream"</span>, Range.closed(<span class=string>"1682390889639-0"</span>, <span class=string>"1682390889639-0"</span>));</span><br></pre></table></figure> <p>| åœºæ™¯ | æ˜¯å¦èƒ½é‡æ–°è¯»å– |<br>| â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |<br>| æ¶ˆè´¹è€…ç»„å†…ï¼Œæ¶ˆæ¯å·²è¢« ack | âŒï¼ˆé™¤éç”¨é group æ–¹å¼æ‰‹åŠ¨è¯»ï¼‰ |<br>| æ¶ˆè´¹è€…ç»„å†…ï¼Œæ¶ˆæ¯æœªè¢« ackï¼ˆpendingï¼‰ | âœ…ï¼ˆå¯ä»¥ç”¨ XCLAIM æŠ¢å›æ¥ï¼‰ |<br>| æƒ³è®©å¤šä¸ªæ¶ˆè´¹è€…éƒ½èƒ½è¯»ä¸€æ¡æ¶ˆæ¯ | âŒï¼ˆç»„å†…ä¸æ”¯æŒï¼›éœ€é group è¯»ï¼‰ |</p></ul><p><img alt=image-20250418233143096 data-src=https://s2.loli.net/2025/04/18/ay8uA5fSi3RvTMV.png><p><img alt=image-20250419131039088 data-src=https://s2.loli.net/2025/04/19/4rg9LteAzoDlaWb.png style=zoom:50%;><p><img alt=image-20250419131059130 data-src=https://s2.loli.net/2025/04/19/muwJasz9gGTxAHK.png><h3 id=è¾¾äººæ¢åº—><a class=headerlink href=#è¾¾äººæ¢åº— title=è¾¾äººæ¢åº—></a>è¾¾äººæ¢åº—</h3><h4 id=ç‚¹èµåŠŸèƒ½><a class=headerlink href=#ç‚¹èµåŠŸèƒ½ title=ç‚¹èµåŠŸèƒ½></a>ç‚¹èµåŠŸèƒ½</h4><p><img alt=image-20250420143555600 data-src=https://s2.loli.net/2025/04/20/p92Zqc4evEjimXY.png><h4 id=ç‚¹èµæ’è¡Œæ¦œ><a class=headerlink href=#ç‚¹èµæ’è¡Œæ¦œ title=ç‚¹èµæ’è¡Œæ¦œ></a>ç‚¹èµæ’è¡Œæ¦œ</h4><p><img alt=image-20250420144640978 data-src=https://s2.loli.net/2025/04/20/Y2jI3QHEemkOBvi.png><h4 id=å¥½å‹å…³æ³¨><a class=headerlink href=#å¥½å‹å…³æ³¨ title=å¥½å‹å…³æ³¨></a>å¥½å‹å…³æ³¨</h4><p>å†™ä¸¤ä¸ªæ¥å£,ä¸€ä¸ªæŸ¥çœ‹æ˜¯å¦å…³æ³¨,å¦ä¸€ä¸ªè¿›è¡Œå…³æ³¨æˆ–å–å…³.<p>å…³æ³¨çš„æ•°æ®è¡¨è®¾è®¡ä¸ºuser_idå’Œfollower_id. ä¸ºä¸€ä¸ªå…³æ³¨è®°å½•<p><img alt=image-20250420200822771 data-src=https://s2.loli.net/2025/04/20/OqkUF4G21LYZM5K.png><p><img alt=image-20250420200856032 data-src=https://s2.loli.net/2025/04/20/hNcu5avy2WmPBMk.png><h4 id=å…±åŒå…³æ³¨><a class=headerlink href=#å…±åŒå…³æ³¨ title=å…±åŒå…³æ³¨></a>å…±åŒå…³æ³¨</h4><p><img alt=image-20250420200600057 data-src=https://s2.loli.net/2025/04/20/thV71ZUKQlaqs3i.png><p>åœ¨æ–°å¢å…³æ³¨æ—¶æ·»åŠ ç¼“å­˜,åŒæ—¶åˆ©ç”¨redisä¸­çš„setäº¤é›†æ“ä½œåœ¨ç¼“å­˜ä¸­å¾—åˆ°å…±åŒå…³æ³¨<h4 id=å…³æ³¨æ¨é€><a class=headerlink href=#å…³æ³¨æ¨é€ title=å…³æ³¨æ¨é€></a>å…³æ³¨æ¨é€</h4><p><img alt=image-20250420220334492 data-src=https://s2.loli.net/2025/04/20/gCqrxOB86TdfhLb.png><p><img alt=image-20250421092155097 data-src=https://s2.loli.net/2025/04/21/8wXL5PpFBWu1c6K.png><p>é€šè¿‡æ¨æ¨¡å¼,é€šè¿‡åˆ†é¡µæ»šåŠ¨è¯»å–å…³æ³¨ç”¨æˆ·å‘å¸ƒçš„åšå®¢æ•°æ®. ç”¨æˆ·å‘å¸ƒåšå®¢æ—¶å°†åšå®¢idåŠ å…¥å…³æ³¨è‡ªå·±çš„ç²‰ä¸çš„æ”¶ä»¶ç®±, ä½¿ç”¨sorted set,ä»¥æ—¶é—´æˆ³ä¸ºscore(å³æ¨æ¨¡å¼)<p><img alt=image-20250421224913326 data-src=https://s2.loli.net/2025/04/21/9IYeW5iocs3u1PB.png><p>å…³é”®æ˜¯åˆ©ç”¨æœ€æ–°çš„æ—¶é—´æˆ³å»æ‹¿æœ€æ–°çš„åšå®¢id,åŒæ—¶åˆ©ç”¨åç§»é‡æ»¤å»ç›¸åŒçš„æ—¶é—´æˆ³(é»˜è®¤ä¸ä¼šé‡å¤). å¦‚æœè€ƒè™‘å‘å¸ƒæ—¶é—´é‡å¤,ä¹Ÿå¯ä»¥åœ¨å­˜å‚¨scoreæ—¶åœ¨æ—¶é—´æˆ³åŸºç¡€ä¸ŠåŠ ä¸€ä¸ªéšæœºå€¼é¿å…scoreé‡å¤.<h4 id=é™„è¿‘å•†æˆ·><a class=headerlink href=#é™„è¿‘å•†æˆ· title=é™„è¿‘å•†æˆ·></a>é™„è¿‘å•†æˆ·</h4><p><a href=https://www.runoob.com/redis/redis-geo.html rel=noopener target=_blank>Redis GEO | èœé¸Ÿæ•™ç¨‹</a><p>Redis GEO ä¸»è¦ç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œï¼Œè¯¥åŠŸèƒ½åœ¨ Redis 3.2 ç‰ˆæœ¬æ–°å¢ã€‚<p>Redis GEO æ“ä½œæ–¹æ³•æœ‰ï¼š<ul><li>geoaddï¼šæ·»åŠ åœ°ç†ä½ç½®çš„åæ ‡ã€‚<li>geoposï¼šè·å–åœ°ç†ä½ç½®çš„åæ ‡ã€‚<li>geodistï¼šè®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚<li>georadiusï¼šæ ¹æ®ç”¨æˆ·ç»™å®šçš„ç»çº¬åº¦åæ ‡æ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚<li>georadiusbymemberï¼šæ ¹æ®å‚¨å­˜åœ¨ä½ç½®é›†åˆé‡Œé¢çš„æŸä¸ªåœ°ç‚¹è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚<li>geohashï¼šè¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å¯¹è±¡çš„ geohash å€¼ã€‚</ul><p>geoadd ç”¨äºå­˜å‚¨æŒ‡å®šçš„åœ°ç†ç©ºé—´ä½ç½®ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€ä½ç½®åç§°(member)æ·»åŠ åˆ°æŒ‡å®šçš„ key ä¸­ã€‚<p>geoadd è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>GEOADD key longitude latitude member [longitude latitude member ...]</span><br></pre></table></figure><ul><li>m ï¼šç±³ï¼Œé»˜è®¤å•ä½ã€‚<li>km ï¼šåƒç±³ã€‚<li>mi ï¼šè‹±é‡Œã€‚<li>ft ï¼šè‹±å°ºã€‚<li>WITHDIST: åœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œ å°†ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚<li>WITHCOORD: å°†ä½ç½®å…ƒç´ çš„ç»åº¦å’Œçº¬åº¦ä¹Ÿä¸€å¹¶è¿”å›ã€‚<li>WITHHASH: ä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚<li>COUNT é™å®šè¿”å›çš„è®°å½•æ•°ã€‚<li>ASC: æŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»è¿‘åˆ°è¿œæ’åºã€‚<li>DESC: æŸ¥æ‰¾ç»“æœæ ¹æ®ä»è¿œåˆ°è¿‘æ’åºã€‚</ul><h4 id=ç”¨æˆ·ç­¾åˆ°><a class=headerlink href=#ç”¨æˆ·ç­¾åˆ° title=ç”¨æˆ·ç­¾åˆ°></a>ç”¨æˆ·ç­¾åˆ°</h4><p><img alt=image-20250422105634699 data-src=https://s2.loli.net/2025/04/22/61cqOWxZMwnfemh.png><p><img alt=image-20250422111632294 data-src=https://s2.loli.net/2025/04/22/aGspbuONkSMdqxf.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>LocalDateTime now = LocalDateTime.now();</span><br><span class=line><span class=keyword>int</span> dayOfYear = now.getDayOfYear();</span><br><span class=line><span class=keyword>int</span> year = now.getYear();</span><br><span class=line>String key = SIGN_KEY + UserHolder.getUser().getId()+ <span class=string>":"</span> + year;</span><br><span class=line>Boolean signSuccess = stringRedisTemplate.opsForValue().setBit(key, dayOfYear-<span class=number>1</span>, <span class=keyword>true</span>);</span><br><span class=line><span class=keyword>if</span> (BooleanUtil.isTrue(signSuccess)) {</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>}<span class=keyword>else</span>{</span><br><span class=line>    <span class=keyword>return</span> Result.fail(<span class=string>"ç­¾åˆ°å¤±è´¥"</span>);</span><br><span class=line>}</span><br></pre></table></figure><h4 id=ç­¾åˆ°ç»Ÿè®¡><a class=headerlink href=#ç­¾åˆ°ç»Ÿè®¡ title=ç­¾åˆ°ç»Ÿè®¡></a>ç­¾åˆ°ç»Ÿè®¡</h4><p>ä½¿ç”¨<code>bitfield</code>æŸ¥è¯¢ä¸€ä¸ªèŒƒå›´å†…çš„äºŒè¿›åˆ¶è¿”å›åè¿›åˆ¶æ•°æ®.<p><img alt=image-20250422121102888 data-src=https://s2.loli.net/2025/04/22/dfuNzSwYlVOsJD1.png><h4 id=UVç»Ÿè®¡-HyperLogLog><a title="UVç»Ÿè®¡  HyperLogLog" class=headerlink href=#UVç»Ÿè®¡-HyperLogLog></a>UVç»Ÿè®¡ HyperLogLog</h4><p>Redis HyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ï¼ŒHyperLogLog çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨è¾“å…¥å…ƒç´ çš„æ•°é‡æˆ–è€…ä½“ç§¯éå¸¸éå¸¸å¤§æ—¶ï¼Œè®¡ç®—åŸºæ•°æ‰€éœ€çš„ç©ºé—´æ€»æ˜¯å›ºå®š çš„ã€å¹¶ä¸”æ˜¯å¾ˆå°çš„ã€‚<p>åœ¨ Redis é‡Œé¢ï¼Œæ¯ä¸ª HyperLogLog é”®åªéœ€è¦èŠ±è´¹ 12 KB å†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æ¥è¿‘ 2^64 ä¸ªä¸åŒå…ƒç´ çš„åŸº æ•°ã€‚è¿™å’Œè®¡ç®—åŸºæ•°æ—¶ï¼Œå…ƒç´ è¶Šå¤šè€—è´¹å†…å­˜å°±è¶Šå¤šçš„é›†åˆå½¢æˆé²œæ˜å¯¹æ¯”ã€‚<p>ä½†æ˜¯ï¼Œå› ä¸º HyperLogLog åªä¼šæ ¹æ®è¾“å…¥å…ƒç´ æ¥è®¡ç®—åŸºæ•°ï¼Œè€Œä¸ä¼šå‚¨å­˜è¾“å…¥å…ƒç´ æœ¬èº«ï¼Œæ‰€ä»¥ HyperLogLog ä¸èƒ½åƒé›†åˆé‚£æ ·ï¼Œè¿”å›è¾“å…¥çš„å„ä¸ªå…ƒç´ ã€‚<p><img alt=image-20250422121540587 data-src=https://s2.loli.net/2025/04/22/MEm6zF5nt28TBch.png><p><img alt=image-20250422122336390 data-src=https://s2.loli.net/2025/04/22/ztXRO9DFqkU68xV.png><h1 id=EasyChat><a class=headerlink href=#EasyChat title=EasyChat></a>EasyChat</h1><h3 id=ç™»å½•æ³¨å†Œ><a class=headerlink href=#ç™»å½•æ³¨å†Œ title=ç™»å½•æ³¨å†Œ></a>ç™»å½•æ³¨å†Œ</h3><p><img alt=image-20250502155041889 data-src=https://s2.loli.net/2025/05/02/C8LFUSamDZfsJPA.png><p><img alt=image-20250502195913653 data-src=https://s2.loli.net/2025/05/02/WABFut1yEYeLSPa.png><h4 id=ç™»é™†><a class=headerlink href=#ç™»é™† title=ç™»é™†></a>ç™»é™†</h4><p>ç™»é™†æ—¶æ£€æŸ¥å¿ƒè·³ç¼“å­˜é¿å…åˆ«å¤„ç™»é™†,å®Œæˆåä¿å­˜ç”¨æˆ·ä¿¡æ¯ç¼“å­˜,å¹¶æŸ¥è¯¢è”ç³»äººå­˜åœ¨ç¼“å­˜ä¸­.<h4 id=æ³¨å†Œ><a class=headerlink href=#æ³¨å†Œ title=æ³¨å†Œ></a>æ³¨å†Œ</h4><p>æ³¨å†Œå®Œæˆå,ä¸»è¦æ˜¯åˆ›å»ºäº†æœºå™¨äººè´¦å·å¹¶åŠ å…¥äº†ä¼šè¯<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br></pre><td class=code><pre><span class=line>Date curDate = <span class=keyword>new</span> Date();</span><br><span class=line></span><br><span class=line>SysSettingDto sysSettingDto = redisComponet.getSysSetting();</span><br><span class=line>String contactId = sysSettingDto.getRobotUid();</span><br><span class=line>String contactName = sysSettingDto.getRobotNickName();</span><br><span class=line>String senMessage = sysSettingDto.getRobotWelcome();</span><br><span class=line>senMessage = StringTools.cleanHtmlTag(senMessage);</span><br><span class=line><span class=comment>//å¢åŠ æœºå™¨äººå¥½å‹</span></span><br><span class=line>UserContact userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>userContact.setUserId(userId);</span><br><span class=line>userContact.setContactId(contactId);</span><br><span class=line>userContact.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>userContact.setCreateTime(curDate);</span><br><span class=line>userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>userContact.setLastUpdateTime(curDate);</span><br><span class=line>userContactMapper.insert(userContact);</span><br><span class=line></span><br><span class=line><span class=comment>//å¢åŠ ä¼šè¯ä¿¡æ¯</span></span><br><span class=line>String sessionId = StringTools.getChatSessionId4User(<span class=keyword>new</span> String[]{userId, contactId});</span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(senMessage);</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insert(chatSession);</span><br><span class=line></span><br><span class=line>ChatSessionUser applySessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>applySessionUser.setUserId(userId);</span><br><span class=line>applySessionUser.setContactId(contactId);</span><br><span class=line>applySessionUser.setContactName(contactName);</span><br><span class=line>applySessionUser.setSessionId(sessionId);</span><br><span class=line><span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdate(applySessionUser);</span><br><span class=line></span><br><span class=line><span class=comment>//å¢åŠ èŠå¤©æ¶ˆæ¯</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.CHAT.getType());</span><br><span class=line>chatMessage.setMessageContent(senMessage);</span><br><span class=line>chatMessage.setSendUserId(contactId);</span><br><span class=line>chatMessage.setSendUserNickName(contactName);</span><br><span class=line>chatMessage.setSendTime(curDate.getTime());</span><br><span class=line>chatMessage.setContactId(userId);</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><h4 id=ä¿å­˜ç”¨æˆ·ä¿¡æ¯><a class=headerlink href=#ä¿å­˜ç”¨æˆ·ä¿¡æ¯ title=ä¿å­˜ç”¨æˆ·ä¿¡æ¯></a>ä¿å­˜ç”¨æˆ·ä¿¡æ¯</h4><p>æ›´æ–°ç”¨æˆ·ä¿¡æ¯,controllerå‚æ•°è®¾ç½®ä¸ºuserInfo,ç„¶åå°†å…¶ä¸­çš„ä¸èƒ½ä¿®æ”¹çš„ä¿¡æ¯è®¾ç½®ä¸ºnull.<p>å¦‚æœæ›´æ”¹äº†æ˜µç§°,æ›´æ–°ç¼“å­˜ä¸­çš„ç”¨æˆ·ä¿¡æ¯,é”®ä¸ºtoken.<p>é™¤äº†æ›´æ–°userinfoè¡¨,å¦‚æœæ˜µç§°ä¸ä¸€æ ·è¿˜è¦æ›´æ–°chat_session_userè¡¨,æ ¹æ®contact<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=comment>//æ›´æ–°ç›¸å…³è¡¨å†—ä½™çš„å­—æ®µ</span></span><br><span class=line>String contactNameUpdate = null;</span><br><span class=line><span class=keyword>if</span> (!dbInfo.get<span class=constructor>NickName()</span>.equals(userInfo.get<span class=constructor>NickName()</span>)) {</span><br><span class=line>    contactNameUpdate = userInfo.get<span class=constructor>NickName()</span>;</span><br><span class=line>}</span><br><span class=line><span class=keyword>if</span> (contactNameUpdate<span class=operator> == </span>null) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line><span class=comment>//æ›´æ–°tokenä¸­çš„æ˜µç§°</span></span><br><span class=line>TokenUserInfoDto tokenUserInfoDto = redisComponet.get<span class=constructor>TokenUserInfoDtoByUserId(<span class=params>userInfo</span>.<span class=params>getUserId</span>()</span>);</span><br><span class=line>tokenUserInfoDto.set<span class=constructor>NickName(<span class=params>contactNameUpdate</span>)</span>;</span><br><span class=line>redisComponet.save<span class=constructor>TokenUserInfoDto(<span class=params>tokenUserInfoDto</span>)</span>;</span><br><span class=line></span><br><span class=line>chatSessionUserService.update<span class=constructor>RedundanceInfo(<span class=params>contactNameUpdate</span>, <span class=params>userInfo</span>.<span class=params>getUserId</span>()</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>if</span> (<span class=module-access><span class=module><span class=identifier>StringTools</span>.</span></span>is<span class=constructor>Empty(<span class=params>contactName</span>)</span>) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line>ChatSessionUser updateInfo = <span class=keyword>new</span> <span class=constructor>ChatSessionUser()</span>;</span><br><span class=line>updateInfo.set<span class=constructor>ContactName(<span class=params>contactName</span>)</span>;</span><br><span class=line><span class=comment>// æ›´æ–°chat_session_userä¸­çš„contact_name</span></span><br><span class=line>ChatSessionUserQuery chatSessionUserQuery = <span class=keyword>new</span> <span class=constructor>ChatSessionUserQuery()</span>;</span><br><span class=line>chatSessionUserQuery.set<span class=constructor>ContactId(<span class=params>contactId</span>)</span>;</span><br><span class=line>this.chatSessionUserMapper.update<span class=constructor>ByParam(<span class=params>updateInfo</span>, <span class=params>chatSessionUserQuery</span>)</span>;</span><br></pre></table></figure><p>ç„¶åé’ˆå¯¹è”ç³»äºº,å‘é€åç§°æ›´æ–°çš„wsæ¶ˆæ¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>userContactQuery.setContactId(contactId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>List&LTUserContact> userContactList = userContactMapper.selectList(userContactQuery);</span><br><span class=line><span class=keyword>for</span> (UserContact userContact : userContactList) {</span><br><span class=line>    MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>    messageSendDto.setContactType(contactTypeEnum.getType());</span><br><span class=line>    messageSendDto.setContactId(userContact.getUserId());</span><br><span class=line>    messageSendDto.setExtendData(contactName);</span><br><span class=line>    messageSendDto.setMessageType(MessageTypeEnum.CONTACT_NAME_UPDATE.getType());</span><br><span class=line>    messageSendDto.setSendUserId(contactId);</span><br><span class=line>    messageSendDto.setSendUserNickName(contactName);</span><br><span class=line>    messageHandler.sendMessage(messageSendDto);</span><br><span class=line>}</span><br></pre></table></figure><p>å¦‚æœä¸Šä¼ çš„å¤´åƒæ–‡ä»¶ä¸ä¸ºç©º,åˆ™ä¸‹è½½åˆ°æœåŠ¡å™¨å¯¹åº”è·¯å¾„. BASE_FOLDER+FILE+AVATAR+user_id.jpg<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (avatarFile != <span class=keyword>null</span>) {</span><br><span class=line>    String baseFolder = appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE;</span><br><span class=line>    File targetFileFolder = <span class=keyword>new</span> File(baseFolder + Constants.FILE_FOLDER_AVATAR_NAME);</span><br><span class=line>    <span class=keyword>if</span> (!targetFileFolder.exists()) {</span><br><span class=line>        targetFileFolder.mkdirs();</span><br><span class=line>    }</span><br><span class=line>    String filePath = targetFileFolder.getPath() + <span class=string>"/"</span> + userInfo.getUserId() + Constants.IMAGE_SUFFIX;</span><br><span class=line>    avatarFile.transferTo(<span class=keyword>new</span> File(filePath));</span><br><span class=line>    avatarCover.transferTo(<span class=keyword>new</span> File(filePath + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>}</span><br></pre></table></figure><h4 id=è·å–ç”¨æˆ·ä¿¡æ¯><a class=headerlink href=#è·å–ç”¨æˆ·ä¿¡æ¯ title=è·å–ç”¨æˆ·ä¿¡æ¯></a>è·å–ç”¨æˆ·ä¿¡æ¯</h4><p>ç›´æ¥æŸ¥è¯¢å³å¯<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>UserInfo userInfo = userInfoService.getUserInfoByUserId(tokenUserInfoDto.getUserId());</span><br><span class=line>UserInfoVO userInfoVO = CopyTools.copy(userInfo, UserInfoVO.class);</span><br><span class=line>userInfoVO.setAdmin(tokenUserInfoDto.getAdmin());</span><br><span class=line><span class=keyword>return</span> getSuccessResponseVO(userInfoVO);</span><br></pre></table></figure><h4 id=æ›´æ–°å¯†ç ><a class=headerlink href=#æ›´æ–°å¯†ç  title=æ›´æ–°å¯†ç ></a>æ›´æ–°å¯†ç </h4><h4 id=é€€å‡º><a class=headerlink href=#é€€å‡º title=é€€å‡º></a>é€€å‡º</h4><h3 id=ç¾¤ç»„ç®¡ç†><a class=headerlink href=#ç¾¤ç»„ç®¡ç† title=ç¾¤ç»„ç®¡ç†></a>ç¾¤ç»„ç®¡ç†</h3><p><img alt=image-20250502195944284 data-src=https://s2.loli.net/2025/05/02/XZeaDzgW8tl5LMA.png><p><img alt=image-20250502200016447 data-src=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png><h4 id=æŸ¥çœ‹è‡ªå·±ç¾¤èŠ><a class=headerlink href=#æŸ¥çœ‹è‡ªå·±ç¾¤èŠ title=æŸ¥çœ‹è‡ªå·±ç¾¤èŠ></a>æŸ¥çœ‹è‡ªå·±ç¾¤èŠ</h4><p>æŸ¥è¯¢user_contactè¡¨,ç¾¤ç»„owneræ˜¯è‡ªå·±,åˆ›å»ºæ—¶é—´é™åº,ç¾¤ç»„çŠ¶æ€æ­£å¸¸.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>     TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>       GroupInfoQuery infoQuery = <span class=keyword>new</span> GroupInfoQuery();</span><br><span class=line>       infoQuery.setGroupOwnerId(tokenUserInfoDto.getUserId());</span><br><span class=line>       infoQuery.setOrderBy(<span class=string>"create_time desc"</span>);</span><br><span class=line>infoQuery.setStatus(GroupStatusEnum.NORMAL.getStatus());</span><br><span class=line>       List&LTGroupInfo> groupInfoList = <span class=keyword>this</span>.groupInfoService.findListByParam(infoQuery);</span><br><span class=line>       <span class=keyword>return</span> getSuccessResponseVO(groupInfoList);</span><br></pre></table></figure><h4 id=æŸ¥çœ‹ç¾¤èŠä¿¡æ¯><a class=headerlink href=#æŸ¥çœ‹ç¾¤èŠä¿¡æ¯ title=æŸ¥çœ‹ç¾¤èŠä¿¡æ¯></a>æŸ¥çœ‹ç¾¤èŠä¿¡æ¯</h4><p>æ ¹æ®groupId,é¦–å…ˆçœ‹ç¾¤èŠæ˜¯å¦å­˜åœ¨,ä»¥åŠè‡ªå·±æ˜¯å¦åœ¨ç¾¤èŠä¸­,æŸ¥è¯¢user_contactè¡¨(è®¾ç½®è”ç³»çŠ¶æ€æ˜¯å¥½å‹),å¦‚æœåœ¨ç¾¤èŠä¸­æ‰èƒ½ç»§ç»­æŸ¥çœ‹. æŸ¥è¯¢groupInfoè¡¨<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>UserContact userContact = <span class=keyword>this</span>.userContactService.getUserContactByUserIdAndContactId(tokenUserInfoDto.getUserId(), groupId);</span><br><span class=line><span class=keyword>if</span> (userContact == <span class=keyword>null</span> || !UserContactStatusEnum.FRIEND.getStatus().equals(userContact.getStatus())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"ä½ ä¸åœ¨ç¾¤èŠæˆ–è€…ç¾¤èŠä¸å­˜åœ¨æˆ–å·²ç»è§£æ•£"</span>);</span><br><span class=line>}</span><br><span class=line>GroupInfo groupInfo = <span class=keyword>this</span>.groupInfoService.getGroupInfoByGroupId(groupId);</span><br><span class=line><span class=keyword>if</span> (groupInfo == <span class=keyword>null</span> || !GroupStatusEnum.NORMAL.getStatus().equals(groupInfo.getStatus())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"ç¾¤èŠä¸å­˜åœ¨æˆ–å·²ç»è§£æ•£"</span>);</span><br><span class=line>}</span><br><span class=line><span class=keyword>return</span> groupInfo;</span><br></pre></table></figure><p>åŒæ—¶æŸ¥è¯¢user_contactè¡¨æŸ¥è¯¢ç¾¤æˆå‘˜ä¸ªæ•°ä¸€èµ·è¿”å›<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactService.findCountByParam(userContactQuery);</span><br><span class=line>groupInfo.setMemberCount(memberCount);</span><br></pre></table></figure><p>ä¸Šé¢æ˜¯æŸ¥çœ‹ç¾¤èŠä¿¡æ¯,ä½†ä¸åŒ…å«ç¾¤èŠä¸­æˆå‘˜,è¿˜æœ‰ä¸€ä¸ªæ¥å£å¯ä»¥æŸ¥è¯¢ç¾¤æˆå‘˜,ä¹Ÿå°±æ˜¯åœ¨user_contactè¡¨ä¸­æŸ¥çœ‹contact_idæ˜¯ç¾¤id,çŠ¶æ€æ˜¯è”ç³»äººçš„<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GroupInfo groupInfo = getGroupDetailCommon(request, groupId);</span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setQueryUserInfo(<span class=keyword>true</span>);</span><br><span class=line>userContactQuery.setOrderBy(<span class=string>"create_time asc"</span>);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>List&LTUserContact> userContactList = <span class=keyword>this</span>.userContactService.findListByParam(userContactQuery);</span><br><span class=line>GroupInfoVO groupInfoVo = <span class=keyword>new</span> GroupInfoVO();</span><br><span class=line>groupInfoVo.setGroupInfo(groupInfo);</span><br><span class=line>groupInfoVo.setUserContactList(userContactList);</span><br><span class=line><span class=keyword>return</span> getSuccessResponseVO(groupInfoVo);</span><br></pre></table></figure><h4 id=åˆ›å»º-æ›´æ–°ç¾¤èŠ><a class=headerlink href=#åˆ›å»º-æ›´æ–°ç¾¤èŠ title=åˆ›å»º/æ›´æ–°ç¾¤èŠ></a>åˆ›å»º/æ›´æ–°ç¾¤èŠ</h4><p>åˆ›å»ºä¸æ›´æ–°ç¾¤èŠæ¥å£ç±»ä¼¼,ä¼ å…¥groupId,å¦‚æœä¸ºç©ºåˆ™åˆ›å»ºç¾¤èŠ.<p>ä¸€ä¸ªç”¨æˆ·åˆ›å»ºç¾¤èŠä¸ªæ•°æœ‰é™,æ‰€ä»¥å…ˆè¿›è¡ŒæŸ¥è¯¢çœ‹æ˜¯å¦æ»¡è¶³æ¡ä»¶.<p>æ»¡è¶³ä¹‹å,æ’å…¥ç¾¤èŠä¿¡æ¯,user_contactè”ç³»ä¿¡æ¯,ç”¨æˆ·è”ç³»äººç¼“å­˜æ›´æ–°,channelContextUtilsåŠ å…¥ç¾¤ç»„channelGroup,æ’å…¥chat_session_userè¡¨,æ’å…¥session_userè¡¨,æ’å…¥chat_messageè¡¨,æœ€åå‘é€messageSendDto.<p>å¦‚æœæ˜¯æ›´æ–°ç¾¤èŠ,åˆ™æ›´æ–°ç¾¤ç»„ä¿¡æ¯,æ›´æ–°user_contactè¡¨ä¸chat_session_userè¡¨(ä¸»è¦æ›´æ–°ç¾¤èŠåç§°)<p>æ›´æ–°chat_session_userä¸­contact_name.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>ChatSessionUser updateInfo = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>updateInfo.setContactName(contactName);</span><br><span class=line></span><br><span class=line>ChatSessionUserQuery chatSessionUserQuery = <span class=keyword>new</span> ChatSessionUserQuery();</span><br><span class=line>chatSessionUserQuery.setContactId(contactId);</span><br><span class=line><span class=keyword>this</span>.chatSessionUserMapper.updateByParam(updateInfo, chatSessionUserQuery);</span><br></pre></table></figure><p>ç„¶åå‘é€wsæ¶ˆæ¯é€šçŸ¥ç¾¤èŠæˆå‘˜æ›´æ”¹äº†ç¾¤åç§°.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>messageSendDto.setContactType(UserContactTypeEnum.getByPrefix(contactId).getType());</span><br><span class=line>messageSendDto.setContactId(contactId);</span><br><span class=line>messageSendDto.setExtendData(contactName);</span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.CONTACT_NAME_UPDATE.getType());</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><p>ç”¨æˆ·æ›´æ”¹æ˜µç§°å…¶å®ç±»ä¼¼,ä¹Ÿéœ€è¦å‘ä»–çš„è”ç³»äººé€šçŸ¥<p>å¦‚æœä¸Šä¼ äº†ç¾¤èŠå¤´åƒæ–‡ä»¶,åˆ™å­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶è·¯å¾„, basePath+FILE_FOLDER_FILE+FILE_FOLDER_AVATAR_NAME+ç¾¤èŠid<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>String baseFolder = appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE;</span><br><span class=line>File targetFileFolder = <span class=keyword>new</span> File(baseFolder + Constants.FILE_FOLDER_AVATAR_NAME);</span><br><span class=line><span class=keyword>if</span> (!targetFileFolder.exists()) {</span><br><span class=line>    targetFileFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line>String filePath = targetFileFolder.getPath() + <span class=string>"/"</span> + groupInfo.getGroupId() + Constants.IMAGE_SUFFIX;</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    avatarFile.transferTo(<span class=keyword>new</span> File(filePath));</span><br><span class=line>    avatarCover.transferTo(<span class=keyword>new</span> File(filePath + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>} <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>    logger.error(<span class=string>"å¤´åƒä¸Šä¼ å¤±è´¥"</span>, e);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"å¤´åƒä¸Šä¼ å¤±è´¥"</span>);</span><br><span class=line>}</span><br></pre></table></figure><h4 id=è§£æ•£ç¾¤èŠ><a class=headerlink href=#è§£æ•£ç¾¤èŠ title=è§£æ•£ç¾¤èŠ></a>è§£æ•£ç¾¤èŠ</h4><p>æ›´æ–°group_infoçŠ¶æ€ç¾¤èŠè¢«è§£æ•£,æ›´æ–°è”ç³»äººuser_contactçŠ¶æ€ä¸ºåˆ é™¤(contact_idä¸ºç¾¤id),åˆ é™¤å¯¹åº”ç¼“å­˜<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=comment>// æ›´æ–°ç¾¤è§£æ•£çŠ¶æ€</span></span><br><span class=line>GroupInfo updateInfo = <span class=keyword>new</span> GroupInfo();</span><br><span class=line>updateInfo.setStatus(GroupStatusEnum.DISSOLUTION.getStatus());</span><br><span class=line><span class=keyword>this</span>.groupInfoMapper.updateByGroupId(updateInfo, groupId);</span><br><span class=line></span><br><span class=line><span class=comment>// æ›´æ–°user_contactçŠ¶æ€ åˆ é™¤</span></span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line></span><br><span class=line>UserContact updateUserContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>updateUserContact.setStatus(UserContactStatusEnum.DEL.getStatus());</span><br><span class=line>userContactMapper.updateByParam(updateUserContact, userContactQuery);</span><br><span class=line><span class=comment>// åˆ é™¤å¯¹åº”è”ç³»äººç¼“å­˜</span></span><br><span class=line>List&LTUserContact> userContactList = <span class=keyword>this</span>.userContactMapper.selectList(userContactQuery);</span><br><span class=line>    <span class=keyword>for</span> (UserContact userContact : userContactList) {</span><br><span class=line>        redisComponet.removeUserContact(userContact.getUserId(), userContact.getContactId());</span><br><span class=line>    }</span><br></pre></table></figure><p>é™¤æ­¤ä¹‹å¤–,æ›´æ–°chat_sessionè¡¨ç¾¤è§£æ•£æ¶ˆæ¯å’Œæ—¶é—´,æ’å…¥chat_messageè¡¨æ›´æ–°ç¾¤è§£æ•£æ¶ˆæ¯,GROUP_CONTEXT_MAPåˆ é™¤ç¾¤ç»„channelGroup<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>String sessionId = StringTools.getChatSessionId4Group(groupId);</span><br><span class=line>Date curTime = <span class=keyword>new</span> Date();</span><br><span class=line>String messageContent = MessageTypeEnum.DISSOLUTION_GROUP.getInitMessage();</span><br><span class=line><span class=comment>//æ›´æ–°ä¼šè¯æ¶ˆæ¯</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line>chatSession.setLastReceiveTime(curTime.getTime());</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//è®°å½•æ¶ˆæ¯æ¶ˆæ¯è¡¨</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendTime(curTime.getTime());</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.DISSOLUTION_GROUP.getType());</span><br><span class=line>chatMessage.setContactId(groupId);</span><br><span class=line>chatMessage.setMessageContent(messageContent);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>è¿˜éœ€è¦ç»™å‘é€ç¾¤æˆå‘˜wsæ¶ˆæ¯,å‘ŠçŸ¥ç¾¤ç»„è§£æ•£.<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>  <span class=comment>//å‘é€è§£æ•£ç¾¤æ¶ˆæ¯</span></span><br><span class=line>        MessageSendDto messageSendDto = <span class=module-access><span class=module><span class=identifier>CopyTools</span>.</span></span>copy(chatMessage, <span class=module-access><span class=module><span class=identifier>MessageSendDto</span>.</span></span><span class=keyword>class</span>);</span><br><span class=line>        messageHandler.send<span class=constructor>Message(<span class=params>messageSendDto</span>)</span>;</span><br><span class=line> <span class=comment>// åœ¨channelContextUtils.javaä¸­ ç»™ç¾¤èŠchannelGroupå‘é€æ¶ˆæ¯,è¿™ä¸ªgroupä¸­çš„æ‰€æœ‰channel,ä¹Ÿå°±æ˜¯ç¾¤æˆå‘˜éƒ½ä¼šæ¥æ”¶åˆ°è¿™ä¸ªç¾¤è§£æ•£æ¶ˆæ¯</span></span><br><span class=line>ChannelGroup group = <span class=module-access><span class=module><span class=identifier>GROUP_CONTEXT_MAP</span>.</span></span>get(messageSendDto.get<span class=constructor>ContactId()</span>);</span><br><span class=line><span class=keyword>if</span> (group<span class=operator> == </span>null) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line>group.write<span class=constructor>AndFlush(<span class=params>new</span> TextWebSocketFrame(JSON.<span class=params>toJSONString</span>(<span class=params>messageSendDto</span>)</span>));</span><br><span class=line><span class=comment>// ç„¶åç§»é™¤GROUP_CONTEXT_MAPä¸­çš„channelGroupå¹¶å…³é—­group</span></span><br><span class=line>  <span class=keyword>if</span> (MessageTypeEnum.DISSOLUTION_GROUP<span class=operator> == </span>messageTypeEnum) {</span><br><span class=line>            <span class=module-access><span class=module><span class=identifier>GROUP_CONTEXT_MAP</span>.</span></span>remove(messageSendDto.get<span class=constructor>ContactId()</span>);</span><br><span class=line>            group.close<span class=literal>()</span>;</span><br><span class=line>        }</span><br></pre></table></figure><h4 id=é€€å‡ºç¾¤èŠ><a class=headerlink href=#é€€å‡ºç¾¤èŠ title=é€€å‡ºç¾¤èŠ></a>é€€å‡ºç¾¤èŠ</h4><p>é™¤äº†æ£€æŸ¥ä¼ é€’è¿‡æ¥çš„groupIdæ˜¯å¦åˆæ³•ä¹‹å¤–(ç¾¤å­˜åœ¨ä¸”æœªè§£æ•£,åˆ›å»ºè€…ä¸èƒ½é€€å‡ºç¾¤èŠ),æŸ¥è¯¢user_contact,æ›´æ–°çŠ¶æ€ä¸ºåˆ é™¤(ä»£ç ä¸­ç›´æ¥åˆ é™¤äº†è¡Œè®°å½•)<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>GroupInfo groupInfo = groupInfoMapper.selectByGroupId(groupId);</span><br><span class=line><span class=keyword>if</span> (groupInfo == <span class=keyword>null</span>) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br><span class=line><span class=comment>//åˆ›å»ºè€…ä¸èƒ½é€€å‡ºç¾¤èŠï¼Œåªèƒ½è§£æ•£ç¾¤</span></span><br><span class=line><span class=keyword>if</span> (userId.equals(groupInfo.getGroupOwnerId())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br><span class=line>Integer count = userContactMapper.deleteByUserIdAndContactId(userId, groupId);</span><br><span class=line><span class=keyword>if</span> (count == <span class=number>0</span>) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br></pre></table></figure><p>æ’å…¥chat_session_userè¡¨é€€ç¾¤æ¶ˆæ¯ä»¥åŠchat_messageæ¶ˆæ¯,æ›´æ–°è”ç³»äººç¼“å­˜<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>UserInfo userInfo = userInfoMapper.selectByUserId(userId);</span><br><span class=line></span><br><span class=line>String sessionId = StringTools.getChatSessionId4Group(groupId);</span><br><span class=line>Date curTime = <span class=keyword>new</span> Date();</span><br><span class=line>String messageContent = String.format(messageTypeEnum.getInitMessage(), userInfo.getNickName());</span><br><span class=line><span class=comment>//æ›´æ–°ä¼šè¯æ¶ˆæ¯</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line>chatSession.setLastReceiveTime(curTime.getTime());</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//è®°å½•æ¶ˆæ¯æ¶ˆæ¯è¡¨</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendTime(curTime.getTime());</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessage.setMessageType(messageTypeEnum.getType());</span><br><span class=line>chatMessage.setContactId(groupId);</span><br><span class=line>chatMessage.setMessageContent(messageContent);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>ç„¶åå°±æ˜¯ä½¿ç”¨messageHandlerå‘é€æ¶ˆæ¯,æœ‰äººé€€ç¾¤äº†å‘é€ç»™ç¾¤ç»„channelGroup,ä¹Ÿå°±æ˜¯æ‰€æœ‰ç¾¤æˆå‘˜<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactMapper.selectCount(userContactQuery); <span class=comment>// å‘é€äº†ç¾¤æˆå‘˜ä¸ªæ•°</span></span><br><span class=line></span><br><span class=line>MessageSendDto messageSendDto = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line>messageSendDto.setExtendData(userId); <span class=comment>// å‘é€äº†é€€ç¾¤äºº</span></span><br><span class=line>messageSendDto.setMemberCount(memberCount);</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><h4 id=åˆ é™¤æˆ–è€…æ·»åŠ ç¾¤æˆå‘˜><a class=headerlink href=#åˆ é™¤æˆ–è€…æ·»åŠ ç¾¤æˆå‘˜ title=åˆ é™¤æˆ–è€…æ·»åŠ ç¾¤æˆå‘˜></a>åˆ é™¤æˆ–è€…æ·»åŠ ç¾¤æˆå‘˜</h4><p>è¿˜æ˜¯ç±»ä¼¼çš„æµç¨‹,å…ˆåˆ¤æ–­æˆå‘˜idå’Œç¾¤ç»„idæœ¬èº«æ˜¯ä¸æ˜¯åœ¨user_contactæˆå‘˜çŠ¶æ€,å¦‚æœæ˜¯æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥. åˆ é™¤å’Œæ·»åŠ ç±»ä¼¼,å¦‚æœæ˜¯åˆ é™¤æˆå‘˜,æ“ä½œç±»ä¼¼æˆå‘˜é€€å‡ºç¾¤æˆå‘˜,ä½†messageç±»å‹æ˜¯REMOVE_GROUP(12, â€œ%sè¢«ç®¡ç†å‘˜ç§»å‡ºäº†ç¾¤èŠâ€, â€œè¢«ç®¡ç†å‘˜ç§»å‡ºäº†ç¾¤èŠâ€).è€Œä¸æ˜¯LEAVE_GROUP,user_contact,chat_session,chat_messageè¡¨æ›´æ–°(ä»£ç ä¸­user_contactè®°å½•è¢«åˆ é™¤),æ¶ˆæ¯ä¹Ÿä¼šå‘é€ç»™ç¾¤ç»„,ä¼šåœ¨å¤„ç†æ—¶åˆ é™¤ç¼“å­˜,ä»¥åŠç§»é™¤ç»„ä¸­çš„channel.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>group.writeAndFlush(<span class=keyword>new</span> TextWebSocketFrame(JSON.toJSONString(messageSendDto)));</span><br><span class=line></span><br><span class=line><span class=comment>//ç§»é™¤ç¾¤èŠ</span></span><br><span class=line>MessageTypeEnum messageTypeEnum = MessageTypeEnum.getByType(messageSendDto.getMessageType());</span><br><span class=line><span class=keyword>if</span> (MessageTypeEnum.LEAVE_GROUP == messageTypeEnum || MessageTypeEnum.REMOVE_GROUP == messageTypeEnum) {</span><br><span class=line>    String userId = (String) messageSendDto.getExtendData();</span><br><span class=line>    redisComponet.removeUserContact(userId, messageSendDto.getContactId());</span><br><span class=line>    Channel channel = USER_CONTEXT_MAP.get(userId);</span><br><span class=line>    <span class=keyword>if</span> (channel == <span class=keyword>null</span>) {</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line>    group.remove(channel);</span><br><span class=line>}</span><br></pre></table></figure><p>å¦‚æœæ˜¯æ·»åŠ ç¾¤æˆå‘˜,ç±»ä¼¼addContact,applyuserIdæ˜¯contactId,è”ç³»äººæ˜¯ç¾¤ç»„id. å…·ä½“æµç¨‹ç±»ä¼¼,æ›´æ–°/æ’å…¥user_contactçŠ¶æ€,æ›´æ–°ç¼“å­˜,æ›´æ–°chat_sessionè¡¨,æ·»åŠ ç¾¤ç»„channel,æ›´æ–°chat_message,æœ€åå‘é€æ¶ˆæ¯(ä¸»è¦ç›®çš„æ˜¯å½“å‰æœºå­å¯èƒ½æ²¡æœ‰è¯¥ç¾¤ç»„çš„channel,é€šè¿‡redissonå‘å¸ƒè®¢é˜…,å…¶ä»–æœºå­å–å‡ºCONTEXT_MAPä¸­çš„channel,ä¸ä¸ºç©ºå°±å‘é€æ¶ˆæ¯).<p>å‡è®¾ä¸€ä¸ªåœºæ™¯,æœ‰è®¸å¤šç”¨æˆ·ç™»é™†äº†ä¸åŒæœåŠ¡å™¨<p><img alt=image-20250722160015745 data-src=https://s2.loli.net/2025/07/22/XnkZECm7cG23dlD.png><h4 id=åŠ å…¥ç¾¤èŠ><a class=headerlink href=#åŠ å…¥ç¾¤èŠ title=åŠ å…¥ç¾¤èŠ></a>åŠ å…¥ç¾¤èŠ</h4><p>ç±»ä¼¼æ·»åŠ å¥½å‹addContact<h3 id=è”ç³»äººç®¡ç†><a class=headerlink href=#è”ç³»äººç®¡ç† title=è”ç³»äººç®¡ç†></a>è”ç³»äººç®¡ç†</h3><p><img alt=image-20250505174711397 data-src=https://s2.loli.net/2025/05/05/vODxw84bH7LguBa.png><p><img alt=image-20250502200016447 data-src=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png><h4 id=æœç´¢ç”¨æˆ·><a class=headerlink href=#æœç´¢ç”¨æˆ· title=æœç´¢ç”¨æˆ·></a>æœç´¢ç”¨æˆ·</h4><p>éœ€è¦ä½¿ç”¨user_infoè¡¨æ ¹æ®ä¼ è¿‡æ¥çš„ç”¨æˆ·idæŸ¥è¯¢,å¦‚æœæ˜¯ç”¨æˆ·,è¿˜éœ€è¦æŸ¥è¯¢æ˜µç§°ã€æ€§åˆ«ç­‰ä¿¡æ¯.<p>å¦‚æœæ˜¯ç¾¤èŠ,è¿˜ä¼šè¿”å›ç¾¤åç§°. åŒæ—¶æŸ¥è¯¢user_contactè¡¨è®¾ç½®è”ç³»çŠ¶æ€.<h4 id=ç”³è¯·æ·»åŠ è”ç³»äºº><a class=headerlink href=#ç”³è¯·æ·»åŠ è”ç³»äºº title=ç”³è¯·æ·»åŠ è”ç³»äºº></a>ç”³è¯·æ·»åŠ è”ç³»äºº</h4><p>æ·»åŠ è”ç³»äººæ—¶,é¦–å…ˆåˆ¤æ–­ä¸€äº›ä¿¡æ¯,æ¯”å¦‚contact_idæ˜¯å¦åˆæ³•(å­˜åœ¨),æ˜¯å¦è¢«æ‹‰é»‘ç­‰.<p>user_contact_applyè¡¨åŒ…å«apply_idä¸ºä¸»é”®,æ„å‘³ç€å¯ä»¥åŒä¸€ç”¨æˆ·å¯ä»¥ç”³è¯·å¤šæ¬¡æ·»åŠ è”ç³»äºº<p><img alt=image-20250721225848826 data-src=https://s2.loli.net/2025/07/21/qXQrNahUbLdZw5p.png><p>çœå»å¯¹å‚æ•°çš„æ ¡éªŒ,é¦–å…ˆæŸ¥è¯¢user_contactè¡¨çŠ¶æ€æ˜¯å¦è¢«æ‹‰é»‘äº†,è¢«æ‹‰é»‘å°±æ— æ³•ç”³è¯·äº†.<p>å½“æ»¡è¶³è¿™äº›æ¡ä»¶,ç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦ç”³è¯·è¿˜æ˜¯ç›´æ¥å°±èƒ½æ·»åŠ .<h4 id=ç›´æ¥æ·»åŠ è”ç³»äºº><a class=headerlink href=#ç›´æ¥æ·»åŠ è”ç³»äºº title=ç›´æ¥æ·»åŠ è”ç³»äºº></a>ç›´æ¥æ·»åŠ è”ç³»äºº</h4><p>å¦‚æœèƒ½ç›´æ¥æ·»åŠ ,å°±è¿›è¡Œæ·»åŠ å¥½å‹æ“ä½œ(å¦‚æœæ˜¯ç¾¤èŠéœ€è¦åˆ¤æ–­æ˜¯å¦è¶…å‡ºäººæ•°)<p>èƒ½æƒ³åˆ°çš„æ“ä½œå°±æ˜¯,æ’å…¥user_contactè¡¨,<strong>å¦‚æœæ˜¯å¥½å‹,å°±éœ€è¦äº’ç›¸æ·»åŠ .</strong>,å¦‚æœæ˜¯ç¾¤ç»„,ç›´æ¥æ’å…¥ä¸€æ¡å³å¯(user_id,group_id)<p><img alt=image-20250721215035264 data-src=https://s2.loli.net/2025/07/21/Mf9eRWBC2mu1plw.png><p>ä¹Ÿå°±æ˜¯user_idåˆ†åˆ«ä¸ºç”³è¯·äººå’Œæ¥æ”¶äºº,ç„¶åæ›´æ–°è”ç³»äººç¼“å­˜.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line>List&LTUserContact> contactList = <span class=keyword>new</span> ArrayList<>();</span><br><span class=line><span class=comment>//ç”³è¯·äººæ·»åŠ å¯¹æ–¹</span></span><br><span class=line>UserContact userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>userContact.setUserId(applyUserId);</span><br><span class=line>userContact.setContactId(contactId);</span><br><span class=line>userContact.setContactType(contactType);</span><br><span class=line>userContact.setCreateTime(curDate);</span><br><span class=line>userContact.setLastUpdateTime(curDate);</span><br><span class=line>userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>contactList.add(userContact);</span><br><span class=line><span class=comment>//å¦‚æœæ˜¯ç”³è¯·å¥½å‹ æ¥æ”¶äººæ·»åŠ ç”³è¯·äºº  ç¾¤ç»„ä¸ç”¨æ·»åŠ å¯¹æ–¹ä¸ºå¥½å‹</span></span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER.getType().equals(contactType)) {</span><br><span class=line>    userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>    userContact.setUserId(receiveUserId);</span><br><span class=line>    userContact.setContactId(applyUserId);</span><br><span class=line>    userContact.setContactType(contactType);</span><br><span class=line>    userContact.setCreateTime(curDate);</span><br><span class=line>    userContact.setLastUpdateTime(curDate);</span><br><span class=line>    userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>    contactList.add(userContact);</span><br><span class=line>}</span><br><span class=line><span class=comment>//æ‰¹é‡åŠ å…¥</span></span><br><span class=line>userContactMapper.insertOrUpdateBatch(contactList);</span><br><span class=line></span><br><span class=line><span class=comment>//å¦‚æœæ˜¯å¥½å‹ç”³è¯·,æ¥æ”¶äººä¹Ÿæ·»åŠ ç”³è¯·äººä¸ºè”ç³»äºº</span></span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER.getType().equals(contactType)) {</span><br><span class=line>    redisComponet.addUserContact(receiveUserId, applyUserId);</span><br><span class=line>}</span><br><span class=line><span class=comment>//å®¡æ ¸é€šè¿‡ï¼Œå°†ç”³è¯·äººçš„è”ç³»äººæ·»åŠ ä¸Š æˆ‘ æˆ– ç¾¤ç»„</span></span><br><span class=line>redisComponet.addUserContact(applyUserId, contactId);</span><br></pre></table></figure><p>åœ¨åˆ›å»ºå¥½å‹è”ç³»å,å°±æ˜¯åˆ›å»ºä¼šè¯ä»¥åŠæ¶ˆæ¯ä¿¡æ¯äº†,å…·ä½“æ“ä½œä¹Ÿæ˜¯è¡¨æ’å…¥/æ›´æ–°æ“ä½œ.<p>å…·ä½“æ¥è¯´,å¯¹äºç”¨æˆ·ä¼šè¯è¡¨,åŒ…æ‹¬(user_id,contact_id,)session_id,contact_name<p><img alt=image-20250721091337069 data-src=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png><p>æ’å…¥è¿™ä¸ªæ•°æ®ä¸éš¾,ä½†éœ€è¦è€ƒè™‘å¯èƒ½ä¹‹å‰è¿™ä¸¤äººå°±æ˜¯å¥½å‹ä½†è¿›è¡Œè¿‡åˆ å¥½å‹æ“ä½œ,è¿™æ¡è®°å½•ä¸ä¼šåˆ é™¤,æ‰€ä»¥å°±è¿›è¡Œæ›´æ–°. æ³¨æ„è¿™ä¸ªè¡¨ä¹Ÿæ˜¯(user_id,contact_id)è”åˆä¸»é”®,å¦‚æœæ˜¯å¥½å‹,ä¹Ÿéœ€è¦æ’å…¥ç›¸äº’çš„ä¸¤æ¡ç”¨æˆ·ä¼šè¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment>//æŸ¥è¯¢æ¥æ”¶äººä¿¡æ¯</span></span><br><span class=line>    UserInfo contactUser = <span class=keyword>this</span>.userInfoMapper.selectByUserId(contactId);</span><br><span class=line>    applySessionUser.setContactName(contactUser.getNickName());</span><br><span class=line>    chatSessionUserList.add(applySessionUser);</span><br><span class=line></span><br><span class=line>    <span class=comment>//æ¥å—äººsession</span></span><br><span class=line>    ChatSessionUser contactSessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>    contactSessionUser.setUserId(contactId);</span><br><span class=line>    contactSessionUser.setContactId(applyUserId);</span><br><span class=line>    contactSessionUser.setSessionId(sessionId);</span><br><span class=line>    contactSessionUser.setLastReceiveTime(curDate.getTime());</span><br><span class=line>    contactSessionUser.setLastMessage(applyInfo);</span><br><span class=line>    <span class=comment>//æŸ¥è¯¢ç”³è¯·äººä¿¡æ¯</span></span><br><span class=line>    UserInfo applyUserInfo = <span class=keyword>this</span>.userInfoMapper.selectByUserId(applyUserId);</span><br><span class=line>    contactSessionUser.setContactName(applyUserInfo.getNickName());</span><br><span class=line>    chatSessionUserList.add(contactSessionUser);</span><br><span class=line>    <span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdateBatch(chatSessionUserList);</span><br></pre></table></figure><p>å¯¹äºä¼šè¯è®°å½•,åªéœ€è¦æ’å…¥/æ›´æ–°ä¸€æ¡,æ ¸å¿ƒæ˜¯æ›´æ–°æœ€æ–°æ¶ˆæ¯å’Œæ¥æ”¶æ—¶é—´. (sqlä½¿ç”¨INSERT INTO xxx on duplicate key update xx)æ’å…¥æˆ–è€…æ›´æ–°å†—ä½™é”®.å‘è¡¨ä¸­æ’å…¥æ–°è¡Œæ—¶ï¼Œå¦‚æœé‡åˆ°ä¸ç°æœ‰è¡Œçš„ <strong>PRIMARY KEYï¼ˆä¸»é”®ï¼‰</strong> æˆ– <strong>UNIQUE KEYï¼ˆå”¯ä¸€é”®ï¼‰</strong> å†²çªçš„æƒ…å†µï¼Œåˆ™æ‰§è¡Œ <code>UPDATE</code> æ“ä½œ<p><img alt=image-20250721091312712 data-src=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment>//åˆ›å»ºä¼šè¯</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line>chatSession.setLastMessage(applyInfo);</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insertOrUpdate(chatSession);</span><br></pre></table></figure><p>ä¸»è¦æ›´æ–°æœ€æ–°æ¶ˆæ¯å’Œæ—¶é—´.<p>æœ€åæ›´æ–°æ¶ˆæ¯å†…å®¹,æ’å…¥æ¶ˆæ¯è¡¨,æ¶ˆæ¯è¡¨ä¸»é”®message_id,è®°å½•äº†æ¶ˆæ¯çš„å‘é€è€…å’Œæ¥æ”¶è€…,session_id,æ¶ˆæ¯ç±»å‹,æ–‡ä»¶ç±»å‹ç­‰.åªéœ€è¦æ’å…¥ä¸€æ¡å³å¯,ä¸éœ€è¦äº’ç›¸æ’å…¥.<p><img alt=image-20250721202934542 data-src=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=comment>//è®°å½•æ¶ˆæ¯æ¶ˆæ¯è¡¨</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.ADD_FRIEND.getType());</span><br><span class=line>chatMessage.setMessageContent(applyInfo);</span><br><span class=line>chatMessage.setSendUserId(applyUserId);</span><br><span class=line>chatMessage.setSendUserNickName(applyUserInfo.getNickName());</span><br><span class=line>chatMessage.setSendTime(curDate.getTime());</span><br><span class=line>chatMessage.setContactId(contactId);</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>æœ€ååˆ©ç”¨messageSendDtoå‘é€ç»™ç”¨æˆ·ä»¥åŠæ¥æ”¶è€…(å› ä¸ºæˆåŠŸåŠ äº†å¥½å‹).<p>æ³¨æ„è®¾ç½®çš„æ¶ˆæ¯ç±»å‹æœ‰å¤šç§,æ¯”å¦‚æ·»åŠ å¥½å‹æˆåŠŸ<code>ADD_FRIEND(1, "", "æ·»åŠ å¥½å‹æ‰“æ‹›å‘¼æ¶ˆæ¯")</code>,ç¾¤ç»„åˆ›å»ºæˆåŠŸç­‰æ¶ˆæ¯ç±»å‹,ä»¥åŠæ–‡ä»¶ä¸Šä¼ ,å¼ºåˆ¶ä¸‹çº¿,é€€å‡ºç¾¤èŠç­‰ç­‰æ¶ˆæ¯éƒ½ä¼šé€šè¿‡wså‘ç»™ç”¨æˆ·å¹¶è®°å½•åœ¨chatMessageçš„ç±»å‹ä¸­.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>INIT(<span class=number>0</span>, <span class=string>""</span>, <span class=string>"è¿æ¥WSè·å–ä¿¡æ¯"</span>),</span><br><span class=line>ADD_FRIEND(<span class=number>1</span>, <span class=string>""</span>, <span class=string>"æ·»åŠ å¥½å‹æ‰“æ‹›å‘¼æ¶ˆæ¯"</span>),</span><br><span class=line>CHAT(<span class=number>2</span>, <span class=string>""</span>, <span class=string>"æ™®é€šèŠå¤©æ¶ˆæ¯"</span>),</span><br><span class=line>GROUP_CREATE(<span class=number>3</span>, <span class=string>"ç¾¤ç»„å·²ç»åˆ›å»ºå¥½ï¼Œå¯ä»¥å’Œå¥½å‹ä¸€èµ·ç•…èŠäº†"</span>, <span class=string>"ç¾¤åˆ›å»ºæˆåŠŸ"</span>),</span><br><span class=line>CONTACT_APPLY(<span class=number>4</span>, <span class=string>""</span>, <span class=string>"å¥½å‹ç”³è¯·"</span>),</span><br><span class=line>MEDIA_CHAT(<span class=number>5</span>, <span class=string>""</span>, <span class=string>"åª’ä½“æ–‡ä»¶"</span>),</span><br><span class=line>FILE_UPLOAD(<span class=number>6</span>, <span class=string>""</span>, <span class=string>"æ–‡ä»¶ä¸Šä¼ å®Œæˆ"</span>),</span><br><span class=line>FORCE_OFF_LINE(<span class=number>7</span>, <span class=string>""</span>, <span class=string>"å¼ºåˆ¶ä¸‹çº¿"</span>),</span><br><span class=line>DISSOLUTION_GROUP(<span class=number>8</span>, <span class=string>"ç¾¤èŠå·²è§£æ•£"</span>, <span class=string>"è§£æ•£ç¾¤èŠ"</span>),</span><br><span class=line>ADD_GROUP(<span class=number>9</span>, <span class=string>"%såŠ å…¥äº†ç¾¤ç»„"</span>, <span class=string>"åŠ å…¥ç¾¤èŠ"</span>),</span><br><span class=line>CONTACT_NAME_UPDATE(<span class=number>10</span>, <span class=string>""</span>, <span class=string>"æ›´æ–°ç¾¤æ˜µç§°"</span>),</span><br><span class=line>LEAVE_GROUP(<span class=number>11</span>, <span class=string>"%sé€€å‡ºäº†ç¾¤èŠ"</span>, <span class=string>"é€€å‡ºç¾¤èŠ"</span>),</span><br><span class=line>REMOVE_GROUP(<span class=number>12</span>, <span class=string>"%sè¢«ç®¡ç†å‘˜ç§»å‡ºäº†ç¾¤èŠ"</span>, <span class=string>"è¢«ç®¡ç†å‘˜ç§»å‡ºäº†ç¾¤èŠ"</span>),</span><br><span class=line>ADD_FRIEND_SELF(<span class=number>13</span>, <span class=string>""</span>, <span class=string>"æ·»åŠ å¥½å‹æ‰“æ‹›å‘¼æ¶ˆæ¯å‘é€ç»™è‡ªå·±"</span>);</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>MessageSendDto messageSendDto = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * å‘é€ç»™æ¥å—å¥½å‹ç”³è¯·çš„äºº</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * å‘é€ç»™ç”³è¯·äºº å‘é€äººå°±æ˜¯æ¥æ”¶äººï¼Œè”ç³»äººå°±æ˜¯ç”³è¯·äºº</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.ADD_FRIEND_SELF.getType());</span><br><span class=line>messageSendDto.setContactId(applyUserId);</span><br><span class=line>messageSendDto.setExtendData(contactUser);</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><p>å› ä¸ºæ˜¯å¥½å‹æ·»åŠ æˆåŠŸæ‰€ä»¥éœ€è¦å‘åŒæ–¹éƒ½å‘é€wsæ¶ˆæ¯,ä½†æ¥æ”¶è€…,æ¶ˆæ¯ç±»å‹å’Œå†…å®¹ä¸å¤ªç›¸åŒ.<p>å¦‚æœæ·»åŠ çš„æ˜¯ç¾¤ç»„,åŒæ ·çš„é¦–å…ˆæ’å…¥user_contactè¡¨,è¿™æ—¶åªéœ€è¦æ’å…¥ä¸€æ¡è®°å½•å³å¯.åŒæ—¶æ›´æ–°ç”³è¯·è€…è”ç³»äººç¼“å­˜.æ­¤å¤–è¿˜è¦å°†è¿™ä¸ªç”¨æˆ·channelåŠ å…¥ç¾¤èŠchannelGroupä¸­.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=comment>//åŠ å…¥ç¾¤ç»„</span></span><br><span class=line>         ChatSessionUser chatSessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>         chatSessionUser.setUserId(applyUserId);</span><br><span class=line>         chatSessionUser.setContactId(contactId);</span><br><span class=line>         GroupInfo groupInfo = <span class=keyword>this</span>.groupInfoMapper.selectByGroupId(contactId);</span><br><span class=line>         chatSessionUser.setContactName(groupInfo.getGroupName());</span><br><span class=line>         chatSessionUser.setSessionId(sessionId);</span><br><span class=line>         <span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdate(chatSessionUser);</span><br><span class=line></span><br><span class=line>         <span class=comment>//å°†ç¾¤ç»„åŠ å…¥åˆ°ç”¨æˆ·çš„è”ç³»äººåˆ—è¡¨</span></span><br><span class=line>         redisComponet.addUserContact(applyUserId, groupInfo.getGroupId());</span><br><span class=line></span><br><span class=line>         channelContextUtils.addUser2Group(applyUserId, groupInfo.getGroupId());</span><br><span class=line></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addUser2Group</span><span class=params>(String userId, String groupId)</span> </span>{</span><br><span class=line>    Channel channel = USER_CONTEXT_MAP.get(userId);</span><br><span class=line>    add2Group(groupId, channel);</span><br><span class=line>}</span><br><span class=line>  <span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>add2Group</span><span class=params>(String groupId, Channel context)</span> </span>{</span><br><span class=line>    ChannelGroup group = GROUP_CONTEXT_MAP.get(groupId);</span><br><span class=line>    <span class=keyword>if</span> (group == <span class=keyword>null</span>) {</span><br><span class=line>        group = <span class=keyword>new</span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE);</span><br><span class=line>        GROUP_CONTEXT_MAP.put(groupId, group);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>if</span> (context == <span class=keyword>null</span>) {</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line>    group.add(context);</span><br><span class=line>}</span><br></pre></table></figure><p>ç„¶åæ’å…¥/æ›´æ–°chat_session_userè¡¨(å› ä¸ºåç»­è¦æ·»åŠ ä¼šè¯æ¶ˆæ¯),ä¹Ÿåªéœ€è¦æ’å…¥ä¸€æ¡,è€Œchat_sessionè¡¨æ’å…¥/æ›´æ–°æ¶ˆæ¯å’Œæ¥æ”¶æ—¶é—´,chat_sessionä¸­çš„æ¶ˆæ¯ç±»å‹ä»¥åŠå†…å®¹å°±æ˜¯æ·»åŠ ç¾¤æ¶ˆæ¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>UserInfo applyUserInfo = <span class=keyword>this</span>.userInfoMapper.selectByUserId(applyUserId);</span><br><span class=line></span><br><span class=line>String sendMessage = String.format(MessageTypeEnum.ADD_GROUP.getInitMessage(), applyUserInfo.getNickName());</span><br><span class=line></span><br><span class=line><span class=comment>//å¢åŠ sessionä¿¡æ¯</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line>chatSession.setLastMessage(sendMessage);</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insertOrUpdate(chatSession);</span><br></pre></table></figure><p>æœ€åè¿˜æ˜¯éœ€è¦ä½¿ç”¨messageHandlerå‘é€messagesendDto,å‘é€ç»™ç¾¤çš„æœ‰äººè¿›å…¥äº†ç¾¤çš„æ¶ˆæ¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=comment>//å‘é€ç¾¤æ¶ˆæ¯</span></span><br><span class=line>MessageSendDto messageSend = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line>messageSend.setContactId(groupInfo.getGroupId());</span><br><span class=line><span class=comment>//è·å–ç¾¤äººæ•°é‡</span></span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(contactId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactMapper.selectCount(userContactQuery);</span><br><span class=line>messageSend.setMemberCount(memberCount);</span><br><span class=line>messageSend.setContactName(groupInfo.getGroupName());</span><br><span class=line>messageHandler.sendMessage(messageSend);</span><br></pre></table></figure><h4 id=æ’å…¥ç”³è¯·è¯·æ±‚><a class=headerlink href=#æ’å…¥ç”³è¯·è¯·æ±‚ title=æ’å…¥ç”³è¯·è¯·æ±‚></a>æ’å…¥ç”³è¯·è¯·æ±‚</h4><p>è¯·æ±‚çš„çŠ¶æ€æšä¸¾å¦‚ä¸‹:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>INIT(<span class=number>0</span>, <span class=string>"å¾…å¤„ç†"</span>),</span><br><span class=line>PASS(<span class=number>1</span>, <span class=string>"å·²åŒæ„"</span>),</span><br><span class=line>REJECT(<span class=number>2</span>, <span class=string>"å·²æ‹’ç»"</span>),</span><br><span class=line>BLACKLIST(<span class=number>3</span>, <span class=string>"å·²æ‹‰é»‘"</span>);;</span><br></pre></table></figure><p>å¦‚æœä¸èƒ½ç›´æ¥æ·»åŠ ,å°±éœ€è¦æ’å…¥/æ›´æ–°user_contact_applyè¡¨.<p>å¦‚æœä¸å­˜åœ¨è¯¥è®°å½•(é€šè¿‡user_idï¼Œcontact_id,receiver_idåˆ›å»ºäº†å”¯ä¸€ç´¢å¼•),åˆ™ç›´æ¥æ’å…¥è¯·æ±‚ä¿¡æ¯.<p>å¦åˆ™æ›´æ–°user_contact_applyçŠ¶æ€ä¸ºå¾…å¤„ç†(ä¹Ÿå°±æ˜¯è¯´)å¹¶æ›´æ–°è¯·æ±‚æ—¶é—´å’Œè¯·æ±‚ä¿¡æ¯.<p>æ­¤å¤–,ç”³è¯·æ¶ˆæ¯ä¼šé€šè¿‡wså‘é€ç»™æ¥æ”¶è€…(å¦‚æœæ²¡æœ‰user_contact_applyè®°å½•æˆ–è€…å…¶çŠ¶æ€ä¸ä¸ºå¾…å¤„ç†)<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (dbApply == <span class=keyword>null</span> || !UserContactApplyStatusEnum.INIT.getStatus().equals(dbApply.getStatus())) {</span><br><span class=line>    <span class=comment>//å¦‚æœæ˜¯å¾…å¤„ç†çŠ¶æ€å°±ä¸å‘æ¶ˆæ¯ï¼Œé¿å…é‡å¤å‘é€</span></span><br><span class=line>    <span class=comment>//å‘é€wsæ¶ˆæ¯</span></span><br><span class=line>    MessageSendDto messageSend = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>    messageSend.setMessageType(MessageTypeEnum.CONTACT_APPLY.getType());</span><br><span class=line>    messageSend.setMessageContent(applyInfo);</span><br><span class=line>    messageSend.setContactId(receiveUserId);</span><br><span class=line>    messageHandler.sendMessage(messageSend);</span><br><span class=line>}</span><br></pre></table></figure><p>messageSendDtoæˆå‘˜å¦‚ä¸‹,åŒ…æ‹¬æ¶ˆæ¯id,ä¼šè¯id,å‘é€å’Œæ¥å—è¿™,æ¶ˆæ¯å†…å®¹,å‘é€æ—¶é—´ä»¥åŠæ¶ˆæ¯ç±»å‹ç­‰ç­‰.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MessageSendDto</span><<span class=title>T</span>> <span class=keyword>implements</span> <span class=title>Serializable</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=keyword>long</span> serialVersionUID = -<span class=number>1045752033171142417L</span>;</span><br><span class=line>    <span class=comment>//æ¶ˆæ¯ID</span></span><br><span class=line>    <span class=keyword>private</span> Long messageId;</span><br><span class=line>    <span class=comment>//ä¼šè¯ID</span></span><br><span class=line>    <span class=keyword>private</span> String sessionId;</span><br><span class=line>    <span class=comment>//å‘é€äºº</span></span><br><span class=line>    <span class=keyword>private</span> String sendUserId;</span><br><span class=line>    <span class=comment>//å‘é€äººæ˜µç§°</span></span><br><span class=line>    <span class=keyword>private</span> String sendUserNickName;</span><br><span class=line>    <span class=comment>//è”ç³»äººID</span></span><br><span class=line>    <span class=keyword>private</span> String contactId;</span><br><span class=line>    <span class=comment>//è”ç³»äººåç§°</span></span><br><span class=line>    <span class=keyword>private</span> String contactName;</span><br><span class=line>    <span class=comment>//æ¶ˆæ¯å†…å®¹</span></span><br><span class=line>    <span class=keyword>private</span> String messageContent;</span><br><span class=line>    <span class=comment>//æœ€åçš„æ¶ˆæ¯</span></span><br><span class=line>    <span class=keyword>private</span> String lastMessage;</span><br><span class=line>    <span class=comment>//æ¶ˆæ¯ç±»å‹</span></span><br><span class=line>    <span class=keyword>private</span> Integer messageType;</span><br><span class=line>    <span class=comment>//å‘é€æ—¶é—´</span></span><br><span class=line>    <span class=keyword>private</span> Long sendTime;</span><br><span class=line>    <span class=comment>//è”ç³»äººç±»å‹</span></span><br><span class=line>    <span class=keyword>private</span> Integer contactType;</span><br><span class=line>    <span class=comment>//æ‰©å±•ä¿¡æ¯</span></span><br><span class=line>    <span class=keyword>private</span> T extendData;</span><br><span class=line></span><br><span class=line>    <span class=comment>//æ¶ˆæ¯çŠ¶æ€ 0:å‘é€ä¸­  1:å·²å‘é€ å¯¹äºæ–‡ä»¶æ˜¯å¼‚æ­¥ä¸Šä¼ ç”¨çŠ¶æ€å¤„ç†</span></span><br><span class=line>    <span class=keyword>private</span> Integer status;</span><br><span class=line></span><br><span class=line>    <span class=comment>//æ–‡ä»¶ä¿¡æ¯</span></span><br><span class=line>    <span class=keyword>private</span> Long fileSize;</span><br><span class=line>    <span class=keyword>private</span> String fileName;</span><br><span class=line>    <span class=keyword>private</span> Integer fileType;</span><br><span class=line></span><br><span class=line>    <span class=comment>//ç¾¤å‘˜</span></span><br><span class=line>    <span class=keyword>private</span> Integer memberCount;</span><br><span class=line>    }</span><br></pre></table></figure><h4 id=æŸ¥è¯¢ç”³è¯·è¯·æ±‚><a class=headerlink href=#æŸ¥è¯¢ç”³è¯·è¯·æ±‚ title=æŸ¥è¯¢ç”³è¯·è¯·æ±‚></a>æŸ¥è¯¢ç”³è¯·è¯·æ±‚</h4><p>æŸ¥è¯¢user_contact_applyè¡¨,receiver_idæ˜¯è‡ªå·±idçš„è®°å½•,å› ä¸ºè¿™ä¸ªè¡¨åŒ…å«è”åˆä¸»é”®(apply_user_id,contact_id,receiver_id). æŒ‰ç…§last_apply_timeé™åº,è¿˜å¯ä»¥è¿”å›è”ç³»äººæ˜µç§°.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"selectList"</span> <span class=attr>resultMap</span>=<span class=string>"base_result_map"</span>></span></span><br><span class=line>    SELECT</span><br><span class=line>    a.*</span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.queryContactInfo"</span>></span></span><br><span class=line>        ,CASE</span><br><span class=line>        WHEN a.contact_type = 0 THEN u.nick_name</span><br><span class=line>        WHEN a.contact_type = 1 THEN g.group_name</span><br><span class=line>        END as contactName</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    FROM</span><br><span class=line>    user_contact_apply a</span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.queryContactInfo"</span>></span></span><br><span class=line>        LEFT JOIN user_info u ON u.user_id = a.apply_user_id and a.receive_user_id = #{query.receiveUserId}</span><br><span class=line>        LEFT JOIN group_info g ON g.group_id = a.contact_id and a.receive_user_id = #{query.receiveUserId}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>include</span> <span class=attr>refid</span>=<span class=string>"query_condition"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.orderBy!=null"</span>></span></span><br><span class=line>        order by ${query.orderBy}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.simplePage!=null"</span>></span></span><br><span class=line>        limit #{query.simplePage.start},#{query.simplePage.end}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h4 id=å¤„ç†ç”³è¯·è¯·æ±‚><a class=headerlink href=#å¤„ç†ç”³è¯·è¯·æ±‚ title=å¤„ç†ç”³è¯·è¯·æ±‚></a>å¤„ç†ç”³è¯·è¯·æ±‚</h4><p>é™¤äº†æ­£å¸¸æµç¨‹çš„å‚æ•°æ£€éªŒå’Œåˆæ³•ä¹‹å¤–,æ›´æ–°user_contact_applyè¡¨çŠ¶æ€,å¦‚æœå…è®¸è¯·æ±‚,æ‰§è¡Œä¸Šè¿°æ·»åŠ è”ç³»äººæ“ä½œ,å¦‚æœæ‹’ç»,åç«¯ä»€ä¹ˆä¹Ÿä¸åš,å¦‚æœæ˜¯æ‹‰é»‘,user_contactçŠ¶æ€è®°å½•ä¸º<strong>ç¬¬ä¸€æ¬¡è¢«æ‹‰é»‘</strong>,åç»­ä¸å†å…è®¸ç”³è¯·æ·»åŠ ,ç„¶åæ’å…¥/æ›´æ–°user_contactè¡¨<h3 id=è”ç³»äººè¯¦æƒ…-åˆ é™¤å’Œæ‹‰é»‘è”ç³»äºº><a class=headerlink href=#è”ç³»äººè¯¦æƒ…-åˆ é™¤å’Œæ‹‰é»‘è”ç³»äºº title=è”ç³»äººè¯¦æƒ…,åˆ é™¤å’Œæ‹‰é»‘è”ç³»äºº></a>è”ç³»äººè¯¦æƒ…,åˆ é™¤å’Œæ‹‰é»‘è”ç³»äºº</h3><p>åŠ è½½è”ç³»äºº,ä¹Ÿå°±æ˜¯ä»user_contactè¡¨ä¸­æŸ¥è¯¢,æ ¹æ®user_idå’Œcontact_idæŸ¥è¯¢,å¦‚æœæ˜¯æŸ¥è¯¢è”ç³»äºº,åŒæ—¶ä¹Ÿä¼šæŸ¥è¯¢è”ç³»äººåå­—ã€æ€§åˆ«ç­‰ä¿¡æ¯,å¦‚æœæ˜¯ç¾¤ç»„,ä¹Ÿä¼šæŸ¥è¯¢ç¾¤æ˜µç§°å’Œç¾¤äººæ•°ç­‰. æ­¤å¤–,user_contactçš„çŠ¶æ€å¿…é¡»æ˜¯æœ‹å‹,æˆ–è€…è¢«åˆ é™¤,è¢«æ‹‰é»‘. ä¹Ÿå°±æ˜¯è¯´å¦‚æœè¢«å…¶åˆ é™¤,ä½†æ²¡æœ‰åˆ é™¤è”ç³»äºº,ä¹Ÿèƒ½åŠ è½½å®ƒ.<p>è”ç³»äººè¯¦æƒ…æœ‰ä¸¤ä¸ªæ¥å£,ä¸€ä¸ªè·å–ä»»æ„ç”¨æˆ·çš„ä¿¡æ¯,é€šè¿‡contact_idè·å–ç”¨æˆ·ä¿¡æ¯,å¹¶è¿”å›è”ç³»çŠ¶æ€.<p>å¦‚æœæ˜¯æŸ¥è¯¢è”ç³»äººè¯¦æƒ…,ä¼šè®¾ç½®æŸ¥è¯¢çŠ¶æ€,å¦‚æœä¸æ˜¯å¥½å‹,è¢«åˆ é™¤,è¢«æ‹‰é»‘æˆ–è€…è¢«é¦–æ¬¡æ‹‰é»‘,å…¶ä½™æŠ¥å¼‚å¸¸. å› ä¸ºå¦‚æœè¢«åˆ é™¤/æ‹‰é»‘ä¾ç„¶èƒ½æŸ¥çœ‹çŠ¶æ€.<p>åˆ é™¤å’Œæ‹‰é»‘å¥½å‹æ—¶å¤„ç†ç±»ä¼¼,é¦–å…ˆä¿®æ”¹user_contactçŠ¶æ€,å¦‚æœæ˜¯åˆ é™¤,è¿˜éœ€è¦å¢åŠ è¢«åˆ é™¤çš„ä¸€æ¡(contact_id,user_id)è®°å½•,æ‹‰é»‘ç±»ä¼¼. ç„¶åéœ€è¦åˆ é™¤åŒæ–¹è”ç³»äººç¼“å­˜. å› ä¸ºç¼“å­˜ä¸­åªä¿å­˜å¥½å‹å…³ç³»çš„è”ç³»äºº,åˆ é™¤å’Œè¢«åˆ é™¤,æ‹‰é»‘å’Œè¢«æ‹‰é»‘éƒ½ä¸å­˜åœ¨,è¿™ä¸ªç¼“å­˜å†…å®¹æ˜¯ç”¨æ¥å‘é€èŠå¤©æ¶ˆæ¯çš„.<h3 id=è·å–ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ä¸é€€å‡ºç™»å½•><a class=headerlink href=#è·å–ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ä¸é€€å‡ºç™»å½• title=è·å–ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ä¸é€€å‡ºç™»å½•></a>è·å–ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ä¸é€€å‡ºç™»å½•</h3><h3 id=åå°ç®¡ç†><a class=headerlink href=#åå°ç®¡ç† title=åå°ç®¡ç†></a>åå°ç®¡ç†</h3><p>ç”¨æˆ·ç®¡ç† é“å·ç®¡ç† ç¾¤ç»„ç®¡ç†<h3 id=ç™»é™†æ—¶åŠ è½½æ¶ˆæ¯><a class=headerlink href=#ç™»é™†æ—¶åŠ è½½æ¶ˆæ¯ title=ç™»é™†æ—¶åŠ è½½æ¶ˆæ¯></a>ç™»é™†æ—¶åŠ è½½æ¶ˆæ¯</h3><blockquote><p>ç¦»çº¿æ¶ˆæ¯å¤„ç†</blockquote><p>åœ¨ç™»é™†æ ¡éªŒå®Œæˆå,<strong>å°†è”ç³»äººå­˜å…¥ç¼“å­˜,å°†tokenå’Œç”¨æˆ·ä¿¡æ¯å­˜å…¥ç¼“å­˜</strong>,å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯.<p>å½“å®¢æˆ·ç«¯å‘é€wsè¿æ¥æ—¶,ä¼šæºå¸¦token,æœåŠ¡ç«¯åˆ©ç”¨tokenè·å–ç”¨æˆ·ä¿¡æ¯,ç„¶ååŠ è½½èŠå¤©æ¶ˆæ¯.<p>å…·ä½“æ¥è¯´,åœ¨ç¼“å­˜ä¸­è·å–è”ç³»äºº,å°†è‡ªå·±çš„channelåŠ å…¥ç¾¤èŠçš„channelGroupä¸­(å¦‚æœæ²¡æœ‰åˆ›å»ºchannelGroupæ”¾å…¥GROUP_CONTEXT_MAPä¸­)<p>ç„¶åå°†è‡ªå·±çš„channelæ”¾å…¥USER_CONTEXT_MAPä¸­,æ›´æ–°ç”¨æˆ·å¿ƒè·³ç¼“å­˜å’Œæœ€æ–°ç™»é™†æ—¶é—´.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>String channelId = channel.id().toString();</span><br><span class=line>        AttributeKey attributeKey = <span class=keyword>null</span>;</span><br><span class=line>        <span class=keyword>if</span> (!AttributeKey.exists(channelId)) {</span><br><span class=line>            attributeKey = AttributeKey.newInstance(channel.id().toString());</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            attributeKey = AttributeKey.valueOf(channel.id().toString());</span><br><span class=line>        }</span><br><span class=line>        channel.attr(attributeKey).set(userId);</span><br><span class=line></span><br><span class=line>        List&LTString> contactList = redisComponet.getUserContactList(userId);</span><br><span class=line>        <span class=keyword>for</span> (String groupId : contactList) {</span><br><span class=line>            <span class=keyword>if</span> (groupId.startsWith(UserContactTypeEnum.GROUP.getPrefix())) {</span><br><span class=line>                add2Group(groupId, channel);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>        USER_CONTEXT_MAP.put(userId, channel);</span><br><span class=line>        redisComponet.saveUserHeartBeat(userId);</span><br><span class=line></span><br><span class=line>        <span class=comment>//æ›´æ–°ç”¨æˆ·æœ€åè¿æ¥æ—¶é—´</span></span><br><span class=line>        UserInfo updateInfo = <span class=keyword>new</span> UserInfo();</span><br><span class=line>        updateInfo.setLastLoginTime(<span class=keyword>new</span> Date());</span><br><span class=line>        userInfoMapper.updateByUserId(updateInfo, userId);</span><br></pre></table></figure><p>é¦–å…ˆ<strong>æŸ¥è¯¢ç”¨æˆ·ä¼šè¯ä¿¡æ¯,ä¹Ÿå°±æ˜¯chat_session_userè¡¨,ç›¸åŒçš„èŠå¤©åŒæ–¹,sessionIdç›¸åŒ,ä¸»é”®æ˜¯user_idå’Œcontact_idè”åˆä¸»é”®,æ ¹æ®user_idæŸ¥çœ‹ç”¨æˆ·ä¼šè¯å¯ä»¥è·å–æœ‰èŠå¤©ä¼šè¯çš„è”ç³»äººä¿¡æ¯,å¦‚æœæ˜¯ç¾¤èŠä¹Ÿä¼šæŸ¥è¯¢ç¾¤èŠäººæ•°,</strong>chat_sessionè¡¨ä¸»é”®æ˜¯session_id.<p>åœ¨mapperä¸­,æŸ¥è¯¢ç”¨æˆ·ä¼šè¯ä¿¡æ¯å°±æ˜¯è·å–chat_session_userèŠå¤©ä¼šè¯å¯¹æ–¹åç§°,idä»¥åŠsessionä¼šè¯æœ€æ–°çš„èŠå¤©ä¿¡æ¯,å¦‚æœæ˜¯ç¾¤èŠè¿˜è¦æŸ¥ç¾¤èŠäººæ•°<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>          * 1ã€æŸ¥è¯¢ä¼šè¯ä¿¡æ¯ æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰ä¼šè¯ï¼Œé¿å…æ¢è®¾å¤‡ä¼šè¯ä¸åŒæ­¥</span></span><br><span class=line><span class=comment>          */</span></span><br><span class=line>         ChatSessionUserQuery sessionUserQuery = <span class=keyword>new</span> ChatSessionUserQuery();</span><br><span class=line>         sessionUserQuery.setUserId(userId);</span><br><span class=line>         sessionUserQuery.setOrderBy(<span class=string>"last_receive_time desc"</span>);</span><br><span class=line>         List&LTChatSessionUser> chatSessionList = chatSessionUserMapper.selectList(sessionUserQuery);</span><br><span class=line>         WsInitData wsInitData = <span class=keyword>new</span> WsInitData();</span><br><span class=line>         wsInitData.setChatSessionList(chatSessionList);</span><br></pre></table></figure><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"selectList"</span> <span class=attr>resultMap</span>=<span class=string>"base_result_map"</span>></span></span><br><span class=line>    SELECT u.*,</span><br><span class=line>    c.last_message lastMessage,</span><br><span class=line>    c.last_receive_time lastReceiveTime,</span><br><span class=line>    case when SUBSTRING(contact_id, 1, 1) ='G'</span><br><span class=line>    THEN (select count(1) from user_contact uc where uc.contact_id = u.contact_id)</span><br><span class=line>    else 0</span><br><span class=line>    end memberCount</span><br><span class=line>    FROM chat_session_user u inner join chat_session c on c.session_id = u.session_id</span><br><span class=line>    <span class=tag><<span class=name>include</span> <span class=attr>refid</span>=<span class=string>"query_condition"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.orderBy!=null"</span>></span></span><br><span class=line>        order by ${query.orderBy}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.simplePage!=null"</span>></span></span><br><span class=line>        limit #{query.simplePage.start},#{query.simplePage.end}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><p>ç„¶åéœ€è¦ç»™å®¢æˆ·ç«¯å‘é€ç¦»çº¿æ—¶å…¶ä»–äººçš„èŠå¤©æ¶ˆæ¯(ç¦»çº¿ä¹‹å‰çš„æ¶ˆæ¯é€šè¿‡å®¢æˆ·ç«¯æŸ¥æ•°æ®åº“),<p>æŸ¥è¯¢æµç¨‹æ˜¯: é¦–å…ˆæŸ¥è¯¢è”ç³»äºº,å¦‚æœæ˜¯ç¾¤èŠ,è”ç³»çš„idæ˜¯ç¾¤ç»„id,åŒæ—¶åŠ ä¸Šè‡ªå·±çš„idä½œä¸ºcontact_id,æŸ¥è¯¢chatMessageæ¶ˆæ¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>           * 2ã€æŸ¥è¯¢èŠå¤©æ¶ˆæ¯</span></span><br><span class=line><span class=comment>           */</span></span><br><span class=line>          <span class=comment>//æŸ¥è¯¢ç”¨æˆ·çš„è”ç³»äºº</span></span><br><span class=line>          UserContactQuery contactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>          contactQuery.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>          contactQuery.setUserId(userId);</span><br><span class=line>          List&LTUserContact> groupContactList = userContactMapper.selectList(contactQuery);</span><br><span class=line>          List&LTString> groupIdList = groupContactList.stream().map(item -> item.getContactId()).collect(Collectors.toList());</span><br><span class=line>          <span class=comment>//å°†è‡ªå·±ä¹ŸåŠ è¿›å»</span></span><br><span class=line>          groupIdList.add(userId);</span><br><span class=line></span><br><span class=line>          ChatMessageQuery messageQuery = <span class=keyword>new</span> ChatMessageQuery();</span><br><span class=line>          messageQuery.setContactIdList(groupIdList);</span><br><span class=line>          messageQuery.setLastReceiveTime(lastOffTime);</span><br><span class=line>          List&LTChatMessage> chatMessageList = chatMessageMapper.selectList(messageQuery);</span><br><span class=line>          wsInitData.setChatMessageList(chatMessageList);</span><br></pre></table></figure><p>æœ€åæŸ¥è¯¢å¥½å‹ç”³è¯·æ•°,ä¹Ÿå°±æ˜¯contact_applyä¸­è¿˜æœªå¤„ç†çš„æ¶ˆæ¯<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>     * 3ã€æŸ¥è¯¢å¥½å‹ç”³è¯·</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    UserContactApplyQuery applyQuery = <span class=keyword>new</span> UserContactApplyQuery();</span><br><span class=line>    applyQuery.setReceiveUserId(userId);</span><br><span class=line>    applyQuery.setLastApplyTimestamp(sourceLastOffTime);</span><br><span class=line>    applyQuery.setStatus(UserContactApplyStatusEnum.INIT.getStatus());</span><br><span class=line>    Integer applyCount = userContactApplyMapper.selectCount(applyQuery);</span><br><span class=line>    wsInitData.setApplyCount(applyCount);</span><br></pre></table></figure><p>æœ€åè¦å°†è¿™äº›æ¶ˆæ¯å‘é€ç»™ç”¨æˆ·<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment>//å‘é€æ¶ˆæ¯</span></span><br><span class=line>MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.INIT.getType()); <span class=comment>// messageSendDtoè®¾ç½®wsæ¶ˆæ¯ç±»å‹</span></span><br><span class=line>messageSendDto.setContactId(userId);</span><br><span class=line>messageSendDto.setExtendData(wsInitData);</span><br><span class=line></span><br><span class=line>sendMsg(messageSendDto, userId);</span><br></pre></table></figure><h3 id=èŠå¤©><a class=headerlink href=#èŠå¤© title=èŠå¤©></a>èŠå¤©</h3><p>ä¸»è¦ä½¿ç”¨wså‘é€æ¶ˆæ¯,ä½†å¤šæœºç¯å¢ƒä¸‹å‘ä¸åŒæœåŠ¡å™¨å‘é€wsæ¶ˆæ¯ä¸å…±äº«,ä½¿ç”¨RedissonåŸºäºredissæ¶ˆæ¯è®¢é˜…å‘é€æ¶ˆæ¯,è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹å‘é€æ¶ˆæ¯(å› ä¸ºé›†ç¾¤ä¸­çš„æœåŠ¡å™¨éƒ½é€šè¿‡redissionè®¢é˜…äº†ç›¸åŒä¸»é¢˜)<p><img alt=image-20250721223758683 data-src=https://s2.loli.net/2025/07/21/y6cuUbi5AOKPRVr.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component("messageHandler")</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MessageHandler</span><<span class=title>T</span>> </span>{</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> Logger logger = LoggerFactory.getLogger(MessageHandler.class);</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String MESSAGE_TOPIC = <span class=string>"message.topic"</span>;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>    <span class=keyword>private</span> RedissonClient redissonClient;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>    <span class=keyword>private</span> ChannelContextUtils channelContextUtils;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=meta>@PostConstruct</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>lisMessage</span><span class=params>()</span> </span>{</span><br><span class=line>        RTopic rTopic = redissonClient.getTopic(MESSAGE_TOPIC);</span><br><span class=line>        rTopic.addListener(MessageSendDto.class, (MessageSendDto, sendDto) -> {</span><br><span class=line>            logger.info(<span class=string>"æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯:{}"</span>, JSON.toJSONString(sendDto));</span><br><span class=line>            channelContextUtils.sendMessage(sendDto);</span><br><span class=line>        });</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>sendMessage</span><span class=params>(MessageSendDto sendDto)</span> </span>{</span><br><span class=line>        RTopic rTopic = redissonClient.getTopic(MESSAGE_TOPIC);</span><br><span class=line>        rTopic.publish(sendDto);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>æ•°æ®åº“è®¾è®¡ä¸Š,ä½¿ç”¨chat_session,chat_session_userä»¥åŠchat_messageè¡¨<p>sessionè¡¨åŒ…æ‹¬sessionId(ä¸èŠå¤©åŒæ–¹ç›¸å…³)ä»¥åŠæœ€æ–°æ¶ˆæ¯å’Œæ¥æ”¶æ—¶é—´<p><img alt=image-20250721091312712 data-src=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png><p>chat_session_userè¡¨åŒ…æ‹¬sessionId(ä¸èŠå¤©åŒæ–¹ç›¸å…³)ä»¥åŠæœ€æ–°æ¶ˆæ¯å’Œæ¥æ”¶æ—¶é—´. ä¸€ä¸ªchat_session_userè¡¨å¯¹åº”ä¸€ä¸ªsessionè¡¨,é€šè¿‡session_idæŸ¥è¯¢æœ€æ–°çš„æ¶ˆæ¯.<p><img alt=image-20250721091337069 data-src=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png><p>chat_messageè¡¨åŒ…æ‹¬å…·ä½“æ¶ˆæ¯,åŒ…æ‹¬å‘é€è€…å’Œæ¥æ”¶è€…,sessionId,messageIdä»¥åŠæ¶ˆæ¯ç±»å‹,æ–‡ä»¶ç±»å‹,çŠ¶æ€,å‘é€è€…æ˜µç§°,æ–‡ä»¶ç±»å‹,æ–‡ä»¶åç§°ç­‰<p><img alt=image-20250721202934542 data-src=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png><h4 id=å‘é€æ¶ˆæ¯><a class=headerlink href=#å‘é€æ¶ˆæ¯ title=å‘é€æ¶ˆæ¯></a>å‘é€æ¶ˆæ¯</h4><p>ç”¨æˆ·å‘è”ç³»äººå‘é€æ¶ˆæ¯,ä¸»è¦å°±æ˜¯æ’å…¥chat_messageè¡¨ä»¥åŠæ›´æ–°sessionè¡¨,messageHandlerå‘é€æ¶ˆæ¯.<p>éš¾ç‚¹æ˜¯å¤„ç†æ–‡ä»¶ä¸Šä¼ å’Œmessageå‘é€çŠ¶æ€. é¦–å…ˆåˆ¤æ–­ä¸æ˜¯æœºå™¨äºº,å¦‚æœä¸æ˜¯,åˆ¤æ–­èŠå¤©contact_idæ˜¯å¦åˆæ³•.<p>æ¥ç€åˆ¤æ–­æ¶ˆæ¯ç±»å‹å’Œcontactç±»å‹,å¦‚æœæ˜¯ç”¨æˆ·,å°±æ˜¯ç”¨æˆ·ä¹‹é—´èŠå¤©,ç”ŸæˆsessionIdæ–¹å¼ä¸åŒ,æ¥ç€æ›´æ–°chat_sessionè¡¨,å¦‚æœæ˜¯group,æ¶ˆæ¯ç±»å‹ä¸æ˜¯åˆ›å»ºç¾¤è¿™ç§æ¶ˆæ¯,å°±éœ€è¦å¸¦ç€userId,è¡¨æ˜è°å‘é€çš„å­˜å‚¨åœ¨chat_sessionè¡¨ä¸­.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER == contactTypeEnum) {</span><br><span class=line>    sessionId = StringTools.getChatSessionId4User(<span class=keyword>new</span> String[]{sendUserId, contactId});</span><br><span class=line>} <span class=keyword>else</span> {</span><br><span class=line>    sessionId = StringTools.getChatSessionId4Group(contactId);</span><br><span class=line>}</span><br><span class=line><span class=comment>//æ›´æ–°ä¼šè¯æ¶ˆæ¯</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.GROUP == contactTypeEnum && !MessageTypeEnum.GROUP_CREATE.getType().equals(messageTypeEnum.getType())) {</span><br><span class=line>    chatSession.setLastMessage(tokenUserInfoDto.getNickName() + <span class=string>"ï¼š"</span> + messageContent);</span><br><span class=line>}</span><br><span class=line>lastMessage = chatSession.getLastMessage();</span><br><span class=line><span class=comment>//å¦‚æœæ˜¯åª’ä½“æ–‡ä»¶</span></span><br><span class=line>chatSession.setLastReceiveTime(curTime);</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//è®°å½•æ¶ˆæ¯æ¶ˆæ¯è¡¨</span></span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendUserId(sendUserId);</span><br><span class=line>chatMessage.setSendUserNickName(tokenUserInfoDto.getNickName());</span><br><span class=line>chatMessage.setSendTime(curTime);</span><br><span class=line>chatMessage.setContactType(contactTypeEnum.getType());</span><br><span class=line>chatMessage.setStatus(status);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>å¦‚æœå‘é€çš„æ˜¯æ–‡ä»¶ç±»å‹,ç”±äºéœ€è¦ä¸Šä¼ ,æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸ºæ­£åœ¨å‘é€,ç­‰æ–‡ä»¶ä¸Šä¼ å®Œæ¯•å†æ›´æ–°.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>Integer status = MessageTypeEnum.MEDIA_CHAT == messageTypeEnum ? MessageStatusEnum.SENDING.getStatus() : MessageStatusEnum.SENDED.getStatus();</span><br></pre></table></figure><p>æœ€åé€šè¿‡messageHandlerå‘é€æ¶ˆæ¯<p>å¦‚æœæ˜¯æœºå™¨äºº,æœºå™¨äººä¼šç›´æ¥å‘é€æ¶ˆæ¯è¿‡å»,ä¹Ÿå°±æ˜¯å†æ¬¡è°ƒç”¨saveMessageæ–¹æ³•æœ¬èº«,å†åœ¨æ–¹æ³•ä¸­é€šè¿‡messageHandlerå‘é€å›ç”¨æˆ·.<p>æœ€åä¼šå°†å‘é€çš„æ¶ˆæ¯å†ä¼ åˆ°å®¢æˆ·ç«¯,æ–¹ä¾¿æ‹¿åˆ°æ¶ˆæ¯id.<h4 id=ä¸Šä¼ æ–‡ä»¶><a class=headerlink href=#ä¸Šä¼ æ–‡ä»¶ title=ä¸Šä¼ æ–‡ä»¶></a>ä¸Šä¼ æ–‡ä»¶</h4><p>controllerå‚æ•°åŒ…æ‹¬messageId,æ£€æŸ¥å‘é€è€…æ˜¯å¦messageIdå¯¹åº”æ¶ˆæ¯çš„å‘é€è€….æ˜¯ä¸Šä¼ æ–‡ä»¶,é¦–å…ˆæ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶.ç„¶åç›´æ¥ä¸Šä¼ å³å¯(æ²¡æœ‰åšç§’ä¼ ,åˆ†ç‰‡ç»­ä¼ ç­‰).<p>ä¸‹è½½çš„è·¯å¾„éµå¾ªBASE_FOLDER+FILE+yyyyMM+messageid.suffix<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>String fileName = file.getOriginalFilename();</span><br><span class=line>String fileExtName = StringTools.getFileSuffix(fileName);</span><br><span class=line>String fileRealName = messageId + fileExtName;</span><br><span class=line>String month = DateUtil.format(<span class=keyword>new</span> Date(message.getSendTime()), DateTimePatternEnum.YYYYMM.getPattern());</span><br><span class=line>File folder = <span class=keyword>new</span> File(appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE + month);</span><br><span class=line><span class=keyword>if</span> (!folder.exists()) {</span><br><span class=line>    folder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>File uploadFile = <span class=keyword>new</span> File(folder.getPath() + <span class=string>"/"</span> + fileRealName);</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    file.transferTo(uploadFile);</span><br><span class=line>    <span class=keyword>if</span> (cover != <span class=keyword>null</span>) {</span><br><span class=line>        cover.transferTo(<span class=keyword>new</span> File(uploadFile.getPath() + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>    }</span><br><span class=line>} <span class=keyword>catch</span> (Exception e) {</span><br><span class=line>    logger.error(<span class=string>"ä¸Šä¼ æ–‡ä»¶å¤±è´¥"</span>, e);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"æ–‡ä»¶ä¸Šä¼ å¤±è´¥"</span>);</span><br><span class=line>}</span><br></pre></table></figure><p>ç„¶åæ›´æ–°chat_messageè¡¨,åˆ©ç”¨æ‹¿åˆ°çš„messageId,çŠ¶æ€æ”¹ä¸ºå·²å‘é€.<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>ChatMessage updateInfo = <span class=keyword>new</span> <span class=constructor>ChatMessage()</span>;</span><br><span class=line>updateInfo.set<span class=constructor>Status(MessageStatusEnum.SENDED.<span class=params>getStatus</span>()</span>);</span><br><span class=line>ChatMessageQuery messageQuery = <span class=keyword>new</span> <span class=constructor>ChatMessageQuery()</span>;</span><br><span class=line>messageQuery.set<span class=constructor>MessageId(<span class=params>messageId</span>)</span>;</span><br><span class=line>chatMessageMapper.update<span class=constructor>ByParam(<span class=params>updateInfo</span>, <span class=params>messageQuery</span>)</span>;</span><br></pre></table></figure><p>æœ€åé€šè¿‡messageHandlerå‘é€ç»™æ¶ˆæ¯çš„æ¥æ”¶è€…,è¡¨æ˜æ–‡ä»¶ä¸Šä¼ æˆåŠŸ,å¯ä»¥ä¸‹è½½äº†.æ¶ˆæ¯å†…å®¹åŒ…å«messageId,è¿™æ ·æ¥æ”¶è€…å¯ä»¥åˆ©ç”¨è¿™ä¸ªidä¸‹è½½æ–‡ä»¶<h4 id=ä¸‹è½½æ–‡ä»¶><a class=headerlink href=#ä¸‹è½½æ–‡ä»¶ title=ä¸‹è½½æ–‡ä»¶></a>ä¸‹è½½æ–‡ä»¶</h4><p>æ³¨æ„æ–‡ä»¶åŒ…æ‹¬ç”¨æˆ·/ç¾¤èŠå¤´åƒè¿˜åŒ…æ‹¬æ¶ˆæ¯ä¸­çš„æ–‡ä»¶,å¦‚æœæ˜¯æ¶ˆæ¯id(å…¨ä¸ºæ•´æ•°),å°±ä¼šæ ¹æ®æ¶ˆæ¯idæŸ¥è¯¢å‘é€æ—¶é—´,æ‹¼æ¥ä¸ºæ–‡ä»¶è·¯å¾„,ç„¶åä¸‹è½½. é¦–å…ˆæ£€æŸ¥æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦ç¬¦åˆ.<p>ç„¶åé€šè¿‡æ¶ˆæ¯idå’Œå‘é€æ—¶é—´æ‰¾åˆ°å¯¹åº”è·¯å¾„çš„æ–‡ä»¶,BASE_FOLDER+FILE+yyyyMM+message_id<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>String month = DateUtil.format(<span class=keyword>new</span> Date(message.getSendTime()), DateTimePatternEnum.YYYYMM.getPattern());</span><br><span class=line>File folder = <span class=keyword>new</span> File(appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE + month);</span><br><span class=line><span class=keyword>if</span> (!folder.exists()) {</span><br><span class=line>    folder.mkdirs();</span><br><span class=line>}</span><br><span class=line>String fileName = message.getFileName();</span><br><span class=line>String fileExtName = StringTools.getFileSuffix(fileName);</span><br><span class=line>String fileRealName = messageId + fileExtName;</span><br><span class=line></span><br><span class=line><span class=keyword>if</span> (cover != <span class=keyword>null</span> && cover) {</span><br><span class=line>    fileRealName = fileRealName + Constants.COVER_IMAGE_SUFFIX;</span><br><span class=line>}</span><br><span class=line>File file = <span class=keyword>new</span> File(folder.getPath() + <span class=string>"/"</span> + fileRealName);</span><br><span class=line><span class=keyword>if</span> (!file.exists()) {</span><br><span class=line>    logger.info(<span class=string>"æ–‡ä»¶ä¸å­˜åœ¨"</span>);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_602);</span><br><span class=line>}</span><br><span class=line><span class=keyword>return</span> file;</span><br></pre></table></figure><p>å¦åˆ™æ˜¯ç”¨æˆ·/ç¾¤èŠId(Uæˆ–è€…Gå‰ç¼€),æ‹¼æ¥ç”¨æˆ·idæ‰¾åˆ°è·¯å¾„ç„¶åä¸‹è½½<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>String avatarFolderName = Constants.FILE_FOLDER_FILE + Constants.FILE_FOLDER_AVATAR_NAME;</span><br><span class=line>String avatarPath = appConfig.getProjectFolder() + avatarFolderName + fileId + Constants.IMAGE_SUFFIX;</span><br><span class=line><span class=keyword>if</span> (showCover) {</span><br><span class=line>    avatarPath = avatarPath + Constants.COVER_IMAGE_SUFFIX;</span><br><span class=line>}</span><br><span class=line>file = <span class=keyword>new</span> File(avatarPath);</span><br><span class=line><span class=keyword>if</span> (!file.exists()) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_602);</span><br><span class=line>}</span><br></pre></table></figure><p>ä¸‹è½½ä½¿ç”¨<code>FileInputStream</code>å’Œ<code>HttpServletResponse.getOutputStream()</code>,æ¯æ¬¡è¯»1024å­—èŠ‚(1KB),é¿å…æ–‡ä»¶è¿‡å¤§.æ³¨æ„è®¾ç½®responseå¤´<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>response.setContentType(<span class=string>"application/x-msdownload; charset=UTF-8"</span>);</span><br><span class=line>response.setHeader(<span class=string>"Content-Disposition"</span>, <span class=string>"attachment;"</span>);</span><br><span class=line>response.setContentLengthLong(file.length());</span><br></pre></table></figure><p>ä¸»è¦è®¾ç½®content-type,content-disposition,content-lengthå¤´<h1 id=EasyPan><a class=headerlink href=#EasyPan title=EasyPan></a>EasyPan</h1><p><a href=https://docs.qq.com/doc/DY1JTbU9kSkRPUUVY rel=noopener target=_blank>03.Javaé¡¹ç›®åˆ›å»º</a><h3 id=IDEè®¾ç½®><a class=headerlink href=#IDEè®¾ç½® title=IDEè®¾ç½®></a>IDEè®¾ç½®</h3><h4 id=JDKä½ç½®è®¾ç½®><a class=headerlink href=#JDKä½ç½®è®¾ç½® title=JDKä½ç½®è®¾ç½®></a>JDKä½ç½®è®¾ç½®</h4><p><img alt=image-20250514230635404 data-src=https://s2.loli.net/2025/05/14/Wpwxn17jzJYgNiZ.png><h4 id=ç¼–è¯‘å™¨è‡ªåŠ¨æ„å»ºä¸çƒ­äº¤æ¢><a class=headerlink href=#ç¼–è¯‘å™¨è‡ªåŠ¨æ„å»ºä¸çƒ­äº¤æ¢ title=ç¼–è¯‘å™¨è‡ªåŠ¨æ„å»ºä¸çƒ­äº¤æ¢></a>ç¼–è¯‘å™¨è‡ªåŠ¨æ„å»ºä¸çƒ­äº¤æ¢</h4><p><img alt=image-20250514230730743 data-src=https://s2.loli.net/2025/05/14/IouNVMneLkvw5xd.png><p><img alt=image-20250514230903350 data-src=https://s2.loli.net/2025/05/14/fHxKr3uUjsJwGTV.png><p><img alt=image-20250514230936534 data-src=https://s2.loli.net/2025/05/14/VIFQjYLmdoMyuT4.png><h4 id=è®¾ç½®Mavenä½ç½®><a class=headerlink href=#è®¾ç½®Mavenä½ç½® title=è®¾ç½®Mavenä½ç½®></a>è®¾ç½®Mavenä½ç½®</h4><p><img alt=image-20250514231336188 data-src=https://s2.loli.net/2025/05/14/AYdCIP8NLceGyig.png><h4 id=è®¾ç½®æ–‡ä»¶ç¼–ç ><a class=headerlink href=#è®¾ç½®æ–‡ä»¶ç¼–ç  title=è®¾ç½®æ–‡ä»¶ç¼–ç ></a>è®¾ç½®æ–‡ä»¶ç¼–ç </h4><p><img alt=image-20250514231119345 data-src=https://s2.loli.net/2025/05/14/gfJ2BtnGVdkwj4a.png><h4 id=åˆ›å»ºå·¥ç¨‹><a class=headerlink href=#åˆ›å»ºå·¥ç¨‹ title=åˆ›å»ºå·¥ç¨‹></a>åˆ›å»ºå·¥ç¨‹</h4><p><img alt=image-20250514231258500 data-src=https://s2.loli.net/2025/05/14/PWJutmFC9iZyXNn.png><p>æˆ–åˆ›å»ºSpring Booté¡¹ç›®<h3 id=é…ç½®æ–‡ä»¶><a class=headerlink href=#é…ç½®æ–‡ä»¶ title=é…ç½®æ–‡ä»¶></a>é…ç½®æ–‡ä»¶</h3><h4 id=POM-xml><a class=headerlink href=#POM-xml title=POM.xml></a>POM.xml</h4><h5 id=é¡¹ç›®åŸºæœ¬ä¿¡æ¯><a class=headerlink href=#é¡¹ç›®åŸºæœ¬ä¿¡æ¯ title=é¡¹ç›®åŸºæœ¬ä¿¡æ¯></a>é¡¹ç›®åŸºæœ¬ä¿¡æ¯</h5><ul><li><code>&LTmodelVersion></code>ï¼šæŒ‡å®š POM æ¨¡å‹çš„ç‰ˆæœ¬ï¼Œé€šå¸¸ä¸º <code>4.0.0</code>ã€‚<li><code>&LTgroupId></code>ï¼šå®šä¹‰é¡¹ç›®æ‰€å±çš„ç»„ç»‡æˆ–å…¬å¸ï¼Œé€šå¸¸ä½¿ç”¨åå‘åŸŸåè¡¨ç¤ºã€‚<li><code>&LTartifactId></code>ï¼šé¡¹ç›®çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé€šå¸¸å¯¹åº”é¡¹ç›®åç§°ã€‚<li><code>&LTversion></code>ï¼šé¡¹ç›®çš„å½“å‰ç‰ˆæœ¬å·ã€‚<li><code>&LTpackaging></code>ï¼šæŒ‡å®šé¡¹ç›®çš„æ‰“åŒ…æ–¹å¼ï¼Œå¦‚ <code>jar</code>ã€<code>war</code> ç­‰ã€‚<li><code>&LTname></code>ï¼šé¡¹ç›®çš„åç§°ã€‚<li><code>&LTdescription></code>ï¼šé¡¹ç›®çš„ç®€è¦æè¿°ã€‚</ul><h5 id=ç»§æ‰¿ä¸æ¨¡å—ç®¡ç†><a class=headerlink href=#ç»§æ‰¿ä¸æ¨¡å—ç®¡ç† title=ç»§æ‰¿ä¸æ¨¡å—ç®¡ç†></a>ç»§æ‰¿ä¸æ¨¡å—ç®¡ç†</h5><ul><li><code>&LTparent></code>ï¼šæŒ‡å®šå½“å‰é¡¹ç›®ç»§æ‰¿çš„çˆ¶ POMï¼Œä¾¿äºå…±äº«ç»Ÿä¸€çš„é…ç½®å’Œä¾èµ–ç®¡ç†ã€‚<li><code>&LTmodules></code>ï¼šåœ¨å¤šæ¨¡å—é¡¹ç›®ä¸­ï¼Œåˆ—å‡ºæ‰€æœ‰å­æ¨¡å—çš„ç›®å½•åç§°ã€‚</ul><h5 id=ä¾èµ–ç®¡ç†><a class=headerlink href=#ä¾èµ–ç®¡ç† title=ä¾èµ–ç®¡ç†></a>ä¾èµ–ç®¡ç†</h5><ul><li><code>&LTdependencies></code>ï¼šåˆ—å‡ºé¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚<li><code>&LTdependencyManagement></code>ï¼šç”¨äºç»Ÿä¸€ç®¡ç†ä¾èµ–çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå­é¡¹ç›®å¯ä»¥å¼•ç”¨è€Œæ— éœ€æŒ‡å®šç‰ˆæœ¬ã€‚<li><code>&LTrepositories></code>ï¼šæŒ‡å®šé¢å¤–çš„è¿œç¨‹ä»“åº“åœ°å€ï¼Œä»¥è·å–ä¾èµ–ã€‚</ul><h5 id=æ„å»ºé…ç½®><a class=headerlink href=#æ„å»ºé…ç½® title=æ„å»ºé…ç½®></a>æ„å»ºé…ç½®</h5><ul><li><p><code>&LTbuild></code>ï¼šå®šä¹‰é¡¹ç›®çš„æ„å»ºç›¸å…³é…ç½®ã€‚</p> <ul><li><code>&LTsourceDirectory></code>ï¼šæŒ‡å®šæºä»£ç ç›®å½•ã€‚<li><code>&LToutputDirectory></code>ï¼šæŒ‡å®šç¼–è¯‘è¾“å‡ºç›®å½•ã€‚<li><code>&LTplugins></code>ï¼šé…ç½®æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ’ä»¶ï¼Œå¦‚ <code>maven-compiler-plugin</code> ç­‰ã€‚</ul> <p><strong>é»˜è®¤ç›®å½•ç»“æ„</strong></p> <ul><li><strong>ä¸»æºä»£ç ç›®å½•</strong>ï¼š<code>src/main/java</code><li><strong>ä¸»èµ„æºç›®å½•</strong>ï¼š<code>src/main/resources</code><li><strong>æµ‹è¯•æºä»£ç ç›®å½•</strong>ï¼š<code>src/test/java</code><li><strong>æµ‹è¯•èµ„æºç›®å½•</strong>ï¼š<code>src/test/resources</code><li><strong>æ„å»ºè¾“å‡ºç›®å½•</strong>ï¼š<code>target/</code><li><strong>ä¸»ç±»è¾“å‡ºç›®å½•</strong>ï¼š<code>target/classes</code><li><strong>æµ‹è¯•ç±»è¾“å‡ºç›®å½•</strong>ï¼š`target/test-classes</ul> <p>è¿™äº›é»˜è®¤è®¾ç½®æºè‡ªäº Maven çš„ Super POM<a href=https://maven.apache.org/ref/3.9.9/maven-model-builder/super-pom.html rel=noopener target=_blank>Maven Model Builder â€“ Super POM</a>ï¼Œæ‰€æœ‰é¡¹ç›®åœ¨æœªæ˜¾å¼é…ç½®çš„æƒ…å†µä¸‹éƒ½ä¼šç»§æ‰¿è¿™äº›è®¾ç½®</p> <p><strong>è‡ªå®šä¹‰è¾“å…¥ç›®å½•</strong></p> <p>å¦‚æœé¡¹ç›®ç»“æ„ä¸åŒäº Maven çš„é»˜è®¤ç»“æ„ï¼Œå¯ä»¥åœ¨ <code>pom.xml</code> ä¸­è‡ªå®šä¹‰è¾“å…¥ç›®å½•ã€‚ä¾‹å¦‚ï¼š</p> <figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>build</span>></span></span><br><span class=line>  <span class=tag><<span class=name>sourceDirectory</span>></span>src/my-src<span class=tag>&LT/<span class=name>sourceDirectory</span>></span></span><br><span class=line>  <span class=tag><<span class=name>testSourceDirectory</span>></span>src/my-test<span class=tag>&LT/<span class=name>testSourceDirectory</span>></span></span><br><span class=line>  <span class=tag><<span class=name>resources</span>></span></span><br><span class=line>    <span class=tag><<span class=name>resource</span>></span></span><br><span class=line>      <span class=tag><<span class=name>directory</span>></span>src/my-resources<span class=tag>&LT/<span class=name>directory</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>resource</span>></span></span><br><span class=line>  <span class=tag>&LT/<span class=name>resources</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>build</span>></span></span><br></pre></table></figure> <p>ä¸Šè¿°é…ç½®å°†ä¸»æºä»£ç ç›®å½•æ›´æ”¹ä¸º <code>src/my-src</code>ï¼Œæµ‹è¯•æºä»£ç ç›®å½•æ›´æ”¹ä¸º <code>src/my-test</code>ï¼Œèµ„æºç›®å½•æ›´æ”¹ä¸º <code>src/my-resources</code>ã€‚</p></ul><h5 id=å±æ€§å®šä¹‰><a class=headerlink href=#å±æ€§å®šä¹‰ title=å±æ€§å®šä¹‰></a>å±æ€§å®šä¹‰</h5><ul><li><code>&LTproperties></code>ï¼šå®šä¹‰å¯åœ¨ POM ä¸­å¼•ç”¨çš„å˜é‡ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ã€‚</ul><h5 id=æ„å»ºç¯å¢ƒä¸å‘å¸ƒé…ç½®><a class=headerlink href=#æ„å»ºç¯å¢ƒä¸å‘å¸ƒé…ç½® title=æ„å»ºç¯å¢ƒä¸å‘å¸ƒé…ç½®></a>æ„å»ºç¯å¢ƒä¸å‘å¸ƒé…ç½®</h5><ul><li><code>&LTprofiles></code>ï¼šå®šä¹‰ä¸åŒçš„æ„å»ºé…ç½®ï¼Œä¾¿äºåœ¨ä¸åŒç¯å¢ƒä¸‹ä½¿ç”¨ã€‚<li><code>&LTdistributionManagement></code>ï¼šé…ç½®é¡¹ç›®çš„å‘å¸ƒä¿¡æ¯ï¼Œå¦‚éƒ¨ç½²åˆ°çš„ä»“åº“åœ°å€ç­‰ã€‚</ul><p><a href=https://maven.apache.org/guides/introduction/introduction-to-the-pom.html rel=noopener target=_blank>Introduction to the POM â€“ Maven</a><h4 id=æ—¥å¿—è®°å½•><a class=headerlink href=#æ—¥å¿—è®°å½• title=æ—¥å¿—è®°å½•></a>æ—¥å¿—è®°å½•</h4><blockquote><p>Spring Boot ä½¿ç”¨ Commons Logging è¿›è¡Œæ‰€æœ‰å†…éƒ¨æ—¥å¿—è®°å½•ï¼Œä½†åº•å±‚æ—¥å¿—å®ç°ä¿æŒå¼€æ”¾ã€‚ä¸º Java Util Loggingã€Log4j2 å’Œ Logback æä¾›äº†é»˜è®¤é…ç½®ã€‚åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œæ—¥å¿—è®°å½•å™¨éƒ½é¢„å…ˆé…ç½®ä¸ºä½¿ç”¨æ§åˆ¶å°è¾“å‡ºï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€‰æ‹©æ–‡ä»¶è¾“å‡ºã€‚</blockquote><p><img alt=img data-src=https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/logback-6ba1b465-5533-49dd-b875-48a10ba29f8e.png style=zoom:67%;><p>å½“å‰ç‰ˆæœ¬logbackä¸­é‡è¦ç»„ä»¶åŒ…æ‹¬appender,ä¹Ÿå°±æ˜¯é…ç½®æ—¥å¿—çš„è¾“å‡ºç›®çš„åœ°ï¼Œé€šè¿‡ name å±æ€§æŒ‡å®šåå­—ï¼Œé€šè¿‡ class å±æ€§æŒ‡å®šç›®çš„åœ°ï¼š<ul><li>ch.qos.logback.core.ConsoleAppenderï¼šè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚<li>ch.qos.logback.core.FileAppenderï¼šè¾“å‡ºåˆ°æ–‡ä»¶ã€‚<li>ch.qos.logback.core.rolling.RollingFileAppenderï¼šæ–‡ä»¶å¤§å°è¶…è¿‡é˜ˆå€¼æ—¶äº§ç”Ÿä¸€ä¸ªæ–°æ–‡ä»¶ã€‚</ul><p>encoder,loggerä»¥åŠroot,å®ƒåªæ”¯æŒä¸€ä¸ªå±æ€§â€”â€”levelï¼Œå€¼å¯ä»¥ä¸ºï¼šTRACEã€DEBUGã€INFOã€WARNã€ERRORã€ALLã€OFF.<p><strong><code>&LTproperty></code></strong>ï¼šå®šä¹‰çš„å˜é‡å¯ä»¥åœ¨æ•´ä¸ªé…ç½®æ–‡ä»¶ä¸­é€šè¿‡ <code>${}</code> å¼•ç”¨ï¼Œä¾¿äºç»´æŠ¤å’Œä¿®æ”¹ã€‚<p><strong><code>&LTappender></code></strong>ï¼šå®šä¹‰æ—¥å¿—çš„è¾“å‡ºæ–¹å¼ã€‚<ul><li><strong><code>ConsoleAppender</code></strong>ï¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚<li><strong><code>RollingFileAppender</code></strong>ï¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œå¹¶æ”¯æŒæŒ‰æ—¶é—´æ»šåŠ¨ç”Ÿæˆæ–°æ–‡ä»¶ã€‚</ul><p><strong><code>&LTlogger></code></strong>ï¼šä¸ºç‰¹å®šçš„åŒ…æˆ–ç±»è®¾ç½®æ—¥å¿—çº§åˆ«å’Œè¾“å‡ºæ–¹å¼ã€‚<p><strong><code>&LTroot></code></strong>ï¼šå®šä¹‰é»˜è®¤çš„æ—¥å¿—çº§åˆ«å’Œè¾“å‡ºæ–¹å¼ï¼Œé€‚ç”¨äºæœªè¢«å…¶ä»– <code>logger</code> æ•è·çš„æ—¥å¿—ã€‚<p>pattern ç”¨æ¥æŒ‡å®šæ—¥å¿—çš„è¾“å‡ºæ ¼å¼ï¼š<ul><li><code>%d</code>ï¼šè¾“å‡ºçš„æ—¶é—´æ ¼å¼ã€‚<li><code>%thread</code>ï¼šæ—¥å¿—çš„çº¿ç¨‹åã€‚<li><code>%-5level</code>ï¼šæ—¥å¿—çš„è¾“å‡ºçº§åˆ«ï¼Œå¡«å……åˆ° 5 ä¸ªå­—ç¬¦ã€‚æ¯”å¦‚è¯´ info åªæœ‰ 4 ä¸ªå­—ç¬¦ï¼Œå°±å¡«å……ä¸€ä¸ªç©ºæ ¼ï¼Œè¿™æ ·æ—¥å¿—ä¿¡æ¯å°±å¯¹é½äº†ã€‚<li><code>%logger{length}</code>ï¼šlogger çš„åç§°ï¼Œlength ç”¨æ¥ç¼©çŸ­åç§°ã€‚æ²¡æœ‰æŒ‡å®šè¡¨ç¤ºå®Œæ•´è¾“å‡ºï¼›0 è¡¨ç¤ºåªè¾“å‡º logger æœ€å³è¾¹ç‚¹å·ä¹‹åçš„å­—ç¬¦ä¸²ï¼›å…¶ä»–æ•°å­—è¡¨ç¤ºè¾“å‡ºå°æ•°ç‚¹æœ€åè¾¹ç‚¹å·ä¹‹å‰çš„å­—ç¬¦æ•°é‡ã€‚<li><code>%msg</code>ï¼šæ—¥å¿—çš„å…·ä½“ä¿¡æ¯ã€‚<li><code>%n</code>ï¼šæ¢è¡Œç¬¦ã€‚<li><code>%relative</code>ï¼šè¾“å‡ºä»ç¨‹åºå¯åŠ¨åˆ°åˆ›å»ºæ—¥å¿—è®°å½•çš„æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚</ul><p><code>logback-spring.xml</code>æä¾›äº†<code>&LTspringProperty></code>ä»¥åŠ<code>&LTspringProfile></code>å¯ä»¥è¯»å–springBooté…ç½®æ–‡ä»¶ä¸­çš„å±æ€§.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br></pre><td class=code><pre><span class=line><span class=meta>&LT?xml version="1.0" encoding="UTF-8" ?></span></span><br><span class=line><span class=tag><<span class=name>configuration</span>></span></span><br><span class=line>    <span class=tag><<span class=name>appender</span> <span class=attr>name</span>=<span class=string>"stdot"</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.ConsoleAppender"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>encoder</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>></span></span><br><span class=line>            <span class=tag><<span class=name>pattern</span>></span>%d{yyyy-MM-dd HH:mm:ss,GMT+8} [%p][%c][%M][%L]-> %m%n<span class=tag>&LT/<span class=name>pattern</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>encoder</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>appender</span>></span></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>appender</span> <span class=attr>name</span>=<span class=string>"file"</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.rolling.RollingFileAppender"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>file</span>></span>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}<span class=tag>&LT/<span class=name>file</span>></span></span><br><span class=line><span class=comment>&LT!--        &LTrollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">--></span></span><br><span class=line><span class=comment>&LT!--            &LTfileNamePattern>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}.%d{yyyy-MM-dd}.%i&LT/fileNamePattern>--></span></span><br><span class=line><span class=comment>&LT!--            &LTtotalSizeCap>5G&LT/totalSizeCap>--></span></span><br><span class=line><span class=comment>&LT!--            &LTmaxHistory>30&LT/maxHistory>--></span></span><br><span class=line><span class=comment>&LT!--        &LT/rollingPolicy>--></span></span><br><span class=line>        <span class=tag><<span class=name>rollingPolicy</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>></span></span><br><span class=line>            <span class=comment>&LT!-- rollover daily --></span></span><br><span class=line>            <span class=tag><<span class=name>fileNamePattern</span>></span>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}.%d{yyyy-MM-dd}.%i<span class=tag>&LT/<span class=name>fileNamePattern</span>></span></span><br><span class=line>            <span class=comment>&LT!-- each file should be at most 100MB, keep 60 days worth of history, but at most 20GB --></span></span><br><span class=line>            <span class=tag><<span class=name>maxFileSize</span>></span>100MB<span class=tag>&LT/<span class=name>maxFileSize</span>></span></span><br><span class=line>            <span class=tag><<span class=name>maxHistory</span>></span>60<span class=tag>&LT/<span class=name>maxHistory</span>></span></span><br><span class=line>            <span class=tag><<span class=name>totalSizeCap</span>></span>20GB<span class=tag>&LT/<span class=name>totalSizeCap</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>rollingPolicy</span>></span></span><br><span class=line>        <span class=tag><<span class=name>encoder</span>></span></span><br><span class=line>            <span class=tag><<span class=name>pattern</span>></span>%d{yyyy-MM-dd HH:mm:ss,GMT+8} [%p][%c][%M][%L]-> %m%n<span class=tag>&LT/<span class=name>pattern</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>encoder</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>appender</span>></span></span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>springProperty</span> <span class=attr>scope</span>=<span class=string>"context"</span> <span class=attr>name</span>=<span class=string>"log.path"</span> <span class=attr>source</span>=<span class=string>"project.folder"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>springProperty</span> <span class=attr>scope</span>=<span class=string>"context"</span> <span class=attr>name</span>=<span class=string>"log.root.level"</span> <span class=attr>source</span>=<span class=string>"log.root.level"</span>/></span></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>property</span> <span class=attr>name</span>=<span class=string>"LOG_FOLDER"</span> <span class=attr>value</span>=<span class=string>"logs"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>property</span> <span class=attr>name</span>=<span class=string>"LOG_FILE_NAME"</span> <span class=attr>value</span>=<span class=string>"easypan.log"</span>/></span></span><br><span class=line>    </span><br><span class=line><span class=comment>&LT!--    &LTlogger name="top.sekyoro.easypan" level="${log.root.level}">--></span></span><br><span class=line><span class=comment>&LT!--        &LTappender-ref ref="stdot"/>--></span></span><br><span class=line><span class=comment>&LT!--        &LTappender-ref ref="file"/>--></span></span><br><span class=line><span class=comment>&LT!--    &LT/logger>   --></span></span><br><span class=line><span class=comment>&LT!--    --></span></span><br><span class=line>    <span class=tag><<span class=name>root</span> <span class=attr>level</span>=<span class=string>"${log.root.level}"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>appender-ref</span> <span class=attr>ref</span>=<span class=string>"stdot"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>appender-ref</span> <span class=attr>ref</span>=<span class=string>"file"</span>/></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>root</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>configuration</span>></span></span><br></pre></table></figure><ul><li><a href=https://docs.spring.io/spring-boot/reference/features/logging.html#features.logging.logback-extensions rel=noopener target=_blank>Logging :: Spring Boot</a><li><a href=https://logback.qos.ch/manual/encoders.html rel=noopener target=_blank>Chapter 5: Encoders</a><li><a href=https://logback.qos.ch/codes.html#layoutInsteadOfEncoder rel=noopener target=_blank>Logback Error Codes</a><li><a href=https://javabetter.cn/gongju/logback.html#_03ã€æŠŠ-log4j-properties-è½¬æˆ-logback-test-xml rel=noopener target=_blank>Logbackï¼šSpring Bootå†…ç½®çš„æ—¥å¿—å¤„ç†æ¡†æ¶ | äºŒå“¥çš„Javaè¿›é˜¶ä¹‹è·¯</a><li><a href=https://docs.spring.io/spring-boot/docs/2.1.8.RELEASE/reference/html/boot-features-logging.html#boot-features-logback-extensions rel=noopener target=_blank>26. Logging</a></ul><h4 id=application-properties><a class=headerlink href=#application-properties title=application.properties></a>application.properties</h4><h5 id=æœåŠ¡å™¨é…ç½®><a class=headerlink href=#æœåŠ¡å™¨é…ç½® title=æœåŠ¡å™¨é…ç½®></a>æœåŠ¡å™¨é…ç½®</h5><ul><li><code>server.port=8080</code>ï¼šè®¾ç½®åº”ç”¨çš„ç«¯å£å·ã€‚<li><code>server.servlet.context-path=/api</code>ï¼šè®¾ç½®åº”ç”¨çš„ä¸Šä¸‹æ–‡è·¯å¾„ã€‚</ul><h5 id=åº”ç”¨ä¿¡æ¯><a class=headerlink href=#åº”ç”¨ä¿¡æ¯ title=åº”ç”¨ä¿¡æ¯></a>åº”ç”¨ä¿¡æ¯</h5><ul><li><code>spring.application.name=myapp</code>ï¼šè®¾ç½®åº”ç”¨çš„åç§°ã€‚</ul><h5 id=æ•°æ®æºé…ç½®ï¼ˆä»¥-MySQL-ä¸ºä¾‹ï¼‰><a title="æ•°æ®æºé…ç½®ï¼ˆä»¥ MySQL ä¸ºä¾‹ï¼‰" class=headerlink href=#æ•°æ®æºé…ç½®ï¼ˆä»¥-MySQL-ä¸ºä¾‹ï¼‰></a>æ•°æ®æºé…ç½®ï¼ˆä»¥ MySQL ä¸ºä¾‹ï¼‰</h5><ul><li><code>spring.datasource.url=jdbc:mysql://localhost:3306/db_example</code><li><code>spring.datasource.username=root</code><li><code>spring.datasource.password=secret</code><li><code>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</code><li><code>spring.jpa.hibernate.ddl-auto=update</code>ï¼šè®¾ç½® JPA çš„ DDL ç­–ç•¥ã€‚</ul><h5 id=æ—¥å¿—é…ç½®><a class=headerlink href=#æ—¥å¿—é…ç½® title=æ—¥å¿—é…ç½®></a>æ—¥å¿—é…ç½®</h5><ul><li><code>logging.level.root=INFO</code>ï¼šè®¾ç½®æ ¹æ—¥å¿—çº§åˆ«ã€‚<li><code>logging.level.com.example=DEBUG</code>ï¼šè®¾ç½®ç‰¹å®šåŒ…çš„æ—¥å¿—çº§åˆ«ã€‚<li><code>logging.file.name=logs/app.log</code>ï¼šè®¾ç½®æ—¥å¿—æ–‡ä»¶åç§°ã€‚<li><code>logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n</code>ï¼šè®¾ç½®æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæ ¼å¼</ul><h5 id=é‚®ä»¶é…ç½®><a class=headerlink href=#é‚®ä»¶é…ç½® title=é‚®ä»¶é…ç½®></a>é‚®ä»¶é…ç½®</h5><ul><li><code>spring.mail.host=smtp.example.com</code><li><code>spring.mail.port=587</code><li><code>spring.mail.username=user@example.com</code><li><code>spring.mail.password=secret</code><li><code>spring.mail.properties.mail.smtp.auth=true</code><li><code>spring.mail.properties.mail.smtp.starttls.enable=true</code></ul><h5 id=å®‰å…¨é…ç½®><a class=headerlink href=#å®‰å…¨é…ç½® title=å®‰å…¨é…ç½®></a>å®‰å…¨é…ç½®</h5><ul><li><code>spring.security.user.name=admin</code><li><code>spring.security.user.password=secret</code><li><code>spring.security.user.roles=USER,ADMIN</code></ul><h5 id=ç¼“å­˜é…ç½®><a class=headerlink href=#ç¼“å­˜é…ç½® title=ç¼“å­˜é…ç½®></a>ç¼“å­˜é…ç½®</h5><ul><li><code>spring.cache.type=simple</code>ï¼šè®¾ç½®ç¼“å­˜ç±»å‹ã€‚<li><code>spring.cache.cache-names=users,transactions</code>ï¼šå®šä¹‰ç¼“å­˜åç§°ã€‚</ul><h5 id=å›½é™…åŒ–é…ç½®><a class=headerlink href=#å›½é™…åŒ–é…ç½® title=å›½é™…åŒ–é…ç½®></a>å›½é™…åŒ–é…ç½®</h5><ul><li><code>spring.messages.basename=messages</code>ï¼šè®¾ç½®æ¶ˆæ¯èµ„æºæ–‡ä»¶çš„åŸºç¡€åç§°ã€‚<li><code>spring.messages.encoding=UTF-8</code>ï¼šè®¾ç½®æ¶ˆæ¯èµ„æºæ–‡ä»¶çš„ç¼–ç ã€‚</ul><h5 id=æµ‹è¯•é…ç½®><a class=headerlink href=#æµ‹è¯•é…ç½® title=æµ‹è¯•é…ç½®></a>æµ‹è¯•é…ç½®</h5><ul><li><code>spring.main.allow-bean-definition-overriding=true</code>ï¼šå…è®¸è¦†ç›– Bean å®šä¹‰ã€‚<li><code>spring.profiles.active=dev</code>ï¼šè®¾ç½®æ´»åŠ¨çš„é…ç½®æ–‡ä»¶ã€‚</ul><p><strong>æ³¨æ„</strong>:1.æ–°ç‰ˆæœ¬ä¸­,<code>spring.mvc.throw-exception-if-no-handler-found</code> å±æ€§å·²è¢«<a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/deprecated-list.html rel=noopener target=_blank>å¼ƒç”¨</a>ï¼Œå»ºè®®ä¸å†ä½¿ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹,Spring Boot ä¼šè¿”å› 404 å“åº”ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚<p>2.<code>spring.mvc.favicon.enable=false</code>é…ç½®å±æ€§å·²å¼ƒç”¨ã€‚æ­¤å¤–ï¼ŒSpring Boot ä¸å†æä¾›é»˜è®¤çš„ faviconï¼Œå› ä¸ºæ­¤å›¾æ ‡å¯è¢«è§†ä¸ºä¿¡æ¯æ³„éœ²,å¯ä»¥å¢åŠ å¯¹åº”handler.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>FaviconConfig</span> <span class=keyword>implements</span> <span class=title>WebMvcConfigurer</span> </span>{</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addResourceHandlers</span><span class=params>(ResourceHandlerRegistry registry)</span> </span>{</span><br><span class=line>        registry.addResourceHandler(<span class=string>"/favicon.ico"</span>)</span><br><span class=line>                .addResourceLocations(<span class=string>"classpath:/static/"</span>);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p><a href=https://www.baeldung-cn.com/spring-boot-favicon rel=noopener target=_blank>Spring Bootä¸­faviconçš„æŒ‡å— | Baeldungä¸­æ–‡ç½‘</a><p>ç›¸å…³æ–‡æ¡£<ul><li><a href=https://docs.spring.io/spring-boot/appendix/application-properties/index.html rel=noopener target=_blank>Common Application Properties :: Spring Boot</a><li><a href=https://docs.spring.io/spring-boot/docs/2.0.x/reference/html/common-application-properties.html rel=noopener target=_blank>Appendix A. Common application properties</a></ul><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line><span class=comment># åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£</span></span><br><span class=line><span class=meta>server.port</span>=<span class=string>7090</span></span><br><span class=line><span class=meta>server.servlet.context-path</span>=<span class=string>/api</span></span><br><span class=line><span class=comment>#sessionè¿‡æœŸæ—¶é—´ 60M ä¸€ä¸ªå°æ—¶</span></span><br><span class=line><span class=meta>server.servlet.session.timeout</span>=<span class=string>PT60M</span></span><br><span class=line><span class=comment>#å¤„ç†favicon</span></span><br><span class=line><span class=comment>#spring.mvc.favicon.enable=false</span></span><br><span class=line><span class=comment>#å¼‚å¸¸å¤„ç†</span></span><br><span class=line><span class=comment>#spring.mvc.throw-exception-if-no-handler-found=true</span></span><br><span class=line><span class=meta>spring.web.resources.add-mappings</span>=<span class=string>false</span></span><br><span class=line><span class=comment>#æ•°æ®åº“é…ç½®</span></span><br><span class=line><span class=meta>spring.datasource.url</span>=<span class=string>jdbc:mysql://127.0.0.1:3306/easypan?serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8&autoReconnect=true&allowMultiQueries=true</span></span><br><span class=line><span class=meta>spring.datasource.username</span>=<span class=string>root</span></span><br><span class=line><span class=meta>spring.datasource.password</span>=<span class=string>root</span></span><br><span class=line><span class=meta>spring.datasource.driver-class-name</span>=<span class=string>com.mysql.cj.jdbc.Driver</span></span><br><span class=line><span class=meta>spring.datasource.hikari.pool-name</span>=<span class=string>HikariCPDatasource</span></span><br><span class=line><span class=meta>spring.datasource.hikari.minimum-idle</span>=<span class=string>5</span></span><br><span class=line><span class=meta>spring.datasource.hikari.idle-timeout</span>=<span class=string>180000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.maximum-pool-size</span>=<span class=string>10</span></span><br><span class=line><span class=meta>spring.datasource.hikari.auto-commit</span>=<span class=string>true</span></span><br><span class=line><span class=meta>spring.datasource.hikari.max-lifetime</span>=<span class=string>1800000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.connection-timeout</span>=<span class=string>30000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.connection-test-query</span>=<span class=string>SELECT 1</span></span><br><span class=line><span class=comment>#å‘é€é‚®ä»¶é…ç½®ç›¸å…³</span></span><br><span class=line><span class=comment># é…ç½®é‚®ä»¶æœåŠ¡å™¨çš„åœ°å€ smtp.qq.com</span></span><br><span class=line><span class=meta>spring.mail.host</span>=<span class=string>smtp.qq.com</span></span><br><span class=line><span class=comment># é…ç½®é‚®ä»¶æœåŠ¡å™¨çš„ç«¯å£ï¼ˆ465æˆ–587ï¼‰</span></span><br><span class=line><span class=meta>spring.mail.port</span>=<span class=string>465</span></span><br><span class=line><span class=comment># é…ç½®ç”¨æˆ·çš„è´¦å·</span></span><br><span class=line><span class=meta>spring.mail.username</span>=<span class=string>test@qq.com</span></span><br><span class=line><span class=comment># é…ç½®ç”¨æˆ·çš„å¯†ç </span></span><br><span class=line><span class=meta>spring.mail.password</span>=<span class=string>123456</span></span><br><span class=line><span class=comment># é…ç½®é»˜è®¤ç¼–ç </span></span><br><span class=line><span class=meta>spring.mail.default-encoding</span>=<span class=string>UTF-8</span></span><br><span class=line><span class=comment># SSL è¿æ¥é…ç½®</span></span><br><span class=line><span class=meta>spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class=string>javax.net.ssl.SSLSocketFactory</span></span><br><span class=line><span class=comment># å¼€å¯ debugï¼Œè¿™æ ·æ–¹ä¾¿å¼€å‘è€…æŸ¥çœ‹é‚®ä»¶å‘é€æ—¥å¿—</span></span><br><span class=line><span class=meta>spring.mail.properties.mail.debug</span>=<span class=string>true</span></span><br><span class=line><span class=comment>#é‚®ä»¶é…ç½®ç»“æŸ</span></span><br><span class=line><span class=comment>#Spring redisé…ç½®</span></span><br><span class=line><span class=comment># Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰</span></span><br><span class=line><span class=meta>spring.data.redis.database</span>=<span class=string>0</span></span><br><span class=line><span class=meta>spring.data.redis.host</span>=<span class=string>127.0.0.1</span></span><br><span class=line><span class=meta>spring.data.redis.port</span>=<span class=string>6379</span></span><br><span class=line><span class=comment># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-active</span>=<span class=string>8</span></span><br><span class=line><span class=comment># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-wait</span>=<span class=string>-1</span></span><br><span class=line><span class=comment># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-idle</span>=<span class=string>10</span></span><br><span class=line><span class=comment># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.min-idle</span>=<span class=string>0</span></span><br><span class=line><span class=comment># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class=line><span class=meta>spring.data.redis.timeout</span>=<span class=string>2000</span></span><br></pre></table></figure><h3 id=ä¸šåŠ¡é‡ç‚¹æµç¨‹><a class=headerlink href=#ä¸šåŠ¡é‡ç‚¹æµç¨‹ title=ä¸šåŠ¡é‡ç‚¹æµç¨‹></a>ä¸šåŠ¡é‡ç‚¹æµç¨‹</h3><h2 id=æ–‡ä»¶ç®¡ç†><a class=headerlink href=#æ–‡ä»¶ç®¡ç† title=æ–‡ä»¶ç®¡ç†></a>æ–‡ä»¶ç®¡ç†</h2><h3 id=æŸ¥çœ‹æ–‡ä»¶><a class=headerlink href=#æŸ¥çœ‹æ–‡ä»¶ title=æŸ¥çœ‹æ–‡ä»¶></a>æŸ¥çœ‹æ–‡ä»¶</h3><h3 id=æ–‡ä»¶ä¸Šä¼ ><a class=headerlink href=#æ–‡ä»¶ä¸Šä¼  title=æ–‡ä»¶ä¸Šä¼ ></a>æ–‡ä»¶ä¸Šä¼ </h3><p><img alt=image-20250722174319746 data-src=https://s2.loli.net/2025/07/22/Udzg4jYavtVsL3Z.png><p>è¡¨ä¸­(file_id,user_id)ä¸ºè”åˆä¸»é”®. controllerå‚æ•°åŒ…å«fileId,file,fileName,filePid,fileMd5,chunkIndex,chunks.<p>å½“åˆšå¼€å§‹ä¸Šä¼ æ—¶,chunkIndex=0,æŸ¥çœ‹filemd5æ˜¯å¦åŒ…å«è¿™ä¸ªæ–‡ä»¶,å¹¶ä¸”å½“å‰ç©ºé—²ç©ºé—´+æ–‡ä»¶ç©ºé—´å¤§äºæ€»ç©ºé—´,å¦‚æœæŸ¥åˆ°äº†,åˆ™ç›´æ¥ä¸Šä¼ ,å¦‚æœæ–‡ä»¶åé‡å¤,é‡å‘½å,æ’å…¥æ•°æ®åº“(file_idå’Œæ–‡ä»¶åå¯èƒ½ä¸åŒ,è¿˜éœ€è¦åœ¨æ•°æ®åº“ä¸­æ’å…¥)<p>ç„¶åæ›´æ–°ä½¿ç”¨ç©ºé—´,ç„¶åè¿”å›ç§’ä¼ å“åº”å³å¯.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=comment>// chunkIndex=0ä¸‹</span></span><br><span class=line>FileInfoQuery infoQuery = <span class=keyword>new</span> FileInfoQuery();</span><br><span class=line>infoQuery.setFileMd5(fileMd5);</span><br><span class=line>infoQuery.setSimplePage(<span class=keyword>new</span> SimplePage(<span class=number>0</span>, <span class=number>1</span>));</span><br><span class=line>infoQuery.setStatus(FileStatusEnums.USING.getStatus());</span><br><span class=line>List&LTFileInfo> dbFileList = <span class=keyword>this</span>.fileInfoMapper.selectList(infoQuery);</span><br><span class=line><span class=comment>//ç§’ä¼ </span></span><br><span class=line><span class=keyword>if</span> (!dbFileList.isEmpty()) {</span><br><span class=line>    FileInfo dbFile = dbFileList.get(<span class=number>0</span>);</span><br><span class=line>    <span class=comment>//åˆ¤æ–­æ–‡ä»¶çŠ¶æ€</span></span><br><span class=line>    <span class=keyword>if</span> (dbFile.getFileSize() + spaceDto.getUseSpace() > spaceDto.getTotalSpace()) {</span><br><span class=line>        <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_904);</span><br><span class=line>    }</span><br><span class=line>    dbFile.setFileId(fileId);</span><br><span class=line>    dbFile.setFilePid(filePid);</span><br><span class=line>    dbFile.setUserId(webUserDto.getUserId());</span><br><span class=line>    dbFile.setFileMd5(<span class=keyword>null</span>);</span><br><span class=line>    dbFile.setCreateTime(curDate);</span><br><span class=line>    dbFile.setLastUpdateTime(curDate);</span><br><span class=line>    dbFile.setStatus(FileStatusEnums.USING.getStatus());</span><br><span class=line>    dbFile.setDelFlag(FileDelFlagEnums.USING.getFlag());</span><br><span class=line>    dbFile.setFileMd5(fileMd5);</span><br><span class=line>    fileName = autoRename(filePid, webUserDto.getUserId(), fileName);</span><br><span class=line>    dbFile.setFileName(fileName);</span><br><span class=line>    <span class=keyword>this</span>.fileInfoMapper.insert(dbFile);</span><br><span class=line>    resultDto.setStatus(UploadStatusEnums.UPLOAD_SECONDS.getCode());</span><br><span class=line>    <span class=comment>//æ›´æ–°ç”¨æˆ·ç©ºé—´ä½¿ç”¨</span></span><br><span class=line>    updateUserSpace(webUserDto, dbFile.getFileSize());</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> resultDto;</span><br><span class=line>}</span><br></pre></table></figure><p>ç„¶åè·å–è¿™ä¸ªåˆ‡ç‰‡å½“å‰å ç”¨å­˜å‚¨,å¦‚æœå¤§äºæ€»ç©ºé—´å°±æŠ¥å¼‚å¸¸.<p>ç„¶åç¡®å®šä¸‹è½½çš„chunkè·¯å¾„,BASE_FOLDER+FILE+user_id_file_id+chunkIndex,ç„¶åä¸‹è½½åˆ°å¯¹åº”ä½ç½®,å¢åŠ å ç”¨çš„ä¸´æ—¶å­˜å‚¨ç©ºé—´.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=comment>//æš‚å­˜åœ¨ä¸´æ—¶ç›®å½•</span></span><br><span class=line>String tempFolderName = appConfig.getProjectFolder() + Constants.FILE_FOLDER_TEMP;</span><br><span class=line>String currentUserFolderName = webUserDto.getUserId() + fileId;</span><br><span class=line><span class=comment>//åˆ›å»ºä¸´æ—¶ç›®å½•</span></span><br><span class=line>tempFileFolder = <span class=keyword>new</span> File(tempFolderName + currentUserFolderName);</span><br><span class=line><span class=keyword>if</span> (!tempFileFolder.exists()) {</span><br><span class=line>    tempFileFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>//åˆ¤æ–­ç£ç›˜ç©ºé—´</span></span><br><span class=line>Long currentTempSize = redisComponent.getFileTempSize(webUserDto.getUserId(), fileId);</span><br><span class=line><span class=keyword>if</span> (file.getSize() + currentTempSize + spaceDto.getUseSpace() > spaceDto.getTotalSpace()) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_904);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>File newFile = <span class=keyword>new</span> File(tempFileFolder.getPath() + <span class=string>"/"</span> + chunkIndex);</span><br><span class=line>file.transferTo(newFile);</span><br><span class=line><span class=comment>//ä¿å­˜ä¸´æ—¶å¤§å°</span></span><br><span class=line>redisComponent.saveFileTempSize(webUserDto.getUserId(), fileId, file.getSize());</span><br><span class=line><span class=comment>//ä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼Œç›´æ¥è¿”å›</span></span><br><span class=line><span class=keyword>if</span> (chunkIndex < chunks - <span class=number>1</span>) {</span><br><span class=line>    resultDto.setStatus(UploadStatusEnums.UPLOADING.getCode());</span><br><span class=line>    <span class=keyword>return</span> resultDto;</span><br><span class=line>}</span><br></pre></table></figure><p>å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡,ç›´æ¥è¿”å›,å“åº”è®¾ç½®ä¸Šä¼ çŠ¶æ€.<p>å½“ä¸Šä¼ å®Œæœ€åä¸€ä¸ªæ–‡ä»¶åˆ†ç‰‡æ—¶,è¡¨ç¤ºä¸Šä¼ å®Œæˆ,å°†ç›¸å…³æ–‡ä»¶ä¿¡æ¯æ’å…¥æ•°æ®åº“,æ–‡ä»¶çŠ¶æ€è®¾ç½®ä¸ºTRANSFER. ä¹Ÿåšäº†ç¼©ç•¥å›¾å¤„ç†,å¦‚æœæ˜¯è§†é¢‘,ç”Ÿæˆç¼©ç•¥å›¾(ä½¿ç”¨ffmepg String cmd = â€œffmpeg -i %s -y -vframes 1 -vf scale=%d:%d/a %sâ€;),å¦‚æœæ˜¯å›¾ç‰‡,ä¹Ÿå¯ä»¥å‹ç¼©å¾—åˆ°ç¼©ç•¥å›¾String cmd = â€œffmpeg -i %s -vf scale=%d:-1 %s -yâ€; æ­¤å¤–,è§†é¢‘ä¼šè¿›è¡Œåˆ‡å‰²,å¾—åˆ°ä¸åŒçš„tsç‰‡æ®µå’Œm3u8ç´¢å¼•æ–‡ä»¶. å¦‚æœæ˜¯h.265è½¬ä¸ºh.264,h.264è½¬æˆts,ç„¶åè¿›è¡Œåˆ‡ç‰‡å¾—åˆ°tsæ–‡ä»¶ä¸m3u8ç´¢å¼•æ–‡ä»¶.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=comment>//åˆ›å»ºåŒååˆ‡ç‰‡ç›®å½•</span></span><br><span class=line>File tsFolder = <span class=keyword>new</span> File(videoFilePath.substring(<span class=number>0</span>, videoFilePath.lastIndexOf(<span class=string>"."</span>)));</span><br><span class=line><span class=keyword>if</span> (!tsFolder.exists()) {</span><br><span class=line>    tsFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>final</span> String CMD_GET_CODE = <span class=string>"ffprobe -v error -select_streams v:0 -show_entries stream=codec_name %s"</span>;</span><br><span class=line>String cmd = String.format(CMD_GET_CODE, videoFilePath);</span><br><span class=line>String result = ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line>result = result.replace(<span class=string>"\n"</span>, <span class=string>""</span>);</span><br><span class=line>result = result.substring(result.indexOf(<span class=string>"="</span>) + <span class=number>1</span>);</span><br><span class=line>String codec = result.substring(<span class=number>0</span>, result.indexOf(<span class=string>"["</span>));</span><br><span class=line></span><br><span class=line><span class=comment>//è½¬ç </span></span><br><span class=line><span class=keyword>if</span> (<span class=string>"hevc"</span>.equals(codec)) {</span><br><span class=line>    String newFileName = videoFilePath.substring(<span class=number>0</span>, videoFilePath.lastIndexOf(<span class=string>"."</span>)) + <span class=string>"_"</span> + videoFilePath.substring(videoFilePath.lastIndexOf(<span class=string>"."</span>));</span><br><span class=line>    <span class=keyword>new</span> File(videoFilePath).renameTo(<span class=keyword>new</span> File(newFileName));</span><br><span class=line>    String CMD_HEVC_264 = <span class=string>"ffmpeg -i %s -c:v libx264 -crf 20 %s"</span>;</span><br><span class=line>    cmd = String.format(CMD_HEVC_264, newFileName, videoFilePath);</span><br><span class=line>    ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line>    <span class=keyword>new</span> File(newFileName).delete();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>final</span> String CMD_TRANSFER_2TS = <span class=string>"ffmpeg -y -i %s  -vcodec copy -acodec copy -bsf:v h264_mp4toannexb %s"</span>;</span><br><span class=line><span class=keyword>final</span> String CMD_CUT_TS = <span class=string>"ffmpeg -i %s -c copy -map 0 -f segment -segment_list %s -segment_time 30 %s/%s_%%4d.ts"</span>;</span><br><span class=line></span><br><span class=line>String tsPath = tsFolder + <span class=string>"/"</span> + Constants.TS_NAME;</span><br><span class=line><span class=comment>//ç”Ÿæˆ.ts</span></span><br><span class=line>cmd = String.format(CMD_TRANSFER_2TS, videoFilePath, tsPath);</span><br><span class=line>ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line><span class=comment>//ç”Ÿæˆç´¢å¼•æ–‡ä»¶.m3u8 å’Œåˆ‡ç‰‡.ts</span></span><br><span class=line>cmd = String.format(CMD_CUT_TS, tsPath, tsFolder.getPath() + <span class=string>"/"</span> + Constants.M3U8_NAME, tsFolder.getPath(), fileId);</span><br><span class=line>ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line><span class=comment>//åˆ é™¤index.ts</span></span><br><span class=line><span class=keyword>new</span> File(tsPath).delete();</span><br></pre></table></figure><p>åŒæ—¶å¼‚æ­¥è¿›è¡Œæ–‡ä»¶åˆå¹¶,æ–‡ä»¶åˆå¹¶å°±æ˜¯å°†chunkså†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­.åŒæ—¶æ›´æ–°æ•°æ®åº“ä¸­æ–‡ä»¶çŠ¶æ€.<p>åœ¨äº‹åŠ¡æäº¤ä¹‹åè°ƒç”¨åˆå¹¶,æˆªå–å°é¢ä»¥åŠè§†é¢‘ç¼–ç ç­‰ä¸šåŠ¡.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment>//äº‹åŠ¡æäº¤åè°ƒç”¨å¼‚æ­¥æ–¹æ³•</span></span><br><span class=line>TransactionSynchronizationManager.registerSynchronization(<span class=keyword>new</span> TransactionSynchronization() {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCommit</span><span class=params>()</span> </span>{</span><br><span class=line>        fileInfoService.transferFile(fileInfo.getFileId(), webUserDto);</span><br><span class=line>    }</span><br><span class=line>});</span><br></pre></table></figure><h3 id=æ–‡ä»¶é¢„è§ˆ><a class=headerlink href=#æ–‡ä»¶é¢„è§ˆ title=æ–‡ä»¶é¢„è§ˆ></a>æ–‡ä»¶é¢„è§ˆ</h3><h4 id=æ™®é€šæ–‡ä»¶é¢„è§ˆ><a class=headerlink href=#æ™®é€šæ–‡ä»¶é¢„è§ˆ title=æ™®é€šæ–‡ä»¶é¢„è§ˆ></a>æ™®é€šæ–‡ä»¶é¢„è§ˆ</h4><h4 id=ç¼©ç•¥å›¾é¢„è§ˆ><a class=headerlink href=#ç¼©ç•¥å›¾é¢„è§ˆ title=ç¼©ç•¥å›¾é¢„è§ˆ></a>ç¼©ç•¥å›¾é¢„è§ˆ</h4><h4 id=è§†é¢‘é¢„è§ˆ><a class=headerlink href=#è§†é¢‘é¢„è§ˆ title=è§†é¢‘é¢„è§ˆ></a>è§†é¢‘é¢„è§ˆ</h4><p>è¿”å›m3u8ç´¢å¼•æ–‡ä»¶ä»¥åŠtsæ–‡ä»¶,<p>å¦‚æœæ˜¯ä¸‹è½½tsæ–‡ä»¶,ä¸ºäº†é¿å…ä¸‹è½½å•ä¸ªæ–‡ä»¶è¿‡å¤§æˆ–è€…è¯´è¿›è¡Œæ’­æ”¾æ—¶éœ€è¦åˆ†ç‰‡æ’­æ”¾,å¯ä»¥é€šè¿‡åœ¨è¯·æ±‚å¤´æºå¸¦range<p>è€Œå“åº”å¤´æºå¸¦<p><code>206</code> å“åº”é€šå¸¸ä¼´éšçš„å¤´éƒ¨ï¼š<p>å½“æœåŠ¡å™¨è¿”å› <code>206 Partial Content</code> çŠ¶æ€ç æ—¶ï¼Œé€šå¸¸ä¼šåŒæ—¶è®¾ç½®ä»¥ä¸‹å“åº”å¤´ï¼š<ol><li><p><strong><code>Content-Range</code></strong>:</p> <ul><li><strong>ä½œç”¨ï¼š</strong> è¿™æ˜¯æœ€é‡è¦çš„å¤´ï¼Œå®ƒæ˜ç¡®å‘ŠçŸ¥å®¢æˆ·ç«¯å½“å‰å“åº”ä½“ä¸­åŒ…å«çš„æ˜¯<strong>æ•´ä¸ªèµ„æºçš„å“ªä¸€éƒ¨åˆ†</strong>ï¼Œä»¥åŠ<strong>æ•´ä¸ªèµ„æºçš„æ€»å¤§å°</strong>ã€‚<li><strong>æ ¼å¼ï¼š</strong> <code>Content-Range: bytes &LTstart>-&LTend>/&LTtotal_length></code><li><strong>ç¤ºä¾‹ï¼š</strong> <code>Content-Range: bytes 1024-2047/2048</code> è¡¨ç¤ºå“åº”ä½“ä¸­æ˜¯æ–‡ä»¶çš„ç¬¬ 1024 å­—èŠ‚åˆ°ç¬¬ 2047 å­—èŠ‚ï¼Œæ•´ä¸ªæ–‡ä»¶æ€»å¤§å°æ˜¯ 2048 å­—èŠ‚ã€‚</ul><li><p><strong><code>Content-Length</code></strong>:</p> <ul><li><strong>ä½œç”¨ï¼š</strong> è¡¨ç¤º<strong>å½“å‰å“åº”ä½“ä¸­å®é™…ä¼ è¾“çš„å­—èŠ‚æ•°</strong>ï¼ˆå³ <code>end - start + 1</code>ï¼‰ã€‚<li><strong>ç¤ºä¾‹ï¼š</strong> å¦‚æœ <code>Content-Range</code> æ˜¯ <code>bytes 1024-2047/2048</code>ï¼Œé‚£ä¹ˆ <code>Content-Length</code> åº”è¯¥æ˜¯ <code>1024</code>ã€‚</ul><li><p><strong><code>Content-Type</code></strong>:</p> <ul><li><strong>ä½œç”¨ï¼š</strong> ä»ç„¶éœ€è¦æŒ‡ç¤ºå“åº”ä½“ä¸­å†…å®¹çš„åª’ä½“ç±»å‹ï¼ˆMIME typeï¼‰ï¼Œå³ä½¿æ˜¯éƒ¨åˆ†å†…å®¹ã€‚</ul><li><p><strong><code>Accept-Ranges</code></strong>:</p> <ul><li><strong>ä½œç”¨ï¼š</strong> é€šå¸¸åœ¨ç¬¬ä¸€æ¬¡ï¼ˆå®Œæ•´ï¼‰è¯·æ±‚æ—¶å°±è®¾ç½® <code>Accept-Ranges: bytes</code>ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æœåŠ¡å™¨æ”¯æŒèŒƒå›´è¯·æ±‚ã€‚å¦‚æœæœåŠ¡å™¨è¿”å› <code>206</code> çŠ¶æ€ç ï¼Œè¿™æ„å‘³ç€å®ƒè‚¯å®šæ”¯æŒ <code>bytes</code> èŒƒå›´ã€‚</ul> <hr> <p>åˆ†ç‰‡ä¸‹è½½ï¼Œä¹Ÿç§°ä¸º<strong>æ–­ç‚¹ç»­ä¼ ï¼ˆResumable Downloadï¼‰æˆ–èŒƒå›´è¯·æ±‚ï¼ˆRange Requestï¼‰</strong>ï¼Œæ˜¯ HTTP åè®®å…è®¸å®¢æˆ·ç«¯åªè¯·æ±‚èµ„æºçš„éƒ¨åˆ†å†…å®¹çš„ä¸€ç§æœºåˆ¶ã€‚å½“å®¢æˆ·ç«¯éœ€è¦è¿›è¡Œåˆ†ç‰‡ä¸‹è½½æ—¶ï¼Œå®ƒä¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ç‰¹å®šçš„ä¿¡æ¯æ¥å‘Šè¯‰æœåŠ¡å™¨å®ƒæƒ³è¦å“ªäº›éƒ¨åˆ†çš„æ•°æ®ã€‚</p> <h5 id=åˆ†ç‰‡ä¸‹è½½æ—¶å®¢æˆ·ç«¯è¯·æ±‚å¤´æºå¸¦çš„å…³é”®ä¿¡æ¯><a class=headerlink href=#åˆ†ç‰‡ä¸‹è½½æ—¶å®¢æˆ·ç«¯è¯·æ±‚å¤´æºå¸¦çš„å…³é”®ä¿¡æ¯ title=åˆ†ç‰‡ä¸‹è½½æ—¶å®¢æˆ·ç«¯è¯·æ±‚å¤´æºå¸¦çš„å…³é”®ä¿¡æ¯></a>åˆ†ç‰‡ä¸‹è½½æ—¶å®¢æˆ·ç«¯è¯·æ±‚å¤´æºå¸¦çš„å…³é”®ä¿¡æ¯</h5><p>åœ¨åˆ†ç‰‡ä¸‹è½½åœºæ™¯ä¸­ï¼Œå®¢æˆ·ç«¯çš„ HTTP è¯·æ±‚å¤´ä¸»è¦ä¼šæºå¸¦ä»¥ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªå…³é”®ä¿¡æ¯ï¼š</p> <p><code>Range</code> è¯·æ±‚å¤´</p> <p>è¿™æ˜¯è¿›è¡Œåˆ†ç‰‡ä¸‹è½½<strong>æœ€æ ¸å¿ƒã€æœ€é‡è¦</strong>çš„è¯·æ±‚å¤´ã€‚å®ƒæ˜ç¡®å‘Šè¯‰æœåŠ¡å™¨å®¢æˆ·ç«¯æƒ³è¦è·å–èµ„æºå†…å®¹çš„å“ªä¸€éƒ¨åˆ†ã€‚</p> <ul><li><p><strong>ä½œç”¨ï¼š</strong> æŒ‡ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯æ–‡ä»¶çš„ç‰¹å®šå­—èŠ‚èŒƒå›´ã€‚</p><li><p><strong>æ ¼å¼ï¼š</strong> <code>Range: bytes=&LTstart>-&LTend></code></p> <ul><li><code>&LTstart></code>: æƒ³è¦è·å–çš„èµ·å§‹å­—èŠ‚åç§»é‡ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰ã€‚<li><code>&LTend></code>: æƒ³è¦è·å–çš„ç»“æŸå­—èŠ‚åç§»é‡ã€‚</ul><li><p><strong>å¸¸ç”¨å˜ä½“ï¼š</strong></p> <ul><li><strong>è¯·æ±‚ä»æŸä¸ªå­—èŠ‚åˆ°æ–‡ä»¶æœ«å°¾ï¼š</strong> <code>Range: bytes=1024-</code><ul><li>è¿™è¡¨ç¤ºå®¢æˆ·ç«¯æƒ³è¦ä»æ–‡ä»¶çš„ç¬¬ 1024 å­—èŠ‚å¼€å§‹ï¼Œä¸€ç›´åˆ°æ–‡ä»¶æœ«å°¾çš„æ‰€æœ‰å†…å®¹ã€‚</ul><li><strong>è¯·æ±‚æ–‡ä»¶çš„æœ€å N ä¸ªå­—èŠ‚ï¼š</strong> <code>Range: bytes=-500</code><ul><li>è¿™è¡¨ç¤ºå®¢æˆ·ç«¯æƒ³è¦æ–‡ä»¶çš„æœ€å 500 ä¸ªå­—èŠ‚ã€‚</ul><li><strong>è¯·æ±‚å¤šä¸ªä¸è¿ç»­çš„èŒƒå›´ï¼š</strong> <code>Range: bytes=0-100, 200-300</code> (æœåŠ¡å™¨ä¸ä¸€å®šæ”¯æŒï¼Œä½† HTTP è§„èŒƒå…è®¸)<ul><li>è¿™è¡¨ç¤ºå®¢æˆ·ç«¯æƒ³è¦ç¬¬ 0-100 å­—èŠ‚å’Œç¬¬ 200-300 å­—èŠ‚ã€‚</ul></ul><li><p><strong>ç¤ºä¾‹ï¼š</strong></p> <figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>GET</span> <span class=string>/path/to/large_file.zip</span> <span class=meta>HTTP/1.1</span></span><br><span class=line><span class=attribute>Host</span><span class=punctuation>: </span>example.com</span><br><span class=line><span class=attribute>Range</span><span class=punctuation>: </span>bytes=5242880-10485759  # è¯·æ±‚æ–‡ä»¶çš„ç¬¬ 5MB åˆ° ç¬¬ 10MB éƒ¨åˆ†</span><br></pre></table></figure></ul> <p><code>If-Range</code> è¯·æ±‚å¤´ (ç”¨äºæ¡ä»¶èŒƒå›´è¯·æ±‚)</p> <p>è¿™ä¸ªè¯·æ±‚å¤´é€šå¸¸ä¸ <code>Range</code> ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å®ç°<strong>æ¡ä»¶æ€§æ–­ç‚¹ç»­ä¼ </strong>ã€‚å®ƒå…è®¸å®¢æˆ·ç«¯åœ¨è¯·æ±‚ç‰¹å®šèŒƒå›´ä¹‹å‰ï¼Œå…ˆéªŒè¯èµ„æºæ˜¯å¦åœ¨ä¸Šæ¬¡ä¸‹è½½åè¢«ä¿®æ”¹è¿‡ã€‚</p> <ul><li><p><strong>ä½œç”¨ï¼š</strong> å¦‚æœæœåŠ¡å™¨ä¸Šèµ„æºçš„ <code>ETag</code> æˆ– <code>Last-Modified</code> æ—¥æœŸä¸ <code>If-Range</code> ä¸­çš„å€¼åŒ¹é…ï¼ŒæœåŠ¡å™¨æ‰ä¼šè¿”å›è¯·æ±‚çš„èŒƒå›´å†…å®¹ï¼ˆ<code>206 Partial Content</code>ï¼‰ã€‚å¦åˆ™ï¼ŒæœåŠ¡å™¨ä¼šå¿½ç•¥ <code>Range</code> å¤´ï¼Œå¹¶è¿”å›æ•´ä¸ªæ–‡ä»¶ï¼ˆ<code>200 OK</code>ï¼‰ï¼Œå› ä¸ºèµ„æºå·²ç»è¢«ä¿®æ”¹ï¼Œéƒ¨åˆ†å†…å®¹å¯èƒ½å·²ç»ä¸å†æœ‰æ•ˆã€‚</p><li><p><strong>æ ¼å¼ï¼š</strong></p> <ul><li><code>If-Range: "&LTETag_value>"</code> (ä½¿ç”¨èµ„æºçš„ ETag)<li><code>If-Range: &LTHTTP-date></code> (ä½¿ç”¨èµ„æºçš„ Last-Modified æ—¥æœŸ)</ul><li><p><strong>ç¤ºä¾‹ï¼š</strong></p> <figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>GET</span> <span class=string>/path/to/large_file.zip</span> <span class=meta>HTTP/1.1</span></span><br><span class=line><span class=attribute>Host</span><span class=punctuation>: </span>example.com</span><br><span class=line><span class=attribute>Range</span><span class=punctuation>: </span>bytes=5242880-         # å®¢æˆ·ç«¯è¯·æ±‚ç»­ä¼ </span><br><span class=line><span class=attribute>If-Range</span><span class=punctuation>: </span>"abcdef1234567890"  # å¦‚æœèµ„æºçš„ETagä¸æ­¤åŒ¹é…ï¼Œåˆ™ç»§ç»­ä¼ è¾“èŒƒå›´å†…å®¹</span><br></pre></table></figure> <ul><li>å¦‚æœæœåŠ¡å™¨å‘ç°æ–‡ä»¶çš„ ETag å˜äº†ï¼Œè¯´æ˜æ–‡ä»¶è¢«ä¿®æ”¹äº†ï¼Œå®ƒä¼šè¿”å›æ•´ä¸ªæ–‡ä»¶ï¼ˆ<code>200 OK</code>ï¼‰ã€‚<li>å¦‚æœ ETag æ²¡å˜ï¼ŒæœåŠ¡å™¨å°±ä¼šè¿”å›è¯·æ±‚çš„èŒƒå›´å†…å®¹ï¼ˆ<code>206 Partial Content</code>ï¼‰ã€‚</ul></ul></ol><p>é‡è¦å“åº”çŠ¶æ€ç :206 éƒ¨åˆ†å†…å®¹ 301 æ°¸ä¹…é‡å®šå‘ 302 æš‚æ—¶é‡å®šå‘<h3 id=ç›®å½•ç›¸å…³><a class=headerlink href=#ç›®å½•ç›¸å…³ title=ç›®å½•ç›¸å…³></a>ç›®å½•ç›¸å…³</h3><h4 id=åˆ›å»ºç›®å½•><a class=headerlink href=#åˆ›å»ºç›®å½• title=åˆ›å»ºç›®å½•></a>åˆ›å»ºç›®å½•</h4><h4 id=è·å–ç›®å½•è·¯å¾„><a class=headerlink href=#è·å–ç›®å½•è·¯å¾„ title=è·å–ç›®å½•è·¯å¾„></a>è·å–ç›®å½•è·¯å¾„</h4><h4 id=æ–‡ä»¶é‡å‘½å><a class=headerlink href=#æ–‡ä»¶é‡å‘½å title=æ–‡ä»¶é‡å‘½å></a>æ–‡ä»¶é‡å‘½å</h4><h4 id=ç§»åŠ¨æ–‡ä»¶><a class=headerlink href=#ç§»åŠ¨æ–‡ä»¶ title=ç§»åŠ¨æ–‡ä»¶></a>ç§»åŠ¨æ–‡ä»¶</h4><h4 id=åˆ é™¤æ–‡ä»¶><a class=headerlink href=#åˆ é™¤æ–‡ä»¶ title=åˆ é™¤æ–‡ä»¶></a>åˆ é™¤æ–‡ä»¶</h4><h3 id=å›æ”¶ç«™å›æ”¶ã€è¿˜åŸä»¥åŠå½»åº•åˆ é™¤æ–‡ä»¶><a class=headerlink href=#å›æ”¶ç«™å›æ”¶ã€è¿˜åŸä»¥åŠå½»åº•åˆ é™¤æ–‡ä»¶ title=å›æ”¶ç«™å›æ”¶ã€è¿˜åŸä»¥åŠå½»åº•åˆ é™¤æ–‡ä»¶></a>å›æ”¶ç«™å›æ”¶ã€è¿˜åŸä»¥åŠå½»åº•åˆ é™¤æ–‡ä»¶</h3><h3 id=å¤–éƒ¨åˆ†äº«æ–‡ä»¶><a class=headerlink href=#å¤–éƒ¨åˆ†äº«æ–‡ä»¶ title=å¤–éƒ¨åˆ†äº«æ–‡ä»¶></a>å¤–éƒ¨åˆ†äº«æ–‡ä»¶</h3><h1 id=EasyLive><a class=headerlink href=#EasyLive title=EasyLive></a>EasyLive</h1><h3 id=å‚è€ƒåšä¸»><a class=headerlink href=#å‚è€ƒåšä¸» title=å‚è€ƒåšä¸»></a>å‚è€ƒåšä¸»</h3><p><a href=https://space.bilibili.com/499388891 rel=noopener target=_blank>ç¨‹åºå‘˜è€ç½—çš„ä¸ªäººç©ºé—´-ç¨‹åºå‘˜è€ç½—ä¸ªäººä¸»é¡µ-å“”å“©å“”å“©è§†é¢‘</a></p><link href=/css/spoiler.css rel=stylesheet><script async src=/js/spoiler.js></script></div><div><div><div style="text-align:center;color: #ccc;font-size:14px;">-------------æœ¬æ–‡ç»“æŸ<i class="fa fa-paw"></i>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------</div></div></div><div class=reward-container><div>æ„Ÿè°¢é˜…è¯».</div><button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">æ‰“èµ</button><div style="display: none;" id=qr><div style="display: inline-block;"><img alt="Sekyoro å¾®ä¿¡æ”¯ä»˜" src=/images/wechatpay.png><p>å¾®ä¿¡æ”¯ä»˜</div></div></div><div><ul class=post-copyright><li class=post-copyright-author><strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Sekyoro<li class=post-copyright-link><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ title=Javaé¡¹ç›®å¤§èµ(å®ä¹ ç‰ˆ)>https://www.sekyoro.top/2025/03/20/Javaé¡¹ç›®å¤§èµ-å®ä¹ ç‰ˆ/</a><li class=post-copyright-license><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</ul></div><div class=followme><p>æ¬¢è¿å…³æ³¨æˆ‘çš„å…¶å®ƒå‘å¸ƒæ¸ é“<div class=social-list><div class=social-item><a class=social-link href=/images/wxqrcode.png target=_blank> <span class=icon> <i class="fab fa-weixin"></i> </span> <span class=label>WeChat</span> </a></div><div class=social-item><a class=social-link href=/images/website.png target=_blank> <span class=icon> <i class="fa fa-user"></i> </span> <span class=label>PersonalWebsite</span> </a></div><div class=social-item><a class=social-link href=https://my-astro-git-main-drowning-in-codes.vercel.app target=_blank> <span class=icon> <i class="fas fa-share"></i> </span> <span class=label>æ‚é±¼åˆ†äº«</span> </a></div><div class=social-item><a class=social-link href=/atom.xml target=_blank> <span class=icon> <i class="fa fa-rss"></i> </span> <span class=label>RSS</span> </a></div></div></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i> Java</a></div><div class=post-nav><div class=post-nav-item><a href=/2025/03/12/TCP-IP%E4%B8%8EHTTP%E7%BC%96%E7%A8%8B/ rel=prev title=TCP/IPä¸HTTPç¼–ç¨‹> <i class="fa fa-chevron-left"></i> TCP/IPä¸HTTPç¼–ç¨‹ </a></div><div class=post-nav-item><a href=/2025/03/20/TinyHttpServer%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/ rel=next title=TinyWebServeré¡¹ç›®å­¦ä¹ > TinyWebServeré¡¹ç›®å­¦ä¹  <i class="fa fa-chevron-right"></i> </a></div></div></footer></article></div><!-- è¯„è®ºåŒº --><div class=comments><div data-id=city data-uid=MTAyMC81MzE5Ny8yOTY3Mg== id=lv-container></div></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><!-- canvasç²’å­æ—¶é’Ÿ --><div><canvas id=canvas style=width:60%;>å½“å‰æµè§ˆå™¨ä¸æ”¯æŒcanvasï¼Œè¯·æ›´æ¢æµè§ˆå™¨åå†è¯•</canvas></div><script>(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //å£°æ˜canvasçš„å®½é«˜
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //å­˜å‚¨æ—¶é—´æ•°æ®
    var data = [];
    //å­˜å‚¨è¿åŠ¨çš„å°çƒ
    var balls = [];
    //è®¾ç½®ç²’å­åŠå¾„
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //å­˜å‚¨æ—¶é—´æ•°å­—ï¼Œç”±åä½å°æ—¶ã€ä¸ªä½å°æ—¶ã€å†’å·ã€åä½åˆ†é’Ÿã€ä¸ªä½åˆ†é’Ÿã€å†’å·ã€åä½ç§’é’Ÿã€ä¸ªä½ç§’é’Ÿè¿™7ä¸ªæ•°å­—ç»„æˆ
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*ç”Ÿæˆç‚¹é˜µæ•°å­—*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*æ›´æ–°æ—¶é’Ÿ*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //æ—¶é—´å‘ç”Ÿå˜åŒ–
            if(NewData[i] !== data[i]){
                //å°†å˜åŒ–çš„æ•°å­—å€¼å’Œåœ¨dataæ•°ç»„ä¸­çš„ç´¢å¼•å­˜å‚¨åœ¨changeNumArrayæ•°ç»„ä¸­
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //å¢åŠ å°çƒ
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*æ›´æ–°å°çƒçŠ¶æ€*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*å¢åŠ è¦è¿åŠ¨çš„å°çƒ*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*æ¸²æŸ“*/
    function render(){
        //é‡ç½®ç”»å¸ƒå®½åº¦ï¼Œè¾¾åˆ°æ¸…ç©ºç”»å¸ƒçš„æ•ˆæœ
        canvas.height = 100;
        //æ¸²æŸ“æ—¶é’Ÿ
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //æ¸²æŸ“å°çƒ
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //æ›´æ–°æ—¶é’Ÿ
        updateDigitTime();
        //æ›´æ–°å°çƒçŠ¶æ€
        updateBalls();
        //æ¸²æŸ“
        render();
    },50);
}

})();</script><!-- require APlayer --><link href=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><!-- require MetingJS --><script src=/js/meting-js.js></script><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>æ–‡ç« ç›®å½•<li class=sidebar-nav-overview>ç«™ç‚¹æ¦‚è§ˆ</ul><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96><span class=nav-number>1.</span> <span class=nav-text>è‹ç©¹å¤–å–</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Jwt%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81><span class=nav-number>1.0.0.1.</span> <span class=nav-text>Jwtç™»å½•éªŒè¯</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%F0%9F%94%90-JWT-%E7%9A%84%E7%BB%93%E6%9E%84><span class=nav-number>1.0.1.</span> <span class=nav-text>ğŸ” JWT çš„ç»“æ„</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3><span class=nav-number>1.0.1.1.</span> <span class=nav-text>æ¥å£æ–‡æ¡£</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5><span class=nav-number>1.0.1.2.</span> <span class=nav-text>æ–°å¢å‘˜å·¥</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%91%98%E5%B7%A5><span class=nav-number>1.0.1.3.</span> <span class=nav-text>åˆ†é¡µæŸ¥è¯¢å‘˜å·¥</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#POJO%E4%B8%AD%E6%97%A5%E6%9C%9F%E5%BA%8F%E5%88%97%E5%8C%96><span class=nav-number>1.0.1.4.</span> <span class=nav-text>POJOä¸­æ—¥æœŸåºåˆ—åŒ–</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Cache><span class=nav-number>1.0.2.</span> <span class=nav-text>Spring Cache</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Task><span class=nav-number>1.0.3.</span> <span class=nav-text>Spring Task</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Websocket%E4%B8%BB%E5%8A%A8%E6%8E%A8%E9%80%81%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF><span class=nav-number>1.0.4.</span> <span class=nav-text>Websocketä¸»åŠ¨æ¨é€è®¢å•æ¶ˆæ¯</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Apache-Echarts%E5%B1%95%E7%A4%BA%E4%BF%A1%E6%81%AF><span class=nav-number>1.0.5.</span> <span class=nav-text>Apache Echartså±•ç¤ºä¿¡æ¯</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Apache-POI><span class=nav-number>1.0.6.</span> <span class=nav-text>Apache POI</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84><span class=nav-number>2.</span> <span class=nav-text>é»‘é©¬ç‚¹è¯„</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Redis%E5%AD%A6%E4%B9%A0><span class=nav-number>2.0.1.</span> <span class=nav-text>Rediså­¦ä¹ </span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Data-Redis><span class=nav-number>2.0.2.</span> <span class=nav-text>Spring Data Redis</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8><span class=nav-number>2.0.2.1.</span> <span class=nav-text>åºåˆ—åŒ–å™¨</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%9F%BA%E4%BA%8ESession%E7%9A%84%E7%99%BB%E9%99%86><span class=nav-number>2.0.3.</span> <span class=nav-text>åŸºäºSessionçš„ç™»é™†</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%9B%86%E7%BE%A4%E7%9A%84session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98><span class=nav-number>2.0.3.1.</span> <span class=nav-text>é›†ç¾¤çš„sessionå…±äº«é—®é¢˜</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%9F%AD%E4%BF%A1%E7%99%BB%E9%99%86><span class=nav-number>2.0.3.2.</span> <span class=nav-text>åŸºäºRedisçš„çŸ­ä¿¡ç™»é™†</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%BC%98%E5%8C%96%E6%8B%A6%E6%88%AA%E5%99%A8><span class=nav-number>2.0.3.3.</span> <span class=nav-text>ä¼˜åŒ–æ‹¦æˆªå™¨</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%99%BB%E9%99%86%E4%BB%A5%E5%8F%8A%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98><span class=nav-number>2.0.3.4.</span> <span class=nav-text>ç™»é™†ä»¥åŠæƒé™æ ¡éªŒå…³é”®é—®é¢˜</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98><span class=nav-number>2.0.4.</span> <span class=nav-text>å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5><span class=nav-number>2.0.5.</span> <span class=nav-text>ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80><span class=nav-number>2.0.6.</span> <span class=nav-text>ä¼˜æƒ åˆ¸ç§’æ€</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81><span class=nav-number>2.0.6.1.</span> <span class=nav-text>æ‚²è§‚é” ä¹è§‚é”</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81><span class=nav-number>2.0.6.2.</span> <span class=nav-text>Redissonå¯é‡å…¥é”</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%AF%E9%87%8D%E8%AF%95-%E6%9B%B4%E6%96%B0%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4><span class=nav-number>2.0.6.3.</span> <span class=nav-text>å¯é‡è¯•/æ›´æ–°è¶…æ—¶æ—¶é—´</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98><span class=nav-number>2.0.6.4.</span> <span class=nav-text>ä¸»ä»ä¸€è‡´æ€§é—®é¢˜</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97><span class=nav-number>2.0.6.5.</span> <span class=nav-text>Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%9F%BA%E4%BA%8Elist%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84><span class=nav-number>2.0.6.6.</span> <span class=nav-text>åŸºäºlistæ•°æ®ç»“æ„</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#pubsub-%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B6%88%E6%81%AF%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B><span class=nav-number>2.0.6.6.1.</span> <span class=nav-text>pubsub ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¶ˆæ¯æ¨¡å‹</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#Stream><span class=nav-number>2.0.6.6.2.</span> <span class=nav-text>Stream</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84><span class=nav-number>2.0.6.6.3.</span> <span class=nav-text>åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</span></a></ol><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E7%BB%84><span class=nav-number>2.0.6.7.</span> <span class=nav-text>åˆ›å»ºç»„</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF><span class=nav-number>2.0.6.8.</span> <span class=nav-text>è¯»å–æ¶ˆæ¯</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4><span class=nav-number>2.0.6.9.</span> <span class=nav-text>æ¶ˆæ¯ç¡®è®¤</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E6%9C%AA%E7%A1%AE%E8%AE%A4%E6%B6%88%E6%81%AF><span class=nav-number>2.0.6.10.</span> <span class=nav-text>æŸ¥çœ‹æœªç¡®è®¤æ¶ˆæ¯</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E2%9C%85%E5%A6%82%E4%BD%95%E8%AE%A9%E6%B6%88%E8%B4%B9%E8%80%85%E8%AF%BB%E5%8F%96%E2%80%9C%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%E2%80%9D%EF%BC%9F><span class=nav-number>2.0.6.10.1.</span> <span class=nav-text>âœ…å¦‚ä½•è®©æ¶ˆè´¹è€…è¯»å–â€œå†å²æ¶ˆæ¯â€ï¼Ÿ</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97><span class=nav-number>2.0.7.</span> <span class=nav-text>è¾¾äººæ¢åº—</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD><span class=nav-number>2.0.7.1.</span> <span class=nav-text>ç‚¹èµåŠŸèƒ½</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C><span class=nav-number>2.0.7.2.</span> <span class=nav-text>ç‚¹èµæ’è¡Œæ¦œ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8><span class=nav-number>2.0.7.3.</span> <span class=nav-text>å¥½å‹å…³æ³¨</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8><span class=nav-number>2.0.7.4.</span> <span class=nav-text>å…±åŒå…³æ³¨</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81><span class=nav-number>2.0.7.5.</span> <span class=nav-text>å…³æ³¨æ¨é€</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7><span class=nav-number>2.0.7.6.</span> <span class=nav-text>é™„è¿‘å•†æˆ·</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0><span class=nav-number>2.0.7.7.</span> <span class=nav-text>ç”¨æˆ·ç­¾åˆ°</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1><span class=nav-number>2.0.7.8.</span> <span class=nav-text>ç­¾åˆ°ç»Ÿè®¡</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#UV%E7%BB%9F%E8%AE%A1-HyperLogLog><span class=nav-number>2.0.7.9.</span> <span class=nav-text>UVç»Ÿè®¡ HyperLogLog</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyChat><span class=nav-number>3.</span> <span class=nav-text>EasyChat</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C><span class=nav-number>3.0.1.</span> <span class=nav-text>ç™»å½•æ³¨å†Œ</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%99%BB%E9%99%86><span class=nav-number>3.0.1.1.</span> <span class=nav-text>ç™»é™†</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%B3%A8%E5%86%8C><span class=nav-number>3.0.1.2.</span> <span class=nav-text>æ³¨å†Œ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.1.3.</span> <span class=nav-text>ä¿å­˜ç”¨æˆ·ä¿¡æ¯</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.1.4.</span> <span class=nav-text>è·å–ç”¨æˆ·ä¿¡æ¯</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9B%B4%E6%96%B0%E5%AF%86%E7%A0%81><span class=nav-number>3.0.1.5.</span> <span class=nav-text>æ›´æ–°å¯†ç </span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%80%80%E5%87%BA><span class=nav-number>3.0.1.6.</span> <span class=nav-text>é€€å‡º</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%BE%A4%E7%BB%84%E7%AE%A1%E7%90%86><span class=nav-number>3.0.2.</span> <span class=nav-text>ç¾¤ç»„ç®¡ç†</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E8%87%AA%E5%B7%B1%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.1.</span> <span class=nav-text>æŸ¥çœ‹è‡ªå·±ç¾¤èŠ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E7%BE%A4%E8%81%8A%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.2.2.</span> <span class=nav-text>æŸ¥çœ‹ç¾¤èŠä¿¡æ¯</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.3.</span> <span class=nav-text>åˆ›å»º/æ›´æ–°ç¾¤èŠ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%A7%A3%E6%95%A3%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.4.</span> <span class=nav-text>è§£æ•£ç¾¤èŠ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%80%80%E5%87%BA%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.5.</span> <span class=nav-text>é€€å‡ºç¾¤èŠ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%A0%E9%99%A4%E6%88%96%E8%80%85%E6%B7%BB%E5%8A%A0%E7%BE%A4%E6%88%90%E5%91%98><span class=nav-number>3.0.2.6.</span> <span class=nav-text>åˆ é™¤æˆ–è€…æ·»åŠ ç¾¤æˆå‘˜</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8A%A0%E5%85%A5%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.7.</span> <span class=nav-text>åŠ å…¥ç¾¤èŠ</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%94%E7%B3%BB%E4%BA%BA%E7%AE%A1%E7%90%86><span class=nav-number>3.0.3.</span> <span class=nav-text>è”ç³»äººç®¡ç†</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%90%9C%E7%B4%A2%E7%94%A8%E6%88%B7><span class=nav-number>3.0.3.1.</span> <span class=nav-text>æœç´¢ç”¨æˆ·</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%94%B3%E8%AF%B7%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.3.2.</span> <span class=nav-text>ç”³è¯·æ·»åŠ è”ç³»äºº</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.3.3.</span> <span class=nav-text>ç›´æ¥æ·»åŠ è”ç³»äºº</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%8F%92%E5%85%A5%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.4.</span> <span class=nav-text>æ’å…¥ç”³è¯·è¯·æ±‚</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E8%AF%A2%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.5.</span> <span class=nav-text>æŸ¥è¯¢ç”³è¯·è¯·æ±‚</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%A4%84%E7%90%86%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.6.</span> <span class=nav-text>å¤„ç†ç”³è¯·è¯·æ±‚</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%94%E7%B3%BB%E4%BA%BA%E8%AF%A6%E6%83%85-%E5%88%A0%E9%99%A4%E5%92%8C%E6%8B%89%E9%BB%91%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.4.</span> <span class=nav-text>è”ç³»äººè¯¦æƒ…,åˆ é™¤å’Œæ‹‰é»‘è”ç³»äºº</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E3%80%81%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E4%B8%8E%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95><span class=nav-number>3.0.5.</span> <span class=nav-text>è·å–ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ä¸é€€å‡ºç™»å½•</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86><span class=nav-number>3.0.6.</span> <span class=nav-text>åå°ç®¡ç†</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%99%BB%E9%99%86%E6%97%B6%E5%8A%A0%E8%BD%BD%E6%B6%88%E6%81%AF><span class=nav-number>3.0.7.</span> <span class=nav-text>ç™»é™†æ—¶åŠ è½½æ¶ˆæ¯</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%8A%E5%A4%A9><span class=nav-number>3.0.8.</span> <span class=nav-text>èŠå¤©</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF><span class=nav-number>3.0.8.1.</span> <span class=nav-text>å‘é€æ¶ˆæ¯</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6><span class=nav-number>3.0.8.2.</span> <span class=nav-text>ä¸Šä¼ æ–‡ä»¶</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6><span class=nav-number>3.0.8.3.</span> <span class=nav-text>ä¸‹è½½æ–‡ä»¶</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyPan><span class=nav-number>4.</span> <span class=nav-text>EasyPan</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#IDE%E8%AE%BE%E7%BD%AE><span class=nav-number>4.0.1.</span> <span class=nav-text>IDEè®¾ç½®</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#JDK%E4%BD%8D%E7%BD%AE%E8%AE%BE%E7%BD%AE><span class=nav-number>4.0.1.1.</span> <span class=nav-text>JDKä½ç½®è®¾ç½®</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BC%96%E8%AF%91%E5%99%A8%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%83%AD%E4%BA%A4%E6%8D%A2><span class=nav-number>4.0.1.2.</span> <span class=nav-text>ç¼–è¯‘å™¨è‡ªåŠ¨æ„å»ºä¸çƒ­äº¤æ¢</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AE%BE%E7%BD%AEMaven%E4%BD%8D%E7%BD%AE><span class=nav-number>4.0.1.3.</span> <span class=nav-text>è®¾ç½®Mavenä½ç½®</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AE%BE%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BC%96%E7%A0%81><span class=nav-number>4.0.1.4.</span> <span class=nav-text>è®¾ç½®æ–‡ä»¶ç¼–ç </span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B><span class=nav-number>4.0.1.5.</span> <span class=nav-text>åˆ›å»ºå·¥ç¨‹</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6><span class=nav-number>4.0.2.</span> <span class=nav-text>é…ç½®æ–‡ä»¶</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#POM-xml><span class=nav-number>4.0.2.1.</span> <span class=nav-text>POM.xml</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF><span class=nav-number>4.0.2.1.1.</span> <span class=nav-text>é¡¹ç›®åŸºæœ¬ä¿¡æ¯</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E7%BB%A7%E6%89%BF%E4%B8%8E%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86><span class=nav-number>4.0.2.1.2.</span> <span class=nav-text>ç»§æ‰¿ä¸æ¨¡å—ç®¡ç†</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86><span class=nav-number>4.0.2.1.3.</span> <span class=nav-text>ä¾èµ–ç®¡ç†</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9E%84%E5%BB%BA%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.1.4.</span> <span class=nav-text>æ„å»ºé…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%B1%9E%E6%80%A7%E5%AE%9A%E4%B9%89><span class=nav-number>4.0.2.1.5.</span> <span class=nav-text>å±æ€§å®šä¹‰</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9E%84%E5%BB%BA%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.1.6.</span> <span class=nav-text>æ„å»ºç¯å¢ƒä¸å‘å¸ƒé…ç½®</span></a></ol><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95><span class=nav-number>4.0.2.2.</span> <span class=nav-text>æ—¥å¿—è®°å½•</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#application-properties><span class=nav-number>4.0.2.3.</span> <span class=nav-text>application.properties</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.1.</span> <span class=nav-text>æœåŠ¡å™¨é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%BA%94%E7%94%A8%E4%BF%A1%E6%81%AF><span class=nav-number>4.0.2.3.2.</span> <span class=nav-text>åº”ç”¨ä¿¡æ¯</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BB%A5-MySQL-%E4%B8%BA%E4%BE%8B%EF%BC%89><span class=nav-number>4.0.2.3.3.</span> <span class=nav-text>æ•°æ®æºé…ç½®ï¼ˆä»¥ MySQL ä¸ºä¾‹ï¼‰</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.4.</span> <span class=nav-text>æ—¥å¿—é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.5.</span> <span class=nav-text>é‚®ä»¶é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.6.</span> <span class=nav-text>å®‰å…¨é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.7.</span> <span class=nav-text>ç¼“å­˜é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%9B%BD%E9%99%85%E5%8C%96%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.8.</span> <span class=nav-text>å›½é™…åŒ–é…ç½®</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.9.</span> <span class=nav-text>æµ‹è¯•é…ç½®</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%9A%E5%8A%A1%E9%87%8D%E7%82%B9%E6%B5%81%E7%A8%8B><span class=nav-number>4.0.3.</span> <span class=nav-text>ä¸šåŠ¡é‡ç‚¹æµç¨‹</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86><span class=nav-number>4.1.</span> <span class=nav-text>æ–‡ä»¶ç®¡ç†</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E6%96%87%E4%BB%B6><span class=nav-number>4.1.1.</span> <span class=nav-text>æŸ¥çœ‹æ–‡ä»¶</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0><span class=nav-number>4.1.2.</span> <span class=nav-text>æ–‡ä»¶ä¸Šä¼ </span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.</span> <span class=nav-text>æ–‡ä»¶é¢„è§ˆ</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%99%AE%E9%80%9A%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.1.</span> <span class=nav-text>æ™®é€šæ–‡ä»¶é¢„è§ˆ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BC%A9%E7%95%A5%E5%9B%BE%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.2.</span> <span class=nav-text>ç¼©ç•¥å›¾é¢„è§ˆ</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%A7%86%E9%A2%91%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.3.</span> <span class=nav-text>è§†é¢‘é¢„è§ˆ</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%88%86%E7%89%87%E4%B8%8B%E8%BD%BD%E6%97%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%90%BA%E5%B8%A6%E7%9A%84%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF><span class=nav-number>4.1.3.3.1.</span> <span class=nav-text>åˆ†ç‰‡ä¸‹è½½æ—¶å®¢æˆ·ç«¯è¯·æ±‚å¤´æºå¸¦çš„å…³é”®ä¿¡æ¯</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%9B%AE%E5%BD%95%E7%9B%B8%E5%85%B3><span class=nav-number>4.1.4.</span> <span class=nav-text>ç›®å½•ç›¸å…³</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95><span class=nav-number>4.1.4.1.</span> <span class=nav-text>åˆ›å»ºç›®å½•</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84><span class=nav-number>4.1.4.2.</span> <span class=nav-text>è·å–ç›®å½•è·¯å¾„</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D><span class=nav-number>4.1.4.3.</span> <span class=nav-text>æ–‡ä»¶é‡å‘½å</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%A7%BB%E5%8A%A8%E6%96%87%E4%BB%B6><span class=nav-number>4.1.4.4.</span> <span class=nav-text>ç§»åŠ¨æ–‡ä»¶</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6><span class=nav-number>4.1.4.5.</span> <span class=nav-text>åˆ é™¤æ–‡ä»¶</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%9B%9E%E6%94%B6%E7%AB%99%E5%9B%9E%E6%94%B6%E3%80%81%E8%BF%98%E5%8E%9F%E4%BB%A5%E5%8F%8A%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6><span class=nav-number>4.1.5.</span> <span class=nav-text>å›æ”¶ç«™å›æ”¶ã€è¿˜åŸä»¥åŠå½»åº•åˆ é™¤æ–‡ä»¶</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%A4%96%E9%83%A8%E5%88%86%E4%BA%AB%E6%96%87%E4%BB%B6><span class=nav-number>4.1.6.</span> <span class=nav-text>å¤–éƒ¨åˆ†äº«æ–‡ä»¶</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyLive><span class=nav-number>5.</span> <span class=nav-text>EasyLive</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%82%E8%80%83%E5%8D%9A%E4%B8%BB><span class=nav-number>5.0.1.</span> <span class=nav-text>å‚è€ƒåšä¸»</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Sekyoro class=site-author-image itemprop=image src=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg><p class=site-author-name itemprop=name>Sekyoro<div class=site-description itemprop=description>ä»€ä¹ˆä¹Ÿæ— æ³•èˆå¼ƒçš„äººï¼Œä»€ä¹ˆä¹Ÿåšä¸äº†.</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>242</span> <span class=site-state-item-name>æ—¥å¿—</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>16</span> <span class=site-state-item-name>åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>214</span> <span class=site-state-item-name>æ ‡ç­¾</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item> <a title="Personal Website â†’ http://proanimer.com" href=http://proanimer.com/ rel=noopener target=_blank><i class="fab fa-internet-explorer fa-fw"></i>Personal Website</a> </span><span class=links-of-author-item> <a title="GitHub â†’ https://github.com/drowning-in-codes" href=https://github.com/drowning-in-codes rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item> <a title="E-Mail â†’ mailto:bukalala174@gmail.com" href=mailto:bukalala174@gmail.com rel=noopener target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class=links-of-author-item> <a title="wxPublicAccount â†’ https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd" href=https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd rel=noopener target=_blank><i class="fab fa-weixin fa-fw"></i>wxPublicAccount</a> </span><span class=links-of-author-item> <a title="RSS â†’ /atom.xml" href=/atom.xml><i class="fa fa-rss fa-fw"></i>RSS</a> </span><span class=links-of-author-item> <a title="CSDN â†’ https://blog.csdn.net/aqwca" href=https://blog.csdn.net/aqwca rel=noopener target=_blank><i class="fa fa-handshake fa-fw"></i>CSDN</a> </span><span class=links-of-author-item> <a title="æ‚é±¼åˆ†äº« â†’ https://my-astro-git-main-drowning-in-codes.vercel.app" href=https://my-astro-git-main-drowning-in-codes.vercel.app/ rel=noopener target=_blank><i class="fas fa-share fa-fw"></i>æ‚é±¼åˆ†äº«</a> </span></div><div class="links-of-blogroll motion-element"><div class=links-of-blogroll-title><i class="fa fa-link fa-fw"></i> å‹æƒ…é“¾æ¥</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=http://myqhs.top/ rel=noopener target=_blank title=http://myqhs.top/>myqhs</a><li class=links-of-blogroll-item><a href=https://www.lllomh.com/ rel=noopener target=_blank title=https://www.lllomh.com/>èŠˆæ¸¡</a><li class=links-of-blogroll-item><a href=https://protool-ten.vercel.app/ rel=noopener target=_blank title=https://protool-ten.vercel.app/>protools</a></ul></div><div class="motion-element announcement"><div class=title></div><p class=content><p class=date></div></div><meting-js id=6856787487 order=random server=netease type=playlist> </meting-js><div class=widget-wrap><h3 class=widget-title style=margin:0>æ–‡ç« è¯äº‘</h3><div class="widget tagcloud" id=myCanvasContainer><canvas height=250 id=resCanvas style=width:100% width=250><ul class=tag-list itemprop=keywords><li class=tag-list-item><a class=tag-list-link href=/tags/Java/ rel=tag>Java</a><span class=tag-list-count>1</span></ul></canvas></div></div><script id=clustrmaps src=https://clustrmaps.com/map_v2.js?d=xQdGTxqARTBiNIwX2aUban-ixkj2s6VaZQWo-aVCgY8&cl=ffffff&w=a></script><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i><span>0%</span></div><!-- è¾¹æ  --></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>Â© Wed Apr 08 2020 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) â€“ <span itemprop=copyrightYear>2025</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>Sekyoro</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-chart-area"></i> </span><span title=ç«™ç‚¹æ€»å­—æ•°>2.7m</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span><span title=ç«™ç‚¹é˜…è¯»æ—¶é•¿>41:31</span></div><script async src=https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container_site_pv>æ€»è®¿é—®é‡<span id=busuanzi_value_site_pv></span>æ¬¡</span><span class=post-meta-divider>|</span><span id=busuanzi_container_site_uv>æ€»è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äºº</span><span class=post-meta-divider>|</span><!-- ä¸è’œå­è®¡æ•°åˆå§‹å€¼çº æ­£ --><script>$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50mså‘¨æœŸæ£€æµ‹å‡½æ•°
    var countOffset = 20000;  // åˆå§‹åŒ–é¦–æ¬¡æ•°æ®

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // åŠ ä¸Šåˆå§‹æ•°æ® 
            clearInterval(int); // åœæ­¢æ£€æµ‹
        }  
    }
       	
});</script><div><span id=timeDate>è½½å…¥å¤©æ•°...</span><span id=times>è½½å…¥æ—¶åˆ†ç§’...</span><script>var now = new Date();
    function createtime() {
        var grt= new Date("04/08/2021 20:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ "+dnum+" å¤© ";
        document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
    }
setInterval("createtime()",250);</script></div><div class=busuanzi-count><script async data-pjax src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span style="display: none;" class=post-meta-item id=busuanzi_container_site_uv> <span class=post-meta-item-icon> <i class="fa fa-user"></i> </span> <span class=site-uv title=æ€»è®¿å®¢é‡> <span id=busuanzi_value_site_uv></span> </span> </span><span class=post-meta-divider>|</span><span style="display: none;" class=post-meta-item id=busuanzi_container_site_pv> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=site-pv title=æ€»è®¿é—®é‡> <span id=busuanzi_value_site_pv></span> </span> </span></div></div></footer></div><script color=0,0,255 count=99 opacity=0.5 src=/lib/canvas-nest/canvas-nest.min.js zindex=-1></script><script src=/lib/anime.min.js></script><script src=https://cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=https://cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js></script><script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/pisces.js></script><script src=/js/next-boot.js></script><script src=/js/bookmark.js></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax',
	'.widget-wrap'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
 
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script data-pjax>(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();</script><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js></script><script src=/js/algolia-search.js></script><script data-pjax>document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});</script><div id=pjax><script charset=utf-8 defer src=/js/outdate.js></script></div><script charset=utf-8 defer src=/js/tagcanvas.js></script><script charset=utf-8 defer src=/js/tagcloud.js></script><script>NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});</script><script>var OriginTitile = document.title;
  var titleTime;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      document.title = "(ã¤ã‚§âŠ‚)æˆ‘è—å¥½äº†å“¦~" + OriginTitile;
      clearTimeout(titleTime);
    } else {
      document.title = "(*Â´âˆ‡ï½€*) è¢«ä½ å‘ç°å•¦~" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });</script><script src=/js/src/activate-power-mode.min.js></script><script>POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);</script>