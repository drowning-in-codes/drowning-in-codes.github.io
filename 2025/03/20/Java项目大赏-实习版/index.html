<!doctypehtml><html lang=zh-CN><script defer src=/live2d-widget/autoload.js></script><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content="Hexo 5.4.0" name=generator><link href=/images/blog_32px.png rel=apple-touch-icon sizes=180x180><link href=/images/blog_32px.png rel=icon sizes=32x32 type=image/png><link href=/images/blog_16px.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><meta content=EPrJAp11bJwHULpQUaSNSZ8_3RcvTsPDAEGOME4pl1w name=google-site-verification><!-- Google tag (gtag.js) --><!-- 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB21D8MKKW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VB21D8MKKW');
</script> --><!-- google adsense in head.swig --><script async crossorigin=anonymous src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123></script><meta content=7226864CE87CE9DE8C008385273846FF name=msvalidate.01><meta content=code-fjFXVtiL7j name=baidu-site-verification><link href=/css/main.css rel=stylesheet><link as=style href=https://fonts.googleapis.com/css?family=Roboto%20Mono,Roboto:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext onload=this.rel='stylesheet' rel=preload><link as=style href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css onload=this.rel='stylesheet' rel=preload><link href=https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap rel=stylesheet><link href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/pace-js@1/pace.min.js></script><script id=hexo-configurations>var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.sekyoro.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":240,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"0F9LEEVW82","apiKey":"78839e9f9be09d081c5c4da81975cd19","indexName":"sekyoblog_sec","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};</script><link href=//cdn.bootcss.com/animate.css/3.5.0/animate.min.css rel=stylesheet><meta content=最近在准备实习,找一些烂大街经典项目练练手. name=description><meta content=article property=og:type><meta content=Java项目大赏(实习版) property=og:title><meta content=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/index.html property=og:url><meta content=Sekyoro的博客小屋 property=og:site_name><meta content=最近在准备实习,找一些烂大街经典项目练练手. property=og:description><meta content=zh_CN property=og:locale><meta content=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png property=og:image><meta content=https://s2.loli.net/2025/04/22/QKmht3v8O4pyAPC.png property=og:image><meta content=https://s2.loli.net/2025/04/23/28JgwEfF7bZNsQz.png property=og:image><meta content=https://s2.loli.net/2025/04/29/J3v6auIHbXNZxkT.png property=og:image><meta content=https://s2.loli.net/2025/04/30/iE9YtUfMhqRXn46.png property=og:image><meta content=https://s2.loli.net/2025/04/12/TEPKoIHGYOma4Jy.png property=og:image><meta content=https://s2.loli.net/2025/04/13/IPJL4xzF2aGAOfN.png property=og:image><meta content=https://s2.loli.net/2025/04/13/VKJzFQulyvWTSfa.png property=og:image><meta content=https://s2.loli.net/2025/03/20/VqbA8F34U17C9xZ.png property=og:image><meta content=https://s2.loli.net/2025/04/14/xZREAUpPzkQBiVF.png property=og:image><meta content=https://s2.loli.net/2025/04/14/bVvPz25pxkyMqB9.png property=og:image><meta content=https://s2.loli.net/2025/07/15/5lLUKEwJnexXoua.png property=og:image><meta content=https://s2.loli.net/2025/04/14/36voF12n9YepEkI.png property=og:image><meta content=https://s2.loli.net/2025/04/14/sUTIzrhMgqNpR7H.png property=og:image><meta content=https://s2.loli.net/2025/04/14/HTdpXizlnASGQqv.png property=og:image><meta content=https://s2.loli.net/2025/04/14/jc9OQH8oFwMLz5K.png property=og:image><meta content=https://s2.loli.net/2025/04/15/p72NIzH9MfZaxnR.png property=og:image><meta content=https://s2.loli.net/2025/04/15/y7bowaDxTL2f8GJ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/TU3KbireNcB4G67.png property=og:image><meta content=https://s2.loli.net/2025/04/15/CFEZY2mKqnwljAW.png property=og:image><meta content=https://s2.loli.net/2025/04/15/LqgUJKSZD9Gfad6.png property=og:image><meta content=https://s2.loli.net/2025/04/15/MozbdO6Ly2aCI4E.png property=og:image><meta content=https://s2.loli.net/2025/04/15/aujZnwSzgiUxloL.png property=og:image><meta content=https://s2.loli.net/2025/04/15/xBTlfUn6WmDpwIJ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/Tcd5tCruUKo6wvM.png property=og:image><meta content=https://s2.loli.net/2025/04/15/x5ayubhtcrSK8qQ.png property=og:image><meta content=https://s2.loli.net/2025/04/15/EBpdcml8I7tLvxU.png property=og:image><meta content=https://s2.loli.net/2025/04/15/3LSmM7p8e5gfXcN.png property=og:image><meta content=https://s2.loli.net/2025/04/15/tXm5rvyNMhbxeYL.png property=og:image><meta content=https://s2.loli.net/2025/04/16/zTXyB8Uo7RKWmc2.png property=og:image><meta content=https://s2.loli.net/2025/04/16/9QRuCerNJpmcHaf.png property=og:image><meta content=https://s2.loli.net/2025/04/16/3tu9mqXVNyoDZYT.png property=og:image><meta content=https://s2.loli.net/2025/04/16/eCKmRn4QDs7pSLA.png property=og:image><meta content=https://s2.loli.net/2025/04/17/t4sZY1NizPOvRcX.png property=og:image><meta content=https://s2.loli.net/2025/04/17/JBC3Xe1HPmpfnwa.png property=og:image><meta content=https://s2.loli.net/2025/04/17/X7GMsSg59QjnaRf.png property=og:image><meta content=https://s2.loli.net/2025/04/17/AG1vHk7s2u6FexB.png property=og:image><meta content=https://s2.loli.net/2025/04/17/2jkGcgNIYylmQL8.png property=og:image><meta content=https://s2.loli.net/2025/04/17/lytxPu8ZirBRH5s.png property=og:image><meta content=https://s2.loli.net/2025/04/17/EYhwIoeVBgmkHfU.png property=og:image><meta content=https://s2.loli.net/2025/04/17/UiIyGpJA4RoP7Dh.png property=og:image><meta content=https://s2.loli.net/2025/04/18/cn3NCI9O24upUlg.png property=og:image><meta content=https://s2.loli.net/2025/04/18/IRiKpLMBV1cCUs3.png property=og:image><meta content=https://s2.loli.net/2025/04/18/bS3QAUKsTHoRY1q.png property=og:image><meta content=https://s2.loli.net/2025/04/18/ayrfSevJ8TdGUF3.png property=og:image><meta content=https://s2.loli.net/2025/04/18/9ih5CDwLBlKNERW.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2014/11/pubsub2.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2014/11/pubsub1.png property=og:image><meta content=https://s2.loli.net/2025/04/18/7LEADu5klUBta8Q.png property=og:image><meta content=https://s2.loli.net/2025/04/18/2lE9g7iU3WBpsIy.png property=og:image><meta content=https://www.runoob.com/wp-content/uploads/2020/09/en-us_image_0167982791.png property=og:image><meta content=https://s2.loli.net/2025/04/18/N41xhBcZ6qTWUiG.png property=og:image><meta content=https://s2.loli.net/2025/04/18/JE9ZNCxDHaBWpw1.png property=og:image><meta content=https://s2.loli.net/2025/04/18/oTspnQeVrkqgOcv.png property=og:image><meta content=https://s2.loli.net/2025/04/18/sVrCm1K7YTewhaq.png property=og:image><meta content=https://s2.loli.net/2025/04/18/ay8uA5fSi3RvTMV.png property=og:image><meta content=https://s2.loli.net/2025/04/19/4rg9LteAzoDlaWb.png property=og:image><meta content=https://s2.loli.net/2025/04/19/muwJasz9gGTxAHK.png property=og:image><meta content=https://s2.loli.net/2025/04/20/p92Zqc4evEjimXY.png property=og:image><meta content=https://s2.loli.net/2025/04/20/Y2jI3QHEemkOBvi.png property=og:image><meta content=https://s2.loli.net/2025/04/20/OqkUF4G21LYZM5K.png property=og:image><meta content=https://s2.loli.net/2025/04/20/hNcu5avy2WmPBMk.png property=og:image><meta content=https://s2.loli.net/2025/04/20/thV71ZUKQlaqs3i.png property=og:image><meta content=https://s2.loli.net/2025/04/20/gCqrxOB86TdfhLb.png property=og:image><meta content=https://s2.loli.net/2025/04/21/8wXL5PpFBWu1c6K.png property=og:image><meta content=https://s2.loli.net/2025/04/21/9IYeW5iocs3u1PB.png property=og:image><meta content=https://s2.loli.net/2025/04/22/61cqOWxZMwnfemh.png property=og:image><meta content=https://s2.loli.net/2025/04/22/aGspbuONkSMdqxf.png property=og:image><meta content=https://s2.loli.net/2025/04/22/dfuNzSwYlVOsJD1.png property=og:image><meta content=https://s2.loli.net/2025/04/22/MEm6zF5nt28TBch.png property=og:image><meta content=https://s2.loli.net/2025/04/22/ztXRO9DFqkU68xV.png property=og:image><meta content=https://s2.loli.net/2025/05/02/C8LFUSamDZfsJPA.png property=og:image><meta content=https://s2.loli.net/2025/05/02/WABFut1yEYeLSPa.png property=og:image><meta content=https://s2.loli.net/2025/05/02/XZeaDzgW8tl5LMA.png property=og:image><meta content=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png property=og:image><meta content=https://s2.loli.net/2025/07/22/XnkZECm7cG23dlD.png property=og:image><meta content=https://s2.loli.net/2025/05/05/vODxw84bH7LguBa.png property=og:image><meta content=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png property=og:image><meta content=https://s2.loli.net/2025/07/21/qXQrNahUbLdZw5p.png property=og:image><meta content=https://s2.loli.net/2025/07/21/Mf9eRWBC2mu1plw.png property=og:image><meta content=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png property=og:image><meta content=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png property=og:image><meta content=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png property=og:image><meta content=https://s2.loli.net/2025/07/21/y6cuUbi5AOKPRVr.png property=og:image><meta content=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png property=og:image><meta content=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png property=og:image><meta content=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png property=og:image><meta content=https://s2.loli.net/2025/05/14/Wpwxn17jzJYgNiZ.png property=og:image><meta content=https://s2.loli.net/2025/05/14/IouNVMneLkvw5xd.png property=og:image><meta content=https://s2.loli.net/2025/05/14/fHxKr3uUjsJwGTV.png property=og:image><meta content=https://s2.loli.net/2025/05/14/VIFQjYLmdoMyuT4.png property=og:image><meta content=https://s2.loli.net/2025/05/14/AYdCIP8NLceGyig.png property=og:image><meta content=https://s2.loli.net/2025/05/14/gfJ2BtnGVdkwj4a.png property=og:image><meta content=https://s2.loli.net/2025/05/14/PWJutmFC9iZyXNn.png property=og:image><meta content=https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/logback-6ba1b465-5533-49dd-b875-48a10ba29f8e.png property=og:image><meta content=https://s2.loli.net/2025/07/22/Udzg4jYavtVsL3Z.png property=og:image><meta content=2025-03-20T09:38:06.000Z property=article:published_time><meta content=2025-07-24T09:40:39.045Z property=article:modified_time><meta content=Sekyoro property=article:author><meta content=Java property=article:tag><meta content=summary name=twitter:card><meta content=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png name=twitter:image><link href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ rel=canonical><script id=page-configurations>// https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };</script><title>Java项目大赏(实习版) | Sekyoro的博客小屋</title><noscript><style>.use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }</style></noscript><link href=/atom.xml rel=alternate title=Sekyoro的博客小屋 type=application/atom+xml><body itemscope itemtype=http://schema.org/WebPage><canvas style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" class=fireworks></canvas><script defer src=https://cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script defer src=/js/src/fireworks.js></script><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <span class=logo-line-before><i></i></span> <h1 class=site-title>Sekyoro的博客小屋</h1> <span class=logo-line-after><i></i></span> </a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu" id=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-bangumis"><a href=/bangumis/ rel=section><i class="fa fa-film fa-fw"></i>追番</a><li class="menu-item menu-item-resume"><a href=/resume/ rel=section><i class="fa fa-file-pdf fa-fw"></i>简历</a><li class="menu-item menu-item-materials"><a href=/materials/ rel=section><i class="fa fa-book fa-fw"></i>学习资料</a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>站点地图</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container></div><span class=popup-btn-close> <i class="fa fa-times-circle"></i> </span></div><div class=algolia-results><div id=algolia-stats></div><div id=algolia-hits></div><div class=algolia-pagination id=algolia-pagination></div></div></div></div></div></header><a class="book-mark-link book-mark-link-fixed" role=button></a><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article class=post-block itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg itemprop=image> <meta content=Sekyoro itemprop=name> <meta content=什么也无法舍弃的人，什么也做不了. itemprop=description> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=Sekyoro的博客小屋 itemprop=name> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Java项目大赏(实习版)</h1><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2025-03-20 17:38:06" datetime=2025-03-20T17:38:06+08:00>2025-03-20</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2025-07-24 17:40:39" datetime=2025-07-24T17:40:39+08:00 itemprop=dateModified>2025-07-24</time> </span><span style="display: none;" class=post-meta-item id=busuanzi_container_page_pv title=阅读次数> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span> </span><br><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>69k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>1:03</span> </span></div></header><div class=post-body itemprop=articleBody><p>最近在准备实习,找一些<del>烂大街</del>经典项目练练手.<br><span id=more></span><h1 id=苍穹外卖><a class=headerlink href=#苍穹外卖 title=苍穹外卖></a>苍穹外卖</h1><p>一个项目通常包含公共类(常量,工具以及异常)部分以及实体类部分<p><img alt=image-20250422144407360 data-src=https://s2.loli.net/2025/04/22/q8oS52LepZjOgHc.png><p>此外还有service,controller,mapper(repository)层以及一些配置类,拦截器等<h4 id=Jwt登录验证><a class=headerlink href=#Jwt登录验证 title=Jwt登录验证></a>Jwt登录验证</h4><ol><li>用户登录请求</ol><p>客户端（通常是浏览器或App）发送包含用户名和密码的登录请求到后端。<ol><li>服务端验证身份</ol><p>后端接收请求，验证用户名和密码是否正确：<ul><li>正确：生成 JWT，返回给客户端<li>错误：返回认证失败响应</ul><ol><li>服务端生成 JWT</ol><p>服务端使用 <strong>密钥</strong> 对 payload 进行签名，生成一个完整的 token：<figure class="highlight gcode"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>bashCopyEditeyJhbGciOiJIUzI<span class=number>1</span><span class=symbol>NiIsInR5</span>cCI<span class=number>6</span>IkpX<span class=attr>VCJ9</span>.    <span class=attr># Header</span></span><br><span class=line><span class=attr>eyJ1</span>c<span class=number>2</span>VySWQiOjEyMywidX<span class=symbol>Nlcm5</span>hbWUiOiJ<span class=number>0</span>b<span class=number>20</span>iLCJleHAiOjE<span class=number>3</span>MT<span class=name>M1</span><span class=symbol>NjgwMDB9</span>.  <span class=attr># Payload</span></span><br><span class=line><span class=attr>SflKxwRJSMeKKF2</span>QT<span class=number>4</span>fwpMeJf<span class=number>36</span>POk<span class=number>6</span>yJV_adQssw<span class=number>5</span>c  <span class=attr># Signature</span></span><br></pre></table></figure><blockquote><p>服务端此后 <strong>不再保存用户状态</strong>，所有认证信息都由 token 自带。</blockquote><ol><li>客户端保存 JWT</ol><p>客户端收到 token 后，通常将其存储在：<ul><li><code>localStorage</code> / <code>sessionStorage</code><li>cookie（慎用，需设置 <code>HttpOnly</code> 和 <code>Secure</code>）</ul><ol><li>客户端携带 JWT 访问资源</ol><p>客户端每次请求受保护的资源时，在请求头中携带 token：<figure class="highlight dts"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=symbol>Authorization:</span> Bearer <span class=params>&LTtoken></span></span><br></pre></table></figure><ol><li>服务端验证 JWT</ol><ul><li>服务端提取 token，验证签名是否合法、是否过期。<li>若合法，解析 payload，拿到 <code>userId</code> 等信息，并执行业务逻辑。</ul><h3 id=🔐-JWT-的结构><a title="🔐 JWT 的结构" class=headerlink href=#🔐-JWT-的结构></a>🔐 JWT 的结构</h3><p>JWT 是一个由三部分组成的字符串，用 <code>.</code> 分隔：<ol><li>Header（头部）</ol><p>描述签名的算法及类型，通常是这样的：<figure class="highlight mipsasm"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>jsonCopyEdit{</span></span><br><span class=line><span class=keyword></span>  <span class=string>"alg"</span>: <span class=string>"HS256"</span>,</span><br><span class=line>  <span class=string>"typ"</span>: <span class=string>"JWT"</span></span><br><span class=line>}</span><br></pre></table></figure><ol><li>Payload（有效载荷）</ol><p>存放业务数据，不应包含敏感信息，因为它是明文的。常见字段：<div class=table-container><table><thead><tr><th>字段<th>含义<tbody><tr><td><code>sub</code><td>主题（Subject）<tr><td><code>exp</code><td>过期时间（Expiration Time）<tr><td><code>iat</code><td>签发时间（Issued At）<tr><td><code>userId</code><td>自定义字段，通常是用户唯一标识<tr><td><code>roles</code><td>自定义字段，表示用户权限角色</table></div><p>示例：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>{</span><br><span class=line>  <span class=attr>"userId"</span>: <span class=number>123</span>,</span><br><span class=line>  <span class=attr>"username"</span>: <span class=string>"tom"</span>,</span><br><span class=line>  <span class=attr>"exp"</span>: <span class=number>1713568000</span></span><br><span class=line>}</span><br></pre></table></figure><ol><li>Signature（签名）</ol><p>由 header 和 payload 使用密钥 <code>secret</code> 签名生成，用于防篡改。<figure class="highlight lisp"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>javaCopyEditHMACSHA256(</span><br><span class=line>  <span class=name>base64UrlEncode</span>(<span class=name>header</span>) + <span class=string>"."</span> + base64UrlEncode(<span class=name>payload</span>),</span><br><span class=line>  secret</span><br><span class=line>)</span><br></pre></table></figure><p><strong>🧾 JWT 优点</strong><ul><li>无需在服务端存储 Session，实现 <strong>无状态认证</strong><li>可跨服务、跨域使用（适合微服务）<li>自带用户信息，减少查库压力<li>易扩展，可加入权限、组织、平台等字段</ul><p><strong>⚠️ 安全建议</strong><ul><li><strong>token 不要放敏感信息</strong>（明文可读）<li>设置合理的 <strong>过期时间</strong><li>通过 <code>HTTPS</code> 传输，防止中间人攻击<li>使用 <code>HttpOnly + Secure</code> 的 cookie 保存（如 SSR）</ul><h4 id=接口文档><a class=headerlink href=#接口文档 title=接口文档></a>接口文档</h4><p>开放接口规范有Swagger(springfox)和<strong>OpenAPI</strong>(目前常用).<p>可以使用springdoc-openapi或Knife4j工具通过添加注解生成规范<p><a href=https://github.com/springdoc/springdoc-openapi rel=noopener target=_blank>springdoc/springdoc-openapi: Library for OpenAPI 3 with spring-boot</a><p><a href=https://doc.xiaominfo.com/docs/quick-start rel=noopener target=_blank>快速开始 | Knife4j</a><p><img alt=image-20250422195017608 data-src=https://s2.loli.net/2025/04/22/QKmht3v8O4pyAPC.png><h4 id=新增员工><a class=headerlink href=#新增员工 title=新增员工></a>新增员工</h4><p>增加mapper的插入语句增加员工信息,注意插入错误处理.<p>以及通过interceptor,threadlocal存储登录信息.<h4 id=分页查询员工><a class=headerlink href=#分页查询员工 title=分页查询员工></a>分页查询员工</h4><p>利用mybatis的pagehelper插件,其通过拦截执行的查询语句修改其中的LIMIT返回结果.首先设置页大小和需要查询的页.<ol><li><code>PageHelper.startPage(pageNum, pageSize)</code></ol><p>用于设置当前页码和每页条数，<strong>必须在执行查询语句之前调用</strong>。<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>PageHelper.startPage(<span class=number>1</span>, <span class=number>10</span>); <span class=comment>// 第1页，每页10条</span></span><br><span class=line>List&LTUser> users = userMapper.selectAll();</span><br><span class=line>PageInfo&LTUser> pageInfo = <span class=keyword>new</span> PageInfo<>(users);</span><br></pre></table></figure><ol><li><code>PageHelper.offsetPage(offset, limit)</code></ol><p>按偏移量方式分页，适合流式加载等场景。<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>PageHelper.offsetPage(<span class=number>20</span>, <span class=number>10</span>); <span class=comment>// 跳过前20条，查询10条</span></span><br><span class=line>List&LTUser> users = userMapper.selectAll();</span><br></pre></table></figure><p>然后在mapper中的sql语句中直接写查询条件,返回Page结果.<div class=table-container><table><thead><tr><th>问题/注意点<th>说明<tbody><tr><td>startPage 必须紧跟查询语句<td>否则分页不起作用（建议不要有中间处理逻辑）<tr><td>不支持多线程共享分页上下文<td>每次分页只作用于当前线程</table></div><p><code>Page&LTT></code>：继承自 <code>ArrayList&LTT></code>，直接包含结果数据 + 分页信息；<p><code>PageInfo&LTT></code>：是一个额外封装类，包含分页信息（适合返回给前端）；<h4 id=POJO中日期序列化><a class=headerlink href=#POJO中日期序列化 title=POJO中日期序列化></a>POJO中日期序列化</h4><p><img alt=image-20250423140945684 data-src=https://s2.loli.net/2025/04/23/28JgwEfF7bZNsQz.png><p>在 Spring Boot 项目中，如果你使用的是 Jackson（Spring Boot 默认的 JSON 序列化库），<strong>可以通过配置 <code>ObjectMapper</code> 或 <code>application.yml</code> 来自定义 <code>LocalDateTime</code> / <code>LocalDate</code> / <code>LocalTime</code> 的序列化格式</strong>。<p>✅ 方法一：在全局 <code>ObjectMapper</code> 中注册时间模块（推荐）<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JacksonConfig</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@Primary</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> ObjectMapper <span class=title>objectMapper</span><span class=params>()</span> </span>{</span><br><span class=line>        ObjectMapper mapper = <span class=keyword>new</span> ObjectMapper();</span><br><span class=line></span><br><span class=line>        JavaTimeModule javaTimeModule = <span class=keyword>new</span> JavaTimeModule();</span><br><span class=line>        <span class=comment>// LocalDateTime</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalDateTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateTimeSerializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalDateTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateTimeDeserializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class=line></span><br><span class=line>        <span class=comment>// LocalDate</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalDate.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateSerializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalDate.class,</span><br><span class=line>                <span class=keyword>new</span> LocalDateDeserializer(DateTimeFormatter.ofPattern(<span class=string>"yyyy-MM-dd"</span>)));</span><br><span class=line></span><br><span class=line>        <span class=comment>// LocalTime</span></span><br><span class=line>        javaTimeModule.addSerializer(LocalTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalTimeSerializer(DateTimeFormatter.ofPattern(<span class=string>"HH:mm:ss"</span>)));</span><br><span class=line>        javaTimeModule.addDeserializer(LocalTime.class,</span><br><span class=line>                <span class=keyword>new</span> LocalTimeDeserializer(DateTimeFormatter.ofPattern(<span class=string>"HH:mm:ss"</span>)));</span><br><span class=line></span><br><span class=line>        mapper.registerModule(javaTimeModule);</span><br><span class=line>        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); <span class=comment>// 防止序列化为时间戳</span></span><br><span class=line></span><br><span class=line>        <span class=keyword>return</span> mapper;</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>✅ 方法二：使用 <code>@JsonFormat</code> 注解在字段上局部配置<p>适合只对个别字段格式化时使用：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=meta>@Data</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MyDto</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span></span><br><span class=line>    <span class=keyword>private</span> LocalDateTime createdTime;</span><br><span class=line></span><br><span class=line>    <span class=meta>@JsonFormat(pattern = "yyyy-MM-dd")</span></span><br><span class=line>    <span class=keyword>private</span> LocalDate date;</span><br><span class=line>}</span><br></pre></table></figure><h3 id=Spring-Cache><a title="Spring Cache" class=headerlink href=#Spring-Cache></a>Spring Cache</h3><p><img alt=image-20250429162721846 data-src=https://s2.loli.net/2025/04/29/J3v6auIHbXNZxkT.png><h3 id=Spring-Task><a title="Spring Task" class=headerlink href=#Spring-Task></a>Spring Task</h3><p><img alt=image-20250430210633413 data-src=https://s2.loli.net/2025/04/30/iE9YtUfMhqRXn46.png><h3 id=Websocket主动推送订单消息><a class=headerlink href=#Websocket主动推送订单消息 title=Websocket主动推送订单消息></a>Websocket主动推送订单消息</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> org.springframework.context.annotation.Bean;</span><br><span class=line><span class=keyword>import</span> org.springframework.context.annotation.Configuration;</span><br><span class=line><span class=keyword>import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class=line></span><br><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>WebSocketConfig</span> </span>{</span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> ServerEndpointExporter <span class=title>serverEndpointExporter</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> ServerEndpointExporter();</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>ServerEndpointExporter 会自动扫描所有 @ServerEndpoint 注解的类。<p>注册到 Servlet 容器的 WebSocket 运行时（ServerContainer）<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> javax.websocket.*;</span><br><span class=line><span class=keyword>import</span> javax.websocket.server.ServerEndpoint;</span><br><span class=line><span class=keyword>import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=line><span class=keyword>import</span> org.springframework.stereotype.Component;</span><br><span class=line><span class=keyword>import</span> java.io.IOException;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.CopyOnWriteArraySet;</span><br><span class=line></span><br><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@ServerEndpoint("/ws/students")</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>StudentWebSocketEndpoint</span> </span>{</span><br><span class=line>    <span class=comment>// 存储所有连接的会话（线程安全）</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> CopyOnWriteArraySet&LTSession> sessions = <span class=keyword>new</span> CopyOnWriteArraySet<>();</span><br><span class=line>    <span class=meta>@Autowired</span></span><br><span class=line>    <span class=keyword>private</span> StudentService studentService;</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnOpen</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onOpen</span><span class=params>(Session session)</span> </span>{</span><br><span class=line>        sessions.add(session);</span><br><span class=line>        <span class=keyword>try</span> {</span><br><span class=line>            session.getBasicRemote().sendText(<span class=string>"Connected to Student WebSocket"</span>);</span><br><span class=line>        } <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>            e.printStackTrace();</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnMessage</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onMessage</span><span class=params>(String message, Session session)</span> <span class=keyword>throws</span> IOException </span>{</span><br><span class=line>        <span class=comment>// 收到客户端消息，广播给所有连接</span></span><br><span class=line>        <span class=keyword>for</span> (Session s : sessions) {</span><br><span class=line>            s.getBasicRemote().sendText(<span class=string>"Message: "</span> + message);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnClose</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onClose</span><span class=params>(Session session)</span> </span>{</span><br><span class=line>        sessions.remove(session);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@OnError</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onError</span><span class=params>(Session session, Throwable throwable)</span> </span>{</span><br><span class=line>        throwable.printStackTrace();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// 广播学生更新</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>broadcastStudentUpdate</span><span class=params>(String message)</span> </span>{</span><br><span class=line>        <span class=keyword>for</span> (Session session : sessions) {</span><br><span class=line>            <span class=keyword>try</span> {</span><br><span class=line>                session.getBasicRemote().sendText(message);</span><br><span class=line>            } <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>                e.printStackTrace();</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=Apache-Echarts展示信息><a title="Apache Echarts展示信息" class=headerlink href=#Apache-Echarts展示信息></a>Apache Echarts展示信息</h3><h3 id=Apache-POI><a title="Apache POI" class=headerlink href=#Apache-POI></a>Apache POI</h3><h1 id=黑马点评><a class=headerlink href=#黑马点评 title=黑马点评></a>黑马点评</h1><p>缓存作用: 降低后端负载,提升读写速度<p>开发成本和维护一致性问题<h3 id=Redis学习><a class=headerlink href=#Redis学习 title=Redis学习></a>Redis学习</h3><p><a href=https://redis.io/docs/latest/develop/clients/jedis/ rel=noopener target=_blank>Jedis guide (Java) | Docs</a><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>redis.clients<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>jedis<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>version</span>></span>5.2.0<span class=tag>&LT/<span class=name>version</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JedisTest</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> Jedis jedis;</span><br><span class=line></span><br><span class=line>    <span class=meta>@BeforeEach</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>setUp</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=comment>// 初始化 Jedis 连接</span></span><br><span class=line>        jedis = <span class=keyword>new</span> Jedis(<span class=string>"localhost"</span>, <span class=number>6379</span>); <span class=comment>// 假设 Redis 服务运行在本地，默认端口为 6379</span></span><br><span class=line>        System.out.println(<span class=string>"Connected to Redis"</span>);</span><br><span class=line>        <span class=comment>// 清空 Redis 数据库，确保测试环境干净</span></span><br><span class=line>        jedis.flushAll();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// 在每个测试方法执行之后运行</span></span><br><span class=line>    <span class=meta>@AfterEach</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>tearDown</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=comment>// 关闭 Jedis 连接</span></span><br><span class=line>        <span class=keyword>if</span> (jedis != <span class=keyword>null</span>) {</span><br><span class=line>            jedis.close();</span><br><span class=line>            System.out.println(<span class=string>"Disconnected from Redis"</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Test</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>testString</span><span class=params>()</span> </span>{</span><br><span class=line>        String result = jedis.set(<span class=string>"name"</span>,<span class=string>"proanimer"</span>);</span><br><span class=line>        System.out.println(<span class=string>"result = "</span> + result);</span><br><span class=line>        String name = jedis.get(<span class=string>"name"</span>);</span><br><span class=line>        System.out.println(<span class=string>"name = "</span> + name);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Test</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>testHash</span><span class=params>()</span> </span>{</span><br><span class=line>        jedis.hset(<span class=string>"user:1"</span>,<span class=string>"name"</span>,<span class=string>"proanimer"</span>);</span><br><span class=line>        jedis.hset(<span class=string>"user:2"</span>, <span class=string>"age"</span>, <span class=string>"24"</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><p><img style="zoom: 50%;" alt=image-20250412221454173 data-src=https://s2.loli.net/2025/04/12/TEPKoIHGYOma4Jy.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>JedisConnectionFactory</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> JedisPool jedisPool;</span><br><span class=line>    <span class=keyword>static</span> {</span><br><span class=line>        <span class=comment>//配置连接池</span></span><br><span class=line>        JedisPoolConfig jedisPoolConfig = <span class=keyword>new</span> JedisPoolConfig();</span><br><span class=line>        jedisPoolConfig.setMaxIdle(<span class=number>10</span>);</span><br><span class=line>        jedisPoolConfig.setMaxTotal(<span class=number>10</span>);</span><br><span class=line>        jedisPoolConfig.setMinIdle(<span class=number>0</span>);</span><br><span class=line>        jedisPoolConfig.setMaxWait(Duration.of(<span class=number>10</span>, ChronoUnit.SECONDS));</span><br><span class=line>        <span class=comment>// 创建连接池</span></span><br><span class=line>        jedisPool = <span class=keyword>new</span> JedisPool(jedisPoolConfig,<span class=string>"127.0.0.1"</span>,<span class=number>6379</span>);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>static</span> Jedis <span class=title>getJedis</span><span class=params>()</span> </span>{</span><br><span class=line>        <span class=keyword>return</span> jedisPool.getResource();</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br></pre></table></figure><h3 id=Spring-Data-Redis><a title="Spring Data Redis" class=headerlink href=#Spring-Data-Redis></a>Spring Data Redis</h3><p><a href=https://spring.io/projects/spring-data-redis rel=noopener target=_blank>Spring Data Redis</a><p><img alt=image-20250413141133598 data-src=https://s2.loli.net/2025/04/13/IPJL4xzF2aGAOfN.png style=zoom:50%;><h4 id=序列化器><a class=headerlink href=#序列化器 title=序列化器></a>序列化器</h4><p>在使用 Spring Data Redis 时，序列化器（Serializer）用于<strong>将 Java 对象转换为适合存储在 Redis 中的格式</strong>（如字节数组），并在从 Redis 读取数据时将其反序列化回 Java 对象。选择合适的序列化器对于确保数据正确性以及优化性能非常重要。默认序列化器是JDK序列化器.<ol><li><code>JdkSerializationRedisSerializer</code></ol><ul><li><strong>描述</strong>：这是默认的序列化器，使用 Java 的序列化机制来处理对象。<li><strong>优点</strong>：支持任意类型的 Java 对象。<li><strong>缺点</strong>：生成的数据较大，效率较低，并且只有在同一 JVM 环境下才能正确反序列化。</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> JdkSerializationRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>StringRedisSerializer</code></ol><ul><li><strong>描述</strong>：专门用于字符串的序列化器，能够高效地处理字符串类型的数据。<li><strong>优点</strong>：简单、快速，适用于大多数键值对场景。<li><strong>缺点</strong>：仅限于字符串类型的数据。</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, String> <span class=title>stringRedisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    StringRedisTemplate template = <span class=keyword>new</span> StringRedisTemplate();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>GenericJackson2JsonRedisSerializer</code></ol><ul><li><strong>描述</strong>：使用 Jackson 库将对象序列化为 JSON 格式。<li><strong>优点</strong>：易于阅读和调试，支持复杂对象结构。<li><strong>缺点</strong>：相对于其他二进制格式（如 Protocol Buffers），JSON 的体积更大，解析速度较慢。</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> GenericJackson2JsonRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>Jackson2JsonRedisSerializer</code></ol><ul><li><strong>描述</strong>：类似于 <code>GenericJackson2JsonRedisSerializer</code>，但它允许你指定序列化的具体类型。<li><strong>优点</strong>：可以更精确地控制序列化过程。<li><strong>缺点</strong>：需要提前知道序列化对象的确切类型。</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, MyObject> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, MyObject> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    Jackson2JsonRedisSerializer&LTMyObject> serializer = <span class=keyword>new</span> Jackson2JsonRedisSerializer<>(MyObject.class);</span><br><span class=line>    template.setValueSerializer(serializer);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li><code>OxmSerializer</code></ol><ul><li><strong>描述</strong>：用于 XML 数据的序列化/反序列化。<li><strong>优点</strong>：适用于需要以 XML 格式存储数据的场景。<li><strong>缺点</strong>：XML 数据通常比 JSON 更大，处理速度也较慢。</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, Object> <span class=title>redisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, Object> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    OxmSerializer serializer = <span class=keyword>new</span> Jaxb2Marshaller(); <span class=comment>// 示例使用 JAXB</span></span><br><span class=line>    template.setValueSerializer(serializer);</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><ol><li>自定义序列化器</ol><p>根据业务需求，你也可以实现自己的序列化器，只需要实现 <code>RedisSerializer&LTT></code> 接口即可。<p>示例代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomRedisSerializer</span> <span class=keyword>implements</span> <span class=title>RedisSerializer</span><<span class=title>MyCustomType</span>> </span>{</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>byte</span>[] serialize(MyCustomType t) <span class=keyword>throws</span> SerializationException {</span><br><span class=line>        <span class=comment>// 实现序列化逻辑</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> <span class=keyword>byte</span>[<span class=number>0</span>];</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> MyCustomType <span class=title>deserialize</span><span class=params>(<span class=keyword>byte</span>[] bytes)</span> <span class=keyword>throws</span> SerializationException </span>{</span><br><span class=line>        <span class=comment>// 实现反序列化逻辑</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>null</span>;</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>// 在配置中使用自定义序列化器</span></span><br><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RedisTemplate&LTString, MyCustomType> <span class=title>customRedisTemplate</span><span class=params>(RedisConnectionFactory factory)</span> </span>{</span><br><span class=line>    RedisTemplate&LTString, MyCustomType> template = <span class=keyword>new</span> RedisTemplate<>();</span><br><span class=line>    template.setConnectionFactory(factory);</span><br><span class=line>    template.setValueSerializer(<span class=keyword>new</span> CustomRedisSerializer());</span><br><span class=line>    <span class=keyword>return</span> template;</span><br><span class=line>}</span><br></pre></table></figure><p><img alt=image-20250413160821439 data-src=https://s2.loli.net/2025/04/13/VKJzFQulyvWTSfa.png><h3 id=基于Session的登陆><a class=headerlink href=#基于Session的登陆 title=基于Session的登陆></a>基于Session的登陆</h3><p><img alt=image-20250320175751672 data-src=https://s2.loli.net/2025/03/20/VqbA8F34U17C9xZ.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br></pre><td class=code><pre><span class=line> <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> Result <span class=title>sendCode</span><span class=params>(String phone, HttpSession session)</span> </span>{</span><br><span class=line><span class=comment>//        1.校验</span></span><br><span class=line>      <span class=comment>/*  String phoneRegex = "^1[3-9]\\d{9}$";</span></span><br><span class=line><span class=comment>        if (!phone.matches(phoneRegex)) {</span></span><br><span class=line><span class=comment>            return Result.fail("手机号格式错误");</span></span><br><span class=line><span class=comment>        }*/</span></span><br><span class=line>        <span class=keyword>boolean</span> phoneInvalid = RegexUtils.isPhoneInvalid(phone);</span><br><span class=line><span class=comment>//        2.如果不符合</span></span><br><span class=line>        <span class=keyword>if</span> (phoneInvalid) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"手机号格式错误"</span>);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        3.符合,生成验证码</span></span><br><span class=line>        String code = RandomUtil.randomNumbers(<span class=number>6</span>);</span><br><span class=line><span class=comment>//        4.保存验证码到session</span></span><br><span class=line>        session.setAttribute(<span class=string>"code"</span>, code);</span><br><span class=line><span class=comment>//        5.发送验证码</span></span><br><span class=line>        log.debug(StrUtil.format(<span class=string>"发送验证码成功，验证码：{}"</span>, code));</span><br><span class=line><span class=comment>//        返回ok</span></span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> Result <span class=title>login</span><span class=params>(LoginFormDTO loginForm, HttpSession session)</span> </span>{</span><br><span class=line><span class=comment>//        1.校验手机号和验证码</span></span><br><span class=line>        String phone = loginForm.getPhone();</span><br><span class=line>        <span class=keyword>boolean</span> phoneInvalid = RegexUtils.isPhoneInvalid(phone);</span><br><span class=line>        <span class=keyword>if</span> (phoneInvalid) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"手机号格式错误"</span>);</span><br><span class=line>        }</span><br><span class=line>        String code = loginForm.getCode();</span><br><span class=line>        String codeInSession = (String) session.getAttribute(<span class=string>"code"</span>);</span><br><span class=line>        <span class=keyword>if</span> (!code.equals(codeInSession)) {</span><br><span class=line>            <span class=keyword>return</span> Result.fail(<span class=string>"验证码错误"</span>);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        2.查询用户</span></span><br><span class=line>        User user = query().eq(<span class=string>"phone"</span>, phone).one();</span><br><span class=line>        <span class=keyword>if</span> (user == <span class=keyword>null</span>) {</span><br><span class=line><span class=comment>//            不存在 创建用户</span></span><br><span class=line>            user = createUserWithPhone(phone);</span><br><span class=line>        }</span><br><span class=line><span class=comment>//        3.保存用户信息到session</span></span><br><span class=line>        session.setAttribute(<span class=string>"user"</span>, BeanUtil.copyProperties(user, UserDTO.class));</span><br><span class=line>        <span class=keyword>return</span> Result.ok();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> User <span class=title>createUserWithPhone</span><span class=params>(String phone)</span> </span>{</span><br><span class=line>        User user = <span class=keyword>new</span> User();</span><br><span class=line>        user.setPhone(phone);</span><br><span class=line>        user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomNumbers(<span class=number>8</span>));</span><br><span class=line>        save(user);</span><br><span class=line>        <span class=keyword>return</span> user;</span><br><span class=line>    }</span><br></pre></table></figure><p>注册登录问题,可以使用拦截器方便注册登陆以及校验权限, 从基于session到基于redis<p>基于session的登陆, 验证码存在session中,在拦截器中获取session或者请求头中的信息,<p>可以使用ThreadLocal,在拦截器方法中存储用户信息避免其他线程访问. 登陆成功将发送生成的token给客户端,并且存在服务端session中.<p>每次访问,在进行权限校验中,根据token在session得到用户信息,如果有就通过权限校验.<p>通过重写WebMvcConfigure类添加拦截器与路径,重写Interceptor类<blockquote><p>WebMvcConfigure类可以用于添加拦截器与静态资源处理以及CORS等等.<p>Interceptor类允许你在请求被 <strong>Controller 处理之前</strong>、<strong>Controller 处理之后但在视图渲染之前</strong>、以及<strong>整个请求处理完成之后</strong>进行拦截和处理。它提供了一种灵活的方式来对请求进行预处理和后处理，而无需修改 Controller 或业务逻辑代码。<p><code>HandlerInterceptor</code> 的主要作用是实现 AOP（面向切面编程）的理念，对 Web 请求处理流程进行<strong>横向切割</strong>，用于实现一些通用的功能，例如：<ol><li><strong>权限校验/身份认证：</strong> 在请求到达 Controller 之前，检查用户是否已登录或是否有权限访问某个资源。<li><strong>日志记录：</strong> 记录请求的进入、退出时间，以及请求参数、响应状态等信息。<li><strong>性能监控：</strong> 计算请求的处理时间，进行性能分析。<li><strong>数据预处理：</strong> 在 Controller 处理之前对请求参数进行一些统一的格式化或校验。<li><strong>跨域处理：</strong> 添加或修改响应头，处理 CORS 相关的逻辑。<li><strong>国际化：</strong> 根据用户请求的语言设置，切换对应的语言环境。<li><strong>会话管理：</strong> 检查会话状态，或进行会话续期。</ol></blockquote><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RefreshTokenInterceptor</span> <span class=keyword>implements</span> <span class=title>HandlerInterceptor</span> </span>{</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=title>RefreshTokenInterceptor</span><span class=params>(StringRedisTemplate stringRedisTemplate)</span> </span>{</span><br><span class=line>        <span class=keyword>this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>boolean</span> <span class=title>preHandle</span><span class=params>(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class=keyword>throws</span> Exception </span>{</span><br><span class=line>        <span class=comment>// 1.获取请求头中的token</span></span><br><span class=line>        String token = request.getHeader(<span class=string>"authorization"</span>);</span><br><span class=line>        <span class=keyword>if</span> (StrUtil.isBlank(token)) {</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=comment>// 2.基于TOKEN获取redis中的用户</span></span><br><span class=line>        String key  = LOGIN_USER_KEY + token;</span><br><span class=line>        Map&LTObject, Object> userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class=line>        <span class=comment>// 3.判断用户是否存在</span></span><br><span class=line>        <span class=keyword>if</span> (userMap.isEmpty()) {</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=comment>// 5.将查询到的hash数据转为UserDTO</span></span><br><span class=line>        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, <span class=keyword>new</span> UserDTO(), <span class=keyword>false</span>);</span><br><span class=line>        <span class=comment>// 6.存在，保存用户信息到 ThreadLocal</span></span><br><span class=line>        UserHolder.saveUser(userDTO);</span><br><span class=line>        <span class=comment>// 7.刷新token有效期</span></span><br><span class=line>        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class=line>        <span class=comment>// 8.放行</span></span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCompletion</span><span class=params>(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class=keyword>throws</span> Exception </span>{</span><br><span class=line>        <span class=comment>// 移除用户</span></span><br><span class=line>        UserHolder.removeUser();</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=集群的session共享问题><a class=headerlink href=#集群的session共享问题 title=集群的session共享问题></a>集群的session共享问题</h4><p><img alt=image-20250414154105418 data-src=https://s2.loli.net/2025/04/14/xZREAUpPzkQBiVF.png><h4 id=基于Redis的短信登陆><a class=headerlink href=#基于Redis的短信登陆 title=基于Redis的短信登陆></a>基于Redis的短信登陆</h4><p><img alt=image-20250414161242250 data-src=https://s2.loli.net/2025/04/14/bVvPz25pxkyMqB9.png><p>基于session的问题 多台tomcat不共享session<p>使用基于redis的登陆注册<p>当登陆时，如果使用账号+手机验证码形式，当前端发送验证码请求，将手机号码和生成的手机验证码存在对应的缓存中，然后登陆时校验。成功就返回一个token，然后将token存在缓存中.可以使用user_id作key.<p>在使用session登陆时,存储信息直接利用了servlet,tomcat提供的session机制,服务器会创建对应会话的session并返回JSESSIONID给客户端,客户端会主动携带该id,服务器直接访问对应的session对象及其包含属性即可.<p>而使用redis登陆,确定缓存的值对象类型<p><img alt=image-20250715141126358 data-src=https://s2.loli.net/2025/07/15/5lLUKEwJnexXoua.png><p>当进入用户权限网页时,读取httpservletRequest中的参数,从请求中获取token,在缓存中查找,找到就满足. 客户端将token放在sessionStorage中进行保存,请求时放在header中的<code>authorization</code>头中,服务端在对应请求头中拿到token.<h4 id=优化拦截器><a class=headerlink href=#优化拦截器 title=优化拦截器></a>优化拦截器</h4><p><img alt=image-20250414210106336 data-src=https://s2.loli.net/2025/04/14/36voF12n9YepEkI.png><p>原本的拦截器只拦截需要权限的controller,但是如果已经有cookie的用户只访问不需要权限的controller就不会更新redis. 也就是说已登陆用户访问不需要权限的网页不会更新缓存,导致一段时间后失效.<p><img alt=image-20250414210226312 data-src=https://s2.loli.net/2025/04/14/sUTIzrhMgqNpR7H.png><p>因此添加全局拦截器,访问所有页面,如果是已登陆用户,更新缓存中TTL,否则什么也不做,直接放行,对于需要权限的拦截器进行检测.<h4 id=登陆以及权限校验关键问题><a class=headerlink href=#登陆以及权限校验关键问题 title=登陆以及权限校验关键问题></a>登陆以及权限校验关键问题</h4><p><strong>基于session或者基于redis缓存</strong><p>session存在tomcat集群不共享的问题,当请求切换到不同tomcat服务时导致数据丢失<p><strong>拦截器配置 通过interceptor或者自己通过AOP实现校验</strong><p>通过拦截器,在请求或者session中拿到校验信息<p>可以使用ThreadLocal在拦截器中直接在session或者redis中获得信息<p><strong>此外还有基于JWT的无状态认证机制,服务器本身不存储session.</strong><p>在登陆成功后,客户端每次携带jwt,JWT本身存储了用户的一些关键信息,具体来说,JWT包含头部,负载,签名.<p>头部包含算法类型,负载包括注册声明、公共声明以及私有声明. 签名是通过密钥加密后的头部和负载加密.<blockquote><p>Payload 部分是 Base64url 编码的，不是加密的。这意味着任何人都可以解码 Payload 并读取其中的内容。因此，绝不能在 Payload 中存放敏感信息</blockquote><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>{</span><br><span class=line>  <span class=attr>"alg"</span>: <span class=string>"HS256"</span>,</span><br><span class=line>  <span class=attr>"typ"</span>: <span class=string>"JWT"</span>,</span><br><span class=line>  </span><br><span class=line>   <span class=attr>"sub"</span>: <span class=string>"user_123"</span>,        <span class=comment>// 用户ID</span></span><br><span class=line>  <span class=attr>"name"</span>: <span class=string>"Alice Smith"</span>,    <span class=comment>// 用户名</span></span><br><span class=line>  <span class=attr>"roles"</span>: [<span class=string>"admin"</span>, <span class=string>"user"</span>], <span class=comment>// 用户角色</span></span><br><span class=line>  <span class=attr>"exp"</span>: <span class=number>1752496261</span>,        <span class=comment>// 过期时间戳</span></span><br><span class=line>  <span class=attr>"iat"</span>: <span class=number>1752492661</span>         <span class=comment>// 签发时间戳  //注意这些部分都会进行base64编码</span></span><br><span class=line>  </span><br><span class=line>  <span class=string>"signature"</span>:HMACSHA256(base64UrlEncode(header) + <span class=string>"."</span> + base64UrlEncode(payload), secret) <span class=comment>//使用 Header 中指定的算法（如 HS256 或 RS256）和服务器端的密钥 (Secret Key)（对于对称加密，如 HS256）或私钥（对于非对称加密，如 RS256）对连接后的字符串进行签名。</span></span><br><span class=line>}</span><br></pre></table></figure><p>最终，这三部分用点连接起来，就构成了完整的 JWT 字符串，例如： <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code><h3 id=商户查询缓存><a class=headerlink href=#商户查询缓存 title=商户查询缓存></a>商户查询缓存</h3><p><img alt=image-20250414220321389 data-src=https://s2.loli.net/2025/04/14/HTdpXizlnASGQqv.png><p><img alt=image-20250414233753517 data-src=https://s2.loli.net/2025/04/14/jc9OQH8oFwMLz5K.png><h3 id=缓存更新策略><a class=headerlink href=#缓存更新策略 title=缓存更新策略></a>缓存更新策略</h3><p><img alt=image-20250415103603707 data-src=https://s2.loli.net/2025/04/15/p72NIzH9MfZaxnR.png><p><img alt=image-20250415103926298 data-src=https://s2.loli.net/2025/04/15/y7bowaDxTL2f8GJ.png><div class=table-container><table><thead><tr><th>策略<th>读操作<th>写操作<th>优点<th>缺点<th>适用场景<tbody><tr><td><strong>Cache Aside</strong><td>先查缓存，再查数据库<td>更新数据库后删除缓存<td>简单、灵活、一致性较好<td>存在短暂不一致、未命中时性能较差<td>数据读多写少、一致性要求不高<tr><td><strong>Read/Write Through</strong><td>缓存负责未命中处理<td>缓存负责同步到数据库<td>透明性好、一致性好<td>复杂性高、可能成为性能瓶颈<td>数据一致性要求高<tr><td><strong>Write Behind Caching</strong><td>先查缓存，再查数据库<td>异步批量写回数据库<td>写性能高、吞吐量大<td>数据丢失风险、一致性差<td>数据写多读少、一致性要求低</table></div><p><img alt=image-20250415105910579 data-src=https://s2.loli.net/2025/04/15/TU3KbireNcB4G67.png><p><img alt=image-20250415111429325 data-src=https://s2.loli.net/2025/04/15/CFEZY2mKqnwljAW.png><p><img alt=image-20250415111703513 data-src=https://s2.loli.net/2025/04/15/LqgUJKSZD9Gfad6.png><div class=table-container><table><thead><tr><th>名称<th>触发场景<th>结果<th>常见解决方案<tbody><tr><td>缓存穿透<td>请求的数据本就不存在（DB 也无）<td>每次请求都打到数据库<td>缓存空值、布隆过滤器<tr><td>缓存击穿<td>某个热点 key 恰好过期了<td>大量请求同时访问 DB，瞬时压力大<td>加互斥锁、热点预热<tr><td>缓存雪崩<td>大量 key 在同一时间过期<td>缓存失效，数据库压力激增<td>加随机过期时间、限流、降级</table></div><p>布隆过滤器是基于一个 <strong>bit 数组</strong> + 多个 <strong>哈希函数</strong>：<ol><li>初始创建一个很大的 bit 数组（如 1 亿位，全是 0）。<li>插入元素时，用多个哈希函数对元素哈希，得到多个下标位置，把这些位置设为 1。<li>查询时，对待查元素用相同的哈希函数求下标：<ul><li>若所有对应 bit 位都是 1 → 可能存在<li>有任意一个 bit 是 0 → 一定不存在</ul></ol><p><img alt=image-20250415133050673 data-src=https://s2.loli.net/2025/04/15/MozbdO6Ly2aCI4E.png><p><img alt=image-20250415143221507 data-src=https://s2.loli.net/2025/04/15/aujZnwSzgiUxloL.png><p><img alt=image-20250415144016106 data-src=https://s2.loli.net/2025/04/15/xBTlfUn6WmDpwIJ.png><p><img alt=image-20250415144408811 data-src=https://s2.loli.net/2025/04/15/Tcd5tCruUKo6wvM.png><p><img alt=image-20250415144944179 data-src=https://s2.loli.net/2025/04/15/x5ayubhtcrSK8qQ.png><p><img alt=image-20250415145118864 data-src=https://s2.loli.net/2025/04/15/EBpdcml8I7tLvxU.png><h3 id=优惠券秒杀><a class=headerlink href=#优惠券秒杀 title=优惠券秒杀></a>优惠券秒杀</h3><p>全局ID生成器,在分布式系统下用来生成全局唯一ID的工具.<p>满足:唯一性,高可用,高性能,递增性,安全性.<p><img alt=image-20250415194042557 data-src=https://s2.loli.net/2025/04/15/3LSmM7p8e5gfXcN.png><p><img alt=image-20250415231649294 data-src=https://s2.loli.net/2025/04/15/tXm5rvyNMhbxeYL.png style=zoom:67%;><p><img alt=image-20250416162534054 data-src=https://s2.loli.net/2025/04/16/zTXyB8Uo7RKWmc2.png style=zoom:67%;><h4 id=悲观锁-乐观锁><a title="悲观锁  乐观锁" class=headerlink href=#悲观锁-乐观锁></a>悲观锁 乐观锁</h4><p><img alt=image-20250416192913692 data-src=https://s2.loli.net/2025/04/16/9QRuCerNJpmcHaf.png><p>乐观锁的关键是判断之前查询得到的数据是否被修改过.常见方式:<ol><li>版本号法</ol><p>给数据添加版本号,每次更新的时候查询数据对应的版本,如果版本号跟之前的不同则表明更新过了.<p><img alt=image-20250416194812142 data-src=https://s2.loli.net/2025/04/16/3tu9mqXVNyoDZYT.png><ol><li>CAS法</ol><p><img alt=image-20250416212059026 data-src=https://s2.loli.net/2025/04/16/eCKmRn4QDs7pSLA.png style=zoom:67%;><p>一人一单,使用悲观锁,加锁. 但在分布式系统下,多个实例下进程不相干,无法进行线程同步,需要实现分布式锁.<p>分布式锁:满足分布式系统或集群模式下多进程可见并且互斥的锁<p><img alt=image-20250417095719500 data-src=https://s2.loli.net/2025/04/17/t4sZY1NizPOvRcX.png><p>基于Redis的分布式锁<p>使用<code>setnx</code><p><img alt=image-20250417124148443 data-src=https://s2.loli.net/2025/04/17/JBC3Xe1HPmpfnwa.png><p>注意如果出现业务耗时超过key的ttl,导致其他线程拿到锁,在删除锁时检查value是否一致。<p>redis lua脚本<p><img alt=image-20250417133641854 data-src=https://s2.loli.net/2025/04/17/X7GMsSg59QjnaRf.png><p><img alt=image-20250417143320701 data-src=https://s2.loli.net/2025/04/17/AG1vHk7s2u6FexB.png><h4 id=Redisson可重入锁><a class=headerlink href=#Redisson可重入锁 title=Redisson可重入锁></a>Redisson可重入锁</h4><p><img alt=image-20250417152425433 data-src=https://s2.loli.net/2025/04/17/2jkGcgNIYylmQL8.png><h4 id=可重试-更新超时时间><a class=headerlink href=#可重试-更新超时时间 title=可重试/更新超时时间></a>可重试/更新超时时间</h4><p><img alt=image-20250417181249028 data-src=https://s2.loli.net/2025/04/17/lytxPu8ZirBRH5s.png><p><img alt=image-20250417181558824 data-src=https://s2.loli.net/2025/04/17/EYhwIoeVBgmkHfU.png><p>所以利用redis缓存作分布式锁的需要核心解决的<strong>可重入</strong>和<strong>超时重试机制</strong>.<h4 id=主从一致性问题><a class=headerlink href=#主从一致性问题 title=主从一致性问题></a>主从一致性问题</h4><p>一、单机多实例（适合开发和测试环境）<p>配置不同的实例端口,多个配置文件启动多个实例.<p>二、多机集群,在每台服务器上创建一个 Redis 配置文件（如 <code>redis-cluster.conf</code>），并添加以下内容：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>port 6379</span><br><span class=line>cluster-enabled yes</span><br><span class=line>cluster-config-file nodes.conf</span><br><span class=line>cluster-node-timeout 5000</span><br><span class=line>appendonly yes</span><br></pre></table></figure><ul><li><code>cluster-enabled yes</code>：启用集群模式。<li><code>cluster-config-file nodes.conf</code>：指定集群节点配置文件。<li><code>cluster-node-timeout 5000</code>：设置节点超时时间（毫秒）</ul><p><img alt=image-20250417232039727 data-src=https://s2.loli.net/2025/04/17/UiIyGpJA4RoP7Dh.png><p><img alt=image-20250418111401540 data-src=https://s2.loli.net/2025/04/18/cn3NCI9O24upUlg.png><p><img alt=image-20250418143910127 data-src=https://s2.loli.net/2025/04/18/IRiKpLMBV1cCUs3.png><p><img alt=image-20250418182224084 data-src=https://s2.loli.net/2025/04/18/bS3QAUKsTHoRY1q.png><h4 id=Redis消息队列><a class=headerlink href=#Redis消息队列 title=Redis消息队列></a>Redis消息队列</h4><p><img alt=image-20250418200244539 data-src=https://s2.loli.net/2025/04/18/ayrfSevJ8TdGUF3.png><h4 id=基于list数据结构><a class=headerlink href=#基于list数据结构 title=基于list数据结构></a>基于list数据结构</h4><p>Redis列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）一个列表最多可以包含 2^32^ -1个元素。主要利用<code>BRPOP</code>移除列表元素,如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止. 同时通过<code>LPUSH</code>添加值.<p><img alt=image-20250418203901472 data-src=https://s2.loli.net/2025/04/18/9ih5CDwLBlKNERW.png><h5 id=pubsub-点对点消息消息模型><a title="pubsub 点对点消息消息模型" class=headerlink href=#pubsub-点对点消息消息模型></a>pubsub 点对点消息消息模型</h5><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。<p>Redis 客户端可以订阅任意数量的频道。<p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2014/11/pubsub2.png><p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2014/11/pubsub1.png><p><img alt=image-20250418210559430 data-src=https://s2.loli.net/2025/04/18/7LEADu5klUBta8Q.png><p><img alt=image-20250418210832702 data-src=https://s2.loli.net/2025/04/18/2lE9g7iU3WBpsIy.png><h5 id=Stream><a class=headerlink href=#Stream title=Stream></a>Stream</h5><p>Redis Stream 是 Redis 5.0 版本新增加的数据结构。<p>Redis Stream 主要用于消息队列(MQ，Message Queue),Redis 本身是有一个 Redis 发布订阅 (pub/sub) 来实现消息队列的功能，但它有个缺点就是消<strong>息无法持久化，如果出现网络断开、Redis 宕机等，消息就会被丢弃</strong>。<p>简单来说发布订阅 (pub/sub) 可以分发消息，但<strong>无法记录历史消息。</strong><p><strong>而 Redis Stream 提供了消息的持久化和主备复制功能</strong>，可以让任何客户端访问任何时刻的数据，并且能记住每一个客户端的访问位置，还能保证消息不丢失。<p><img alt=img data-src=https://www.runoob.com/wp-content/uploads/2020/09/en-us_image_0167982791.png><ul><li><strong>Stream</strong>: 在 Redis 中，一个 Stream 就是一个追加日志类型的键值对集合。<li><strong>Entry</strong>: 每个流中的元素称为 Entry 或者 Message，由唯一标识符（ID）和数据字段组成。<li><strong>Consumer Group</strong>: 允许不同的消费者组从同一个流中读取消息，每个组可以独立地跟踪自己已经消费的消息位置。<li><strong>ID</strong>: 每条消息都有一个唯一的 ID，格式为 <code>&LTtimestamp>-&LTsequence></code>，其中时间戳是消息添加时的时间，序列号用于区分同一毫秒内添加的消息。</ul><p><img alt=image-20250418223626722 data-src=https://s2.loli.net/2025/04/18/N41xhBcZ6qTWUiG.png><p><img style="zoom: 33%;" alt=image-20250418224505431 data-src=https://s2.loli.net/2025/04/18/JE9ZNCxDHaBWpw1.png><h5 id=基于Stream的消息队列-消费者组><a class=headerlink href=#基于Stream的消息队列-消费者组 title=基于Stream的消息队列-消费者组></a>基于Stream的消息队列-消费者组</h5><p><img alt=image-20250418225321965 data-src=https://s2.loli.net/2025/04/18/oTspnQeVrkqgOcv.png><p>给消费者分类,消息漏读,消息确认避免消息丢失.<div class=table-container><table><thead><tr><th>命令<th>作用<tbody><tr><td><code>XADD</code><td>添加消息到 Stream<tr><td><code>XRANGE</code> / <code>XREVRANGE</code><td>范围读取消息（正/反向）<tr><td><code>XREAD</code><td>阻塞或非阻塞读取消息<tr><td><code>XGROUP CREATE</code><td>创建消费者组<tr><td><code>XREADGROUP</code><td>按消费者组读取消息<tr><td><code>XACK</code><td>确认消息已处理<tr><td><code>XPENDING</code><td>查看待处理（未 ack）消息<tr><td><code>XDEL</code><td>删除指定消息<tr><td><code>XTRIM</code><td>裁剪旧消息，控制 Stream 大小<tr><td><code>XLEN</code><td>获取 Stream 长度<tr><td><code>XINFO</code><td>获取 Stream / Consumer 详细信息</table></div><h4 id=创建组><a class=headerlink href=#创建组 title=创建组></a>创建组</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XGROUP CREATE mystream mygroup $ MKSTREAM</span><br></pre></table></figure><blockquote><p>创建名为 <code>mygroup</code> 的消费者组，<code>$</code> 从最新消息开始消费，<code>MKSTREAM</code> 可自动创建 Stream。</blockquote><h4 id=读取消息><a class=headerlink href=#读取消息 title=读取消息></a>读取消息</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XREADGROUP GROUP mygroup consumer1 COUNT 2 STREAMS mystream ></span><br></pre></table></figure><blockquote><p><code>></code> 表示读取尚未分配的消息（新消息）。</blockquote><h4 id=消息确认><a class=headerlink href=#消息确认 title=消息确认></a>消息确认</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XACK mystream mygroup 1686900000000-0</span><br></pre></table></figure><h4 id=查看未确认消息><a class=headerlink href=#查看未确认消息 title=查看未确认消息></a>查看未确认消息</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>XPENDING mystream mygroup</span><br></pre></table></figure><div class=table-container><table><thead><tr><th>命令<th>说明<tbody><tr><td><code>XINFO STREAM mystream</code><td>查看 stream 本体信息<tr><td><code>XINFO GROUPS mystream</code><td>查看所有消费者组信息<tr><td><code>XINFO CONSUMERS mystream mygroup</code><td>查看某个消费者组中各个消费者状态</table></div><p><img alt=image-20250418233032176 data-src=https://s2.loli.net/2025/04/18/sVrCm1K7YTewhaq.png><p>消费者组中的多消费者争抢消息体现在<p>在 Redis Stream 中使用 <strong>消费者组（Consumer Group）</strong> 时，有个关键的机制是：<blockquote><p>➤ <strong>同一个消费者组内，一个消息只会被分配给一个消费者处理。</strong></blockquote><p>这意味着：<ul><li><p>如果消费者 A <strong>已经读取并 ack（确认）了一条消息</strong>，那么：</p> <ul><li>同组内的消费者 B 是 <strong>无法再读取这条消息</strong> 的。<li>除非你专门指定消息 ID 重新读取（例如用 <code>XREADGROUP</code> + 指定 ID）。</ul><li><p>如果你希望 <strong>消费者 B</strong> 能“读到之前被其他消费者已处理的消息”，你必须显式指定 ID，并该消息<strong>未被 ack</strong>或使用 <code>XPENDING</code> 查找。</p> <h5 id=✅如何让消费者读取“历史消息”？><a class=headerlink href=#✅如何让消费者读取“历史消息”？ title=✅如何让消费者读取“历史消息”？></a>✅如何让消费者读取“历史消息”？</h5><p>场景 1：消息还未被 ack（pending）</p> <p>可以通过 <code>XPENDING</code> + <code>XCLAIM</code> 把消息“抢过来”：</p> <figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>javaCopyEditPendingMessages pending = stringRedisTemplate.ops<span class=constructor>ForStream()</span></span><br><span class=line>    .pending(<span class=string>"mystream"</span>, <span class=string>"mygroup"</span>, <span class=module-access><span class=module><span class=identifier>Range</span>.</span></span>unbounded<span class=literal>()</span>, <span class=number>10</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>for</span> (PendingMessage message : pending) {</span><br><span class=line>    <span class=comment>// 把未 ack 的消息交给当前消费者</span></span><br><span class=line>    List&LTMapRecord&LTString, Object, Object>> records = stringRedisTemplate.ops<span class=constructor>ForStream()</span>.claim(</span><br><span class=line>        <span class=module-access><span class=module><span class=identifier>Consumer</span>.</span></span>from(<span class=string>"mygroup"</span>, <span class=string>"consumer2"</span>),</span><br><span class=line>        <span class=module-access><span class=module><span class=identifier>Duration</span>.</span></span><span class=keyword>of</span><span class=constructor>Seconds(5)</span>,</span><br><span class=line>        message.get<span class=constructor>Id()</span></span><br><span class=line>    );</span><br><span class=line>}</span><br></pre></table></figure> <p>场景 2：消息已被 ack，想重复读取</p> <p>Redis 默认设计下是不会让你“重复消费”被 ack 的消息的，<strong>但你可以手动读取它（不是 group 模式）</strong>：</p> <figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// 不使用消费者组，直接用 XREAD + ID</span></span><br><span class=line>List&LTMapRecord&LTString, Object, Object>> records = stringRedisTemplate.opsForStream()</span><br><span class=line>    .read(StreamOffset.fromStart(<span class=string>"mystream"</span>)); <span class=comment>// 或者用具体 ID</span></span><br></pre></table></figure> <p>也可以用 <code>XRANGE</code> 来精确读取：</p> <figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// 获取某条历史消息</span></span><br><span class=line>stringRedisTemplate.opsForStream()</span><br><span class=line>    .range(<span class=string>"mystream"</span>, Range.closed(<span class=string>"1682390889639-0"</span>, <span class=string>"1682390889639-0"</span>));</span><br></pre></table></figure> <p>| 场景 | 是否能重新读取 |<br>| —————————————————- | ——————————————— |<br>| 消费者组内，消息已被 ack | ❌（除非用非 group 方式手动读） |<br>| 消费者组内，消息未被 ack（pending） | ✅（可以用 XCLAIM 抢回来） |<br>| 想让多个消费者都能读一条消息 | ❌（组内不支持；需非 group 读） |</p></ul><p><img alt=image-20250418233143096 data-src=https://s2.loli.net/2025/04/18/ay8uA5fSi3RvTMV.png><p><img alt=image-20250419131039088 data-src=https://s2.loli.net/2025/04/19/4rg9LteAzoDlaWb.png style=zoom:50%;><p><img alt=image-20250419131059130 data-src=https://s2.loli.net/2025/04/19/muwJasz9gGTxAHK.png><h3 id=达人探店><a class=headerlink href=#达人探店 title=达人探店></a>达人探店</h3><h4 id=点赞功能><a class=headerlink href=#点赞功能 title=点赞功能></a>点赞功能</h4><p><img alt=image-20250420143555600 data-src=https://s2.loli.net/2025/04/20/p92Zqc4evEjimXY.png><h4 id=点赞排行榜><a class=headerlink href=#点赞排行榜 title=点赞排行榜></a>点赞排行榜</h4><p><img alt=image-20250420144640978 data-src=https://s2.loli.net/2025/04/20/Y2jI3QHEemkOBvi.png><h4 id=好友关注><a class=headerlink href=#好友关注 title=好友关注></a>好友关注</h4><p>写两个接口,一个查看是否关注,另一个进行关注或取关.<p>关注的数据表设计为user_id和follower_id. 为一个关注记录<p><img alt=image-20250420200822771 data-src=https://s2.loli.net/2025/04/20/OqkUF4G21LYZM5K.png><p><img alt=image-20250420200856032 data-src=https://s2.loli.net/2025/04/20/hNcu5avy2WmPBMk.png><h4 id=共同关注><a class=headerlink href=#共同关注 title=共同关注></a>共同关注</h4><p><img alt=image-20250420200600057 data-src=https://s2.loli.net/2025/04/20/thV71ZUKQlaqs3i.png><p>在新增关注时添加缓存,同时利用redis中的set交集操作在缓存中得到共同关注<h4 id=关注推送><a class=headerlink href=#关注推送 title=关注推送></a>关注推送</h4><p><img alt=image-20250420220334492 data-src=https://s2.loli.net/2025/04/20/gCqrxOB86TdfhLb.png><p><img alt=image-20250421092155097 data-src=https://s2.loli.net/2025/04/21/8wXL5PpFBWu1c6K.png><p>通过推模式,通过分页滚动读取关注用户发布的博客数据. 用户发布博客时将博客id加入关注自己的粉丝的收件箱, 使用sorted set,以时间戳为score(即推模式)<p><img alt=image-20250421224913326 data-src=https://s2.loli.net/2025/04/21/9IYeW5iocs3u1PB.png><p>关键是利用最新的时间戳去拿最新的博客id,同时利用偏移量滤去相同的时间戳(默认不会重复). 如果考虑发布时间重复,也可以在存储score时在时间戳基础上加一个随机值避免score重复.<h4 id=附近商户><a class=headerlink href=#附近商户 title=附近商户></a>附近商户</h4><p><a href=https://www.runoob.com/redis/redis-geo.html rel=noopener target=_blank>Redis GEO | 菜鸟教程</a><p>Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，该功能在 Redis 3.2 版本新增。<p>Redis GEO 操作方法有：<ul><li>geoadd：添加地理位置的坐标。<li>geopos：获取地理位置的坐标。<li>geodist：计算两个位置之间的距离。<li>georadius：根据用户给定的经纬度坐标来获取指定范围内的地理位置集合。<li>georadiusbymember：根据储存在位置集合里面的某个地点获取指定范围内的地理位置集合。<li>geohash：返回一个或多个位置对象的 geohash 值。</ul><p>geoadd 用于存储指定的地理空间位置，可以将一个或多个经度(longitude)、纬度(latitude)、位置名称(member)添加到指定的 key 中。<p>geoadd 语法格式如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>GEOADD key longitude latitude member [longitude latitude member ...]</span><br></pre></table></figure><ul><li>m ：米，默认单位。<li>km ：千米。<li>mi ：英里。<li>ft ：英尺。<li>WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。<li>WITHCOORD: 将位置元素的经度和纬度也一并返回。<li>WITHHASH: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大。<li>COUNT 限定返回的记录数。<li>ASC: 查找结果根据距离从近到远排序。<li>DESC: 查找结果根据从远到近排序。</ul><h4 id=用户签到><a class=headerlink href=#用户签到 title=用户签到></a>用户签到</h4><p><img alt=image-20250422105634699 data-src=https://s2.loli.net/2025/04/22/61cqOWxZMwnfemh.png><p><img alt=image-20250422111632294 data-src=https://s2.loli.net/2025/04/22/aGspbuONkSMdqxf.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>LocalDateTime now = LocalDateTime.now();</span><br><span class=line><span class=keyword>int</span> dayOfYear = now.getDayOfYear();</span><br><span class=line><span class=keyword>int</span> year = now.getYear();</span><br><span class=line>String key = SIGN_KEY + UserHolder.getUser().getId()+ <span class=string>":"</span> + year;</span><br><span class=line>Boolean signSuccess = stringRedisTemplate.opsForValue().setBit(key, dayOfYear-<span class=number>1</span>, <span class=keyword>true</span>);</span><br><span class=line><span class=keyword>if</span> (BooleanUtil.isTrue(signSuccess)) {</span><br><span class=line>    <span class=keyword>return</span> Result.ok();</span><br><span class=line>}<span class=keyword>else</span>{</span><br><span class=line>    <span class=keyword>return</span> Result.fail(<span class=string>"签到失败"</span>);</span><br><span class=line>}</span><br></pre></table></figure><h4 id=签到统计><a class=headerlink href=#签到统计 title=签到统计></a>签到统计</h4><p>使用<code>bitfield</code>查询一个范围内的二进制返回十进制数据.<p><img alt=image-20250422121102888 data-src=https://s2.loli.net/2025/04/22/dfuNzSwYlVOsJD1.png><h4 id=UV统计-HyperLogLog><a title="UV统计  HyperLogLog" class=headerlink href=#UV统计-HyperLogLog></a>UV统计 HyperLogLog</h4><p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定 的、并且是很小的。<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。<p><img alt=image-20250422121540587 data-src=https://s2.loli.net/2025/04/22/MEm6zF5nt28TBch.png><p><img alt=image-20250422122336390 data-src=https://s2.loli.net/2025/04/22/ztXRO9DFqkU68xV.png><h1 id=EasyChat><a class=headerlink href=#EasyChat title=EasyChat></a>EasyChat</h1><h3 id=登录注册><a class=headerlink href=#登录注册 title=登录注册></a>登录注册</h3><p><img alt=image-20250502155041889 data-src=https://s2.loli.net/2025/05/02/C8LFUSamDZfsJPA.png><p><img alt=image-20250502195913653 data-src=https://s2.loli.net/2025/05/02/WABFut1yEYeLSPa.png><h4 id=登陆><a class=headerlink href=#登陆 title=登陆></a>登陆</h4><p>登陆时检查心跳缓存避免别处登陆,完成后保存用户信息缓存,并查询联系人存在缓存中.<h4 id=注册><a class=headerlink href=#注册 title=注册></a>注册</h4><p>注册完成后,主要是创建了机器人账号并加入了会话<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br></pre><td class=code><pre><span class=line>Date curDate = <span class=keyword>new</span> Date();</span><br><span class=line></span><br><span class=line>SysSettingDto sysSettingDto = redisComponet.getSysSetting();</span><br><span class=line>String contactId = sysSettingDto.getRobotUid();</span><br><span class=line>String contactName = sysSettingDto.getRobotNickName();</span><br><span class=line>String senMessage = sysSettingDto.getRobotWelcome();</span><br><span class=line>senMessage = StringTools.cleanHtmlTag(senMessage);</span><br><span class=line><span class=comment>//增加机器人好友</span></span><br><span class=line>UserContact userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>userContact.setUserId(userId);</span><br><span class=line>userContact.setContactId(contactId);</span><br><span class=line>userContact.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>userContact.setCreateTime(curDate);</span><br><span class=line>userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>userContact.setLastUpdateTime(curDate);</span><br><span class=line>userContactMapper.insert(userContact);</span><br><span class=line></span><br><span class=line><span class=comment>//增加会话信息</span></span><br><span class=line>String sessionId = StringTools.getChatSessionId4User(<span class=keyword>new</span> String[]{userId, contactId});</span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(senMessage);</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insert(chatSession);</span><br><span class=line></span><br><span class=line>ChatSessionUser applySessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>applySessionUser.setUserId(userId);</span><br><span class=line>applySessionUser.setContactId(contactId);</span><br><span class=line>applySessionUser.setContactName(contactName);</span><br><span class=line>applySessionUser.setSessionId(sessionId);</span><br><span class=line><span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdate(applySessionUser);</span><br><span class=line></span><br><span class=line><span class=comment>//增加聊天消息</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.CHAT.getType());</span><br><span class=line>chatMessage.setMessageContent(senMessage);</span><br><span class=line>chatMessage.setSendUserId(contactId);</span><br><span class=line>chatMessage.setSendUserNickName(contactName);</span><br><span class=line>chatMessage.setSendTime(curDate.getTime());</span><br><span class=line>chatMessage.setContactId(userId);</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><h4 id=保存用户信息><a class=headerlink href=#保存用户信息 title=保存用户信息></a>保存用户信息</h4><p>更新用户信息,controller参数设置为userInfo,然后将其中的不能修改的信息设置为null.<p>如果更改了昵称,更新缓存中的用户信息,键为token.<p>除了更新userinfo表,如果昵称不一样还要更新chat_session_user表,根据contact<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=comment>//更新相关表冗余的字段</span></span><br><span class=line>String contactNameUpdate = null;</span><br><span class=line><span class=keyword>if</span> (!dbInfo.get<span class=constructor>NickName()</span>.equals(userInfo.get<span class=constructor>NickName()</span>)) {</span><br><span class=line>    contactNameUpdate = userInfo.get<span class=constructor>NickName()</span>;</span><br><span class=line>}</span><br><span class=line><span class=keyword>if</span> (contactNameUpdate<span class=operator> == </span>null) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line><span class=comment>//更新token中的昵称</span></span><br><span class=line>TokenUserInfoDto tokenUserInfoDto = redisComponet.get<span class=constructor>TokenUserInfoDtoByUserId(<span class=params>userInfo</span>.<span class=params>getUserId</span>()</span>);</span><br><span class=line>tokenUserInfoDto.set<span class=constructor>NickName(<span class=params>contactNameUpdate</span>)</span>;</span><br><span class=line>redisComponet.save<span class=constructor>TokenUserInfoDto(<span class=params>tokenUserInfoDto</span>)</span>;</span><br><span class=line></span><br><span class=line>chatSessionUserService.update<span class=constructor>RedundanceInfo(<span class=params>contactNameUpdate</span>, <span class=params>userInfo</span>.<span class=params>getUserId</span>()</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>if</span> (<span class=module-access><span class=module><span class=identifier>StringTools</span>.</span></span>is<span class=constructor>Empty(<span class=params>contactName</span>)</span>) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line>ChatSessionUser updateInfo = <span class=keyword>new</span> <span class=constructor>ChatSessionUser()</span>;</span><br><span class=line>updateInfo.set<span class=constructor>ContactName(<span class=params>contactName</span>)</span>;</span><br><span class=line><span class=comment>// 更新chat_session_user中的contact_name</span></span><br><span class=line>ChatSessionUserQuery chatSessionUserQuery = <span class=keyword>new</span> <span class=constructor>ChatSessionUserQuery()</span>;</span><br><span class=line>chatSessionUserQuery.set<span class=constructor>ContactId(<span class=params>contactId</span>)</span>;</span><br><span class=line>this.chatSessionUserMapper.update<span class=constructor>ByParam(<span class=params>updateInfo</span>, <span class=params>chatSessionUserQuery</span>)</span>;</span><br></pre></table></figure><p>然后针对联系人,发送名称更新的ws消息.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>userContactQuery.setContactId(contactId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>List&LTUserContact> userContactList = userContactMapper.selectList(userContactQuery);</span><br><span class=line><span class=keyword>for</span> (UserContact userContact : userContactList) {</span><br><span class=line>    MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>    messageSendDto.setContactType(contactTypeEnum.getType());</span><br><span class=line>    messageSendDto.setContactId(userContact.getUserId());</span><br><span class=line>    messageSendDto.setExtendData(contactName);</span><br><span class=line>    messageSendDto.setMessageType(MessageTypeEnum.CONTACT_NAME_UPDATE.getType());</span><br><span class=line>    messageSendDto.setSendUserId(contactId);</span><br><span class=line>    messageSendDto.setSendUserNickName(contactName);</span><br><span class=line>    messageHandler.sendMessage(messageSendDto);</span><br><span class=line>}</span><br></pre></table></figure><p>如果上传的头像文件不为空,则下载到服务器对应路径. BASE_FOLDER+FILE+AVATAR+user_id.jpg<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (avatarFile != <span class=keyword>null</span>) {</span><br><span class=line>    String baseFolder = appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE;</span><br><span class=line>    File targetFileFolder = <span class=keyword>new</span> File(baseFolder + Constants.FILE_FOLDER_AVATAR_NAME);</span><br><span class=line>    <span class=keyword>if</span> (!targetFileFolder.exists()) {</span><br><span class=line>        targetFileFolder.mkdirs();</span><br><span class=line>    }</span><br><span class=line>    String filePath = targetFileFolder.getPath() + <span class=string>"/"</span> + userInfo.getUserId() + Constants.IMAGE_SUFFIX;</span><br><span class=line>    avatarFile.transferTo(<span class=keyword>new</span> File(filePath));</span><br><span class=line>    avatarCover.transferTo(<span class=keyword>new</span> File(filePath + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>}</span><br></pre></table></figure><h4 id=获取用户信息><a class=headerlink href=#获取用户信息 title=获取用户信息></a>获取用户信息</h4><p>直接查询即可<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>UserInfo userInfo = userInfoService.getUserInfoByUserId(tokenUserInfoDto.getUserId());</span><br><span class=line>UserInfoVO userInfoVO = CopyTools.copy(userInfo, UserInfoVO.class);</span><br><span class=line>userInfoVO.setAdmin(tokenUserInfoDto.getAdmin());</span><br><span class=line><span class=keyword>return</span> getSuccessResponseVO(userInfoVO);</span><br></pre></table></figure><h4 id=更新密码><a class=headerlink href=#更新密码 title=更新密码></a>更新密码</h4><h4 id=退出><a class=headerlink href=#退出 title=退出></a>退出</h4><h3 id=群组管理><a class=headerlink href=#群组管理 title=群组管理></a>群组管理</h3><p><img alt=image-20250502195944284 data-src=https://s2.loli.net/2025/05/02/XZeaDzgW8tl5LMA.png><p><img alt=image-20250502200016447 data-src=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png><h4 id=查看自己群聊><a class=headerlink href=#查看自己群聊 title=查看自己群聊></a>查看自己群聊</h4><p>查询user_contact表,群组owner是自己,创建时间降序,群组状态正常.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>     TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>       GroupInfoQuery infoQuery = <span class=keyword>new</span> GroupInfoQuery();</span><br><span class=line>       infoQuery.setGroupOwnerId(tokenUserInfoDto.getUserId());</span><br><span class=line>       infoQuery.setOrderBy(<span class=string>"create_time desc"</span>);</span><br><span class=line>infoQuery.setStatus(GroupStatusEnum.NORMAL.getStatus());</span><br><span class=line>       List&LTGroupInfo> groupInfoList = <span class=keyword>this</span>.groupInfoService.findListByParam(infoQuery);</span><br><span class=line>       <span class=keyword>return</span> getSuccessResponseVO(groupInfoList);</span><br></pre></table></figure><h4 id=查看群聊信息><a class=headerlink href=#查看群聊信息 title=查看群聊信息></a>查看群聊信息</h4><p>根据groupId,首先看群聊是否存在,以及自己是否在群聊中,查询user_contact表(设置联系状态是好友),如果在群聊中才能继续查看. 查询groupInfo表<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);</span><br><span class=line>UserContact userContact = <span class=keyword>this</span>.userContactService.getUserContactByUserIdAndContactId(tokenUserInfoDto.getUserId(), groupId);</span><br><span class=line><span class=keyword>if</span> (userContact == <span class=keyword>null</span> || !UserContactStatusEnum.FRIEND.getStatus().equals(userContact.getStatus())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"你不在群聊或者群聊不存在或已经解散"</span>);</span><br><span class=line>}</span><br><span class=line>GroupInfo groupInfo = <span class=keyword>this</span>.groupInfoService.getGroupInfoByGroupId(groupId);</span><br><span class=line><span class=keyword>if</span> (groupInfo == <span class=keyword>null</span> || !GroupStatusEnum.NORMAL.getStatus().equals(groupInfo.getStatus())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"群聊不存在或已经解散"</span>);</span><br><span class=line>}</span><br><span class=line><span class=keyword>return</span> groupInfo;</span><br></pre></table></figure><p>同时查询user_contact表查询群成员个数一起返回<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactService.findCountByParam(userContactQuery);</span><br><span class=line>groupInfo.setMemberCount(memberCount);</span><br></pre></table></figure><p>上面是查看群聊信息,但不包含群聊中成员,还有一个接口可以查询群成员,也就是在user_contact表中查看contact_id是群id,状态是联系人的<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GroupInfo groupInfo = getGroupDetailCommon(request, groupId);</span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setQueryUserInfo(<span class=keyword>true</span>);</span><br><span class=line>userContactQuery.setOrderBy(<span class=string>"create_time asc"</span>);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>List&LTUserContact> userContactList = <span class=keyword>this</span>.userContactService.findListByParam(userContactQuery);</span><br><span class=line>GroupInfoVO groupInfoVo = <span class=keyword>new</span> GroupInfoVO();</span><br><span class=line>groupInfoVo.setGroupInfo(groupInfo);</span><br><span class=line>groupInfoVo.setUserContactList(userContactList);</span><br><span class=line><span class=keyword>return</span> getSuccessResponseVO(groupInfoVo);</span><br></pre></table></figure><h4 id=创建-更新群聊><a class=headerlink href=#创建-更新群聊 title=创建/更新群聊></a>创建/更新群聊</h4><p>创建与更新群聊接口类似,传入groupId,如果为空则创建群聊.<p>一个用户创建群聊个数有限,所以先进行查询看是否满足条件.<p>满足之后,插入群聊信息,user_contact联系信息,用户联系人缓存更新,channelContextUtils加入群组channelGroup,插入chat_session_user表,插入session_user表,插入chat_message表,最后发送messageSendDto.<p>如果是更新群聊,则更新群组信息,更新user_contact表与chat_session_user表(主要更新群聊名称)<p>更新chat_session_user中contact_name.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>ChatSessionUser updateInfo = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>updateInfo.setContactName(contactName);</span><br><span class=line></span><br><span class=line>ChatSessionUserQuery chatSessionUserQuery = <span class=keyword>new</span> ChatSessionUserQuery();</span><br><span class=line>chatSessionUserQuery.setContactId(contactId);</span><br><span class=line><span class=keyword>this</span>.chatSessionUserMapper.updateByParam(updateInfo, chatSessionUserQuery);</span><br></pre></table></figure><p>然后发送ws消息通知群聊成员更改了群名称.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>messageSendDto.setContactType(UserContactTypeEnum.getByPrefix(contactId).getType());</span><br><span class=line>messageSendDto.setContactId(contactId);</span><br><span class=line>messageSendDto.setExtendData(contactName);</span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.CONTACT_NAME_UPDATE.getType());</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><p>用户更改昵称其实类似,也需要向他的联系人通知<p>如果上传了群聊头像文件,则存储到一个文件路径, basePath+FILE_FOLDER_FILE+FILE_FOLDER_AVATAR_NAME+群聊id<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>String baseFolder = appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE;</span><br><span class=line>File targetFileFolder = <span class=keyword>new</span> File(baseFolder + Constants.FILE_FOLDER_AVATAR_NAME);</span><br><span class=line><span class=keyword>if</span> (!targetFileFolder.exists()) {</span><br><span class=line>    targetFileFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line>String filePath = targetFileFolder.getPath() + <span class=string>"/"</span> + groupInfo.getGroupId() + Constants.IMAGE_SUFFIX;</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    avatarFile.transferTo(<span class=keyword>new</span> File(filePath));</span><br><span class=line>    avatarCover.transferTo(<span class=keyword>new</span> File(filePath + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>} <span class=keyword>catch</span> (IOException e) {</span><br><span class=line>    logger.error(<span class=string>"头像上传失败"</span>, e);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"头像上传失败"</span>);</span><br><span class=line>}</span><br></pre></table></figure><h4 id=解散群聊><a class=headerlink href=#解散群聊 title=解散群聊></a>解散群聊</h4><p>更新group_info状态群聊被解散,更新联系人user_contact状态为删除(contact_id为群id),删除对应缓存<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=comment>// 更新群解散状态</span></span><br><span class=line>GroupInfo updateInfo = <span class=keyword>new</span> GroupInfo();</span><br><span class=line>updateInfo.setStatus(GroupStatusEnum.DISSOLUTION.getStatus());</span><br><span class=line><span class=keyword>this</span>.groupInfoMapper.updateByGroupId(updateInfo, groupId);</span><br><span class=line></span><br><span class=line><span class=comment>// 更新user_contact状态 删除</span></span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line></span><br><span class=line>UserContact updateUserContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>updateUserContact.setStatus(UserContactStatusEnum.DEL.getStatus());</span><br><span class=line>userContactMapper.updateByParam(updateUserContact, userContactQuery);</span><br><span class=line><span class=comment>// 删除对应联系人缓存</span></span><br><span class=line>List&LTUserContact> userContactList = <span class=keyword>this</span>.userContactMapper.selectList(userContactQuery);</span><br><span class=line>    <span class=keyword>for</span> (UserContact userContact : userContactList) {</span><br><span class=line>        redisComponet.removeUserContact(userContact.getUserId(), userContact.getContactId());</span><br><span class=line>    }</span><br></pre></table></figure><p>除此之外,更新chat_session表群解散消息和时间,插入chat_message表更新群解散消息,GROUP_CONTEXT_MAP删除群组channelGroup<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>String sessionId = StringTools.getChatSessionId4Group(groupId);</span><br><span class=line>Date curTime = <span class=keyword>new</span> Date();</span><br><span class=line>String messageContent = MessageTypeEnum.DISSOLUTION_GROUP.getInitMessage();</span><br><span class=line><span class=comment>//更新会话消息</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line>chatSession.setLastReceiveTime(curTime.getTime());</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//记录消息消息表</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendTime(curTime.getTime());</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.DISSOLUTION_GROUP.getType());</span><br><span class=line>chatMessage.setContactId(groupId);</span><br><span class=line>chatMessage.setMessageContent(messageContent);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>还需要给发送群成员ws消息,告知群组解散.<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>  <span class=comment>//发送解散群消息</span></span><br><span class=line>        MessageSendDto messageSendDto = <span class=module-access><span class=module><span class=identifier>CopyTools</span>.</span></span>copy(chatMessage, <span class=module-access><span class=module><span class=identifier>MessageSendDto</span>.</span></span><span class=keyword>class</span>);</span><br><span class=line>        messageHandler.send<span class=constructor>Message(<span class=params>messageSendDto</span>)</span>;</span><br><span class=line> <span class=comment>// 在channelContextUtils.java中 给群聊channelGroup发送消息,这个group中的所有channel,也就是群成员都会接收到这个群解散消息</span></span><br><span class=line>ChannelGroup group = <span class=module-access><span class=module><span class=identifier>GROUP_CONTEXT_MAP</span>.</span></span>get(messageSendDto.get<span class=constructor>ContactId()</span>);</span><br><span class=line><span class=keyword>if</span> (group<span class=operator> == </span>null) {</span><br><span class=line>    return;</span><br><span class=line>}</span><br><span class=line>group.write<span class=constructor>AndFlush(<span class=params>new</span> TextWebSocketFrame(JSON.<span class=params>toJSONString</span>(<span class=params>messageSendDto</span>)</span>));</span><br><span class=line><span class=comment>// 然后移除GROUP_CONTEXT_MAP中的channelGroup并关闭group</span></span><br><span class=line>  <span class=keyword>if</span> (MessageTypeEnum.DISSOLUTION_GROUP<span class=operator> == </span>messageTypeEnum) {</span><br><span class=line>            <span class=module-access><span class=module><span class=identifier>GROUP_CONTEXT_MAP</span>.</span></span>remove(messageSendDto.get<span class=constructor>ContactId()</span>);</span><br><span class=line>            group.close<span class=literal>()</span>;</span><br><span class=line>        }</span><br></pre></table></figure><h4 id=退出群聊><a class=headerlink href=#退出群聊 title=退出群聊></a>退出群聊</h4><p>除了检查传递过来的groupId是否合法之外(群存在且未解散,创建者不能退出群聊),查询user_contact,更新状态为删除(代码中直接删除了行记录)<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>GroupInfo groupInfo = groupInfoMapper.selectByGroupId(groupId);</span><br><span class=line><span class=keyword>if</span> (groupInfo == <span class=keyword>null</span>) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br><span class=line><span class=comment>//创建者不能退出群聊，只能解散群</span></span><br><span class=line><span class=keyword>if</span> (userId.equals(groupInfo.getGroupOwnerId())) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br><span class=line>Integer count = userContactMapper.deleteByUserIdAndContactId(userId, groupId);</span><br><span class=line><span class=keyword>if</span> (count == <span class=number>0</span>) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class=line>}</span><br></pre></table></figure><p>插入chat_session_user表退群消息以及chat_message消息,更新联系人缓存<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>UserInfo userInfo = userInfoMapper.selectByUserId(userId);</span><br><span class=line></span><br><span class=line>String sessionId = StringTools.getChatSessionId4Group(groupId);</span><br><span class=line>Date curTime = <span class=keyword>new</span> Date();</span><br><span class=line>String messageContent = String.format(messageTypeEnum.getInitMessage(), userInfo.getNickName());</span><br><span class=line><span class=comment>//更新会话消息</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line>chatSession.setLastReceiveTime(curTime.getTime());</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//记录消息消息表</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendTime(curTime.getTime());</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessage.setMessageType(messageTypeEnum.getType());</span><br><span class=line>chatMessage.setContactId(groupId);</span><br><span class=line>chatMessage.setMessageContent(messageContent);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>然后就是使用messageHandler发送消息,有人退群了发送给群组channelGroup,也就是所有群成员<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(groupId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactMapper.selectCount(userContactQuery); <span class=comment>// 发送了群成员个数</span></span><br><span class=line></span><br><span class=line>MessageSendDto messageSendDto = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line>messageSendDto.setExtendData(userId); <span class=comment>// 发送了退群人</span></span><br><span class=line>messageSendDto.setMemberCount(memberCount);</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><h4 id=删除或者添加群成员><a class=headerlink href=#删除或者添加群成员 title=删除或者添加群成员></a>删除或者添加群成员</h4><p>还是类似的流程,先判断成员id和群组id本身是不是在user_contact成员状态,如果是才能进行下一步. 删除和添加类似,如果是删除成员,操作类似成员退出群成员,但message类型是REMOVE_GROUP(12, “%s被管理员移出了群聊”, “被管理员移出了群聊”).而不是LEAVE_GROUP,user_contact,chat_session,chat_message表更新(代码中user_contact记录被删除),消息也会发送给群组,会在处理时删除缓存,以及移除组中的channel.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>group.writeAndFlush(<span class=keyword>new</span> TextWebSocketFrame(JSON.toJSONString(messageSendDto)));</span><br><span class=line></span><br><span class=line><span class=comment>//移除群聊</span></span><br><span class=line>MessageTypeEnum messageTypeEnum = MessageTypeEnum.getByType(messageSendDto.getMessageType());</span><br><span class=line><span class=keyword>if</span> (MessageTypeEnum.LEAVE_GROUP == messageTypeEnum || MessageTypeEnum.REMOVE_GROUP == messageTypeEnum) {</span><br><span class=line>    String userId = (String) messageSendDto.getExtendData();</span><br><span class=line>    redisComponet.removeUserContact(userId, messageSendDto.getContactId());</span><br><span class=line>    Channel channel = USER_CONTEXT_MAP.get(userId);</span><br><span class=line>    <span class=keyword>if</span> (channel == <span class=keyword>null</span>) {</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line>    group.remove(channel);</span><br><span class=line>}</span><br></pre></table></figure><p>如果是添加群成员,类似addContact,applyuserId是contactId,联系人是群组id. 具体流程类似,更新/插入user_contact状态,更新缓存,更新chat_session表,添加群组channel,更新chat_message,最后发送消息(主要目的是当前机子可能没有该群组的channel,通过redisson发布订阅,其他机子取出CONTEXT_MAP中的channel,不为空就发送消息).<p>假设一个场景,有许多用户登陆了不同服务器<p><img alt=image-20250722160015745 data-src=https://s2.loli.net/2025/07/22/XnkZECm7cG23dlD.png><h4 id=加入群聊><a class=headerlink href=#加入群聊 title=加入群聊></a>加入群聊</h4><p>类似添加好友addContact<h3 id=联系人管理><a class=headerlink href=#联系人管理 title=联系人管理></a>联系人管理</h3><p><img alt=image-20250505174711397 data-src=https://s2.loli.net/2025/05/05/vODxw84bH7LguBa.png><p><img alt=image-20250502200016447 data-src=https://s2.loli.net/2025/05/02/psnG2CViDxzf8YQ.png><h4 id=搜索用户><a class=headerlink href=#搜索用户 title=搜索用户></a>搜索用户</h4><p>需要使用user_info表根据传过来的用户id查询,如果是用户,还需要查询昵称、性别等信息.<p>如果是群聊,还会返回群名称. 同时查询user_contact表设置联系状态.<h4 id=申请添加联系人><a class=headerlink href=#申请添加联系人 title=申请添加联系人></a>申请添加联系人</h4><p>添加联系人时,首先判断一些信息,比如contact_id是否合法(存在),是否被拉黑等.<p>user_contact_apply表包含apply_id为主键,意味着可以同一用户可以申请多次添加联系人<p><img alt=image-20250721225848826 data-src=https://s2.loli.net/2025/07/21/qXQrNahUbLdZw5p.png><p>省去对参数的校验,首先查询user_contact表状态是否被拉黑了,被拉黑就无法申请了.<p>当满足这些条件,然后判断是否需要申请还是直接就能添加.<h4 id=直接添加联系人><a class=headerlink href=#直接添加联系人 title=直接添加联系人></a>直接添加联系人</h4><p>如果能直接添加,就进行添加好友操作(如果是群聊需要判断是否超出人数)<p>能想到的操作就是,插入user_contact表,<strong>如果是好友,就需要互相添加.</strong>,如果是群组,直接插入一条即可(user_id,group_id)<p><img alt=image-20250721215035264 data-src=https://s2.loli.net/2025/07/21/Mf9eRWBC2mu1plw.png><p>也就是user_id分别为申请人和接收人,然后更新联系人缓存.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line>List&LTUserContact> contactList = <span class=keyword>new</span> ArrayList<>();</span><br><span class=line><span class=comment>//申请人添加对方</span></span><br><span class=line>UserContact userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>userContact.setUserId(applyUserId);</span><br><span class=line>userContact.setContactId(contactId);</span><br><span class=line>userContact.setContactType(contactType);</span><br><span class=line>userContact.setCreateTime(curDate);</span><br><span class=line>userContact.setLastUpdateTime(curDate);</span><br><span class=line>userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>contactList.add(userContact);</span><br><span class=line><span class=comment>//如果是申请好友 接收人添加申请人  群组不用添加对方为好友</span></span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER.getType().equals(contactType)) {</span><br><span class=line>    userContact = <span class=keyword>new</span> UserContact();</span><br><span class=line>    userContact.setUserId(receiveUserId);</span><br><span class=line>    userContact.setContactId(applyUserId);</span><br><span class=line>    userContact.setContactType(contactType);</span><br><span class=line>    userContact.setCreateTime(curDate);</span><br><span class=line>    userContact.setLastUpdateTime(curDate);</span><br><span class=line>    userContact.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>    contactList.add(userContact);</span><br><span class=line>}</span><br><span class=line><span class=comment>//批量加入</span></span><br><span class=line>userContactMapper.insertOrUpdateBatch(contactList);</span><br><span class=line></span><br><span class=line><span class=comment>//如果是好友申请,接收人也添加申请人为联系人</span></span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER.getType().equals(contactType)) {</span><br><span class=line>    redisComponet.addUserContact(receiveUserId, applyUserId);</span><br><span class=line>}</span><br><span class=line><span class=comment>//审核通过，将申请人的联系人添加上 我 或 群组</span></span><br><span class=line>redisComponet.addUserContact(applyUserId, contactId);</span><br></pre></table></figure><p>在创建好友联系后,就是创建会话以及消息信息了,具体操作也是表插入/更新操作.<p>具体来说,对于用户会话表,包括(user_id,contact_id,)session_id,contact_name<p><img alt=image-20250721091337069 data-src=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png><p>插入这个数据不难,但需要考虑可能之前这两人就是好友但进行过删好友操作,这条记录不会删除,所以就进行更新. 注意这个表也是(user_id,contact_id)联合主键,如果是好友,也需要插入相互的两条用户会话.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment>//查询接收人信息</span></span><br><span class=line>    UserInfo contactUser = <span class=keyword>this</span>.userInfoMapper.selectByUserId(contactId);</span><br><span class=line>    applySessionUser.setContactName(contactUser.getNickName());</span><br><span class=line>    chatSessionUserList.add(applySessionUser);</span><br><span class=line></span><br><span class=line>    <span class=comment>//接受人session</span></span><br><span class=line>    ChatSessionUser contactSessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>    contactSessionUser.setUserId(contactId);</span><br><span class=line>    contactSessionUser.setContactId(applyUserId);</span><br><span class=line>    contactSessionUser.setSessionId(sessionId);</span><br><span class=line>    contactSessionUser.setLastReceiveTime(curDate.getTime());</span><br><span class=line>    contactSessionUser.setLastMessage(applyInfo);</span><br><span class=line>    <span class=comment>//查询申请人信息</span></span><br><span class=line>    UserInfo applyUserInfo = <span class=keyword>this</span>.userInfoMapper.selectByUserId(applyUserId);</span><br><span class=line>    contactSessionUser.setContactName(applyUserInfo.getNickName());</span><br><span class=line>    chatSessionUserList.add(contactSessionUser);</span><br><span class=line>    <span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdateBatch(chatSessionUserList);</span><br></pre></table></figure><p>对于会话记录,只需要插入/更新一条,核心是更新最新消息和接收时间. (sql使用INSERT INTO xxx on duplicate key update xx)插入或者更新冗余键.向表中插入新行时，如果遇到与现有行的 <strong>PRIMARY KEY（主键）</strong> 或 <strong>UNIQUE KEY（唯一键）</strong> 冲突的情况，则执行 <code>UPDATE</code> 操作<p><img alt=image-20250721091312712 data-src=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment>//创建会话</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line>chatSession.setLastMessage(applyInfo);</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insertOrUpdate(chatSession);</span><br></pre></table></figure><p>主要更新最新消息和时间.<p>最后更新消息内容,插入消息表,消息表主键message_id,记录了消息的发送者和接收者,session_id,消息类型,文件类型等.只需要插入一条即可,不需要互相插入.<p><img alt=image-20250721202934542 data-src=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=comment>//记录消息消息表</span></span><br><span class=line>ChatMessage chatMessage = <span class=keyword>new</span> ChatMessage();</span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setMessageType(MessageTypeEnum.ADD_FRIEND.getType());</span><br><span class=line>chatMessage.setMessageContent(applyInfo);</span><br><span class=line>chatMessage.setSendUserId(applyUserId);</span><br><span class=line>chatMessage.setSendUserNickName(applyUserInfo.getNickName());</span><br><span class=line>chatMessage.setSendTime(curDate.getTime());</span><br><span class=line>chatMessage.setContactId(contactId);</span><br><span class=line>chatMessage.setContactType(UserContactTypeEnum.USER.getType());</span><br><span class=line>chatMessage.setStatus(MessageStatusEnum.SENDED.getStatus());</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>最后利用messageSendDto发送给用户以及接收者(因为成功加了好友).<p>注意设置的消息类型有多种,比如添加好友成功<code>ADD_FRIEND(1, "", "添加好友打招呼消息")</code>,群组创建成功等消息类型,以及文件上传,强制下线,退出群聊等等消息都会通过ws发给用户并记录在chatMessage的类型中.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>INIT(<span class=number>0</span>, <span class=string>""</span>, <span class=string>"连接WS获取信息"</span>),</span><br><span class=line>ADD_FRIEND(<span class=number>1</span>, <span class=string>""</span>, <span class=string>"添加好友打招呼消息"</span>),</span><br><span class=line>CHAT(<span class=number>2</span>, <span class=string>""</span>, <span class=string>"普通聊天消息"</span>),</span><br><span class=line>GROUP_CREATE(<span class=number>3</span>, <span class=string>"群组已经创建好，可以和好友一起畅聊了"</span>, <span class=string>"群创建成功"</span>),</span><br><span class=line>CONTACT_APPLY(<span class=number>4</span>, <span class=string>""</span>, <span class=string>"好友申请"</span>),</span><br><span class=line>MEDIA_CHAT(<span class=number>5</span>, <span class=string>""</span>, <span class=string>"媒体文件"</span>),</span><br><span class=line>FILE_UPLOAD(<span class=number>6</span>, <span class=string>""</span>, <span class=string>"文件上传完成"</span>),</span><br><span class=line>FORCE_OFF_LINE(<span class=number>7</span>, <span class=string>""</span>, <span class=string>"强制下线"</span>),</span><br><span class=line>DISSOLUTION_GROUP(<span class=number>8</span>, <span class=string>"群聊已解散"</span>, <span class=string>"解散群聊"</span>),</span><br><span class=line>ADD_GROUP(<span class=number>9</span>, <span class=string>"%s加入了群组"</span>, <span class=string>"加入群聊"</span>),</span><br><span class=line>CONTACT_NAME_UPDATE(<span class=number>10</span>, <span class=string>""</span>, <span class=string>"更新群昵称"</span>),</span><br><span class=line>LEAVE_GROUP(<span class=number>11</span>, <span class=string>"%s退出了群聊"</span>, <span class=string>"退出群聊"</span>),</span><br><span class=line>REMOVE_GROUP(<span class=number>12</span>, <span class=string>"%s被管理员移出了群聊"</span>, <span class=string>"被管理员移出了群聊"</span>),</span><br><span class=line>ADD_FRIEND_SELF(<span class=number>13</span>, <span class=string>""</span>, <span class=string>"添加好友打招呼消息发送给自己"</span>);</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>MessageSendDto messageSendDto = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * 发送给接受好友申请的人</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * 发送给申请人 发送人就是接收人，联系人就是申请人</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.ADD_FRIEND_SELF.getType());</span><br><span class=line>messageSendDto.setContactId(applyUserId);</span><br><span class=line>messageSendDto.setExtendData(contactUser);</span><br><span class=line>messageHandler.sendMessage(messageSendDto);</span><br></pre></table></figure><p>因为是好友添加成功所以需要向双方都发送ws消息,但接收者,消息类型和内容不太相同.<p>如果添加的是群组,同样的首先插入user_contact表,这时只需要插入一条记录即可.同时更新申请者联系人缓存.此外还要将这个用户channel加入群聊channelGroup中.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=comment>//加入群组</span></span><br><span class=line>         ChatSessionUser chatSessionUser = <span class=keyword>new</span> ChatSessionUser();</span><br><span class=line>         chatSessionUser.setUserId(applyUserId);</span><br><span class=line>         chatSessionUser.setContactId(contactId);</span><br><span class=line>         GroupInfo groupInfo = <span class=keyword>this</span>.groupInfoMapper.selectByGroupId(contactId);</span><br><span class=line>         chatSessionUser.setContactName(groupInfo.getGroupName());</span><br><span class=line>         chatSessionUser.setSessionId(sessionId);</span><br><span class=line>         <span class=keyword>this</span>.chatSessionUserMapper.insertOrUpdate(chatSessionUser);</span><br><span class=line></span><br><span class=line>         <span class=comment>//将群组加入到用户的联系人列表</span></span><br><span class=line>         redisComponet.addUserContact(applyUserId, groupInfo.getGroupId());</span><br><span class=line></span><br><span class=line>         channelContextUtils.addUser2Group(applyUserId, groupInfo.getGroupId());</span><br><span class=line></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addUser2Group</span><span class=params>(String userId, String groupId)</span> </span>{</span><br><span class=line>    Channel channel = USER_CONTEXT_MAP.get(userId);</span><br><span class=line>    add2Group(groupId, channel);</span><br><span class=line>}</span><br><span class=line>  <span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>add2Group</span><span class=params>(String groupId, Channel context)</span> </span>{</span><br><span class=line>    ChannelGroup group = GROUP_CONTEXT_MAP.get(groupId);</span><br><span class=line>    <span class=keyword>if</span> (group == <span class=keyword>null</span>) {</span><br><span class=line>        group = <span class=keyword>new</span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE);</span><br><span class=line>        GROUP_CONTEXT_MAP.put(groupId, group);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>if</span> (context == <span class=keyword>null</span>) {</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line>    group.add(context);</span><br><span class=line>}</span><br></pre></table></figure><p>然后插入/更新chat_session_user表(因为后续要添加会话消息),也只需要插入一条,而chat_session表插入/更新消息和接收时间,chat_session中的消息类型以及内容就是添加群消息.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>UserInfo applyUserInfo = <span class=keyword>this</span>.userInfoMapper.selectByUserId(applyUserId);</span><br><span class=line></span><br><span class=line>String sendMessage = String.format(MessageTypeEnum.ADD_GROUP.getInitMessage(), applyUserInfo.getNickName());</span><br><span class=line></span><br><span class=line><span class=comment>//增加session信息</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setSessionId(sessionId);</span><br><span class=line>chatSession.setLastReceiveTime(curDate.getTime());</span><br><span class=line>chatSession.setLastMessage(sendMessage);</span><br><span class=line><span class=keyword>this</span>.chatSessionMapper.insertOrUpdate(chatSession);</span><br></pre></table></figure><p>最后还是需要使用messageHandler发送messagesendDto,发送给群的有人进入了群的消息.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=comment>//发送群消息</span></span><br><span class=line>MessageSendDto messageSend = CopyTools.copy(chatMessage, MessageSendDto.class);</span><br><span class=line>messageSend.setContactId(groupInfo.getGroupId());</span><br><span class=line><span class=comment>//获取群人数量</span></span><br><span class=line>UserContactQuery userContactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>userContactQuery.setContactId(contactId);</span><br><span class=line>userContactQuery.setStatus(UserContactStatusEnum.FRIEND.getStatus());</span><br><span class=line>Integer memberCount = <span class=keyword>this</span>.userContactMapper.selectCount(userContactQuery);</span><br><span class=line>messageSend.setMemberCount(memberCount);</span><br><span class=line>messageSend.setContactName(groupInfo.getGroupName());</span><br><span class=line>messageHandler.sendMessage(messageSend);</span><br></pre></table></figure><h4 id=插入申请请求><a class=headerlink href=#插入申请请求 title=插入申请请求></a>插入申请请求</h4><p>请求的状态枚举如下:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>INIT(<span class=number>0</span>, <span class=string>"待处理"</span>),</span><br><span class=line>PASS(<span class=number>1</span>, <span class=string>"已同意"</span>),</span><br><span class=line>REJECT(<span class=number>2</span>, <span class=string>"已拒绝"</span>),</span><br><span class=line>BLACKLIST(<span class=number>3</span>, <span class=string>"已拉黑"</span>);;</span><br></pre></table></figure><p>如果不能直接添加,就需要插入/更新user_contact_apply表.<p>如果不存在该记录(通过user_id，contact_id,receiver_id创建了唯一索引),则直接插入请求信息.<p>否则更新user_contact_apply状态为待处理(也就是说)并更新请求时间和请求信息.<p>此外,申请消息会通过ws发送给接收者(如果没有user_contact_apply记录或者其状态不为待处理)<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (dbApply == <span class=keyword>null</span> || !UserContactApplyStatusEnum.INIT.getStatus().equals(dbApply.getStatus())) {</span><br><span class=line>    <span class=comment>//如果是待处理状态就不发消息，避免重复发送</span></span><br><span class=line>    <span class=comment>//发送ws消息</span></span><br><span class=line>    MessageSendDto messageSend = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>    messageSend.setMessageType(MessageTypeEnum.CONTACT_APPLY.getType());</span><br><span class=line>    messageSend.setMessageContent(applyInfo);</span><br><span class=line>    messageSend.setContactId(receiveUserId);</span><br><span class=line>    messageHandler.sendMessage(messageSend);</span><br><span class=line>}</span><br></pre></table></figure><p>messageSendDto成员如下,包括消息id,会话id,发送和接受这,消息内容,发送时间以及消息类型等等.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MessageSendDto</span><<span class=title>T</span>> <span class=keyword>implements</span> <span class=title>Serializable</span> </span>{</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=keyword>long</span> serialVersionUID = -<span class=number>1045752033171142417L</span>;</span><br><span class=line>    <span class=comment>//消息ID</span></span><br><span class=line>    <span class=keyword>private</span> Long messageId;</span><br><span class=line>    <span class=comment>//会话ID</span></span><br><span class=line>    <span class=keyword>private</span> String sessionId;</span><br><span class=line>    <span class=comment>//发送人</span></span><br><span class=line>    <span class=keyword>private</span> String sendUserId;</span><br><span class=line>    <span class=comment>//发送人昵称</span></span><br><span class=line>    <span class=keyword>private</span> String sendUserNickName;</span><br><span class=line>    <span class=comment>//联系人ID</span></span><br><span class=line>    <span class=keyword>private</span> String contactId;</span><br><span class=line>    <span class=comment>//联系人名称</span></span><br><span class=line>    <span class=keyword>private</span> String contactName;</span><br><span class=line>    <span class=comment>//消息内容</span></span><br><span class=line>    <span class=keyword>private</span> String messageContent;</span><br><span class=line>    <span class=comment>//最后的消息</span></span><br><span class=line>    <span class=keyword>private</span> String lastMessage;</span><br><span class=line>    <span class=comment>//消息类型</span></span><br><span class=line>    <span class=keyword>private</span> Integer messageType;</span><br><span class=line>    <span class=comment>//发送时间</span></span><br><span class=line>    <span class=keyword>private</span> Long sendTime;</span><br><span class=line>    <span class=comment>//联系人类型</span></span><br><span class=line>    <span class=keyword>private</span> Integer contactType;</span><br><span class=line>    <span class=comment>//扩展信息</span></span><br><span class=line>    <span class=keyword>private</span> T extendData;</span><br><span class=line></span><br><span class=line>    <span class=comment>//消息状态 0:发送中  1:已发送 对于文件是异步上传用状态处理</span></span><br><span class=line>    <span class=keyword>private</span> Integer status;</span><br><span class=line></span><br><span class=line>    <span class=comment>//文件信息</span></span><br><span class=line>    <span class=keyword>private</span> Long fileSize;</span><br><span class=line>    <span class=keyword>private</span> String fileName;</span><br><span class=line>    <span class=keyword>private</span> Integer fileType;</span><br><span class=line></span><br><span class=line>    <span class=comment>//群员</span></span><br><span class=line>    <span class=keyword>private</span> Integer memberCount;</span><br><span class=line>    }</span><br></pre></table></figure><h4 id=查询申请请求><a class=headerlink href=#查询申请请求 title=查询申请请求></a>查询申请请求</h4><p>查询user_contact_apply表,receiver_id是自己id的记录,因为这个表包含联合主键(apply_user_id,contact_id,receiver_id). 按照last_apply_time降序,还可以返回联系人昵称.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"selectList"</span> <span class=attr>resultMap</span>=<span class=string>"base_result_map"</span>></span></span><br><span class=line>    SELECT</span><br><span class=line>    a.*</span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.queryContactInfo"</span>></span></span><br><span class=line>        ,CASE</span><br><span class=line>        WHEN a.contact_type = 0 THEN u.nick_name</span><br><span class=line>        WHEN a.contact_type = 1 THEN g.group_name</span><br><span class=line>        END as contactName</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    FROM</span><br><span class=line>    user_contact_apply a</span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.queryContactInfo"</span>></span></span><br><span class=line>        LEFT JOIN user_info u ON u.user_id = a.apply_user_id and a.receive_user_id = #{query.receiveUserId}</span><br><span class=line>        LEFT JOIN group_info g ON g.group_id = a.contact_id and a.receive_user_id = #{query.receiveUserId}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>include</span> <span class=attr>refid</span>=<span class=string>"query_condition"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.orderBy!=null"</span>></span></span><br><span class=line>        order by ${query.orderBy}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.simplePage!=null"</span>></span></span><br><span class=line>        limit #{query.simplePage.start},#{query.simplePage.end}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h4 id=处理申请请求><a class=headerlink href=#处理申请请求 title=处理申请请求></a>处理申请请求</h4><p>除了正常流程的参数检验和合法之外,更新user_contact_apply表状态,如果允许请求,执行上述添加联系人操作,如果拒绝,后端什么也不做,如果是拉黑,user_contact状态记录为<strong>第一次被拉黑</strong>,后续不再允许申请添加,然后插入/更新user_contact表<h3 id=联系人详情-删除和拉黑联系人><a class=headerlink href=#联系人详情-删除和拉黑联系人 title=联系人详情,删除和拉黑联系人></a>联系人详情,删除和拉黑联系人</h3><p>加载联系人,也就是从user_contact表中查询,根据user_id和contact_id查询,如果是查询联系人,同时也会查询联系人名字、性别等信息,如果是群组,也会查询群昵称和群人数等. 此外,user_contact的状态必须是朋友,或者被删除,被拉黑. 也就是说如果被其删除,但没有删除联系人,也能加载它.<p>联系人详情有两个接口,一个获取任意用户的信息,通过contact_id获取用户信息,并返回联系状态.<p>如果是查询联系人详情,会设置查询状态,如果不是好友,被删除,被拉黑或者被首次拉黑,其余报异常. 因为如果被删除/拉黑依然能查看状态.<p>删除和拉黑好友时处理类似,首先修改user_contact状态,如果是删除,还需要增加被删除的一条(contact_id,user_id)记录,拉黑类似. 然后需要删除双方联系人缓存. 因为缓存中只保存好友关系的联系人,删除和被删除,拉黑和被拉黑都不存在,这个缓存内容是用来发送聊天消息的.<h3 id=获取用户信息、修改密码与退出登录><a class=headerlink href=#获取用户信息、修改密码与退出登录 title=获取用户信息、修改密码与退出登录></a>获取用户信息、修改密码与退出登录</h3><h3 id=后台管理><a class=headerlink href=#后台管理 title=后台管理></a>后台管理</h3><p>用户管理 靓号管理 群组管理<h3 id=登陆时加载消息><a class=headerlink href=#登陆时加载消息 title=登陆时加载消息></a>登陆时加载消息</h3><blockquote><p>离线消息处理</blockquote><p>在登陆校验完成后,<strong>将联系人存入缓存,将token和用户信息存入缓存</strong>,并返回用户信息.<p>当客户端发送ws连接时,会携带token,服务端利用token获取用户信息,然后加载聊天消息.<p>具体来说,在缓存中获取联系人,将自己的channel加入群聊的channelGroup中(如果没有创建channelGroup放入GROUP_CONTEXT_MAP中)<p>然后将自己的channel放入USER_CONTEXT_MAP中,更新用户心跳缓存和最新登陆时间.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>String channelId = channel.id().toString();</span><br><span class=line>        AttributeKey attributeKey = <span class=keyword>null</span>;</span><br><span class=line>        <span class=keyword>if</span> (!AttributeKey.exists(channelId)) {</span><br><span class=line>            attributeKey = AttributeKey.newInstance(channel.id().toString());</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            attributeKey = AttributeKey.valueOf(channel.id().toString());</span><br><span class=line>        }</span><br><span class=line>        channel.attr(attributeKey).set(userId);</span><br><span class=line></span><br><span class=line>        List&LTString> contactList = redisComponet.getUserContactList(userId);</span><br><span class=line>        <span class=keyword>for</span> (String groupId : contactList) {</span><br><span class=line>            <span class=keyword>if</span> (groupId.startsWith(UserContactTypeEnum.GROUP.getPrefix())) {</span><br><span class=line>                add2Group(groupId, channel);</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>        USER_CONTEXT_MAP.put(userId, channel);</span><br><span class=line>        redisComponet.saveUserHeartBeat(userId);</span><br><span class=line></span><br><span class=line>        <span class=comment>//更新用户最后连接时间</span></span><br><span class=line>        UserInfo updateInfo = <span class=keyword>new</span> UserInfo();</span><br><span class=line>        updateInfo.setLastLoginTime(<span class=keyword>new</span> Date());</span><br><span class=line>        userInfoMapper.updateByUserId(updateInfo, userId);</span><br></pre></table></figure><p>首先<strong>查询用户会话信息,也就是chat_session_user表,相同的聊天双方,sessionId相同,主键是user_id和contact_id联合主键,根据user_id查看用户会话可以获取有聊天会话的联系人信息,如果是群聊也会查询群聊人数,</strong>chat_session表主键是session_id.<p>在mapper中,查询用户会话信息就是获取chat_session_user聊天会话对方名称,id以及session会话最新的聊天信息,如果是群聊还要查群聊人数<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>          * 1、查询会话信息 查询用户所有会话，避免换设备会话不同步</span></span><br><span class=line><span class=comment>          */</span></span><br><span class=line>         ChatSessionUserQuery sessionUserQuery = <span class=keyword>new</span> ChatSessionUserQuery();</span><br><span class=line>         sessionUserQuery.setUserId(userId);</span><br><span class=line>         sessionUserQuery.setOrderBy(<span class=string>"last_receive_time desc"</span>);</span><br><span class=line>         List&LTChatSessionUser> chatSessionList = chatSessionUserMapper.selectList(sessionUserQuery);</span><br><span class=line>         WsInitData wsInitData = <span class=keyword>new</span> WsInitData();</span><br><span class=line>         wsInitData.setChatSessionList(chatSessionList);</span><br></pre></table></figure><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"selectList"</span> <span class=attr>resultMap</span>=<span class=string>"base_result_map"</span>></span></span><br><span class=line>    SELECT u.*,</span><br><span class=line>    c.last_message lastMessage,</span><br><span class=line>    c.last_receive_time lastReceiveTime,</span><br><span class=line>    case when SUBSTRING(contact_id, 1, 1) ='G'</span><br><span class=line>    THEN (select count(1) from user_contact uc where uc.contact_id = u.contact_id)</span><br><span class=line>    else 0</span><br><span class=line>    end memberCount</span><br><span class=line>    FROM chat_session_user u inner join chat_session c on c.session_id = u.session_id</span><br><span class=line>    <span class=tag><<span class=name>include</span> <span class=attr>refid</span>=<span class=string>"query_condition"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.orderBy!=null"</span>></span></span><br><span class=line>        order by ${query.orderBy}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line>    <span class=tag><<span class=name>if</span> <span class=attr>test</span>=<span class=string>"query.simplePage!=null"</span>></span></span><br><span class=line>        limit #{query.simplePage.start},#{query.simplePage.end}</span><br><span class=line>    <span class=tag>&LT/<span class=name>if</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><p>然后需要给客户端发送离线时其他人的聊天消息(离线之前的消息通过客户端查数据库),<p>查询流程是: 首先查询联系人,如果是群聊,联系的id是群组id,同时加上自己的id作为contact_id,查询chatMessage消息.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>           * 2、查询聊天消息</span></span><br><span class=line><span class=comment>           */</span></span><br><span class=line>          <span class=comment>//查询用户的联系人</span></span><br><span class=line>          UserContactQuery contactQuery = <span class=keyword>new</span> UserContactQuery();</span><br><span class=line>          contactQuery.setContactType(UserContactTypeEnum.GROUP.getType());</span><br><span class=line>          contactQuery.setUserId(userId);</span><br><span class=line>          List&LTUserContact> groupContactList = userContactMapper.selectList(contactQuery);</span><br><span class=line>          List&LTString> groupIdList = groupContactList.stream().map(item -> item.getContactId()).collect(Collectors.toList());</span><br><span class=line>          <span class=comment>//将自己也加进去</span></span><br><span class=line>          groupIdList.add(userId);</span><br><span class=line></span><br><span class=line>          ChatMessageQuery messageQuery = <span class=keyword>new</span> ChatMessageQuery();</span><br><span class=line>          messageQuery.setContactIdList(groupIdList);</span><br><span class=line>          messageQuery.setLastReceiveTime(lastOffTime);</span><br><span class=line>          List&LTChatMessage> chatMessageList = chatMessageMapper.selectList(messageQuery);</span><br><span class=line>          wsInitData.setChatMessageList(chatMessageList);</span><br></pre></table></figure><p>最后查询好友申请数,也就是contact_apply中还未处理的消息<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment>     * 3、查询好友申请</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    UserContactApplyQuery applyQuery = <span class=keyword>new</span> UserContactApplyQuery();</span><br><span class=line>    applyQuery.setReceiveUserId(userId);</span><br><span class=line>    applyQuery.setLastApplyTimestamp(sourceLastOffTime);</span><br><span class=line>    applyQuery.setStatus(UserContactApplyStatusEnum.INIT.getStatus());</span><br><span class=line>    Integer applyCount = userContactApplyMapper.selectCount(applyQuery);</span><br><span class=line>    wsInitData.setApplyCount(applyCount);</span><br></pre></table></figure><p>最后要将这些消息发送给用户<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment>//发送消息</span></span><br><span class=line>MessageSendDto messageSendDto = <span class=keyword>new</span> MessageSendDto();</span><br><span class=line>messageSendDto.setMessageType(MessageTypeEnum.INIT.getType()); <span class=comment>// messageSendDto设置ws消息类型</span></span><br><span class=line>messageSendDto.setContactId(userId);</span><br><span class=line>messageSendDto.setExtendData(wsInitData);</span><br><span class=line></span><br><span class=line>sendMsg(messageSendDto, userId);</span><br></pre></table></figure><h3 id=聊天><a class=headerlink href=#聊天 title=聊天></a>聊天</h3><p>主要使用ws发送消息,但多机环境下向不同服务器发送ws消息不共享,使用Redisson基于rediss消息订阅发送消息,解决集群环境下发送消息(因为集群中的服务器都通过redission订阅了相同主题)<p><img alt=image-20250721223758683 data-src=https://s2.loli.net/2025/07/21/y6cuUbi5AOKPRVr.png><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component("messageHandler")</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MessageHandler</span><<span class=title>T</span>> </span>{</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> Logger logger = LoggerFactory.getLogger(MessageHandler.class);</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String MESSAGE_TOPIC = <span class=string>"message.topic"</span>;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>    <span class=keyword>private</span> RedissonClient redissonClient;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>    <span class=keyword>private</span> ChannelContextUtils channelContextUtils;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=meta>@PostConstruct</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>lisMessage</span><span class=params>()</span> </span>{</span><br><span class=line>        RTopic rTopic = redissonClient.getTopic(MESSAGE_TOPIC);</span><br><span class=line>        rTopic.addListener(MessageSendDto.class, (MessageSendDto, sendDto) -> {</span><br><span class=line>            logger.info(<span class=string>"收到广播消息:{}"</span>, JSON.toJSONString(sendDto));</span><br><span class=line>            channelContextUtils.sendMessage(sendDto);</span><br><span class=line>        });</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>sendMessage</span><span class=params>(MessageSendDto sendDto)</span> </span>{</span><br><span class=line>        RTopic rTopic = redissonClient.getTopic(MESSAGE_TOPIC);</span><br><span class=line>        rTopic.publish(sendDto);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>数据库设计上,使用chat_session,chat_session_user以及chat_message表<p>session表包括sessionId(与聊天双方相关)以及最新消息和接收时间<p><img alt=image-20250721091312712 data-src=https://s2.loli.net/2025/07/21/oKpGdkxvjiJtVC2.png><p>chat_session_user表包括sessionId(与聊天双方相关)以及最新消息和接收时间. 一个chat_session_user表对应一个session表,通过session_id查询最新的消息.<p><img alt=image-20250721091337069 data-src=https://s2.loli.net/2025/07/21/rn2d8Njp3DWHQYB.png><p>chat_message表包括具体消息,包括发送者和接收者,sessionId,messageId以及消息类型,文件类型,状态,发送者昵称,文件类型,文件名称等<p><img alt=image-20250721202934542 data-src=https://s2.loli.net/2025/07/21/nFU6EcNfQlRx8Oz.png><h4 id=发送消息><a class=headerlink href=#发送消息 title=发送消息></a>发送消息</h4><p>用户向联系人发送消息,主要就是插入chat_message表以及更新session表,messageHandler发送消息.<p>难点是处理文件上传和message发送状态. 首先判断不是机器人,如果不是,判断聊天contact_id是否合法.<p>接着判断消息类型和contact类型,如果是用户,就是用户之间聊天,生成sessionId方式不同,接着更新chat_session表,如果是group,消息类型不是创建群这种消息,就需要带着userId,表明谁发送的存储在chat_session表中.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> (UserContactTypeEnum.USER == contactTypeEnum) {</span><br><span class=line>    sessionId = StringTools.getChatSessionId4User(<span class=keyword>new</span> String[]{sendUserId, contactId});</span><br><span class=line>} <span class=keyword>else</span> {</span><br><span class=line>    sessionId = StringTools.getChatSessionId4Group(contactId);</span><br><span class=line>}</span><br><span class=line><span class=comment>//更新会话消息</span></span><br><span class=line>ChatSession chatSession = <span class=keyword>new</span> ChatSession();</span><br><span class=line>chatSession.setLastMessage(messageContent);</span><br><span class=line><span class=keyword>if</span> (UserContactTypeEnum.GROUP == contactTypeEnum && !MessageTypeEnum.GROUP_CREATE.getType().equals(messageTypeEnum.getType())) {</span><br><span class=line>    chatSession.setLastMessage(tokenUserInfoDto.getNickName() + <span class=string>"："</span> + messageContent);</span><br><span class=line>}</span><br><span class=line>lastMessage = chatSession.getLastMessage();</span><br><span class=line><span class=comment>//如果是媒体文件</span></span><br><span class=line>chatSession.setLastReceiveTime(curTime);</span><br><span class=line>chatSessionMapper.updateBySessionId(chatSession, sessionId);</span><br><span class=line><span class=comment>//记录消息消息表</span></span><br><span class=line>chatMessage.setSessionId(sessionId);</span><br><span class=line>chatMessage.setSendUserId(sendUserId);</span><br><span class=line>chatMessage.setSendUserNickName(tokenUserInfoDto.getNickName());</span><br><span class=line>chatMessage.setSendTime(curTime);</span><br><span class=line>chatMessage.setContactType(contactTypeEnum.getType());</span><br><span class=line>chatMessage.setStatus(status);</span><br><span class=line>chatMessageMapper.insert(chatMessage);</span><br></pre></table></figure><p>如果发送的是文件类型,由于需要上传,消息类型设置为正在发送,等文件上传完毕再更新.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>Integer status = MessageTypeEnum.MEDIA_CHAT == messageTypeEnum ? MessageStatusEnum.SENDING.getStatus() : MessageStatusEnum.SENDED.getStatus();</span><br></pre></table></figure><p>最后通过messageHandler发送消息<p>如果是机器人,机器人会直接发送消息过去,也就是再次调用saveMessage方法本身,再在方法中通过messageHandler发送回用户.<p>最后会将发送的消息再传到客户端,方便拿到消息id.<h4 id=上传文件><a class=headerlink href=#上传文件 title=上传文件></a>上传文件</h4><p>controller参数包括messageId,检查发送者是否messageId对应消息的发送者.是上传文件,首先检查文件大小限制.然后直接上传即可(没有做秒传,分片续传等).<p>下载的路径遵循BASE_FOLDER+FILE+yyyyMM+messageid.suffix<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>String fileName = file.getOriginalFilename();</span><br><span class=line>String fileExtName = StringTools.getFileSuffix(fileName);</span><br><span class=line>String fileRealName = messageId + fileExtName;</span><br><span class=line>String month = DateUtil.format(<span class=keyword>new</span> Date(message.getSendTime()), DateTimePatternEnum.YYYYMM.getPattern());</span><br><span class=line>File folder = <span class=keyword>new</span> File(appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE + month);</span><br><span class=line><span class=keyword>if</span> (!folder.exists()) {</span><br><span class=line>    folder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>File uploadFile = <span class=keyword>new</span> File(folder.getPath() + <span class=string>"/"</span> + fileRealName);</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    file.transferTo(uploadFile);</span><br><span class=line>    <span class=keyword>if</span> (cover != <span class=keyword>null</span>) {</span><br><span class=line>        cover.transferTo(<span class=keyword>new</span> File(uploadFile.getPath() + Constants.COVER_IMAGE_SUFFIX));</span><br><span class=line>    }</span><br><span class=line>} <span class=keyword>catch</span> (Exception e) {</span><br><span class=line>    logger.error(<span class=string>"上传文件失败"</span>, e);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(<span class=string>"文件上传失败"</span>);</span><br><span class=line>}</span><br></pre></table></figure><p>然后更新chat_message表,利用拿到的messageId,状态改为已发送.<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>ChatMessage updateInfo = <span class=keyword>new</span> <span class=constructor>ChatMessage()</span>;</span><br><span class=line>updateInfo.set<span class=constructor>Status(MessageStatusEnum.SENDED.<span class=params>getStatus</span>()</span>);</span><br><span class=line>ChatMessageQuery messageQuery = <span class=keyword>new</span> <span class=constructor>ChatMessageQuery()</span>;</span><br><span class=line>messageQuery.set<span class=constructor>MessageId(<span class=params>messageId</span>)</span>;</span><br><span class=line>chatMessageMapper.update<span class=constructor>ByParam(<span class=params>updateInfo</span>, <span class=params>messageQuery</span>)</span>;</span><br></pre></table></figure><p>最后通过messageHandler发送给消息的接收者,表明文件上传成功,可以下载了.消息内容包含messageId,这样接收者可以利用这个id下载文件<h4 id=下载文件><a class=headerlink href=#下载文件 title=下载文件></a>下载文件</h4><p>注意文件包括用户/群聊头像还包括消息中的文件,如果是消息id(全为整数),就会根据消息id查询发送时间,拼接为文件路径,然后下载. 首先检查消息接收者是否符合.<p>然后通过消息id和发送时间找到对应路径的文件,BASE_FOLDER+FILE+yyyyMM+message_id<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>String month = DateUtil.format(<span class=keyword>new</span> Date(message.getSendTime()), DateTimePatternEnum.YYYYMM.getPattern());</span><br><span class=line>File folder = <span class=keyword>new</span> File(appConfig.getProjectFolder() + Constants.FILE_FOLDER_FILE + month);</span><br><span class=line><span class=keyword>if</span> (!folder.exists()) {</span><br><span class=line>    folder.mkdirs();</span><br><span class=line>}</span><br><span class=line>String fileName = message.getFileName();</span><br><span class=line>String fileExtName = StringTools.getFileSuffix(fileName);</span><br><span class=line>String fileRealName = messageId + fileExtName;</span><br><span class=line></span><br><span class=line><span class=keyword>if</span> (cover != <span class=keyword>null</span> && cover) {</span><br><span class=line>    fileRealName = fileRealName + Constants.COVER_IMAGE_SUFFIX;</span><br><span class=line>}</span><br><span class=line>File file = <span class=keyword>new</span> File(folder.getPath() + <span class=string>"/"</span> + fileRealName);</span><br><span class=line><span class=keyword>if</span> (!file.exists()) {</span><br><span class=line>    logger.info(<span class=string>"文件不存在"</span>);</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_602);</span><br><span class=line>}</span><br><span class=line><span class=keyword>return</span> file;</span><br></pre></table></figure><p>否则是用户/群聊Id(U或者G前缀),拼接用户id找到路径然后下载<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>String avatarFolderName = Constants.FILE_FOLDER_FILE + Constants.FILE_FOLDER_AVATAR_NAME;</span><br><span class=line>String avatarPath = appConfig.getProjectFolder() + avatarFolderName + fileId + Constants.IMAGE_SUFFIX;</span><br><span class=line><span class=keyword>if</span> (showCover) {</span><br><span class=line>    avatarPath = avatarPath + Constants.COVER_IMAGE_SUFFIX;</span><br><span class=line>}</span><br><span class=line>file = <span class=keyword>new</span> File(avatarPath);</span><br><span class=line><span class=keyword>if</span> (!file.exists()) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_602);</span><br><span class=line>}</span><br></pre></table></figure><p>下载使用<code>FileInputStream</code>和<code>HttpServletResponse.getOutputStream()</code>,每次读1024字节(1KB),避免文件过大.注意设置response头<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>response.setContentType(<span class=string>"application/x-msdownload; charset=UTF-8"</span>);</span><br><span class=line>response.setHeader(<span class=string>"Content-Disposition"</span>, <span class=string>"attachment;"</span>);</span><br><span class=line>response.setContentLengthLong(file.length());</span><br></pre></table></figure><p>主要设置content-type,content-disposition,content-length头<h1 id=EasyPan><a class=headerlink href=#EasyPan title=EasyPan></a>EasyPan</h1><p><a href=https://docs.qq.com/doc/DY1JTbU9kSkRPUUVY rel=noopener target=_blank>03.Java项目创建</a><h3 id=IDE设置><a class=headerlink href=#IDE设置 title=IDE设置></a>IDE设置</h3><h4 id=JDK位置设置><a class=headerlink href=#JDK位置设置 title=JDK位置设置></a>JDK位置设置</h4><p><img alt=image-20250514230635404 data-src=https://s2.loli.net/2025/05/14/Wpwxn17jzJYgNiZ.png><h4 id=编译器自动构建与热交换><a class=headerlink href=#编译器自动构建与热交换 title=编译器自动构建与热交换></a>编译器自动构建与热交换</h4><p><img alt=image-20250514230730743 data-src=https://s2.loli.net/2025/05/14/IouNVMneLkvw5xd.png><p><img alt=image-20250514230903350 data-src=https://s2.loli.net/2025/05/14/fHxKr3uUjsJwGTV.png><p><img alt=image-20250514230936534 data-src=https://s2.loli.net/2025/05/14/VIFQjYLmdoMyuT4.png><h4 id=设置Maven位置><a class=headerlink href=#设置Maven位置 title=设置Maven位置></a>设置Maven位置</h4><p><img alt=image-20250514231336188 data-src=https://s2.loli.net/2025/05/14/AYdCIP8NLceGyig.png><h4 id=设置文件编码><a class=headerlink href=#设置文件编码 title=设置文件编码></a>设置文件编码</h4><p><img alt=image-20250514231119345 data-src=https://s2.loli.net/2025/05/14/gfJ2BtnGVdkwj4a.png><h4 id=创建工程><a class=headerlink href=#创建工程 title=创建工程></a>创建工程</h4><p><img alt=image-20250514231258500 data-src=https://s2.loli.net/2025/05/14/PWJutmFC9iZyXNn.png><p>或创建Spring Boot项目<h3 id=配置文件><a class=headerlink href=#配置文件 title=配置文件></a>配置文件</h3><h4 id=POM-xml><a class=headerlink href=#POM-xml title=POM.xml></a>POM.xml</h4><h5 id=项目基本信息><a class=headerlink href=#项目基本信息 title=项目基本信息></a>项目基本信息</h5><ul><li><code>&LTmodelVersion></code>：指定 POM 模型的版本，通常为 <code>4.0.0</code>。<li><code>&LTgroupId></code>：定义项目所属的组织或公司，通常使用反向域名表示。<li><code>&LTartifactId></code>：项目的唯一标识符，通常对应项目名称。<li><code>&LTversion></code>：项目的当前版本号。<li><code>&LTpackaging></code>：指定项目的打包方式，如 <code>jar</code>、<code>war</code> 等。<li><code>&LTname></code>：项目的名称。<li><code>&LTdescription></code>：项目的简要描述。</ul><h5 id=继承与模块管理><a class=headerlink href=#继承与模块管理 title=继承与模块管理></a>继承与模块管理</h5><ul><li><code>&LTparent></code>：指定当前项目继承的父 POM，便于共享统一的配置和依赖管理。<li><code>&LTmodules></code>：在多模块项目中，列出所有子模块的目录名称。</ul><h5 id=依赖管理><a class=headerlink href=#依赖管理 title=依赖管理></a>依赖管理</h5><ul><li><code>&LTdependencies></code>：列出项目所需的所有依赖项。<li><code>&LTdependencyManagement></code>：用于统一管理依赖的版本信息，子项目可以引用而无需指定版本。<li><code>&LTrepositories></code>：指定额外的远程仓库地址，以获取依赖。</ul><h5 id=构建配置><a class=headerlink href=#构建配置 title=构建配置></a>构建配置</h5><ul><li><p><code>&LTbuild></code>：定义项目的构建相关配置。</p> <ul><li><code>&LTsourceDirectory></code>：指定源代码目录。<li><code>&LToutputDirectory></code>：指定编译输出目录。<li><code>&LTplugins></code>：配置构建过程中使用的插件，如 <code>maven-compiler-plugin</code> 等。</ul> <p><strong>默认目录结构</strong></p> <ul><li><strong>主源代码目录</strong>：<code>src/main/java</code><li><strong>主资源目录</strong>：<code>src/main/resources</code><li><strong>测试源代码目录</strong>：<code>src/test/java</code><li><strong>测试资源目录</strong>：<code>src/test/resources</code><li><strong>构建输出目录</strong>：<code>target/</code><li><strong>主类输出目录</strong>：<code>target/classes</code><li><strong>测试类输出目录</strong>：`target/test-classes</ul> <p>这些默认设置源自于 Maven 的 Super POM<a href=https://maven.apache.org/ref/3.9.9/maven-model-builder/super-pom.html rel=noopener target=_blank>Maven Model Builder – Super POM</a>，所有项目在未显式配置的情况下都会继承这些设置</p> <p><strong>自定义输入目录</strong></p> <p>如果项目结构不同于 Maven 的默认结构，可以在 <code>pom.xml</code> 中自定义输入目录。例如：</p> <figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>build</span>></span></span><br><span class=line>  <span class=tag><<span class=name>sourceDirectory</span>></span>src/my-src<span class=tag>&LT/<span class=name>sourceDirectory</span>></span></span><br><span class=line>  <span class=tag><<span class=name>testSourceDirectory</span>></span>src/my-test<span class=tag>&LT/<span class=name>testSourceDirectory</span>></span></span><br><span class=line>  <span class=tag><<span class=name>resources</span>></span></span><br><span class=line>    <span class=tag><<span class=name>resource</span>></span></span><br><span class=line>      <span class=tag><<span class=name>directory</span>></span>src/my-resources<span class=tag>&LT/<span class=name>directory</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>resource</span>></span></span><br><span class=line>  <span class=tag>&LT/<span class=name>resources</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>build</span>></span></span><br></pre></table></figure> <p>上述配置将主源代码目录更改为 <code>src/my-src</code>，测试源代码目录更改为 <code>src/my-test</code>，资源目录更改为 <code>src/my-resources</code>。</p></ul><h5 id=属性定义><a class=headerlink href=#属性定义 title=属性定义></a>属性定义</h5><ul><li><code>&LTproperties></code>：定义可在 POM 中引用的变量，便于统一管理版本号等信息。</ul><h5 id=构建环境与发布配置><a class=headerlink href=#构建环境与发布配置 title=构建环境与发布配置></a>构建环境与发布配置</h5><ul><li><code>&LTprofiles></code>：定义不同的构建配置，便于在不同环境下使用。<li><code>&LTdistributionManagement></code>：配置项目的发布信息，如部署到的仓库地址等。</ul><p><a href=https://maven.apache.org/guides/introduction/introduction-to-the-pom.html rel=noopener target=_blank>Introduction to the POM – Maven</a><h4 id=日志记录><a class=headerlink href=#日志记录 title=日志记录></a>日志记录</h4><blockquote><p>Spring Boot 使用 Commons Logging 进行所有内部日志记录，但底层日志实现保持开放。为 Java Util Logging、Log4j2 和 Logback 提供了默认配置。在每种情况下，日志记录器都预先配置为使用控制台输出，同时也可以选择文件输出。</blockquote><p><img alt=img data-src=https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/gongju/logback-6ba1b465-5533-49dd-b875-48a10ba29f8e.png style=zoom:67%;><p>当前版本logback中重要组件包括appender,也就是配置日志的输出目的地，通过 name 属性指定名字，通过 class 属性指定目的地：<ul><li>ch.qos.logback.core.ConsoleAppender：输出到控制台。<li>ch.qos.logback.core.FileAppender：输出到文件。<li>ch.qos.logback.core.rolling.RollingFileAppender：文件大小超过阈值时产生一个新文件。</ul><p>encoder,logger以及root,它只支持一个属性——level，值可以为：TRACE、DEBUG、INFO、WARN、ERROR、ALL、OFF.<p><strong><code>&LTproperty></code></strong>：定义的变量可以在整个配置文件中通过 <code>${}</code> 引用，便于维护和修改。<p><strong><code>&LTappender></code></strong>：定义日志的输出方式。<ul><li><strong><code>ConsoleAppender</code></strong>：将日志输出到控制台。<li><strong><code>RollingFileAppender</code></strong>：将日志输出到文件，并支持按时间滚动生成新文件。</ul><p><strong><code>&LTlogger></code></strong>：为特定的包或类设置日志级别和输出方式。<p><strong><code>&LTroot></code></strong>：定义默认的日志级别和输出方式，适用于未被其他 <code>logger</code> 捕获的日志。<p>pattern 用来指定日志的输出格式：<ul><li><code>%d</code>：输出的时间格式。<li><code>%thread</code>：日志的线程名。<li><code>%-5level</code>：日志的输出级别，填充到 5 个字符。比如说 info 只有 4 个字符，就填充一个空格，这样日志信息就对齐了。<li><code>%logger{length}</code>：logger 的名称，length 用来缩短名称。没有指定表示完整输出；0 表示只输出 logger 最右边点号之后的字符串；其他数字表示输出小数点最后边点号之前的字符数量。<li><code>%msg</code>：日志的具体信息。<li><code>%n</code>：换行符。<li><code>%relative</code>：输出从程序启动到创建日志记录的时间，单位为毫秒。</ul><p><code>logback-spring.xml</code>提供了<code>&LTspringProperty></code>以及<code>&LTspringProfile></code>可以读取springBoot配置文件中的属性.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br></pre><td class=code><pre><span class=line><span class=meta>&LT?xml version="1.0" encoding="UTF-8" ?></span></span><br><span class=line><span class=tag><<span class=name>configuration</span>></span></span><br><span class=line>    <span class=tag><<span class=name>appender</span> <span class=attr>name</span>=<span class=string>"stdot"</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.ConsoleAppender"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>encoder</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>></span></span><br><span class=line>            <span class=tag><<span class=name>pattern</span>></span>%d{yyyy-MM-dd HH:mm:ss,GMT+8} [%p][%c][%M][%L]-> %m%n<span class=tag>&LT/<span class=name>pattern</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>encoder</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>appender</span>></span></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>appender</span> <span class=attr>name</span>=<span class=string>"file"</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.rolling.RollingFileAppender"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>file</span>></span>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}<span class=tag>&LT/<span class=name>file</span>></span></span><br><span class=line><span class=comment>&LT!--        &LTrollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">--></span></span><br><span class=line><span class=comment>&LT!--            &LTfileNamePattern>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}.%d{yyyy-MM-dd}.%i&LT/fileNamePattern>--></span></span><br><span class=line><span class=comment>&LT!--            &LTtotalSizeCap>5G&LT/totalSizeCap>--></span></span><br><span class=line><span class=comment>&LT!--            &LTmaxHistory>30&LT/maxHistory>--></span></span><br><span class=line><span class=comment>&LT!--        &LT/rollingPolicy>--></span></span><br><span class=line>        <span class=tag><<span class=name>rollingPolicy</span> <span class=attr>class</span>=<span class=string>"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>></span></span><br><span class=line>            <span class=comment>&LT!-- rollover daily --></span></span><br><span class=line>            <span class=tag><<span class=name>fileNamePattern</span>></span>${log.path}/${LOG_FOLDER}/${LOG_FILE_NAME}.%d{yyyy-MM-dd}.%i<span class=tag>&LT/<span class=name>fileNamePattern</span>></span></span><br><span class=line>            <span class=comment>&LT!-- each file should be at most 100MB, keep 60 days worth of history, but at most 20GB --></span></span><br><span class=line>            <span class=tag><<span class=name>maxFileSize</span>></span>100MB<span class=tag>&LT/<span class=name>maxFileSize</span>></span></span><br><span class=line>            <span class=tag><<span class=name>maxHistory</span>></span>60<span class=tag>&LT/<span class=name>maxHistory</span>></span></span><br><span class=line>            <span class=tag><<span class=name>totalSizeCap</span>></span>20GB<span class=tag>&LT/<span class=name>totalSizeCap</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>rollingPolicy</span>></span></span><br><span class=line>        <span class=tag><<span class=name>encoder</span>></span></span><br><span class=line>            <span class=tag><<span class=name>pattern</span>></span>%d{yyyy-MM-dd HH:mm:ss,GMT+8} [%p][%c][%M][%L]-> %m%n<span class=tag>&LT/<span class=name>pattern</span>></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>encoder</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>appender</span>></span></span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>springProperty</span> <span class=attr>scope</span>=<span class=string>"context"</span> <span class=attr>name</span>=<span class=string>"log.path"</span> <span class=attr>source</span>=<span class=string>"project.folder"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>springProperty</span> <span class=attr>scope</span>=<span class=string>"context"</span> <span class=attr>name</span>=<span class=string>"log.root.level"</span> <span class=attr>source</span>=<span class=string>"log.root.level"</span>/></span></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>property</span> <span class=attr>name</span>=<span class=string>"LOG_FOLDER"</span> <span class=attr>value</span>=<span class=string>"logs"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>property</span> <span class=attr>name</span>=<span class=string>"LOG_FILE_NAME"</span> <span class=attr>value</span>=<span class=string>"easypan.log"</span>/></span></span><br><span class=line>    </span><br><span class=line><span class=comment>&LT!--    &LTlogger name="top.sekyoro.easypan" level="${log.root.level}">--></span></span><br><span class=line><span class=comment>&LT!--        &LTappender-ref ref="stdot"/>--></span></span><br><span class=line><span class=comment>&LT!--        &LTappender-ref ref="file"/>--></span></span><br><span class=line><span class=comment>&LT!--    &LT/logger>   --></span></span><br><span class=line><span class=comment>&LT!--    --></span></span><br><span class=line>    <span class=tag><<span class=name>root</span> <span class=attr>level</span>=<span class=string>"${log.root.level}"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>appender-ref</span> <span class=attr>ref</span>=<span class=string>"stdot"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>appender-ref</span> <span class=attr>ref</span>=<span class=string>"file"</span>/></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>root</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>configuration</span>></span></span><br></pre></table></figure><ul><li><a href=https://docs.spring.io/spring-boot/reference/features/logging.html#features.logging.logback-extensions rel=noopener target=_blank>Logging :: Spring Boot</a><li><a href=https://logback.qos.ch/manual/encoders.html rel=noopener target=_blank>Chapter 5: Encoders</a><li><a href=https://logback.qos.ch/codes.html#layoutInsteadOfEncoder rel=noopener target=_blank>Logback Error Codes</a><li><a href=https://javabetter.cn/gongju/logback.html#_03、把-log4j-properties-转成-logback-test-xml rel=noopener target=_blank>Logback：Spring Boot内置的日志处理框架 | 二哥的Java进阶之路</a><li><a href=https://docs.spring.io/spring-boot/docs/2.1.8.RELEASE/reference/html/boot-features-logging.html#boot-features-logback-extensions rel=noopener target=_blank>26. Logging</a></ul><h4 id=application-properties><a class=headerlink href=#application-properties title=application.properties></a>application.properties</h4><h5 id=服务器配置><a class=headerlink href=#服务器配置 title=服务器配置></a>服务器配置</h5><ul><li><code>server.port=8080</code>：设置应用的端口号。<li><code>server.servlet.context-path=/api</code>：设置应用的上下文路径。</ul><h5 id=应用信息><a class=headerlink href=#应用信息 title=应用信息></a>应用信息</h5><ul><li><code>spring.application.name=myapp</code>：设置应用的名称。</ul><h5 id=数据源配置（以-MySQL-为例）><a title="数据源配置（以 MySQL 为例）" class=headerlink href=#数据源配置（以-MySQL-为例）></a>数据源配置（以 MySQL 为例）</h5><ul><li><code>spring.datasource.url=jdbc:mysql://localhost:3306/db_example</code><li><code>spring.datasource.username=root</code><li><code>spring.datasource.password=secret</code><li><code>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</code><li><code>spring.jpa.hibernate.ddl-auto=update</code>：设置 JPA 的 DDL 策略。</ul><h5 id=日志配置><a class=headerlink href=#日志配置 title=日志配置></a>日志配置</h5><ul><li><code>logging.level.root=INFO</code>：设置根日志级别。<li><code>logging.level.com.example=DEBUG</code>：设置特定包的日志级别。<li><code>logging.file.name=logs/app.log</code>：设置日志文件名称。<li><code>logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n</code>：设置控制台日志输出格式</ul><h5 id=邮件配置><a class=headerlink href=#邮件配置 title=邮件配置></a>邮件配置</h5><ul><li><code>spring.mail.host=smtp.example.com</code><li><code>spring.mail.port=587</code><li><code>spring.mail.username=user@example.com</code><li><code>spring.mail.password=secret</code><li><code>spring.mail.properties.mail.smtp.auth=true</code><li><code>spring.mail.properties.mail.smtp.starttls.enable=true</code></ul><h5 id=安全配置><a class=headerlink href=#安全配置 title=安全配置></a>安全配置</h5><ul><li><code>spring.security.user.name=admin</code><li><code>spring.security.user.password=secret</code><li><code>spring.security.user.roles=USER,ADMIN</code></ul><h5 id=缓存配置><a class=headerlink href=#缓存配置 title=缓存配置></a>缓存配置</h5><ul><li><code>spring.cache.type=simple</code>：设置缓存类型。<li><code>spring.cache.cache-names=users,transactions</code>：定义缓存名称。</ul><h5 id=国际化配置><a class=headerlink href=#国际化配置 title=国际化配置></a>国际化配置</h5><ul><li><code>spring.messages.basename=messages</code>：设置消息资源文件的基础名称。<li><code>spring.messages.encoding=UTF-8</code>：设置消息资源文件的编码。</ul><h5 id=测试配置><a class=headerlink href=#测试配置 title=测试配置></a>测试配置</h5><ul><li><code>spring.main.allow-bean-definition-overriding=true</code>：允许覆盖 Bean 定义。<li><code>spring.profiles.active=dev</code>：设置活动的配置文件。</ul><p><strong>注意</strong>:1.新版本中,<code>spring.mvc.throw-exception-if-no-handler-found</code> 属性已被<a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/deprecated-list.html rel=noopener target=_blank>弃用</a>，建议不再使用。默认情况下,Spring Boot 会返回 404 响应，无需额外配置。<p>2.<code>spring.mvc.favicon.enable=false</code>配置属性已弃用。此外，Spring Boot 不再提供默认的 favicon，因为此图标可被视为信息泄露,可以增加对应handler.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>FaviconConfig</span> <span class=keyword>implements</span> <span class=title>WebMvcConfigurer</span> </span>{</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addResourceHandlers</span><span class=params>(ResourceHandlerRegistry registry)</span> </span>{</span><br><span class=line>        registry.addResourceHandler(<span class=string>"/favicon.ico"</span>)</span><br><span class=line>                .addResourceLocations(<span class=string>"classpath:/static/"</span>);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p><a href=https://www.baeldung-cn.com/spring-boot-favicon rel=noopener target=_blank>Spring Boot中favicon的指南 | Baeldung中文网</a><p>相关文档<ul><li><a href=https://docs.spring.io/spring-boot/appendix/application-properties/index.html rel=noopener target=_blank>Common Application Properties :: Spring Boot</a><li><a href=https://docs.spring.io/spring-boot/docs/2.0.x/reference/html/common-application-properties.html rel=noopener target=_blank>Appendix A. Common application properties</a></ul><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line><span class=comment># 应用服务 WEB 访问端口</span></span><br><span class=line><span class=meta>server.port</span>=<span class=string>7090</span></span><br><span class=line><span class=meta>server.servlet.context-path</span>=<span class=string>/api</span></span><br><span class=line><span class=comment>#session过期时间 60M 一个小时</span></span><br><span class=line><span class=meta>server.servlet.session.timeout</span>=<span class=string>PT60M</span></span><br><span class=line><span class=comment>#处理favicon</span></span><br><span class=line><span class=comment>#spring.mvc.favicon.enable=false</span></span><br><span class=line><span class=comment>#异常处理</span></span><br><span class=line><span class=comment>#spring.mvc.throw-exception-if-no-handler-found=true</span></span><br><span class=line><span class=meta>spring.web.resources.add-mappings</span>=<span class=string>false</span></span><br><span class=line><span class=comment>#数据库配置</span></span><br><span class=line><span class=meta>spring.datasource.url</span>=<span class=string>jdbc:mysql://127.0.0.1:3306/easypan?serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8&autoReconnect=true&allowMultiQueries=true</span></span><br><span class=line><span class=meta>spring.datasource.username</span>=<span class=string>root</span></span><br><span class=line><span class=meta>spring.datasource.password</span>=<span class=string>root</span></span><br><span class=line><span class=meta>spring.datasource.driver-class-name</span>=<span class=string>com.mysql.cj.jdbc.Driver</span></span><br><span class=line><span class=meta>spring.datasource.hikari.pool-name</span>=<span class=string>HikariCPDatasource</span></span><br><span class=line><span class=meta>spring.datasource.hikari.minimum-idle</span>=<span class=string>5</span></span><br><span class=line><span class=meta>spring.datasource.hikari.idle-timeout</span>=<span class=string>180000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.maximum-pool-size</span>=<span class=string>10</span></span><br><span class=line><span class=meta>spring.datasource.hikari.auto-commit</span>=<span class=string>true</span></span><br><span class=line><span class=meta>spring.datasource.hikari.max-lifetime</span>=<span class=string>1800000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.connection-timeout</span>=<span class=string>30000</span></span><br><span class=line><span class=meta>spring.datasource.hikari.connection-test-query</span>=<span class=string>SELECT 1</span></span><br><span class=line><span class=comment>#发送邮件配置相关</span></span><br><span class=line><span class=comment># 配置邮件服务器的地址 smtp.qq.com</span></span><br><span class=line><span class=meta>spring.mail.host</span>=<span class=string>smtp.qq.com</span></span><br><span class=line><span class=comment># 配置邮件服务器的端口（465或587）</span></span><br><span class=line><span class=meta>spring.mail.port</span>=<span class=string>465</span></span><br><span class=line><span class=comment># 配置用户的账号</span></span><br><span class=line><span class=meta>spring.mail.username</span>=<span class=string>test@qq.com</span></span><br><span class=line><span class=comment># 配置用户的密码</span></span><br><span class=line><span class=meta>spring.mail.password</span>=<span class=string>123456</span></span><br><span class=line><span class=comment># 配置默认编码</span></span><br><span class=line><span class=meta>spring.mail.default-encoding</span>=<span class=string>UTF-8</span></span><br><span class=line><span class=comment># SSL 连接配置</span></span><br><span class=line><span class=meta>spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class=string>javax.net.ssl.SSLSocketFactory</span></span><br><span class=line><span class=comment># 开启 debug，这样方便开发者查看邮件发送日志</span></span><br><span class=line><span class=meta>spring.mail.properties.mail.debug</span>=<span class=string>true</span></span><br><span class=line><span class=comment>#邮件配置结束</span></span><br><span class=line><span class=comment>#Spring redis配置</span></span><br><span class=line><span class=comment># Redis数据库索引（默认为0）</span></span><br><span class=line><span class=meta>spring.data.redis.database</span>=<span class=string>0</span></span><br><span class=line><span class=meta>spring.data.redis.host</span>=<span class=string>127.0.0.1</span></span><br><span class=line><span class=meta>spring.data.redis.port</span>=<span class=string>6379</span></span><br><span class=line><span class=comment># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-active</span>=<span class=string>8</span></span><br><span class=line><span class=comment># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-wait</span>=<span class=string>-1</span></span><br><span class=line><span class=comment># 连接池中的最大空闲连接</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.max-idle</span>=<span class=string>10</span></span><br><span class=line><span class=comment># 连接池中的最小空闲连接</span></span><br><span class=line><span class=meta>spring.data.redis.jedis.pool.min-idle</span>=<span class=string>0</span></span><br><span class=line><span class=comment># 连接超时时间（毫秒）</span></span><br><span class=line><span class=meta>spring.data.redis.timeout</span>=<span class=string>2000</span></span><br></pre></table></figure><h3 id=业务重点流程><a class=headerlink href=#业务重点流程 title=业务重点流程></a>业务重点流程</h3><h2 id=文件管理><a class=headerlink href=#文件管理 title=文件管理></a>文件管理</h2><h3 id=查看文件><a class=headerlink href=#查看文件 title=查看文件></a>查看文件</h3><h3 id=文件上传><a class=headerlink href=#文件上传 title=文件上传></a>文件上传</h3><p><img alt=image-20250722174319746 data-src=https://s2.loli.net/2025/07/22/Udzg4jYavtVsL3Z.png><p>表中(file_id,user_id)为联合主键. controller参数包含fileId,file,fileName,filePid,fileMd5,chunkIndex,chunks.<p>当刚开始上传时,chunkIndex=0,查看filemd5是否包含这个文件,并且当前空闲空间+文件空间大于总空间,如果查到了,则直接上传,如果文件名重复,重命名,插入数据库(file_id和文件名可能不同,还需要在数据库中插入)<p>然后更新使用空间,然后返回秒传响应即可.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=comment>// chunkIndex=0下</span></span><br><span class=line>FileInfoQuery infoQuery = <span class=keyword>new</span> FileInfoQuery();</span><br><span class=line>infoQuery.setFileMd5(fileMd5);</span><br><span class=line>infoQuery.setSimplePage(<span class=keyword>new</span> SimplePage(<span class=number>0</span>, <span class=number>1</span>));</span><br><span class=line>infoQuery.setStatus(FileStatusEnums.USING.getStatus());</span><br><span class=line>List&LTFileInfo> dbFileList = <span class=keyword>this</span>.fileInfoMapper.selectList(infoQuery);</span><br><span class=line><span class=comment>//秒传</span></span><br><span class=line><span class=keyword>if</span> (!dbFileList.isEmpty()) {</span><br><span class=line>    FileInfo dbFile = dbFileList.get(<span class=number>0</span>);</span><br><span class=line>    <span class=comment>//判断文件状态</span></span><br><span class=line>    <span class=keyword>if</span> (dbFile.getFileSize() + spaceDto.getUseSpace() > spaceDto.getTotalSpace()) {</span><br><span class=line>        <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_904);</span><br><span class=line>    }</span><br><span class=line>    dbFile.setFileId(fileId);</span><br><span class=line>    dbFile.setFilePid(filePid);</span><br><span class=line>    dbFile.setUserId(webUserDto.getUserId());</span><br><span class=line>    dbFile.setFileMd5(<span class=keyword>null</span>);</span><br><span class=line>    dbFile.setCreateTime(curDate);</span><br><span class=line>    dbFile.setLastUpdateTime(curDate);</span><br><span class=line>    dbFile.setStatus(FileStatusEnums.USING.getStatus());</span><br><span class=line>    dbFile.setDelFlag(FileDelFlagEnums.USING.getFlag());</span><br><span class=line>    dbFile.setFileMd5(fileMd5);</span><br><span class=line>    fileName = autoRename(filePid, webUserDto.getUserId(), fileName);</span><br><span class=line>    dbFile.setFileName(fileName);</span><br><span class=line>    <span class=keyword>this</span>.fileInfoMapper.insert(dbFile);</span><br><span class=line>    resultDto.setStatus(UploadStatusEnums.UPLOAD_SECONDS.getCode());</span><br><span class=line>    <span class=comment>//更新用户空间使用</span></span><br><span class=line>    updateUserSpace(webUserDto, dbFile.getFileSize());</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> resultDto;</span><br><span class=line>}</span><br></pre></table></figure><p>然后获取这个切片当前占用存储,如果大于总空间就报异常.<p>然后确定下载的chunk路径,BASE_FOLDER+FILE+user_id_file_id+chunkIndex,然后下载到对应位置,增加占用的临时存储空间.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=comment>//暂存在临时目录</span></span><br><span class=line>String tempFolderName = appConfig.getProjectFolder() + Constants.FILE_FOLDER_TEMP;</span><br><span class=line>String currentUserFolderName = webUserDto.getUserId() + fileId;</span><br><span class=line><span class=comment>//创建临时目录</span></span><br><span class=line>tempFileFolder = <span class=keyword>new</span> File(tempFolderName + currentUserFolderName);</span><br><span class=line><span class=keyword>if</span> (!tempFileFolder.exists()) {</span><br><span class=line>    tempFileFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>//判断磁盘空间</span></span><br><span class=line>Long currentTempSize = redisComponent.getFileTempSize(webUserDto.getUserId(), fileId);</span><br><span class=line><span class=keyword>if</span> (file.getSize() + currentTempSize + spaceDto.getUseSpace() > spaceDto.getTotalSpace()) {</span><br><span class=line>    <span class=keyword>throw</span> <span class=keyword>new</span> BusinessException(ResponseCodeEnum.CODE_904);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>File newFile = <span class=keyword>new</span> File(tempFileFolder.getPath() + <span class=string>"/"</span> + chunkIndex);</span><br><span class=line>file.transferTo(newFile);</span><br><span class=line><span class=comment>//保存临时大小</span></span><br><span class=line>redisComponent.saveFileTempSize(webUserDto.getUserId(), fileId, file.getSize());</span><br><span class=line><span class=comment>//不是最后一个分片，直接返回</span></span><br><span class=line><span class=keyword>if</span> (chunkIndex < chunks - <span class=number>1</span>) {</span><br><span class=line>    resultDto.setStatus(UploadStatusEnums.UPLOADING.getCode());</span><br><span class=line>    <span class=keyword>return</span> resultDto;</span><br><span class=line>}</span><br></pre></table></figure><p>如果不是最后一个分片,直接返回,响应设置上传状态.<p>当上传完最后一个文件分片时,表示上传完成,将相关文件信息插入数据库,文件状态设置为TRANSFER. 也做了缩略图处理,如果是视频,生成缩略图(使用ffmepg String cmd = “ffmpeg -i %s -y -vframes 1 -vf scale=%d:%d/a %s”;),如果是图片,也可以压缩得到缩略图String cmd = “ffmpeg -i %s -vf scale=%d:-1 %s -y”; 此外,视频会进行切割,得到不同的ts片段和m3u8索引文件. 如果是h.265转为h.264,h.264转成ts,然后进行切片得到ts文件与m3u8索引文件.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=comment>//创建同名切片目录</span></span><br><span class=line>File tsFolder = <span class=keyword>new</span> File(videoFilePath.substring(<span class=number>0</span>, videoFilePath.lastIndexOf(<span class=string>"."</span>)));</span><br><span class=line><span class=keyword>if</span> (!tsFolder.exists()) {</span><br><span class=line>    tsFolder.mkdirs();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>final</span> String CMD_GET_CODE = <span class=string>"ffprobe -v error -select_streams v:0 -show_entries stream=codec_name %s"</span>;</span><br><span class=line>String cmd = String.format(CMD_GET_CODE, videoFilePath);</span><br><span class=line>String result = ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line>result = result.replace(<span class=string>"\n"</span>, <span class=string>""</span>);</span><br><span class=line>result = result.substring(result.indexOf(<span class=string>"="</span>) + <span class=number>1</span>);</span><br><span class=line>String codec = result.substring(<span class=number>0</span>, result.indexOf(<span class=string>"["</span>));</span><br><span class=line></span><br><span class=line><span class=comment>//转码</span></span><br><span class=line><span class=keyword>if</span> (<span class=string>"hevc"</span>.equals(codec)) {</span><br><span class=line>    String newFileName = videoFilePath.substring(<span class=number>0</span>, videoFilePath.lastIndexOf(<span class=string>"."</span>)) + <span class=string>"_"</span> + videoFilePath.substring(videoFilePath.lastIndexOf(<span class=string>"."</span>));</span><br><span class=line>    <span class=keyword>new</span> File(videoFilePath).renameTo(<span class=keyword>new</span> File(newFileName));</span><br><span class=line>    String CMD_HEVC_264 = <span class=string>"ffmpeg -i %s -c:v libx264 -crf 20 %s"</span>;</span><br><span class=line>    cmd = String.format(CMD_HEVC_264, newFileName, videoFilePath);</span><br><span class=line>    ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line>    <span class=keyword>new</span> File(newFileName).delete();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>final</span> String CMD_TRANSFER_2TS = <span class=string>"ffmpeg -y -i %s  -vcodec copy -acodec copy -bsf:v h264_mp4toannexb %s"</span>;</span><br><span class=line><span class=keyword>final</span> String CMD_CUT_TS = <span class=string>"ffmpeg -i %s -c copy -map 0 -f segment -segment_list %s -segment_time 30 %s/%s_%%4d.ts"</span>;</span><br><span class=line></span><br><span class=line>String tsPath = tsFolder + <span class=string>"/"</span> + Constants.TS_NAME;</span><br><span class=line><span class=comment>//生成.ts</span></span><br><span class=line>cmd = String.format(CMD_TRANSFER_2TS, videoFilePath, tsPath);</span><br><span class=line>ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line><span class=comment>//生成索引文件.m3u8 和切片.ts</span></span><br><span class=line>cmd = String.format(CMD_CUT_TS, tsPath, tsFolder.getPath() + <span class=string>"/"</span> + Constants.M3U8_NAME, tsFolder.getPath(), fileId);</span><br><span class=line>ProcessUtils.executeCommand(cmd, <span class=keyword>false</span>);</span><br><span class=line><span class=comment>//删除index.ts</span></span><br><span class=line><span class=keyword>new</span> File(tsPath).delete();</span><br></pre></table></figure><p>同时异步进行文件合并,文件合并就是将chunks写入到一个文件中.同时更新数据库中文件状态.<p>在事务提交之后调用合并,截取封面以及视频编码等业务.<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment>//事务提交后调用异步方法</span></span><br><span class=line>TransactionSynchronizationManager.registerSynchronization(<span class=keyword>new</span> TransactionSynchronization() {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCommit</span><span class=params>()</span> </span>{</span><br><span class=line>        fileInfoService.transferFile(fileInfo.getFileId(), webUserDto);</span><br><span class=line>    }</span><br><span class=line>});</span><br></pre></table></figure><h3 id=文件预览><a class=headerlink href=#文件预览 title=文件预览></a>文件预览</h3><h4 id=普通文件预览><a class=headerlink href=#普通文件预览 title=普通文件预览></a>普通文件预览</h4><h4 id=缩略图预览><a class=headerlink href=#缩略图预览 title=缩略图预览></a>缩略图预览</h4><h4 id=视频预览><a class=headerlink href=#视频预览 title=视频预览></a>视频预览</h4><p>返回m3u8索引文件以及ts文件,<p>如果是下载ts文件,为了避免下载单个文件过大或者说进行播放时需要分片播放,可以通过在请求头携带range<p>而响应头携带<p><code>206</code> 响应通常伴随的头部：<p>当服务器返回 <code>206 Partial Content</code> 状态码时，通常会同时设置以下响应头：<ol><li><p><strong><code>Content-Range</code></strong>:</p> <ul><li><strong>作用：</strong> 这是最重要的头，它明确告知客户端当前响应体中包含的是<strong>整个资源的哪一部分</strong>，以及<strong>整个资源的总大小</strong>。<li><strong>格式：</strong> <code>Content-Range: bytes &LTstart>-&LTend>/&LTtotal_length></code><li><strong>示例：</strong> <code>Content-Range: bytes 1024-2047/2048</code> 表示响应体中是文件的第 1024 字节到第 2047 字节，整个文件总大小是 2048 字节。</ul><li><p><strong><code>Content-Length</code></strong>:</p> <ul><li><strong>作用：</strong> 表示<strong>当前响应体中实际传输的字节数</strong>（即 <code>end - start + 1</code>）。<li><strong>示例：</strong> 如果 <code>Content-Range</code> 是 <code>bytes 1024-2047/2048</code>，那么 <code>Content-Length</code> 应该是 <code>1024</code>。</ul><li><p><strong><code>Content-Type</code></strong>:</p> <ul><li><strong>作用：</strong> 仍然需要指示响应体中内容的媒体类型（MIME type），即使是部分内容。</ul><li><p><strong><code>Accept-Ranges</code></strong>:</p> <ul><li><strong>作用：</strong> 通常在第一次（完整）请求时就设置 <code>Accept-Ranges: bytes</code>，告诉客户端服务器支持范围请求。如果服务器返回 <code>206</code> 状态码，这意味着它肯定支持 <code>bytes</code> 范围。</ul> <hr> <p>分片下载，也称为<strong>断点续传（Resumable Download）或范围请求（Range Request）</strong>，是 HTTP 协议允许客户端只请求资源的部分内容的一种机制。当客户端需要进行分片下载时，它会在请求头中携带特定的信息来告诉服务器它想要哪些部分的数据。</p> <h5 id=分片下载时客户端请求头携带的关键信息><a class=headerlink href=#分片下载时客户端请求头携带的关键信息 title=分片下载时客户端请求头携带的关键信息></a>分片下载时客户端请求头携带的关键信息</h5><p>在分片下载场景中，客户端的 HTTP 请求头主要会携带以下一个或多个关键信息：</p> <p><code>Range</code> 请求头</p> <p>这是进行分片下载<strong>最核心、最重要</strong>的请求头。它明确告诉服务器客户端想要获取资源内容的哪一部分。</p> <ul><li><p><strong>作用：</strong> 指示客户端请求的是文件的特定字节范围。</p><li><p><strong>格式：</strong> <code>Range: bytes=&LTstart>-&LTend></code></p> <ul><li><code>&LTstart></code>: 想要获取的起始字节偏移量（从 0 开始计数）。<li><code>&LTend></code>: 想要获取的结束字节偏移量。</ul><li><p><strong>常用变体：</strong></p> <ul><li><strong>请求从某个字节到文件末尾：</strong> <code>Range: bytes=1024-</code><ul><li>这表示客户端想要从文件的第 1024 字节开始，一直到文件末尾的所有内容。</ul><li><strong>请求文件的最后 N 个字节：</strong> <code>Range: bytes=-500</code><ul><li>这表示客户端想要文件的最后 500 个字节。</ul><li><strong>请求多个不连续的范围：</strong> <code>Range: bytes=0-100, 200-300</code> (服务器不一定支持，但 HTTP 规范允许)<ul><li>这表示客户端想要第 0-100 字节和第 200-300 字节。</ul></ul><li><p><strong>示例：</strong></p> <figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>GET</span> <span class=string>/path/to/large_file.zip</span> <span class=meta>HTTP/1.1</span></span><br><span class=line><span class=attribute>Host</span><span class=punctuation>: </span>example.com</span><br><span class=line><span class=attribute>Range</span><span class=punctuation>: </span>bytes=5242880-10485759  # 请求文件的第 5MB 到 第 10MB 部分</span><br></pre></table></figure></ul> <p><code>If-Range</code> 请求头 (用于条件范围请求)</p> <p>这个请求头通常与 <code>Range</code> 一起使用，以实现<strong>条件性断点续传</strong>。它允许客户端在请求特定范围之前，先验证资源是否在上次下载后被修改过。</p> <ul><li><p><strong>作用：</strong> 如果服务器上资源的 <code>ETag</code> 或 <code>Last-Modified</code> 日期与 <code>If-Range</code> 中的值匹配，服务器才会返回请求的范围内容（<code>206 Partial Content</code>）。否则，服务器会忽略 <code>Range</code> 头，并返回整个文件（<code>200 OK</code>），因为资源已经被修改，部分内容可能已经不再有效。</p><li><p><strong>格式：</strong></p> <ul><li><code>If-Range: "&LTETag_value>"</code> (使用资源的 ETag)<li><code>If-Range: &LTHTTP-date></code> (使用资源的 Last-Modified 日期)</ul><li><p><strong>示例：</strong></p> <figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>GET</span> <span class=string>/path/to/large_file.zip</span> <span class=meta>HTTP/1.1</span></span><br><span class=line><span class=attribute>Host</span><span class=punctuation>: </span>example.com</span><br><span class=line><span class=attribute>Range</span><span class=punctuation>: </span>bytes=5242880-         # 客户端请求续传</span><br><span class=line><span class=attribute>If-Range</span><span class=punctuation>: </span>"abcdef1234567890"  # 如果资源的ETag与此匹配，则继续传输范围内容</span><br></pre></table></figure> <ul><li>如果服务器发现文件的 ETag 变了，说明文件被修改了，它会返回整个文件（<code>200 OK</code>）。<li>如果 ETag 没变，服务器就会返回请求的范围内容（<code>206 Partial Content</code>）。</ul></ul></ol><p>重要响应状态码:206 部分内容 301 永久重定向 302 暂时重定向<h3 id=目录相关><a class=headerlink href=#目录相关 title=目录相关></a>目录相关</h3><h4 id=创建目录><a class=headerlink href=#创建目录 title=创建目录></a>创建目录</h4><h4 id=获取目录路径><a class=headerlink href=#获取目录路径 title=获取目录路径></a>获取目录路径</h4><h4 id=文件重命名><a class=headerlink href=#文件重命名 title=文件重命名></a>文件重命名</h4><h4 id=移动文件><a class=headerlink href=#移动文件 title=移动文件></a>移动文件</h4><h4 id=删除文件><a class=headerlink href=#删除文件 title=删除文件></a>删除文件</h4><h3 id=回收站回收、还原以及彻底删除文件><a class=headerlink href=#回收站回收、还原以及彻底删除文件 title=回收站回收、还原以及彻底删除文件></a>回收站回收、还原以及彻底删除文件</h3><h3 id=外部分享文件><a class=headerlink href=#外部分享文件 title=外部分享文件></a>外部分享文件</h3><h1 id=EasyLive><a class=headerlink href=#EasyLive title=EasyLive></a>EasyLive</h1><h3 id=参考博主><a class=headerlink href=#参考博主 title=参考博主></a>参考博主</h3><p><a href=https://space.bilibili.com/499388891 rel=noopener target=_blank>程序员老罗的个人空间-程序员老罗个人主页-哔哩哔哩视频</a></p><link href=/css/spoiler.css rel=stylesheet><script async src=/js/spoiler.js></script></div><div><div><div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div class=reward-container><div>感谢阅读.</div><button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div style="display: none;" id=qr><div style="display: inline-block;"><img alt="Sekyoro 微信支付" src=/images/wechatpay.png><p>微信支付</div></div></div><div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者： </strong>Sekyoro<li class=post-copyright-link><strong>本文链接：</strong> <a href=https://www.sekyoro.top/2025/03/20/Java%E9%A1%B9%E7%9B%AE%E5%A4%A7%E8%B5%8F-%E5%AE%9E%E4%B9%A0%E7%89%88/ title=Java项目大赏(实习版)>https://www.sekyoro.top/2025/03/20/Java项目大赏-实习版/</a><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</ul></div><div class=followme><p>欢迎关注我的其它发布渠道<div class=social-list><div class=social-item><a class=social-link href=/images/wxqrcode.png target=_blank> <span class=icon> <i class="fab fa-weixin"></i> </span> <span class=label>WeChat</span> </a></div><div class=social-item><a class=social-link href=/images/website.png target=_blank> <span class=icon> <i class="fa fa-user"></i> </span> <span class=label>PersonalWebsite</span> </a></div><div class=social-item><a class=social-link href=https://my-astro-git-main-drowning-in-codes.vercel.app target=_blank> <span class=icon> <i class="fas fa-share"></i> </span> <span class=label>杂鱼分享</span> </a></div><div class=social-item><a class=social-link href=/atom.xml target=_blank> <span class=icon> <i class="fa fa-rss"></i> </span> <span class=label>RSS</span> </a></div></div></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i> Java</a></div><div class=post-nav><div class=post-nav-item><a href=/2025/03/12/TCP-IP%E4%B8%8EHTTP%E7%BC%96%E7%A8%8B/ rel=prev title=TCP/IP与HTTP编程> <i class="fa fa-chevron-left"></i> TCP/IP与HTTP编程 </a></div><div class=post-nav-item><a href=/2025/03/20/TinyHttpServer%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/ rel=next title=TinyWebServer项目学习> TinyWebServer项目学习 <i class="fa fa-chevron-right"></i> </a></div></div></footer></article></div><!-- 评论区 --><div class=comments><div data-id=city data-uid=MTAyMC81MzE5Ny8yOTY3Mg== id=lv-container></div></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class=sidebar><div class=sidebar-inner><!-- canvas粒子时钟 --><div><canvas id=canvas style=width:60%;>当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();</script><!-- require APlayer --><link href=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><!-- require MetingJS --><script src=/js/meting-js.js></script><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96><span class=nav-number>1.</span> <span class=nav-text>苍穹外卖</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Jwt%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81><span class=nav-number>1.0.0.1.</span> <span class=nav-text>Jwt登录验证</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%F0%9F%94%90-JWT-%E7%9A%84%E7%BB%93%E6%9E%84><span class=nav-number>1.0.1.</span> <span class=nav-text>🔐 JWT 的结构</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3><span class=nav-number>1.0.1.1.</span> <span class=nav-text>接口文档</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5><span class=nav-number>1.0.1.2.</span> <span class=nav-text>新增员工</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%91%98%E5%B7%A5><span class=nav-number>1.0.1.3.</span> <span class=nav-text>分页查询员工</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#POJO%E4%B8%AD%E6%97%A5%E6%9C%9F%E5%BA%8F%E5%88%97%E5%8C%96><span class=nav-number>1.0.1.4.</span> <span class=nav-text>POJO中日期序列化</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Cache><span class=nav-number>1.0.2.</span> <span class=nav-text>Spring Cache</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Task><span class=nav-number>1.0.3.</span> <span class=nav-text>Spring Task</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Websocket%E4%B8%BB%E5%8A%A8%E6%8E%A8%E9%80%81%E8%AE%A2%E5%8D%95%E6%B6%88%E6%81%AF><span class=nav-number>1.0.4.</span> <span class=nav-text>Websocket主动推送订单消息</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Apache-Echarts%E5%B1%95%E7%A4%BA%E4%BF%A1%E6%81%AF><span class=nav-number>1.0.5.</span> <span class=nav-text>Apache Echarts展示信息</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Apache-POI><span class=nav-number>1.0.6.</span> <span class=nav-text>Apache POI</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84><span class=nav-number>2.</span> <span class=nav-text>黑马点评</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Redis%E5%AD%A6%E4%B9%A0><span class=nav-number>2.0.1.</span> <span class=nav-text>Redis学习</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Data-Redis><span class=nav-number>2.0.2.</span> <span class=nav-text>Spring Data Redis</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8><span class=nav-number>2.0.2.1.</span> <span class=nav-text>序列化器</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%9F%BA%E4%BA%8ESession%E7%9A%84%E7%99%BB%E9%99%86><span class=nav-number>2.0.3.</span> <span class=nav-text>基于Session的登陆</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%9B%86%E7%BE%A4%E7%9A%84session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98><span class=nav-number>2.0.3.1.</span> <span class=nav-text>集群的session共享问题</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%9F%AD%E4%BF%A1%E7%99%BB%E9%99%86><span class=nav-number>2.0.3.2.</span> <span class=nav-text>基于Redis的短信登陆</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%BC%98%E5%8C%96%E6%8B%A6%E6%88%AA%E5%99%A8><span class=nav-number>2.0.3.3.</span> <span class=nav-text>优化拦截器</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%99%BB%E9%99%86%E4%BB%A5%E5%8F%8A%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98><span class=nav-number>2.0.3.4.</span> <span class=nav-text>登陆以及权限校验关键问题</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98><span class=nav-number>2.0.4.</span> <span class=nav-text>商户查询缓存</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5><span class=nav-number>2.0.5.</span> <span class=nav-text>缓存更新策略</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80><span class=nav-number>2.0.6.</span> <span class=nav-text>优惠券秒杀</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%82%B2%E8%A7%82%E9%94%81-%E4%B9%90%E8%A7%82%E9%94%81><span class=nav-number>2.0.6.1.</span> <span class=nav-text>悲观锁 乐观锁</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81><span class=nav-number>2.0.6.2.</span> <span class=nav-text>Redisson可重入锁</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%AF%E9%87%8D%E8%AF%95-%E6%9B%B4%E6%96%B0%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4><span class=nav-number>2.0.6.3.</span> <span class=nav-text>可重试/更新超时时间</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98><span class=nav-number>2.0.6.4.</span> <span class=nav-text>主从一致性问题</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97><span class=nav-number>2.0.6.5.</span> <span class=nav-text>Redis消息队列</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%9F%BA%E4%BA%8Elist%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84><span class=nav-number>2.0.6.6.</span> <span class=nav-text>基于list数据结构</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#pubsub-%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B6%88%E6%81%AF%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B><span class=nav-number>2.0.6.6.1.</span> <span class=nav-text>pubsub 点对点消息消息模型</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#Stream><span class=nav-number>2.0.6.6.2.</span> <span class=nav-text>Stream</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84><span class=nav-number>2.0.6.6.3.</span> <span class=nav-text>基于Stream的消息队列-消费者组</span></a></ol><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E7%BB%84><span class=nav-number>2.0.6.7.</span> <span class=nav-text>创建组</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF><span class=nav-number>2.0.6.8.</span> <span class=nav-text>读取消息</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4><span class=nav-number>2.0.6.9.</span> <span class=nav-text>消息确认</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E6%9C%AA%E7%A1%AE%E8%AE%A4%E6%B6%88%E6%81%AF><span class=nav-number>2.0.6.10.</span> <span class=nav-text>查看未确认消息</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E2%9C%85%E5%A6%82%E4%BD%95%E8%AE%A9%E6%B6%88%E8%B4%B9%E8%80%85%E8%AF%BB%E5%8F%96%E2%80%9C%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%E2%80%9D%EF%BC%9F><span class=nav-number>2.0.6.10.1.</span> <span class=nav-text>✅如何让消费者读取“历史消息”？</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97><span class=nav-number>2.0.7.</span> <span class=nav-text>达人探店</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD><span class=nav-number>2.0.7.1.</span> <span class=nav-text>点赞功能</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C><span class=nav-number>2.0.7.2.</span> <span class=nav-text>点赞排行榜</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8><span class=nav-number>2.0.7.3.</span> <span class=nav-text>好友关注</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8><span class=nav-number>2.0.7.4.</span> <span class=nav-text>共同关注</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81><span class=nav-number>2.0.7.5.</span> <span class=nav-text>关注推送</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7><span class=nav-number>2.0.7.6.</span> <span class=nav-text>附近商户</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0><span class=nav-number>2.0.7.7.</span> <span class=nav-text>用户签到</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1><span class=nav-number>2.0.7.8.</span> <span class=nav-text>签到统计</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#UV%E7%BB%9F%E8%AE%A1-HyperLogLog><span class=nav-number>2.0.7.9.</span> <span class=nav-text>UV统计 HyperLogLog</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyChat><span class=nav-number>3.</span> <span class=nav-text>EasyChat</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C><span class=nav-number>3.0.1.</span> <span class=nav-text>登录注册</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%99%BB%E9%99%86><span class=nav-number>3.0.1.1.</span> <span class=nav-text>登陆</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%B3%A8%E5%86%8C><span class=nav-number>3.0.1.2.</span> <span class=nav-text>注册</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.1.3.</span> <span class=nav-text>保存用户信息</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.1.4.</span> <span class=nav-text>获取用户信息</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9B%B4%E6%96%B0%E5%AF%86%E7%A0%81><span class=nav-number>3.0.1.5.</span> <span class=nav-text>更新密码</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%80%80%E5%87%BA><span class=nav-number>3.0.1.6.</span> <span class=nav-text>退出</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%BE%A4%E7%BB%84%E7%AE%A1%E7%90%86><span class=nav-number>3.0.2.</span> <span class=nav-text>群组管理</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E8%87%AA%E5%B7%B1%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.1.</span> <span class=nav-text>查看自己群聊</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E7%BE%A4%E8%81%8A%E4%BF%A1%E6%81%AF><span class=nav-number>3.0.2.2.</span> <span class=nav-text>查看群聊信息</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA-%E6%9B%B4%E6%96%B0%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.3.</span> <span class=nav-text>创建/更新群聊</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%A7%A3%E6%95%A3%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.4.</span> <span class=nav-text>解散群聊</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E9%80%80%E5%87%BA%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.5.</span> <span class=nav-text>退出群聊</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%A0%E9%99%A4%E6%88%96%E8%80%85%E6%B7%BB%E5%8A%A0%E7%BE%A4%E6%88%90%E5%91%98><span class=nav-number>3.0.2.6.</span> <span class=nav-text>删除或者添加群成员</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8A%A0%E5%85%A5%E7%BE%A4%E8%81%8A><span class=nav-number>3.0.2.7.</span> <span class=nav-text>加入群聊</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%94%E7%B3%BB%E4%BA%BA%E7%AE%A1%E7%90%86><span class=nav-number>3.0.3.</span> <span class=nav-text>联系人管理</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%90%9C%E7%B4%A2%E7%94%A8%E6%88%B7><span class=nav-number>3.0.3.1.</span> <span class=nav-text>搜索用户</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%94%B3%E8%AF%B7%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.3.2.</span> <span class=nav-text>申请添加联系人</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.3.3.</span> <span class=nav-text>直接添加联系人</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%8F%92%E5%85%A5%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.4.</span> <span class=nav-text>插入申请请求</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%9F%A5%E8%AF%A2%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.5.</span> <span class=nav-text>查询申请请求</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%A4%84%E7%90%86%E7%94%B3%E8%AF%B7%E8%AF%B7%E6%B1%82><span class=nav-number>3.0.3.6.</span> <span class=nav-text>处理申请请求</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%94%E7%B3%BB%E4%BA%BA%E8%AF%A6%E6%83%85-%E5%88%A0%E9%99%A4%E5%92%8C%E6%8B%89%E9%BB%91%E8%81%94%E7%B3%BB%E4%BA%BA><span class=nav-number>3.0.4.</span> <span class=nav-text>联系人详情,删除和拉黑联系人</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E3%80%81%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E4%B8%8E%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95><span class=nav-number>3.0.5.</span> <span class=nav-text>获取用户信息、修改密码与退出登录</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86><span class=nav-number>3.0.6.</span> <span class=nav-text>后台管理</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%99%BB%E9%99%86%E6%97%B6%E5%8A%A0%E8%BD%BD%E6%B6%88%E6%81%AF><span class=nav-number>3.0.7.</span> <span class=nav-text>登陆时加载消息</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%81%8A%E5%A4%A9><span class=nav-number>3.0.8.</span> <span class=nav-text>聊天</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF><span class=nav-number>3.0.8.1.</span> <span class=nav-text>发送消息</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6><span class=nav-number>3.0.8.2.</span> <span class=nav-text>上传文件</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6><span class=nav-number>3.0.8.3.</span> <span class=nav-text>下载文件</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyPan><span class=nav-number>4.</span> <span class=nav-text>EasyPan</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#IDE%E8%AE%BE%E7%BD%AE><span class=nav-number>4.0.1.</span> <span class=nav-text>IDE设置</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#JDK%E4%BD%8D%E7%BD%AE%E8%AE%BE%E7%BD%AE><span class=nav-number>4.0.1.1.</span> <span class=nav-text>JDK位置设置</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BC%96%E8%AF%91%E5%99%A8%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E4%B8%8E%E7%83%AD%E4%BA%A4%E6%8D%A2><span class=nav-number>4.0.1.2.</span> <span class=nav-text>编译器自动构建与热交换</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AE%BE%E7%BD%AEMaven%E4%BD%8D%E7%BD%AE><span class=nav-number>4.0.1.3.</span> <span class=nav-text>设置Maven位置</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%AE%BE%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BC%96%E7%A0%81><span class=nav-number>4.0.1.4.</span> <span class=nav-text>设置文件编码</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B><span class=nav-number>4.0.1.5.</span> <span class=nav-text>创建工程</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6><span class=nav-number>4.0.2.</span> <span class=nav-text>配置文件</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#POM-xml><span class=nav-number>4.0.2.1.</span> <span class=nav-text>POM.xml</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF><span class=nav-number>4.0.2.1.1.</span> <span class=nav-text>项目基本信息</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E7%BB%A7%E6%89%BF%E4%B8%8E%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86><span class=nav-number>4.0.2.1.2.</span> <span class=nav-text>继承与模块管理</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86><span class=nav-number>4.0.2.1.3.</span> <span class=nav-text>依赖管理</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9E%84%E5%BB%BA%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.1.4.</span> <span class=nav-text>构建配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%B1%9E%E6%80%A7%E5%AE%9A%E4%B9%89><span class=nav-number>4.0.2.1.5.</span> <span class=nav-text>属性定义</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9E%84%E5%BB%BA%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%8F%91%E5%B8%83%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.1.6.</span> <span class=nav-text>构建环境与发布配置</span></a></ol><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95><span class=nav-number>4.0.2.2.</span> <span class=nav-text>日志记录</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#application-properties><span class=nav-number>4.0.2.3.</span> <span class=nav-text>application.properties</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.1.</span> <span class=nav-text>服务器配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%BA%94%E7%94%A8%E4%BF%A1%E6%81%AF><span class=nav-number>4.0.2.3.2.</span> <span class=nav-text>应用信息</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%EF%BC%88%E4%BB%A5-MySQL-%E4%B8%BA%E4%BE%8B%EF%BC%89><span class=nav-number>4.0.2.3.3.</span> <span class=nav-text>数据源配置（以 MySQL 为例）</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.4.</span> <span class=nav-text>日志配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.5.</span> <span class=nav-text>邮件配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.6.</span> <span class=nav-text>安全配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.7.</span> <span class=nav-text>缓存配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%9B%BD%E9%99%85%E5%8C%96%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.8.</span> <span class=nav-text>国际化配置</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE><span class=nav-number>4.0.2.3.9.</span> <span class=nav-text>测试配置</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%9A%E5%8A%A1%E9%87%8D%E7%82%B9%E6%B5%81%E7%A8%8B><span class=nav-number>4.0.3.</span> <span class=nav-text>业务重点流程</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86><span class=nav-number>4.1.</span> <span class=nav-text>文件管理</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%9F%A5%E7%9C%8B%E6%96%87%E4%BB%B6><span class=nav-number>4.1.1.</span> <span class=nav-text>查看文件</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0><span class=nav-number>4.1.2.</span> <span class=nav-text>文件上传</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.</span> <span class=nav-text>文件预览</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%99%AE%E9%80%9A%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.1.</span> <span class=nav-text>普通文件预览</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BC%A9%E7%95%A5%E5%9B%BE%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.2.</span> <span class=nav-text>缩略图预览</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%A7%86%E9%A2%91%E9%A2%84%E8%A7%88><span class=nav-number>4.1.3.3.</span> <span class=nav-text>视频预览</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E5%88%86%E7%89%87%E4%B8%8B%E8%BD%BD%E6%97%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%90%BA%E5%B8%A6%E7%9A%84%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF><span class=nav-number>4.1.3.3.1.</span> <span class=nav-text>分片下载时客户端请求头携带的关键信息</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%9B%AE%E5%BD%95%E7%9B%B8%E5%85%B3><span class=nav-number>4.1.4.</span> <span class=nav-text>目录相关</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95><span class=nav-number>4.1.4.1.</span> <span class=nav-text>创建目录</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84><span class=nav-number>4.1.4.2.</span> <span class=nav-text>获取目录路径</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D><span class=nav-number>4.1.4.3.</span> <span class=nav-text>文件重命名</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%A7%BB%E5%8A%A8%E6%96%87%E4%BB%B6><span class=nav-number>4.1.4.4.</span> <span class=nav-text>移动文件</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6><span class=nav-number>4.1.4.5.</span> <span class=nav-text>删除文件</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%9B%9E%E6%94%B6%E7%AB%99%E5%9B%9E%E6%94%B6%E3%80%81%E8%BF%98%E5%8E%9F%E4%BB%A5%E5%8F%8A%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6><span class=nav-number>4.1.5.</span> <span class=nav-text>回收站回收、还原以及彻底删除文件</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%A4%96%E9%83%A8%E5%88%86%E4%BA%AB%E6%96%87%E4%BB%B6><span class=nav-number>4.1.6.</span> <span class=nav-text>外部分享文件</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#EasyLive><span class=nav-number>5.</span> <span class=nav-text>EasyLive</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%82%E8%80%83%E5%8D%9A%E4%B8%BB><span class=nav-number>5.0.1.</span> <span class=nav-text>参考博主</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Sekyoro class=site-author-image itemprop=image src=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg><p class=site-author-name itemprop=name>Sekyoro<div class=site-description itemprop=description>什么也无法舍弃的人，什么也做不了.</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>242</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>16</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>214</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item> <a title="Personal Website → http://proanimer.com" href=http://proanimer.com/ rel=noopener target=_blank><i class="fab fa-internet-explorer fa-fw"></i>Personal Website</a> </span><span class=links-of-author-item> <a title="GitHub → https://github.com/drowning-in-codes" href=https://github.com/drowning-in-codes rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item> <a title="E-Mail → mailto:bukalala174@gmail.com" href=mailto:bukalala174@gmail.com rel=noopener target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class=links-of-author-item> <a title="wxPublicAccount → https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd" href=https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd rel=noopener target=_blank><i class="fab fa-weixin fa-fw"></i>wxPublicAccount</a> </span><span class=links-of-author-item> <a title="RSS → /atom.xml" href=/atom.xml><i class="fa fa-rss fa-fw"></i>RSS</a> </span><span class=links-of-author-item> <a title="CSDN → https://blog.csdn.net/aqwca" href=https://blog.csdn.net/aqwca rel=noopener target=_blank><i class="fa fa-handshake fa-fw"></i>CSDN</a> </span><span class=links-of-author-item> <a title="杂鱼分享 → https://my-astro-git-main-drowning-in-codes.vercel.app" href=https://my-astro-git-main-drowning-in-codes.vercel.app/ rel=noopener target=_blank><i class="fas fa-share fa-fw"></i>杂鱼分享</a> </span></div><div class="links-of-blogroll motion-element"><div class=links-of-blogroll-title><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=http://myqhs.top/ rel=noopener target=_blank title=http://myqhs.top/>myqhs</a><li class=links-of-blogroll-item><a href=https://www.lllomh.com/ rel=noopener target=_blank title=https://www.lllomh.com/>芈渡</a><li class=links-of-blogroll-item><a href=https://protool-ten.vercel.app/ rel=noopener target=_blank title=https://protool-ten.vercel.app/>protools</a></ul></div><div class="motion-element announcement"><div class=title></div><p class=content><p class=date></div></div><meting-js id=6856787487 order=random server=netease type=playlist> </meting-js><div class=widget-wrap><h3 class=widget-title style=margin:0>文章词云</h3><div class="widget tagcloud" id=myCanvasContainer><canvas height=250 id=resCanvas style=width:100% width=250><ul class=tag-list itemprop=keywords><li class=tag-list-item><a class=tag-list-link href=/tags/Java/ rel=tag>Java</a><span class=tag-list-count>1</span></ul></canvas></div></div><script id=clustrmaps src=https://clustrmaps.com/map_v2.js?d=xQdGTxqARTBiNIwX2aUban-ixkj2s6VaZQWo-aVCgY8&cl=ffffff&w=a></script><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i><span>0%</span></div><!-- 边栏 --></div></aside><div id=sidebar-dimmer></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© Wed Apr 08 2020 08:00:00 GMT+0800 (中国标准时间) – <span itemprop=copyrightYear>2025</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>Sekyoro</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-chart-area"></i> </span><span title=站点总字数>2.7m</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span><span title=站点阅读时长>41:31</span></div><script async src=https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container_site_pv>总访问量<span id=busuanzi_value_site_pv></span>次</span><span class=post-meta-divider>|</span><span id=busuanzi_container_site_uv>总访客数<span id=busuanzi_value_site_uv></span>人</span><span class=post-meta-divider>|</span><!-- 不蒜子计数初始值纠正 --><script>$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});</script><div><span id=timeDate>载入天数...</span><span id=times>载入时分秒...</span><script>var now = new Date();
    function createtime() {
        var grt= new Date("04/08/2021 20:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);</script></div><div class=busuanzi-count><script async data-pjax src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span style="display: none;" class=post-meta-item id=busuanzi_container_site_uv> <span class=post-meta-item-icon> <i class="fa fa-user"></i> </span> <span class=site-uv title=总访客量> <span id=busuanzi_value_site_uv></span> </span> </span><span class=post-meta-divider>|</span><span style="display: none;" class=post-meta-item id=busuanzi_container_site_pv> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=site-pv title=总访问量> <span id=busuanzi_value_site_pv></span> </span> </span></div></div></footer></div><script color=0,0,255 count=99 opacity=0.5 src=/lib/canvas-nest/canvas-nest.min.js zindex=-1></script><script src=/lib/anime.min.js></script><script src=https://cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script><script src=https://cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script><script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js></script><script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/pisces.js></script><script src=/js/next-boot.js></script><script src=/js/bookmark.js></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax',
	'.widget-wrap'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
 
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script data-pjax>(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();</script><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js></script><script src=/js/algolia-search.js></script><script data-pjax>document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});</script><div id=pjax><script charset=utf-8 defer src=/js/outdate.js></script></div><script charset=utf-8 defer src=/js/tagcanvas.js></script><script charset=utf-8 defer src=/js/tagcloud.js></script><script>NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});</script><script>var OriginTitile = document.title;
  var titleTime;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      document.title = "(つェ⊂)我藏好了哦~" + OriginTitile;
      clearTimeout(titleTime);
    } else {
      document.title = "(*´∇｀*) 被你发现啦~" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });</script><script src=/js/src/activate-power-mode.min.js></script><script>POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);</script>