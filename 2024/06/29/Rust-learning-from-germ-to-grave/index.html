<!doctypehtml><html lang=zh-CN><script defer src=/live2d-widget/autoload.js></script><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content="Hexo 5.4.0" name=generator><link href=/images/blog_32px.png rel=apple-touch-icon sizes=180x180><link href=/images/blog_32px.png rel=icon sizes=32x32 type=image/png><link href=/images/blog_16px.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><meta content=EPrJAp11bJwHULpQUaSNSZ8_3RcvTsPDAEGOME4pl1w name=google-site-verification><!-- Google tag (gtag.js) --><!-- 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB21D8MKKW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VB21D8MKKW');
</script> --><!-- google adsense in head.swig --><script async crossorigin=anonymous src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123></script><meta content=7226864CE87CE9DE8C008385273846FF name=msvalidate.01><meta content=code-fjFXVtiL7j name=baidu-site-verification><link href=/css/main.css rel=stylesheet><link as=style href=https://fonts.googleapis.com/css?family=Roboto%20Mono,Roboto:300,300italic,400,400italic,700,700italic|Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext onload=this.rel='stylesheet' rel=preload><link as=style href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css onload=this.rel='stylesheet' rel=preload><link href=https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap rel=stylesheet><link href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/pace-js@1/pace.min.js></script><script id=hexo-configurations>var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.sekyoro.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":240,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"0F9LEEVW82","apiKey":"78839e9f9be09d081c5c4da81975cd19","indexName":"sekyoblog_sec","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};</script><link href=//cdn.bootcss.com/animate.css/3.5.0/animate.min.css rel=stylesheet><meta content="Rust官方推荐的三个资料,分别是The Rust programming language,Rust by examples以及ruslings,已经相当充足了.包括相对全面的书,代码例子以及方便的互动式exercises.个人觉得,the book相当于字典,虽然其实还有内容更多的reference,而examples更加易懂上手,rustlings相当于刷题,把关键东西了解一遍. 所以从这三" name=description><meta content=article property=og:type><meta content="Rust learning:from germ to grave" property=og:title><meta content=https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/index.html property=og:url><meta content=Sekyoro的博客小屋 property=og:site_name><meta content="Rust官方推荐的三个资料,分别是The Rust programming language,Rust by examples以及ruslings,已经相当充足了.包括相对全面的书,代码例子以及方便的互动式exercises.个人觉得,the book相当于字典,虽然其实还有内容更多的reference,而examples更加易懂上手,rustlings相当于刷题,把关键东西了解一遍. 所以从这三" property=og:description><meta content=zh_CN property=og:locale><meta content=https://s2.loli.net/2024/06/29/5tfZJquDxgvKros.png property=og:image><meta content=https://s2.loli.net/2024/06/29/gZaJPSIc5sdzM91.png property=og:image><meta content=2024-06-29T04:51:24.000Z property=article:published_time><meta content=2024-08-29T12:43:40.000Z property=article:modified_time><meta content=Sekyoro property=article:author><meta content=Rust property=article:tag><meta content=summary name=twitter:card><meta content=https://s2.loli.net/2024/06/29/5tfZJquDxgvKros.png name=twitter:image><link href=https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/ rel=canonical><script id=page-configurations>// https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };</script><title>Rust learning:from germ to grave | Sekyoro的博客小屋</title><noscript><style>.use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }</style></noscript><link href=/atom.xml rel=alternate title=Sekyoro的博客小屋 type=application/atom+xml><body itemscope itemtype=http://schema.org/WebPage><canvas style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" class=fireworks></canvas><script defer src=https://cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script defer src=/js/src/fireworks.js></script><div class="container use-motion"><div class=headband></div><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <span class=logo-line-before><i></i></span> <h1 class=site-title>Sekyoro的博客小屋</h1> <span class=logo-line-after><i></i></span> </a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu" id=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-bangumis"><a href=/bangumis/ rel=section><i class="fa fa-film fa-fw"></i>追番</a><li class="menu-item menu-item-resume"><a href=/resume/ rel=section><i class="fa fa-file-pdf fa-fw"></i>简历</a><li class="menu-item menu-item-materials"><a href=/materials/ rel=section><i class="fa fa-book fa-fw"></i>学习资料</a><li class="menu-item menu-item-sitemap"><a href=/sitemap.xml rel=section><i class="fa fa-sitemap fa-fw"></i>站点地图</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container></div><span class=popup-btn-close> <i class="fa fa-times-circle"></i> </span></div><div class=algolia-results><div id=algolia-stats></div><div id=algolia-hits></div><div class=algolia-pagination id=algolia-pagination></div></div></div></div></div></header><a class="book-mark-link book-mark-link-fixed" role=button></a><main class=main><div class=main-inner><div class=content-wrap><div class="content post posts-expand"><article class=post-block itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg itemprop=image> <meta content=Sekyoro itemprop=name> <meta content=什么也无法舍弃的人，什么也做不了. itemprop=description> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=Sekyoro的博客小屋 itemprop=name> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Rust learning:from germ to grave</h1><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-06-29 12:51:24" datetime=2024-06-29T12:51:24+08:00>2024-06-29</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2024-08-29 20:43:40" datetime=2024-08-29T20:43:40+08:00 itemprop=dateModified>2024-08-29</time> </span><span style="display: none;" class=post-meta-item id=busuanzi_container_page_pv title=阅读次数> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span> </span><br><span class=post-meta-item title=本文字数> <span class=post-meta-item-icon> <i class="far fa-file-word"></i> </span> <span class=post-meta-item-text>本文字数：</span> <span>19k</span> </span><span class=post-meta-item title=阅读时长> <span class=post-meta-item-icon> <i class="far fa-clock"></i> </span> <span class=post-meta-item-text>阅读时长 ≈</span> <span>17 分钟</span> </span></div></header><div class=post-body itemprop=articleBody><p>Rust官方推荐的三个资料,分别是The Rust programming language,Rust by examples以及ruslings,已经相当充足了.包括相对全面的书,代码例子以及方便的互动式exercises.个人觉得,the book相当于字典,虽然其实还有内容更多的reference,而examples更加易懂上手,rustlings相当于刷题,把关键东西了解一遍.<p>所以从这三个东西入手开始Rust学习之旅,一些地方会跟c++对比.<br><span id=more></span><h3 id=宏macro><a class=headerlink href=#宏macro title=宏macro></a>宏macro</h3><p>术语宏指的是Rust中的一系列特性:带有macro_rules的声明性宏!还有三种过程宏:<ul><li>Custom <code>#[derive]</code> macros that specify code added with the <code>derive</code> attribute used on structs and enums<li>Attribute-like macros that define custom attributes usable on any item<li>Function-like macros that look like function calls but operate on the tokens specified as their argument</ul><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=meta>#[macro_export]</span></span><br><span class=line><span class=built_in>macro_rules!</span> vec {</span><br><span class=line>    ( $( $x:expr ),* ) => {</span><br><span class=line>        {</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut</span> temp_vec = <span class=built_in>Vec</span>::new();</span><br><span class=line>            $(</span><br><span class=line>                temp_vec.push($x);</span><br><span class=line>            )*</span><br><span class=line>            temp_vec</span><br><span class=line>        }</span><br><span class=line>    };</span><br><span class=line>}</span><br></pre></table></figure><h3 id=变量binding><a class=headerlink href=#变量binding title=变量binding></a>变量binding</h3><p>知识点:<ol><li>不变性 Rust默认不可变,不像c++到处声明const<li>scope和shadowing 主要有variable shadowing,也就是可以重声明,在c++中不允许<li>将一个mut的值赋值给non-mut的值,在那个域内,non-mute的值也不能被改变</ol><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut</span> x = <span class=number>3</span>;</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Number {}"</span>, x);</span><br><span class=line>    x = <span class=number>5</span>; </span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Number {}"</span>, x);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> number = <span class=string>"T-H-R-E-E"</span>; <span class=comment>// don't change this line</span></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Spell a Number : {}"</span>, number);</span><br><span class=line>    <span class=keyword>let</span> number = <span class=number>3</span>; <span class=comment>// don't rename this variable</span></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Number plus two is : {}"</span>, number + <span class=number>2</span>);</span><br><span class=line>}</span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut</span> _mutable_integer = <span class=number>7i32</span>;</span><br><span class=line></span><br><span class=line>    {</span><br><span class=line>        <span class=comment>// Shadowing by immutable `_mutable_integer`</span></span><br><span class=line>        <span class=keyword>let</span> <span class=keyword>mut</span> _mutable_integer = _mutable_integer;</span><br><span class=line>        </span><br><span class=line>        _mutable_integer = <span class=number>50</span>;</span><br><span class=line>       </span><br><span class=line>        <span class=comment>// `_mutable_integer` goes out of scope</span></span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=comment>// Ok! `_mutable_integer` is not frozen in this scope</span></span><br><span class=line>    _mutable_integer = <span class=number>3</span>;</span><br></pre></table></figure><h3 id=Primitives><a class=headerlink href=#Primitives title=Primitives></a>Primitives</h3><h4 id=字面量和操作符><a class=headerlink href=#字面量和操作符 title=字面量和操作符></a>字面量和操作符</h4><ol><li>推荐在使用字面量是后面加上类型.<li>原生类型本身可以printable</ol><p>元组、数组与slices.<p>元组,通过()表示,通过.num索引,可以使用#[derive(Debug)]实现方法打印.<p>数组 [T;length]声明,编译时已知.<p>切片(Slices)与数组类似,但它们的长度在编译时是未知的。相反,切片是一个由两个字(word)组成的对象:第一个字是指向数据的指针,第二个字是切片的长度。字的大小与 <code>usize</code> 类型相同,由处理器架构决定,例如在 x86-64 上为 64 位。切片可用于借用数组的一部分,它的类型签名为 <code>&[T]</code>。<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=comment>// This function borrows a slice.</span></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>analyze_slice</span></span>(slice: &[<span class=built_in>i32</span>]) {</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"First element of the slice: {}"</span>, slice[<span class=number>0</span>]);</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"The slice has {} elements"</span>, slice.len());</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>let</span> xs: [<span class=built_in>i32</span>; <span class=number>5</span>] = [<span class=number>1</span>, <span class=number>2</span>, <span class=number>3</span>, <span class=number>4</span>, <span class=number>5</span>];</span><br><span class=line><span class=comment>// All elements can be initialized to the same value.</span></span><br><span class=line><span class=keyword>let</span> ys: [<span class=built_in>i32</span>; <span class=number>500</span>] = [<span class=number>0</span>; <span class=number>500</span>];</span><br><span class=line><span class=built_in>println!</span>(<span class=string>"Borrow the whole array as a slice."</span>);</span><br><span class=line>analyze_slice(&xs);</span><br></pre></table></figure><h3 id=自定义类型><a class=headerlink href=#自定义类型 title=自定义类型></a>自定义类型</h3><h4 id=structures><a class=headerlink href=#structures title=structures></a>structures</h4><p>使用 <code>struct</code> 关键字可以创建三种类型的结构体(struct):<ol><li>元组结构体(Tuple structs)，基本上是命名元组。<li>经典的 C 风格结构体。<li>无字段的单元结构体(Unit structs)，在泛型编程中很有用。</ol><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line><span class=meta>#[derive(Debug)]</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Person</span></span> {</span><br><span class=line>    name: <span class=built_in>String</span>,</span><br><span class=line>    age: <span class=built_in>u8</span>,</span><br><span class=line>}</span><br><span class=line><span class=comment>// A unit struct</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Unit</span></span>;</span><br><span class=line></span><br><span class=line><span class=comment>// A tuple struct</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Pair</span></span>(<span class=built_in>i32</span>, <span class=built_in>f32</span>);</span><br><span class=line></span><br><span class=line><span class=comment>// A struct with two fields</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Point</span></span> {</span><br><span class=line>    x: <span class=built_in>f32</span>,</span><br><span class=line>    y: <span class=built_in>f32</span>,</span><br><span class=line>}</span><br><span class=line><span class=comment>// A tuple struct</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Pair</span></span>(<span class=built_in>i32</span>, <span class=built_in>f32</span>);</span><br><span class=line><span class=comment>// Instantiate a tuple struct</span></span><br><span class=line><span class=keyword>let</span> pair = Pair(<span class=number>1</span>, <span class=number>0.1</span>);</span><br><span class=line></span><br><span class=line><span class=comment>// Access the fields of a tuple struct</span></span><br><span class=line><span class=built_in>println!</span>(<span class=string>"pair contains {:?} and {:?}"</span>, pair.<span class=number>0</span>, pair.<span class=number>1</span>);</span><br><span class=line></span><br><span class=line><span class=comment>// Destructure a tuple struct</span></span><br><span class=line><span class=keyword>let</span> Pair(integer, decimal) = pair;</span><br></pre></table></figure><h4 id=Enums><a class=headerlink href=#Enums title=Enums></a>Enums</h4><p><code>enum</code>关键字允许创建一个可以是几种不同变体(variant)之一的类型。任何在结构体(struct)中有效的变体,在枚举(enum)中也是有效的。<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>enum</span> <span class=title>IpAddrKind</span></span> {</span><br><span class=line>    V4,</span><br><span class=line>    V6,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>IpAddr</span></span> {</span><br><span class=line>    kind: IpAddrKind,</span><br><span class=line>    address: <span class=built_in>String</span>,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>let</span> home = IpAddr {</span><br><span class=line>    kind: IpAddrKind::V4,</span><br><span class=line>    address: <span class=built_in>String</span>::from(<span class=string>"127.0.0.1"</span>),</span><br><span class=line>};</span><br><span class=line></span><br><span class=line><span class=keyword>let</span> loopback = IpAddr {</span><br><span class=line>    kind: IpAddrKind::V6,</span><br><span class=line>    address: <span class=built_in>String</span>::from(<span class=string>"::1"</span>),</span><br><span class=line>};</span><br></pre></table></figure><h4 id=constants><a class=headerlink href=#constants title=constants></a>constants</h4><p>Rust 有两种不同类型的常量,可以在任何作用域(包括全局)中声明。两种常量都需要显式的类型注解:<ol><li><code>const</code>: 不可变的值(最常见的情况)。<li><code>static</code>: 可能是可变的变量,拥有 <code>'static</code> 生命周期。<code>'static</code> 生命周期是被推断出来的,不需要显式指定。访问或修改可变的 <code>static</code> 变量是不安全的</ol><h3 id=工具><a class=headerlink href=#工具 title=工具></a>工具</h3><h4 id=强大的包管理系统><a class=headerlink href=#强大的包管理系统 title=强大的包管理系统></a>强大的包管理系统</h4><p>一个rust项目可能是lib也可以是main,分别代表生成库和可执行程序. 注意可以既存在main.rs和lib.rs.<ul><li><strong>Packages:</strong> A Cargo feature that lets you build, test, and share crates<li><strong>Crates:</strong> A tree of modules that produces a library or executable<li><strong>Modules</strong> and <strong>use:</strong> Let you control the organization, scope, and privacy of paths<li><strong>Paths:</strong> A way of naming an item, such as a struct, function, or module</ul><p>crate根文件是Rust编译器启动的源文件,它构成了crate的根模块<p>包(Packages)是提供一组功能的一个或多个crate的集合。一个包包含一个Cargo.toml。描述如何构建这些crate的Toml文件。Cargo实际上是一个包，其中包含用于构建代码的命令行工具的二进制crate。Cargo包还包含一个二进制包所依赖的库包。其他项目可以依赖Cargo库crate来使用Cargo命令行工具使用的相同逻辑。<p>crate有两种形式:二进制(binary)crate或库(library )crate。二进制crate是可以编译为可运行的可执行文件的程序，例如命令行程序或服务器。每个程序都必须有一个名为main的函数，用于定义可执行程序运行时发生的情况。<p>library crate<strong>没有main函数</strong>，也不能编译成可执行文件。相反，它们定义了旨在与多个项目共享的功能。<h5 id=项目结构><a class=headerlink href=#项目结构 title=项目结构></a>项目结构</h5><ol><li><p>从crate根目录开始:当编译一个crate时，编译器<strong>首先查找crate根文件</strong>(通常是src/lib.rs,为库crate或src/main.rs表示二进制文件)用于编译代码。</p><li><p>声明模块:在crate根文件中，你可以声明新的模块;假设你用mod garden;声明了一个“花园”模块。编译器将在这些地方查找模块的代码：</p> <p>内联下载mod garden之后</p> <p>在src/garden.rs文件中</p> <p>在src/garden/mod.rs文件中 查找模块的规律就是同级目录同名文件或者同名子目录中的<code>mod.rs</code>文件</p><li><p>声明子模块:在crate根目录之外的任何文件中(除了<code>src/main/lib.rs</code>的文件中)，都可以声明子模块。例如，你可以声明mod vegetables;在<code>src/garden.rs</code>。编译器将在以下地方以父模块命名的目录中查找子模块的代码:</p> <p>内联，直接跟在mod vegetables后面</p> <p>在src/garden/vegetables.rs文件中</p> <p>在src/garden/vegetables/mod.rs文件中 查找子模块的规律就是与文件同名子目录中的同名模块文件或者同名模块目录中的<code>mod.rs</code>文件</p><li><p>模块中的代码路径:一旦模块成为crate的一部分,只要隐私规则允许,就可以使用代码路径从同一crate中的任何其他地方引用该模块中的代码。例如，garden vegetables模块中的Asparagus类型可以在crate::garden::vegetables::Asparagus中找到。</p><li><p>私有vs.公共:默认情况下，模块内的代码对其父模块是私有的。要使一个模块为公共，请使用pub mod而不是mod声明它。要使公共模块中的项也为公共，请在声明它们之前使用pub。</p><li><p>use关键字:在作用域中，use关键字创建项的快捷方式，以减少长路径的重复。在任何可以引用crate::garden::vegetables::Asparagus的作用域中，你可以使用crate::garden::vegetables::Asparagus创建一个快捷方式;从那时起，你只需要编写Asparagus就可以在作用域中使用该类型。</p> <p>​ 注意,<code>use</code>是用于减少名称重复的,<code>pub mod</code>才是用于引入的.</p> <p>使用<code>mod</code>组织代码结构,提到src/main.rs和src/lib.rs被称为crate roots.命名的原因是这两个文件的内容在crate的模块结构(称为模块树)的根位置形成了一个名为crate的模块</p> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line><span class=keyword>mod</span> front_of_house {</span><br><span class=line>    <span class=keyword>mod</span> hosting {</span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>add_to_waitlist</span></span>() {}</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>seat_at_table</span></span>() {}</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>mod</span> serving {</span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>take_order</span></span>() {}</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>serve_order</span></span>() {}</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>take_payment</span></span>() {}</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line><span class=comment>/// 模块树,注意</span></span><br><span class=line><span class=string>""</span><span class=string>"</span></span><br><span class=line><span class=string>crate</span></span><br><span class=line><span class=string> └── front_of_house</span></span><br><span class=line><span class=string>     ├── hosting</span></span><br><span class=line><span class=string>     │   ├── add_to_waitlist</span></span><br><span class=line><span class=string>     │   └── seat_at_table</span></span><br><span class=line><span class=string>     └── serving</span></span><br><span class=line><span class=string>         ├── take_order</span></span><br><span class=line><span class=string>         ├── serve_order</span></span><br><span class=line><span class=string>         └── take_payment</span></span><br><span class=line><span class=string>"</span><span class=string>""</span></span><br></pre></table></figure> <p><strong>Path</strong></p> <p>在模块树中如何找到一个item</p> <p><strong>绝对路径</strong>是从crate根目录开始的完整路径;对于来自外部crate的代码，绝对路径以crate名称开头，而对于来自当前crate的代码，它以文字crate开头。</p> <p>相对路径从当前模块开始，使用当前模块中的self、super或标识符。</p></ol><p>父模块中的项不能使用子模块中的私有项，但子模块中的项可以使用其祖先模块中的项。这是因为子模块封装并隐藏了它们的实现细节，但是子模块可以看到它们被定义的上下文。<p>sibling之间可以调用模块,比如同在crate下的函数和模块,这个函数可以直接调用模块而不使用pub.<p><strong>相对路径</strong><p>使用super,self等引入.<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>fn</span> <span class=title>deliver_order</span></span>() {}</span><br><span class=line></span><br><span class=line><span class=keyword>mod</span> back_of_house {</span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>fix_incorrect_order</span></span>() {</span><br><span class=line>        cook_order();</span><br><span class=line>        super::deliver_order();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>cook_order</span></span>() {}</span><br><span class=line>}</span><br></pre></table></figure><p>注意使得模块中的enum,structs,函数等pub才能访问.<blockquote><p>一个包可以同时包含src/main。Rs二进制crate根以及src/lib。默认情况下，两个crate都有包名。通常，具有这种既包含库又包含二进制crate模式的包在二进制crate中会有足够的代码来启动调用库crate中的代码的可执行文件。这使得其他项目可以从包提供的大部分功能中受益，因为库crate的代码可以共享</blockquote><p>使用<code>use</code>将paths引入作用域,要使用的话就要在同一mod作用域中.<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>mod</span> front_of_house {</span><br><span class=line>    <span class=keyword>pub</span> <span class=keyword>mod</span> hosting {</span><br><span class=line>        <span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>add_to_waitlist</span></span>() {}</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>use</span> crate::front_of_house::hosting;</span><br><span class=line></span><br><span class=line><span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>eat_at_restaurant</span></span>() {</span><br><span class=line>    hosting::add_to_waitlist();</span><br><span class=line>}</span><br></pre></table></figure><p>使用use将函数的父模块带入作用域意味着我们必须在调用函数时指定父模块。在调用函数时指定父模块可以清楚地表明该函数不是本地定义的，同时仍然可以最大限度地减少完整路径的重复。此外在使用struct、enum和其他项时，习惯上指定完整路径。<p>对于将两个具有相同名称的类型带入相同作用域的问题,除了引入父模块，还有另一种解决方案:在路径之后，可以为类型指定as和一个新的本地名称或别名。<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>use</span> std::fmt::<span class=built_in>Result</span>;</span><br><span class=line><span class=keyword>use</span> std::io::<span class=built_in>Result</span> <span class=keyword>as</span> IoResult;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>function1</span></span>() -> <span class=built_in>Result</span> {</span><br><span class=line>    <span class=comment>// --snip--</span></span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>function2</span></span>() -> IoResult<()> {</span><br><span class=line>    <span class=comment>// --snip--</span></span><br><span class=line>}</span><br></pre></table></figure><p>使用use关键字将名称引入作用域时，在新作用域中可用的名称是private。为了使调用代码的代码能够引用该名称，就好像它是在该代码的作用域中定义的一样，可以组合pub和use。这种技术被称为再导出<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=comment>// restaurant  src/lib.rs</span></span><br><span class=line><span class=keyword>mod</span> front_of_house {</span><br><span class=line>    <span class=keyword>pub</span> <span class=keyword>mod</span> hosting {</span><br><span class=line>        <span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>add_to_waitlist</span></span>() {}</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>pub</span> <span class=keyword>use</span> crate::front_of_house::hosting;</span><br><span class=line></span><br><span class=line><span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>eat_at_restaurant</span></span>() {</span><br><span class=line>    hosting::add_to_waitlist();</span><br><span class=line>}</span><br></pre></table></figure><p>在更改之前，外部代码必须通过restaurant::front_of_house::hosting::add_to_waitlist()来调用add_to_waitlist函数，这也需要将front_of_house模块标记为pub.现在外部代码可以使用restaurant::hosting::add_to_waitlist()代替。<p>标准std库也是一个包外部的crate。因为标准库是随Rust语言一起提供的，所以不需要更改Cargo.toml。但是需要用use来引用它，以便将其中的项引入包的作用域。<p>推荐模块命名不要为<code>mod.rs</code>,使用名为<code>mod.rs</code>文件的风格的主要缺点是项目最终可能会有许多名为mod.rs的文件,当同时在编辑器中打开它们时,这可能会令人困惑。<h3 id=使用Cargo构建大项目><a class=headerlink href=#使用Cargo构建大项目 title=使用Cargo构建大项目></a>使用Cargo构建大项目</h3><h4 id=Release><a class=headerlink href=#Release title=Release></a>Release</h4><p>在debug和release构建时可以使用不同的选项,在<code>Cargo.toml</code>中<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>[profile.dev]</span><br><span class=line>opt-level = <span class=number>0</span></span><br><span class=line></span><br><span class=line>[profile.release]</span><br><span class=line>opt-level = <span class=number>3</span></span><br></pre></table></figure><p>Cargo有两个主要配置profiles:运行Cargo构建时使用的开发配置文件和运行Cargo构建—发布时使用的发布配置文件。运行<code>cargo build --release</code>使用<code>release</code> profile.<p>当没有显式地添加任何profiles时，Cargo对应用的每个profiles都有默认设置。通过添加[profile.]*]部分，自定义的任何配置文件,覆盖任何子集的默认设置。<p>option-level设置控制Rust将应用于代码的优化数量，范围为0到3。应用更多的优化会延长编译时间，因此，如果您正在开发并经常编译代码，那么您可能希望通过更少的优化来加快编译速度，即使结果代码运行得更慢。<p>因此dev的默认选项级别为0。准备发布代码时，最好花更多的时间进行编译。将只在发布模式下编译一次，但是将多次运行编译后的程序，因此发布模式以较长的编译时间换取运行速度更快的代码<p>使用<code>cargo publish</code>进行发布,注意需要注册crates.io账号,如果需要更新版本更改<code>version</code>再推送即可<figure class="highlight toml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=section>[package]</span></span><br><span class=line><span class=attr>name</span> = <span class=string>"guessing_game"</span></span><br><span class=line><span class=attr>version</span> = <span class=string>"0.1.0"</span></span><br><span class=line><span class=attr>edition</span> = <span class=string>"2021"</span></span><br><span class=line><span class=attr>description</span> = <span class=string>"A fun game where you guess what number the computer has chosen."</span></span><br><span class=line><span class=attr>license</span> = <span class=string>"MIT OR Apache-2.0"</span></span><br><span class=line></span><br><span class=line><span class=section>[dependencies]</span></span><br></pre></table></figure><p>使用<code>cargo yank --vers [versionNumber]</code>可以阻止使用这个项目的某个版本的依赖.<p>yank一个版本可以防止新项目依赖于该版本，同时允许所有依赖于该版本的现有项目继续进行。<h4 id=workspaces><a class=headerlink href=#workspaces title=workspaces></a>workspaces</h4><p>工作区是一组共享Cargo.lock,和输出目录的packages. 常见工作流是一个可执行文件的packages和多个生成库的packages.<p>在根目录下创建<code>Cargo.toml</code>,其中添加packages名字,假设根目录名字add<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>[workspace]</span><br><span class=line></span><br><span class=line>members = [</span><br><span class=line>    <span class=string>"adder"</span>,</span><br><span class=line>]</span><br></pre></table></figure><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cargo new adder</span><br></pre></table></figure><p>目录结构如下<figure class="highlight reasonml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>├── <span class=module-access><span class=module><span class=identifier>Cargo</span>.</span></span>lock</span><br><span class=line>├── <span class=module-access><span class=module><span class=identifier>Cargo</span>.</span></span>toml</span><br><span class=line>├── adder</span><br><span class=line>│   ├── <span class=module-access><span class=module><span class=identifier>Cargo</span>.</span></span>toml</span><br><span class=line>│   └── src</span><br><span class=line>│       └── main.rs</span><br><span class=line>└── target</span><br></pre></table></figure><p>工作区在顶层有一个目标目录，编译后的工件将被放置到该目录中;adder包没有自己的目标目录。即使要从adder目录中运行cargo构建，编译后的工件仍然会在add/target而不是add/adder/target中结束。Cargo在工作区的目标目录中采用这样的结构，因为工作区的crate是相互依赖的。<blockquote><p>如果每个crate都有自己的目标目录，那么每个crate都必须重新编译工作空间中的其他crate，以便将工件放置在自己的目标目录中。通过共享一个目标目录，crate可以避免不必要的重新构建。</blockquote><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cargo new add_one --lib</span><br></pre></table></figure><p>继续添加crate,加入workspace中.<figure class="highlight toml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=section>[workspace]</span></span><br><span class=line><span class=attr>members</span> = [</span><br><span class=line>    <span class=string>"adder"</span>,</span><br><span class=line>    <span class=string>"add_one"</span>,</span><br><span class=line>]</span><br></pre></table></figure><p>添加本地项目中的依赖<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// adder/Cargo.toml</span></span><br><span class=line>[dependencies]</span><br><span class=line>add_one = { path = <span class=string>"../add_one"</span> }</span><br></pre></table></figure><p>在顶层目录运行<code>cargo build</code>,然后指定<code>-p</code>运行指定可执行程序<code>cargo run -p adder</code><p>如果要使workspace下两个crate使用同一版本同一个依赖,可以使得其中一个crate依赖另一个依赖,build之后在顶层cargo.lock中会有相关依赖信息.<blockquote><p>Cargo将确保工作空间中使用rand包的每个包中的每个crate都使用相同的版本，只要它们指定rand的兼容版本，就可以节省空间并确保工作空间中的crate彼此兼容</blockquote><p>workspace中的项目测试,在顶层目录中<code>cargo test</code>运行每个crate中的测试,使用<code>cargo test -p</code>指定,发布项目同理,<code>cargo publish -p</code>.<p><code>cargo install</code>命令在本地安装和使用二进制crate.<p>所有使用cargo install安装的二进制文件都存储在安装根目录的bin文件夹中。如果没有任何自定义配置，这个目录将是<code>$HOME/.cargo/bin</code><p>如果<code>$PATH</code>中的二进制文件名为<code>cargo-something</code>，则可以通过运行Cargo something来将其作为Cargo子命令运行。在运行cargo——list时会列出这样的自定义命令。<h4 id=cargo-fmt-clippy><a title="cargo fmt/clippy" class=headerlink href=#cargo-fmt-clippy></a>cargo fmt/clippy</h4><p>分别用于格式化和语法提示<h4 id=cargo-doc><a title="cargo doc" class=headerlink href=#cargo-doc></a>cargo doc</h4><p>非常方便的生成文档的工具<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cargo doc --no-deps --open</span><br></pre></table></figure><h4 id=test><a class=headerlink href=#test title=test></a>test</h4><p>单元测试 集成测试 benchmarks<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cargo <span class=built_in>test</span></span><br></pre></table></figure><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=meta>#[cfg(test)]</span></span><br><span class=line><span class=keyword>mod</span> test{</span><br><span class=line><span class=keyword>use</span> super::*;</span><br><span class=line><span class=meta>#[test]</span></span><br><span class=line>    func(){</span><br><span class=line>        <span class=built_in>assert_eq!</span>();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>}</span><br></pre></table></figure><p>此外也有doc-test,用于测试文档中的代码.尝试使用<code>criterion</code><a href=https://bheisler.github.io/criterion.rs/book/index.html rel=noopener target=_blank>Criterion.rs - Criterion.rs Documentation (bheisler.github.io)</a>进行benchmark测试.<h4 id=log><a class=headerlink href=#log title=log></a>log</h4><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=keyword>use</span> log::{error,warn,info,debug,trace};</span><br><span class=line>error!();</span><br><span class=line>warn!();</span><br><span class=line>info!();</span><br><span class=line>debug!();</span><br><span class=line>trace!();</span><br></pre></table></figure><h3 id=dyn><a class=headerlink href=#dyn title=dyn></a>dyn</h3><p>Rust 编译器需要知道每个函数的返回类型需要多少空间。这意味着所有函数都必须返回一个具体类型。与其他语言不同，如果你有个像 <code>Animal</code> 那样的的 trait，则不能编写返回 <code>Animal</code> 的函数，因为其不同的实现将需要不同的内存量。<p>但是，<strong>有一个简单的解决方法。相比于直接返回一个 trait 对象，我们的函数返回一个包含一些 <code>Animal</code> 的 <code>Box</code></strong>。<figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>trait</span> <span class=title>walk</span></span> {</span><br><span class=line> <span class=function><span class=keyword>fn</span> <span class=title>xx</span></span>();</span><br><span class=line>}</span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>a</span></span> {</span><br><span class=line></span><br><span class=line>}</span><br><span class=line><span class=keyword>impl</span> walk <span class=keyword>for</span> a {</span><br><span class=line> <span class=function><span class=keyword>fn</span> <span class=title>xx</span></span>(){}</span><br><span class=line>}</span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>b</span></span> {</span><br><span class=line></span><br><span class=line>}</span><br><span class=line><span class=keyword>impl</span> walk <span class=keyword>for</span> b {</span><br><span class=line> <span class=function><span class=keyword>fn</span> <span class=title>xx</span></span>(){}</span><br><span class=line>}</span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>	<span class=keyword>let</span> t = <span class=built_in>vec!</span>[<span class=built_in>Box</span>::new(a{]}),<span class=built_in>Box</span>::new(b{})]; <span class=comment>// Box&LTdyn walk></span></span><br><span class=line>}</span><br></pre></table></figure><p><code>box</code> 只是对堆中某些内存的引用。因为引用的大小是静态已知的，并且编译器可以保证引用指向已分配的堆 <code>Animal</code>，所以可以从函数中返回 trait.<p>每当在堆上分配内存时，Rust 都会尝试尽可能明确。因此，如果<strong>函数以这种方式返回指向堆的 trait 指针，则需要使用 <code>dyn</code> 关键字编写返回类型</strong><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Sheep</span></span> {}</span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Cow</span></span> {}</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>trait</span> <span class=title>Animal</span></span> {</span><br><span class=line>    <span class=comment>// 实例方法签名</span></span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>noise</span></span>(&<span class=keyword>self</span>) -> &<span class=symbol>'static</span> <span class=built_in>str</span>;</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>// 实现 `Sheep` 的 `Animal` trait。</span></span><br><span class=line><span class=keyword>impl</span> Animal <span class=keyword>for</span> Sheep {</span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>noise</span></span>(&<span class=keyword>self</span>) -> &<span class=symbol>'static</span> <span class=built_in>str</span> {</span><br><span class=line>        <span class=string>"baaaaah!"</span></span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>// 实现 `Cow` 的 `Animal` trait。</span></span><br><span class=line><span class=keyword>impl</span> Animal <span class=keyword>for</span> Cow {</span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>noise</span></span>(&<span class=keyword>self</span>) -> &<span class=symbol>'static</span> <span class=built_in>str</span> {</span><br><span class=line>        <span class=string>"moooooo!"</span></span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment>// 返回一些实现 Animal 的结构体，但是在编译时我们不知道哪个结构体。</span></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>random_animal</span></span>(random_number: <span class=built_in>f64</span>) -> <span class=built_in>Box</span><<span class=keyword>dyn</span> Animal> {</span><br><span class=line>    <span class=keyword>if</span> random_number < <span class=number>0.5</span> {</span><br><span class=line>        <span class=built_in>Box</span>::new(Sheep {})</span><br><span class=line>    } <span class=keyword>else</span> {</span><br><span class=line>        <span class=built_in>Box</span>::new(Cow {})</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> random_number = <span class=number>0.234</span>;</span><br><span class=line>    <span class=keyword>let</span> animal = random_animal(random_number);</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"You've randomly chosen an animal, and it says {}"</span>, animal.noise());</span><br><span class=line>}</span><br></pre></table></figure><h3 id=智能指针><a class=headerlink href=#智能指针 title=智能指针></a>智能指针</h3><p>与C++类似,rust也使用了一套机制保证内存安全. 智能指针相比于借用(引用)来说,其在大多数情况下拥有所有权.<p>常用智能指针类型如下<ul><li><code>Box&LTT></code> for allocating values on the heap<li><code>Rc&LTT></code>, a reference counting type that enables multiple ownership<li><p><code>Ref&LTT></code> and <code>RefMut&LTT></code>, accessed through <code>RefCell&LTT></code>, a type that enforces the borrowing rules at runtime instead of compile time</p><li><p><strong>RefCell</strong>：智能指针，允许运行时动态获取可变引用，跟踪借用以保证安全性</p><li><strong>Arc</strong>:线程安全的reference counting type</ul><p>此外,有<strong>Ref</strong>:用于在不可变借用的情况下安全地访问数据和<strong>Cell</strong>分别用来安全访问数据.<h4 id=Box><a class=headerlink href=#Box title=Box></a>Box</h4><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>enum</span> <span class=title>List</span></span> {</span><br><span class=line>    Cons(<span class=built_in>i32</span>, <span class=built_in>Box</span>&LTList>),</span><br><span class=line>    Nil,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>use</span> crate::List::{Cons, Nil};</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> list = Cons(<span class=number>1</span>, <span class=built_in>Box</span>::new(Cons(<span class=number>2</span>, <span class=built_in>Box</span>::new(Cons(<span class=number>3</span>, <span class=built_in>Box</span>::new(Nil))))));</span><br><span class=line>}</span><br></pre></table></figure><h4 id=Rc><a class=headerlink href=#Rc title=Rc></a>Rc</h4><p>你必须通过使用Rust类型Rc\<t>显式地启用多重所有权，Rc\<t>是引用计数的缩写。Rc\<t>类型跟踪对一个值的引用次数，以确定该值是否仍在使用。如果对一个值的引用为零，则可以清除该值，而不会导致任何引用无效。 <p>当<strong>想要在堆上分配一些数据供程序的多个部分读取,并且在编译时无法确定哪个部分将最后使用该数据时</strong>,使用Rc\<t>类型。<strong>如果知道哪一部分将最后完成,就可以将该部分设置为数据的所有者,并且在编译时强制执行的正常所有权规则将生效。</strong> <p>注意，<strong>Rc\<t>仅用于单线程场景 <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>enum</span> <span class=title>List</span></span> {</span><br><span class=line>    Cons(<span class=built_in>i32</span>, Rc&LTList>),</span><br><span class=line>    Nil,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>use</span> crate::List::{Cons, Nil};</span><br><span class=line><span class=keyword>use</span> std::rc::Rc;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> a = Rc::new(Cons(<span class=number>5</span>, Rc::new(Cons(<span class=number>10</span>, Rc::new(Nil)))));</span><br><span class=line>    <span class=keyword>let</span> b = Cons(<span class=number>3</span>, Rc::clone(&a));</span><br><span class=line>    <span class=keyword>let</span> c = Cons(<span class=number>4</span>, Rc::clone(&a));</span><br><span class=line>}</span><br></pre></table></figure> <p>Rust中，<code>Cell</code> 是标准库中的一个类型，它提供了一种在可变引用的限制下安全地更新数据的方法。<code>Cell</code> 是一个非线程安全的类型，主要用于单线程环境下的可变状态管理。</p> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=keyword>use</span> std::cell::Cell;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=comment>// 创建一个 Cell</span></span><br><span class=line>    <span class=keyword>let</span> count = Cell::new(<span class=number>0</span>);</span><br><span class=line></span><br><span class=line>    <span class=comment>// 使用 get() 获取值</span></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Initial value: {}"</span>, count.get());</span><br><span class=line></span><br><span class=line>    <span class=comment>// 使用 set() 修改值</span></span><br><span class=line>    count.set(<span class=number>10</span>);</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"New value: {}"</span>, count.get());</span><br><span class=line>}</span><br></pre></table></figure> <p>与Rc\<t>不同，RefCell\<t>类型表示它所持有的数据的单一所有权. <p>通过引用和Box\<t>，借用规则的不变量在编译时强制执行。使用RefCell\<t>，这些<strong>不变量在运行时强制执行</strong>。对于引用，如果违反了这些规则，就会出现编译器错误。对于RefCell\<t>，如果你违反了这些规则，你的程序就会panic并退出。 <blockquote><p>在编译时检查借用规则的优点是，在开发过程中可以更快地捕获错误，并且不会对运行时性能产生影响，因为所有的分析都是事先完成的。由于这些原因，在大多数情况下，在编译时检查借用规则是最好的选择，这就是为什么这是Rust的默认值。<p>在运行时检查借阅规则的优点是，在编译时检查不允许的情况下，允许某些内存安全的场景。静态分析和Rust编译器一样，本质上是保守的。代码的一些属性是不可能通过分析代码来检测的</blockquote> <p>与Rc\<t>类似，RefCell\<t>仅用于单线程场景，如果您尝试在多线程上下文中使用它，则会给您一个编译时错误。(尝试使用Mutex以及Arc) <h4 id=Arc><a class=headerlink href=#Arc title=Arc></a>Arc</h4><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=keyword>use</span> std::sync::{Arc, Mutex};</span><br><span class=line><span class=keyword>use</span> std::thread;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> counter = Arc::new(Mutex::new(<span class=number>0</span>));</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut</span> handles = <span class=built_in>vec!</span>[];</span><br><span class=line></span><br><span class=line>    <span class=keyword>for</span> _ <span class=keyword>in</span> <span class=number>0</span>..<span class=number>10</span> {</span><br><span class=line>        <span class=keyword>let</span> counter = Arc::clone(&counter);</span><br><span class=line>        <span class=keyword>let</span> handle = thread::spawn(<span class=keyword>move</span> || {</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut</span> num = counter.lock().unwrap();</span><br><span class=line></span><br><span class=line>            *num += <span class=number>1</span>;</span><br><span class=line>        });</span><br><span class=line>        handles.push(handle);</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>for</span> handle <span class=keyword>in</span> handles {</span><br><span class=line>        handle.join().unwrap();</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"Result: {}"</span>, *counter.lock().unwrap());</span><br><span class=line>}</span><br></pre></table></figure> <h4 id=Weak><a class=headerlink href=#Weak title=Weak></a>Weak</h4><p>同c++中的weak_ptr,避免循环引用.</p> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=keyword>use</span> std::cell::RefCell;</span><br><span class=line><span class=keyword>use</span> std::rc::{Rc, Weak};</span><br><span class=line></span><br><span class=line><span class=meta>#[derive(Debug)]</span></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>Node</span></span> {</span><br><span class=line>    value: <span class=built_in>i32</span>,</span><br><span class=line>    parent: RefCell&LTWeak&LTNode>>,</span><br><span class=line>    children: RefCell<<span class=built_in>Vec</span>&LTRc&LTNode>>>,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> leaf = Rc::new(Node {</span><br><span class=line>        value: <span class=number>3</span>,</span><br><span class=line>        parent: RefCell::new(Weak::new()),</span><br><span class=line>        children: RefCell::new(<span class=built_in>vec!</span>[]),</span><br><span class=line>    });</span><br><span class=line></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"leaf parent = {:?}"</span>, leaf.parent.borrow().upgrade());</span><br><span class=line></span><br><span class=line>    <span class=keyword>let</span> branch = Rc::new(Node {</span><br><span class=line>        value: <span class=number>5</span>,</span><br><span class=line>        parent: RefCell::new(Weak::new()),</span><br><span class=line>        children: RefCell::new(<span class=built_in>vec!</span>[Rc::clone(&leaf)]),</span><br><span class=line>    });</span><br><span class=line></span><br><span class=line>    *leaf.parent.borrow_mut() = Rc::downgrade(&branch);</span><br><span class=line></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"leaf parent = {:?}"</span>, leaf.parent.borrow().upgrade());</span><br><span class=line>}</span><br></pre></table></figure> <h4 id=RefCell><a class=headerlink href=#RefCell title=RefCell></a>RefCell</h4><p>Rc\<t>允许同一数据的多个所有者;Box\<t>和RefCell\<t>具有单个所有者。 <p>Box\<t>允许在编译时检查不可变或可变借用(意味着只有单一读取和修改者,同时也是owner);Rc\<t>只允许在编译时不可变借用(相当于可以有多个可读,不能更改值,可以考虑搭配RefCell修改); <p>RefCell\<t>允许在运行时检查不可变或可变的借用。因为RefCell\<t>允许在运行时检查可变借用，所以即使RefCell\<t>是不可变的，你也可以改变RefCell\<t>中的值。 <blockquote><p>内部可变性是Rust中的一种设计模式，它允许你改变数据，即使数据有不可变的引用;<p>这就是使用RefCell的目的.</blockquote> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre><td class=code><pre><span class=line><span class=keyword>pub</span> <span class=class><span class=keyword>trait</span> <span class=title>Messenger</span></span> {</span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>send</span></span>(&<span class=keyword>self</span>, msg: &<span class=built_in>str</span>);</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>pub</span> <span class=class><span class=keyword>struct</span> <span class=title>LimitTracker</span></span><<span class=symbol>'a</span>, T: Messenger> {</span><br><span class=line>    messenger: &<span class=symbol>'a</span> T,</span><br><span class=line>    value: <span class=built_in>usize</span>,</span><br><span class=line>    max: <span class=built_in>usize</span>,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>impl</span><<span class=symbol>'a</span>, T> LimitTracker<<span class=symbol>'a</span>, T></span><br><span class=line><span class=keyword>where</span></span><br><span class=line>    T: Messenger,</span><br><span class=line>{</span><br><span class=line>    <span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>new</span></span>(messenger: &<span class=symbol>'a</span> T, max: <span class=built_in>usize</span>) -> LimitTracker<<span class=symbol>'a</span>, T> {</span><br><span class=line>        LimitTracker {</span><br><span class=line>            messenger,</span><br><span class=line>            value: <span class=number>0</span>,</span><br><span class=line>            max,</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>pub</span> <span class=function><span class=keyword>fn</span> <span class=title>set_value</span></span>(&<span class=keyword>mut</span> <span class=keyword>self</span>, value: <span class=built_in>usize</span>) {</span><br><span class=line>        <span class=keyword>self</span>.value = value;</span><br><span class=line></span><br><span class=line>        <span class=keyword>let</span> percentage_of_max = <span class=keyword>self</span>.value <span class=keyword>as</span> <span class=built_in>f64</span> / <span class=keyword>self</span>.max <span class=keyword>as</span> <span class=built_in>f64</span>;</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> percentage_of_max >= <span class=number>1.0</span> {</span><br><span class=line>            <span class=keyword>self</span>.messenger.send(<span class=string>"Error: You are over your quota!"</span>);</span><br><span class=line>        } <span class=keyword>else</span> <span class=keyword>if</span> percentage_of_max >= <span class=number>0.9</span> {</span><br><span class=line>            <span class=keyword>self</span>.messenger</span><br><span class=line>                .send(<span class=string>"Urgent warning: You've used up over 90% of your quota!"</span>);</span><br><span class=line>        } <span class=keyword>else</span> <span class=keyword>if</span> percentage_of_max >= <span class=number>0.75</span> {</span><br><span class=line>            <span class=keyword>self</span>.messenger</span><br><span class=line>                .send(<span class=string>"Warning: You've used up over 75% of your quota!"</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line><span class=meta>#[cfg(test)]</span></span><br><span class=line><span class=keyword>mod</span> tests {</span><br><span class=line>    <span class=keyword>use</span> super::*;</span><br><span class=line>    <span class=keyword>use</span> std::cell::RefCell;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>MockMessenger</span></span> {</span><br><span class=line>        sent_messages: RefCell<<span class=built_in>Vec</span><<span class=built_in>String</span>>>,</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>impl</span> MockMessenger {</span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>new</span></span>() -> MockMessenger {</span><br><span class=line>            MockMessenger {</span><br><span class=line>                sent_messages: RefCell::new(<span class=built_in>vec!</span>[]),</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=keyword>impl</span> Messenger <span class=keyword>for</span> MockMessenger {</span><br><span class=line>        <span class=function><span class=keyword>fn</span> <span class=title>send</span></span>(&<span class=keyword>self</span>, message: &<span class=built_in>str</span>) {</span><br><span class=line>            <span class=keyword>self</span>.sent_messages.borrow_mut().push(<span class=built_in>String</span>::from(message));</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line></span><br><span class=line>    <span class=meta>#[test]</span></span><br><span class=line>    <span class=function><span class=keyword>fn</span> <span class=title>it_sends_an_over_75_percent_warning_message</span></span>() {</span><br><span class=line>        <span class=comment>// --snip--</span></span><br><span class=line></span><br><span class=line>        <span class=built_in>assert_eq!</span>(mock_messenger.sent_messages.borrow().len(), <span class=number>1</span>);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure> <p>使用RefCell\<t>的常见方法是与Rc\<t>结合使用。回想一下，Rc\<t>允许您拥有某些数据的多个所有者，但它只提供对该数据的不可变访问。如果你有一个Rc\<t>持有一个RefCell\<t>，可以得到一个值，可以有多个所有者，你可以改变 <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=comment>// 在有多个owner情况下修改数据 使用Rc和RefCell</span></span><br><span class=line><span class=meta>#[derive(Debug)]</span></span><br><span class=line><span class=class><span class=keyword>enum</span> <span class=title>List</span></span> {</span><br><span class=line>    Cons(Rc&LTRefCell<<span class=built_in>i32</span>>>, Rc&LTList>),</span><br><span class=line>    Nil,</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>use</span> crate::List::{Cons, Nil};</span><br><span class=line><span class=keyword>use</span> std::cell::RefCell;</span><br><span class=line><span class=keyword>use</span> std::rc::Rc;</span><br><span class=line></span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>main</span></span>() {</span><br><span class=line>    <span class=keyword>let</span> value = Rc::new(RefCell::new(<span class=number>5</span>));</span><br><span class=line></span><br><span class=line>    <span class=keyword>let</span> a = Rc::new(Cons(Rc::clone(&value), Rc::new(Nil)));</span><br><span class=line></span><br><span class=line>    <span class=keyword>let</span> b = Cons(Rc::new(RefCell::new(<span class=number>3</span>)), Rc::clone(&a));</span><br><span class=line>    <span class=keyword>let</span> c = Cons(Rc::new(RefCell::new(<span class=number>4</span>)), Rc::clone(&a));</span><br><span class=line></span><br><span class=line>    *value.borrow_mut() += <span class=number>10</span>;</span><br><span class=line></span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"a after = {a:?}"</span>);</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"b after = {b:?}"</span>);</span><br><span class=line>    <span class=built_in>println!</span>(<span class=string>"c after = {c:?}"</span>);</span><br><span class=line>}</span><br></pre></table></figure> <p>总结一下,没有特别情况可以使用Box,类似于c++中unique_ptr,Rc类似于shared_ptr.</p> <p>Arc和Mutex用于多线程情况. RefCell本身是运行时改变借用可变性,在一些情况下可以使用.</p> <h4 id=Trait-对比Concept-in-C-20><a title="Trait 对比Concept in C++20" class=headerlink href=#Trait-对比Concept-in-C-20></a>Trait 对比Concept in C++20</h4><p>Rust中trait与泛型结合很好,同时由于Rust没有类的继承,可以考虑使用泛型继承和组合实现类似效果. 可以<strong>使用<code>:</code>以及where和<code>+</code>搭配可以对trait的继承以及对泛型的限制进行描述</strong></p> <figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=keyword>pub</span> train walk {</span><br><span class=line>	<span class=function><span class=keyword>fn</span> <span class=title>xxx</span></span>();</span><br><span class=line>	<span class=function><span class=keyword>fn</span> <span class=title>yy</span></span>(){<span class=built_in>println!</span>(<span class=string>""</span>)};</span><br><span class=line>	<span class=function><span class=keyword>fn</span> <span class=title>zzz</span></span>();</span><br><span class=line>}</span><br><span class=line><span class=keyword>pub</span> <span class=class><span class=keyword>trait</span> <span class=title>run</span></span>:walk {</span><br><span class=line>  <span class=function><span class=keyword>fn</span> <span class=title>ttt</span></span>();</span><br><span class=line>}</span><br><span class=line><span class=function><span class=keyword>fn</span> <span class=title>func</span></span>(s:<span class=keyword>dyn</span> run){}</span><br><span class=line><span class=comment>// 限制结构的泛型</span></span><br><span class=line><span class=keyword>pub</span> <span class=class><span class=keyword>struct</span> <span class=title>Hi</span></span>&LTT:run> {</span><br><span class=line>  T:value</span><br><span class=line>}</span><br><span class=line><span class=comment>// 实现结构的trait</span></span><br><span class=line><span class=keyword>impl</span> walk <span class=keyword>for</span> Hi&LTT> <span class=keyword>where</span> T:walk {</span><br><span class=line></span><br><span class=line>}</span><br></pre></table></figure> <p>此外trait也可以写泛型(这在c++中往往是常见行为). trait在继承时使用<code>:</code>和<code>+</code>,在泛型使用时使用<code>:</code>或<code>where</code>,<code>+</code>.</p> <p>在c++中concept更偏向于限制泛型,而rust中trait还有接口的含义(通过实现接口而不是继承满足要求).</p> <figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>template</span> <<span class=keyword>typename</span> T></span><br><span class=line><span class=keyword>concept</span> integral = std::is_integral&LTT>::value;</span><br></pre></table></figure> <p>声明concept如上,此外可以使用<code>&&</code>搭配,还可以使用requires</p> <figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>template</span> <<span class=keyword>typename</span> T></span><br><span class=line><span class=keyword>concept</span> Addable = <span class=built_in><span class=keyword>requires</span></span>(T a, T b) { a + b; };  <span class=comment>// a + b 可通过编译即可</span></span><br></pre></table></figure> <ol><li><code>requires { requirement-seq }</code><li><code>requires ( parameter-list(optional) ) { requirement-seq }</code></ol> <p><code>requirements-seq</code> 可以是：简单要求、类型要求、复合要求、嵌套要求.</p> <figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=keyword>template</span> <<span class=class><span class=keyword>class</span> <span class=title>T</span>></span></span><br><span class=line><span class=keyword>concept</span> Check = <span class=built_in><span class=keyword>requires</span></span>(T a, T b) {</span><br><span class=line>    { a.<span class=built_in>clear</span>() } <span class=keyword>noexcept</span>;  <span class=comment>// 支持clear,且不抛异常</span></span><br><span class=line>    { a + b } <span class=keyword>noexcept</span>->std::same_as<<span class=keyword>int</span>>;  <span class=comment>// std::same_as&LTdecltype((a + b)), int></span></span><br><span class=line>};</span><br><span class=line><span class=keyword>template</span> <<span class=keyword>typename</span> T></span><br><span class=line><span class=keyword>concept</span> C =</span><br><span class=line>    <span class=built_in><span class=keyword>requires</span></span>(T x) {</span><br><span class=line>    {*x};                                 <span class=comment>// *x有意义</span></span><br><span class=line>    { x + <span class=number>1</span> } -> std::same_as<<span class=keyword>int</span>>;       <span class=comment>// x + 1有意义且std::same_as&LTdecltype((x + 1)), int>，即x+1是int类型</span></span><br><span class=line>    { x * <span class=number>1</span> } -> std::convertible_to&LTT>;  <span class=comment>// x * 1 有意义且std::convertible_to< decltype((x *1),T>，即x*1可转变为T类型</span></span><br><span class=line>};</span><br><span class=line></span><br><span class=line><span class=keyword>template</span> <<span class=class><span class=keyword>class</span> <span class=title>T</span>></span></span><br><span class=line><span class=keyword>concept</span> Check = <span class=built_in><span class=keyword>requires</span></span>(T a, T b) {</span><br><span class=line>    <span class=keyword>requires</span> std::same_as<<span class=keyword>decltype</span>((a + b)), <span class=keyword>int</span>>;</span><br><span class=line>};</span><br><span class=line><span class=comment>// =></span></span><br><span class=line><span class=keyword>template</span> <<span class=class><span class=keyword>class</span> <span class=title>T</span>></span></span><br><span class=line><span class=keyword>concept</span> Check = <span class=built_in><span class=keyword>requires</span></span>(T a, T b) {</span><br><span class=line>    { a + b } -> std::same_as<<span class=keyword>int</span>>;</span><br><span class=line>};</span><br></pre></table></figure> <p>而使用concept如下,使用和定义concept时都可以使用requires和&&.</p> <figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=keyword>template</span> <<span class=keyword>typename</span> T></span><br><span class=line><span class=function><span class=keyword>requires</span> integral&LTT> </span></span><br><span class=line><span class=function>T <span class=title>inc</span><span class=params>(T a)</span> </span>{ <span class=keyword>return</span> ++a; } <span class=comment>// 个人推荐</span></span><br><span class=line><span class=keyword>template</span> <<span class=keyword>typename</span> T></span><br><span class=line><span class=function>T <span class=title>inc</span><span class=params>(T a)</span> <span class=keyword>requires</span> integral&LTT> </span>{ <span class=keyword>return</span> ++a; } <span class=comment>//</span></span><br><span class=line><span class=keyword>template</span> &LTintegral T></span><br><span class=line><span class=function>T <span class=title>inc</span><span class=params>(T& a)</span> </span>{ <span class=keyword>return</span> ++a; } <span class=comment>//</span></span><br><span class=line><span class=function>integral <span class=keyword>auto</span> <span class=title>inc</span><span class=params>(integral <span class=keyword>auto</span> a)</span> </span>{ <span class=keyword>return</span> ++a; } <span class=comment>// 泛型函数 使用concept限制</span></span><br></pre></table></figure> <h3 id=后记><a class=headerlink href=#后记 title=后记></a>后记</h3><p>作为偏底层的编程语言,c/c++,rust,zig等目前都还在发展,即使c++已过五十年,但C++2a中Concepts,Modules,Coroutines(协程)等新特性都不断出现(虽然在其他语言中早就有了),所以还是地位仍在的.而后两者在前端工具构建上均大显身手,期待后续发展.</p> <p>我也很喜欢使用C/C++,Go,Rust等写一些小程序demo.</p> <h3 id=FYI><a class=headerlink href=#FYI title=FYI></a>FYI</h3><p>一些语言高级特性</p> <ol><li><a href=https://draveness.me/metaprogramming/ rel=noopener target=_blank>谈元编程与表达能力 - 面向信仰编程 (draveness.me)</a><li><a href=https://mirrors.tuna.tsinghua.edu.cn/tuna/tunight/2020-04-25-generics-and-metaprogramming/slides.pdf rel=noopener target=_blank>从泛型 (Generics) 到元编程 (Metaprogramming) (tsinghua.edu.cn)</a></ol> <p><img alt=image-20240629202803323 data-src=https://s2.loli.net/2024/06/29/5tfZJquDxgvKros.png></p> <p><img alt=image-20240629202943879 data-src=https://s2.loli.net/2024/06/29/gZaJPSIc5sdzM91.png></p> <link href=/css/spoiler.css rel=stylesheet><script async src=/js/spoiler.js></script> <div><div><div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div> <div class=popular-posts-header>相关文章</div> <ul class=popular-posts><li class=popular-posts-item><div class=popular-posts-title><a href=\2024\09\15\build-a-mini-project-starter-in-Rust\ rel=bookmark>build a mini project starter in Rust</a></div></ul> <div class=reward-container><div>感谢阅读.</div><button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div style="display: none;" id=qr><div style="display: inline-block;"><img alt="Sekyoro 微信支付" src=/images/wechatpay.png><p>微信支付</div></div></div> <div><ul class=post-copyright><li class=post-copyright-author><strong>本文作者： </strong>Sekyoro<li class=post-copyright-link><strong>本文链接：</strong> <a title="Rust learning:from germ to grave" href=https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/>https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/</a><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</ul></div> <div class=followme><p>欢迎关注我的其它发布渠道<div class=social-list><div class=social-item><a class=social-link href=/images/wxqrcode.png target=_blank> <span class=icon> <i class="fab fa-weixin"></i> </span> <span class=label>WeChat</span> </a></div><div class=social-item><a class=social-link href=/images/website.png target=_blank> <span class=icon> <i class="fa fa-user"></i> </span> <span class=label>PersonalWebsite</span> </a></div><div class=social-item><a class=social-link href=https://my-astro-git-main-drowning-in-codes.vercel.app target=_blank> <span class=icon> <i class="fas fa-share"></i> </span> <span class=label>杂鱼分享</span> </a></div><div class=social-item><a class=social-link href=/atom.xml target=_blank> <span class=icon> <i class="fa fa-rss"></i> </span> <span class=label>RSS</span> </a></div></div></div> <footer class=post-footer><div class=post-tags><a href=/tags/Rust/ rel=tag><i class="fa fa-tag"></i> Rust</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/06/25/%E4%B8%8D%E5%90%8C%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BA%92%E6%93%8D%E4%BD%9C/ rel=prev title=不同编程语言之间的互操作> <i class="fa fa-chevron-left"></i> 不同编程语言之间的互操作 </a></div><div class=post-nav-item><a href=/2024/06/30/%E5%8D%8F%E4%BD%9C%E6%84%9F%E7%9F%A5%E7%AE%97%E6%B3%95-%E4%B8%89/ rel=next title=协作感知算法:三> 协作感知算法:三 <i class="fa fa-chevron-right"></i> </a></div></div></footer> <!-- 评论区 --> <div class=comments><div data-id=city data-uid=MTAyMC81MzE5Ny8yOTY3Mg== id=lv-container></div></div> <script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script> <div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div> <aside class=sidebar><div class=sidebar-inner><!-- canvas粒子时钟 --><div><canvas id=canvas style=width:60%;>当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();</script><!-- require APlayer --><link href=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js></script><!-- require MetingJS --><script src=/js/meting-js.js></script><ul class="sidebar-nav motion-element"><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class=nav><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%AE%8Fmacro><span class=nav-number>1.</span> <span class=nav-text>宏macro</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%98%E9%87%8Fbinding><span class=nav-number>2.</span> <span class=nav-text>变量binding</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Primitives><span class=nav-number>3.</span> <span class=nav-text>Primitives</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%AD%97%E9%9D%A2%E9%87%8F%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6><span class=nav-number>3.1.</span> <span class=nav-text>字面量和操作符</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B><span class=nav-number>4.</span> <span class=nav-text>自定义类型</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#structures><span class=nav-number>4.1.</span> <span class=nav-text>structures</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Enums><span class=nav-number>4.2.</span> <span class=nav-text>Enums</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#constants><span class=nav-number>4.3.</span> <span class=nav-text>constants</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%B7%A5%E5%85%B7><span class=nav-number>5.</span> <span class=nav-text>工具</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8C%85%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F><span class=nav-number>5.1.</span> <span class=nav-text>强大的包管理系统</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84><span class=nav-number>5.1.1.</span> <span class=nav-text>项目结构</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BD%BF%E7%94%A8Cargo%E6%9E%84%E5%BB%BA%E5%A4%A7%E9%A1%B9%E7%9B%AE><span class=nav-number>6.</span> <span class=nav-text>使用Cargo构建大项目</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Release><span class=nav-number>6.1.</span> <span class=nav-text>Release</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#workspaces><span class=nav-number>6.2.</span> <span class=nav-text>workspaces</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#cargo-fmt-clippy><span class=nav-number>6.3.</span> <span class=nav-text>cargo fmt/clippy</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#cargo-doc><span class=nav-number>6.4.</span> <span class=nav-text>cargo doc</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#test><span class=nav-number>6.5.</span> <span class=nav-text>test</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#log><span class=nav-number>6.6.</span> <span class=nav-text>log</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#dyn><span class=nav-number>7.</span> <span class=nav-text>dyn</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88><span class=nav-number>8.</span> <span class=nav-text>智能指针</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Box><span class=nav-number>8.1.</span> <span class=nav-text>Box</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Rc><span class=nav-number>8.2.</span> <span class=nav-text>Rc</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Arc><span class=nav-number>8.3.</span> <span class=nav-text>Arc</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Weak><span class=nav-number>8.4.</span> <span class=nav-text>Weak</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#RefCell><span class=nav-number>8.5.</span> <span class=nav-text>RefCell</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Trait-%E5%AF%B9%E6%AF%94Concept-in-C-20><span class=nav-number>8.6.</span> <span class=nav-text>Trait 对比Concept in C++20</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%90%8E%E8%AE%B0><span class=nav-number>9.</span> <span class=nav-text>后记</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#FYI><span class=nav-number>10.</span> <span class=nav-text>FYI</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Sekyoro class=site-author-image itemprop=image src=https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg><p class=site-author-name itemprop=name>Sekyoro<div class=site-description itemprop=description>什么也无法舍弃的人，什么也做不了.</div></div><div class="site-state-wrap motion-element"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>213</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>16</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>197</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class=links-of-author-item> <a title="Personal Website → http://proanimer.com" href=http://proanimer.com/ rel=noopener target=_blank><i class="fab fa-internet-explorer fa-fw"></i>Personal Website</a> </span><span class=links-of-author-item> <a title="GitHub → https://github.com/drowning-in-codes" href=https://github.com/drowning-in-codes rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item> <a title="E-Mail → mailto:bukalala174@gmail.com" href=mailto:bukalala174@gmail.com rel=noopener target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class=links-of-author-item> <a title="wxPublicAccount → https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd" href=https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd rel=noopener target=_blank><i class="fab fa-weixin fa-fw"></i>wxPublicAccount</a> </span><span class=links-of-author-item> <a title="RSS → /atom.xml" href=/atom.xml><i class="fa fa-rss fa-fw"></i>RSS</a> </span><span class=links-of-author-item> <a title="CSDN → https://blog.csdn.net/aqwca" href=https://blog.csdn.net/aqwca rel=noopener target=_blank><i class="fa fa-handshake fa-fw"></i>CSDN</a> </span><span class=links-of-author-item> <a title="杂鱼分享 → https://my-astro-git-main-drowning-in-codes.vercel.app" href=https://my-astro-git-main-drowning-in-codes.vercel.app/ rel=noopener target=_blank><i class="fas fa-share fa-fw"></i>杂鱼分享</a> </span></div><div class="links-of-blogroll motion-element"><div class=links-of-blogroll-title><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=http://myqhs.top/ rel=noopener target=_blank title=http://myqhs.top/>myqhs</a><li class=links-of-blogroll-item><a href=https://www.lllomh.com/ rel=noopener target=_blank title=https://www.lllomh.com/>芈渡</a><li class=links-of-blogroll-item><a href=https://protool-ten.vercel.app/ rel=noopener target=_blank title=https://protool-ten.vercel.app/>protools</a></ul></div><div class="motion-element announcement"><div class=title></div><p class=content><p class=date></div></div><meting-js id=6856787487 order=random server=netease type=playlist> </meting-js><div class=widget-wrap><h3 class=widget-title style=margin:0>文章词云</h3><div class="widget tagcloud" id=myCanvasContainer><canvas height=250 id=resCanvas style=width:100% width=250><ul class=tag-list itemprop=keywords><li class=tag-list-item><a class=tag-list-link href=/tags/Rust/ rel=tag>Rust</a><span class=tag-list-count>2</span></ul></canvas></div></div><script id=clustrmaps src=https://clustrmaps.com/map_v2.js?d=xQdGTxqARTBiNIwX2aUban-ixkj2s6VaZQWo-aVCgY8&cl=ffffff&w=a></script><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i><span>0%</span></div><!-- 边栏 --></div></aside> <div id=sidebar-dimmer></div> <footer class=footer><div class=footer-inner><div class=copyright>© Wed Apr 08 2020 08:00:00 GMT+0800 (中国标准时间) – <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>Sekyoro</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-chart-area"></i> </span><span title=站点总字数>2m</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon> <i class="fa fa-coffee"></i> </span><span title=站点阅读时长>30:08</span></div><script async src=https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js></script><span id=busuanzi_container_site_pv>总访问量<span id=busuanzi_value_site_pv></span>次</span><span class=post-meta-divider>|</span><span id=busuanzi_container_site_uv>总访客数<span id=busuanzi_value_site_uv></span>人</span><span class=post-meta-divider>|</span><!-- 不蒜子计数初始值纠正 --><script>$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});</script><div><span id=timeDate>载入天数...</span><span id=times>载入时分秒...</span><script>var now = new Date();
    function createtime() {
        var grt= new Date("04/08/2021 20:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);</script></div><div class=busuanzi-count><script async data-pjax src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span style="display: none;" class=post-meta-item id=busuanzi_container_site_uv> <span class=post-meta-item-icon> <i class="fa fa-user"></i> </span> <span class=site-uv title=总访客量> <span id=busuanzi_value_site_uv></span> </span> </span><span class=post-meta-divider>|</span><span style="display: none;" class=post-meta-item id=busuanzi_container_site_pv> <span class=post-meta-item-icon> <i class="fa fa-eye"></i> </span> <span class=site-pv title=总访问量> <span id=busuanzi_value_site_pv></span> </span> </span></div></div></footer> <script color=0,0,255 count=99 opacity=0.5 src=/lib/canvas-nest/canvas-nest.min.js zindex=-1></script> <script src=/lib/anime.min.js></script> <script src=https://cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js></script> <script src=https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js></script> <script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js></script> <script src=https://cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js></script> <script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js></script> <script src=https://cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js></script> <script src=/js/utils.js></script> <script src=/js/motion.js></script> <script src=/js/schemes/pisces.js></script> <script src=/js/next-boot.js></script> <script src=/js/bookmark.js></script> <script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax',
	'.widget-wrap'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
 
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script> <script data-pjax>(function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();</script> <script src=https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js></script> <script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js></script> <script src=/js/algolia-search.js></script> <script data-pjax>document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});</script> <div id=pjax><script charset=utf-8 defer src=/js/outdate.js></script></div> <script charset=utf-8 defer src=/js/tagcanvas.js></script> <script charset=utf-8 defer src=/js/tagcloud.js></script> <script>NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});</script> <script>var OriginTitile = document.title;
  var titleTime;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      document.title = "(つェ⊂)我藏好了哦~" + OriginTitile;
      clearTimeout(titleTime);
    } else {
      document.title = "(*´∇｀*) 被你发现啦~" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });</script> <script src=/js/src/activate-power-mode.min.js></script> <script>POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);</script> 