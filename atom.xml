<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sekyoroçš„åšå®¢å°å±‹</title>
  
  
  <link href="https://www.sekyoro.top/atom.xml" rel="self"/>
  
  <link href="https://www.sekyoro.top/"/>
  <updated>2024-04-02T04:31:41.194Z</updated>
  <id>https://www.sekyoro.top/</id>
  
  <author>
    <name>Sekyoro</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Go Webæ¡†æ¶å°èµ</title>
    <link href="https://www.sekyoro.top/2024/04/02/Go-Web%E6%A1%86%E6%9E%B6%E5%B0%8F%E8%B5%8F/"/>
    <id>https://www.sekyoro.top/2024/04/02/Go-Web%E6%A1%86%E6%9E%B6%E5%B0%8F%E8%B5%8F/</id>
    <published>2024-04-02T03:23:04.000Z</published>
    <updated>2024-04-02T04:31:41.194Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>è¯´å®è¯,Goè¿™è¾¹çƒ­åº¦ä¸‹é™äº†ä¸å°‘,ä¸»è¦å¸‚åœºè¿˜æ˜¯åœ¨äº‘åŸç”Ÿä»¥åŠå°‘è®¸å¾®æœåŠ¡.å®ƒæœ¬èº«çš„æ ‡å‡†åº“å·²ç»éå¸¸å¤Ÿç”¨äº†æ­é…å¥å…¨çš„å®˜æ–¹packageä»“åº“,ç”¨èµ·æ¥å¾ˆé¡ºç•….</p><p><img data-src="https://blog.jetbrains.com/wp-content/uploads/2021/02/11-2x-2.png" alt="img" style="zoom: 33%;" /></p><span id="more"></span><p>Goçš„webæ¡†æ¶ç”Ÿæ€ä¾æ—§é›¶é›¶ç¢ç¢,æ²¡æœ‰ä¸€ä¸ªå¤§çš„ç»Ÿä¸€æ¡†æ¶,ä¸è¿‡è¿™ä¹Ÿæ­£å¸¸,ç›®å‰é™¤äº†Java,å…¶ä»–éƒ½éš¾è¯´.</p><p>ç›®å‰Goç®¡ç†åŒ…éƒ½ä½¿ç”¨modäº†,ä¸ç”¨å»çœ‹ç½‘ä¸Šè€æ•™ç¨‹çš„ä»€ä¹ˆGO PATHé…ä¸€å †.</p><h2 id="Gin"><a href="#Gin" class="headerlink" title="Gin"></a>Gin</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  r := gin.Default()</span><br><span class="line">  r.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  r.Run() <span class="comment">// listen and serve on 0.0.0.0:8080 (for windows &quot;localhost:8080&quot;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ginåº”è¯¥æ˜¯æœ€å¸¸ä½¿ç”¨çš„äº†,staræ•°ç›®å‰75.1k,å®˜æ–¹ä¾‹å­ä¹Ÿæ¯”è¾ƒå¤š<a href="https://gin-gonic.com/zh-cn/docs/">æ–‡æ¡£ | Gin Web Framework (gin-gonic.com)</a></p><h2 id="Echo"><a href="#Echo" class="headerlink" title="Echo"></a>Echo</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/labstack/echo/v4&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">e := echo.New()</span><br><span class="line">e.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c echo.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> c.String(http.StatusOK, <span class="string">&quot;Hello, World!&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">e.Logger.Fatal(e.Start(<span class="string">&quot;:1323&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€æ´é«˜æ€§èƒ½æ‰©å±•æ€§å¼ºçš„webæ¡†æ¶,çœ‹èµ·æ¥è·Ÿginæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å·®åˆ«.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(c echo.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> c.HTML(http.StatusOK, <span class="string">&quot;&lt;strong&gt;Hello, World!&lt;/strong&gt;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Iris"><a href="#Iris" class="headerlink" title="Iris"></a>Iris</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/kataras/iris/v12&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  app := iris.New()</span><br><span class="line">  app.Use(iris.Compression)</span><br><span class="line">  app.Get(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(ctx iris.Context)</span></span> &#123;</span><br><span class="line">    ctx.HTML(<span class="string">&quot;Hello &lt;strong&gt;%s&lt;/strong&gt;!&quot;</span>, <span class="string">&quot;World&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  app.Listen(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    app := iris.Default()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Simple group: v1</span></span><br><span class="line">    v1 := app.Party(<span class="string">&quot;/v1&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        v1.Post(<span class="string">&quot;/login&quot;</span>, loginEndpoint)</span><br><span class="line">        v1.Post(<span class="string">&quot;/submit&quot;</span>, submitEndpoint)</span><br><span class="line">        v1.Post(<span class="string">&quot;/read&quot;</span>, readEndpoint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Simple group: v2</span></span><br><span class="line">    v2 := app.Party(<span class="string">&quot;/v2&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        v2.Post(<span class="string">&quot;/login&quot;</span>, loginEndpoint)</span><br><span class="line">        v2.Post(<span class="string">&quot;/submit&quot;</span>, submitEndpoint)</span><br><span class="line">        v2.Post(<span class="string">&quot;/read&quot;</span>, readEndpoint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.Listen(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h2><p>å·ç§°æ˜¯å—expresså½±å“çš„æ¡†æ¶,çœ‹ä»£ç è¿˜æ˜¯ä¸é”™çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    app := fiber.New()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GET /api/register</span></span><br><span class="line">    app.Get(<span class="string">&quot;/api/*&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c fiber.Ctx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;âœ‹ %s&quot;</span>, c.Params(<span class="string">&quot;*&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> c.SendString(msg) <span class="comment">// =&gt; âœ‹ register</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GET /flights/LAX-SFO</span></span><br><span class="line">    app.Get(<span class="string">&quot;/flights/:from-:to&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c fiber.Ctx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;ğŸ’¸ From: %s, To: %s&quot;</span>, c.Params(<span class="string">&quot;from&quot;</span>), c.Params(<span class="string">&quot;to&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> c.SendString(msg) <span class="comment">// =&gt; ğŸ’¸ From: LAX, To: SFO</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GET /dictionary.txt</span></span><br><span class="line">    app.Get(<span class="string">&quot;/:file.:ext&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c fiber.Ctx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;ğŸ“ƒ %s.%s&quot;</span>, c.Params(<span class="string">&quot;file&quot;</span>), c.Params(<span class="string">&quot;ext&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> c.SendString(msg) <span class="comment">// =&gt; ğŸ“ƒ dictionary.txt</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GET /john/75</span></span><br><span class="line">    app.Get(<span class="string">&quot;/:name/:age/:gender?&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c fiber.Ctx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;ğŸ‘´ %s is %s years old&quot;</span>, c.Params(<span class="string">&quot;name&quot;</span>), c.Params(<span class="string">&quot;age&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> c.SendString(msg) <span class="comment">// =&gt; ğŸ‘´ john is 75 years old</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GET /john</span></span><br><span class="line">    app.Get(<span class="string">&quot;/:name&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c fiber.Ctx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        msg := fmt.Sprintf(<span class="string">&quot;Hello, %s ğŸ‘‹!&quot;</span>, c.Params(<span class="string">&quot;name&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> c.SendString(msg) <span class="comment">// =&gt; Hello john ğŸ‘‹!</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    log.Fatal(app.Listen(<span class="string">&quot;:3000&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åéƒ¨ç½²å¯ä»¥ä½¿ç”¨Render<a href="https://docs.render.com/">Docs + Quickstarts | Render Docs</a>,è¿˜æœ‰ä¸€äº›goçš„webæ¡†æ¶,ä½†æ„Ÿè§‰æ–‡æ¡£ä¸æ˜¯å¾ˆå¥½æˆ–è€…ç›®å‰ç”¨çš„äººè¿˜ä¸å¤š,æ‰€ä»¥å°±å…ˆä¸è¯´äº†.</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¯´å®è¯,Goè¿™è¾¹çƒ­åº¦ä¸‹é™äº†ä¸å°‘,ä¸»è¦å¸‚åœºè¿˜æ˜¯åœ¨äº‘åŸç”Ÿä»¥åŠå°‘è®¸å¾®æœåŠ¡.å®ƒæœ¬èº«çš„æ ‡å‡†åº“å·²ç»éå¸¸å¤Ÿç”¨äº†æ­é…å¥å…¨çš„å®˜æ–¹packageä»“åº“,ç”¨èµ·æ¥å¾ˆé¡ºç•….&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&quot;https://blog.jetbrains.com/wp-content/uploads/2021/02/11-2x-2.png&quot; alt=&quot;img&quot; style=&quot;zoom: 33%;&quot; /&gt;&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Vitepress:SSGæ¡†æ¶ä½¿ç”¨</title>
    <link href="https://www.sekyoro.top/2024/04/01/Vitepress-SSG%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/"/>
    <id>https://www.sekyoro.top/2024/04/01/Vitepress-SSG%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/</id>
    <published>2024-04-01T12:34:30.000Z</published>
    <updated>2024-04-02T03:14:01.434Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æœ€è¿‘æƒ³ç€æŠŠä¸€äº›æ¡†æ¶æ€»ç»“çš„ä¸œè¥¿æ”¾åˆ°ä¸€ä¸ªåœ¨çº¿æ–‡æ¡£è€Œä¸æ˜¯åšå®¢é‡Œ,äºæ˜¯åˆåœ¨ç½‘ä¸Šæœå¯»äº†ä¸€äº›é™æ€ç½‘ç«™ç”Ÿæˆå™¨(äº‹å®ä¸Šç°åœ¨æˆ‘ç”¨çš„hexoä¹Ÿç®—æ˜¯),è¿™ç±»æ¡†æ¶æŠŠç±»ä¼¼markdownè¿™ç§buildæˆhtml,é€‚åˆæ–‡æ¡£ã€åšå®¢è¿™ç§æ²¡æœ‰åå°æœåŠ¡çš„. å¦‚æœä½ æƒ³è¦å¤æ‚çš„,å¯ä»¥è¯•è¯•Astro<a href="https://docs.astro.build/zh-cn/getting-started/">å…¥é—¨æŒ‡å— | Docs (astro.build)</a>,è¿™ä¸ªæ¡†æ¶é»˜è®¤æœåŠ¡ç«¯æ¸²æŸ“.<br><span id="more"></span></p><p>å¯¹äºå‰ç«¯,å¯é€‰çš„æ–‡æ¡£æ¡†æ¶è¿˜æ˜¯å¾ˆå¤šçš„,æˆ‘æœ€æ¨èvitepress(è¿™ä¹Ÿæ˜¯æœ¬ç¯‡æ–‡ç« ä¸»è¦è®²çš„),æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨vuepress.</p><h3 id="Vitepress"><a href="#Vitepress" class="headerlink" title="Vitepress"></a>Vitepress</h3><p>vueçš„å›¢é˜Ÿæ‰“é€ ,å¾ˆå¥½ç”¨.è‡ªå¸¦çš„æ ·å¼ä¸é”™,è‡ªå®šä¹‰æ€§å¼º.</p><p>é…ç½®æ–‡ä»¶é…ç½®ä¸»é¢˜çš„æ ‡é¢˜,æè¿°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .vitepress/config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// site-level options</span></span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;VitePress&#x27;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;Just playing around.&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">themeConfig</span>: &#123;</span><br><span class="line">    <span class="comment">// theme-level options</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»é¢˜é…ç½®åŒ…æ‹¬logo,nav,siderbar,footerç­‰.æˆ‘è¯•ç”¨äº†ä¸€ä¸‹,é€‚åˆå†™<strong>äº§å“æ–‡æ¡£</strong>,å®ƒæœ¬èº«çš„å®˜ç½‘<a href="https://vitepress.dev/">VitePress | Vite &amp; Vue Powered Static Site Generator</a>å°±æ˜¯vitepresså†™çš„.</p><p>å¯ä»¥åœ¨è¿™ä¸ªé…ç½®é‡Œå†™navå’Œsidebarçš„ä¿¡æ¯.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&quot;vitepress&quot;</span>;</span><br><span class="line"><span class="comment">// https://vitepress.dev/reference/site-config</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineConfig(&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;protools&quot;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&quot;tools which I learn and use&quot;</span>,</span><br><span class="line">  <span class="attr">themeConfig</span>: &#123;</span><br><span class="line">    <span class="comment">// https://vitepress.dev/reference/default-theme-config</span></span><br><span class="line">    <span class="attr">search</span>: &#123;</span><br><span class="line">      <span class="attr">provider</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">sidebar</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&quot;Webæ¡†æ¶&quot;</span>,</span><br><span class="line">        <span class="attr">items</span>: [</span><br><span class="line">          &#123; <span class="attr">text</span>: <span class="string">&quot;Node&quot;</span>, <span class="attr">link</span>: <span class="string">&quot;/node_web&quot;</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">text</span>: <span class="string">&quot;Python&quot;</span>, <span class="attr">link</span>: <span class="string">&quot;/python_web&quot;</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">nav</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&quot;Webæ¡†æ¶&quot;</span>,</span><br><span class="line">        <span class="attr">items</span>: [</span><br><span class="line">          &#123; <span class="attr">text</span>: <span class="string">&quot;Node&quot;</span>, <span class="attr">link</span>: <span class="string">&quot;/node_web&quot;</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">text</span>: <span class="string">&quot;Python&quot;</span>, <span class="attr">link</span>: <span class="string">&quot;/python_web&quot;</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">footer</span>: &#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Released under the MIT License.&quot;</span>,</span><br><span class="line">      <span class="attr">copyright</span>: <span class="string">`Copyright Â©<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear()&#125;</span>.Made with â¤ &lt;a href=&quot;https://sekyoro.top&quot;&gt;Sekyoro&lt;/a&gt;`</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">socialLinks</span>: [</span><br><span class="line">      &#123; <span class="attr">icon</span>: <span class="string">&quot;github&quot;</span>, <span class="attr">link</span>: <span class="string">&quot;https://github.com/drowning-in-codes&quot;</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è€ŒHome pageä½œä¸ºä¸»é¡µ,layoutè®¾ç½®ä¸º<code>home</code>,å…¶ä»–çš„å¯ä»¥è®¾ç½®ä¸º<code>doc</code></p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240401233049341.png" alt="image-20240401233049341"></p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="section"># https://vitepress.dev/reference/default-theme-home-page</span></span><br><span class="line">layout: home</span><br><span class="line"></span><br><span class="line">hero:</span><br><span class="line">  name: &quot;protools&quot;</span><br><span class="line">  text: &quot;tools which I learn and use&quot;</span><br><span class="line">  tagline: Help me and others to learn and use.</span><br><span class="line">  image:</span><br><span class="line"><span class="code">    src: /logo.png</span></span><br><span class="line"><span class="code">    alt: protools</span></span><br><span class="line"><span class="code">  actions:</span></span><br><span class="line"><span class="code">    - theme: brand</span></span><br><span class="line"><span class="code">      text: &#x27;Webæ¡†æ¶&#x27;</span></span><br><span class="line"><span class="code">      link: &#x27;/node_web&#x27; </span></span><br><span class="line"><span class="code">features:</span></span><br><span class="line"><span class="code">  - title: Learn </span></span><br><span class="line"><span class="code">    details: No features</span></span><br><span class="line"><span class="code">---</span></span><br></pre></td></tr></table></figure><p>åœ¨å†™markdownæ—¶å¯ä»¥å¤šåˆ©ç”¨vitepressè‡ªå¸¦çš„ä¸€äº›ç‰¹æ€§,</p><p>å†™å®Œä¹‹åbuildä¸€ä¸‹æŠŠ.vitepressç›®å½•ä¸‹çš„distæ‹¿æ¥éƒ¨ç½²å°±è¡Œ.æˆ‘å°±éƒ¨ç½²åœ¨äº†vercelä¸Š,æ•´ä¸ªè¿‡ç¨‹å¾ˆé¡ºç•…<a href="https://protool-ten.vercel.app/">protools (protool-ten.vercel.app)</a></p><p>ä½†æ˜¯ä¹Ÿæœ‰ç¼ºç‚¹,æ¯”å¦‚markdownå¢åŠ äº†ä¸€äº›ä¸œè¥¿å¢åŠ å­¦ä¹ æˆæœ¬.ä¸è¿‡å®˜æ–¹æ–‡æ¡£è¿˜æ˜¯å†™å¾—å¾ˆæ¸…æ¥šçš„.</p><h3 id="Docsify"><a href="#Docsify" class="headerlink" title="Docsify"></a>Docsify</h3><p>ä¹Ÿæ˜¯jsçš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨<a href="https://docsify.js.org/#/?id=docsify">docsify</a>.ä¸è¿‡éƒ½æœ‰vitepressäº†,æ„Ÿè§‰å¿…è¦æ€§ä¸æ˜¯å¾ˆå¤§,è¿™ç§ä¸œè¥¿æ²¡å¿…è¦æå‡ ä¸ª</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i docsify-cli -g</span><br><span class="line">docsify init ./docs</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å®Œæˆåï¼Œä½ å¯ä»¥åœ¨ ./docs å­ç›®å½•ä¸‹çœ‹åˆ°æ–‡ä»¶åˆ—è¡¨ã€‚</p><ul><li>ä½œä¸ºå…¥å£æ–‡ä»¶çš„ index.html</li><li>ä½œä¸ºä¸»é¡µçš„ README.md</li><li>.nojekyll é˜»æ­¢ GitHub é¡µé¢å¿½ç•¥ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶</li></ul><p>ä¸‹é¢æ˜¯Pythonçš„æ–‡æ¡£ç”Ÿæˆå™¨.é€‚åˆPythonå†™çš„åº“</p><h3 id="Mkdocs"><a href="#Mkdocs" class="headerlink" title="Mkdocs"></a>Mkdocs</h3><p><a href="https://www.mkdocs.org/">mkdocs.org</a>çœ‹ç•Œé¢å°±æœ‰Pythoné‚£ç§æ„Ÿè§‰äº†,æ¯•ç«ŸPythonçš„æ–‡æ¡£ç»å¸¸é•¿è¿™ç§æ ·å­.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install mkdocs</span><br><span class="line">mkdocs new my-project</span><br><span class="line"><span class="built_in">cd</span> my-project</span><br></pre></td></tr></table></figure><p><img data-src="https://www.mkdocs.org/img/initial-layout.png" alt="The initial MkDocs layout"></p><p>åœ¨<code>mkdocs.yml</code>é…ç½®ä¸­åŠ ä¸Šç½‘ç«™ä¿¡æ¯å’Œnavç­‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">site_url:</span> <span class="string">https://example.com/</span></span><br><span class="line"><span class="attr">nav:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">Home:</span> <span class="string">index.md</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">About:</span> <span class="string">about.md</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">readthedocs</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdocs build</span><br></pre></td></tr></table></figure><p>è¿™ç§ç½‘ç«™å¯ä»¥éƒ¨ç½²åœ¨<a href="https://www.pythonanywhere.com/">Host, run, and code Python in the cloud: PythonAnywhere (www.pythonanywhere.com)</a>å’Œgithub pagesä¸Š,vercelä¸Šç›®å‰ä¸å¤ªè¡Œ.</p><h3 id="Sphinx"><a href="#Sphinx" class="headerlink" title="Sphinx"></a>Sphinx</h3><p><a href="https://zh-sphinx-doc.readthedocs.io/en/latest/tutorial.html">Sphinxåˆå° â€” Sphinx ä½¿ç”¨æ‰‹å†Œ (zh-sphinx-doc.readthedocs.io)</a></p><p>ä¸æ¨è,æœ¬èº«ä¸æ”¯æŒmarkdown,ä½¿ç”¨çš„æ˜¯<code>reStructuredText</code>ç¼–å†™,ç•Œé¢ä¹Ÿä¸€èˆ¬.</p><p>å…¶ä»–çš„ç›¸å½“äºç±»ä¼¼åœ¨çº¿æœåŠ¡äº†,åŸºæœ¬ä¸Šä¸éœ€è¦é…ç½®ç›´æ¥ç²˜è´´å†…å®¹å°±è¡Œ</p><h3 id="gitbook"><a href="#gitbook" class="headerlink" title="gitbook"></a>gitbook</h3><p>æœ¬èº«è¿˜æ˜¯å¾ˆä¸é”™çš„æœåŠ¡<a href="https://www.gitbook.com/">GitBook â€“ Knowledge management for technical teams</a></p><p>å¾ˆå¤šäººæ‹¿æ¥åˆ¶ä½œç”µå­ä¹¦</p><h3 id="è¯­é›€"><a href="#è¯­é›€" class="headerlink" title="è¯­é›€"></a>è¯­é›€</h3><p><a href="https://www.yuque.com/">è¯­é›€ï¼Œä¸ºæ¯ä¸€ä¸ªäººæä¾›ä¼˜ç§€çš„æ–‡æ¡£å’ŒçŸ¥è¯†åº“å·¥å…· (yuque.com)</a>å›½å†…çš„å¹³å°,æ­£å¦‚ä»‹ç»ä¸€æ ·,å¯ä»¥æ‹¿æ¥å†™æ–‡æ¡£å’Œæä¾›çŸ¥è¯†</p><p>æœ€åæ€»ç»“ä¸€ä¸‹,å¦‚æœå†™åæŠ€æœ¯æ€§æ–‡æ¡£,åå‰ç«¯çš„æŠ€æœ¯æˆ–è€…äº§å“ä½¿ç”¨vitepress,å…¶ä»–ç”¨mkdocs(ä¹Ÿå¯ä»¥éƒ½æ˜¯ç”¨vitepress,ä¸»è¦æ˜¯å‰ç«¯çš„é£æ ¼è·Ÿvitepresså¾ˆæ­)</p><p>å¦‚æœé¢å‘å¤§ä¼—çš„é‚£ç§çŸ¥è¯†æ–‡æ¡£,ç”¨gitbookå°±è¡Œ.</p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ol><li><a href="https://blog.csdn.net/m0_46521785/article/details/119812280">å‡ æ¬¾æ–‡æ¡£æ¡†æ¶ï¼šMkdocsã€Sphinxã€Teadocsã€docsify-CSDNåšå®¢</a></li><li><a href="https://vitepress.dev/guide/getting-started">Getting Started | VitePress</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘æƒ³ç€æŠŠä¸€äº›æ¡†æ¶æ€»ç»“çš„ä¸œè¥¿æ”¾åˆ°ä¸€ä¸ªåœ¨çº¿æ–‡æ¡£è€Œä¸æ˜¯åšå®¢é‡Œ,äºæ˜¯åˆåœ¨ç½‘ä¸Šæœå¯»äº†ä¸€äº›é™æ€ç½‘ç«™ç”Ÿæˆå™¨(äº‹å®ä¸Šç°åœ¨æˆ‘ç”¨çš„hexoä¹Ÿç®—æ˜¯),è¿™ç±»æ¡†æ¶æŠŠç±»ä¼¼markdownè¿™ç§buildæˆhtml,é€‚åˆæ–‡æ¡£ã€åšå®¢è¿™ç§æ²¡æœ‰åå°æœåŠ¡çš„. å¦‚æœä½ æƒ³è¦å¤æ‚çš„,å¯ä»¥è¯•è¯•Astro&lt;a href=&quot;https://docs.astro.build/zh-cn/getting-started/&quot;&gt;å…¥é—¨æŒ‡å— | Docs (astro.build)&lt;/a&gt;,è¿™ä¸ªæ¡†æ¶é»˜è®¤æœåŠ¡ç«¯æ¸²æŸ“.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Nodeåç«¯æ¡†æ¶å°èµ</title>
    <link href="https://www.sekyoro.top/2024/03/30/Node%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E5%B0%8F%E8%B5%8F/"/>
    <id>https://www.sekyoro.top/2024/03/30/Node%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E5%B0%8F%E8%B5%8F/</id>
    <published>2024-03-30T12:49:50.000Z</published>
    <updated>2024-04-01T15:12:51.929Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¹‹å‰å†™äº†Python,ç°åœ¨å†™ç‚¹NodeJSçš„,å½“ç„¶ç›®å‰JSçš„è¿è¡Œæ—¶è¿˜æœ‰Denoå’ŒBun,ä¸è¿‡è¿˜æ˜¯éœ€è¦æ—¶é—´æ£€éªŒ.è€ŒNodeçš„åç«¯æ¡†æ¶ä¹Ÿä¸å°‘,å…¶ä¸­ä½¼ä½¼è€…å½“å±Nest.js,è€Œæ›´å°çš„æœ‰Expressè¿™ç§.<br><span id="more"></span><br>è¿™é‡Œå°±å†™å†™Express,Koa,Fastifyä»¥åŠNestè¿™å‡ ä¸ªæ¡†æ¶çš„ä»‹ç»ä»¥åŠç¤ºä¾‹ä»£ç ,ä»¥ä¾›åç»­æŠ€æœ¯é€‰å‹ä½¿ç”¨.</p><p>é¦–å…ˆå®Œå…¨å¯ä»¥ä¸ä½¿ç”¨æ¡†æ¶å†™ä¸€äº›api</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> parsedURL = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">   <span class="keyword">if</span> (parsedURL.pathname === <span class="string">&#x27;/api&#x27;</span>) &#123;</span><br><span class="line">      res.setHeader(<span class="string">&#x27;content-type&#x27;</span>, <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>)</span><br><span class="line">      res.end(<span class="string">`Hey <span class="subst">$&#123;parsedURL.query.name&#125;</span> <span class="subst">$&#123;parsedURL.query.lastname&#125;</span>`</span>)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">4000</span>)</span><br></pre></td></tr></table></figure><h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express</span><br></pre></td></tr></table></figure><p>ä¹…ç»è€ƒéªŒçš„nodeåç«¯å°æ¡†æ¶,æœ¬èº«åŠŸèƒ½æŒºå°‘çš„,æ„Ÿè§‰è¿˜ä¸å¦‚Flask.æ²¡æœ‰ç‰¹é‡è½½,éœ€è¦ä½¿ç”¨nodemon.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">&#x27;Hello World&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  app.get(<span class="string">&#x27;/api/:name/:age&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.params)</span><br><span class="line">    res.send(&#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: req.params.name,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>é‡è¦æ¦‚å¿µæ˜¯Middleware,é€šè¿‡ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET method route</span></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">&quot;sddsaf&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">&quot;/api/:name/:age&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.params);</span><br><span class="line">  res.send(&#123;</span><br><span class="line">    <span class="attr">name</span>: req.params.name,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST method route</span></span><br><span class="line">app.post(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">&quot;POST request to the homepage&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> myLogger = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;LOGGED&quot;</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;;</span><br><span class="line">app.use(myLogger);</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">&quot;/secret&quot;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Accessing the secret section ...&quot;</span>);</span><br><span class="line">  next(); <span class="comment">// pass control to the next handler</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>expressçš„å¯é­”æ”¹æ€§æŒºé«˜çš„,å¯ä»¥ä½¿ç”¨å¤šç§ä¸­é—´ä»¶ä»¥åŠé‡è½½expressçš„API</p><p>ä¸­é—´ä»¶åˆ†ä¸ºåº”ç”¨çº§,è·¯ç”±çº§ä»¥åŠä¸€äº›è‡ªå¸¦çš„å’Œç¬¬ä¸‰æ–¹çš„.</p><h3 id="åº”ç”¨çº§ä¸­é—´ä»¶"><a href="#åº”ç”¨çº§ä¸­é—´ä»¶" class="headerlink" title="åº”ç”¨çº§ä¸­é—´ä»¶"></a>åº”ç”¨çº§ä¸­é—´ä»¶</h3><p>åº”ç”¨çº§ç›´æ¥ä½¿ç”¨app.use()ä¹Ÿå¯ä»¥ä½¿ç”¨app.getç­‰.</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">&#x27;/user/:id&#x27;</span>, (req, <span class="keyword">res</span>, <span class="keyword">next</span>) =&gt; &#123;</span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">&#x27;Request Type:&#x27;</span>, req.method)</span><br><span class="line">  <span class="keyword">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨useå¯ä»¥è¿ç»­å®šä¹‰å¤šä¸ªä¸­é—´ä»¶</span><br><span class="line">app.use(<span class="string">&#x27;/user/:id&#x27;</span>, (req, <span class="keyword">res</span>, <span class="keyword">next</span>) =&gt; &#123;</span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">&#x27;Request URL:&#x27;</span>, req.originalUrl)</span><br><span class="line">  <span class="keyword">next</span>()</span><br><span class="line">&#125;, (req, <span class="keyword">res</span>, <span class="keyword">next</span>) =&gt; &#123;</span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">&#x27;Request Type:&#x27;</span>, req.method)</span><br><span class="line">  <span class="keyword">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"># ä½¿ç”¨app.<span class="built_in">get</span>å¯ä»¥è¿ç»­å®šä¹‰å¤šä¸ªä¸­é—´ä»¶</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logOriginalUrl</span> <span class="params">(req, res, next)</span> &#123;</span></span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">&#x27;Request URL:&#x27;</span>, req.originalUrl)</span><br><span class="line">  <span class="keyword">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logMethod</span> <span class="params">(req, res, next)</span> &#123;</span></span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">&#x27;Request Type:&#x27;</span>, req.method)</span><br><span class="line">  <span class="keyword">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const logStuff = [logOriginalUrl, logMethod]</span><br><span class="line">app.<span class="built_in">get</span>(<span class="string">&#x27;/user/:id&#x27;</span>, logStuff, (req, <span class="keyword">res</span>, <span class="keyword">next</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">res</span>.send(<span class="string">&#x27;User Info&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¦è·³è¿‡ä¸€ä¸ªè·¯ç”±çš„ä¸­é—´ä»¶ä¸­çš„å…¶ä»–ä¸­é—´ä»¶å‡½æ•°ï¼Œå¯è°ƒç”¨ next(â€˜routeâ€™) å°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªè·¯ç”±ã€‚æ³¨æ„ï¼šnext(â€˜routeâ€™) åªé€‚ç”¨äºé€šè¿‡ app.METHOD() æˆ– router.METHOD() å‡½æ•°åŠ è½½çš„ä¸­é—´ä»¶å‡½æ•°ã€‚</p><blockquote><p>æ³¨æ„åŒºåˆ†å¯¹åº”è·¯ç”±çš„handlerå’Œmiddleware.(æ„Ÿè§‰å·®åˆ«å…¶å®ä¸æ˜¯å¾ˆå¤§)å‰è€…ä¸€èˆ¬è´Ÿè´£ä¸»è¦äº‹åŠ¡é€»è¾‘æ¯”è¾ƒå¤š,åè€…è´Ÿè´£ä¸€äº›loggingå•¥çš„.</p></blockquote><h3 id="è·¯ç”±çº§ä¸­é—´ä»¶"><a href="#è·¯ç”±çº§ä¸­é—´ä»¶" class="headerlink" title="è·¯ç”±çº§ä¸­é—´ä»¶"></a>è·¯ç”±çº§ä¸­é—´ä»¶</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Time:&#x27;</span>, <span class="built_in">Date</span>.now())</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// a middleware sub-stack shows request info for any type of HTTP request to the /user/:id path</span></span><br><span class="line">router.use(<span class="string">&#x27;/user/:id&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Request URL:&#x27;</span>, req.originalUrl)</span><br><span class="line">  next()</span><br><span class="line">&#125;, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Request Type:&#x27;</span>, req.method)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// handler for the /user/:id path, which renders a special page</span></span><br><span class="line">router.get(<span class="string">&#x27;/user/:id&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.params.id)</span><br><span class="line">  res.render(<span class="string">&#x27;special&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// mount the router on the app</span></span><br><span class="line">app.use(<span class="string">&#x27;/&#x27;</span>, router)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ router.use() å’Œ router.METHOD() å‡½æ•°åŠ è½½è·¯ç”±å™¨çº§ä¸­é—´ä»¶ã€‚ç›¸å½“äºç»†åˆ†é¢—ç²’åº¦äº†,ä½¿ç”¨ä¸€ä¸ªrouterçš„ä¸­é—´ä»¶ä½œä¸ºappçº§åˆ«çš„ä¸­é—´ä»¶.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// predicate the router with a check and bail out when needed</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.headers[<span class="string">&#x27;x-auth&#x27;</span>]) <span class="keyword">return</span> next(<span class="string">&#x27;router&#x27;</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/user/:id&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">&#x27;hello, user!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// use the router and 401 anything falling through</span></span><br><span class="line">app.use(<span class="string">&#x27;/admin&#x27;</span>, router, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.sendStatus(<span class="number">401</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä½¿ç”¨è·¯ç”±ä¸­é—´ä»¶,å¦‚æœè®¿é—®æ²¡æœ‰x-authå¤´,å°±è·³è¿‡å…¶ä»–ä¸­é—´ä»¶ç›´åˆ°handlers</p><h3 id="é”™è¯¯å¤„ç†ä¸­é—´ä»¶"><a href="#é”™è¯¯å¤„ç†ä¸­é—´ä»¶" class="headerlink" title="é”™è¯¯å¤„ç†ä¸­é—´ä»¶"></a>é”™è¯¯å¤„ç†ä¸­é—´ä»¶</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack)</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">&#x27;Something broke!&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è‡ªå¸¦ä¸­é—´ä»¶</p><ul><li><a href="https://expressjs.com/en/4x/api.html#express.static">express.static</a> serves static assets such as HTML files, images, and so on.</li><li><a href="https://expressjs.com/en/4x/api.html#express.json">express.json</a> parses incoming requests with JSON payloads. <strong>NOTE: Available with Express 4.16.0+</strong></li><li><a href="https://expressjs.com/en/4x/api.html#express.urlencoded">express.urlencoded</a> parses incoming requests with URL-encoded payloads. <strong>NOTE: Available with Express 4.16.0+</strong></li></ul><p>ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cookie-parser</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// load the cookie-parsing middleware</span></span><br><span class="line">app.use(cookieParser())</span><br></pre></td></tr></table></figure><h3 id="é‡å†™express-API"><a href="#é‡å†™express-API" class="headerlink" title="é‡å†™express API"></a>é‡å†™express API</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.response.sendStatus = <span class="function"><span class="keyword">function</span> (<span class="params">statusCode, type, message</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// code is intentionally kept simple for demonstration purpose</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.contentType(type)</span><br><span class="line">    .status(statusCode)</span><br><span class="line">    .send(message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(app.request, <span class="string">&#x27;ip&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">  get () &#123; <span class="keyword">return</span> <span class="built_in">this</span>.get(<span class="string">&#x27;Client-IP&#x27;</span>) &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>expressçš„æ¨¡æ¿å¼•æ“å¯ä»¥ä½¿ç”¨Pug,Mustache,Ejsç­‰</p><p>é”™è¯¯å¤„ç†å‡½æ•°,åŒ…æ‹¬ä¸€ä¸ªé»˜è®¤çš„,è¿™ä¸ªé»˜è®¤çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶å‡½æ•°è¢«æ·»åŠ åˆ°ä¸­é—´ä»¶å‡½æ•°æ ˆçš„æœ«å°¾,ä¹Ÿå¯æ·»åŠ è‡ªå®šä¹‰çš„.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack)</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">&#x27;Something broke!&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="Koa"><a href="#Koa" class="headerlink" title="Koa"></a>Koa</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>koaçš„ä¸­é—´ä»¶æƒ³æ³•è·Ÿexpressä¸å¤ªä¸€æ ·,è€Œä¸”æœ¬èº«æ²¡æœ‰route.æ¯”å¦‚ä¸‹é¢çš„è¾“å‡ºä¾æ¬¡æ˜¯logger,res,start,1,Hello,GET / - 1ms</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// logger</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;logger&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">  <span class="keyword">const</span> rt = ctx.response.get(<span class="string">&#x27;X-Response-Time&#x27;</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;rt&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// x-response-time</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;res&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="keyword">const</span> ms = <span class="built_in">Date</span>.now() - start;</span><br><span class="line">  <span class="built_in">console</span>.log(ms)</span><br><span class="line">  ctx.set(<span class="string">&#x27;X-Response-Time&#x27;</span>, <span class="string">`<span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">    <span class="comment">// html</span></span><br><span class="line">  ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">    <span class="comment">// json</span></span><br><span class="line">   <span class="comment">// ctx.body = &#123; foo: &#x27;bar&#x27; &#125;;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>koaä¸­æœ‰ä¸ªcontext,å¯ä»¥ç»™å®ƒå¢åŠ å±æ€§.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.context.db = db();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ctx.db);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ctxé‡Œé¢åŒ…å«äº†åŸºæœ¬æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿,åŒ…æ‹¬requestå’Œresponse.</p><ul><li><code>ctx.header</code></li><li><code>ctx.headers</code></li><li><code>ctx.method</code></li><li><code>ctx.method=</code></li><li><code>ctx.url</code></li><li><code>ctx.url=</code></li><li><code>ctx.originalUrl</code></li><li><code>ctx.origin</code></li><li><code>ctx.href</code></li><li><code>ctx.path</code></li><li><code>ctx.path=</code></li><li><code>ctx.query</code></li><li><code>ctx.query=</code></li><li><code>ctx.querystring</code></li><li><p><code>ctx.querystring=</code>ç­‰</p></li><li><p><code>ctx.body</code></p></li><li><code>ctx.body=</code></li><li><code>ctx.status</code></li><li><code>ctx.status=</code></li><li><code>ctx.message</code></li><li><code>ctx.message=</code></li><li><code>ctx.length=</code></li><li><code>ctx.length</code></li><li><code>ctx.type=</code></li><li><code>ctx.type</code></li><li><code>ctx.headerSent</code></li><li><code>ctx.redirect()</code></li><li><code>ctx.attachment()</code></li><li><code>ctx.set()</code></li><li><code>ctx.append()</code></li><li><code>ctx.remove()</code></li><li><code>ctx.lastModified=</code></li><li><code>ctx.etag=</code></li></ul><p>è·¯ç”±è¿˜éœ€è¦ä¸‹è½½<code>koa-router</code>,koaæœ¬èº«ä¸åŒ…å«ä¸­é—´ä»¶.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;Home Page&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/about&#x27;</span>, <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;About Page&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Server started on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>é”™è¯¯å¤„ç†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  log.error(<span class="string">&#x27;server error&#x27;</span>, err, ctx)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ€»ä»·ä¸€ä¸‹,koaæœ¬èº«æ¯”è¾ƒç®€æ´,ä½¿ç”¨ä¸­é—´ä»¶çš„é€»è¾‘æœ‰ç‚¹æ€ª,ä½¿ç”¨awaitä¼šè°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶,å¦‚æœæ²¡æœ‰å…¶ä»–ä¸­é—´ä»¶äº†å†è°ƒç”¨handler,ç„¶åå†å›å».æ²¡æœ‰è‡ªå¸¦è·¯ç”±,è€Œä¸”å¯¹æ¨¡æ¿å¼•æ“æ”¯æŒåŠ›åº¦ä¹Ÿä¸å¤Ÿ,é€‚åˆå†™API.</p><h2 id="Fastify"><a href="#Fastify" class="headerlink" title="Fastify"></a>Fastify</h2><p>ç‰¹ç‚¹å°±æ˜¯å¿«,è€Œä¸”githubä¸ŠstaræŒºå¤šçš„,ä¸€èˆ¬è¡¨æ˜ç”Ÿæ€ä¸ä¼šå¤ªå·®.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> fastify = <span class="built_in">require</span>(<span class="string">&quot;fastify&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> app = fastify()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/api&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">`Hey <span class="subst">$&#123;req.query.name&#125;</span> <span class="subst">$&#123;req.query.name&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">4000</span>)</span><br></pre></td></tr></table></figure><p>fastifyä¹Ÿæœ‰ä¸­é—´ä»¶è¿™ç§å«åšæ’ä»¶pluginçš„ä¸œè¥¿.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> fastify = <span class="built_in">require</span>(<span class="string">&quot;fastify&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> app = fastify(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">logger</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">routes</span> (<span class="params">app, options</span>) </span>&#123;</span><br><span class="line">    app.get(<span class="string">&#x27;/hi&#x27;</span>, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">hello</span>: <span class="string">&#x27;hi&#x27;</span> &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  app.register(routes)</span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">app.get(<span class="string">&quot;/api&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">`Hey <span class="subst">$&#123;req.query.name&#125;</span> <span class="subst">$&#123;req.query.name&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> start = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> app.listen(&#123; <span class="attr">port</span>: <span class="number">3000</span> &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        app.log.error(err)</span><br><span class="line">      process.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  start()</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> opts = &#123;</span><br><span class="line">  <span class="attr">schema</span>: &#123;</span><br><span class="line">    <span class="attr">body</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        <span class="attr">someKey</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">someOtherKey</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fastify.post(<span class="string">&#x27;/&#x27;</span>, opts, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> opts = &#123;</span><br><span class="line">  <span class="attr">schema</span>: &#123;</span><br><span class="line">    <span class="attr">response</span>: &#123;</span><br><span class="line">      <span class="number">200</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">        <span class="attr">properties</span>: &#123;</span><br><span class="line">          <span class="attr">hello</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fastify.get(<span class="string">&#x27;/&#x27;</span>, opts, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¯¹äºæ•°æ®éªŒè¯,è¯¥è·¯ç”±æ¥å—ä¸€ä¸ªschemaé”®ï¼Œè¯¥schemaé”®åŒ…å«bodyã€querystringã€paramså’Œæ ‡å¤´ã€‚</p><p>å¯¹äºåºåˆ—åŒ–,å¯ä»¥å°†åºåˆ—åŒ–é€Ÿåº¦æé«˜ 2-3 å€ã€‚è¿™è¿˜æœ‰åŠ©äºé˜²æ­¢æ½œåœ¨æ•æ„Ÿæ•°æ®çš„æ³„æ¼ï¼Œå› ä¸º Fastify å°†åªåºåˆ—åŒ–å“åº”æ¨¡å¼ä¸­çš„æ•°æ®ã€‚</p><p>æ„Ÿè§‰å®ƒçš„æ–‡æ¡£å†™çš„ä¸æ˜¯å¾ˆå¥½å•Š,ä¸è¿‡å¦‚æœæœ‰å…¶ä»–æ¡†æ¶åŸºç¡€å€’è¿˜æ˜¯å¥½å†™.</p><p>å¯¹è¿™ç§ç²¾å°çš„æ¡†æ¶,æœ‰å¯¹æ¯”<a href="https://plainenglish.io/blog/fastify-express-benchmark-4c4aebb726d6">I Built the Same API With Fastify, Express &amp; Bare Node.js. Here Are the Differences (plainenglish.io)</a>è¡¨æ˜expressè¿˜æ˜¯å å¤§å¤´,å³ä½¿fastifyæ€§èƒ½å¥½ä¸€äº›,æ¯•ç«Ÿç°åœ¨æ€§èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªåº”ç”¨çš„å…¨éƒ¨.</p><h2 id="Nest-js"><a href="#Nest-js" class="headerlink" title="Nest.js"></a>Nest.js</h2><p>Nestæ˜¯é’ˆå¯¹é¡¹ç›®çš„,ç®€å•çš„å‡ ä¸ªapiçš„è¯è¿˜æ˜¯ç”¨expressè¿™ç§å§.Nestæœ‰controller,provider,interceptorè¿™ç§ä¸œè¥¿äº†,è¿˜å…¨é¢æ”¯æŒts,ç›¸å½“äºå‘spring MVCè¿ˆè¿›.</p><blockquote><p>app.controller.ts å¸¦æœ‰å•ä¸€è·¯ç”±çš„åŸºæœ¬æ§åˆ¶å™¨ã€‚<br>app.controller.spec.ts æ§åˆ¶å™¨çš„å•å…ƒæµ‹è¯•ã€‚<br>app.module.ts åº”ç”¨ç¨‹åºçš„æ ¹æ¨¡å—ã€‚<br>app.service.ts å¸¦æœ‰å•ä¸€æ–¹æ³•çš„åŸºæœ¬æœåŠ¡ã€‚<br>main.ts åº”ç”¨ç¨‹åºçš„å…¥å£æ–‡ä»¶ï¼Œä½¿ç”¨æ ¸å¿ƒå‡½æ•° NestFactory åˆ›å»º Nest åº”ç”¨ç¨‹åºå®ä¾‹ã€‚</p></blockquote><p>è¦åˆ›å»º Nest åº”ç”¨ç¨‹åºå®ä¾‹éœ€è¦ä½¿ç”¨æ ¸å¿ƒ NestFactory ç±»ã€‚NestFactory æä¾›äº†å‡ ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºåº”ç”¨ç¨‹åºå®ä¾‹ã€‚create() æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç¬¦åˆ INestApplication æ¥å£ã€‚è¯¥å¯¹è±¡æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•.</p><h3 id="Controllers"><a href="#Controllers" class="headerlink" title="Controllers"></a>Controllers</h3><p>æ§åˆ¶å™¨è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p><img data-src="https://docs.nestjs.com/assets/Controllers_1.png" alt="img"></p><p>æ§åˆ¶å™¨çš„ä½œç”¨æ˜¯æ¥æ”¶åº”ç”¨ç¨‹åºçš„ç‰¹å®šè¯·æ±‚ã€‚<strong>è·¯ç”±æœºåˆ¶æ§åˆ¶å“ªä¸ªæ§åˆ¶å™¨æ¥æ”¶å“ªäº›è¯·æ±‚</strong>ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ§åˆ¶å™¨éƒ½æœ‰ä¸æ­¢ä¸€ä¸ªè·¯ç”±ï¼Œä¸åŒçš„è·¯ç”±å¯ä»¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</p><p><strong>ä¸ºäº†åˆ›å»ºåŸºæœ¬æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»å’Œè£…é¥°å™¨ã€‚è£…é¥°å™¨å°†ç±»ä¸æ‰€éœ€çš„å…ƒæ•°æ®å…³è”èµ·æ¥ï¼Œä½¿ Nest èƒ½å¤Ÿåˆ›å»ºè·¯ç”±å›¾</strong>ï¼ˆå°†è¯·æ±‚ç»‘å®šåˆ°ç›¸åº”çš„æ§åˆ¶å™¨ï¼‰ã€‚</p><p>ä¸€ä¸ªmoduleä¸‹åŒ…æ‹¬controllerå’Œprovider(service).</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Controller,</span><br><span class="line">  Get,</span><br><span class="line">  Req,</span><br><span class="line">  Post,</span><br><span class="line">  Res,</span><br><span class="line">  Param,</span><br><span class="line">  HttpCode,</span><br><span class="line">  Body,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateCatDto &#125; <span class="keyword">from</span> <span class="string">&#x27;./create-cat.dto&#x27;</span>;</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  findAll(<span class="meta">@Req</span>() request: Request, <span class="meta">@Param</span>() param): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(request.body);</span><br><span class="line">    <span class="built_in">console</span>.log(param);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This action returns all cats&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  find(<span class="meta">@Req</span>() request: Request, <span class="meta">@Param</span>() param): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(request.body);</span><br><span class="line">    <span class="built_in">console</span>.log(param);</span><br><span class="line">    <span class="keyword">return</span> param.id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="meta">@HttpCode</span>(<span class="number">204</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;This action adds a new cat&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsController &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.controller&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">controllers</span>: [AppController, CatsController],</span><br><span class="line">  <span class="attr">providers</span>: [AppService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨modules.tsä¸­å†™controllerå’Œprovider,ç›¸å½“äºæŠŠhandlerå’Œrouteéƒ½å†™äº†.æœ‰å¾ˆå¤šä¿®é¥°å™¨å¯ä»¥ä½¿ç”¨</p><div class="table-container"><table><thead><tr><th>è£…é¥°å™¨</th><th>æ–¹æ³•</th></tr></thead><tbody><tr><td><code>@Request(), @Req()</code></td><td><code>req</code></td></tr><tr><td><code>@Response(), @Res()</code><strong>*</strong></td><td><code>res</code></td></tr><tr><td><code>@Next()</code></td><td><code>next</code></td></tr><tr><td><code>@Session()</code></td><td><code>req.session</code></td></tr><tr><td><code>@Param(key?: string)</code></td><td><code>req.params</code> / <code>req.params[key]</code></td></tr><tr><td><code>@Body(key?: string)</code></td><td><code>req.body</code> / <code>req.body[key]</code></td></tr><tr><td><code>@Query(key?: string)</code></td><td><code>req.query</code> / <code>req.query[key]</code></td></tr><tr><td><code>@Headers(name?: string)</code></td><td><code>req.headers</code> / <code>req.headers[name]</code></td></tr><tr><td><code>@Ip()</code></td><td><code>req.ip</code></td></tr><tr><td><code>@HostParam()</code></td><td><code>req.hosts</code></td></tr></tbody></table></div><h3 id="Providers"><a href="#Providers" class="headerlink" title="Providers"></a>Providers</h3><p>Nest ä¸­çš„è®¸å¤šåŸºæœ¬ç±»éƒ½å¯ä»¥è¢«è§†ä¸ºæä¾›è€…ï¼Œå¦‚æœservices, repositories, factories, helpersç­‰ã€‚æä¾›è€…çš„ä¸»è¦ç†å¿µæ˜¯å®ƒå¯ä»¥ä½œä¸ºä¾èµ–æ³¨å…¥ï¼›è¿™æ„å‘³ç€å¯¹è±¡ä¹‹é—´å¯ä»¥åˆ›å»ºå„ç§å…³ç³»ï¼Œè€Œ â€œè¿æ¥ â€œè¿™äº›å¯¹è±¡çš„åŠŸèƒ½åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¯ä»¥å§”æ‰˜ç»™ Nest è¿è¡Œæ—¶ç³»ç»Ÿã€‚</p><p><img data-src="https://docs.nestjs.com/assets/Components_1.png" alt="img"></p><p>å¯ä»¥åˆ›å»ºä¸€ä¸ªserviceä½œä¸ºprovider,@Injectable() è£…é¥°å™¨é™„åŠ äº†å…ƒæ•°æ®ï¼Œå£°æ˜ CatsService æ˜¯ä¸€ä¸ªå¯ç”± Nest IoC å®¹å™¨ç®¡ç†çš„ç±»ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Cat &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces/cat.interface&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> cats: Cat[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">create</span>(<span class="params">cat: Cat</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cats.push(cat);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  findAll(): Cat[] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.cats;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Cat &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    age: <span class="built_in">number</span>;</span><br><span class="line">    breed: <span class="built_in">string</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Post, Body &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CreateCatDto &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-cat.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsService &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Cat &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces/cat.interface&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsController</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> catsService: CatsService</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="keyword">async</span> findAll(): <span class="built_in">Promise</span>&lt;Cat[]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.catsService.findAll();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CatsService æ˜¯é€šè¿‡ç±»æ„é€ å‡½æ•°æ³¨å…¥çš„ã€‚è¯·æ³¨æ„ private è¯­æ³•çš„ä½¿ç”¨ã€‚è¿™ç§é€Ÿè®°æ–¹æ³•å…è®¸æˆ‘ä»¬åœ¨åŒä¸€ä½ç½®ç«‹å³å£°æ˜å’Œåˆå§‹åŒ– catsService æˆå‘˜ã€‚</p><p>ç°åœ¨å·²ç»å®šä¹‰äº†ä¸€ä¸ªæä¾›è€…ï¼ˆCatsServiceï¼‰ï¼Œå¹¶ä¸”æœ‰äº†è¯¥æœåŠ¡çš„æ¶ˆè´¹è€…ï¼ˆCatsControllerï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å‘ Nest æ³¨å†Œè¯¥æœåŠ¡ï¼Œä»¥ä¾¿å®ƒèƒ½æ‰§è¡Œæ³¨å…¥ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsController &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsService &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.service&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">controllers</span>: [AppController, CatsController],</span><br><span class="line">  <span class="attr">providers</span>: [AppService, CatsService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>controllerä¸­è®¿é—®provideråˆ©ç”¨<strong>ä¾èµ–æ³¨å…¥</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> catsService: CatsService</span>)</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h3><p>æ¨¡å—æ˜¯ä¸€ä¸ªç”¨ @Module() è£…é¥°å™¨æ³¨è§£çš„ç±»ã€‚@Module() è£…é¥°å™¨æä¾›äº† Nest ç”¨æ¥ç»„ç»‡åº”ç”¨ç¨‹åºç»“æ„çš„å…ƒæ•°æ®</p><p><img data-src="https://docs.nestjs.com/assets/Modules_1.png" alt="img"></p><p>æ¯ä¸ªåº”ç”¨ç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªæ¨¡å—ï¼Œå³æ ¹æ¨¡å—ã€‚æ ¹æ¨¡å—æ˜¯ Nest ç”¨æ¥æ„å»ºåº”ç”¨ç¨‹åºå›¾çš„èµ·ç‚¹â€”Nest ç”¨æ¥è§£å†³æ¨¡å—å’Œæä¾›ç¨‹åºä¹‹é—´çš„å…³ç³»å’Œä¾èµ–å…³ç³»çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚</p><p>å»ºè®®å°†æ¨¡å—ä½œä¸ºç»„ç»‡ç»„ä»¶çš„æœ‰æ•ˆæ–¹å¼ã€‚å› æ­¤ï¼Œå¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºè€Œè¨€ï¼Œæœ€ç»ˆæ¶æ„å°†é‡‡ç”¨å¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—å°è£…ä¸€ç»„å¯†åˆ‡ç›¸å…³çš„åŠŸèƒ½ã€‚</p><div class="table-container"><table><thead><tr><th>æ¨¡å—ä¸­å†…å®¹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>providers</code></td><td>the providers that will be instantiated by the Nest injector and that may be shared at least across this module</td></tr><tr><td><code>controllers</code></td><td>the set of controllers defined in this module which have to be instantiated</td></tr><tr><td><code>imports</code></td><td>the list of imported modules that export the providers which are required in this module</td></tr><tr><td><code>exports</code></td><td>the subset of <code>providers</code> that are provided by this module and should be available in other modules which import this module. You can use either the provider itself or just its token (<code>provide</code> value)</td></tr></tbody></table></div><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats/cats.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DogController &#125; <span class="keyword">from</span> <span class="string">&#x27;./dog.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DogService &#125; <span class="keyword">from</span> <span class="string">&#x27;./dog.service&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [CatsModule],</span><br><span class="line">  <span class="attr">controllers</span>: [AppController, DogController],</span><br><span class="line">  <span class="attr">providers</span>: [AppService, DogService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>åŒä¸€ä¸ªmodulesä¸­çš„ä¸åŒcontrollerå¯ä»¥å…±äº«provider,æ­¤å¤–ä¸åŒmoduleså¯ä»¥importè¿˜å¯ä»¥å¯¼å‡ºprovider</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppController &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats/cats.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DogController &#125; <span class="keyword">from</span> <span class="string">&#x27;./dog.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; DogService &#125; <span class="keyword">from</span> <span class="string">&#x27;./dog.service&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [CatsModule],</span><br><span class="line">  <span class="attr">controllers</span>: [AppController, DogController],</span><br><span class="line">  <span class="attr">providers</span>: [AppService, DogService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ¨¡å—éƒ½è‡ªåŠ¨æˆä¸ºå…±äº«æ¨¡å—ã€‚ä¸€<strong>æ—¦åˆ›å»ºï¼Œä»»ä½•æ¨¡å—éƒ½å¯ä»¥é‡å¤ä½¿ç”¨</strong>ã€‚å‡è®¾æˆ‘ä»¬æƒ³åœ¨å…¶ä»–å‡ ä¸ªæ¨¡å—ä¹‹é—´å…±äº«ä¸€ä¸ª CatsService å®ä¾‹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¼å‡º CatsService æä¾›è€…ï¼Œå°†å…¶æ·»åŠ åˆ°æ¨¡å—çš„å¯¼å‡ºæ•°ç»„ä¸­</p><p><img data-src="https://docs.nestjs.com/assets/Shared_Module_1.png" alt="img"></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsController &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsService &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [CatsController],</span><br><span class="line">  <span class="attr">providers</span>: [CatsService],</span><br><span class="line">  <span class="attr">exports</span>: [CatsService]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œä»»ä½•å¯¼å…¥ CatsModule çš„æ¨¡å—éƒ½å¯ä»¥è®¿é—® CatsServiceï¼Œå¹¶ä¸æ‰€æœ‰å¯¼å…¥è¯¥æ¨¡å—çš„å…¶ä»–æ¨¡å—å…±äº«åŒä¸€ä¸ªå®ä¾‹ã€‚æ­¤å¤–è¿˜æœ‰å…¨å±€moduleså’ŒåŠ¨æ€modules,</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module, Global &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsController &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsService &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Global</span>()</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [CatsController],</span><br><span class="line">  <span class="attr">providers</span>: [CatsService],</span><br><span class="line">  <span class="attr">exports</span>: [CatsService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><p>ä¸­é—´ä»¶æ˜¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰è°ƒç”¨çš„å‡½æ•°ã€‚ä¸­é—´ä»¶å‡½æ•°å¯ä»¥è®¿é—®è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œä»¥åŠåº”ç”¨ç¨‹åºè¯·æ±‚-å“åº”å¾ªç¯ä¸­çš„ next() ä¸­é—´ä»¶å‡½æ•°ã€‚ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°é€šå¸¸ç”¨åä¸º next çš„å˜é‡æ¥è¡¨ç¤ºã€‚</p><p>ä¸­é—´ä»¶åŠŸèƒ½å¯æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š</p><ul><li>æ‰§è¡Œä»»ä½•ä»£ç ã€‚</li><li>æ›´æ”¹è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚</li><li>ç»“æŸè¯·æ±‚-å“åº”å¾ªç¯ã€‚</li><li>è°ƒç”¨å †æ ˆä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚</li><li>å¦‚æœå½“å‰ä¸­é—´ä»¶å‡½æ•°æ²¡æœ‰ç»“æŸè¯·æ±‚-å“åº”å¾ªç¯ï¼Œåˆ™å¿…é¡»è°ƒç”¨ next() å°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚å¦åˆ™ï¼Œè¯·æ±‚å°†è¢«æŒ‚èµ·ã€‚</li></ul><p><img data-src="https://docs.nestjs.com/assets/Middlewares_1.png" alt="img"></p><p>åˆ›å»ºä¸­é—´ä»¶</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, NestMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response, NextFunction &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerMiddleware</span> <span class="title">implements</span> <span class="title">NestMiddleware</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">use</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Request...&#x27;</span>);</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§æ‰¿<code>use</code>æ–¹æ³•,ä½¿ç”¨req,resä»¥åŠnextæ–¹æ³•.</p><p>ä½¿ç”¨ä¸­é—´ä»¶,ä½¿ç”¨æ¨¡å—ç±»çš„ configure() æ–¹æ³•æ¥è®¾ç½®å®ƒä»¬ã€‚åŒ…å«ä¸­é—´ä»¶çš„æ¨¡å—å¿…é¡»å®ç° NestModule æ¥å£ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module, NestModule, MiddlewareConsumer &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoggerMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/middleware/logger.middleware&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CatsModule &#125; <span class="keyword">from</span> <span class="string">&#x27;./cats/cats.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [CatsModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>)</span> &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(LoggerMiddleware)</span><br><span class="line">      .forRoutes(<span class="string">&#x27;cats&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°NestModuleæ¥å£å¹¶ç»§æ‰¿configureæ–¹æ³•,ä½¿ç”¨consumerç±»</p><p>å®ƒæä¾›äº†å¤šç§å†…ç½®æ–¹æ³•æ¥ç®¡ç†ä¸­é—´ä»¶ã€‚æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½èƒ½ä»¥æµç•…çš„æ–¹å¼ç®€å•åœ°ä¸²è”èµ·æ¥ã€‚forRoutes() æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ã€å¤šä¸ªå­—ç¬¦ä¸²ã€ä¸€ä¸ª RouteInfo å¯¹è±¡ä»¥åŠcontrollerç±».ä½¿ç”¨consumeråº”ç”¨ä¸­é—´ä»¶åœ¨è·¯ç”±å’Œcontrollerç±»ä¸Š.</p><p>æ­¤å¤–ä¹Ÿæœ‰å…¨å±€ä¸­é—´ä»¶</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">app.use(logger);</span><br><span class="line"><span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><h3 id="Exception-filtes"><a href="#Exception-filtes" class="headerlink" title="Exception filtes"></a>Exception filtes</h3><p>è‡ªå¸¦äº†ä¸€å †å¼‚å¸¸</p><ul><li><code>BadRequestException</code></li><li><code>UnauthorizedException</code></li><li><code>NotFoundException</code></li><li><code>ForbiddenException</code></li><li><code>NotAcceptableException</code></li><li><code>RequestTimeoutException</code></li><li><code>ConflictException</code></li><li><code>GoneException</code></li><li><code>HttpVersionNotSupportedException</code></li><li><code>PayloadTooLargeException</code></li><li><code>UnsupportedMediaTypeException</code></li><li><code>UnprocessableEntityException</code></li><li><code>InternalServerErrorException</code></li><li><code>NotImplementedException</code></li><li><code>ImATeapotException</code></li><li><code>MethodNotAllowedException</code></li><li><code>BadGatewayException</code></li><li><code>ServiceUnavailableException</code></li><li><code>GatewayTimeoutException</code></li><li><code>PreconditionFailedException</code></li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">findAll</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">this</span>.service.findAll()</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123; </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(&#123;</span><br><span class="line">      <span class="attr">status</span>: HttpStatus.FORBIDDEN,</span><br><span class="line">      <span class="attr">error</span>: <span class="string">&#x27;This is a custom message&#x27;</span>,</span><br><span class="line">    &#125;, HttpStatus.FORBIDDEN, &#123;</span><br><span class="line">      <span class="attr">cause</span>: error</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è‡ªå·±ç»§æ‰¿HttpException.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ForbiddenException</span> <span class="keyword">extends</span> <span class="title">HttpException</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&#x27;Forbidden&#x27;</span>, HttpStatus.FORBIDDEN);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦æ›´å¥½çš„æ§åˆ¶,å¯ä»¥ç»§æ‰¿<code>ExceptionFilter</code>ä½¿ç”¨catchä¸“é—¨å¤„ç†æŸäº›å¼‚å¸¸.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ExceptionFilter, Catch, ArgumentsHost, HttpException &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Catch</span>(HttpException)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpExceptionFilter</span> <span class="title">implements</span> <span class="title">ExceptionFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">catch</span>(exception: HttpException, <span class="attr">host</span>: ArgumentsHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = host.switchToHttp();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.getResponse&lt;Response&gt;();</span><br><span class="line">    <span class="keyword">const</span> request = ctx.getRequest&lt;Request&gt;();</span><br><span class="line">    <span class="keyword">const</span> status = exception.getStatus();</span><br><span class="line"></span><br><span class="line">    response</span><br><span class="line">      .status(status)</span><br><span class="line">      .json(&#123;</span><br><span class="line">        <span class="attr">statusCode</span>: status,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().toISOString(),</span><br><span class="line">        <span class="attr">path</span>: request.url,</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¥½filteråè¿›è¡Œç»‘å®šåˆ°æŸä¸ªè·¯ç”±</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UseFilters</span>(HttpExceptionFilter)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ForbiddenException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pipes-and-guards"><a href="#pipes-and-guards" class="headerlink" title="pipes and guards"></a>pipes and guards</h3><p>pipes æ˜¯ä¸€ä¸ªä½¿ç”¨ @Injectable() è£…é¥°å™¨æ³¨è§£çš„ç±»ï¼Œå®ƒå®ç°äº† PipeTransform æ¥å£ã€‚</p><p><img data-src="https://docs.nestjs.com/assets/Pipe_1.png" alt="img"></p><p>ç®¡é“ç”¨äºè½¬æ¢å’Œæ ¡éªŒæ•°æ®.</p><ul><li><code>ValidationPipe</code></li><li><code>ParseIntPipe</code></li><li><code>ParseFloatPipe</code></li><li><code>ParseBoolPipe</code></li><li><code>ParseArrayPipe</code></li><li><code>ParseUUIDPipe</code></li><li><code>ParseEnumPipe</code></li><li><code>DefaultValuePipe</code></li><li><code>ParseFilePipe</code></li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>, ParseIntPipe) id: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.catsService.findOne(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ…æ‹¬åšæ•°æ®ç±»å‹è½¬æ¢çš„é»˜è®¤å€¼ç­‰çš„pipe,è¿˜å¯ä»¥è‡ªå®šä¹‰pipe</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PipeTransform, Injectable, ArgumentMetadata &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªpipeç®¡é“éƒ½å¿…é¡»å®ç° transform() æ–¹æ³•ä»¥å®ç° PipeTransform æ¥å£ã€‚è¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>å€¼</li><li>å…ƒæ•°æ®</li></ul><p>æ•°æ®æ ¡éªŒä¹Ÿæœ‰å¾ˆå¤šç§æ–¹æ³•,ä¸‹é¢æ˜¯æœ€ç®€å•çš„.åˆ›å»ºæ•°æ®ç±»å‹.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateCatDto</span> </span>&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  age: <span class="built_in">number</span>;</span><br><span class="line">  breed: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨<code>zod</code>ç¬¬ä¸‰æ–¹åº“.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save zod</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; PipeTransform, ArgumentMetadata, BadRequestException &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ZodSchema  &#125; <span class="keyword">from</span> <span class="string">&#x27;zod&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ZodValidationPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> schema: ZodSchema</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">transform</span>(<span class="params">value: unknown, metadata: ArgumentMetadata</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> parsedValue = <span class="built_in">this</span>.schema.parse(value);</span><br><span class="line">      <span class="keyword">return</span> parsedValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(<span class="string">&#x27;Validation failed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨ schema.parse() æ–¹æ³•ï¼Œæ ¹æ®æä¾›çš„æ¨¡å¼éªŒè¯è¾“å…¥çš„å‚æ•°ã€‚</p><p>éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œæ‰èƒ½ä½¿ç”¨ ZodValidationPipeï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª ZodValidationPipe å®ä¾‹</li><li>åœ¨pipeçš„ç±»æ„é€ å‡½æ•°ä¸­ä¼ é€’ç‰¹å®šäºä¸Šä¸‹æ–‡çš„ Zod æ¨¡å¼</li><li>å°†pipeç»‘å®šåˆ°æ–¹æ³•</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; z &#125; <span class="keyword">from</span> <span class="string">&#x27;zod&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCatSchema = z</span><br><span class="line">  .object(&#123;</span><br><span class="line">    <span class="attr">name</span>: z.string(),</span><br><span class="line">    <span class="attr">age</span>: z.number(),</span><br><span class="line">    <span class="attr">breed</span>: z.string(),</span><br><span class="line">  &#125;)</span><br><span class="line">  .required();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> CreateCatDto = z.infer&lt;<span class="keyword">typeof</span> createCatSchema&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨pipe</span></span><br><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UsePipes</span>(<span class="keyword">new</span> ZodValidationPipe(createCatSchema))</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>guard æ˜¯ä¸€ä¸ªä½¿ç”¨ @Injectable() è£…é¥°å™¨æ³¨è§£çš„ç±»ï¼Œå®ƒå®ç°äº† CanActivate æ¥å£ã€‚</p><p><img data-src="https://docs.nestjs.com/assets/Guards_1.png" alt="img"></p><p>guardæ ¹æ®è¿è¡Œæ—¶å­˜åœ¨çš„æŸäº›æ¡ä»¶ï¼ˆå¦‚æƒé™ã€è§’è‰²ã€ACL ç­‰ï¼‰ï¼Œå†³å®šè·¯ç”±å¤„ç†ç¨‹åºæ˜¯å¦å¤„ç†ç»™å®šè¯·æ±‚ã€‚è¿™é€šå¸¸è¢«ç§°ä¸ºæˆæƒ.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, CanActivate, ExecutionContext &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  canActivate(</span><br><span class="line">    context: ExecutionContext,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.switchToHttp().getRequest();</span><br><span class="line">    <span class="keyword">return</span> validateRequest(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªguardéƒ½å¿…é¡»å®ç° canActivate() å‡½æ•°ã€‚è¯¥å‡½æ•°åº”è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨æ˜å½“å‰è¯·æ±‚æ˜¯å¦è¢«å…è®¸ã€‚å®ƒå¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥ï¼ˆé€šè¿‡ Promise æˆ– Observableï¼‰è¿”å›å“åº”ã€‚Nest ä½¿ç”¨è¿”å›å€¼æ¥æ§åˆ¶ä¸‹ä¸€æ­¥æ“ä½œ.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, CanActivate, ExecutionContext &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">RolesGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  canActivate(</span><br><span class="line">    context: ExecutionContext,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(RolesGuard)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>å…¨å±€guard.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">app.useGlobalGuards(<span class="keyword">new</span> RolesGuard());</span><br></pre></td></tr></table></figure><h3 id="interceptors"><a href="#interceptors" class="headerlink" title="interceptors"></a>interceptors</h3><p>æ‹¦æˆªå™¨æ˜¯ä¸€ä¸ªä½¿ç”¨ @Injectable() è£…é¥°å™¨æ³¨è§£å¹¶å®ç° NestInterceptor æ¥å£çš„ç±»</p><p><img data-src="https://docs.nestjs.com/assets/Interceptors_1.png" alt="img"></p><p>å—é¢å‘æ–¹é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æŠ€æœ¯çš„å¯å‘ï¼Œæ‹¦æˆªå™¨å…·æœ‰ä¸€ç³»åˆ—æœ‰ç”¨çš„åŠŸèƒ½ã€‚å®ƒä»¬å¯ä»¥</p><ul><li>åœ¨æ–¹æ³•æ‰§è¡Œå‰/åç»‘å®šé¢å¤–é€»è¾‘</li><li>è½¬æ¢å‡½æ•°è¿”å›çš„ç»“æœ</li><li>è½¬æ¢å‡½æ•°æŠ›å‡ºçš„å¼‚å¸¸</li><li>æ‰©å±•åŸºæœ¬å‡½æ•°è¡Œä¸º</li><li>æ ¹æ®ç‰¹å®šæ¡ä»¶ï¼ˆå¦‚ç¼“å­˜ç›®çš„ï¼‰å®Œå…¨é‡å†™å‡½æ•°</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, NestInterceptor, ExecutionContext, CallHandler &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">  intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Before...&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .handle()</span><br><span class="line">      .pipe(</span><br><span class="line">        tap(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`After... <span class="subst">$&#123;<span class="built_in">Date</span>.now() - now&#125;</span>ms`</span>)),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»‘å®šinterceptor.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UseInterceptors</span>(LoggingInterceptor)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>å…¨å±€æ‹¦æˆªå™¨</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">app.useGlobalInterceptors(<span class="keyword">new</span> LoggingInterceptor());</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰è£…é¥°å™¨</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, ExecutionContext &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> User = createParamDecorator(</span><br><span class="line">  <span class="function">(<span class="params">data: unknown, ctx: ExecutionContext</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = ctx.switchToHttp().getRequest();</span><br><span class="line">    <span class="keyword">return</span> request.user;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">findOne</span>(<span class="params"><span class="meta">@User</span>() user: UserEntity</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="websocketä¸socket-io"><a href="#websocketä¸socket-io" class="headerlink" title="websocketä¸socket.io"></a>websocketä¸socket.io</h2><p><img data-src="https://www.runoob.com/wp-content/uploads/2016/03/ws.png" alt="img"></p><blockquote><p>WebSocket ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚</p><p>åœ¨ WebSocket API ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚</p><p>åœ¨ WebSocket API ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦åšä¸€ä¸ªæ¡æ‰‹çš„åŠ¨ä½œï¼Œç„¶åï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å°±å½¢æˆäº†ä¸€æ¡å¿«é€Ÿé€šé“ã€‚ä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥æ•°æ®äº’ç›¸ä¼ é€ã€‚</p><p>ç°åœ¨ï¼Œå¾ˆå¤šç½‘ç«™ä¸ºäº†å®ç°æ¨é€æŠ€æœ¯ï¼Œæ‰€ç”¨çš„æŠ€æœ¯éƒ½æ˜¯ Ajax è½®è¯¢ã€‚è½®è¯¢æ˜¯åœ¨ç‰¹å®šçš„çš„æ—¶é—´é—´éš”ï¼ˆå¦‚æ¯1ç§’ï¼‰ï¼Œç”±æµè§ˆå™¨å¯¹æœåŠ¡å™¨å‘å‡ºHTTPè¯·æ±‚ï¼Œç„¶åç”±æœåŠ¡å™¨è¿”å›æœ€æ–°çš„æ•°æ®ç»™å®¢æˆ·ç«¯çš„æµè§ˆå™¨ã€‚è¿™ç§ä¼ ç»Ÿçš„æ¨¡å¼å¸¦æ¥å¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œå³æµè§ˆå™¨éœ€è¦ä¸æ–­çš„å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œç„¶è€ŒHTTPè¯·æ±‚å¯èƒ½åŒ…å«è¾ƒé•¿çš„å¤´éƒ¨ï¼Œå…¶ä¸­çœŸæ­£æœ‰æ•ˆçš„æ•°æ®å¯èƒ½åªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¾ç„¶è¿™æ ·ä¼šæµªè´¹å¾ˆå¤šçš„å¸¦å®½ç­‰èµ„æºã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://echo.websocket.org&quot;</span>);</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Connection open ...&quot;</span>); </span><br><span class="line">  ws.send(<span class="string">&quot;Hello WebSockets!&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log( <span class="string">&quot;Received Message: &quot;</span> + evt.data);</span><br><span class="line">  ws.close();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Connection closed.&quot;</span>);</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯å®¢æˆ·ç«¯çš„å†™æ³•,æœåŠ¡ç«¯å¯ä»¥åˆ©ç”¨ws<a href="https://github.com/websockets/ws">websockets/ws: Simple to use, blazing fast and thoroughly tested WebSocket client and server for Node.js (github.com)</a>æˆ–socket.ioåº“<a href="https://github.com/socketio/socket.io">socketio/socket.io: Realtime application framework (Node.JS server) (github.com)</a>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¼å…¥WebSocketæ¨¡å—:</span></span><br><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•ç”¨Serverç±»:</span></span><br><span class="line"><span class="keyword">const</span> WebSocketServer = WebSocket.Server;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–:</span></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> WebSocketServer(&#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span></span><br><span class="line">&#125;);</span><br><span class="line">wss.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ws</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[SERVER] connection()`</span>);</span><br><span class="line">    ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`[SERVER] Received: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">        ws.send(<span class="string">`ECHO: <span class="subst">$&#123;message&#125;</span>`</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`[SERVER] error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è¯·æ±‚æ—¢å¯ä»¥åœ¨æµè§ˆå™¨,ä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡å—çš„å®¢æˆ·ç«¯.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://localhost:3000/test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€WebSocketè¿æ¥åç«‹åˆ»å‘é€ä¸€æ¡æ¶ˆæ¯:</span></span><br><span class="line">ws.on(<span class="string">&#x27;open&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[CLIENT] open()`</span>);</span><br><span class="line">    ws.send(<span class="string">&#x27;Hello!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº”æ”¶åˆ°çš„æ¶ˆæ¯:</span></span><br><span class="line">ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[CLIENT] Received: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>WebSocketåè®®æœ¬èº«ä¸è¦æ±‚åŒæºç­–ç•¥ï¼ˆSame-origin Policyï¼‰ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªåœ°å€ä¸º<code>http://a.com</code>çš„ç½‘é¡µå¯ä»¥é€šè¿‡WebSocketè¿æ¥åˆ°<code>ws://b.com</code>ã€‚ä½†æ˜¯ï¼Œæµè§ˆå™¨ä¼šå‘é€<code>Origin</code>çš„HTTPå¤´ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯ä»¥æ ¹æ®<code>Origin</code>æ‹’ç»è¿™ä¸ªWebSocketè¯·æ±‚ã€‚æ‰€ä»¥ï¼Œæ˜¯å¦è¦æ±‚åŒæºè¦çœ‹æœåŠ¡å™¨ç«¯å¦‚ä½•æ£€æŸ¥ã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡ç«¯</span></span><br><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Server &#125; = <span class="built_in">require</span>(<span class="string">&quot;socket.io&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> httpServer = createServer();</span><br><span class="line"><span class="keyword">const</span> io = <span class="keyword">new</span> Server(httpServer, &#123;</span><br><span class="line">  <span class="attr">cors</span>: &#123;</span><br><span class="line">    <span class="attr">origin</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">    <span class="attr">credentials</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">io.on(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  socket.on(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Received message:&quot;</span>, data);</span><br><span class="line">    io.emit(<span class="string">&quot;message&quot;</span>, data); <span class="comment">// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯</span></span><br><span class="line">  &#125;);</span><br><span class="line">  socket.on(<span class="string">&quot;event&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;receive:&quot;</span>, data);</span><br><span class="line">  &#125;);</span><br><span class="line">  socket.on(<span class="string">&quot;disconnect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;disconnet&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">httpServer.listen(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Server started on port 3000&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// å®¢æˆ·ç«¯</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Socket.IO Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">      <span class="attr">src</span>=<span class="string">&quot;https://cdn.socket.io/4.7.5/socket.io.min.js&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">integrity</span>=<span class="string">&quot;sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> socket = io(<span class="string">&quot;http://localhost:3000&quot;</span>);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">      socket.on(<span class="string">&quot;connect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&quot;Connected to server&quot;</span>);</span></span><br><span class="line"><span class="javascript">      &#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">      socket.on(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&quot;Received message:&quot;</span>, data);</span></span><br><span class="line"><span class="javascript">      &#125;);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&quot;message-input&quot;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> message = input.value;</span></span><br><span class="line"><span class="javascript">        socket.emit(<span class="string">&quot;message&quot;</span>, message);</span></span><br><span class="line"><span class="javascript">        input.value = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="javascript">      &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;message-input&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter message&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;sendMessage()&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æŸä¸ªnamespace(è·ŸæŸä¸ªè·¯ç”±ç±»ä¼¼)ä¸‹è¿æ¥çš„å®¢æˆ·ç«¯çš„æ•°é‡</span></span><br><span class="line"><span class="keyword">const</span> socketCount = io.of(<span class="string">&quot;/&quot;</span>).sockets.size;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Connected clients:&quot;</span>, socketCount);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = io(); <span class="comment">// or io(&quot;/&quot;), the main namespace</span></span><br><span class="line"><span class="keyword">const</span> orderSocket = io(<span class="string">&quot;/orders&quot;</span>); <span class="comment">// the &quot;orders&quot; namespace</span></span><br><span class="line"><span class="keyword">const</span> userSocket = io(<span class="string">&quot;/users&quot;</span>); <span class="comment">// the &quot;users&quot; namespace</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> socket = io(<span class="string">&quot;https://example.com&quot;</span>); <span class="comment">// or io(&quot;https://example.com/&quot;), the main namespace</span></span><br><span class="line"><span class="keyword">const</span> orderSocket = io(<span class="string">&quot;https://example.com/orders&quot;</span>); <span class="comment">// the &quot;orders&quot; namespace</span></span><br><span class="line"><span class="keyword">const</span> userSocket = io(<span class="string">&quot;https://example.com/users&quot;</span>); <span class="comment">// the &quot;users&quot; namespace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®cors</span></span><br><span class="line"><span class="keyword">const</span> io = <span class="keyword">new</span> Server(httpServer, &#123;</span><br><span class="line">  <span class="attr">cors</span>: &#123;</span><br><span class="line">    <span class="attr">origin</span>: <span class="string">&quot;https://example.com&quot;</span>,</span><br><span class="line">    <span class="attr">allowedHeaders</span>: [<span class="string">&quot;my-custom-header&quot;</span>],</span><br><span class="line">    <span class="attr">credentials</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>socket.ioä¸­server,socketéƒ½æ˜¯é‡è¦æ¦‚å¿µ,è€Œä¸”socket.ioåº“æœ¬èº«ä¸websocketå¹¶ä¸ç›¸å®¹.</p><blockquote><p>å°½ç®¡ Socket.IO åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ç¡®å®ä½¿ç”¨ WebSocket è¿›è¡Œä¼ è¾“ï¼Œä½†å®ƒä¼šåœ¨æ¯ä¸ªæ•°æ®åŒ…ä¸­æ·»åŠ é¢å¤–çš„å…ƒæ•°æ®ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ WebSocket å®¢æˆ·ç«¯æ— æ³•æˆåŠŸè¿æ¥åˆ° Socket.IO æœåŠ¡å™¨ï¼Œè€Œ Socket.IO å®¢æˆ·ç«¯ä¹Ÿæ— æ³•è¿æ¥åˆ°çº¯ WebSocket æœåŠ¡å™¨ã€‚</p></blockquote><p>serverå¯ä»¥å¯¹åº”å¤šä¸ªnamespaceå’Œclient,æŒç®¡å¤šä¸ªsockets.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240331182812851.png" alt="image-20240331182812851"></p><p><code>io.of</code>ä¸<code>`io.in</code>åˆ†åˆ«è¡¨ç¤ºåœ¨æŸä¸ªnamespaceä¸‹å’ŒæŸä¸ªroomæˆ–è€…idçš„socket</p><p>è·å–è¿æ¥çš„å®¢æˆ·ç«¯çš„æ•°ç›®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = io.engine.clientsCount;</span><br><span class="line"><span class="comment">// may or may not be similar to the count of Socket instances in the main namespace, depending on your usage</span></span><br><span class="line"><span class="keyword">const</span> count2 = io.of(<span class="string">&quot;/&quot;</span>).sockets.size;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–serverå¯ä»¥ç®¡ç†rooms,åè€…ç›¸å½“äºéš”ç¦».æ¯”å¦‚ä¸‹é¢ä»£ç æ˜¯æ‹‰è¿›æˆ¿é—´ä¸æ‹‰å‡ºæˆ¿é—´</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make all Socket instances join the &quot;room1&quot; room</span></span><br><span class="line">io.socketsJoin(<span class="string">&quot;room1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room join the &quot;room2&quot; and &quot;room3&quot; rooms</span></span><br><span class="line">io.in(<span class="string">&quot;room1&quot;</span>).socketsJoin([<span class="string">&quot;room2&quot;</span>, <span class="string">&quot;room3&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room of the &quot;admin&quot; namespace join the &quot;room2&quot; room</span></span><br><span class="line">io.of(<span class="string">&quot;/admin&quot;</span>).in(<span class="string">&quot;room1&quot;</span>).socketsJoin(<span class="string">&quot;room2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// this also works with a single socket ID</span></span><br><span class="line">io.in(theSocketId).socketsJoin(<span class="string">&quot;room1&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make all Socket instances leave the &quot;room1&quot; room</span></span><br><span class="line">io.socketsLeave(<span class="string">&quot;room1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room leave the &quot;room2&quot; and &quot;room3&quot; rooms</span></span><br><span class="line">io.in(<span class="string">&quot;room1&quot;</span>).socketsLeave([<span class="string">&quot;room2&quot;</span>, <span class="string">&quot;room3&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room of the &quot;admin&quot; namespace leave the &quot;room2&quot; room</span></span><br><span class="line">io.of(<span class="string">&quot;/admin&quot;</span>).in(<span class="string">&quot;room1&quot;</span>).socketsLeave(<span class="string">&quot;room2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// this also works with a single socket ID</span></span><br><span class="line">io.in(theSocketId).socketsLeave(<span class="string">&quot;room1&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å…³é—­socketè¿æ¥ä»¥åŠè·å–å¯¹åº”çš„socket.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make all Socket instances disconnect</span></span><br><span class="line">io.disconnectSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room disconnect (and discard the low-level connection)</span></span><br><span class="line">io.in(<span class="string">&quot;room1&quot;</span>).disconnectSockets(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make all Socket instances in the &quot;room1&quot; room of the &quot;admin&quot; namespace disconnect</span></span><br><span class="line">io.of(<span class="string">&quot;/admin&quot;</span>).in(<span class="string">&quot;room1&quot;</span>).disconnectSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// this also works with a single socket ID</span></span><br><span class="line">io.of(<span class="string">&quot;/admin&quot;</span>).in(theSocketId).disconnectSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// return all Socket instances of the main namespace</span></span><br><span class="line"><span class="keyword">const</span> sockets = <span class="keyword">await</span> io.fetchSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// return all Socket instances in the &quot;room1&quot; room of the main namespace</span></span><br><span class="line"><span class="keyword">const</span> sockets = <span class="keyword">await</span> io.in(<span class="string">&quot;room1&quot;</span>).fetchSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// return all Socket instances in the &quot;room1&quot; room of the &quot;admin&quot; namespace</span></span><br><span class="line"><span class="keyword">const</span> sockets = <span class="keyword">await</span> io.of(<span class="string">&quot;/admin&quot;</span>).in(<span class="string">&quot;room1&quot;</span>).fetchSockets();</span><br><span class="line"></span><br><span class="line"><span class="comment">// this also works with a single socket ID</span></span><br><span class="line"><span class="keyword">const</span> sockets = <span class="keyword">await</span> io.in(theSocketId).fetchSockets();</span><br></pre></td></tr></table></figure><p>serverSideEmitå…è®¸å‘é›†ç¾¤ä¸­çš„å…¶ä»– Socket.IO æœåŠ¡å™¨å‘å‡ºäº‹ä»¶(å¤šserverä¸­)(éœ€è¦é…ç½®adapter)</p><p>socketå¯ä»¥<code>emit</code>,<code>join</code>,<code>leave</code>ä»¥åŠ<code>disconnet</code>ç­‰æ“ä½œ,å±æ€§åŒ…æ‹¬id,handshake(åŒ…å«å¤´,å®¢æˆ·ç«¯åœ°å€ç­‰é‡è¦ä¿¡æ¯),roomsä»¥åŠåŒ…å«çš„æ•°æ®. å®ƒæ˜¯ä¸å®¢æˆ·ç«¯äº¤äº’çš„åŸºæœ¬ç±»ã€‚å®ƒç»§æ‰¿äº† Node.js EventEmitter çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¦‚ emitã€onã€once æˆ– removeListenerã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">headers</span>: <span class="comment">/* the headers of the initial request */</span></span><br><span class="line">  query: <span class="comment">/* the query params of the initial request */</span></span><br><span class="line">  auth: <span class="comment">/* the authentication payload */</span></span><br><span class="line">  time: <span class="comment">/* the date of creation (as string) */</span></span><br><span class="line">  issued: <span class="comment">/* the date of creation (unix timestamp) */</span></span><br><span class="line">  url: <span class="comment">/* the request URL string */</span></span><br><span class="line">  address: <span class="comment">/* the ip of the client */</span></span><br><span class="line">  xdomain: <span class="comment">/* whether the connection is cross-domain */</span></span><br><span class="line">  secure: <span class="comment">/* whether the connection is secure */</span></span><br><span class="line">&#125;</span><br><span class="line">io.on(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(socket.rooms); <span class="comment">// Set &#123; &lt;socket.id&gt; &#125;</span></span><br><span class="line">  socket.join(<span class="string">&quot;room1&quot;</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(socket.rooms); <span class="comment">// Set &#123; &lt;socket.id&gt;, &quot;room1&quot; &#125;</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// server A</span></span><br><span class="line">io.on(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  socket.data.username = <span class="string">&quot;alice&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// server B</span></span><br><span class="line"><span class="keyword">const</span> sockets = <span class="keyword">await</span> io.fetchSockets();</span><br><span class="line"><span class="built_in">console</span>.log(sockets[<span class="number">0</span>].data.username); <span class="comment">// &quot;alice&quot;</span></span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä½¿ç”¨å¯¹åº”çš„åº“<code>`socket.io-client</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = io(<span class="string">&quot;http://localhost:3000&quot;</span>);</span><br><span class="line">  socket.on(<span class="string">&quot;connect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Connected to server&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  socket.on(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Received message:&quot;</span>, data);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&quot;message-input&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> message = input.value;</span><br><span class="line">    socket.emit(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">    input.value = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>æ­¤å¤–è¿˜æœ‰Hapi.js,Adonis.js,Egg.jsç­‰ç­‰,ä¸è¿‡åŸºæœ¬é€»è¾‘éƒ½ä¸€æ ·äº†.è®©æˆ‘æ¨èçš„è¯,è¿˜æ˜¯express,å¤§å‹çš„ä¸Šnest.js. è¿˜è¦è¯´ä¸€å¥,jsçš„åç«¯æ¡†æ¶ä¸­æ–‡æ–‡æ¡£è´¨é‡è¿˜æœ‰å¾…æå‡,å…¶å®åŒ…æ‹¬è‹±æ–‡æ–‡æ¡£çœ‹èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹è€æ—§.</p><p>Pythonçš„Webæœ¯è¯­é‡Œé¢è¿˜æ˜¯è®²è§†å›¾views,æ¨¡å‹models,urlsè¿™ç§çš„(å—Django,Flaskçš„å½±å“?),è€ŒNodeè¿™è¾¹åç«¯æ¡†æ¶è¿˜æ˜¯åœ¨è¯´è·¯ç”±è¿™ç§.</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰å†™äº†Python,ç°åœ¨å†™ç‚¹NodeJSçš„,å½“ç„¶ç›®å‰JSçš„è¿è¡Œæ—¶è¿˜æœ‰Denoå’ŒBun,ä¸è¿‡è¿˜æ˜¯éœ€è¦æ—¶é—´æ£€éªŒ.è€ŒNodeçš„åç«¯æ¡†æ¶ä¹Ÿä¸å°‘,å…¶ä¸­ä½¼ä½¼è€…å½“å±Nest.js,è€Œæ›´å°çš„æœ‰Expressè¿™ç§.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>åˆ·é¢˜ç½‘ç«™æ€»ç»“</title>
    <link href="https://www.sekyoro.top/2024/03/30/%E5%88%B7%E9%A2%98%E7%BD%91%E7%AB%99%E6%80%BB%E7%BB%93/"/>
    <id>https://www.sekyoro.top/2024/03/30/%E5%88%B7%E9%A2%98%E7%BD%91%E7%AB%99%E6%80%BB%E7%BB%93/</id>
    <published>2024-03-30T04:40:59.000Z</published>
    <updated>2024-03-31T07:34:08.471Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>åšè¿™äº›ä¸»è¦è¿˜æ˜¯é”»ç‚¼æ‰‹æ„Ÿ,ä¸è¦å¿˜äº†ä¸€äº›åŸºç¡€çŸ¥è¯†.æ­¤å¤–è¿˜åŒ…å«pythonå’Œtypescriptçš„typingé—®é¢˜.<br><span id="more"></span></p><h2 id="å·¥ä½œåˆ·é¢˜å‹"><a href="#å·¥ä½œåˆ·é¢˜å‹" class="headerlink" title="å·¥ä½œåˆ·é¢˜å‹"></a>å·¥ä½œåˆ·é¢˜å‹</h2><h3 id="Leetcode"><a href="#Leetcode" class="headerlink" title="Leetcode"></a>Leetcode</h3><p>ç”¨çš„æœ€å¤š,æˆ‘ä¸ªäººæ„Ÿè§‰ä¸ç”¨çº ç»“ç”¨.cnè¿˜æ˜¯.comçš„,ä¹Ÿæœ‰å‘¨èµ›å’Œä¼ä¸šé¢˜</p><h3 id="ç‰›å®¢ç½‘"><a href="#ç‰›å®¢ç½‘" class="headerlink" title="ç‰›å®¢ç½‘"></a>ç‰›å®¢ç½‘</h3><p>æ›´åŠ æœ¬åœŸåŒ–,æœ¬åœ°ä¼ä¸šçš„é¢˜åº“æ›´å¤šå§</p><h2 id="å­¦ä¹ å‹"><a href="#å­¦ä¹ å‹" class="headerlink" title="å­¦ä¹ å‹"></a>å­¦ä¹ å‹</h2><h3 id="codewars"><a href="#codewars" class="headerlink" title="codewars"></a>codewars</h3><p>æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ç½‘ç«™,é€‚åˆç»ƒç»ƒæ‰‹,é¢˜å€’æ˜¯ä¸éš¾.</p><p><img data-src="https://s2.loli.net/2024/03/30/ewEQhUAfYzPDgyi.png" alt="image-20240330160405991"></p><h3 id="hackerrank"><a href="#hackerrank" class="headerlink" title="hackerrank"></a>hackerrank</h3><p>æœ‰å„ç§æŠ€èƒ½çš„ç»ƒä¹ ,ä¹Ÿæœ‰ä¸åŒå±‚æ¬¡çš„ç»ƒä¹ é¢˜.çœ‹ä¸ªäººçˆ±å¥½äº†.</p><h2 id="ç«èµ›å‹"><a href="#ç«èµ›å‹" class="headerlink" title="ç«èµ›å‹"></a>ç«èµ›å‹</h2><p>ä¸‹é¢å°±æ˜¯åŠ¨çœŸæ ¼çš„äº†</p><h3 id="Codeforces"><a href="#Codeforces" class="headerlink" title="Codeforces"></a>Codeforces</h3><p><img data-src="https://s2.loli.net/2024/03/30/wK2Lj76fsRHQcNM.png" alt="image-20240330161209680"></p><h3 id="Topcoder"><a href="#Topcoder" class="headerlink" title="Topcoder"></a>Topcoder</h3><p>è¿™ä¸ªå¹³å°ä¸å…¶è¯´æ‹¿æ¥åˆ·é¢˜,ä¸å¦‚æ‹¿æ¥èµšé’±.</p><p><img data-src="https://s2.loli.net/2024/03/30/PF2gaYGQUVqrdnD.png" alt="image-20240330161514807"></p><h3 id="Atcoder"><a href="#Atcoder" class="headerlink" title="Atcoder"></a>Atcoder</h3><p><img data-src="https://s2.loli.net/2024/03/30/vjXfSmzR4l9QsKd.png" alt="image-20240330161747680" style="zoom:50%;" /></p><p>ä»éš¾åº¦ä¸Šè¯´ç›¸æ¯”cfæ›´é€‚åˆæ–°æ‰‹äº†.</p><p><a href="https://www.cnblogs.com/wawcac-blog/articles/12245307.html">ä¸€ç§ç¨‹åºè®¾è®¡ç«èµ›çš„è®­ç»ƒæ–¹æ³•ï¼ˆè¯‘ï¼‰ - wawcac - åšå®¢å›­ (cnblogs.com)</a></p><h2 id="ç»ƒä¹ è¯­è¨€"><a href="#ç»ƒä¹ è¯­è¨€" class="headerlink" title="ç»ƒä¹ è¯­è¨€"></a>ç»ƒä¹ è¯­è¨€</h2><h3 id="python-type-challenge"><a href="#python-type-challenge" class="headerlink" title="python-type-challenge"></a>python-type-challenge</h3><p><a href="https://github.com/laike9m/Python-Type-Challenges">laike9m/Python-Type-Challenges: Master Python typing (type hints) with interactive online exercises! (github.com)</a></p><p>pythonçš„typingä¸å¦‚ts,ä½†æ˜¯åˆé€‚çš„ä½¿ç”¨ä¸€äº›æ•ˆæœè¿˜æ˜¯ä¸é”™çš„.</p><h3 id="type-challenges"><a href="#type-challenges" class="headerlink" title="type-challenges"></a>type-challenges</h3><p><img data-src="https://s2.loli.net/2024/03/30/f4CrVLp8lKYXjEi.png" alt="image-20240330160751891" style="zoom:50%;" /></p><p>ç»ƒä¹ tsçš„typing,</p><p>è§£æ<a href="https://blog.maxiaobo.com.cn/type-challenge/dist/">å…³äºæœ¬æ–‡æ¡£ | TS ç±»å‹æŒ‘æˆ˜é€šå…³æ‰‹å†Œ (maxiaobo.com.cn)</a></p><h3 id="type-hero"><a href="#type-hero" class="headerlink" title="type-hero"></a>type-hero</h3><p>åŒä¸Š,ç»ƒä¹ tsçš„typing,ä½†æ˜¯é¢˜ç›®ä¸ä¸€æ ·.</p><p>é™¤äº†ä¸Šé¢ä¹‹å¤–å…¶å®è¿˜æœ‰å¾ˆå¤šOJç½‘ç«™,ä½†æ˜¯æˆ‘æƒ³è¿™ä¹ˆå¤šä¹Ÿæ²¡å¿…è¦ä¸€ä¸€åˆ—ä¸¾.</p><p>ç›®å‰æˆ‘ä¸ªäººå¸¸ç”¨çš„å°±æ˜¯Leetcodeåˆ·é¢˜,Codewarséšä¾¿ç»ƒç»ƒæ‰‹ä»¥åŠCodeforceså»è§‚æ‘©å¤§ä½¬.</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;åšè¿™äº›ä¸»è¦è¿˜æ˜¯é”»ç‚¼æ‰‹æ„Ÿ,ä¸è¦å¿˜äº†ä¸€äº›åŸºç¡€çŸ¥è¯†.æ­¤å¤–è¿˜åŒ…å«pythonå’Œtypescriptçš„typingé—®é¢˜.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>pythonçš„Webæ¡†æ¶æ¯”è¾ƒ</title>
    <link href="https://www.sekyoro.top/2024/03/27/python%E7%9A%84Web%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83/"/>
    <id>https://www.sekyoro.top/2024/03/27/python%E7%9A%84Web%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83/</id>
    <published>2024-03-27T14:22:39.000Z</published>
    <updated>2024-03-29T15:52:22.003Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¹‹å‰å¥½åƒå†™è¿‡ä¸€äº›å…³äºPythonçš„Webæ¡†æ¶?ç°åœ¨å†æŒ‰ç…§ASGIä¸åŸæœ¬çš„WSGIåŒºåˆ†ä¸€ä¸‹,é¡ºä¾¿æŠŠ<strong>æ¡†æ¶</strong>(framework)ä¸<strong>åº“</strong>(library)åŒºåˆ†ä¸€ä¸‹.<br><span id="more"></span></p><p>ä¹‹å‰æˆ‘ä¹Ÿå†™è¿‡(æˆ–è€…è¯´æƒ³è¿‡)ä¸€äº›ç±»ä¼¼ç”Ÿæ€ä»¥åŠä½œç”¨çš„æ¡†æ¶è¿›è¡Œæ¯”è¾ƒ,å¤§å¤šéƒ½æ˜¯çœ‹çœ‹ç½‘ä¸Šè¯„ä»·ä»¥åŠstaræ•°,ç°åœ¨æˆ‘æƒ³å¤§æ¦‚ä½¿ç”¨ä»¥ä¸‹æ„Ÿå—ä¸€ä¸‹æ°›å›´,æ¯•ç«Ÿç°åœ¨æ‰¾å·¥ä½œä¸€èˆ¬ä¹Ÿä¸ä¼šå¼ºè°ƒç”¨pythonçš„web(äº‹å®ä¸Špythonçš„webç¡®å®è¦æ¯”Javaçš„ç”Ÿæ€å•¥çš„è¦å·®).</p><p>æ ¹æ®githubçš„starä¸ç½‘ä¸Šè§‚å¯Ÿ,æˆ‘å¯¹Django,Flask,FastAPI,Tornado,Sanicä¸Šæ‰‹æµ…å°ä¸€ä¸‹,æ¯•ç«Ÿå…¶ä»–æ¡†æ¶è¿˜ä¸åˆ°10k star,æœªæ¥å¯æœŸ.</p><p>é¦–å…ˆä½¿ç”¨Pythonå¼€å‘webçš„ä¸»è¦ç›®çš„è¿˜æ˜¯å¼€å‘æ•ˆç‡é«˜,å¯ç”¨çš„ç¬¬ä¸‰æ–¹åº“å¯ä»¥è¯´æ˜¯æ•°ä¸€<del>æ•°äºŒ</del>,è€Œwebæ¡†æ¶æœ¬èº«å¾ˆå¤šæ—¶å€™å°±æ˜¯åœ¨ä¼ å‚CRUDææ¥æå»,æ‰€ä»¥ç›¸å…³ç”Ÿæ€å’Œç¤¾åŒºæ´»è·ƒåº¦åº”è¯¥æ˜¯æœ€é‡è¦çš„å› ç´ ä¹‹ä¸€äº†.è¿™ä¹Ÿæ˜¯æˆ‘é€‰æ‹©staræ•°é«˜çš„æ¡†æ¶åŸå› ,æˆ‘çœ‹è§æœ‰äº›æ¨èçš„æŸäº›æ¡†æ¶å·²ç»å‡ å¹´æ²¡æœ‰æ–°çš„commitäº†,æ‰€ä»¥ç°åœ¨è¶ç€æœ‰ç©ºçœ‹çœ‹ç›®å‰Python webæƒ…å†µ.å¦å¤–å¯ä»¥è®¢é˜…<a href="https://pycoders.com/">PyCoderâ€™s Weekly | A Weekly Python Email Newsletter (pycoders.com)</a></p><p><img data-src="https://s2.loli.net/2024/03/28/1VRMny34mdt9b6f.png" alt="image-20240328234239085"></p><p><img data-src="https://i.imgur.com/7paYgeL.jpg" alt="img"></p><p>æ‰å¿ƒäº†â€¦.2015å¹´çš„å›ç­”,è¿˜æ˜¯å¾ˆé¢†å…ˆçš„.æ‰€ä»¥Pythonçš„å¼ºé¡¹è¿˜æ˜¯åè®¡ç®—,åšä¸€äº›æœ‰æ•ˆçš„ä¸Šå±‚çš„åº”ç”¨.æˆ–è€…å»ç ”ç©¶ä¸€ä¸‹CPythonåšä¸œè¥¿.</p><p>è€Œç›®å‰Flask,Djangoéƒ½å·²æ”¯æŒå¼‚æ­¥ç½‘ç»œæ¨¡å‹,æ‰€ä»¥åšä¸ªå°é¡¹ç›®åº”è¯¥æ˜¯æ²¡å•¥å·®åˆ«çš„.ä»¥ä¸‹ä½¿ç”¨poetryç®¡ç†åŒ…ç¯å¢ƒ.</p><p><img data-src="https://s2.loli.net/2024/03/29/PMb2aJfliZdmTH8.png" alt="image-20240329235216575"></p><h3 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h3><p><a href="https://docs.djangoproject.com/zh-hans/5.0/intro/overview/">åˆè¯† Django | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">poetry add django</span><br><span class="line">django-admin startproject mysite</span><br></pre></td></tr></table></figure><p>åˆ›å»ºé¡¹ç›®,ä¸€ä¸ªé¡¹ç›®ä¸‹æœ‰å¾ˆå¤šåº”ç”¨.</p><blockquote><p>ä¸€ä¸ª Python åŒ… â€”â€” å³ä¸€ä¸ªä»£ç ç›®å½• â€” å®ƒåŒ…å« Django çš„ä¸€ä¸ªå®ä¾‹ä¸­æ‰€æœ‰çš„è®¾ç½®ã€‚è¿™åŒ…æ‹¬æ•°æ®åº“é…ç½®ï¼ŒDjango çš„ç‰¹å®šé€‰é¡¹å’Œç‰¹å®šåº”ç”¨ç¨‹åºè®¾ç½®</p></blockquote><p>æ–‡ä»¶ç»“æ„å¦‚ä¸‹</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysite/</span><br><span class="line">    manage.<span class="keyword">py</span></span><br><span class="line">    mysite/</span><br><span class="line">        __init__.<span class="keyword">py</span></span><br><span class="line">        settings.<span class="keyword">py</span></span><br><span class="line">        urls.<span class="keyword">py</span></span><br><span class="line">        asgi.<span class="keyword">py</span></span><br><span class="line">        wsgi.<span class="keyword">py</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>views.py</code>ä¸­åˆ›å»º<strong>è§†å›¾</strong>,åœ¨åˆ›å»º<code>urls.py</code>ä½œä¸ºurlé…ç½®è¿›è¡Œæ˜ å°„,ç„¶ååœ¨mysite/urls.pyåˆ›å»ºurlpatterns</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> include, path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&quot;polls/&quot;</span>, include(<span class="string">&quot;polls.urls&quot;</span>)),</span><br><span class="line">    path(<span class="string">&quot;admin/&quot;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ä½œä¸ºwebæ¡†æ¶éœ€è¦æ€è€ƒçš„å‡ ä¸ªé—®é¢˜å°±æ˜¯ æ•°æ®åº“çš„CRUD,åœ¨Djangoçš„setting.pyä¸‹ä¿®æ”¹ç›¸å…³é…ç½®.æ¯”å¦‚é…ç½®æ•°æ®åº“çš„è¿æ¥ä»¥åŠè´¦æˆ·,å¯†ç ç­‰ä¿¡æ¯.æ­¤å¤–è¿™ä¸ªæ–‡ä»¶ä¸­è¿˜æœ‰ä¸€äº›é»˜è®¤å®‰è£…çš„åº”ç”¨,è¿™äº›åº”ç”¨æœ‰äº›ä¹Ÿä¼šåˆ›å»ºæ•°æ®è¡¨åœ¨ä½¿ç”¨ä¹‹å‰éœ€è¦åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€äº›è¡¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ¨¡å‹"><a href="#åˆ›å»ºæ¨¡å‹" class="headerlink" title="åˆ›å»ºæ¨¡å‹"></a>åˆ›å»ºæ¨¡å‹</h4><p>è®¸å¤šwebæ¡†æ¶éƒ½å¼ºè°ƒè¿™ä¸€ç‚¹,ç„¶è€Œæ¨¡å‹åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ<code>æ•°æ®åº“ç»“æ„è®¾è®¡å’Œé™„åŠ çš„å…¶å®ƒå…ƒæ•°æ®</code></p><blockquote><p>ä¸€ä¸ªæ¨¡å‹å°±æ˜¯å•ä¸ªå®šä¹‰ä½ çš„æ•°æ®çš„ä¿¡æ¯æºã€‚æ¨¡å‹ä¸­åŒ…å«äº†ä¸å¯ç¼ºå°‘çš„æ•°æ®åŒºåŸŸå’Œä½ å­˜å‚¨æ•°æ®çš„è¡Œä¸ºã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Question</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    question_text = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    pub_date = models.DateTimeField(<span class="string">&quot;date published&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Choice</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    question = models.ForeignKey(Question, on_delete=models.CASCADE)</span><br><span class="line">    choice_text = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    votes = models.IntegerField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¥½åå°±èƒ½ç›´æ¥ä½¿ç”¨djangoæä¾›çš„å·¥å…·,å…ˆåˆ›å»ºpythonå†™çš„sqlè¯­å¥,å†åˆ©ç”¨è¯­å¥åˆ›å»ºè¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations polls</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œä½¿ç”¨é»˜è®¤çš„sqliteæ•°æ®åº“,è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„.</p><p><img data-src="https://s2.loli.net/2024/03/29/HThLi4fXlgpUcsu.png" alt="image-20240329200022851"></p><p>å½“ç„¶å®šä¹‰é‡Œæ¨¡å‹ä¹‹åè¿˜è¦æ¿€æ´»æ¨¡å‹æ‰èƒ½åˆ›å»ºè¿ç§»è¯­å¥.æ¿€æ´»è¯­å¥å°±æ˜¯åœ¨setting.pyä¸­æ·»åŠ é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&quot;polls.apps.PollsConfig&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.auth&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.contenttypes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.sessions&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.messages&quot;</span>,</span><br><span class="line">    <span class="string">&quot;django.contrib.staticfiles&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥è¿›shell,é€šè¿‡åˆ›å»ºçš„modelsç›´æ¥è¿›è¡Œæ·»åŠ å­—æ®µ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py shell</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç›´æ¥åˆ©ç”¨ç»§æ‰¿äº†models.Modelçš„pythonå¯¹è±¡æ“ä½œæ•°æ®åº“å­—æ®µ.</p><p>æ­¤å¤–è¿˜å¯ä»¥åˆ›å»ºè¶…çº§ç”¨æˆ·é€šè¿‡webä¿®æ”¹.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦åœ¨admin.pyä¸­æ³¨å†Œä¸€ä¸‹å¯ä»¥åœ¨ç®¡ç†å‘˜ä¸­æŸ¥çœ‹.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin.py</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line">admin.site.register(Question)</span><br></pre></td></tr></table></figure><p>DjangoæŠŠå¯¹äºrequestçš„ç›¸åº”å«åšviews,æœ¬èº«å®ƒä¹Ÿæœ‰ä¸ªè²Œä¼¼å«åšMVTçš„æ¦‚å¿µ?å…¶å®è·ŸMVCå·®ä¸å¤š,model,viewä»¥åŠtemplate.è¿™äº›æ¦‚å¿µå…¶å®æ—©å°±åœ¨å…¶å®ƒè¯­è¨€çš„webæ¡†æ¶æ·±æ·±æ¸—é€äº†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Hello, world. You&#x27;re at the polls index.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sayHello</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;ans&quot;</span>: <span class="string">&quot;Hello&quot;</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;You&#x27;re looking at question %s.&quot;</span> % question_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    response = <span class="string">&quot;You&#x27;re looking at the results of question %s.&quot;</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(response % question_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;You&#x27;re voting on question %s.&quot;</span> % question_id)</span><br></pre></td></tr></table></figure><p>å†åœ¨urlsä¸­é…ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ex: /polls/</span></span><br><span class="line">    path(<span class="string">&quot;&quot;</span>, views.index, name=<span class="string">&quot;index&quot;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/</span></span><br><span class="line">    path(<span class="string">&quot;&lt;int:question_id&gt;/&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/results/</span></span><br><span class="line">    path(<span class="string">&quot;&lt;int:question_id&gt;/results/&quot;</span>, views.results, name=<span class="string">&quot;results&quot;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/vote/</span></span><br><span class="line">    path(<span class="string">&quot;&lt;int:question_id&gt;/vote/&quot;</span>, views.vote, name=<span class="string">&quot;vote&quot;</span>),</span><br><span class="line"></span><br><span class="line">    path(<span class="string">&quot;what&quot;</span>, views.vote, name=<span class="string">&quot;vote&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>è§†å›¾å¯ä»¥ä»æ•°æ®åº“é‡Œè¯»å–è®°å½•ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼ˆæ¯”å¦‚ Django è‡ªå¸¦çš„ï¼Œæˆ–è€…å…¶ä»–ç¬¬ä¸‰æ–¹çš„ï¼‰ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ª PDF æ–‡ä»¶ï¼Œå¯ä»¥è¾“å‡ºä¸€ä¸ª XMLï¼Œåˆ›å»ºä¸€ä¸ª ZIP æ–‡ä»¶ï¼Œä½ å¯ä»¥åšä»»ä½•ä½ æƒ³åšçš„äº‹ï¼Œä½¿ç”¨ä»»ä½•ä½ æƒ³ç”¨çš„ Python åº“ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸€ä¸ªæ¨¡æ¿ä½œä¸ºè§†å›¾çš„è¿”å›å€¼.å¯ä»¥çœ‹åˆ°settingä¸­çš„è®¾ç½®</p><p>åœ¨è§†å›¾ä¸­,å¯ä»¥ä½¿ç”¨HttpResponseå’Œtemplate.renderè¿”å›html,æˆ–è€…æ˜¯ç›´æ¥ä½¿ç”¨render.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    latest_question_list = Question.objects.order_by(<span class="string">&quot;-pub_date&quot;</span>)[:<span class="number">5</span>]</span><br><span class="line">    context = &#123;<span class="string">&quot;latest_question_list&quot;</span>: latest_question_list&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&quot;polls/index.html&quot;</span>, context)</span><br></pre></td></tr></table></figure><blockquote><p>è½½å…¥æ¨¡æ¿ï¼Œå¡«å……ä¸Šä¸‹æ–‡ï¼Œå†è¿”å›ç”±å®ƒç”Ÿæˆçš„ <a href="https://docs.djangoproject.com/zh-hans/5.0/ref/request-response/#django.http.HttpResponse"><code>HttpResponse</code></a> å¯¹è±¡ã€æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„æ“ä½œæµç¨‹ã€‚äºæ˜¯ Django æä¾›äº†ä¸€ä¸ªå¿«æ·å‡½æ•°ï¼Œç”¨å®ƒæ¥é‡å†™ <code>index()</code> è§†å›¾</p></blockquote><p>å¯ä»¥æŠ›å‡º404é”™è¯¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        question = Question.objects.get(pk=question_id)</span><br><span class="line">    <span class="keyword">except</span> Question.DoesNotExist:</span><br><span class="line">        <span class="keyword">raise</span> Http404(<span class="string">&quot;Question does not exist&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&quot;polls/detail.html&quot;</span>, &#123;<span class="string">&quot;question&quot;</span>: question&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&quot;polls/detail.html&quot;</span>, &#123;<span class="string">&quot;question&quot;</span>: question&#125;)</span><br></pre></td></tr></table></figure><p>ä¼ å…¥å‚æ•°å¯ä¾›æ¨¡æ¿è°ƒç”¨</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% for choice in question.choice_set.all %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; choice.choice_text &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿˜èƒ½ä½¿ç”¨urls.pyä¸­çš„nameä¿®æ”¹æ¨¡æ¿ä¸­çš„ç¡¬ç¼–ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&quot;&lt;int:question_id&gt;/&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;a href=<span class="string">&quot;/polls/&#123;&#123; question.id &#125;&#125;/&quot;</span>&gt;&#123;&#123; question.question_text &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;a href=<span class="string">&quot;&#123;% url &#x27;detail&#x27; question.id %&#125;&quot;</span>&gt;&#123;&#123; question.question_text &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¨¡æ¿ä¸­ä½¿ç”¨<code>&#123;% url 'detail'%&#125;</code>å°±è¡¨ç¤º</p><p>è¿˜å¯ä»¥ç»™urlåç§°æ·»åŠ å‘½åç©ºé—´.ä¸ºäº†é¿å…å¤šä¸ªåº”ç”¨viewså†²çª.åœ¨urls.pyä¸­æ·»åŠ app.name</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_name = &quot;polls&quot;</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ä½¿ç”¨<code>HttpResponseRedirect</code>çš„<code>`reverse()</code>çš„å‡½æ•°æ„é€ URLå­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HttpResponseRedirect(reverse(<span class="string">&quot;polls:results&quot;</span>, args=(question.<span class="built_in">id</span>,)))</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨é€šç”¨è§†å›¾,é€šç”¨è§†å›¾å°†å¸¸è§çš„æ¨¡å¼æŠ½è±¡åˆ°äº†ä¸€ä¸ªåœ°æ­¥ï¼Œä»¥è‡³äºä½ ç”šè‡³ä¸éœ€è¦ç¼–å†™ Python ä»£ç æ¥åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼Œ<a href="https://docs.djangoproject.com/zh-hans/5.0/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><code>ListView</code></a> å’Œ <a href="https://docs.djangoproject.com/zh-hans/5.0/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><code>DetailView</code></a> é€šç”¨è§†å›¾åˆ†åˆ«æŠ½è±¡äº† â€œæ˜¾ç¤ºå¯¹è±¡åˆ—è¡¨â€ å’Œ â€œæ˜¾ç¤ºç‰¹å®šç±»å‹å¯¹è±¡çš„è¯¦ç»†é¡µé¢â€ çš„æ¦‚å¿µã€‚</p><blockquote><p>è¿™äº›è§†å›¾åæ˜ åŸºæœ¬çš„ç½‘ç»œå¼€å‘ä¸­çš„ä¸€ä¸ªå¸¸è§æƒ…å†µï¼š<strong>æ ¹æ® URL ä¸­çš„å‚æ•°ä»æ•°æ®åº“ä¸­è·å–æ•°æ®ã€è½½å…¥æ¨¡æ¿æ–‡ä»¶ç„¶åè¿”å›æ¸²æŸ“åçš„æ¨¡æ¿ã€‚ ç”±äºè¿™ç§æƒ…å†µç‰¹åˆ«å¸¸è§ï¼ŒDjango æä¾›ä¸€ç§å¿«æ·æ–¹å¼ï¼Œå«åš â€œé€šç”¨è§†å›¾â€ ç³»ç»Ÿ</strong>ã€‚</p></blockquote><p>ä½¿ç”¨é€šç”¨è§†å›¾éœ€è¦ä¿®æ”¹urlconfå’Œè§†å›¾.</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> <span class="type">path</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">app_name = &quot;polls&quot;</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(&quot;&quot;, views.IndexView.as_view(), <span class="type">name</span>=&quot;index&quot;),</span><br><span class="line">    path(&quot;&lt;int:pk&gt;/&quot;, views.DetailView.as_view(), <span class="type">name</span>=&quot;detail&quot;),</span><br><span class="line">    path(&quot;&lt;int:pk&gt;/results/&quot;, views.ResultsView.as_view(), <span class="type">name</span>=&quot;results&quot;),</span><br><span class="line">    path(&quot;&lt;int:question_id&gt;/vote/&quot;, views.vote, <span class="type">name</span>=&quot;vote&quot;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯ä½¿ç”¨æ”¹å¥½çš„é€šç”¨è§†å›¾è·Ÿurlé…å¯¹.å¯¹äºListViewå’ŒDetailViewä¸å¤ªä¸€æ ·,ListViewçš„contextå‘½åæ˜¯<model_name>_list,æ‰€ä»¥éœ€è¦ä½¿ç”¨<code>context_object_name</code>,è€ŒDetailViewé»˜è®¤æ˜¯<model_name></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Choice, Question</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">generic.ListView</span>):</span></span><br><span class="line">    template_name = <span class="string">&quot;polls/index.html&quot;</span></span><br><span class="line">    context_object_name = <span class="string">&quot;latest_question_list&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return the last five published questions.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Question.objects.order_by(<span class="string">&quot;-pub_date&quot;</span>)[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailView</span>(<span class="params">generic.DetailView</span>):</span></span><br><span class="line">    model = Question</span><br><span class="line">    template_name = <span class="string">&quot;polls/detail.html&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultsView</span>(<span class="params">generic.DetailView</span>):</span></span><br><span class="line">    model = Question</span><br><span class="line">    template_name = <span class="string">&quot;polls/results.html&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="comment"># same as above, no changes needed.</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è§†å›¾ä¸­é…ç½®å¥½æ¨¡æ¿,æ¨¡å‹è¿˜å¯ä»¥ä¿®æ”¹ä¼ å…¥çš„contextå˜é‡åå­—<code>context_object_name</code></p><p>æµ‹è¯•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionModelTests</span>(<span class="params">TestCase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_was_published_recently_with_future_question</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        was_published_recently() returns False for questions whose pub_date</span></span><br><span class="line"><span class="string">        is in the future.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        time = timezone.now() + datetime.timedelta(days=<span class="number">30</span>)</span><br><span class="line">        future_question = Question(pub_date=time)</span><br><span class="line">        self.assertIs(future_question.was_published_recently(), <span class="literal">False</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py test polls</span><br></pre></td></tr></table></figure><p>åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨é™æ€æ–‡ä»¶,é»˜è®¤ç›®å½•æ˜¯<code>static</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% static &#x27;polls/style.css&#x27; %&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥ä¿®æ”¹Djangoåå°çš„è¡¨å•å’Œç•Œé¢ç­‰.</p><p><a href="https://djangopackages.org/">Django Packages : Reusable apps, sites and tools directory for Django</a></p><p>å¯ä»¥çœ‹åˆ°djangoä¸æ„§æ˜¯pythonå†…æ´»è·ƒåº¦å’Œç”Ÿæ€æ•°ä¸€æ•°äºŒçš„æ¡†æ¶äº†,å¿«é€Ÿå¼€å‘è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„,å†…ç½®äº†å¾ˆå¤šä¸œè¥¿,ä¸åªæ˜¯å•çº¯çš„restfulAPI.å½“ç„¶Djangoä¹Ÿæœ‰ä¸ªrest framework<a href="https://www.django-rest-framework.org/">Home - Django REST framework (django-rest-framework.org)</a>æ›´åŠ é€‚åˆå†™API</p><h3 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h3><p>ç›¸æ¯”äºDjango,Flaskæ›´åå‘å•çº¯å†™API,æ’ä»¶ç”Ÿæ€æ²¡æœ‰Djangoå¤š,æ•°æ®åº“ä¸€èˆ¬ä½¿ç”¨sqlalchemy.</p><p>ä½†æ˜¯FlaskåŒ…æ‹¬äº†htmlæ¨¡æ¿,è·¯ç”±,é™æ€æ–‡ä»¶,sessionsåº”è¯¥æœ‰çš„åŠŸèƒ½.æˆ‘ä¹Ÿæ‹¿å®ƒå†™ä¸ªå°webç¨‹åº,è¿™é‡Œä¸èµ˜è¿°äº†.<a href="https://proanimer.com/arxiv/result">è®ºæ–‡æŸ¥ (proanimer.com)</a></p><p><a href="https://github.com/drowning-in-codes/paper-reader">drowning-in-codes/paper-reader (github.com)</a></p><p><img data-src="https://s2.loli.net/2024/03/29/DEFAU7eBNqKTmnX.png" alt="image-20240329225756697"></p><p>ä¸Šé¢è¿™ä¸¤ä¸ªæ¡†æ¶ç”¨äºç”Ÿäº§ç¯å¢ƒæ—¶è¿˜éœ€è¦ä½¿ç”¨WSGIæœåŠ¡å™¨,æ¯”å¦‚uWSGI,gunicornç­‰.</p><h3 id="FastAPI"><a href="#FastAPI" class="headerlink" title="FastAPI"></a>FastAPI</h3><p>å¾ˆç«çš„å¼‚æ­¥webæ¡†æ¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install fastapi</span><br><span class="line">pip install <span class="string">&quot;uvicorn[standard]&quot;</span></span><br></pre></td></tr></table></figure><p>çœ‹çœ‹ä¸‹é¢åŸºæœ¬ç¤ºä¾‹,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_root</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;Hello&quot;</span>: <span class="string">&quot;World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">int</span>, q: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br></pre></td></tr></table></figure><p>å†™æ³•è¿˜æ˜¯å¾ˆæœ´ç´ çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœä½ çš„ä»£ç é‡Œä¼šå‡ºç° async / awaitï¼Œè¯·ä½¿ç”¨ async defï¼š</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_root</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;Hello&quot;</span>: <span class="string">&quot;World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">int</span>, q: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹ç‚¹åŒ…æ‹¬:å¼‚æ­¥(Starletteæ”¯æŒ),æ•°æ®éªŒè¯Pydantic,äº¤äº’å¼æ–‡æ¡£(ä½¿ç”¨swagger UIç”Ÿæˆ)</p><p>å¾ˆå®¹æ˜“ä¸Šæ‰‹å­¦ä¹ ,å®˜æ–¹æ¨èæ•°æ®åº“ORMä¹Ÿæ˜¯SQLAlchemy.</p><h3 id="Tornado"><a href="#Tornado" class="headerlink" title="Tornado"></a>Tornado</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> tornado</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.write(<span class="string">&quot;Hello, world&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span>():</span></span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">        (<span class="string">r&quot;/&quot;</span>, MainHandler),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">8888</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.Event().wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯å¼‚æ­¥æ¡†æ¶,é€‚åˆwebsocketsç­‰.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install tornado</span><br></pre></td></tr></table></figure><p>æˆ‘çœ‹äº†ä¸€ä¸‹æ–‡æ¡£,æ„Ÿè§‰ä¸æ˜¯å¾ˆå¥½ä¸Šæ‰‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.write(<span class="string">&quot;Hello, world&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    application = tornado.web.Application([</span><br><span class="line">        (<span class="string">r&quot;/&quot;</span>, MainHandler),</span><br><span class="line">    ])</span><br><span class="line">    application.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()    </span><br></pre></td></tr></table></figure><p>Tornado å¤§è‡´å¯åˆ†ä¸ºå››ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ul><li>Webæ¡†æ¶ï¼ˆåŒ…æ‹¬ <a href="https://www.osgeo.cn/tornado/web.html#tornado.web.RequestHandler"><code>RequestHandler</code></a> å®ƒæ˜¯åˆ›å»ºWebåº”ç”¨ç¨‹åºå’Œå„ç§æ”¯æŒç±»çš„å­ç±»ï¼‰ã€‚</li><li>HTTPçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å®ç° (<a href="https://www.osgeo.cn/tornado/httpserver.html#tornado.httpserver.HTTPServer"><code>HTTPServer</code></a> å’Œ <a href="https://www.osgeo.cn/tornado/httpclient.html#tornado.httpclient.AsyncHTTPClient"><code>AsyncHTTPClient</code></a> ï¼‰</li><li>åŒ…å«ç±»çš„å¼‚æ­¥ç½‘ç»œåº“ <a href="https://www.osgeo.cn/tornado/ioloop.html#tornado.ioloop.IOLoop"><code>IOLoop</code></a> å’Œ <a href="https://www.osgeo.cn/tornado/iostream.html#tornado.iostream.IOStream"><code>IOStream</code></a> ä½œä¸ºHTTPç»„ä»¶çš„æ„å»ºå—ï¼Œä¹Ÿå¯ä»¥ç”¨äºå®ç°å…¶ä»–åè®®ã€‚</li><li>åä½œç¨‹åºåº“ (<a href="https://www.osgeo.cn/tornado/gen.html#module-tornado.gen"><code>tornado.gen</code></a> ï¼‰å®ƒå…è®¸å¼‚æ­¥ä»£ç ä»¥æ¯”é“¾æ¥å›è°ƒæ›´ç®€å•çš„æ–¹å¼å†™å…¥ã€‚è¿™ç±»ä¼¼äºPython3.5ä¸­å¼•å…¥çš„æœ¬åœ°ååŒå·¥ä½œç‰¹æ€§ã€‚</li></ul><h3 id="Sanic"><a href="#Sanic" class="headerlink" title="Sanic"></a>Sanic</h3><p>æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®å†ç”¨,ç›®å‰æ›´æ–°è¿˜æ˜¯æ¯”è¾ƒé¢‘ç¹çš„.å¯ä»¥è¯´æ˜¯é™¤äº†FastAPIæœ€æœ‰å‰é€”çš„äº†.</p><p><img data-src="https://s2.loli.net/2024/03/29/y8Uda4LGTKlDkXM.png" alt="image-20240329231255284"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sanic</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;MyHelloWorldApp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;Hello, world.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®˜ç½‘çš„æ–‡æ¡£ä¹Ÿå¼ºè°ƒäº†å…¶å…³æ³¨performance,flexibilityå’Œæ˜“äºä½¿ç”¨.æˆ‘è§‰å¾—è¿™äº›è·Ÿpythonæ¯”è¾ƒå¥‘åˆ.</p><p>è¿æ¥æ•°æ®åº“,appæ³¨å†Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">app = Sanic(<span class="string">&quot;MyApp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_server_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">attach_db</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    app.ctx.db = Database()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># app registry ç›¸å½“äºåœ¨ä¸€ä¸ªåœ°æ–¹ç»™å®ƒæŒ‚Sanicä¸Š</span></span><br><span class="line"><span class="comment"># ./path/to/server.py</span></span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;my_awesome_server&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./path/to/somewhere_else.py</span></span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"></span><br><span class="line">app = Sanic.get_app(<span class="string">&quot;my_awesome_server&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åº“é…ç½®</span></span><br><span class="line">app = Sanic(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.config.DB_NAME = <span class="string">&#x27;appdb&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;DB_USER&#x27;</span>] = <span class="string">&#x27;appuser&#x27;</span></span><br><span class="line"></span><br><span class="line">db_settings = &#123;</span><br><span class="line">    <span class="string">&#x27;DB_HOST&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DB_NAME&#x27;</span>: <span class="string">&#x27;appdb&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DB_USER&#x27;</span>: <span class="string">&#x27;appuser&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">app.config.update(db_settings)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ./path/to/server.py å·¥å‚æ¨¡å¼å¾—åˆ°appå¹¶ä½¿ç”¨sanic path.to.server:create_appè¿è¡Œ</span></span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> .path.to.config <span class="keyword">import</span> MyConfig</span><br><span class="line"><span class="keyword">from</span> .path.to.some.blueprint <span class="keyword">import</span> bp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config=MyConfig</span>) -&gt; Sanic:</span></span><br><span class="line">    app = Sanic(<span class="string">&quot;MyApp&quot;</span>, config=config)</span><br><span class="line">    app.blueprint(bp)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure><p>handlers,request,responseç­‰éƒ½æ˜¯è€è¯äº†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/foo&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">foo_handler</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;I said foo!&quot;</span>)</span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/typed&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">typed_handler</span>(<span class="params">request: Request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&#x27;OK&#x27;</span>)</span><br></pre></td></tr></table></figure><p>Sanicæä¾›äº†Listener,çœ‹èµ·æ¥åƒåœ¨ç”Ÿå‘½å‘¨æœŸå†…æ·»åŠ hook.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.reload_process_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">reload_start</span>(<span class="params">*_</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; reload_start &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.main_process_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_start</span>(<span class="params">*_</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; main_start &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_server_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">before_start</span>(<span class="params">*_</span>):</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; before_start &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&quot;before_server_start&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_1</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_server_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_2</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&quot;after_server_start&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_3</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_server_start</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_4</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_4&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&quot;before_server_stop&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_5</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_5&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_server_stop</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_6</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.listener(<span class="params"><span class="string">&quot;after_server_stop&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_7</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_7&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_server_stop</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">listener_8</span>(<span class="params">app, loop</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;listener_8&quot;</span>)</span><br></pre></td></tr></table></figure><p>Sanicè·ŸFlaskä¸€æ ·æä¾›äº†è“å›¾.</p><blockquote><p>è“å›¾æ˜¯ä¸€ç§å¯ç”¨äºåº”ç”¨ç¨‹åºå†…å­è·¯ç”±çš„å¯¹è±¡ã€‚è“å›¾å®šä¹‰äº†ç”¨äºæ·»åŠ è·¯ç”±çš„ç±»ä¼¼æ–¹æ³•ï¼Œè€Œä¸æ˜¯å°†è·¯ç”±æ·»åŠ åˆ°åº”ç”¨ç¨‹åºå®ä¾‹ä¸­ï¼Œç„¶åä»¥çµæ´»å’Œå¯æ’æ‹”çš„æ–¹å¼å°†è·¯ç”±æ³¨å†Œåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚</p><p>è“å›¾å¯¹å¤§å‹åº”ç”¨ç¨‹åºå°¤å…¶æœ‰ç”¨ï¼Œå› ä¸ºåœ¨å¤§å‹åº”ç”¨ç¨‹åºä¸­ï¼Œåº”ç”¨ç¨‹åºé€»è¾‘å¯è¢«åˆ†è§£ä¸ºå¤šä¸ªç»„æˆ–è´£ä»»åŒºã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ./my_blueprint.py</span><br><span class="line">from sanic.response import json</span><br><span class="line">from sanic import Blueprint</span><br><span class="line"></span><br><span class="line">bp = Blueprint(&quot;my_blueprint&quot;)</span><br><span class="line"></span><br><span class="line">@bp.route(&quot;/&quot;)</span><br><span class="line">async def bp_root(request):</span><br><span class="line">    return json(&#123;&quot;my&quot;: &quot;blueprint&quot;&#125;)</span><br><span class="line"></span><br><span class="line">from sanic import Sanic</span><br><span class="line">from my_blueprint import bp</span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.blueprint(bp)</span><br></pre></td></tr></table></figure><h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>æ­¤å¤–è¿˜æœ‰Starlette,Quart,Falconç­‰å¼‚æ­¥ç½‘ç»œæ¡†æ¶(å…¶å®æ²¡å¿…è¦è¿™ä¹ˆå¼ºè°ƒå¼‚æ­¥).ä½†é‰´äºè¿˜æ²¡æœ‰é‚£ä¹ˆå¤šç”Ÿæ€å°±å…ˆä¸å“é‰´äº†.</p><p>åé¢æœ‰ç©ºåº”è¯¥è¿˜ä¼šå“é‰´ä¸€ä¸‹Nodeçš„åç«¯æ¡†æ¶,æ¯”å¦‚koa,express,nestç­‰.PHPæ¡†æ¶è¿˜æœ‰Laravel,Sympfony,ThinkPHPä»¥åŠåŸºäºSwoole,workermançš„hyperf<a href="https://hyperf.wiki/2.0/#/">Hyperf</a>,webmanæ¡†æ¶ç­‰ç­‰,ä¸è¿‡æˆ‘å¯èƒ½æ›´çœ‹å¥½Laravel(ä¸ç”¨å¤ªåœ¨æ„å…¶æ€§èƒ½).é™¤äº†è¿™äº›è¯­è¨€,Java,C#,Goå°±æ˜¯Webå¸¸å®¢äº†(ä¸è¿‡.Netå‘å±•æœ‰ç‚¹æ›²æŠ˜),å®ƒä»¬çš„webæ¡†æ¶æ¯”è¾ƒé›†ä¸­ä¹Ÿæˆç†Ÿ,å·¥ä½œä¸Šä¹Ÿç”¨å¾—å¾ˆå¤š.</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰å¥½åƒå†™è¿‡ä¸€äº›å…³äºPythonçš„Webæ¡†æ¶?ç°åœ¨å†æŒ‰ç…§ASGIä¸åŸæœ¬çš„WSGIåŒºåˆ†ä¸€ä¸‹,é¡ºä¾¿æŠŠ&lt;strong&gt;æ¡†æ¶&lt;/strong&gt;(framework)ä¸&lt;strong&gt;åº“&lt;/strong&gt;(library)åŒºåˆ†ä¸€ä¸‹.&lt;br&gt;</summary>
    
    
    
    
    <category term="python" scheme="https://www.sekyoro.top/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Qtå˜å¤©äº†?äº†è§£Qt6ç›¸å…³æŠ€æœ¯</title>
    <link href="https://www.sekyoro.top/2024/03/24/Qt%E5%8F%98%E5%A4%A9%E4%BA%86-%E4%BA%86%E8%A7%A3Qt6%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF/"/>
    <id>https://www.sekyoro.top/2024/03/24/Qt%E5%8F%98%E5%A4%A9%E4%BA%86-%E4%BA%86%E8%A7%A3Qt6%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF/</id>
    <published>2024-03-24T10:37:06.000Z</published>
    <updated>2024-03-27T12:14:10.475Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ç›®å‰c/sæ¶æ„çš„åº”ç”¨å¼€å‘å·²ç»æœ‰äº†è¶³å¤Ÿå¤šçš„é€‰æ‹©,å…¶ä¸­è·¨å¹³å°çš„å¼€å‘ä¹Ÿéå¸¸å¤š.æ¯”å¦‚Dartçš„Flutter,C++çš„Qt,.Netçš„MAUIç­‰ç­‰,ä¸è¿‡å…¶ä¸­å‘ä¸æ˜¯å¤–è¡Œèƒ½ä¸€çœ¼çœ‹é€çš„,å°¤å…¶æ˜¯å¾®è½¯ç›¸å…³çš„UIæŠ€æœ¯æ ˆåˆ†æ”¯å®åœ¨å¤š,è·¨å¹³å°ç›¸å…³èƒ½åŠ›ä¸æ˜(å¾®è½¯è¿™æ–¹é¢çš„æ–‡æ¡£æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹ä¹±),å­¦ä¹ èµ„æ–™ä¸å¤Ÿå……è¶³,è€ŒQtå¹¶ä¸å¼€æº,ä½†æ˜¯æœ€è¿‘æˆ‘çœ‹åˆ°å…¶å®˜ç½‘åˆæ›´æ–°äº†ä¸€æ³¢æŠ€æœ¯,æ„Ÿè§‰å¾ˆäº®çœ¼,å’±ä»¬æ¥çœ‹çœ‹.<br><span id="more"></span></p><p>ç›®å‰è·¨å¹³å°çš„è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ç³ç…æ»¡ç›®,ä½†å…¶ä¸­æ¯”è¾ƒæˆç†Ÿçš„å¼€å‘æ•ˆç‡ä¸ä½çš„,ç½‘ä¸Šæ•™ç¨‹å¤šçš„åˆæˆäº†å‡¤æ¯›éºŸè§’.è®©æˆ‘è¯´çš„è¯,æœ‰Flutter,.Net MAUIä»¥åŠQtç­‰ç­‰</p><p>Flutterå°±ä¸å¤šæäº†,æˆ‘æ˜¯æœ€æ¨èè¿™ä¸ªçš„.</p><p>.Netç›¸å…³é¡¹ç›®åœ¨å¾®è½¯æ“æŒä¸‹,ç”Ÿä¸å¦‚æ­».æœ€æˆç†Ÿçš„æ˜¯WPFæœ¬èº«ä¸æ”¯æŒè·¨å¹³å°,æ­¤å¤–çš„Avalonia,Unoç­‰è·¨å¹³å°å¹¶ä¸æ˜¯å¾®è½¯é¦–æ¨. å¾®è½¯ç›®å‰é¦–æ¨MAUIä¸Blazor,åè€…æ˜¯Webæ¡†æ¶,æ­¤å¤–è¿˜æœ‰UWPçš„ç»§ä»»è€…WinUI3ç›®å‰ä¹Ÿä¸æˆç†Ÿ(å…¶ç›®çš„åº”è¯¥æ˜¯å æ®WPFçš„éƒ¨åˆ†å¸‚åœº).<a href="https://www.cnblogs.com/duwenlong/p/17462010.html">èŠèŠMAUIã€WinUI3å’ŒWPFçš„ä¼˜åŠ¿åŠåŠ£åŠ¿ - æœæ–‡é¾™ - åšå®¢å›­ (cnblogs.com)</a></p><p><img data-src="https://s2.loli.net/2024/03/25/6WmE12y9JhZRXaO.png" alt="image-20240325123001580"></p><p><img data-src="https://github.com/robloo/PublicDocs/raw/master/XAMLFrameworkEvolution.png?raw=true" alt="img"></p><p>æ­¤å¤–è¿˜æœ‰ç§»åŠ¨ç«¯è·¨å¹³å°çš„React Native,Jetpack Compose(Compose Multiplatform)ç­‰ç­‰,æ¡Œé¢åº”ç”¨è¿˜æœ‰Electron,Tauri(ç›®å‰ä¹Ÿèƒ½åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨)ç­‰,å›½å†…ç”Ÿæ€ä¸‹è¿˜æœ‰å¾®ä¿¡å°ç¨‹åº,Uniapp,Taroç­‰.</p><p><img data-src="https://s2.loli.net/2024/03/25/V3DjN1wpYhmUSZF.png" alt="image-20240325123020037"></p><blockquote><p><a href="https://developer.android.google.cn/jetpack/compose?hl=zh-cn">Jetpack Compose</a> æ˜¯ä¸€æ¬¾æ–°å‹å·¥å…·åŒ…ï¼Œæ—¨åœ¨å¸®åŠ©ç®€åŒ–ç•Œé¢å¼€å‘ã€‚è¯¥å·¥å…·åŒ…å°†å“åº”å¼ç¼–ç¨‹æ¨¡å‹ä¸ç®€æ´æ˜“ç”¨çš„ Kotlin ç¼–ç¨‹è¯­è¨€ç›¸ç»“åˆï¼Œå¹¶é‡‡ç”¨å®Œå…¨å£°æ˜å¼çš„ä»£ç ç¼–å†™æ–¹å¼ï¼Œè®©æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°æ¥æè¿°ç•Œé¢ï¼Œè¿™äº›å‡½æ•°ä¼šå°†æ•°æ®è½¬æ¢ä¸ºç•Œé¢å±‚æ¬¡ç»“æ„ã€‚å½“åº•å±‚æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨é‡æ–°æ‰§è¡Œè¿™äº›å‡½æ•°ï¼Œä¸ºæ‚¨æ›´æ–°ç•Œé¢å±‚æ¬¡ç»“æ„ã€‚ç®€å•æ¥è¯´,åŒ…æ‹¬Flutter,è¿™äº›éƒ½æ˜¯ä½¿ç”¨ä»£ç å£°æ˜UIçš„,è€Œ.Netä¸‹è®¸å¤šUIæ¡†æ¶ä½¿ç”¨xaml,è¿™ä¸ä¹‹å‰çš„å®‰å“å¼€å‘ç±»ä¼¼.</p></blockquote><p>ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤š,åšæŠ€æœ¯é€‰å‹æ¥ä¸ªæ€»ç»“çš„è¯,å½“ç„¶é¦–å…ˆéœ€è¦é¡¾åŠå›¢é˜Ÿäººå‘˜,æœ€å¥½ç»“åˆå·¥æœŸå’Œå›¢é˜ŸæŠ€æœ¯æ ˆé€‰æ‹©.å¦‚æœæ˜¯ä¸ªäººå¼€å‘è€…,ç”±äºç›®å‰Flutterå¯¹webå’Œæ¡Œé¢æ”¯æŒè¿˜æ˜¯ä¸å¤ªæˆç†Ÿ,æˆ‘ä¸ªäººå…¶å®æƒ³æ¨è.Netçš„æŠ€æœ¯,æˆ–è€…ä½ ä¹Ÿå¯ä»¥è€ƒè™‘Electronåšæ¡Œé¢(å¼ºè°ƒè½¯ä»¶æ€§èƒ½æˆ–è€…å®¹é”™æ€§è€ƒè™‘WPF,Qtç­‰),ç§»åŠ¨ç«¯ç”¨Flutteræˆ–React Native(Composeç›®å‰è·¨å¹³å°ä¹Ÿä¸å¤ªæˆç†Ÿ,å¦‚æœåªè€ƒè™‘å®‰å“å¯ä»¥è¯•è¯•)</p><p>è€Œä»Šå¤©è¦è°ˆåˆ°çš„Qt,åœ¨å·¥ä¸šé¢†åŸŸç”¨å¾—å¤š,æ„Ÿè§‰è¿˜æ˜¯å› ä¸ºå†å²æ²‰æ·€.è¿™å‡ å¤©çœ‹äº†Qtå®˜ç½‘,å…¶æ¨å‡ºäº†Design Studioè½¯ä»¶,Qt Creatorè²Œä¼¼ä¹Ÿæ”¯æŒäº†AIè¾…åŠ©ç¼–ç ,è¯´æ˜è¿˜æ˜¯è·Ÿä¸Šäº†æ½®æµ,è€ŒQt6çš„ä¼˜åŠ¿å°±æ˜¯è·ŸQt quickæ›´å¥½ç»“åˆäº†.ç›®å‰ä¸‹è½½Qtä¹Ÿä¸åƒä¹‹å‰é‚£ä¹ˆéº»çƒ¦,ç°åœ¨ç”¨ä¸€ä¸ªunified-downloaderè”ç½‘ä¸‹è½½ä»¥åŠåç»­æ›´æ–°å°±è¡Œäº†.</p><h2 id="æ–°çš„Qt"><a href="#æ–°çš„Qt" class="headerlink" title="æ–°çš„Qt"></a>æ–°çš„Qt</h2><p>Qtä¸»è¦è¿˜æ˜¯åœ¨æ¡Œé¢ã€åµŒå…¥å¼å¤š,ä½†å…¶å®ç§»åŠ¨ç«¯ä¹Ÿå¯ä»¥,ç›¸ä¿¡å…¶è·¨å¹³å°èƒ½åŠ›.Qt6ä¸Qt5åŸºæœ¬å¯ä»¥æ— ç¼è½¬æ¢.</p><blockquote><p>Qt 6 is highly compatible with <a href="https://doc.qt.io/qt-5.15/">Qt 5</a>. Developers of Qt 5 applications can move seamlessly to Qt 6 while retaining the applicationsâ€™ functionality.</p></blockquote><p><img data-src="https://s2.loli.net/2024/03/25/b8UsBofHexM9gZ6.png" alt="image-20240325132130083"></p><p>Qtç›®å‰æä¾›äº†è®¾è®¡,å¼€å‘,æµ‹è¯•å’Œä¼˜åŒ–çš„å·¥å…·,ä¸»è¦ä½¿ç”¨å‰ä¸¤è€…å³å¯.</p><h3 id="å¯¹äºUIè®¾è®¡"><a href="#å¯¹äºUIè®¾è®¡" class="headerlink" title="å¯¹äºUIè®¾è®¡"></a>å¯¹äºUIè®¾è®¡</h3><p><img data-src="https://doc.qt.io/qtcreator/images/qtcreator-project-qt-quick.webp" alt="{New Project dialog}"></p><p>å¦‚æœæƒ³è¦åœ¨ç§»åŠ¨ç«¯æˆ–è€…éœ€è¦ä¸æ»‘çš„åŠ¨ç”»,é‚£å°±ç”¨Qt Quick.å¯ä»¥ä½¿ç”¨Qt Design Studioè¾…åŠ©è®¾è®¡.</p><p><img data-src="https://s2.loli.net/2024/03/25/9nFhjdfoMGsXUyV.png" alt="image-20240325143557948"></p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QtQuick</span><br><span class="line"><span class="title">Rectangle</span> &#123;</span><br><span class="line">    <span class="attribute">id:</span><span class="string"> page</span></span><br><span class="line">    <span class="attribute">anchors.fill</span>: <span class="built_in">parent</span></span><br><span class="line">    <span class="attribute">color</span>: <span class="string">&quot;#ffffff&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨qmlæè¿°ç•Œé¢</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ListModel</span> &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> todayTasksListModel</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">ListModel</span> &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> thisWeekTasksListModel</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">ListModel</span> &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> laterTasksListModel</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">Column</span> &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> column</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">anchors.fill</span>: <span class="built_in">parent</span></span><br><span class="line">        <span class="attribute">spacing</span>: <span class="number">14</span></span><br><span class="line"></span><br><span class="line">        <span class="title">TasksList</span> &#123;</span><br><span class="line">            <span class="attribute">id:</span><span class="string"> todayTasks</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">width</span>: column.width</span><br><span class="line">            <span class="attribute">maxHeight</span>: <span class="number">180</span></span><br><span class="line">            <span class="attribute">listModel</span>: todayTasksListModel</span><br><span class="line">            <span class="attribute">headerText</span>: qsTr(<span class="string">&quot;Today&quot;</span>)</span><br><span class="line">            <span class="attribute">tasksCount</span>: todayTasksListModel.count</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title">TasksList</span> &#123;</span><br><span class="line">            <span class="attribute">id:</span><span class="string"> thisWeekTasks</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">width</span>: column.width</span><br><span class="line">            <span class="attribute">maxHeight</span>: column.height - y - <span class="number">60</span></span><br><span class="line">            <span class="attribute">listModel</span>: thisWeekTasksListModel</span><br><span class="line">            <span class="attribute">headerText</span>: qsTr(<span class="string">&quot;This week&quot;</span>)</span><br><span class="line">            <span class="attribute">tasksCount</span>: thisWeekTasksListModel.count</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title">TasksList</span> &#123;</span><br><span class="line">            <span class="attribute">id:</span><span class="string"> laterTasks</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">width</span>: column.width</span><br><span class="line">            <span class="attribute">maxHeight</span>: column.height - y</span><br><span class="line">            <span class="attribute">listModel</span>: laterTasksListModel</span><br><span class="line">            <span class="attribute">headerText</span>: qsTr(<span class="string">&quot;Later&quot;</span>)</span><br><span class="line">            <span class="attribute">tasksCount</span>: laterTasksListModel.count</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘åœ¨ä½¿ç”¨çš„æ—¶å€™æ„Ÿè§‰å¾ˆåƒå®‰å“çš„composeæˆ–è€…WPFçš„xamlå¼€å‘,ä¹Ÿæ˜¯å£°æ˜å¼,Flutterä¹Ÿæ˜¯å£°æ˜å¼,è¿™å¯èƒ½å°±æ˜¯è¶‹åŠ¿å§.ç±»ä¼¼jsé€šè¿‡findelementByIdå†åˆ°React,Vueçš„å£°æ˜å¼UI.</p><h3 id="ä½¿ç”¨QtWidget"><a href="#ä½¿ç”¨QtWidget" class="headerlink" title="ä½¿ç”¨QtWidget"></a>ä½¿ç”¨QtWidget</h3><p><img data-src="https://doc.qt.io/qt-6/images/notepad2.png" alt="&quot;Qt Creator New Project dialog&quot;"></p><p><img data-src="https://doc.qt.io/qt-6/images/qtdesigner.png" alt="&quot;Qt Designer opened from Qt Creator&quot;"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;notepad.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    Notepad w;</span><br><span class="line">    w.<span class="built_in">show</span>();</span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨QtWidgetæ˜¯ä¼ ç»Ÿå¼€å‘æ–¹å¼,è¿™é‡Œå°±ä¸èµ˜è¿°äº†.</p><p>ç›®å‰æˆ‘åœ¨Qtå®˜ç½‘ä»¥åŠå¼€å‘å·¥å…·ä¸Šæ‰¾åˆ°äº†ä¸€å †tutorial,å¯æƒœç›®å‰æ²¡å¤šå°‘æ—¶é—´å­¦ä¹ ,å¯ä»¥é¢„è§çš„æ˜¯,è™½ç„¶Qtåœ¨äº’è”ç½‘ä»¥åŠå¼€æºè½¯ä»¶é¢†åŸŸåŸºæœ¬æ²¡ä»€ä¹ˆå¸‚åœºå æœ‰ç‡(ç›®å‰è¢«WebæŠ€æœ¯å ç€,è¦ä¹ˆå°±æ˜¯Flutteræˆ–è€….Net),ä½†æ˜¯åœ¨ä½¿ç”¨c++æ¯”è¾ƒå¤šçš„å·¥ä¸šé¢†åŸŸæˆ–æ˜¯ä½¿ç”¨Pythonè¿›è¡ŒQtå¼€å‘åº”è¯¥æ˜¯ä¸€ä¸ªæŠ€æœ¯ä¸Šä¸é”™çš„é€‰æ‹©äº†.æ¯”å¦‚ä¸‹é¢ä»£ç å°±æ˜¯ç”¨pythonæ‰§è¡Œqml.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PySide6.QtGui <span class="keyword">import</span> QGuiApplication</span><br><span class="line"><span class="keyword">from</span> PySide6.QtQml <span class="keyword">import</span> QQmlApplicationEngine</span><br><span class="line">QML = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">import QtQuick</span></span><br><span class="line"><span class="string">import QtQuick.Controls</span></span><br><span class="line"><span class="string">import QtQuick.Layouts</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Window &#123;</span></span><br><span class="line"><span class="string">    width: 300</span></span><br><span class="line"><span class="string">    height: 200</span></span><br><span class="line"><span class="string">    visible: true</span></span><br><span class="line"><span class="string">    title: &quot;Hello World&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    readonly property list&lt;string&gt; texts: [&quot;Hallo Welt&quot;, &quot;Hei maailma&quot;,</span></span><br><span class="line"><span class="string">                                           &quot;Hola Mundo&quot;, &quot;ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    function setText() &#123;</span></span><br><span class="line"><span class="string">        var i = Math.round(Math.random() * 3)</span></span><br><span class="line"><span class="string">        text.text = texts[i]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ColumnLayout &#123;</span></span><br><span class="line"><span class="string">        anchors.fill:  parent</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Text &#123;</span></span><br><span class="line"><span class="string">            id: text</span></span><br><span class="line"><span class="string">            text: &quot;Hello World&quot;</span></span><br><span class="line"><span class="string">            Layout.alignment: Qt.AlignHCenter</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        Button &#123;</span></span><br><span class="line"><span class="string">            text: &quot;Click me&quot;</span></span><br><span class="line"><span class="string">            Layout.alignment: Qt.AlignHCenter</span></span><br><span class="line"><span class="string">            onClicked:  setText()</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QGuiApplication(sys.argv)</span><br><span class="line">    engine = QQmlApplicationEngine()</span><br><span class="line">    engine.loadData(QML.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> engine.rootObjects():</span><br><span class="line">        sys.exit(-<span class="number">1</span>)</span><br><span class="line">    exit_code = app.<span class="built_in">exec</span>()</span><br><span class="line">    <span class="keyword">del</span> engine</span><br><span class="line">    sys.exit(exit_code)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯å¸¸è§çš„ç”¨pythonå†™qtwidget</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PySide6 <span class="keyword">import</span> QtCore, QtWidgets, QtGui</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWidget</span>(<span class="params">QtWidgets.QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.hello = [<span class="string">&quot;Hallo Welt&quot;</span>, <span class="string">&quot;Hei maailma&quot;</span>, <span class="string">&quot;Hola Mundo&quot;</span>, <span class="string">&quot;ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€&quot;</span>]</span><br><span class="line"></span><br><span class="line">        self.button = QtWidgets.QPushButton(<span class="string">&quot;Click me!&quot;</span>)</span><br><span class="line">        self.text = QtWidgets.QLabel(<span class="string">&quot;Hello World&quot;</span>,</span><br><span class="line">                                     alignment=QtCore.Qt.AlignCenter)</span><br><span class="line"></span><br><span class="line">        self.layout = QtWidgets.QVBoxLayout(self)</span><br><span class="line">        self.layout.addWidget(self.text)</span><br><span class="line">        self.layout.addWidget(self.button)</span><br><span class="line"></span><br><span class="line">        self.button.clicked.connect(self.magic)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @QtCore.Slot()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">magic</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.text.setText(random.choice(self.hello))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QtWidgets.QApplication([])</span><br><span class="line"></span><br><span class="line">    widget = MyWidget()</span><br><span class="line">    widget.resize(<span class="number">800</span>, <span class="number">600</span>)</span><br><span class="line">    widget.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.<span class="built_in">exec</span>())</span><br></pre></td></tr></table></figure><p>ç›®å‰QtWidgetä¸Qt quickæ²¡æœ‰ç»å¯¹ä¼˜åŠ£,å®˜ç½‘ä¹Ÿæ˜¯æ¨èåœ¨ä½¿ç”¨åŠ¨ç”»å’Œç§»åŠ¨ç«¯è§¦æ‘¸æ—¶ä½¿ç”¨qml,äº‹å®ä¸Šè¿™ä¸¤è€…ä¹Ÿå¯ä»¥ç»“åˆä½¿ç”¨. è€Œå®‰å“æ–¹é¢Composeå·²ç»æˆäº†è¶‹åŠ¿,ä½†ä¼ ç»Ÿxmlå¼€å‘ä¹Ÿéœ€è¦æŒæ¡ç”¨æ¥ç»´æŠ¤æ—§é¡¹ç›®ä»¥åŠæ–°é¡¹ç›®ç¼ºå°‘çš„ç»„ä»¶.</p><p>å…¶ä»–æŠ€æœ¯å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« æ€»ç»“å¾—ä¸é”™<a href="https://zhuanlan.zhihu.com/p/547806659">æ¡Œé¢è½¯ä»¶å¼€å‘æ¡†æ¶å¤§èµ - çŸ¥ä¹ (zhihu.com)</a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç›®å‰c/sæ¶æ„çš„åº”ç”¨å¼€å‘å·²ç»æœ‰äº†è¶³å¤Ÿå¤šçš„é€‰æ‹©,å…¶ä¸­è·¨å¹³å°çš„å¼€å‘ä¹Ÿéå¸¸å¤š.æ¯”å¦‚Dartçš„Flutter,C++çš„Qt,.Netçš„MAUIç­‰ç­‰,ä¸è¿‡å…¶ä¸­å‘ä¸æ˜¯å¤–è¡Œèƒ½ä¸€çœ¼çœ‹é€çš„,å°¤å…¶æ˜¯å¾®è½¯ç›¸å…³çš„UIæŠ€æœ¯æ ˆåˆ†æ”¯å®åœ¨å¤š,è·¨å¹³å°ç›¸å…³èƒ½åŠ›ä¸æ˜(å¾®è½¯è¿™æ–¹é¢çš„æ–‡æ¡£æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹ä¹±),å­¦ä¹ èµ„æ–™ä¸å¤Ÿå……è¶³,è€ŒQtå¹¶ä¸å¼€æº,ä½†æ˜¯æœ€è¿‘æˆ‘çœ‹åˆ°å…¶å®˜ç½‘åˆæ›´æ–°äº†ä¸€æ³¢æŠ€æœ¯,æ„Ÿè§‰å¾ˆäº®çœ¼,å’±ä»¬æ¥çœ‹çœ‹.&lt;br&gt;</summary>
    
    
    
    
    <category term="æŠ€æœ¯æ ˆ" scheme="https://www.sekyoro.top/tags/%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¼€å§‹å†™ä¸€ç¯‡ç°ä»£å…«è‚¡è®ºæ–‡</title>
    <link href="https://www.sekyoro.top/2024/03/16/%E5%A6%82%E4%BD%95%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E7%AF%87%E7%8E%B0%E4%BB%A3%E5%85%AB%E8%82%A1%E8%AE%BA%E6%96%87/"/>
    <id>https://www.sekyoro.top/2024/03/16/%E5%A6%82%E4%BD%95%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E7%AF%87%E7%8E%B0%E4%BB%A3%E5%85%AB%E8%82%A1%E8%AE%BA%E6%96%87/</id>
    <published>2024-03-16T02:28:08.000Z</published>
    <updated>2024-04-02T03:20:46.555Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>é€šè¿‡é˜…è¯»ä¸€ç³»åˆ—æ–‡ç« ,åˆ†ææ‘˜è¦ã€ä»‹ç»æ¯ä¸ªsectionçš„ç»„ç»‡å½¢å¼,æ–¹ä¾¿å†™å‡ºä¸€äº›åˆ—ç°ä»£å…«è‚¡æ–‡.<br><span id="more"></span></p><h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><blockquote><p>å®éªŒéƒ¨åˆ†ä»‹ç»ä½¿ç”¨çš„æ•°æ®é›†,è¯„ä»·æŒ‡æ ‡,å®ç°ç»†èŠ‚,å®šé‡åˆ†æ,å®šæ€§åˆ†æä»¥åŠæ¶ˆèå®éªŒ.</p></blockquote><p>é¦–å…ˆä»‹ç»è®ºæ–‡è¿›è¡Œäº†comprehensiveçš„å®éªŒ,ç„¶ååˆ†åˆ«ä»‹ç»æ•°æ®é›†,éšåä»‹ç»è¯„ä»·æŒ‡æ ‡.</p><h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p>ä»‹ç»ä½¿ç”¨çš„æ¡†æ¶ã€å·¥å…·ä»¥åŠè®­ç»ƒçš„GPUè®¾å¤‡.ç„¶åä»‹ç»è®­ç»ƒæ—¶çš„ç»†èŠ‚,æ¯”å¦‚ä½¿ç”¨çš„optimizerå’Œlr_scheduler,batch_size,epochsç­‰.ç„¶åä»‹ç»è‡ªå·±çš„ç®—æ³•ä¸­çš„å‚æ•°è®¾ç½®,æœ€åä»‹ç»ä¸€äº›ç»†èŠ‚ç­‰</p><h3 id="å®šé‡åˆ†æ"><a href="#å®šé‡åˆ†æ" class="headerlink" title="å®šé‡åˆ†æ"></a>å®šé‡åˆ†æ</h3><p>ä½¿ç”¨ä¸åŒæŒ‡æ ‡è¿›è¡Œå¯¹æ¯”</p><h2 id="Latexå¸¸ç”¨"><a href="#Latexå¸¸ç”¨" class="headerlink" title="Latexå¸¸ç”¨"></a>Latexå¸¸ç”¨</h2><blockquote><p>ä¼—æ‰€å‘¨çŸ¥,ä¸ç”¨latexå†™å‡ºæ¥çš„åªèƒ½æ˜¯æ–‡ç« ,ä¸èƒ½æ˜¯è®ºæ–‡(æš´è¨€).</p></blockquote><p>LATEX ä¸­å•å¼•å· â€˜ å’Œ â€™ åˆ†åˆ«ç”¨ ` å’Œ â€˜ è¾“å…¥ï¼›åŒå¼•å· â€œ å’Œ â€ åˆ†åˆ«ç”¨ `` å’Œ â€˜â€™ è¾“å…¥</p><h3 id="å¯¹æ–‡å­—æ“ä½œ"><a href="#å¯¹æ–‡å­—æ“ä½œ" class="headerlink" title="å¯¹æ–‡å­—æ“ä½œ"></a>å¯¹æ–‡å­—æ“ä½œ</h3><p>æ¯”å¦‚<code>\textbf</code>ç­‰ç­‰èƒ½ä½¿æ–‡å­—æ”¹å˜(åŒ…æ‹¬å…¬å¼),è¿™äº›è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„.</p><p>å¼•å…¥å®åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\usepackage&#123;amsmath&#125;</span><br><span class="line">\usepackage&#123;amssymb&#125;</span><br><span class="line">\usepackage&#123;bm&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ’ç‰ˆæ•°å­¦å…¬å¼,ä¸»è¦ä½¿ç”¨amsmathå®,è€Œamssymbæä¾›è®¸å¤šæ•°å­¦ç¬¦å·</p><p><code>\underline</code> å‘½ä»¤ç”Ÿæˆä¸‹åˆ’çº¿çš„æ ·å¼ä¸å¤Ÿçµæ´»ï¼Œä¸åŒçš„å•è¯å¯èƒ½ç”Ÿæˆé«˜ä½å„å¼‚çš„ä¸‹åˆ’çº¿ï¼Œå¹¶ ä¸”æ— æ³•æ¢è¡Œã€‚<code>ulem</code> å®åŒ…æä¾›äº†æ›´çµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›çš„ <code>\uline</code> å‘½ä»¤èƒ½å¤Ÿè½»æ¾ç”Ÿæˆè‡ªåŠ¨æ¢è¡Œçš„ä¸‹åˆ’çº¿</p><h4 id="è¡Œå†…å’Œè¡Œé—´å…¬å¼"><a href="#è¡Œå†…å’Œè¡Œé—´å…¬å¼" class="headerlink" title="è¡Œå†…å’Œè¡Œé—´å…¬å¼"></a>è¡Œå†…å’Œè¡Œé—´å…¬å¼</h4><blockquote><p>æ•°å­¦å…¬å¼æœ‰ä¸¤ç§æ’ç‰ˆæ–¹å¼ï¼šå…¶ä¸€æ˜¯ä¸æ–‡å­—æ··æ’ï¼Œç§°ä¸ºè¡Œå†…å…¬å¼ï¼›å…¶äºŒæ˜¯å•ç‹¬åˆ—ä¸ºä¸€è¡Œæ’ç‰ˆï¼Œ ç§°ä¸ºè¡Œé—´å…¬å¼ã€‚</p></blockquote><p>ç®€å•æ¥è¯´è¡Œå†…å…¬å¼ä½¿ç”¨$$$$,è¡Œé—´å…¬å¼ä½¿ç”¨<code>\equation</code>.</p><p>equation ç¯å¢ƒä¸ºå…¬å¼è‡ªåŠ¨ç”Ÿæˆä¸€ ä¸ªç¼–å·ï¼Œ<strong>è¿™ä¸ªç¼–å·å¯ä»¥ç”¨ \label å’Œ \ref ç”Ÿæˆäº¤å‰å¼•ç”¨ï¼Œamsmath çš„ \eqref å‘½ä»¤ç”šè‡³ä¸ºå¼•ç”¨ è‡ªåŠ¨åŠ ä¸Šåœ†æ‹¬å·</strong>ï¼›è¿˜å¯ä»¥ç”¨ \tag å‘½ä»¤æ‰‹åŠ¨ä¿®æ”¹å…¬å¼çš„ç¼–å·ï¼Œæˆ–è€…ç”¨ \notag å‘½ä»¤å–æ¶ˆä¸ºå…¬å¼ç¼– å·</p><p>å¦‚æœéœ€è¦<strong>ç›´æ¥ä½¿ç”¨ä¸å¸¦ç¼–å·çš„è¡Œé—´å…¬å¼</strong>ï¼Œåˆ™å°†å…¬å¼ç”¨å‘½ä»¤ [ å’Œ ] åŒ…è£¹ï¼Œä¸ä¹‹ç­‰æ•ˆçš„æ˜¯ displaymath ç¯å¢ƒã€‚æœ‰çš„äººæ›´å–œæ¬¢ equation* ç¯å¢ƒï¼Œä½“ç°äº†å¸¦æ˜Ÿå·å’Œä¸å¸¦æ˜Ÿå·çš„ç¯å¢ƒä¹‹é—´çš„åŒº åˆ«ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;equation*&#125;</span><br><span class="line">a^2 + b^2 = c^2</span><br><span class="line">\end&#123;equation*&#125;</span><br><span class="line">For short:</span><br><span class="line">\[ a^2 + b^2 = c^2 \]</span><br><span class="line">Or if you like the long one:</span><br><span class="line">\begin&#123;displaymath&#125;</span><br><span class="line">a^2 + b^2 = c^2</span><br><span class="line">\end&#123;displaymath&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å½“ç”¨æˆ·ä½¿ç”¨ $ å¼€å¯è¡Œå†…å…¬å¼è¾“å…¥ï¼Œæˆ–æ˜¯ä½¿ç”¨ [ å‘½ä»¤ã€equation ç¯å¢ƒæ—¶ï¼ŒLATEX å°±è¿›å…¥äº† æ•°å­¦æ¨¡å¼ã€‚</p></blockquote><ul><li>æ•°å­¦æ¨¡å¼ä¸­è¾“å…¥çš„ç©ºæ ¼è¢«å¿½ç•¥ã€‚æ•°å­¦ç¬¦å·çš„é—´è·é»˜è®¤ç”±ç¬¦å·çš„æ€§è´¨ï¼ˆå…³ç³»ç¬¦å·ã€è¿ç®—ç¬¦ç­‰ï¼‰ å†³å®šã€‚éœ€è¦äººä¸ºå¼•å…¥é—´è·æ—¶ï¼Œä½¿ç”¨ \quad å’Œ \qquad ç­‰å‘½ä»¤</li><li><p>ä¸å…è®¸æœ‰ç©ºè¡Œï¼ˆåˆ†æ®µï¼‰ã€‚è¡Œé—´å…¬å¼ä¸­ä¹Ÿæ— æ³•ç”¨ \ å‘½ä»¤æ‰‹åŠ¨æ¢è¡Œï¼Œæ’ç‰ˆå¤šè¡Œå…¬å¼éœ€è¦ä½¿ç”¨å…¶ä»–ç¯å¢ƒ</p></li><li><p>æ‰€æœ‰çš„å­—æ¯è¢«å½“ä½œæ•°å­¦å…¬å¼ä¸­çš„å˜é‡å¤„ç†ï¼Œå­—æ¯é—´è·ä¸æ–‡æœ¬æ¨¡å¼ä¸ä¸€è‡´ï¼Œä¹Ÿæ— æ³•ç”Ÿæˆå•è¯ ä¹‹é—´çš„ç©ºæ ¼ã€‚æƒ³åœ¨æ•°å­¦å…¬å¼ä¸­è¾“å…¥æ­£ä½“çš„æ–‡æœ¬ï¼Œç®€å•æƒ…å†µä¸‹å¯ç”¨  \mathrm å‘½ä»¤ã€‚æˆ–è€…ç”¨ amsmath æä¾›çš„ \text å‘½ä»¤</p></li></ul><h5 id="ä¸€èˆ¬ç¬¦å·"><a href="#ä¸€èˆ¬ç¬¦å·" class="headerlink" title="ä¸€èˆ¬ç¬¦å·"></a>ä¸€èˆ¬ç¬¦å·</h5><p>å¸Œè…Šå­—æ¯ç¬¦å·çš„åç§°å°±æ˜¯å…¶è‹±æ–‡åç§°ï¼Œå¦‚ Î± (\alpha)ã€Î² (\beta) ç­‰ç­‰ã€‚å¤§å†™çš„å¸Œè…Šå­—æ¯ä¸º é¦–å­—æ¯å¤§å†™çš„å‘½ä»¤ï¼Œå¦‚ Î“ (\Gamma)ã€âˆ† (\Delta) ç­‰ç­‰ã€‚æ— ç©·å¤§ç¬¦å·ä¸º âˆ (\infty)ã€‚</p><h5 id="hyperref"><a href="#hyperref" class="headerlink" title="hyperref"></a>hyperref</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;hyperref&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">    Please visit my \href&#123;https://www.example.com&#125;&#123;website&#125;.</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\usepackage&#123;hyperref&#125;</span><br><span class="line">\hypersetup&#123;</span><br><span class="line">colorlinks=true,</span><br><span class="line">linkcolor=cyan,</span><br><span class="line">filecolor=blue,      </span><br><span class="line">urlcolor=red,</span><br><span class="line">citecolor=green,</span><br><span class="line">pagebackref=true,</span><br><span class="line">    breaklinks=true,</span><br><span class="line">    letterpaper=true,</span><br><span class="line">    </span><br><span class="line">    bookmarks=false,</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>colorlinkså°±æ˜¯è¯´è¶…é“¾æ¥æ˜¯å¦å¸¦é¢œè‰²ï¼›<br>linkcolorå°±æ˜¯ç›®å½•ï¼Œå…¬å¼ï¼Œå›¾è¡¨ç­‰å†…éƒ¨é“¾æ¥çš„é¢œè‰²ï¼›<br>filecolorå°±æ˜¯æ–‡ä»¶å‹é“¾æ¥çš„é¢œè‰²ï¼›<br>urlcolorå°±æ˜¯ç½‘é¡µé“¾æ¥çš„é¢œè‰²ï¼›<br>citecolorå°±æ˜¯å‚è€ƒæ–‡çŒ®è¿æ¥çš„é¢œè‰²</p><p>pagebackref=true<code>ï¼šåœ¨å‚è€ƒæ–‡çŒ®ä¸­æ·»åŠ è¿”å›é¡µç çš„é“¾æ¥ã€‚</code>breaklinks=true`ï¼šå…è®¸é“¾æ¥è·¨è¡Œæ–­å¼€ã€‚</p><p>letterpaper=trueï¼šå°†é¡µé¢å¤§å°è®¾ç½®ä¸ºLetterçº¸å¼ å°ºå¯¸ã€‚</p><p>bookmarks=falseï¼šç¦ç”¨ä¹¦ç­¾ç”Ÿæˆã€‚</p></blockquote><p>amssymb å®åŒ…æä¾›äº†ä¸€äº›æ¬¡å¸¸ç”¨çš„ç¬¦å·ã€‚</p><h5 id="xcolor"><a href="#xcolor" class="headerlink" title="xcolor"></a>xcolor</h5><p>æ–‡æœ¬è®¾ç½®é¢œè‰²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;xcolor&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">    \textcolor&#123;red&#125;&#123;è¿™æ˜¯çº¢è‰²çš„æ–‡æœ¬ã€‚&#125;</span><br><span class="line"></span><br><span class="line">    \colorbox&#123;blue!30&#125;&#123;è¿™æ˜¯ä¸€ä¸ªè“è‰²èƒŒæ™¯çš„ç›’å­ã€‚&#125;</span><br><span class="line"></span><br><span class="line">    \definecolor&#123;mygreen&#125;&#123;rgb&#125;&#123;0,0.5,0&#125;</span><br><span class="line">    \textcolor&#123;mygreen&#125;&#123;è¿™æ˜¯è‡ªå®šä¹‰çš„ç»¿è‰²æ–‡æœ¬ã€‚&#125;</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><h5 id="soul"><a href="#soul" class="headerlink" title="soul"></a>soul</h5><p>ä¸‹åˆ’çº¿å’Œåˆ é™¤çº¿ç­‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\st&#123;This text has a strikethrough.&#125;</span><br><span class="line">\hl&#123;\ul&#123;Highlighted and underlined text.&#125;&#125;</span><br><span class="line">\st&#123;\ul&#123;Strikethrough and underlined text.&#125;&#125;</span><br></pre></td></tr></table></figure><h5 id="times"><a href="#times" class="headerlink" title="times"></a>times</h5><p>timeså®åŒ…ç”¨äºå°†æ–‡æ¡£çš„å­—ä½“è®¾ç½®ä¸ºTimeså­—ä½“ã€‚ä½¿ç”¨\usepackage{times}å‘½ä»¤å¯¼å…¥è¯¥å®åŒ…å³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;times&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">This is some text in Times font.</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><h5 id="epsfigå®åŒ…"><a href="#epsfigå®åŒ…" class="headerlink" title="epsfigå®åŒ…"></a>epsfigå®åŒ…</h5><p><code>epsfig</code>å®åŒ…ç”¨äºåœ¨LaTeXæ–‡æ¡£ä¸­æ’å…¥EPSæ ¼å¼çš„å›¾åƒæ–‡ä»¶ã€‚ä½¿ç”¨<code>\usepackage&#123;epsfig&#125;</code>å‘½ä»¤å¯¼å…¥è¯¥å®åŒ…å³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;epsfig&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">\begin&#123;figure&#125;</span><br><span class="line">    \centering</span><br><span class="line">    \epsfig&#123;file=example.eps, width=0.5\textwidth&#125;</span><br><span class="line">    \caption&#123;An example EPS figure.&#125;</span><br><span class="line">\end&#123;figure&#125;</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><h5 id="graphicx"><a href="#graphicx" class="headerlink" title="graphicx"></a>graphicx</h5><p><code>graphicx</code>å®åŒ…æ˜¯LaTeXä¸­æœ€å¸¸ç”¨çš„å›¾å½¢å¤„ç†å®åŒ…ä¹‹ä¸€ï¼Œç”¨äºæ’å…¥å’Œæ“ä½œå„ç§å›¾åƒæ–‡ä»¶æ ¼å¼ã€‚ä½¿ç”¨<code>\usepackage&#123;graphicx&#125;</code>å‘½ä»¤å¯¼å…¥è¯¥å®åŒ…å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;graphicx&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">\begin&#123;figure&#125;</span><br><span class="line">    \centering</span><br><span class="line">    \includegraphics[width=0.5\textwidth]&#123;example.png&#125;</span><br><span class="line">    \caption&#123;An example PNG image.&#125;</span><br><span class="line">\end&#123;figure&#125;</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\graphicspath&#123;&#123;resource/&#125;&#125;     % organize your images and other figures under resource/ folder</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="bbding"><a href="#bbding" class="headerlink" title="bbding"></a>bbding</h5><p><code>bbding</code>å®åŒ…æä¾›äº†ä¸€ç³»åˆ—ç‰¹æ®Šç¬¦å·å’Œå›¾æ ‡ï¼Œå¦‚æ‰‹åŠ¿ã€ç®­å¤´ã€å‹¾å·ã€å‰å·ç­‰ã€‚ä½¿ç”¨<code>\usepackage&#123;bbding&#125;</code>å‘½ä»¤å¯¼å…¥è¯¥å®åŒ…å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;bbding&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">\Checkmark \quad \XSolidBrush \quad \HandRight</span><br><span class="line">\end&#123;document&#125;</span><br><span class="line"># æ‰“å‹¾å‰</span><br><span class="line">\Checkmark</span><br><span class="line">\CheckmarkBold</span><br><span class="line">\XSolid</span><br><span class="line">\XSolidBold</span><br><span class="line">\XSolidBrush</span><br></pre></td></tr></table></figure><h5 id="subcaption"><a href="#subcaption" class="headerlink" title="subcaption"></a>subcaption</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;graphicx&#125;</span><br><span class="line">\usepackage&#123;subcaption&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">\begin&#123;figure&#125;</span><br><span class="line">    \centering</span><br><span class="line">    \begin&#123;subfigure&#125;&#123;0.3\textwidth&#125;</span><br><span class="line">        \includegraphics[width=\linewidth]&#123;image1.png&#125;</span><br><span class="line">        \caption&#123;Subfigure 1&#125;</span><br><span class="line">    \end&#123;subfigure&#125;</span><br><span class="line">    \quad</span><br><span class="line">    \begin&#123;subfigure&#125;&#123;0.3\textwidth&#125;</span><br><span class="line">        \includegraphics[width=\linewidth]&#123;image2.png&#125;</span><br><span class="line">        \caption&#123;Subfigure 2&#125;</span><br><span class="line">    \end&#123;subfigure&#125;</span><br><span class="line">    \caption&#123;Example with subfigures.&#125;</span><br><span class="line">\end&#123;figure&#125;</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">As shown in Figure \ref&#123;fig:example&#125;, subfigure \subref&#123;subfig:1&#125; is interesting.</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>\subref</code>å¼•ç”¨å­å›¾</p><h5 id="nicefrac"><a href="#nicefrac" class="headerlink" title="\nicefrac"></a>\nicefrac</h5><p><code>\nicefrac</code>å‘½ä»¤æ˜¯ç”±<code>nicefrac</code>å®åŒ…æä¾›çš„ã€‚å®ƒç”¨äºç”Ÿæˆæ›´ç´§å‡‘çš„åˆ†æ•°ç¬¦å·ï¼Œæ¯”å¦‚1/2ã€3/4ç­‰ã€‚é€šå¸¸åœ¨æ–‡æœ¬æ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œå¯ä»¥å°†å…¶ç”¨äºæ­£æ–‡ã€æ ‡æ³¨æˆ–å…¶ä»–åœ°æ–¹éœ€è¦ä½¿ç”¨åˆ†æ•°çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\documentclass&#123;article&#125;</span><br><span class="line">\usepackage&#123;nicefrac&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;document&#125;</span><br><span class="line">    The result is \nicefrac&#123;1&#125;&#123;2&#125;.</span><br><span class="line">\end&#123;document&#125;</span><br></pre></td></tr></table></figure><h5 id="microtype"><a href="#microtype" class="headerlink" title="microtype"></a>microtype</h5><p><code>microtype</code>å®åŒ…æä¾›äº†å¾®è°ƒå­—è·å’Œå­—å½¢çš„åŠŸèƒ½ï¼Œä»¥æ”¹å–„æ–‡æœ¬çš„æ’ç‰ˆæ•ˆæœã€‚å®ƒå¯ä»¥è‡ªåŠ¨è°ƒæ•´å­—ç¬¦ä¹‹é—´çš„é—´è·ã€å­—å·å’Œå­—å½¢ï¼Œä»¥æé«˜è§†è§‰æ•ˆæœå’Œå¯è¯»æ€§ã€‚è¦ä½¿ç”¨<code>microtype</code>å®åŒ…ï¼Œåªéœ€åœ¨å¯¼è¨€åŒºä½¿ç”¨<code>\usepackage&#123;microtype&#125;</code>å‘½ä»¤å¯¼å…¥å³å¯ã€‚</p><h5 id="fancyhdr"><a href="#fancyhdr" class="headerlink" title="fancyhdr"></a>fancyhdr</h5><p><code>fancyhdr</code>å®åŒ…ç”¨äºè‡ªå®šä¹‰é¡µçœ‰å’Œé¡µè„šçš„æ ·å¼ã€‚å®ƒå…è®¸åœ¨é¡µé¢çš„é¡¶éƒ¨å’Œåº•éƒ¨æ·»åŠ è‡ªå®šä¹‰å†…å®¹ï¼Œå¦‚æ–‡æ¡£æ ‡é¢˜ã€ç« èŠ‚æ ‡é¢˜ã€é¡µç ç­‰ã€‚é€šè¿‡ä½¿ç”¨<code>fancyhdr</code>å®åŒ…ï¼Œæ‚¨å¯ä»¥çµæ´»åœ°æ§åˆ¶å’Œè®¾è®¡é¡µé¢çš„é¡µçœ‰å’Œé¡µè„šã€‚è¦ä½¿ç”¨<code>fancyhdr</code>å®åŒ…ï¼Œåªéœ€åœ¨å¯¼è¨€åŒºä½¿ç”¨<code>\usepackage&#123;fancyhdr&#125;</code>å‘½ä»¤å¯¼å…¥å³å¯ã€‚</p><h3 id="ç”»è¡¨æ ¼"><a href="#ç”»è¡¨æ ¼" class="headerlink" title="ç”»è¡¨æ ¼"></a>ç”»è¡¨æ ¼</h3><p>ä¸‰çº¿è¡¨åœ¨è®ºæ–‡é‡Œé¢åŸºæœ¬æ˜¯å¿…é¡»çš„.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;tabular&#125;[âŸ¨alignâŸ©]&#123;âŸ¨column-specâŸ©&#125;</span><br><span class="line">âŸ¨item1âŸ© &amp; âŸ¨item2âŸ© &amp; â€¦ \\</span><br><span class="line">\hline</span><br><span class="line">âŸ¨item1âŸ© &amp; âŸ¨item2âŸ© &amp; â€¦ \\</span><br><span class="line">\end&#123;tabular&#125;</span><br></pre></td></tr></table></figure><p>è¡¨æ ¼æœ‰ä¸ªåˆ—æ ¼å¼,åŒ…æ‹¬l,c,r,pä»¥åŠ|å’Œ@{}.æ¯è¡Œçš„æ•°ç›®ä¸èƒ½å¤šäºåˆ—æ ¼å¼ä¸ªæ•°.è¿˜æœ‰ç®€å•æ³•\</p><p>*{n}{<column-spec\>}.å¦å¤–<code>\hline</code>å¯ä»¥ç”¨äºç»˜åˆ¶æ¨ªçº¿,ä½†ç°åœ¨å¤šç”¨<code>\cline</code>æ›¿ä»£å¯ä»¥ç»˜åˆ¶è·¨è¶Šéƒ¨åˆ†å•å…ƒæ ¼çš„æ¨ªçº¿.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;tabular&#125;&#123;|c|c|c|&#125;</span><br><span class="line">\hline</span><br><span class="line">4 &amp; 9 &amp; 2 \\ \cline&#123;2-3&#125;</span><br><span class="line">3 &amp; 5 &amp; 7 \\ \cline&#123;1-1&#125;</span><br><span class="line">8 &amp; 1 &amp; 6 \\ \hline</span><br><span class="line">\end&#123;tabular&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç§‘æŠ€è®ºæ–‡æ’ç‰ˆä¸­å¹¿æ³›åº”ç”¨çš„è¡¨æ ¼å½¢å¼æ˜¯ä¸‰çº¿è¡¨ï¼Œå½¢å¼å¹²å‡€ç®€æ˜ã€‚ä¸‰çº¿è¡¨ç”± booktabs å®åŒ… æ”¯æŒï¼Œå®ƒæä¾›äº† \topruleã€\midrule å’Œ \bottomrule å‘½ä»¤ç”¨ä»¥æ’ç‰ˆä¸‰çº¿è¡¨çš„ä¸‰æ¡çº¿ï¼Œä»¥åŠå’Œ \cline å¯¹åº”çš„ \cmidruleã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæœ€å¥½ä¸è¦ç”¨å…¶å®ƒæ¨ªçº¿ä»¥åŠç«–çº¿</p></blockquote><p>åˆå¹¶å•å…ƒæ ¼å¯ä»¥ä½¿ç”¨<code>\multicolumn&#123;&lt;n&gt;&#125;&#123;&lt;column-spec&gt;&#125;&#123;&lt;item&gt;&#125;</code>ä»¥åŠ<code>\multirow&#123;âŸ¨nâŸ©&#125;&#123;âŸ¨widthâŸ©&#125;&#123;âŸ¨itemâŸ©&#125;</code></p><p>âŸ¨widthâŸ© ä¸ºåˆå¹¶åå•å…ƒæ ¼çš„å®½åº¦ï¼Œå¯ä»¥å¡« * ä»¥ä½¿ç”¨è‡ªç„¶å®½åº¦</p><p><code>\cmidrule</code> å‘½ä»¤ç”¨äºç»˜åˆ¶å¸¦æœ‰ä¸­é—´è§„æ ¼çº¿çš„è¡¨æ ¼ã€‚å…¶ä¸­ï¼Œ<code>&lt;trim&gt;</code> æ˜¯ç”¨äºæ§åˆ¶è§„æ ¼çº¿ä¿®å‰ªçš„å‚æ•°ã€‚</p><p><code>&lt;trim&gt;</code> å¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§å–å€¼ä¹‹ä¸€ï¼š</p><ul><li><code>l</code>: åœ¨å·¦ä¾§ä¿®å‰ªè§„æ ¼çº¿ï¼Œä½¿å…¶ä¸ä¸å·¦è¾¹ç•Œç›¸è¿ã€‚</li><li><code>r</code>: åœ¨å³ä¾§ä¿®å‰ªè§„æ ¼çº¿ï¼Œä½¿å…¶ä¸ä¸å³è¾¹ç•Œç›¸è¿ã€‚</li><li><code>lr</code>: åœ¨å·¦å³ä¸¤ä¾§ä¿®å‰ªè§„æ ¼çº¿ï¼Œä½¿å…¶ä¸ä¸å·¦å³è¾¹ç•Œç›¸è¿ã€‚</li></ul><h3 id="æ•°å­—ç¬¦å·æ§åˆ¶"><a href="#æ•°å­—ç¬¦å·æ§åˆ¶" class="headerlink" title="æ•°å­—ç¬¦å·æ§åˆ¶"></a>æ•°å­—ç¬¦å·æ§åˆ¶</h3><p>ä¸€äº›æ•°å­—ç¬¦å·çš„å½¢æ€åœ¨ä¸åŒåœ°æ–¹éœ€è¦ä¸ä¸€æ ·,æ¯”å¦‚å…¬å¼ä¸­</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸åŒçš„æ•°å­¦å­—ä½“å¾€å¾€å¸¦æœ‰ä¸åŒçš„è¯­ä¹‰ï¼Œå¦‚çŸ©é˜µã€å‘é‡ç­‰å¸¸ä¼šä½¿ç”¨ç²—ä½“æˆ–ç²—æ–œä½“ï¼Œ è€Œæ•°é›†å¸¸ä¼šä½¿ç”¨ <code>\mathbb</code>è¡¨ç¤ºã€‚å‡ºäºå†…å®¹ä¸æ ¼å¼åˆ†ç¦»ä»¥åŠæ–¹ä¾¿ä¹¦å†™çš„è€ƒè™‘ï¼Œå¯ä»¥ä¸ºå®ƒä»¬å®šä¹‰æ–° çš„å‘½ä»¤ã€‚</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240331213806915.png" alt="image-20240331213806915"></p><p>å¯¹äºæ•°å­¦ç¬¦å·åŠ ç²—,ä½¿ç”¨<code>\mathbf</code>è·å¾—ç›´ç«‹åŠ ç²—,ä¹Ÿå¯ä»¥ä½¿ç”¨<code>bm</code>  å®åŒ…æä¾›çš„<code>\bm</code>  å‘½ä»¤å¾—åˆ°ç²—æ–œä½“.</p><h3 id="å…¬å¼ç¯å¢ƒ"><a href="#å…¬å¼ç¯å¢ƒ" class="headerlink" title="å…¬å¼ç¯å¢ƒ"></a>å…¬å¼ç¯å¢ƒ</h3><p>å¤šè¡Œå…¬å¼,amsmath å®åŒ…çš„ <strong>multline ç¯å¢ƒ</strong>æä¾›äº†ä¹¦å†™æŠ˜è¡Œé•¿å…¬å¼çš„æ–¹ä¾¿ç¯å¢ƒã€‚å®ƒå…è®¸ç”¨ \ æŠ˜è¡Œï¼Œå°† å…¬å¼ç¼–å·æ”¾åœ¨æœ€åä¸€è¡Œã€‚å¤šè¡Œå…¬å¼çš„é¦–è¡Œå·¦å¯¹é½ï¼Œæœ«è¡Œå³å¯¹é½ï¼Œå…¶ä½™è¡Œå±…ä¸­ã€‚å¤šè¡Œå…¬å¼çš„é¦–è¡Œå·¦å¯¹é½ï¼Œæœ«è¡Œå³å¯¹é½ï¼Œå…¶ä½™è¡Œå±…ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;multline&#125;</span><br><span class="line">a + b + c + d + e + f</span><br><span class="line">+ g + h + i \\</span><br><span class="line">= j + k + l + m + n\\</span><br><span class="line">= o + p + q + r + s\\</span><br><span class="line">= t + u + v + x + z</span><br><span class="line">\end&#123;multline&#125;</span><br></pre></td></tr></table></figure><p>æœ€å¸¸ç”¨çš„æ˜¯ <strong>align ç¯å¢ƒ</strong>ï¼Œå®ƒå°†å…¬å¼ç”¨ &amp; éš”ä¸ºä¸¤éƒ¨åˆ†å¹¶å¯¹é½ã€‚åˆ†éš”ç¬¦é€šå¸¸æ”¾åœ¨ç­‰å·å·¦è¾¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;align&#125;</span><br><span class="line">a =&#123;&#125; &amp; b + c \\</span><br><span class="line">=&#123;&#125; &amp; d + e + f + g + h + i</span><br><span class="line">+ j + k + l \notag \\</span><br><span class="line">&amp; + m + n + o \\</span><br><span class="line">=&#123;&#125; &amp; p + q + r + s</span><br><span class="line">\end&#123;align&#125;</span><br></pre></td></tr></table></figure><p>align ç¯å¢ƒä¼šç»™æ¯è¡Œå…¬å¼éƒ½ç¼–å·ã€‚ç„¶å¯ä»¥ç”¨ \notag å»æ‰æŸè¡Œçš„ç¼–å·ã€‚ä¸ºäº†å¯¹é½ç­‰å·ï¼Œå°†åˆ†éš”ç¬¦æ”¾åœ¨å³ä¾§ï¼Œå¹¶ä¸”æ­¤æ—¶éœ€è¦åœ¨ç­‰å·åæ·»åŠ ä¸€å¯¹æ‹¬å· {} ä»¥äº§ç”Ÿæ­£å¸¸çš„ é—´è·</p><p>align è¿˜èƒ½å¤Ÿå¯¹é½å¤šç»„å…¬å¼ï¼Œé™¤ç­‰å·å‰çš„ &amp; ä¹‹å¤–ï¼Œå…¬å¼ä¹‹é—´ä¹Ÿç”¨ &amp; åˆ†éš”</p><p>å¦‚æœä¸éœ€è¦æŒ‰ç­‰å·å¯¹é½ï¼Œåªéœ€ç½—åˆ—æ•°ä¸ªå…¬å¼ï¼Œ<strong>gather</strong> å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½ç”¨çš„ç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;gather&#125;</span><br><span class="line">a = b + c \\</span><br><span class="line">d = e + f + g \\</span><br><span class="line">h + i = j + k \notag \\</span><br><span class="line">l + m = n</span><br><span class="line">\end&#123;gather&#125;</span><br></pre></td></tr></table></figure><p>align å’Œ gather æœ‰å¯¹åº”çš„ä¸å¸¦ç¼–å·çš„ç‰ˆæœ¬ align<em> å’Œ gather</em>ã€‚</p><p>å¦ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚æ˜¯<strong>å°†å¤šä¸ªå…¬å¼ç»„åœ¨ä¸€èµ·å…¬ç”¨ä¸€ä¸ªç¼–å·ï¼Œç¼–å·ä½äºå…¬å¼çš„å±…ä¸­ä½ç½®</strong>ã€‚ä¸ºæ­¤ï¼Œ amsmath å®åŒ…æä¾›äº†è¯¸å¦‚ alignedã€gathered ç­‰ç¯å¢ƒï¼Œä¸ equation ç¯å¢ƒå¥—ç”¨ã€‚ä»¥ -ed ç»“å°¾çš„ ç¯å¢ƒç”¨æ³•ä¸å‰ä¸€èŠ‚ä¸ä»¥ -ed ç»“å°¾çš„ç¯å¢ƒç”¨æ³•ä¸€ä¸€å¯¹åº”</p><p>amsmath å®åŒ…æä¾›äº†è¯¸å¦‚ alignedã€gathered ç­‰ç¯å¢ƒï¼Œä¸ equation ç¯å¢ƒå¥—ç”¨ã€‚ä»¥ -ed ç»“å°¾çš„ ç¯å¢ƒç”¨æ³•ä¸å‰ä¸€èŠ‚ä¸ä»¥ -ed ç»“å°¾çš„ç¯å¢ƒç”¨æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;equation&#125;</span><br><span class="line">\begin&#123;aligned&#125;</span><br><span class="line">a &amp;= b + c \\</span><br><span class="line">d &amp;= e + f + g \\</span><br><span class="line">h + i &amp;= j + k \\</span><br><span class="line">l + m &amp;= n</span><br><span class="line">\end&#123;aligned&#125;</span><br><span class="line">\end&#123;equation&#125;</span><br></pre></td></tr></table></figure><p>åŒºåˆ«æ˜¯ split åªèƒ½ å°†æ¯è¡Œçš„ä¸€ä¸ªå…¬å¼åˆ†ä¸¤æ ,aligned å…è®¸æ¯è¡Œå¤šä¸ªå…¬å¼å¤šæ .</p><h3 id="ç©ºæ ¼ä¸åˆ†æ®µ"><a href="#ç©ºæ ¼ä¸åˆ†æ®µ" class="headerlink" title="ç©ºæ ¼ä¸åˆ†æ®µ"></a>ç©ºæ ¼ä¸åˆ†æ®µ</h3><p>ç©ºæ ¼é”®å’Œ Tab é”®è¾“å…¥çš„ç©ºç™½å­—ç¬¦è§†ä¸ºâ€œç©ºæ ¼â€ã€‚è¿ç»­çš„è‹¥å¹²ä¸ªç©ºç™½å­—ç¬¦è§†ä¸ºä¸€ä¸ªç©ºæ ¼ã€‚<strong>ä¸€è¡Œå¼€å¤´çš„ç©ºæ ¼å¿½ç•¥ä¸è®¡</strong>ã€‚</p><p><strong>è¡Œæœ«çš„æ¢è¡Œç¬¦è§†ä¸ºä¸€ä¸ªç©ºæ ¼</strong>ï¼›ä½†è¿ç»­ä¸¤ä¸ªæ¢è¡Œç¬¦ï¼Œ<strong>ä¹Ÿå°±æ˜¯ç©ºè¡Œï¼Œä¼šå°†æ–‡å­—åˆ†æ®µã€‚å¤šä¸ªç©ºè¡Œè¢« è§†ä¸ºä¸€ä¸ªç©ºè¡Œã€‚ä¹Ÿå¯ä»¥åœ¨è¡Œæœ«ä½¿ç”¨ \par å‘½ä»¤åˆ†æ®µ</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">It&#x27;s difficult to find \ldots\\</span><br><span class="line">It&#x27;s dif&#123;&#125;f&#123;&#125;icult to f&#123;&#125;ind \ldots</span><br></pre></td></tr></table></figure><h3 id="æ–­è¡Œå’Œæ–­é¡µ"><a href="#æ–­è¡Œå’Œæ–­é¡µ" class="headerlink" title="æ–­è¡Œå’Œæ–­é¡µ"></a>æ–­è¡Œå’Œæ–­é¡µ</h3><h3 id="å¼•å…¥å›¾ç‰‡"><a href="#å¼•å…¥å›¾ç‰‡" class="headerlink" title="å¼•å…¥å›¾ç‰‡"></a>å¼•å…¥å›¾ç‰‡</h3><p>LATEX æœ¬èº«ä¸æ”¯æŒæ’å›¾åŠŸèƒ½ï¼Œéœ€è¦ç”± <strong>graphicx å®åŒ…</strong>è¾…åŠ©æ”¯æŒ</p><p>æˆ‘çœ‹é€šå¸¸ä½¿ç”¨çš„æ˜¯pdfå¼•å…¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> \begin&#123;figure&#125;[t]</span><br><span class="line">  \centering</span><br><span class="line">  \includegraphics[width=\linewidth]&#123;imgs/temporal.pdf&#125;</span><br><span class="line">  \caption&#123;(a) The architecture of the proposed CIA component, including selective information filtering (\textit&#123;left&#125;) and spatio-temporal feature integration (\textit&#123;middle&#125;). (b) The multi-scale convolutional structure in the pyramid LSTM.</span><br><span class="line">  &#125;</span><br><span class="line">  \label&#123;temporal&#125;</span><br><span class="line">  \vspace&#123;-9pt&#125;</span><br><span class="line">\end&#123;figure&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦[t]è¡¨ç¤ºåœ¨å½“é¡µçš„é¡¶éƒ¨.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\includegraphics[âŸ¨optionsâŸ©]&#123;âŸ¨filenameâŸ©&#125;</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åå¯èƒ½éœ€è¦ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„è¡¨ç¤ºã€‚å›¾ç‰‡æ–‡ä»¶çš„æ‰©å±•åä¸€èˆ¬å¯ä¸å†™ã€‚å¦å¤–ä¸€å®šè¦æ³¨æ„ï¼Œæ–‡ä»¶åé‡Œæ—¢ä¸è¦ç©ºæ ¼ï¼ˆç±»ä¼¼ \includeï¼‰ï¼Œä¹Ÿä¸è¦æœ‰å¤šä½™çš„è‹±æ–‡ç‚¹å·ã€‚å¦å¤– graphicx å®åŒ…è¿˜æä¾›äº† \graphicspath å‘½ä»¤ï¼Œç”¨äºå£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå›¾ç‰‡æ–‡ä»¶å­˜æ”¾çš„ç›® å½•ï¼Œä½¿ç”¨è¿™äº›ç›®å½•é‡Œçš„å›¾ç‰‡æ—¶å¯ä¸ç”¨å†™è·¯å¾„</p><h3 id="å®šä¹‰æ–°å‘½ä»¤"><a href="#å®šä¹‰æ–°å‘½ä»¤" class="headerlink" title="å®šä¹‰æ–°å‘½ä»¤"></a>å®šä¹‰æ–°å‘½ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\newcommand&#123;\âŸ¨nameâŸ©&#125;[âŸ¨numâŸ©]&#123;âŸ¨definitionâŸ©&#125;</span><br></pre></td></tr></table></figure><p><code>\newcommand</code> çš„åŸºæœ¬ç”¨æ³•éœ€è¦ä¸¤ä¸ªå¿…é€‰å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° âŸ¨nameâŸ© æ˜¯è¦å®šä¹‰çš„å‘½ä»¤åç§°ï¼ˆå¸¦åæ–œçº¿ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•° âŸ¨definitionâŸ© æ˜¯å‘½ä»¤çš„å…·ä½“å®šä¹‰ã€‚æ–¹æ‹¬å·é‡Œçš„å‚æ•° âŸ¨numâŸ© æ˜¯å¯é€‰çš„ï¼Œç”¨äºæŒ‡å®š æ–°å‘½ä»¤æ‰€éœ€çš„å‚æ•°æ•°ç›®ï¼ˆæœ€å¤š 9 ä¸ªï¼‰ã€‚å¦‚æœç¼ºçœå¯é€‰å‚æ•°ï¼Œé»˜è®¤å°±æ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯æ–°å®šä¹‰çš„å‘½ä»¤ä¸å¸¦ä»»ä½•å‚æ•°,å¦‚æœä½¿ç”¨å¤šå‚æ•°çš„è¯,åœ¨å‘½ä»¤çš„å®šä¹‰ä¸­ï¼Œæ ‡è®° #1 ä»£è¡¨æŒ‡å®šçš„å‚æ•°ã€‚ å¦‚æœæƒ³ä½¿ç”¨å¤šä¸ªå‚æ•°ï¼Œå¯ä»¥ä¾æ¬¡ä½¿ç”¨ #2ã€â€¦â€¦ã€#9 ç­‰æ ‡è®°.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\newcommand&#123;\sayHello&#125;[2]&#123;</span><br><span class="line">    Hi!\emph&#123;#1&#125;</span><br><span class="line">&#125;</span><br><span class="line">\sayHello&#123;Jack&#125;</span><br></pre></td></tr></table></figure><blockquote><p>LATEX ä¸å…è®¸ä½¿ç”¨ \newcommand å®šä¹‰ä¸€ä¸ªä¸ç°æœ‰å‘½ä»¤é‡åçš„å‘½ä»¤ã€‚</p><p>å¦‚æœéœ€è¦ä¿®æ”¹å‘½ä»¤å®šä¹‰ çš„è¯ï¼Œä½¿ç”¨ \renewcommand å‘½ä»¤ã€‚</p><p>å®ƒä½¿ç”¨ä¸å‘½ä»¤ \newcommand ç›¸åŒçš„è¯­æ³•ã€‚ </p><p>åœ¨æŸäº›æƒ…å†µä¹‹ä¸‹ï¼Œä½¿ç”¨ \providecommand å‘½ä»¤æ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„æ–¹æ¡ˆï¼š<strong>åœ¨å‘½ä»¤æœªå®šä¹‰æ—¶ï¼Œå®ƒç›¸å½“äº \newcommandï¼›åœ¨å‘½ä»¤å·²å®šä¹‰æ—¶ï¼Œæ²¿ç”¨å·²æœ‰çš„å®šä¹‰</strong></p></blockquote><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li>lshort<a href="https://github.com/CTeX-org/lshort-zh-cn/releases">Releases Â· CTeX-org/lshort-zh-cn (github.com)</a></li><li><a href="https://www.overleaf.com/learn/latex/Learn_LaTeX_in_30_minutes">Learn LaTeX in 30 minutes - Overleaf, Online LaTeX Editor</a></li><li><a href="https://dmackinnon1.github.io/LaTeX101/">LaTeX101 (dmackinnon1.github.io)</a></li><li><a href="https://www.ctan.org/topic/class">CTAN: Class</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;é€šè¿‡é˜…è¯»ä¸€ç³»åˆ—æ–‡ç« ,åˆ†ææ‘˜è¦ã€ä»‹ç»æ¯ä¸ªsectionçš„ç»„ç»‡å½¢å¼,æ–¹ä¾¿å†™å‡ºä¸€äº›åˆ—ç°ä»£å…«è‚¡æ–‡.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>CMAçƒ­åŠ›å›¾å­¦ä¹ </title>
    <link href="https://www.sekyoro.top/2024/03/03/CMA%E7%83%AD%E5%8A%9B%E5%9B%BE%E5%AD%A6%E4%B9%A0/"/>
    <id>https://www.sekyoro.top/2024/03/03/CMA%E7%83%AD%E5%8A%9B%E5%9B%BE%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-03-03T11:32:36.000Z</published>
    <updated>2024-03-03T11:32:37.016Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>attention mechanisms in CV</title>
    <link href="https://www.sekyoro.top/2024/03/03/attention-mechanisms-in-CV/"/>
    <id>https://www.sekyoro.top/2024/03/03/attention-mechanisms-in-CV/</id>
    <published>2024-03-03T07:19:50.000Z</published>
    <updated>2024-03-12T09:30:39.551Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¸»è¦æ˜¯åœ¨è§†è§‰é¢†åŸŸä»¥åŠäºŒç»´çš„feature mapä¸Šçš„æ³¨æ„åŠ›æœºåˆ¶,ä¸åŒäº1Dæ•°æ®,ä¸€èˆ¬ä¸ä¼šç”¨q,k,væ¥ç®—.æ€»ç»“ä¸€ä¸‹cvä¸­attentionçš„å‘å±•.</p><span id="more"></span><h2 id="Coordinate-Attention"><a href="#Coordinate-Attention" class="headerlink" title="Coordinate Attention"></a>Coordinate Attention</h2><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://arxiv.org/pdf/2111.07624.pdf">2111.07624.pdf (arxiv.org)</a> ç»¼è¿°</li><li><a href="https://arxiv.org/pdf/2112.05561.pdf">2112.05561.pdf (arxiv.org)</a></li><li><a href="https://arxiv.org/pdf/1807.06521.pdf">1807.06521.pdf (arxiv.org)</a></li><li><a href="https://arxiv.org/pdf/2103.02907.pdf">2103.02907.pdf (arxiv.org)</a></li><li><a href="https://arxiv.org/pdf/1811.11721.pdf">1811.11721.pdf (arxiv.org)</a></li><li><a href="https://arxiv.org/pdf/1711.07971.pdf">arxiv.org/pdf/1711.07971.pdf</a></li><li><a href="https://arxiv.org/pdf/1709.01507.pdf">1709.01507.pdf (arxiv.org)</a></li><li><a href="https://arxiv.org/pdf/1903.06586.pdf">1903.06586.pdf (arxiv.org)</a></li><li><a href="https://mlrad.io/combining-convolution-and-attention-mechanisms">Convolution-Attention Mechanism Fusion (mlrad.io)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸»è¦æ˜¯åœ¨è§†è§‰é¢†åŸŸä»¥åŠäºŒç»´çš„feature mapä¸Šçš„æ³¨æ„åŠ›æœºåˆ¶,ä¸åŒäº1Dæ•°æ®,ä¸€èˆ¬ä¸ä¼šç”¨q,k,væ¥ç®—.æ€»ç»“ä¸€ä¸‹cvä¸­attentionçš„å‘å±•.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å†å›çœ‹æ‰©æ•£æ¨¡å‹</title>
    <link href="https://www.sekyoro.top/2024/02/23/%E5%86%8D%E5%9B%9E%E7%9C%8B%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B/"/>
    <id>https://www.sekyoro.top/2024/02/23/%E5%86%8D%E5%9B%9E%E7%9C%8B%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B/</id>
    <published>2024-02-23T08:53:30.000Z</published>
    <updated>2024-02-24T03:55:44.472Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æœ€è¿‘OpenAIçš„Soraæ¨¡å‹åˆå¤§ç«äº†ä¸€æŠŠ,æ®è¯´èƒŒåçš„æŠ€æœ¯æ˜¯transformer+diffusion.ä¹‹å‰æˆ‘ä¹Ÿå¤§è‡´ä»‹ç»è¿‡stable diffusionçš„è¿‡ç¨‹,è¿™é‡Œæˆ‘å†ç¨å¾®è¯¦ç»†ä»‹ç»ä¸€ä¸‹ç»å…¸çš„æ‰©æ•£æ¨¡å‹ä»¥åŠæ”¹è¿›ä¹‹åçš„DDIM.å…¶ä¸­æˆ‘ä¹Ÿæœ‰å¾ˆå¤šä¸å¤ªæ˜ç™½çš„,åªæœ‰ç»“åˆä»£ç ç†è§£äº†.<br><span id="more"></span></p><p>ç›¸å…³è®ºæ–‡<a href="https://arxiv.org/abs/2006.11239">[2006.11239] Denoising Diffusion Probabilistic Models (arxiv.org)</a>ä¸<a href="https://arxiv.org/abs/2010.02502">[2010.02502] Denoising Diffusion Implicit Models (arxiv.org)</a>,<a href="https://arxiv.org/pdf/2112.10752.pdf">2112.10752.pdf (arxiv.org)</a></p><blockquote><p>Stable Diffusion is a latent text-to-image diffusion model.</p></blockquote><p>å·²ç»æå‡ºäº†å‡ ç§åŸºäºæ‰©æ•£çš„ç”Ÿæˆæ¨¡å‹ï¼Œå…¶ä¸‹æœ‰ç±»ä¼¼çš„æƒ³æ³•ï¼ŒåŒ…æ‹¬æ‰©æ•£æ¦‚ç‡æ¨¡å‹ã€å™ªå£°æ¡ä»¶è¯„åˆ†ç½‘ç»œå’Œå»å™ªæ‰©æ•£æ¦‚ç‡æ¨¡å‹ã€‚ç°åœ¨å¸¸è¯´çš„åŸºäºæ‰©æ•£çš„ç”Ÿæˆæ¨¡å‹é€šå¸¸æŒ‡çš„åè€…DDPMæˆ–è€…æ”¹è¿›çš„DDIM.</p><h2 id="å‰å‘æ‰©æ•£è¿‡ç¨‹"><a href="#å‰å‘æ‰©æ•£è¿‡ç¨‹" class="headerlink" title="å‰å‘æ‰©æ•£è¿‡ç¨‹"></a>å‰å‘æ‰©æ•£è¿‡ç¨‹</h2><p><img data-src="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/DDPM.png" alt="img"></p><script type="math/tex; mode=display">q(\mathbf{x}_t|\mathbf{x}_{t-1})=\mathcal{N}(\mathbf{x}_t;\sqrt{1-\beta_t}\mathbf{x}_{t-1},\beta_t\mathbf{I})\quad q(\mathbf{x}_{1:T}|\mathbf{x}_0)=\prod_{t=1}^Tq(\mathbf{x}_t|\mathbf{x}_{t-1})</script><p>æ‰€è°“çš„æ‰©æ•£å°±æ˜¯ç»™å›¾ç‰‡(æˆ–è€…æ˜¯ç‰¹å¾,æ¯”å¦‚stable diffusionå°±æ˜¯åœ¨æ‰€è°“latentç©ºé—´ä¸Šè¿›è¡Œæ‰©æ•£çš„)åŠ å™ªå£°,æ‰€åŠ çš„å™ªå£°æŒ‰ç…§ä¸€å®šåˆ†å¸ƒ.</p><p>å‰å‘è¿‡ç¨‹ä¸ºä¸€ä¸ªé©¬å°”ç§‘å¤«é“¾,ä½¿ç”¨é‡å‚æ•°åŒ–(åœ¨VAEä¸­ä¹Ÿæœ‰),å¯ä»¥è¡¨ç¤ºä¸º</p><script type="math/tex; mode=display">\begin{aligned}\mathbf{x}_t&=\sqrt{\alpha_t}\mathbf{x}_{t-1}+\sqrt{1-\alpha_t}\boldsymbol{\epsilon}_{t-1}&&\text{;where }\boldsymbol{\epsilon}_{t-1},\boldsymbol{\epsilon}_{t-2},\cdots\sim\mathcal{N}(\boldsymbol{0},\mathbf{I})\\&=\sqrt{\alpha_t\alpha_{t-1}}\mathbf{x}_{t-2}+\sqrt{1-\alpha_t\alpha_{t-1}}\boldsymbol{\bar{\epsilon}}_{t-2}&&\text{;where }\boldsymbol{\bar{\boldsymbol{\epsilon}}}_{t-2}\text{ merges two Gaussians }(*).\\&=\ldots\\&=\sqrt{\alpha}_t\mathbf{x}_0+\sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}&&\text{j}\\q(\mathbf{x}_t|\mathbf{x}_0)&=\mathcal{N}(\mathbf{x}_t;\sqrt{\alpha}_t\mathbf{x}_0,(1-\bar{\alpha}_t)\mathbf{I})\end{aligned}</script><p>å…¶ä¸­Î±=1-Î².$\bar{\alpha}<em>{t}=\prod</em>{i=1}^{t}\alpha_{i}$,Î²æ˜¯ä»0åˆ°1ä¸­é—´çš„é‡‡æ ·å€¼,æ¯”å¦‚0.01,0.02..</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear_beta_schedule</span>(<span class="params">timesteps, start=<span class="number">0.0001</span>, end=<span class="number">0.02</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> torch.linspace(start, end, timesteps)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_index_from_list</span>(<span class="params">vals, t, x_shape</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">    Returns a specific index t of a passed list of values vals</span></span><br><span class="line"><span class="string">    while considering the batch dimension.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    batch_size = t.shape[<span class="number">0</span>]</span><br><span class="line">    out = vals.gather(-<span class="number">1</span>, t.cpu())</span><br><span class="line">    <span class="keyword">return</span> out.reshape(batch_size, *((<span class="number">1</span>,) * (<span class="built_in">len</span>(x_shape) - <span class="number">1</span>))).to(t.device)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward_diffusion_sample</span>(<span class="params">x_0, t, device=<span class="string">&quot;cpu&quot;</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">    Takes an image and a timestep as input and </span></span><br><span class="line"><span class="string">    returns the noisy version of it</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    noise = torch.randn_like(x_0)</span><br><span class="line">    sqrt_alphas_cumprod_t = get_index_from_list(sqrt_alphas_cumprod, t, x_0.shape)</span><br><span class="line">    sqrt_one_minus_alphas_cumprod_t = get_index_from_list(</span><br><span class="line">        sqrt_one_minus_alphas_cumprod, t, x_0.shape</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># mean + variance</span></span><br><span class="line">    <span class="keyword">return</span> sqrt_alphas_cumprod_t.to(device) * x_0.to(device) \</span><br><span class="line">    + sqrt_one_minus_alphas_cumprod_t.to(device) * noise.to(device), noise.to(device)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define beta schedule</span></span><br><span class="line">T = <span class="number">300</span></span><br><span class="line">betas = linear_beta_schedule(timesteps=T)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-calculate different terms for closed form</span></span><br><span class="line">alphas = <span class="number">1.</span> - betas</span><br><span class="line">alphas_cumprod = torch.cumprod(alphas, axis=<span class="number">0</span>)</span><br><span class="line">alphas_cumprod_prev = F.pad(alphas_cumprod[:-<span class="number">1</span>], (<span class="number">1</span>, <span class="number">0</span>), value=<span class="number">1.0</span>)</span><br><span class="line">sqrt_recip_alphas = torch.sqrt(<span class="number">1.0</span> / alphas)</span><br><span class="line">sqrt_alphas_cumprod = torch.sqrt(alphas_cumprod)</span><br><span class="line">sqrt_one_minus_alphas_cumprod = torch.sqrt(<span class="number">1.</span> - alphas_cumprod)</span><br><span class="line">posterior_variance = betas * (<span class="number">1.</span> - alphas_cumprod_prev) / (<span class="number">1.</span> - alphas_cumprod)</span><br></pre></td></tr></table></figure><p>åŠ å™ªå£°çš„scheduleæœ‰å¤šç§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cosine_beta_schedule</span>(<span class="params">timesteps, s=<span class="number">0.008</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    cosine schedule as proposed in https://arxiv.org/abs/2102.09672</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    steps = timesteps + <span class="number">1</span></span><br><span class="line">    x = torch.linspace(<span class="number">0</span>, timesteps, steps)</span><br><span class="line">    alphas_cumprod = torch.cos(((x / timesteps) + s) / (<span class="number">1</span> + s) * torch.pi * <span class="number">0.5</span>) ** <span class="number">2</span></span><br><span class="line">    alphas_cumprod = alphas_cumprod / alphas_cumprod[<span class="number">0</span>]</span><br><span class="line">    betas = <span class="number">1</span> - (alphas_cumprod[<span class="number">1</span>:] / alphas_cumprod[:-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> torch.clip(betas, <span class="number">0.0001</span>, <span class="number">0.9999</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear_beta_schedule</span>(<span class="params">timesteps</span>):</span></span><br><span class="line">    beta_start = <span class="number">0.0001</span></span><br><span class="line">    beta_end = <span class="number">0.02</span></span><br><span class="line">    <span class="keyword">return</span> torch.linspace(beta_start, beta_end, timesteps)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quadratic_beta_schedule</span>(<span class="params">timesteps</span>):</span></span><br><span class="line">    beta_start = <span class="number">0.0001</span></span><br><span class="line">    beta_end = <span class="number">0.02</span></span><br><span class="line">    <span class="keyword">return</span> torch.linspace(beta_start**<span class="number">0.5</span>, beta_end**<span class="number">0.5</span>, timesteps) ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid_beta_schedule</span>(<span class="params">timesteps</span>):</span></span><br><span class="line">    beta_start = <span class="number">0.0001</span></span><br><span class="line">    beta_end = <span class="number">0.02</span></span><br><span class="line">    betas = torch.linspace(-<span class="number">6</span>, <span class="number">6</span>, timesteps)</span><br><span class="line">    <span class="keyword">return</span> torch.sigmoid(betas) * (beta_end - beta_start) + beta_start</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åå‘æ‰©æ•£è¿‡ç¨‹"><a href="#åå‘æ‰©æ•£è¿‡ç¨‹" class="headerlink" title="åå‘æ‰©æ•£è¿‡ç¨‹"></a>åå‘æ‰©æ•£è¿‡ç¨‹</h2><p>å¦‚æœèƒ½å°†ä¸Šè¿°è¿‡ç¨‹åå‘,å°±èƒ½ä»é«˜æ–¯å™ªå£°å›¾åƒå¾—åˆ°ä¸€æ•´å›¾åƒäº†.ä¹Ÿå°±æ˜¯éœ€è¦çŸ¥é“$q(\mathbf{x}<em>{t-1}|\mathbf{x}</em>{t})$,è¿™è·Ÿè´å¶æ–¯æœ‰ç‚¹å…³ç³»,å¯ä»¥ä½¿ç”¨ç¥ç»ç½‘ç»œè¿‘ä¼¼è¿™ä¸ªæ¡ä»¶æ¦‚ç‡,ä»¥ä¾¿è¿è¡Œåå‘æ‰©æ•£è¿‡ç¨‹.</p><script type="math/tex; mode=display">p_\theta(\mathbf{x}_{0:T})=p(\mathbf{x}_T)\prod_{t=1}^Tp_\theta(\mathbf{x}_{t-1}|\mathbf{x}_t)\quad p_\theta(\mathbf{x}_{t-1}|\mathbf{x}_t)=\mathcal{N}(\mathbf{x}_{t-1};\boldsymbol{\mu}_\theta(\mathbf{x}_t,t),\boldsymbol{\Sigma}_\theta(\mathbf{x}_t,t))</script><p>å‡è®¾åå‘ä¹Ÿæ˜¯é«˜æ–¯,å¯ä»¥æœ‰æ¡ä»¶æ¦‚ç‡</p><script type="math/tex; mode=display">q(\mathbf{x}_{t-1}|\mathbf{x}_t,\mathbf{x}_0)=\mathcal{N}(\mathbf{x}_{t-1};\tilde{\boldsymbol{\mu}}(\mathbf{x}_t,\mathbf{x}_0),\color{red}{\tilde{\boldsymbol{\beta}}_t}\mathbf{I})</script><p>ä½¿ç”¨è´å¶æ–¯</p><script type="math/tex; mode=display">\begin{aligned}q(\mathbf{x}_{t-1}|\mathbf{x}_t,\mathbf{x}_0)& =q(\mathbf{x}_t|\mathbf{x}_{t-1},\mathbf{x}_0)\frac{q(\mathbf{x}_{t-1}|\mathbf{x}_0)}{q(\mathbf{x}_t|\mathbf{x}_0)}  \\&\propto\exp\left(-\frac12(\frac{(\mathbf{x}_t-\sqrt{\alpha_t}\mathbf{x}_{t-1})^2}{\beta_t}+\frac{(\mathbf{x}_{t-1}-\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_0)^2}{1-\bar{\alpha}_{t-1}}-\frac{(\mathbf{x}_t-\sqrt{\bar{\alpha}_t}\mathbf{x}_0)^2}{1-\bar{\alpha}_t})\right) \\&=\exp\left(-\frac12(\frac{\mathbf{x}_t^2-2\sqrt{\alpha_t}\mathbf{x}_t\mathbf{x}_{t-1}+\alpha_t\mathbf{x}_{t-1}^2}{\beta_t}+\frac{\mathbf{x}_{t-1}^2-2\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_0\mathbf{x}_{t-1}+\bar{\alpha}_{t-1}\mathbf{x}_0^2}{1-\bar{\alpha}_{t-1}}-\frac{(\mathbf{x}_t-\sqrt{\bar{\alpha}_t}\mathbf{x}_0)^2}{1-\bar{\alpha}_t})\right) \\&\left.=\exp\left(-\frac12(\color{red}{(\frac{\alpha_t}{\beta_t}+\frac1{1-\bar{\alpha}_{t-1}})x_{t-1}^2-(\frac{2\sqrt{\alpha_t}}{\beta_t}x_t+\frac{2\sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}}x_0)x_{t-1}+C(\mathbf{x}_t,\mathbf{x}_0)}\right)\right)\end{aligned}</script><p>æ ¹æ®ä¸€å †å…¬å¼è®¡ç®—(è¿™ä¸æ˜¯æˆ‘æ“…é•¿çš„),å¾—åˆ°å‡å€¼å’Œæ–¹å·®.</p><script type="math/tex; mode=display">\begin{aligned}\tilde{\beta}_{t}& =1/(\frac{\alpha_t}{\beta_t}+\frac{1}{1-\bar{\alpha}_{t-1}})=1/(\frac{\alpha_t-\bar{\alpha}_t+\beta_t}{\beta_t(1-\bar{\alpha}_{t-1})})=\frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t}\cdot\beta_t  \\\tilde{\boldsymbol{\mu}}_t(\mathbf{x}_t,\mathbf{x}_0)& =(\frac{\sqrt{\alpha_t}}{\beta_t}\mathbf{x}_t+\frac{\sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}}\mathbf{x}_0)/(\frac{\alpha_t}{\beta_t}+\frac{1}{1-\bar{\alpha}_{t-1}})  \\&=(\frac{\sqrt{\alpha_t}}{\beta_t}\mathbf{x}_t+\frac{\sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}}\mathbf{x}_0)\frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t}\cdot\beta_t \\&=\frac{\sqrt{\alpha_t}(1-\bar{\alpha}_{t-1})}{1-\bar{\alpha}_t}\mathbf{x}_t+\frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1-\bar{\alpha}_t}\mathbf{x}_0\end{aligned}</script><p>ç”±äº$\mathbf{x}_0=\frac1{\sqrt{\bar{\alpha}_t}}(\mathbf{x}_t-\sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}_t)$,æœ‰å‡å€¼å¦‚ä¸‹:</p><script type="math/tex; mode=display">\begin{aligned}\tilde{\boldsymbol{\mu}}_{t}& =\frac{\sqrt{\alpha_t}(1-\bar{\alpha}_{t-1})}{1-\bar{\alpha}_t}\mathbf{x}_t+\frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1-\bar{\alpha}_t}\frac{1}{\sqrt{\bar{\alpha}_t}}(\mathbf{x}_t-\sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}_t)  \\&=\color{red}{\frac1{\sqrt{\alpha_t}}\left(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_t\right)}\end{aligned}</script><p>æ‰€ä»¥éœ€è¦è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œæ‹Ÿåˆè¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒ,ä½¿ç”¨é‡å‚æ•°åŒ–æŠ€å·§,å‰å‘åŠ å™ªå£°å,åˆ©ç”¨å¾—åˆ°çš„å›¾åƒæ•°æ®å¾—åˆ°é«˜æ–¯åˆ†å¸ƒçš„å‚æ•°Î¼</p><script type="math/tex; mode=display">\begin{aligned}\boldsymbol{\mu}_{\theta}(\mathbf{x}_{t},t)& =\color{red}{\frac1{\sqrt{\alpha_t}}\left(\mathbf{x}_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\boldsymbol{\epsilon}_\theta(\mathbf{x}_t,t)\right)}  \\\Gamma\mathrm{hus~}\mathbf{x}_{t-1}& =\mathcal{N}(\mathbf{x}_{t-1};\frac{1}{\sqrt{\alpha_{t}}}\left(\mathbf{x}_{t}-\frac{1-\alpha_{t}}{\sqrt{1-\bar{\alpha}_{t}}}\boldsymbol{\epsilon}_{\theta}(\mathbf{x}_{t},t)\right),\boldsymbol{\Sigma}_{\theta}(\mathbf{x}_{t},t)) \end{aligned}</script><script type="math/tex; mode=display">\begin{aligned}L_{t}& =\mathbb{E}_{\mathbf{x}_0,\epsilon}\Big[\frac{1}{2\|\boldsymbol{\Sigma}_\theta(\mathbf{x}_t,t)\|_2^2}\|\tilde{\boldsymbol{\mu}}_t(\mathbf{x}_t,\mathbf{x}_0)-\boldsymbol{\mu}_\theta(\mathbf{x}_t,t)\|^2\Big]  \\&=\mathbb{E}_{\mathbf{x}_0,\epsilon}\Big[\frac1{2\|\boldsymbol{\Sigma}_\theta\|_2^2}\|\color{red}{\frac1{\sqrt{\alpha_t}}\left(\mathbf{x}_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\boldsymbol{\epsilon}_t\right)}-\frac1{\sqrt{\alpha_t}}\Big(\mathbf{x}_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \\&=\mathbb{E}_{\mathbf{x}_0,\boldsymbol{\epsilon}}\Big[\frac{(1-\alpha_t)^2}{2\alpha_t(1-\bar{\alpha}_t)\|\boldsymbol{\Sigma}_\theta\|_2^2}\|\boldsymbol{\epsilon}_t-\boldsymbol{\epsilon}_\theta(\mathbf{x}_t,t)\|^2\Big] \\&=\mathbb{E}_{\mathbf{x}_0,\epsilon}\Big[\frac{(1-\alpha_t)^2}{2\alpha_t(1-\bar{\alpha}_t)\|\boldsymbol{\Sigma}_\theta\|_2^2}\|\boldsymbol{\epsilon}_t-\boldsymbol{\epsilon}_\theta(\sqrt{\bar{\alpha}_t}\mathbf{x}_0+\sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}_t,t)\|^2\Big]\end{aligned}</script><h3 id="ç®€åŒ–"><a href="#ç®€åŒ–" class="headerlink" title="ç®€åŒ–"></a>ç®€åŒ–</h3><script type="math/tex; mode=display">\begin{aligned}L_{t}^{\operatorname{simple}}& =\mathbb{E}_{t\sim[1,T],\mathbf{x}_0,\boldsymbol{\epsilon}_t}\left[\|\boldsymbol{\epsilon}_t-\boldsymbol{\epsilon}_\theta(\mathbf{x}_t,t)\|^2\right]  \\&=\mathbb{E}_{t\sim[1,T],\mathbf{x}_0,\boldsymbol{\epsilon}_t}\left[\|\boldsymbol{\epsilon}_t-\boldsymbol{\epsilon}_\theta(\sqrt{\bar{\alpha}_t}\mathbf{x}_0+\sqrt{1-\bar{\alpha}_t}\boldsymbol{\epsilon}_t,t)\|^2\right]\end{aligned}</script><p>æœ€ç»ˆç›®æ ‡ä¼˜åŒ–å‡½æ•°</p><script type="math/tex; mode=display">L_\text{simple} = L_t^\text{simple} + C</script><p><img data-src="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/DDPM-algo.png" alt="img"></p><h2 id="åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·"><a href="#åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·" class="headerlink" title="åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·"></a>åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·</h2><p>DDPMç”Ÿæˆæ ·æœ¬å¾ˆæ…¢,å¯ä»¥é€šè¿‡ç»è¿‡å¤šæ­¥åè¿›è¡Œé‡‡æ ·(ä¹Ÿå°±æ˜¯å¢åŠ é‡‡æ ·é—´éš”),æˆ–è€…æ ¹æ®DDIMè®ºæ–‡,è·³è¿‡p(x~t~|x~t-1~)ç›´æ¥ä»p(x~t~|x~0~)å‡ºå‘.</p><script type="math/tex; mode=display">\begin{aligned}\mathbf{X}_{t-1}& =\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_0+\sqrt{1-\bar{\alpha}_{t-1}}\boldsymbol{\epsilon}_{t-1}  \\&=\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_0+\sqrt{1-\bar{\alpha}_{t-1}-\sigma_t^2}\boldsymbol{\epsilon}_t+\sigma_t\boldsymbol{\epsilon} \\&=\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_0+\sqrt{1-\bar{\alpha}_{t-1}-\sigma_t^2}\frac{\mathbf{x}_t-\sqrt{\bar{\alpha}_t}\mathbf{x}_0}{\sqrt{1-\bar{\alpha}_t}}+\sigma_t\boldsymbol{\epsilon} \\q_\sigma(\mathbf{x}_{t-1}|\mathbf{x}_t,\mathbf{x}_0)& =\mathcal{N}(\mathbf{x}_{t-1};\sqrt{\bar{\alpha}_{t-1}}\mathbf{x}_{0}+\sqrt{1-\bar{\alpha}_{t-1}-\sigma_{t}^{2}}\frac{\mathbf{x}_{t}-\sqrt{\bar{\alpha}_{t}}\mathbf{x}_{0}}{\sqrt{1-\bar{\alpha}_{t}}},\sigma_{t}^{2}\mathbf{I}) \end{aligned}</script><script type="math/tex; mode=display">\tilde{\beta}_t=\sigma_t^2=\frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t}\cdot\beta_t</script><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://huggingface.co/blog/annotated-diffusion">The Annotated Diffusion Model (huggingface.co)</a></li><li><a href="https://colab.research.google.com/drive/1sjy9odlSSy0RBVgMTgP7s99NXsqglsUL?usp=sharing#scrollTo=qWw50ui9IZ5q">diffusion_model.ipynb - Colaboratory (google.com)</a></li><li><a href="https://github.com/cloneofsimo/minDiffusion/tree/master">cloneofsimo/minDiffusion: Self-contained, minimalistic implementation of diffusion models with Pytorch. (github.com)</a></li><li><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/">What are Diffusion Models? | Lilâ€™Log (lilianweng.github.io)</a></li><li><a href="https://spaces.ac.cn/archives/9119">ç”Ÿæˆæ‰©æ•£æ¨¡å‹æ¼«è°ˆï¼ˆä¸€ï¼‰ï¼šDDPM = æ‹†æ¥¼ + å»ºæ¥¼ - ç§‘å­¦ç©ºé—´|Scientific Spaces</a></li><li><a href="https://sungsoo.github.io/2022/07/20/diffusion-model.html">Diffusion Models from Scratch in PyTorch (sungsoo.github.io)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘OpenAIçš„Soraæ¨¡å‹åˆå¤§ç«äº†ä¸€æŠŠ,æ®è¯´èƒŒåçš„æŠ€æœ¯æ˜¯transformer+diffusion.ä¹‹å‰æˆ‘ä¹Ÿå¤§è‡´ä»‹ç»è¿‡stable diffusionçš„è¿‡ç¨‹,è¿™é‡Œæˆ‘å†ç¨å¾®è¯¦ç»†ä»‹ç»ä¸€ä¸‹ç»å…¸çš„æ‰©æ•£æ¨¡å‹ä»¥åŠæ”¹è¿›ä¹‹åçš„DDIM.å…¶ä¸­æˆ‘ä¹Ÿæœ‰å¾ˆå¤šä¸å¤ªæ˜ç™½çš„,åªæœ‰ç»“åˆä»£ç ç†è§£äº†.&lt;br&gt;</summary>
    
    
    
    
    <category term="diffusion model" scheme="https://www.sekyoro.top/tags/diffusion-model/"/>
    
  </entry>
  
  <entry>
    <title>æœºå™¨å­¦ä¹ å›é¡¾:é›†æˆå­¦ä¹ </title>
    <link href="https://www.sekyoro.top/2024/02/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9B%9E%E9%A1%BE-%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/"/>
    <id>https://www.sekyoro.top/2024/02/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9B%9E%E9%A1%BE-%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-02-22T15:49:54.000Z</published>
    <updated>2024-02-23T04:55:42.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ æ–¹æ³•,ç°åœ¨ç”¨å¾—ä¸å¤šäº†(è‡ªæˆ‘æ„Ÿè§‰).ä½†æ˜¯æœ‰å¿…è¦ç¨å¾®äº†è§£ä¸€ä¸‹åŸç†ã€‚<br><span id="more"></span></p><p>é›†æˆå­¦ä¹ æ–¹æ³•å¯ä»¥åˆ†ä¸ºBagging,Boostingä»¥åŠStacking.</p><p>Baggingä¹Ÿç§°ä¸ºbootstrapèšåˆï¼Œæ˜¯é¢„æµ‹æ¨¡å‹çš„å¤šä¸ªç‰ˆæœ¬çš„èšåˆã€‚æ¯ä¸ªæ¨¡å‹éƒ½æ˜¯å•ç‹¬è®­ç»ƒçš„ï¼Œå¹¶ä½¿ç”¨å¹³å‡è¿‡ç¨‹è¿›è¡Œç»„åˆã€‚è£…è¢‹çš„ä¸»è¦é‡ç‚¹æ˜¯å®ç°æ¯”ä»»ä½•æ¨¡å‹å•ç‹¬å…·æœ‰çš„æ–¹å·®æ›´å°çš„æ–¹å·®ã€‚</p><p>Bootstrapping æ˜¯ä»ç»™å®šçš„æ•°æ®é›†ä¸­ç”Ÿæˆè‡ªä¸¾æ ·æœ¬çš„è¿‡ç¨‹ã€‚æ ·æœ¬æ˜¯é€šè¿‡éšæœºæŠ½å–æ•°æ®ç‚¹å¹¶è¿›è¡Œæ›¿æ¢è€Œå½¢æˆçš„ã€‚</p><p>é‡æ–°é‡‡æ ·çš„æ•°æ®åŒ…å«åŸå§‹æ•°æ®ä¸­ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„ä¸åŒç‰¹å¾ã€‚å®ƒç»˜åˆ¶äº†æ•°æ®ç‚¹ä¸­å­˜åœ¨çš„åˆ†å¸ƒï¼Œå¹¶ä¸”å¾€å¾€ä¿æŒå½¼æ­¤ä¸åŒï¼Œå³æ•°æ®åˆ†å¸ƒå¿…é¡»ä¿æŒå®Œæ•´ï¼ŒåŒæ—¶ä¿æŒBootstrapping æ ·æœ¬ä¹‹é—´çš„ä¸ç›¸ä¼¼æ€§.å…¶å®è¿™è·Ÿç›®å‰æ·±åº¦å­¦ä¹ ä¸­çš„æ ·æœ¬å¢å¼ºç­‰æ¦‚å¿µåˆä½•å°ä¸åŒå‘¢.</p><p>åœ¨Baggingä¸­,é¦–å…ˆåˆ›å»ºè‡ªä¸¾æ ·æœ¬.ç„¶å,å¯¹æ¯ä¸ªæ ·æœ¬åº”ç”¨å›å½’ç®—æ³•æˆ–åˆ†ç±»ç®—æ³•.æœ€ååœ¨å›å½’çš„æƒ…å†µä¸‹,å¯¹ä¸ªä½“å­¦ä¹ è€…é¢„æµ‹çš„æ‰€æœ‰è¾“å‡ºå–å¹³å‡å€¼.å¯¹äºåˆ†ç±»,è¦ä¹ˆæ¥å—æŠ•ç¥¨æœ€å¤šçš„ç±»åˆ«ï¼ˆç¡¬æŠ•ç¥¨ï¼‰,è¦ä¹ˆå°†æ‰€æœ‰ç±»åˆ«æ¦‚ç‡çš„æœ€é«˜å¹³å‡å€¼ä½œä¸ºè¾“å‡ºï¼ˆè½¯æŠ•ç¥¨ï¼‰</p><script type="math/tex; mode=display">\widehat{f_{bag}}=\widehat{f_1}\left(X\right)+\widehat{f_2}\left(X\right)+\cdots+\widehat{f_b}\left(X\right)</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> model_selection</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> BaggingClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeClassifier</span><br><span class="line">seed = <span class="number">7</span></span><br><span class="line">kfold = model_selection.KFold(n_splits=<span class="number">10</span>, random_state=seed)</span><br><span class="line">cart = DecisionTreeClassifier()</span><br><span class="line">num_trees = <span class="number">100</span></span><br><span class="line">model = BaggingClassifier(base_estimator=cart,n_estimators=num_trees, random_state=seed)</span><br><span class="line"></span><br><span class="line">results = model_selection.cross_val_score(model, X, Y, cv=kfold)</span><br><span class="line"><span class="built_in">print</span>(results.mean())</span><br></pre></td></tr></table></figure><p>Stackingæ˜¯é€šè¿‡ä¸€ä¸ªå…ƒåˆ†ç±»å™¨æˆ–è€…å…ƒå›å½’å™¨æ¥æ•´åˆå¤šä¸ªåˆ†ç±»æ¨¡å‹æˆ–å›å½’æ¨¡å‹çš„é›†æˆå­¦ä¹ æŠ€æœ¯ã€‚åŸºç¡€æ¨¡å‹åˆ©ç”¨æ•´ä¸ªè®­ç»ƒé›†åšè®­ç»ƒï¼Œå…ƒæ¨¡å‹å°†åŸºç¡€æ¨¡å‹çš„ç‰¹å¾ä½œä¸ºç‰¹å¾è¿›è¡Œè®­ç»ƒ.æ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼äºå…ƒå­¦ä¹ (meta learning)çš„æ¦‚å¿µ.</p><p><img data-src="https://pic1.zhimg.com/80/v2-6a1eb954185433e79498dea9bf87e0e0_720w.webp" alt="img"></p><p>æˆ–è€…åˆå¯ä»¥åˆ†ä¸ºé¡ºåºçš„å’Œå¹¶è¡Œçš„è®­ç»ƒå™¨.ä¸åŒçš„æ¨¡å‹æŒ‰é¡ºåºç”Ÿæˆ,ä¹‹å‰æ¨¡å‹çš„é”™è¯¯ç”±åé¢çš„åˆ†ç±»å™¨å­¦ä¹ .è¿™æ—¨åœ¨é€šè¿‡èµ‹äºˆé”™è¯¯æ ‡è®°çš„ç¤ºä¾‹æ›´é«˜çš„æƒé‡ï¼ˆä¾‹å¦‚AdaBoostï¼‰æ¥åˆ©ç”¨æ¨¡å‹ä¹‹é—´çš„ç›¸å…³æ€§ã€‚</p><p> å¹¶è¡Œè®­ç»ƒå™¨,å…¶ä¸­åŸºç¡€æ¨¡å‹æ˜¯å¹¶è¡Œç”Ÿæˆçš„.è¿™é€šè¿‡å¹³å‡é”™è¯¯æ¥åˆ©ç”¨æ¨¡å‹ä¹‹é—´çš„ç‹¬ç«‹æ€§ï¼ˆä¾‹å¦‚éšæœºæ£®æ—ï¼‰</p><p>è¿™é‡Œä¸»è¦ä»‹ç»å…¶ä¸­çš„Boosting,Boostingç®—æ³•è¯•å›¾ä»å‡ ä¸ªè¾ƒå¼±æ¨¡å‹çš„é”™è¯¯ä¸­å»ºç«‹ä¸€ä¸ªå¼ºå¤§çš„å­¦ä¹ è€…ï¼ˆé¢„æµ‹æ¨¡å‹ï¼‰ã€‚é¦–å…ˆä»è®­ç»ƒæ•°æ®åˆ›å»ºæ¨¡å‹.ç„¶åé€šè¿‡å°è¯•å‡å°‘ä¸Šä¸€ä¸ªæ¨¡å‹ä¸­çš„é”™è¯¯,ä»ä¸Šä¸€ä¸ªåˆ›å»ºç¬¬äºŒä¸ªæ¨¡å‹.ä¾æ¬¡æ·»åŠ æ¨¡å‹,æ¯ä¸ªæ¨¡å‹éƒ½å¯¹å…¶å‰èº«è¿›è¡Œæ ¡æ­£,ç›´åˆ°è®­ç»ƒæ•°æ®å¾—åˆ°å®Œç¾é¢„æµ‹æˆ–æ·»åŠ äº†æœ€å¤§æ•°é‡çš„æ¨¡å‹ã€‚</p><p>BoostingåŒ…æ‹¬AdaBoost,Gradient Tree Boostingç­‰ç­‰.</p><h3 id="AdaBoost"><a href="#AdaBoost" class="headerlink" title="AdaBoost"></a>AdaBoost</h3><p>AdaBoostæ˜¯ä¸€ç§éå¸¸æµè¡Œçš„BoostingæŠ€æœ¯,æ—¨åœ¨å°†å¤šä¸ªå¼±åˆ†ç±»å™¨ç»„åˆèµ·æ¥æ„å»ºä¸€ä¸ªå¼ºåˆ†ç±»å™¨.å¼±åˆ†ç±»å™¨æ¯”éšæœºçŒœæµ‹æ€§èƒ½æ›´å¥½ï¼Œä½†åœ¨ä¸ºå¯¹è±¡æŒ‡å®šç±»æ–¹é¢ä»ç„¶è¡¨ç°ä¸ä½³ã€‚å•ä¸ªåˆ†ç±»å™¨å¯èƒ½æ— æ³•å‡†ç¡®é¢„æµ‹å¯¹è±¡çš„ç±»åˆ«ï¼Œä½†å½“æˆ‘ä»¬å°†å¤šä¸ªå¼±åˆ†ç±»å™¨åˆ†ç»„ï¼Œæ¯ä¸ªå¼±åˆ†ç±»å™¨ä»å…¶ä»–é”™è¯¯åˆ†ç±»çš„å¯¹è±¡ä¸­é€æ­¥å­¦ä¹ æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªè¿™æ ·çš„å¼ºæ¨¡å‹ã€‚è¿™é‡Œæåˆ°çš„åˆ†ç±»å™¨å¯ä»¥æ˜¯ä»»ä½•åŸºæœ¬åˆ†ç±»å™¨ï¼Œä»å†³ç­–æ ‘ï¼ˆé€šå¸¸æ˜¯é»˜è®¤çš„ï¼‰åˆ°é€»è¾‘å›å½’ç­‰ã€‚</p><p>æ­¥éª¤1ï¼šåŸºäºåŠ æƒæ ·æœ¬åœ¨è®­ç»ƒæ•°æ®ä¹‹ä¸Šè¿›è¡Œå¼±åˆ†ç±»å™¨ï¼ˆä¾‹å¦‚decision stumpï¼‰.æ¯ä¸ªæ ·æœ¬çš„æƒé‡è¡¨æ˜æ­£ç¡®åˆ†ç±»çš„é‡è¦æ€§ã€‚æœ€åˆï¼Œå¯¹äºç¬¬ä¸€ä¸ªstump,æˆ‘ä»¬ç»™äºˆæ‰€æœ‰æ ·æœ¬ç›¸ç­‰çš„æƒé‡ã€‚</p><p>ç¬¬2æ­¥ï¼šæˆ‘ä»¬ä¸ºæ¯ä¸ªå˜é‡åˆ›å»ºä¸€ä¸ªå†³ç­–æ ‘æ¡©,çœ‹çœ‹æ¯ä¸ªæ ‘æ¡©å°†æ ·æœ¬åˆ†ç±»åˆ°ç›®æ ‡ç±»çš„æ•ˆæœå¦‚ä½•.</p><p>æ­¥éª¤3ï¼šå°†æ›´å¤šçš„æƒé‡åˆ†é…ç»™åˆ†ç±»é”™è¯¯çš„æ ·æœ¬,ä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªå†³ç­–é˜¶æ®µå¯¹å…¶è¿›è¡Œæ­£ç¡®åˆ†ç±».æƒé‡ä¹Ÿæ ¹æ®åˆ†ç±»å™¨çš„ç²¾åº¦åˆ†é…ç»™æ¯ä¸ªåˆ†ç±»å™¨,è¿™æ„å‘³ç€é«˜ç²¾åº¦=é«˜æƒé‡</p><p>ç¬¬4æ­¥ï¼šä»ç¬¬2æ­¥å¼€å§‹é‡å¤,ç›´åˆ°æ‰€æœ‰æ•°æ®ç‚¹éƒ½è¢«æ­£ç¡®åˆ†ç±»,æˆ–è€…è¾¾åˆ°æœ€å¤§è¿­ä»£çº§åˆ«.</p><p>é¦–å…ˆç»™æ¯ä¸ªæ ·æœ¬ç›¸åŒæƒé‡,è®¡ç®—å¾—åˆ°çš„é¢„æµ‹ç»“æœé”™è¯¯ç‡,æ ¹æ®é”™è¯¯ç‡å¾—åˆ°Î±</p><script type="math/tex; mode=display">error = sum(w(i) * terror(i)) / sum(w) \\terror = 0 if(y == p), otherwise 1</script><script type="math/tex; mode=display">\alpha_t=\frac12ln\frac{(1-TotalError)}{TotalError}</script><p>ç„¶åå¯¹æƒé‡è¿›è¡Œæ›´æ–°</p><script type="math/tex; mode=display">w_i=w_{i-1}*e^{\pm\alpha}</script><p>å½“é¢„æµ‹è¾“å‡ºå’Œå®é™…è¾“å‡ºä¸€è‡´æ—¶ï¼ˆæ ·æœ¬åˆ†ç±»æ­£ç¡®ï¼‰ï¼ŒAlphaä¸ºæ­£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡å°‘äº†æ ·æƒé‡ï¼Œå› ä¸ºå·²ç»è¡¨ç°å¾—å¾ˆå¥½äº†ã€‚</p><p>å½“é¢„æµ‹è¾“å‡ºä¸å®é™…ç±»åˆ«ä¸ä¸€è‡´æ—¶ï¼ˆå³æ ·æœ¬åˆ†ç±»é”™è¯¯ï¼‰ï¼ŒAlphaä¸ºè´Ÿå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦å¢åŠ æ ·æœ¬æƒé‡ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªæ ‘æ¡©ä¸­ä¸ä¼šé‡å¤ç›¸åŒçš„é”™è¯¯åˆ†ç±»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Created on Nov 28, 2010</span></span><br><span class="line"><span class="string">Adaboost is short for Adaptive Boosting</span></span><br><span class="line"><span class="string">@author: Peter</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadSimpData</span>():</span></span><br><span class="line">    datMat = matrix([[ <span class="number">1.</span> ,  <span class="number">2.1</span>],</span><br><span class="line">        [ <span class="number">2.</span> ,  <span class="number">1.1</span>],</span><br><span class="line">        [ <span class="number">1.3</span>,  <span class="number">1.</span> ],</span><br><span class="line">        [ <span class="number">1.</span> ,  <span class="number">1.</span> ],</span><br><span class="line">        [ <span class="number">2.</span> ,  <span class="number">1.</span> ]])</span><br><span class="line">    classLabels = [<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>]</span><br><span class="line">    <span class="keyword">return</span> datMat,classLabels</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadDataSet</span>(<span class="params">fileName</span>):</span>      <span class="comment">#general function to parse tab -delimited floats</span></span><br><span class="line">    numFeat = <span class="built_in">len</span>(<span class="built_in">open</span>(fileName).readline().split(<span class="string">&#x27;\t&#x27;</span>)) <span class="comment">#get number of fields </span></span><br><span class="line">    dataMat = []; labelMat = []</span><br><span class="line">    fr = <span class="built_in">open</span>(fileName)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fr.readlines():</span><br><span class="line">        lineArr =[]</span><br><span class="line">        curLine = line.strip().split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(numFeat-<span class="number">1</span>):</span><br><span class="line">            lineArr.append(<span class="built_in">float</span>(curLine[i]))</span><br><span class="line">        dataMat.append(lineArr)</span><br><span class="line">        labelMat.append(<span class="built_in">float</span>(curLine[-<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">return</span> dataMat,labelMat</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stumpClassify</span>(<span class="params">dataMatrix,dimen,threshVal,threshIneq</span>):</span><span class="comment">#just classify the data</span></span><br><span class="line">    retArray = ones((shape(dataMatrix)[<span class="number">0</span>],<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> threshIneq == <span class="string">&#x27;lt&#x27;</span>:</span><br><span class="line">        retArray[dataMatrix[:,dimen] &lt;= threshVal] = -<span class="number">1.0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        retArray[dataMatrix[:,dimen] &gt; threshVal] = -<span class="number">1.0</span></span><br><span class="line">    <span class="keyword">return</span> retArray</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildStump</span>(<span class="params">dataArr,classLabels,D</span>):</span></span><br><span class="line">    dataMatrix = mat(dataArr); labelMat = mat(classLabels).T</span><br><span class="line">    m,n = shape(dataMatrix)</span><br><span class="line">    numSteps = <span class="number">10.0</span>; bestStump = &#123;&#125;; bestClasEst = mat(zeros((m,<span class="number">1</span>)))</span><br><span class="line">    minError = inf <span class="comment">#init error sum, to +infinity</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):<span class="comment">#loop over all dimensions</span></span><br><span class="line">        rangeMin = dataMatrix[:,i].<span class="built_in">min</span>(); rangeMax = dataMatrix[:,i].<span class="built_in">max</span>();</span><br><span class="line">        stepSize = (rangeMax-rangeMin)/numSteps</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">1</span>,<span class="built_in">int</span>(numSteps)+<span class="number">1</span>):<span class="comment">#loop over all range in current dimension</span></span><br><span class="line">            <span class="keyword">for</span> inequal <span class="keyword">in</span> [<span class="string">&#x27;lt&#x27;</span>, <span class="string">&#x27;gt&#x27;</span>]: <span class="comment">#go over less than and greater than</span></span><br><span class="line">                threshVal = (rangeMin + <span class="built_in">float</span>(j) * stepSize)</span><br><span class="line">                predictedVals = stumpClassify(dataMatrix,i,threshVal,inequal)<span class="comment">#call stump classify with i, j, lessThan</span></span><br><span class="line">                errArr = mat(ones((m,<span class="number">1</span>)))</span><br><span class="line">                errArr[predictedVals == labelMat] = <span class="number">0</span></span><br><span class="line">                weightedError = D.T*errArr  <span class="comment">#calc total error multiplied by D</span></span><br><span class="line">                <span class="comment">#print &quot;split: dim %d, thresh %.2f, thresh ineqal: %s, the weighted error is %.3f&quot; % (i, threshVal, inequal, weightedError)</span></span><br><span class="line">                <span class="keyword">if</span> weightedError &lt; minError:</span><br><span class="line">                    minError = weightedError</span><br><span class="line">                    bestClasEst = predictedVals.copy()</span><br><span class="line">                    bestStump[<span class="string">&#x27;dim&#x27;</span>] = i</span><br><span class="line">                    bestStump[<span class="string">&#x27;thresh&#x27;</span>] = threshVal</span><br><span class="line">                    bestStump[<span class="string">&#x27;ineq&#x27;</span>] = inequal</span><br><span class="line">    <span class="keyword">return</span> bestStump,minError,bestClasEst</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adaBoostTrainDS</span>(<span class="params">dataArr,classLabels,numIt=<span class="number">40</span></span>):</span></span><br><span class="line">    weakClassArr = []</span><br><span class="line">    m = shape(dataArr)[<span class="number">0</span>]</span><br><span class="line">    D = mat(ones((m,<span class="number">1</span>))/m)   <span class="comment">#init D to all equal</span></span><br><span class="line">    aggClassEst = mat(zeros((m,<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(numIt):</span><br><span class="line">        bestStump,error,classEst = buildStump(dataArr,classLabels,D)<span class="comment">#build Stump</span></span><br><span class="line">        <span class="comment">#print &quot;D:&quot;,D.T</span></span><br><span class="line">        alpha = <span class="built_in">float</span>(<span class="number">0.5</span>*log((<span class="number">1.0</span>-error)/<span class="built_in">max</span>(error,<span class="number">1e-16</span>)))<span class="comment">#calc alpha, throw in max(error,eps) to account for error=0</span></span><br><span class="line">        bestStump[<span class="string">&#x27;alpha&#x27;</span>] = alpha  </span><br><span class="line">        weakClassArr.append(bestStump)                  <span class="comment">#store Stump Params in Array</span></span><br><span class="line">        <span class="comment">#print &quot;classEst: &quot;,classEst.T</span></span><br><span class="line">        expon = multiply(-<span class="number">1</span>*alpha*mat(classLabels).T,classEst) <span class="comment">#exponent for D calc, getting messy</span></span><br><span class="line">        D = multiply(D,exp(expon))                              <span class="comment">#Calc New D for next iteration</span></span><br><span class="line">        D = D/D.<span class="built_in">sum</span>()</span><br><span class="line">        <span class="comment">#calc training error of all classifiers, if this is 0 quit for loop early (use break)</span></span><br><span class="line">        aggClassEst += alpha*classEst</span><br><span class="line">        <span class="comment">#print &quot;aggClassEst: &quot;,aggClassEst.T</span></span><br><span class="line">        aggErrors = multiply(sign(aggClassEst) != mat(classLabels).T,ones((m,<span class="number">1</span>)))</span><br><span class="line">        errorRate = aggErrors.<span class="built_in">sum</span>()/m</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;total error: &quot;</span>,errorRate</span><br><span class="line">        <span class="keyword">if</span> errorRate == <span class="number">0.0</span>: <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> weakClassArr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adaClassify</span>(<span class="params">datToClass,classifierArr</span>):</span></span><br><span class="line">    dataMatrix = mat(datToClass)<span class="comment">#do stuff similar to last aggClassEst in adaBoostTrainDS</span></span><br><span class="line">    m = shape(dataMatrix)[<span class="number">0</span>]</span><br><span class="line">    aggClassEst = mat(zeros((m,<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classifierArr)):</span><br><span class="line">        classEst = stumpClassify(dataMatrix, classifierArr[i][<span class="string">&#x27;dim&#x27;</span>],\</span><br><span class="line">                                 classifierArr[i][<span class="string">&#x27;thresh&#x27;</span>],\</span><br><span class="line">                                 classifierArr[i][<span class="string">&#x27;ineq&#x27;</span>])<span class="comment">#call stump classify</span></span><br><span class="line">        aggClassEst += classifierArr[i][<span class="string">&#x27;alpha&#x27;</span>]*classEst</span><br><span class="line">        <span class="built_in">print</span> aggClassEst</span><br><span class="line">    <span class="keyword">return</span> sign(aggClassEst)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plotROC</span>(<span class="params">predStrengths, classLabels</span>):</span></span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    cur = (<span class="number">1.0</span>,<span class="number">1.0</span>) <span class="comment">#cursor</span></span><br><span class="line">    ySum = <span class="number">0.0</span> <span class="comment">#variable to calculate AUC</span></span><br><span class="line">    numPosClas = <span class="built_in">sum</span>(array(classLabels)==<span class="number">1.0</span>)</span><br><span class="line">    yStep = <span class="number">1</span>/<span class="built_in">float</span>(numPosClas); xStep = <span class="number">1</span>/<span class="built_in">float</span>(<span class="built_in">len</span>(classLabels)-numPosClas)</span><br><span class="line">    sortedIndicies = predStrengths.argsort()<span class="comment">#get sorted index, it&#x27;s reverse</span></span><br><span class="line">    fig = plt.figure()</span><br><span class="line">    fig.clf()</span><br><span class="line">    ax = plt.subplot(<span class="number">111</span>)</span><br><span class="line">    <span class="comment">#loop through all the values, drawing a line segment at each point</span></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> sortedIndicies.tolist()[<span class="number">0</span>]:</span><br><span class="line">        <span class="keyword">if</span> classLabels[index] == <span class="number">1.0</span>:</span><br><span class="line">            delX = <span class="number">0</span>; delY = yStep;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            delX = xStep; delY = <span class="number">0</span>;</span><br><span class="line">            ySum += cur[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">#draw line from cur to (cur[0]-delX,cur[1]-delY)</span></span><br><span class="line">        ax.plot([cur[<span class="number">0</span>],cur[<span class="number">0</span>]-delX],[cur[<span class="number">1</span>],cur[<span class="number">1</span>]-delY], c=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">        cur = (cur[<span class="number">0</span>]-delX,cur[<span class="number">1</span>]-delY)</span><br><span class="line">    ax.plot([<span class="number">0</span>,<span class="number">1</span>],[<span class="number">0</span>,<span class="number">1</span>],<span class="string">&#x27;b--&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;False positive rate&#x27;</span>); plt.ylabel(<span class="string">&#x27;True positive rate&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;ROC curve for AdaBoost horse colic detection system&#x27;</span>)</span><br><span class="line">    ax.axis([<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line">    plt.show()</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;the Area Under the Curve is: &quot;</span>,ySum*xStep</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://machinelearningmastery.com/boosting-and-adaboost-for-machine-learning/">Boosting and AdaBoost for Machine Learning - MachineLearningMastery.com</a></li><li><a href="https://machinelearningmastery.com/gentle-introduction-xgboost-applied-machine-learning/">A Gentle Introduction to XGBoost for Applied Machine Learning - MachineLearningMastery.com</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ æ–¹æ³•,ç°åœ¨ç”¨å¾—ä¸å¤šäº†(è‡ªæˆ‘æ„Ÿè§‰).ä½†æ˜¯æœ‰å¿…è¦ç¨å¾®äº†è§£ä¸€ä¸‹åŸç†ã€‚&lt;br&gt;</summary>
    
    
    
    
    <category term="Ensemble Learning" scheme="https://www.sekyoro.top/tags/Ensemble-Learning/"/>
    
  </entry>
  
  <entry>
    <title>æ·±åº¦å­¦ä¹ æœ‰ç”¨çš„åº“ä»¥åŠä»‹ç»</title>
    <link href="https://www.sekyoro.top/2024/02/19/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%9C%89%E7%94%A8%E7%9A%84%E5%BA%93%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/"/>
    <id>https://www.sekyoro.top/2024/02/19/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%9C%89%E7%94%A8%E7%9A%84%E5%BA%93%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/</id>
    <published>2024-02-19T07:49:03.000Z</published>
    <updated>2024-02-23T07:07:03.166Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>åœ¨çœ‹å…¶ä»–æºä»£ç æ—¶ä»¥åŠè‡ªå·±å†™ä»£ç æ—¶å¯èƒ½ç”¨åˆ°çš„æœ‰ç”¨çš„åº“ä»¥åŠä¸€äº›å¸¸ç”¨å†™æ³•.<br><span id="more"></span></p><h2 id="pythonè‡ªå¸¦çš„åº“"><a href="#pythonè‡ªå¸¦çš„åº“" class="headerlink" title="pythonè‡ªå¸¦çš„åº“"></a>pythonè‡ªå¸¦çš„åº“</h2><h3 id="itertools"><a href="#itertools" class="headerlink" title="itertools"></a>itertools</h3><p>ç”¨äºè¿­ä»£å™¨çš„å·¥å…·<a href="https://docs.python.org/zh-cn/3/library/itertools.html">itertools â€”- ä¸ºé«˜æ•ˆå¾ªç¯è€Œåˆ›å»ºè¿­ä»£å™¨çš„å‡½æ•° â€” Python 3.12.2 æ–‡æ¡£</a></p><h3 id="functools"><a href="#functools" class="headerlink" title="functools"></a>functools</h3><p>ç”¨äºå¤„ç†å‡½æ•°çš„å·¥å…·</p><h3 id="collections"><a href="#collections" class="headerlink" title="collections"></a>collections</h3><p>é›†åˆå·¥å…·</p><h2 id="æ·±åº¦å­¦ä¹ åº“"><a href="#æ·±åº¦å­¦ä¹ åº“" class="headerlink" title="æ·±åº¦å­¦ä¹ åº“"></a>æ·±åº¦å­¦ä¹ åº“</h2><h3 id="timm"><a href="#timm" class="headerlink" title="timm"></a>timm</h3><h3 id="einops"><a href="#einops" class="headerlink" title="einops"></a>einops</h3><h3 id="from-torch-import-einsum"><a href="#from-torch-import-einsum" class="headerlink" title="from torch import einsum"></a>from torch import einsum</h3><h2 id="transformers"><a href="#transformers" class="headerlink" title="transformers"></a>transformers</h2><h2 id="accelerate"><a href="#accelerate" class="headerlink" title="accelerate"></a>accelerate</h2><h2 id="ä¸€äº›å¸¸ç”¨ä»£ç "><a href="#ä¸€äº›å¸¸ç”¨ä»£ç " class="headerlink" title="ä¸€äº›å¸¸ç”¨ä»£ç "></a>ä¸€äº›å¸¸ç”¨ä»£ç </h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seed = <span class="number">2024</span></span><br><span class="line">random.seed(seed)</span><br><span class="line">torch.manual_seed(seed)</span><br><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    torch.cuda.manual_seed(seed)</span><br><span class="line">    torch.cuda.manual_seed_all(seed)</span><br><span class="line">np.random.seed(seed)</span><br><span class="line">torch.backends.cudnn.benchmark = <span class="literal">False</span></span><br><span class="line">torch.backends.cudnn.deterministic = <span class="literal">True</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.optim <span class="keyword">import</span> Optimizer</span><br><span class="line"><span class="keyword">from</span> torch.optim.lr_scheduler <span class="keyword">import</span> LambdaLR</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cosine_schedule_with_warmup</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">optimizer: Optimizer,</span></span></span><br><span class="line"><span class="params"><span class="function">num_warmup_steps: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">num_training_steps: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">num_cycles: <span class="built_in">float</span> = <span class="number">0.5</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">last_epoch: <span class="built_in">int</span> = -<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>):</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Create a schedule with a learning rate that decreases following the values of the cosine function between the</span></span><br><span class="line"><span class="string">initial lr set in the optimizer to 0, after a warmup period during which it increases linearly between 0 and the</span></span><br><span class="line"><span class="string">initial lr set in the optimizer.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Args:</span></span><br><span class="line"><span class="string">optimizer (:class:`~torch.optim.Optimizer`):</span></span><br><span class="line"><span class="string">The optimizer for which to schedule the learning rate.</span></span><br><span class="line"><span class="string">num_warmup_steps (:obj:`int`):</span></span><br><span class="line"><span class="string">The number of steps for the warmup phase.</span></span><br><span class="line"><span class="string">num_training_steps (:obj:`int`):</span></span><br><span class="line"><span class="string">The total number of training steps.</span></span><br><span class="line"><span class="string">num_cycles (:obj:`float`, `optional`, defaults to 0.5):</span></span><br><span class="line"><span class="string">The number of waves in the cosine schedule (the defaults is to just decrease from the max value to 0</span></span><br><span class="line"><span class="string">following a half-cosine).</span></span><br><span class="line"><span class="string">last_epoch (:obj:`int`, `optional`, defaults to -1):</span></span><br><span class="line"><span class="string">The index of the last epoch when resuming training.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Return:</span></span><br><span class="line"><span class="string">:obj:`torch.optim.lr_scheduler.LambdaLR` with the appropriate schedule.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lr_lambda</span>(<span class="params">current_step</span>):</span></span><br><span class="line"><span class="comment"># Warmup</span></span><br><span class="line"><span class="keyword">if</span> current_step &lt; num_warmup_steps:</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">float</span>(current_step) / <span class="built_in">float</span>(<span class="built_in">max</span>(<span class="number">1</span>, num_warmup_steps))</span><br><span class="line"><span class="comment"># decadence</span></span><br><span class="line">progress = <span class="built_in">float</span>(current_step - num_warmup_steps) / <span class="built_in">float</span>(</span><br><span class="line"><span class="built_in">max</span>(<span class="number">1</span>, num_training_steps - num_warmup_steps)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">max</span>(</span><br><span class="line"><span class="number">0.0</span>, <span class="number">0.5</span> * (<span class="number">1.0</span> + math.cos(math.pi * <span class="built_in">float</span>(num_cycles) * <span class="number">2.0</span> * progress))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> LambdaLR(optimizer, lr_lambda, last_epoch)</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›æœ‰ç”¨çš„èµ„æ–™"><a href="#ä¸€äº›æœ‰ç”¨çš„èµ„æ–™" class="headerlink" title="ä¸€äº›æœ‰ç”¨çš„èµ„æ–™"></a>ä¸€äº›æœ‰ç”¨çš„èµ„æ–™</h2><ol><li><a href="https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-deep-learning-tips-and-tricks">CS 230 - Deep Learning Tips and Tricks Cheatsheet (stanford.edu)</a></li><li><a href="https://github.com/Conchylicultor/Deep-Learning-Tricks">Conchylicultor/Deep-Learning-Tricks: Enumerate diverse machine learning training tricks. (github.com)</a></li><li><a href="https://github.com/ayyucedemirbas/Deep-Learning-Tips-and-Tricks">ayyucedemirbas/Deep-Learning-Tips-and-Tricks (github.com)</a></li><li>æ‰¾ä¸€äº›æ¨¡å‹ä»£ç <a href="https://github.com/huggingface/pytorch-image-models">huggingface/pytorch-image-models: PyTorch image models, scripts, pretrained weights â€” ResNet, ResNeXT, EfficientNet, NFNet, Vision Transformer (ViT), MobileNet-V3/V2, RegNet, DPN, CSPNet, Swin Transformer, MaxViT, CoAtNet, ConvNeXt, and more (github.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨çœ‹å…¶ä»–æºä»£ç æ—¶ä»¥åŠè‡ªå·±å†™ä»£ç æ—¶å¯èƒ½ç”¨åˆ°çš„æœ‰ç”¨çš„åº“ä»¥åŠä¸€äº›å¸¸ç”¨å†™æ³•.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>transformer and attention(ä¸‰)</title>
    <link href="https://www.sekyoro.top/2024/02/16/transformer-and-attention-%E4%B8%89/"/>
    <id>https://www.sekyoro.top/2024/02/16/transformer-and-attention-%E4%B8%89/</id>
    <published>2024-02-16T14:44:00.000Z</published>
    <updated>2024-02-21T15:14:28.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>è¿™é‡Œä»‹ç»ä¸€äº›ç»†èŠ‚ä¿¡æ¯.æœ‰å…³ä½ç½®ç¼–ç ä¿¡æ¯å’Œç”¨äºå›¾åƒçš„transformer.<br><span id="more"></span></p><h2 id="çº¿æ€§æ³¨æ„åŠ›"><a href="#çº¿æ€§æ³¨æ„åŠ›" class="headerlink" title="çº¿æ€§æ³¨æ„åŠ›"></a>çº¿æ€§æ³¨æ„åŠ›</h2><script type="math/tex; mode=display">Attention(\boldsymbol{Q},\boldsymbol{K},\boldsymbol{V})=softmax\left(\boldsymbol{Q}\boldsymbol{K}^\top\right)\boldsymbol{V}</script><p>å…¶ä¸­$Q\in\mathbb{R}^{n\times d_k},\boldsymbol{K}\in\mathbb{R}^{m\times d_k},\boldsymbol{V}\in\mathbb{R}^{m\times d_v}$â€‹,ä¸€èˆ¬æƒ…å†µä¸‹n&gt;dç”šè‡³n&gt;&gt;d.æ‰€ä»¥å¦‚æœå¯¹QK^T^è¿›è¡Œsoftmaxæ“ä½œ,å¤æ‚åº¦ä¸ºO(mn),æ‰€ä»¥å»æ‰Softmaxçš„Attentionçš„å¤æ‚åº¦å¯ä»¥é™åˆ°æœ€ç†æƒ³çš„çº¿æ€§çº§åˆ«Linear Attention.</p><script type="math/tex; mode=display">Attention(\boldsymbol{Q},\boldsymbol{K},\boldsymbol{V})_i=\frac{\sum_{j=1}^nsim(\boldsymbol{q}_i,\boldsymbol{k}_j)\boldsymbol{v}_j}{\sum_{j=1}^nsim(\boldsymbol{q}_i,\boldsymbol{k}_j)}</script><p>åªè¦ä¿è¯Attentionç›¸ä¼¼çš„åˆ†å¸ƒç‰¹æ€§,è¦æ±‚sim(q~i~,k~j~)â‰¥0æ’æˆç«‹.æ¯”å¦‚å¯ä»¥æŠŠæ ¸å‡½æ•°æ”¹ä¸ºæ¿€æ´»å‡½æ•°ä½¿å¾—è¾“å‡ºå¤§äº0.</p><p>è¿˜å¯ä»¥æ”¹æˆsoftmax.</p><p><img data-src="https://s2.loli.net/2024/02/17/wE3HgYJ7KnxZ5pe.png" alt="image-20240217224419083"></p><p>å…¶ä¸­softmax1ã€softmax2åˆ†åˆ«æŒ‡åœ¨ç¬¬ä¸€ä¸ªï¼ˆnï¼‰ã€ç¬¬äºŒä¸ªç»´åº¦ï¼ˆdï¼‰è¿›è¡ŒSoftmaxè¿ç®—.</p><p><a href="https://spaces.ac.cn/archives/7546">çº¿æ€§Attentionçš„æ¢ç´¢ï¼šAttentionå¿…é¡»æœ‰ä¸ªSoftmaxå—ï¼Ÿ - ç§‘å­¦ç©ºé—´|Scientific Spaces</a>æå‡ºå°†æŒ‡æ•°</p><p>e^qK^æ³°å‹’å±•å¼€,$e^{\boldsymbol{q}_i^\top\boldsymbol{k}_j}\approx1+\boldsymbol{q}_i^\top\boldsymbol{k}_j$</p><p><img data-src="https://s2.loli.net/2024/02/17/fhBMIgcsqzZQt3k.png" alt="image-20240217224836831"></p><p>æ­¤å¤–è¿˜æœ‰ç¨€ç–æ³¨æ„åŠ›,è¿™é‡Œå°±ä¸å¤šä»‹ç»äº†.</p><h2 id="å›¾åƒä¸­çš„transformerä¸attention"><a href="#å›¾åƒä¸­çš„transformerä¸attention" class="headerlink" title="å›¾åƒä¸­çš„transformerä¸attention"></a>å›¾åƒä¸­çš„transformerä¸attention</h2><p>æ³¨æ„åŠ›æœºåˆ¶ä»¥åŠtransformeréƒ½æ˜¯å…ˆåœ¨NLPé¢†åŸŸå‘å±•,æ‰€ä»¥ä¸€èˆ¬attentionå¯èƒ½ä¼šå¤„ç†ä¸€äº›1ç»´æ•°æ®,æœ‰CNNä¸transformerç»“åˆçš„Conformer<a href="https://arxiv.org/abs/2005.08100">[2005.08100] Conformer: Convolution-augmented Transformer for Speech Recognition (arxiv.org)</a>,conformerä¸­çš„ç¼–ç é‡‡ç”¨ç›¸å¯¹ä½ç½®ç¼–ç .</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> einops <span class="keyword">import</span> rearrange</span><br><span class="line"><span class="keyword">from</span> einops.layers.torch <span class="keyword">import</span> Rearrange</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn, einsum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exists</span>(<span class="params">val</span>):</span></span><br><span class="line">    <span class="keyword">return</span> val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">default</span>(<span class="params">val, d</span>):</span></span><br><span class="line">    <span class="keyword">return</span> val <span class="keyword">if</span> exists(val) <span class="keyword">else</span> d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swish</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x * x.sigmoid()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedForward</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, mult=<span class="number">4</span>, dropout=<span class="number">0.0</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.net = nn.Sequential(</span><br><span class="line">            nn.Linear(dim, dim * mult),</span><br><span class="line">            Swish(),  <span class="comment"># or can be replace by nn.silu()</span></span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">            nn.Linear(dim * mult, dim),</span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.net(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, heads=<span class="number">8</span>, dim_head=<span class="number">64</span>, dropout=<span class="number">0.0</span>, max_pos_emb=<span class="number">512</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        inner_dim = dim_head * heads</span><br><span class="line">        self.heads = heads</span><br><span class="line">        self.scale = dim_head**-<span class="number">0.5</span></span><br><span class="line">        self.to_q = nn.Linear(dim, inner_dim, bias=<span class="literal">False</span>)</span><br><span class="line">        self.to_kv = nn.Linear(dim, inner_dim * <span class="number">2</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.to_out = nn.Linear(inner_dim, dim)</span><br><span class="line"></span><br><span class="line">        self.max_pos_emb = max_pos_emb</span><br><span class="line">        self.rel_pos_emb = nn.Embedding(<span class="number">2</span> * max_pos_emb + <span class="number">1</span>, dim_head)</span><br><span class="line"></span><br><span class="line">        self.dropout = nn.Dropout(dropout)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, context=<span class="literal">None</span>, mask=<span class="literal">None</span>, context_mask=<span class="literal">None</span></span>):</span></span><br><span class="line">        n, device, h, max_pos_emb, has_context = (</span><br><span class="line">            x.shape[-<span class="number">2</span>],</span><br><span class="line">            x.device,</span><br><span class="line">            self.heads,</span><br><span class="line">            self.max_pos_emb,</span><br><span class="line">            exists(context),</span><br><span class="line">        )</span><br><span class="line">        context = default(context, x)</span><br><span class="line"></span><br><span class="line">        q, k, v = (self.to_q(x), *self.to_kv(context).chunk(<span class="number">2</span>, dim=-<span class="number">1</span>))</span><br><span class="line">        q, k, v = <span class="built_in">map</span>(<span class="keyword">lambda</span> t: rearrange(t, <span class="string">&quot;b n (h d) -&gt; b h n d&quot;</span>, h=h), (q, k, v))</span><br><span class="line"></span><br><span class="line">        dots = einsum(<span class="string">&quot;b h i d, b h j d -&gt; b h i j&quot;</span>, q, k) * self.scale</span><br><span class="line"></span><br><span class="line">        <span class="comment"># shaw&#x27;s relative positional embedding</span></span><br><span class="line">        seq = torch.arange(n, device=device)</span><br><span class="line">        dist = rearrange(seq, <span class="string">&quot;i -&gt; i ()&quot;</span>) - rearrange(seq, <span class="string">&quot;j -&gt; () j&quot;</span>)</span><br><span class="line">        dist = dist.clamp(-max_pos_emb, max_pos_emb) + max_pos_emb</span><br><span class="line">        rel_pos_emb = self.rel_pos_emb(dist).to(q)</span><br><span class="line">        pos_attn = einsum(<span class="string">&quot;b h n d, n r d -&gt; b h n r&quot;</span>, q, rel_pos_emb) * self.scale</span><br><span class="line">        dots = dots + pos_attn</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> exists(mask) <span class="keyword">or</span> exists(context_mask):</span><br><span class="line">            mask = default(mask, <span class="keyword">lambda</span>: torch.ones(*x.shape[:<span class="number">2</span>], device=device))</span><br><span class="line">            context_mask = (</span><br><span class="line">                default(context_mask, mask)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> has_context</span><br><span class="line">                <span class="keyword">else</span> default(</span><br><span class="line">                    context_mask, <span class="keyword">lambda</span>: torch.ones(*context.shape[:<span class="number">2</span>], device=device)</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            mask_value = -torch.finfo(dots.dtype).<span class="built_in">max</span></span><br><span class="line">            mask = rearrange(mask, <span class="string">&quot;b i -&gt; b () i ()&quot;</span>) * rearrange(</span><br><span class="line">                context_mask, <span class="string">&quot;b j -&gt; b () () j&quot;</span></span><br><span class="line">            )</span><br><span class="line">            dots.masked_fill_(~mask, mask_value)</span><br><span class="line"></span><br><span class="line">        attn = dots.softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        out = einsum(<span class="string">&quot;b h i j, b h j d -&gt; b h i d&quot;</span>, attn, v)</span><br><span class="line">        out = rearrange(out, <span class="string">&quot;b h n d -&gt; b n (h d)&quot;</span>)</span><br><span class="line">        out = self.to_out(out)</span><br><span class="line">        <span class="keyword">return</span> self.dropout(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_same_padding</span>(<span class="params">kernel_size</span>):</span></span><br><span class="line">    pad = kernel_size // <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> pad, pad - (kernel_size + <span class="number">1</span>) % <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DepthWiseConv1d</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, chan_in, chan_out, kernel_size, padding</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.padding = padding</span><br><span class="line">        self.conv = nn.Conv1d(chan_in, chan_out, kernel_size, groups=chan_in)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = F.pad(x, self.padding)</span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GLU</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.dim = dim</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        out, gate = x.chunk(<span class="number">2</span>, dim=self.dim)</span><br><span class="line">        <span class="keyword">return</span> out * gate.sigmoid()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConformerConvModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self, dim, causal=<span class="literal">False</span>, expansion_factor=<span class="number">2</span>, kernel_size=<span class="number">31</span>, dropout=<span class="number">0.0</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        inner_dim = dim * expansion_factor</span><br><span class="line">        padding = calc_same_padding(kernel_size) <span class="keyword">if</span> <span class="keyword">not</span> causal <span class="keyword">else</span> (kernel_size - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        self.net = nn.Sequential(</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">            Rearrange(<span class="string">&quot;b n d -&gt; b d n&quot;</span>),</span><br><span class="line">            nn.Conv1d(dim, inner_dim * <span class="number">2</span>, <span class="number">1</span>),</span><br><span class="line">            GLU(dim=<span class="number">1</span>),</span><br><span class="line">            DepthWiseConv1d(</span><br><span class="line">                inner_dim, inner_dim, kernel_size=kernel_size, padding=padding</span><br><span class="line">            ),</span><br><span class="line">            nn.BatchNorm1d(inner_dim) <span class="keyword">if</span> <span class="keyword">not</span> causal <span class="keyword">else</span> nn.Identity(),</span><br><span class="line">            Swish(),</span><br><span class="line">            nn.Conv1d(inner_dim, dim, <span class="number">1</span>),</span><br><span class="line">            Rearrange(<span class="string">&quot;b d n -&gt; b n d&quot;</span>),</span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.net(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scale</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, scale, fn</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.scale = scale</span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.fn(x, **kwargs) * self.scale</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PreNorm</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, fn</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.fn = fn</span><br><span class="line">        self.norm = nn.LayerNorm(dim)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, **kwargs</span>):</span></span><br><span class="line">        x = self.norm(x)</span><br><span class="line">        <span class="keyword">return</span> self.fn(x, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConformerBlock</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        *,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim_head=<span class="number">64</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        heads=<span class="number">8</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        ff_mult=<span class="number">4</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_expansion_factor=<span class="number">2</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_kernel_size=<span class="number">31</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attn_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        ff_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_causal=<span class="literal">False</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.ff1 = FeedForward(dim=dim, mult=ff_mult, dropout=ff_dropout)</span><br><span class="line">        self.attn = Attention(</span><br><span class="line">            dim=dim, dim_head=dim_head, heads=heads, dropout=attn_dropout</span><br><span class="line">        )</span><br><span class="line">        self.conv = ConformerConvModule(</span><br><span class="line">            dim=dim,</span><br><span class="line">            causal=conv_causal,</span><br><span class="line">            expansion_factor=conv_expansion_factor,</span><br><span class="line">            kernel_size=conv_kernel_size,</span><br><span class="line">            dropout=conv_dropout,</span><br><span class="line">        )</span><br><span class="line">        self.ff2 = FeedForward(dim=dim, mult=ff_mult, dropout=ff_dropout)</span><br><span class="line"></span><br><span class="line">        self.attn = PreNorm(dim, self.attn)</span><br><span class="line">        self.ff1 = Scale(<span class="number">0.5</span>, PreNorm(dim, self.ff1))</span><br><span class="line">        self.ff2 = Scale(<span class="number">0.5</span>, PreNorm(dim, self.ff2))</span><br><span class="line"></span><br><span class="line">        self.post_norm = nn.LayerNorm(dim)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask=<span class="literal">None</span></span>):</span></span><br><span class="line">        x = self.ff1(x) + x</span><br><span class="line">        x = self.attn(x, mask=mask) + x</span><br><span class="line">        x = self.conv(x) + x</span><br><span class="line">        x = self.ff2(x) + x</span><br><span class="line">        x = self.post_norm(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        *,</span></span></span><br><span class="line"><span class="params"><span class="function">        depth,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim_head=<span class="number">64</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        heads=<span class="number">8</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        ff_mult=<span class="number">4</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_expansion_factor=<span class="number">2</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_kernel_size=<span class="number">31</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attn_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        ff_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        conv_causal=<span class="literal">False</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.dim = dim</span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            self.layers.append(</span><br><span class="line">                ConformerBlock(</span><br><span class="line">                    dim=dim,</span><br><span class="line">                    dim_head=dim_head,</span><br><span class="line">                    heads=heads,</span><br><span class="line">                    ff_mult=ff_mult,</span><br><span class="line">                    conv_expansion_factor=conv_expansion_factor,</span><br><span class="line">                    conv_kernel_size=conv_kernel_size,</span><br><span class="line">                    conv_causal=conv_causal,</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = block(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šä¸€èŠ‚ä¸­å…¶å®å·²ç»å……åˆ†ä½¿ç”¨äº†feature mapä¹Ÿå°±æ˜¯äºŒç»´æ•°æ®ä¸Šçš„æ³¨æ„åŠ›æœºåˆ¶,ç°åœ¨ä»‹ç»ä¸€ä¸‹åœ¨è§†è§‰é¢†åŸŸè¡¨ç°å‡ºè‰²çš„transformeråŠå…¶å˜ä½“.</p><h2 id="Vision-Transformer"><a href="#Vision-Transformer" class="headerlink" title="Vision Transformer"></a>Vision Transformer</h2><p><img data-src="https://s2.loli.net/2024/02/17/mdybruOEWxgSDVt.png" alt="image-20240217121859843"></p><p>å°†transformeræ‹¿åˆ°CVé¢†åŸŸçš„å‡ºåä½œå“,é€šè¿‡patch embeddingå¾—åˆ°åºåˆ—,å†åŠ ä¸Šä½ç½®ç¼–ç å°±èƒ½åƒåœ¨nlpä¸€æ ·å¤„ç†é—®é¢˜.</p><p><img data-src="https://pic1.zhimg.com/80/v2-1c6aa554d8fc53daa7bf79c755b1f86c_720w.webp" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> einops <span class="keyword">import</span> rearrange</span><br><span class="line"><span class="keyword">from</span> einops.layers.torch <span class="keyword">import</span> Rearrange</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="comment"># helpers</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pair</span>(<span class="params">t</span>):</span></span><br><span class="line">    <span class="keyword">return</span> t <span class="keyword">if</span> <span class="built_in">isinstance</span>(t, <span class="built_in">tuple</span>) <span class="keyword">else</span> (t, t)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">posemb_sincos_2d</span>(<span class="params">h, w, dim, temperature: <span class="built_in">int</span> = <span class="number">10000</span>, dtype=torch.float32</span>):</span></span><br><span class="line">    y, x = torch.meshgrid(torch.arange(h), torch.arange(w), indexing=<span class="string">&quot;ij&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> (dim % <span class="number">4</span>) == <span class="number">0</span>, <span class="string">&quot;feature dimension must be multiple of 4 for sincos emb&quot;</span></span><br><span class="line">    omega = torch.arange(dim // <span class="number">4</span>) / (dim // <span class="number">4</span> - <span class="number">1</span>)</span><br><span class="line">    omega = <span class="number">1.0</span> / (temperature**omega)</span><br><span class="line"></span><br><span class="line">    y = y.flatten()[:, <span class="literal">None</span>] * omega[<span class="literal">None</span>, :]</span><br><span class="line">    x = x.flatten()[:, <span class="literal">None</span>] * omega[<span class="literal">None</span>, :]</span><br><span class="line">    pe = torch.cat((x.sin(), x.cos(), y.sin(), y.cos()), dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> pe.<span class="built_in">type</span>(dtype)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># classes</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedForward</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, hidden_dim</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.net = nn.Sequential(</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">            nn.Linear(dim, hidden_dim),</span><br><span class="line">            nn.GELU(),</span><br><span class="line">            nn.Linear(hidden_dim, dim),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.net(x)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, heads=<span class="number">8</span>, dim_head=<span class="number">64</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        inner_dim = dim_head * heads</span><br><span class="line">        self.heads = heads</span><br><span class="line">        self.scale = dim_head**-<span class="number">0.5</span></span><br><span class="line">        self.norm = nn.LayerNorm(dim)</span><br><span class="line"></span><br><span class="line">        self.attend = nn.Softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.to_qkv = nn.Linear(dim, inner_dim * <span class="number">3</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.to_out = nn.Linear(inner_dim, dim, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.norm(x)</span><br><span class="line"></span><br><span class="line">        qkv = self.to_qkv(x).chunk(<span class="number">3</span>, dim=-<span class="number">1</span>)</span><br><span class="line">        q, k, v = <span class="built_in">map</span>(<span class="keyword">lambda</span> t: rearrange(t, <span class="string">&quot;b n (h d) -&gt; b h n d&quot;</span>, h=self.heads), qkv)</span><br><span class="line"></span><br><span class="line">        dots = torch.matmul(q, k.transpose(-<span class="number">1</span>, -<span class="number">2</span>)) * self.scale</span><br><span class="line"></span><br><span class="line">        attn = self.attend(dots)</span><br><span class="line"></span><br><span class="line">        out = torch.matmul(attn, v)</span><br><span class="line">        out = rearrange(out, <span class="string">&quot;b h n d -&gt; b n (h d)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.to_out(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, depth, heads, dim_head, mlp_dim</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.norm = nn.LayerNorm(dim)</span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            self.layers.append(</span><br><span class="line">                nn.ModuleList(</span><br><span class="line">                    [</span><br><span class="line">                        Attention(dim, heads=heads, dim_head=dim_head),</span><br><span class="line">                        FeedForward(dim, mlp_dim),</span><br><span class="line">                    ]</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">for</span> attn, ff <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = attn(x) + x</span><br><span class="line">            x = ff(x) + x</span><br><span class="line">        <span class="keyword">return</span> self.norm(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleViT</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        *,</span></span></span><br><span class="line"><span class="params"><span class="function">        image_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        patch_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_classes,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        depth,</span></span></span><br><span class="line"><span class="params"><span class="function">        heads,</span></span></span><br><span class="line"><span class="params"><span class="function">        mlp_dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        channels=<span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim_head=<span class="number">64</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        image_height, image_width = pair(image_size)</span><br><span class="line">        patch_height, patch_width = pair(patch_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> (</span><br><span class="line">            image_height % patch_height == <span class="number">0</span> <span class="keyword">and</span> image_width % patch_width == <span class="number">0</span></span><br><span class="line">        ), <span class="string">&quot;Image dimensions must be divisible by the patch size.&quot;</span></span><br><span class="line"></span><br><span class="line">        patch_dim = channels * patch_height * patch_width</span><br><span class="line"></span><br><span class="line">        self.to_patch_embedding = nn.Sequential(</span><br><span class="line">            Rearrange(</span><br><span class="line">                <span class="string">&quot;b c (h p1) (w p2) -&gt; b (h w) (p1 p2 c)&quot;</span>,</span><br><span class="line">                p1=patch_height,</span><br><span class="line">                p2=patch_width,</span><br><span class="line">            ),</span><br><span class="line">            nn.LayerNorm(patch_dim),</span><br><span class="line">            nn.Linear(patch_dim, dim),</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.pos_embedding = posemb_sincos_2d(</span><br><span class="line">            h=image_height // patch_height,</span><br><span class="line">            w=image_width // patch_width,</span><br><span class="line">            dim=dim,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.transformer = Transformer(dim, depth, heads, dim_head, mlp_dim)</span><br><span class="line"></span><br><span class="line">        self.pool = <span class="string">&quot;mean&quot;</span></span><br><span class="line">        self.to_latent = nn.Identity()</span><br><span class="line"></span><br><span class="line">        self.linear_head = nn.Linear(dim, num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, img</span>):</span></span><br><span class="line">        device = img.device</span><br><span class="line"></span><br><span class="line">        x = self.to_patch_embedding(img)</span><br><span class="line">        x += self.pos_embedding.to(device, dtype=x.dtype)</span><br><span class="line"></span><br><span class="line">        x = self.transformer(x)</span><br><span class="line">        x = x.mean(dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        x = self.to_latent(x)</span><br><span class="line">        <span class="keyword">return</span> self.linear_head(x)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åšäº†patchä¹‹åçš„ä½ç½®ç¼–ç ä½¿ç”¨ä¸‰è§’å‡½æ•°ç»å¯¹ç¼–ç ,attentionå’Œfeednetworkä¸transformeræ²¡æœ‰ä»€ä¹ˆå·®åˆ«.</p><h2 id="å·ç§¯æ³¨æ„åŠ›"><a href="#å·ç§¯æ³¨æ„åŠ›" class="headerlink" title="å·ç§¯æ³¨æ„åŠ›"></a>å·ç§¯æ³¨æ„åŠ›</h2><p>ä½¿ç”¨vision transformerä¸­ä½¿ç”¨çš„ç»å¯¹ä½ç½®æ³¨æ„åŠ›,ä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸å¯¹ä½ç½®æ³¨æ„åŠ›æˆ–è€…å·ç§¯æ³¨æ„åŠ›.</p><blockquote><p>å·ç§¯ä½ç½®åµŒå…¥( CPE )æ–¹æ³•è€ƒè™‘äº†è¾“å…¥åºåˆ—çš„2Dæ€§è´¨ã€‚é‡‡ç”¨è¡¥é›¶çš„æ–¹å¼è¿›è¡Œ2Då·ç§¯é‡‡é›†ä½ç½®ä¿¡æ¯ã€‚å·ç§¯ä½ç½®åµŒå…¥( Convolutional PositionåµŒå…¥ï¼ŒCPE )å¯ç”¨äºåˆå¹¶ViTä¸åŒé˜¶æ®µçš„ä½ç½®æ•°æ®ã€‚CPEå¯ä»¥å…·ä½“å¼•å…¥åˆ°è‡ªæ³¨æ„åŠ›æ¨¡å—ï¼Œå‰é¦ˆç½‘ç»œï¼Œæˆ–è€…åœ¨ä¸¤ä¸ªç¼–ç å™¨å±‚ä¹‹é—´çš„ã€‚</p></blockquote><p>å·ç§¯æ³¨æ„åŠ›é€šå¸¸æ–¹æ³•æ˜¯åˆ©ç”¨2Då·ç§¯æˆ–è€…depth-wiseçš„å·ç§¯å°†å·²ç»åšäº†patchçš„å›¾åƒæ•°æ®è¿›è¡Œå¤„ç†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvolutionalPositionEmbedding</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv = nn.Conv2d(d_model, d_model, kernel_size, padding=padding)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = x.transpose(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># å°†é€šé“ç»´åº¦å’Œåºåˆ—é•¿åº¦ç»´åº¦äº¤æ¢</span></span><br><span class="line">        x = x.unsqueeze(<span class="number">2</span>)  <span class="comment"># åœ¨é€šé“ç»´åº¦å’Œåºåˆ—é•¿åº¦ç»´åº¦ä¹‹é—´æ·»åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">        x = self.conv(x)  <span class="comment"># å¯¹è¾“å…¥è¿›è¡Œå·ç§¯æ“ä½œ</span></span><br><span class="line">        x = x.squeeze(<span class="number">2</span>)  <span class="comment"># ç§»é™¤æ·»åŠ çš„ç»´åº¦</span></span><br><span class="line">        x = x.transpose(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># å°†é€šé“ç»´åº¦å’Œåºåˆ—é•¿åº¦ç»´åº¦äº¤æ¢å›æ¥</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h3 id="CVT"><a href="#CVT" class="headerlink" title="CVT"></a>CVT</h3><p><img data-src="https://github.com/rishikksh20/convolution-vision-transformers/raw/master/assets/model.PNG" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   #!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#   #-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#  Copyleft (C) 2024 proanimer, Inc. All Rights Reserved</span></span><br><span class="line"><span class="comment">#   author:proanimer</span></span><br><span class="line"><span class="comment">#   createTime:2024/2/18 ä¸Šåˆ10:38</span></span><br><span class="line"><span class="comment">#   lastModifiedTime:2024/2/18 ä¸Šåˆ10:38</span></span><br><span class="line"><span class="comment">#   file:cvt.py</span></span><br><span class="line"><span class="comment">#   software: classicNets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> einops <span class="keyword">import</span> rearrange, repeat</span><br><span class="line"><span class="keyword">from</span> einops.layers.torch <span class="keyword">import</span> Rearrange</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> einsum</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SepConv2d</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        in_channels,</span></span></span><br><span class="line"><span class="params"><span class="function">        out_channels,</span></span></span><br><span class="line"><span class="params"><span class="function">        kernel_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        stride=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        padding=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        dilation=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SepConv2d, self).__init__()</span><br><span class="line">        self.depthwise = torch.nn.Conv2d(</span><br><span class="line">            in_channels,</span><br><span class="line">            in_channels,</span><br><span class="line">            kernel_size=kernel_size,</span><br><span class="line">            stride=stride,</span><br><span class="line">            padding=padding,</span><br><span class="line">            dilation=dilation,</span><br><span class="line">            groups=in_channels,</span><br><span class="line">        )</span><br><span class="line">        self.bn = torch.nn.BatchNorm2d(in_channels)</span><br><span class="line">        self.pointwise = torch.nn.Conv2d(in_channels, out_channels, kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.depthwise(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        x = self.pointwise(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Residual</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.fn(x, **kwargs) + x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PreNorm</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, fn</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.norm = nn.LayerNorm(dim)</span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.fn(self.norm(x), **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedForward</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, hidden_dim, dropout=<span class="number">0.0</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.net = nn.Sequential(</span><br><span class="line">            nn.Linear(dim, hidden_dim),</span><br><span class="line">            nn.GELU(),</span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">            nn.Linear(hidden_dim, dim),</span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.net(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        img_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        heads=<span class="number">8</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim_head=<span class="number">64</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        kernel_size=<span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        q_stride=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        k_stride=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        v_stride=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        last_stage=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.last_stage = last_stage</span><br><span class="line">        self.img_size = img_size</span><br><span class="line">        inner_dim = dim_head * heads</span><br><span class="line">        project_out = <span class="keyword">not</span> (heads == <span class="number">1</span> <span class="keyword">and</span> dim_head == dim)</span><br><span class="line"></span><br><span class="line">        self.heads = heads</span><br><span class="line">        self.scale = dim_head**-<span class="number">0.5</span></span><br><span class="line">        pad = (kernel_size - q_stride) // <span class="number">2</span></span><br><span class="line">        self.to_q = SepConv2d(dim, inner_dim, kernel_size, q_stride, pad)</span><br><span class="line">        self.to_k = SepConv2d(dim, inner_dim, kernel_size, k_stride, pad)</span><br><span class="line">        self.to_v = SepConv2d(dim, inner_dim, kernel_size, v_stride, pad)</span><br><span class="line"></span><br><span class="line">        self.to_out = (</span><br><span class="line">            nn.Sequential(nn.Linear(inner_dim, dim), nn.Dropout(dropout))</span><br><span class="line">            <span class="keyword">if</span> project_out</span><br><span class="line">            <span class="keyword">else</span> nn.Identity()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        b, n, _, h = *x.shape, self.heads</span><br><span class="line">        <span class="keyword">if</span> self.last_stage:</span><br><span class="line">            cls_token = x[:, <span class="number">0</span>]</span><br><span class="line">            x = x[:, <span class="number">1</span>:]</span><br><span class="line">            cls_token = rearrange(cls_token.unsqueeze(<span class="number">1</span>), <span class="string">&quot;b n (h d) -&gt; b h n d&quot;</span>, h=h)</span><br><span class="line">        x = rearrange(x, <span class="string">&quot;b (l w) n -&gt; b n l w&quot;</span>, l=self.img_size, w=self.img_size)</span><br><span class="line">        q = self.to_q(x)</span><br><span class="line">        q = rearrange(q, <span class="string">&quot;b (h d) l w -&gt; b h (l w) d&quot;</span>, h=h)</span><br><span class="line"></span><br><span class="line">        v = self.to_v(x)</span><br><span class="line">        v = rearrange(v, <span class="string">&quot;b (h d) l w -&gt; b h (l w) d&quot;</span>, h=h)</span><br><span class="line"></span><br><span class="line">        k = self.to_k(x)</span><br><span class="line">        k = rearrange(k, <span class="string">&quot;b (h d) l w -&gt; b h (l w) d&quot;</span>, h=h)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.last_stage:</span><br><span class="line">            q = torch.cat((cls_token, q), dim=<span class="number">2</span>)</span><br><span class="line">            v = torch.cat((cls_token, v), dim=<span class="number">2</span>)</span><br><span class="line">            k = torch.cat((cls_token, k), dim=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        dots = einsum(<span class="string">&quot;b h i d, b h j d -&gt; b h i j&quot;</span>, q, k) * self.scale</span><br><span class="line"></span><br><span class="line">        attn = dots.softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        out = einsum(<span class="string">&quot;b h i j, b h j d -&gt; b h i d&quot;</span>, attn, v)</span><br><span class="line">        out = rearrange(out, <span class="string">&quot;b h n d -&gt; b n (h d)&quot;</span>)</span><br><span class="line">        out = self.to_out(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        img_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        depth,</span></span></span><br><span class="line"><span class="params"><span class="function">        heads,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim_head,</span></span></span><br><span class="line"><span class="params"><span class="function">        mlp_dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        last_stage=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            self.layers.append(</span><br><span class="line">                nn.ModuleList(</span><br><span class="line">                    [</span><br><span class="line">                        PreNorm(</span><br><span class="line">                            dim,</span><br><span class="line">                            ConvAttention(</span><br><span class="line">                                dim,</span><br><span class="line">                                img_size,</span><br><span class="line">                                heads=heads,</span><br><span class="line">                                dim_head=dim_head,</span><br><span class="line">                                dropout=dropout,</span><br><span class="line">                                last_stage=last_stage,</span><br><span class="line">                            ),</span><br><span class="line">                        ),</span><br><span class="line">                        PreNorm(dim, FeedForward(dim, mlp_dim, dropout=dropout)),</span><br><span class="line">                    ]</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">for</span> attn, ff <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = attn(x) + x</span><br><span class="line">            x = ff(x) + x</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cvt</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        image_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        in_channels,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_classes,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim=<span class="number">64</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        kernels=[<span class="number">7</span>, <span class="number">3</span>, <span class="number">3</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        strides=[<span class="number">4</span>, <span class="number">2</span>, <span class="number">2</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        heads=[<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        depth=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">10</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        pool=<span class="string">&quot;cls&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        emb_dropout=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        scale_dim=<span class="number">4</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>(cvt, self).__init__()</span><br><span class="line">        <span class="keyword">assert</span> pool <span class="keyword">in</span> &#123;</span><br><span class="line">            <span class="string">&quot;cls&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mean&quot;</span>,</span><br><span class="line">        &#125;, <span class="string">&quot;pool type must be either cls (cls token) or mean (mean pooling)&quot;</span></span><br><span class="line">        self.pool = pool</span><br><span class="line">        self.dim = dim</span><br><span class="line">        self.stage1_conv_embed = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, dim, kernels[<span class="number">0</span>], strides[<span class="number">0</span>], <span class="number">2</span>),</span><br><span class="line">            Rearrange(<span class="string">&quot;b c h w -&gt; b (h w) c&quot;</span>, h=image_size // <span class="number">4</span>, w=image_size // <span class="number">4</span>),</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">        )</span><br><span class="line">        self.stage_1_transformer = nn.Sequential(</span><br><span class="line">            Transformer(</span><br><span class="line">                dim,</span><br><span class="line">                img_size=image_size // <span class="number">4</span>,</span><br><span class="line">                depth=depth[<span class="number">0</span>],</span><br><span class="line">                heads=heads[<span class="number">0</span>],</span><br><span class="line">                dim_head=dim // heads[<span class="number">0</span>],</span><br><span class="line">                mlp_dim=dim * scale_dim,</span><br><span class="line">                dropout=dropout,</span><br><span class="line">                last_stage=<span class="literal">True</span>,</span><br><span class="line">            ),</span><br><span class="line">            Rearrange(<span class="string">&quot;b (h w) c -&gt; b c h w&quot;</span>, h=image_size // <span class="number">4</span>, w=image_size // <span class="number">4</span>),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#     stage 2</span></span><br><span class="line">        in_channels = dim</span><br><span class="line">        scale = heads[<span class="number">1</span>] // heads[<span class="number">0</span>]</span><br><span class="line">        dim = scale * dim</span><br><span class="line">        self.stage2_conv_embed = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, dim, kernels[<span class="number">1</span>], strides[<span class="number">1</span>], <span class="number">1</span>),</span><br><span class="line">            Rearrange(<span class="string">&quot;b c h w -&gt; b (h w) c&quot;</span>, h=image_size // <span class="number">8</span>, w=image_size // <span class="number">8</span>),</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">        )</span><br><span class="line">        self.stage_2_transformer = nn.Sequential(</span><br><span class="line">            Transformer(</span><br><span class="line">                dim,</span><br><span class="line">                img_size=image_size // <span class="number">8</span>,</span><br><span class="line">                depth=depth[<span class="number">1</span>],</span><br><span class="line">                heads=heads[<span class="number">1</span>],</span><br><span class="line">                dim_head=dim // heads[<span class="number">1</span>],</span><br><span class="line">                mlp_dim=dim * scale_dim,</span><br><span class="line">                dropout=dropout,</span><br><span class="line">                last_stage=<span class="literal">True</span>,</span><br><span class="line">            ),</span><br><span class="line">            Rearrange(<span class="string">&quot;b (h w) c -&gt; b c h w&quot;</span>, h=image_size // <span class="number">8</span>, w=image_size // <span class="number">8</span>),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#     stage 3</span></span><br><span class="line">        in_channels = dim</span><br><span class="line">        scale = heads[<span class="number">2</span>] // heads[<span class="number">1</span>]</span><br><span class="line">        dim = scale * dim</span><br><span class="line">        self.stage3_conv_embed = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, dim, kernels[<span class="number">2</span>], strides[<span class="number">2</span>], <span class="number">1</span>),</span><br><span class="line">            Rearrange(<span class="string">&quot;b c h w -&gt; b (h w) c&quot;</span>, h=image_size // <span class="number">16</span>, w=image_size // <span class="number">16</span>),</span><br><span class="line">            nn.LayerNorm(dim),</span><br><span class="line">        )</span><br><span class="line">        self.stage_3_transformer = nn.Sequential(</span><br><span class="line">            Transformer(</span><br><span class="line">                dim=dim,</span><br><span class="line">                img_size=image_size // <span class="number">16</span>,</span><br><span class="line">                depth=depth[<span class="number">2</span>],</span><br><span class="line">                heads=heads[<span class="number">2</span>],</span><br><span class="line">                dim_head=self.dim,</span><br><span class="line">                mlp_dim=dim * scale_dim,</span><br><span class="line">                dropout=dropout,</span><br><span class="line">                last_stage=<span class="literal">True</span>,</span><br><span class="line">            ),</span><br><span class="line">        )</span><br><span class="line">        self.cls_token = nn.Parameter(torch.randn(<span class="number">1</span>, <span class="number">1</span>, dim))</span><br><span class="line">        self.drop_large = nn.Dropout(emb_dropout)</span><br><span class="line"></span><br><span class="line">        self.mlp_head = nn.Sequential(nn.LayerNorm(dim), nn.Linear(dim, num_classes))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,img</span>):</span></span><br><span class="line">        xs = self.stage1_conv_embed(img)</span><br><span class="line">        xs = self.stage1_transformer(xs)</span><br><span class="line"></span><br><span class="line">        xs = self.stage2_conv_embed(xs)</span><br><span class="line">        xs = self.stage2_transformer(xs)</span><br><span class="line"></span><br><span class="line">        xs = self.stage3_conv_embed(xs)</span><br><span class="line">        b, n, _ = xs.shape</span><br><span class="line">        cls_tokens = repeat(self.cls_token, <span class="string">&#x27;() n d -&gt; b n d&#x27;</span>, b=b)</span><br><span class="line">        xs = torch.cat((cls_tokens, xs), dim=<span class="number">1</span>)</span><br><span class="line">        xs = self.stage3_transformer(xs)</span><br><span class="line">        xs = xs.mean(dim=<span class="number">1</span>) <span class="keyword">if</span> self.pool == <span class="string">&#x27;mean&#x27;</span> <span class="keyword">else</span> xs[:, <span class="number">0</span>]</span><br><span class="line">        xs = self.mlp_head(xs)</span><br><span class="line">        <span class="keyword">return</span> xs</span><br></pre></td></tr></table></figure><h3 id="PVT"><a href="#PVT" class="headerlink" title="PVT"></a>PVT</h3><p><img data-src="https://s2.loli.net/2024/02/18/w8EUDyAJ4sIv51n.png" alt="image-20240218105527163"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   #!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#   #-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#  Copyleft (C) 2024 proanimer, Inc. All Rights Reserved</span></span><br><span class="line"><span class="comment">#   author:proanimer</span></span><br><span class="line"><span class="comment">#   createTime:2024/2/18 ä¸‹åˆ2:22</span></span><br><span class="line"><span class="comment">#   lastModifiedTime:2024/2/18 ä¸‹åˆ2:22</span></span><br><span class="line"><span class="comment">#   file:pvt.py</span></span><br><span class="line"><span class="comment">#   software: classicNets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> timm.models.layers <span class="keyword">import</span> DropPath, to_2tuple, trunc_normal_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mlp</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        in_features,</span></span></span><br><span class="line"><span class="params"><span class="function">        hidden_features=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        out_features=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        act_layer=nn.GELU,</span></span></span><br><span class="line"><span class="params"><span class="function">        drop=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        out_features = out_features <span class="keyword">or</span> in_features</span><br><span class="line">        hidden_features = hidden_features <span class="keyword">or</span> in_features</span><br><span class="line">        self.fc1 = nn.Linear(in_features, hidden_features)</span><br><span class="line">        self.act = act_layer()</span><br><span class="line">        self.fc2 = nn.Linear(hidden_features, out_features)</span><br><span class="line">        self.drop = nn.Dropout(drop)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.fc1(x)</span><br><span class="line">        x = self.act(x)</span><br><span class="line">        x = self.drop(x)</span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        x = self.drop(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_heads=<span class="number">8</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        qkv_bias=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        qk_scale=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attn_drop=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        proj_drop=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        sr_ratio=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">assert</span> (</span><br><span class="line">            dim % num_heads == <span class="number">0</span></span><br><span class="line">        ), <span class="string">f&quot;dim <span class="subst">&#123;dim&#125;</span> should be divided by num_heads <span class="subst">&#123;num_heads&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">        self.dim = dim</span><br><span class="line">        self.num_heads = num_heads</span><br><span class="line">        head_dim = dim // num_heads</span><br><span class="line">        self.scale = qk_scale <span class="keyword">or</span> head_dim**-<span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">        self.q = nn.Linear(dim, dim, bias=qkv_bias)</span><br><span class="line">        self.kv = nn.Linear(dim, dim * <span class="number">2</span>, bias=qkv_bias)</span><br><span class="line">        self.attn_drop = nn.Dropout(attn_drop)</span><br><span class="line">        self.proj = nn.Linear(dim, dim)</span><br><span class="line">        self.proj_drop = nn.Dropout(proj_drop)</span><br><span class="line"></span><br><span class="line">        self.sr_ratio = sr_ratio</span><br><span class="line">        <span class="keyword">if</span> sr_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            self.sr = nn.Conv2d(dim, dim, kernel_size=sr_ratio, stride=sr_ratio)</span><br><span class="line">            self.norm = nn.LayerNorm(dim)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, H, W</span>):</span></span><br><span class="line">        B, N, C = x.shape</span><br><span class="line">        q = (</span><br><span class="line">            self.q(x)</span><br><span class="line">            .reshape(B, N, self.num_heads, C // self.num_heads)</span><br><span class="line">            .permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.sr_ratio &gt; <span class="number">1</span>:</span><br><span class="line">            x_ = x.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>).reshape(B, C, H, W)</span><br><span class="line">            x_ = self.sr(x_).reshape(B, C, -<span class="number">1</span>).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            x_ = self.norm(x_)</span><br><span class="line">            kv = (</span><br><span class="line">                self.kv(x_)</span><br><span class="line">                .reshape(B, -<span class="number">1</span>, <span class="number">2</span>, self.num_heads, C // self.num_heads)</span><br><span class="line">                .permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            kv = (</span><br><span class="line">                self.kv(x)</span><br><span class="line">                .reshape(B, -<span class="number">1</span>, <span class="number">2</span>, self.num_heads, C // self.num_heads)</span><br><span class="line">                .permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">            )</span><br><span class="line">        k, v = kv[<span class="number">0</span>], kv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        attn = (q @ k.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) * self.scale  <span class="comment"># q (B,H,N,C)  K(B,H,C,N)</span></span><br><span class="line">        attn = attn.softmax(dim=-<span class="number">1</span>)</span><br><span class="line">        attn = self.attn_drop(attn)</span><br><span class="line"></span><br><span class="line">        x = (</span><br><span class="line">            (attn @ v).transpose(<span class="number">1</span>, <span class="number">2</span>).reshape(B, N, C)</span><br><span class="line">        )  <span class="comment"># (B,H,N,N) @ (B,H,N,C) -&gt; (B,H,N,C)</span></span><br><span class="line">        x = self.proj(x)</span><br><span class="line">        x = self.proj_drop(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Block</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        dim,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_heads,</span></span></span><br><span class="line"><span class="params"><span class="function">        mlp_ratio=<span class="number">4.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        qkv_bias=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        qk_scale=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        drop=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attn_drop=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        drop_path=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        act_layer=nn.GELU,</span></span></span><br><span class="line"><span class="params"><span class="function">        norm_layer=nn.LayerNorm,</span></span></span><br><span class="line"><span class="params"><span class="function">        sr_ratio=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.norm1 = norm_layer(dim)</span><br><span class="line">        self.attn = Attention(</span><br><span class="line">            dim,</span><br><span class="line">            num_heads=num_heads,</span><br><span class="line">            qkv_bias=qkv_bias,</span><br><span class="line">            qk_scale=qk_scale,</span><br><span class="line">            attn_drop=attn_drop,</span><br><span class="line">            proj_drop=drop,</span><br><span class="line">            sr_ratio=sr_ratio,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> drop path for stochastic depth, we shall see if this is better than dropout here</span></span><br><span class="line">        self.drop_path = DropPath(drop_path) <span class="keyword">if</span> drop_path &gt; <span class="number">0.0</span> <span class="keyword">else</span> nn.Identity()</span><br><span class="line">        self.norm2 = norm_layer(dim)</span><br><span class="line">        mlp_hidden_dim = <span class="built_in">int</span>(dim * mlp_ratio)</span><br><span class="line">        self.mlp = Mlp(</span><br><span class="line">            in_features=dim,</span><br><span class="line">            hidden_features=mlp_hidden_dim,</span><br><span class="line">            act_layer=act_layer,</span><br><span class="line">            drop=drop,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, H, W</span>):</span></span><br><span class="line">        x = x + self.drop_path(self.attn(self.norm1(x), H, W))</span><br><span class="line">        x = x + self.drop_path(self.mlp(self.norm2(x)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatchEmbed</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Image to Patch Embedding&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, img_size=<span class="number">224</span>, patch_size=<span class="number">16</span>, in_chans=<span class="number">3</span>, embed_dim=<span class="number">768</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        img_size = to_2tuple(img_size)</span><br><span class="line">        patch_size = to_2tuple(patch_size)</span><br><span class="line"></span><br><span class="line">        self.img_size = img_size</span><br><span class="line">        self.patch_size = patch_size</span><br><span class="line">        <span class="keyword">assert</span> (</span><br><span class="line">            img_size[<span class="number">0</span>] % patch_size[<span class="number">0</span>] == <span class="number">0</span> <span class="keyword">and</span> img_size[<span class="number">1</span>] % patch_size[<span class="number">1</span>] == <span class="number">0</span></span><br><span class="line">        ), <span class="string">f&quot;img_size <span class="subst">&#123;img_size&#125;</span> should be divided by patch_size <span class="subst">&#123;patch_size&#125;</span>.&quot;</span></span><br><span class="line">        self.H, self.W = img_size[<span class="number">0</span>] // patch_size[<span class="number">0</span>], img_size[<span class="number">1</span>] // patch_size[<span class="number">1</span>]</span><br><span class="line">        self.num_patches = self.H * self.W</span><br><span class="line">        self.proj = nn.Conv2d(</span><br><span class="line">            in_chans, embed_dim, kernel_size=patch_size, stride=patch_size</span><br><span class="line">        )</span><br><span class="line">        self.norm = nn.LayerNorm(embed_dim)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        B, C, H, W = x.shape</span><br><span class="line"></span><br><span class="line">        x = (</span><br><span class="line">            self.proj(x).flatten(<span class="number">2</span>).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        )  <span class="comment"># B,C,H,W-&gt;B,embed_dim,seq*seq-&gt;B,seq*seq,embed_dim</span></span><br><span class="line">        x = self.norm(x)</span><br><span class="line">        H, W = H // self.patch_size[<span class="number">0</span>], W // self.patch_size[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x, (H, W)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PyramidVisionTransformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self,</span></span></span><br><span class="line"><span class="params"><span class="function">        img_size=<span class="number">224</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        patch_size=<span class="number">16</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        in_chans=<span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_classes=<span class="number">1000</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        embed_dims=[<span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        num_heads=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        mlp_ratios=[<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        qkv_bias=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        qk_scale=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        drop_rate=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        attn_drop_rate=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        drop_path_rate=<span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        norm_layer=nn.LayerNorm,</span></span></span><br><span class="line"><span class="params"><span class="function">        depths=[<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        sr_ratios=[<span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">        F4=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        num_stages=<span class="number">4</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.depths = depths</span><br><span class="line">        self.F4 = F4</span><br><span class="line">        self.num_stages = num_stages</span><br><span class="line"></span><br><span class="line">        dpr = [</span><br><span class="line">            x.item() <span class="keyword">for</span> x <span class="keyword">in</span> torch.linspace(<span class="number">0</span>, drop_path_rate, <span class="built_in">sum</span>(depths))</span><br><span class="line">        ]  <span class="comment"># stochastic depth decay rule</span></span><br><span class="line">        cur = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_stages):</span><br><span class="line">            patch_embed = PatchEmbed(</span><br><span class="line">                img_size=img_size <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">else</span> img_size // (<span class="number">2</span> ** (i + <span class="number">1</span>)),</span><br><span class="line">                patch_size=patch_size <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">else</span> <span class="number">2</span>,</span><br><span class="line">                in_chans=in_chans <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">else</span> embed_dims[i - <span class="number">1</span>],</span><br><span class="line">                embed_dim=embed_dims[i],</span><br><span class="line">            )  <span class="comment"># [B,seq=num_patches,dim=patch_size**2*embed_dim]</span></span><br><span class="line">            num_patches = (</span><br><span class="line">                patch_embed.num_patches</span><br><span class="line">                <span class="keyword">if</span> i != num_stages - <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> patch_embed.num_patches + <span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">            pos_embed = nn.Parameter(torch.zeros(<span class="number">1</span>, num_patches, embed_dims[i]))</span><br><span class="line">            pos_drop = nn.Dropout(p=drop_rate)</span><br><span class="line"></span><br><span class="line">            block = nn.ModuleList(</span><br><span class="line">                [</span><br><span class="line">                    Block(</span><br><span class="line">                        dim=embed_dims[i],</span><br><span class="line">                        num_heads=num_heads[i],</span><br><span class="line">                        mlp_ratio=mlp_ratios[i],</span><br><span class="line">                        qkv_bias=qkv_bias,</span><br><span class="line">                        qk_scale=qk_scale,</span><br><span class="line">                        drop=drop_rate,</span><br><span class="line">                        attn_drop=attn_drop_rate,</span><br><span class="line">                        drop_path=dpr[cur + j],</span><br><span class="line">                        norm_layer=norm_layer,</span><br><span class="line">                        sr_ratio=sr_ratios[i],</span><br><span class="line">                    )</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(depths[i])</span><br><span class="line">                ]</span><br><span class="line">            )</span><br><span class="line">            cur += depths[i]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">setattr</span>(self, <span class="string">f&quot;patch_embed<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, patch_embed)</span><br><span class="line">            <span class="built_in">setattr</span>(self, <span class="string">f&quot;pos_embed<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, pos_embed)</span><br><span class="line">            <span class="built_in">setattr</span>(self, <span class="string">f&quot;pos_drop<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, pos_drop)</span><br><span class="line">            <span class="built_in">setattr</span>(self, <span class="string">f&quot;block<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>, block)</span><br><span class="line"></span><br><span class="line">            trunc_normal_(pos_embed, std=<span class="number">0.02</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># init weights</span></span><br><span class="line">        self.apply(self._init_weights)</span><br><span class="line">        <span class="comment"># self.init_weights(pretrained)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_weights</span>(<span class="params">self, m</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">            trunc_normal_(m.weight, std=<span class="number">0.02</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Linear) <span class="keyword">and</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.LayerNorm):</span><br><span class="line">            nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            nn.init.constant_(m.weight, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_pos_embed</span>(<span class="params">self, pos_embed, patch_embed, H, W</span>):</span></span><br><span class="line">        <span class="keyword">if</span> H * W == self.patch_embed1.num_patches:</span><br><span class="line">            <span class="keyword">return</span> pos_embed</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                F.interpolate(</span><br><span class="line">                    pos_embed.reshape(<span class="number">1</span>, patch_embed.H, patch_embed.W, -<span class="number">1</span>).permute(</span><br><span class="line">                        <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">                    ),</span><br><span class="line">                    size=(H, W),</span><br><span class="line">                    mode=<span class="string">&quot;bilinear&quot;</span>,</span><br><span class="line">                )</span><br><span class="line">                .reshape(<span class="number">1</span>, -<span class="number">1</span>, H * W)</span><br><span class="line">                .permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_features</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        outs = []</span><br><span class="line">        B = x.shape[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_stages):</span><br><span class="line">            patch_embed = <span class="built_in">getattr</span>(self, <span class="string">f&quot;patch_embed<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">            pos_embed = <span class="built_in">getattr</span>(self, <span class="string">f&quot;pos_embed<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">            pos_drop = <span class="built_in">getattr</span>(self, <span class="string">f&quot;pos_drop<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">            block = <span class="built_in">getattr</span>(self, <span class="string">f&quot;block<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">            x, (H, W) = patch_embed(x)</span><br><span class="line">            <span class="keyword">if</span> i == self.num_stages - <span class="number">1</span>:</span><br><span class="line">                pos_embed = self._get_pos_embed(pos_embed[:, <span class="number">1</span>:], patch_embed, H, W)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pos_embed = self._get_pos_embed(pos_embed, patch_embed, H, W)</span><br><span class="line"></span><br><span class="line">            x = pos_drop(x + pos_embed)</span><br><span class="line">            <span class="keyword">for</span> blk <span class="keyword">in</span> block:</span><br><span class="line">                x = blk(x, H, W)</span><br><span class="line">            x = x.reshape(B, H, W, -<span class="number">1</span>).permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>).contiguous()</span><br><span class="line">            outs.append(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.forward_features(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.F4:</span><br><span class="line">            x = x[<span class="number">3</span>:<span class="number">4</span>]</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h3 id="PVT-v2"><a href="#PVT-v2" class="headerlink" title="PVT v2"></a>PVT v2</h3><p><a href="https://arxiv.org/pdf/2106.13797.pdf">2106.13797.pdf (arxiv.org)</a>å¯¹ä¹‹å‰çš„pvtè¿›è¡Œäº†æ”¹è¿›,åŒ…æ‹¬ç©ºé—´å¤§å°é™ä½æ”¾çš„æ–¹æ³•,patch embdeddingæ”¹ä¸ºäº†æœ‰é‡å åŒºåŸŸçš„patch embedding.FeedNetworkä¸­åŠ äº†depth-wiseå·ç§¯.</p><p><img data-src="https://s2.loli.net/2024/02/21/buMGx8v6TfNOQht.png" alt="image-20240221212026465"></p><p><img data-src="https://s2.loli.net/2024/02/21/OhtbAGq8NgvKnEX.png" alt="image-20240221212055900"></p><h3 id="CPVTä¸­çš„PEG"><a href="#CPVTä¸­çš„PEG" class="headerlink" title="CPVTä¸­çš„PEG"></a>CPVTä¸­çš„PEG</h3><p><img data-src="https://s2.loli.net/2024/02/19/LHY9bVrE8w2DlZs.png" alt="image-20240219150034479"></p><p>conditional position encoding</p><p><img data-src="https://s2.loli.net/2024/02/18/cfmP5yO41sN6h8o.png" alt="image-20240218103528794"></p><p>å‡ºè‡ªè®ºæ–‡<a href="https://arxiv.org/pdf/2102.10882.pdf">2102.10882.pdf (arxiv.org)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PEG</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim=<span class="number">256</span>, k=<span class="number">3</span></span>):</span></span><br><span class="line">        self.proj = nn.Conv2d(dim, dim, k, <span class="number">1</span>, k//<span class="number">2</span>, groups=dim)</span><br><span class="line">        <span class="comment"># Only for demo use, more complicated functions are effective too.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, H, W</span>):</span></span><br><span class="line">        B, N, C = x.shape</span><br><span class="line">        cls_token, feat_token = x[:, <span class="number">0</span>], x[:, <span class="number">1</span>:] <span class="comment"># cls tokenä¸å‚ä¸PEG</span></span><br><span class="line">        cnn_feat = feat_token.transpose(<span class="number">1</span>, <span class="number">2</span>).view(B, C, H, W)</span><br><span class="line">        x = self.proj(cnn_feat) + cnn_feat <span class="comment"># äº§ç”ŸPEåŠ ä¸Šè‡ªèº«</span></span><br><span class="line">        x = x.flatten(<span class="number">2</span>).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        x = torch.cat((cls_token.unsqueeze(<span class="number">1</span>), x), dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisionTransformer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">layers=<span class="number">12</span>, dim=<span class="number">192</span>, nhead=<span class="number">3</span>, img_size=<span class="number">224</span>, patch_size=<span class="number">16</span></span>):</span></span><br><span class="line">        self.pos_block = PEG(dim)</span><br><span class="line">        self.blocks = nn.ModuleList([TransformerEncoderLayer(dim</span><br><span class="line">, nhead, dim*<span class="number">4</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(layers)])</span><br><span class="line">        self.patch_embed = PatchEmbed(img_size, patch_size, dim</span><br><span class="line">*<span class="number">4</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_features</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        B, C, H, W = x.shape</span><br><span class="line">        x, patch_size = self.patch_embed(x)</span><br><span class="line">        _H, _W = H // patch_size, W // patch_size</span><br><span class="line">        x = torch.cat((self.cls_tokens, x), dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i, blk <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.blocks):</span><br><span class="line">            x = blk(x)</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>: <span class="comment"># ç¬¬ä¸€ä¸ªencoderä¹‹åæ–½åŠ PEG</span></span><br><span class="line">                x = self.pos_block(x, _H, _W)</span><br><span class="line">        <span class="keyword">return</span> x[:, <span class="number">0</span>]</span><br></pre></td></tr></table></figure><h3 id="LocalVit"><a href="#LocalVit" class="headerlink" title="LocalVit"></a>LocalVit</h3><p><img data-src="https://s2.loli.net/2024/02/18/ncu63LwS7bKhl8j.png" alt="image-20240218105718876"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, depth, heads, dim_head, patch_height, patch_width, scale = <span class="number">4</span>, depth_kernel = <span class="number">3</span>, dropout = <span class="number">0.</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            self.layers.append(nn.ModuleList([</span><br><span class="line">                Residual(PreNorm(dim, Attention(dim, heads = heads, dim_head = dim_head, dropout = dropout))),</span><br><span class="line">                Residual(PreNorm(dim, ConvFF(dim, scale, depth_kernel, patch_height, patch_width)))</span><br><span class="line">            ]))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> attn, convff <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = attn(x)</span><br><span class="line">            cls_tokens = x[:, <span class="number">0</span>]</span><br><span class="line">            x = convff(x[:, <span class="number">1</span>:])</span><br><span class="line">            x = torch.cat((cls_tokens.unsqueeze(<span class="number">1</span>), x), dim=<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">return</span> xclass ConvFF(nn.Module):</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim = <span class="number">192</span>, scale = <span class="number">4</span>, depth_kernel = <span class="number">3</span>, patch_height = <span class="number">14</span>, patch_width = <span class="number">14</span>, dropout=<span class="number">0.</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        scale_dim = dim*scale</span><br><span class="line">        self.up_proj = nn.Sequential(</span><br><span class="line">                                    Rearrange(<span class="string">&#x27;b (h w) c -&gt; b c h w&#x27;</span>, h=patch_height, w=patch_width),</span><br><span class="line">                                    nn.Conv2d(dim, scale_dim, kernel_size=<span class="number">1</span>),</span><br><span class="line">                                    nn.Hardswish()</span><br><span class="line">                                    )</span><br><span class="line">        </span><br><span class="line">        self.depth_conv = nn.Sequential(</span><br><span class="line">                        nn.Conv2d(scale_dim, scale_dim, kernel_size=depth_kernel, padding=<span class="number">1</span>, groups=scale_dim, bias=<span class="literal">True</span>),</span><br><span class="line">                        nn.Conv2d(scale_dim, scale_dim, kernel_size=<span class="number">1</span>, bias=<span class="literal">True</span>),</span><br><span class="line">                        nn.Hardswish()</span><br><span class="line">                        )</span><br><span class="line">        </span><br><span class="line">        self.down_proj = nn.Sequential(</span><br><span class="line">                                    nn.Conv2d(scale_dim, dim, kernel_size=<span class="number">1</span>),</span><br><span class="line">                                    nn.Dropout(dropout),</span><br><span class="line">                                    Rearrange(<span class="string">&#x27;b c h w -&gt;b (h w) c&#x27;</span>)</span><br><span class="line">                                    )</span><br></pre></td></tr></table></figure><p>åœ¨feed-forwardä¸­ä½¿ç”¨2dçš„å·ç§¯.</p><h2 id="transformerä¸­çš„ç»å¯¹å’Œç›¸å¯¹ä½ç½®ç¼–ç "><a href="#transformerä¸­çš„ç»å¯¹å’Œç›¸å¯¹ä½ç½®ç¼–ç " class="headerlink" title="transformerä¸­çš„ç»å¯¹å’Œç›¸å¯¹ä½ç½®ç¼–ç "></a>transformerä¸­çš„ç»å¯¹å’Œç›¸å¯¹ä½ç½®ç¼–ç </h2><p>ä½ç½®ç¼–ç å¯ä»¥åˆ†ä¸ºä½¿ç”¨<code>nn.Embedding</code>æˆ–è€…<code>nn.Parameter</code>çš„å¯å­¦ä¹ å‚æ•°,ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å›ºå®šçš„å€¼,æ¯”å¦‚ä¸‰è§’å‡½æ•°ç¼–ç .æ­¤å¤–å¯ä»¥åˆ†ä¸ºç›¸å¯¹ä½ç½®å’Œç»å¯¹ä½ç½®ç¼–ç </p><h3 id="ç»å¯¹ä½ç½®ç¼–ç "><a href="#ç»å¯¹ä½ç½®ç¼–ç " class="headerlink" title="ç»å¯¹ä½ç½®ç¼–ç "></a>ç»å¯¹ä½ç½®ç¼–ç </h3><p>transformerä¸­ä½¿ç”¨äº†ä½ç½®ç¼–ç ä¿¡æ¯,è¢«è®¤ä¸ºæ˜¯ç»å¯¹ä½ç½®ç¼–ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositionalEncoding</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;Implement the PE function.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d_model, dropout, max_len=<span class="number">5000</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(PositionalEncoding, self).__init__()</span><br><span class="line">        self.dropout = nn.Dropout(p=dropout)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Compute the positional encodings once in log space.</span></span><br><span class="line">        pe = torch.zeros(max_len, d_model)</span><br><span class="line">        position = torch.arange(<span class="number">0</span>, max_len).unsqueeze(<span class="number">1</span>)</span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>) *</span><br><span class="line">                             -(math.log(<span class="number">10000.0</span>) / d_model))</span><br><span class="line">        pe[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term)</span><br><span class="line">        pe[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term)</span><br><span class="line">        pe = pe.unsqueeze(<span class="number">0</span>)</span><br><span class="line">        self.register_buffer(<span class="string">&#x27;pe&#x27;</span>, pe)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = x + Variable(self.pe[:, :x.size(<span class="number">1</span>)],</span><br><span class="line">                         requires_grad=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> self.dropout(x)</span><br></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬å¯èƒ½å¸Œæœ›ä½¿ç”¨ç›¸å¯¹ä½ç½®ç¼–ç è€Œä¸æ˜¯ç»å¯¹ä½ç½®ç¼–ç ï¼ŒåŸå› æœ‰å¾ˆå¤šã€‚é¦–å…ˆï¼Œä½¿ç”¨ç»å¯¹ä½ç½®ä¿¡æ¯å¿…ç„¶æ„å‘³ç€æ¨¡å‹å¯ä»¥å¤„ç†çš„tokenæ•°é‡æœ‰é™åˆ¶ã€‚å‡è®¾ä¸€ä¸ªè¯­è¨€æ¨¡å‹æœ€å¤šåªèƒ½ç¼–ç 1024ä¸ªä½ç½®ã€‚è¿™å¿…ç„¶æ„å‘³ç€ä»»ä½•é•¿äº1024ä¸ªtokençš„åºåˆ—éƒ½ä¸èƒ½è¢«æ¨¡å‹å¤„ç†;ç›¸å¯¹ä½ç½®ç¼–ç å¯ä»¥æ¨å¹¿åˆ°çœ‹ä¸è§é•¿åº¦çš„åºåˆ—ï¼Œå› ä¸ºç†è®ºä¸Šå®ƒç¼–ç çš„å”¯ä¸€ä¿¡æ¯æ˜¯ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„ç›¸å¯¹æˆå¯¹è·ç¦»ã€‚</p></blockquote><h3 id="ç›¸å¯¹ä½ç½®ç¼–ç çš„å†å²"><a href="#ç›¸å¯¹ä½ç½®ç¼–ç çš„å†å²" class="headerlink" title="ç›¸å¯¹ä½ç½®ç¼–ç çš„å†å²"></a>ç›¸å¯¹ä½ç½®ç¼–ç çš„å†å²</h3><blockquote><p>ç›¸å¯¹ä½ç½®åµŒå…¥( Relative Position Embeddingï¼ŒRPE )æŠ€æœ¯ä¸»è¦ç”¨äºå°†ä¸ç›¸å¯¹ä½ç½®ç›¸å…³çš„ä¿¡æ¯çº³å…¥åˆ°æ³¨æ„åŠ›æ¨¡å—ä¸­ã€‚è¯¥æŠ€æœ¯åŸºäºè¿™æ ·çš„æ€æƒ³ï¼šå—ä¹‹é—´çš„ç©ºé—´å…³ç³»æ¯”å®ƒä»¬çš„ç»å¯¹ä½ç½®æ‰¿è½½æ›´å¤šçš„æƒé‡ã€‚ä¸ºäº†è®¡ç®—RPEå€¼ï¼Œä½¿ç”¨äº†åŸºäºå¯å­¦ä¹ å‚æ•°çš„æŸ¥æ‰¾è¡¨ã€‚æŸ¥æ‰¾è¿‡ç¨‹ç”±å›¾åƒpatché—´çš„ç›¸å¯¹è·ç¦»å†³å®šã€‚è™½ç„¶RPEæŠ€æœ¯å¯ä»¥æ‰©å±•åˆ°ä¸åŒé•¿åº¦çš„åºåˆ—ï¼Œä½†å®ƒå¯èƒ½ä¼šå¢åŠ è®­ç»ƒå’Œæµ‹è¯•æ—¶é—´ã€‚</p></blockquote><p>åœ¨<code>attention is all you need</code>ä¸­çš„attentionä¸­,è‡ªæˆ‘æ³¨æ„åŠ›å¯ä»¥è¡¨è¿°ä¸ºå¦‚ä¸‹,å¹¶ä½¿ç”¨ä¸‰è§’å‡½æ•°ç´¢å¼•è¿›è¡Œä½ç½®ç¼–ç .</p><script type="math/tex; mode=display">z_i=\sum_{j=1}^n\alpha_{ij}(x_jW^V) \\\alpha_{ij}=\frac{\exp e_{ij}}{\sum_{k=1}^n\exp e_{ik}} \\e_{ij}=\frac{(x_iW^Q)(x_jW^K)^T}{\sqrt{d_z}}</script><h3 id="1Dæ•°æ®"><a href="#1Dæ•°æ®" class="headerlink" title="1Dæ•°æ®"></a>1Dæ•°æ®</h3><h4 id="Shaw"><a href="#Shaw" class="headerlink" title="Shaw"></a>Shaw</h4><p>ç›¸å¯¹ä½ç½®ç¼–ç åœ¨swin-transformerä»¥åŠSelf-Attention with Relative Position Representationsä¸­éƒ½æœ‰ä½“ç°.è¾ƒæ—©çš„è®ºæ–‡<a href="https://arxiv.org/pdf/1803.02155.pdf">1803.02155.pdf (arxiv.org)</a></p><script type="math/tex; mode=display">z_i=\sum_{j=1}^n\alpha_{ij}(x_jW^V+a_{ij}^V) \\e_{ij}=\frac{x_iW^Q(x_jW^K+a_{ij}^K)^T}{\sqrt{d_z}} \\\begin{aligned}a_{ij}^{K}& =w_{\mathrm{clip}(j-i,k)}^{K}  \\a_{ij}^{V}& =w_{\mathrm{clip}(j-i,k)}^{V}  \\\operatorname{clip}(x,k)& =\max(-k,\min(k,x)) \end{aligned}</script><p>å…¶ä¸­çš„w^k^å’Œw^v^æ˜¯éœ€è¦è®­ç»ƒçš„å‚æ•°.</p><script type="math/tex; mode=display">w^{K}=(w_{-k}^{K},\ldots,w_{k}^{K}) \\w^{V}=(\dot{w_{-k}^{V}},\ldots,w_{k}^{V})</script><p>ä»¥ä¸‹æ˜¯<a href="https://arxiv.org/pdf/1803.02155.pdf">1803.02155.pdf (arxiv.org)</a>ä¸­çš„ç›¸å¯¹ä½ç½®æ³¨æ„åŠ›</p><p><img data-src="https://s2.loli.net/2024/02/16/4esqYAdLkgNuybn.png" alt="image-20240216225108501" style="zoom: 67%;" /></p><p><img data-src="https://pic4.zhimg.com/80/v2-f6d057978590bd14fd876856500b69df_720w.webp" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shaw&#x27;s relative positional embedding</span></span><br><span class="line">seq = torch.arange(n, device=device)</span><br><span class="line">dist = rearrange(seq, <span class="string">&quot;i -&gt; i ()&quot;</span>) - rearrange(seq, <span class="string">&quot;j -&gt; () j&quot;</span>)</span><br><span class="line">dist = dist.clamp(-max_pos_emb, max_pos_emb) + max_pos_emb</span><br><span class="line">rel_pos_emb = self.rel_pos_emb(dist).to(q)</span><br><span class="line">pos_attn = einsum(<span class="string">&quot;b h n d, n r d -&gt; b h n r&quot;</span>, q, rel_pos_emb) * self.scale</span><br><span class="line">dots = dots + pos_attn</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> exists(mask) <span class="keyword">or</span> exists(context_mask):</span><br><span class="line">    mask = default(mask, <span class="keyword">lambda</span>: torch.ones(*x.shape[:<span class="number">2</span>], device=device))</span><br><span class="line">    context_mask = (</span><br><span class="line">        default(context_mask, mask)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> has_context</span><br><span class="line">        <span class="keyword">else</span> default(</span><br><span class="line">            context_mask, <span class="keyword">lambda</span>: torch.ones(*context.shape[:<span class="number">2</span>], device=device)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    mask_value = -torch.finfo(dots.dtype).<span class="built_in">max</span></span><br><span class="line">    mask = rearrange(mask, <span class="string">&quot;b i -&gt; b () i ()&quot;</span>) * rearrange(</span><br><span class="line">        context_mask, <span class="string">&quot;b j -&gt; b () () j&quot;</span></span><br><span class="line">    )</span><br><span class="line">    dots.masked_fill_(~mask, mask_value)</span><br><span class="line"></span><br><span class="line">attn = dots.softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">out = einsum(<span class="string">&quot;b h i j, b h j d -&gt; b h i d&quot;</span>, attn, v)</span><br><span class="line">out = rearrange(out, <span class="string">&quot;b h n d -&gt; b n (h d)&quot;</span>)</span><br><span class="line">out = self.to_out(out)</span><br></pre></td></tr></table></figure><h4 id="transformer-xl"><a href="#transformer-xl" class="headerlink" title="transformer-xl"></a>transformer-xl</h4><p>ä¼—æ‰€å‘¨çŸ¥,q=xW~Q~,k=xW~K~,åŠ å…¥ç›¸å¯¹ä½ç½®ç¼–ç å,å±•å¼€ä¸€èˆ¬æ³¨æ„åŠ›å…¬å¼æœ‰</p><p><img data-src="https://pic4.zhimg.com/80/v2-5ee0eed4bc859e400591d7c83047bffb_720w.webp" alt="img"></p><p><img data-src="https://pic1.zhimg.com/80/v2-733f110568f1c83519ada84af1e32014_720w.webp" alt="img"></p><p>Transformer-XLçš„åšæ³•å¾ˆç®€å•ï¼Œç›´æ¥å°† $p<em>j$ æ›¿æ¢ä¸ºç›¸å¯¹ä½ç½®å‘é‡ $R</em>{i-j}$, è‡³äºä¸¤ä¸ª $p_i$ , åˆ™å¹²è„†æ›¿æ¢ä¸ºä¸¤ä¸ªå¯è®­ç»ƒçš„é—®é‡ $u,v$</p><p>ä¹‹åçš„æ”¹è¿›ä¹Ÿæ˜¯åŸºäºæ­¤,å¹¶ä¸”ä¸å†æ”¹åŠ¨è®¡ç®—Väº†.</p><p>åœ¨transformer-xl(æˆ–è€…ä¹Ÿæ˜¯XLNETä¸­ä½¿ç”¨çš„ç¼–ç )ä¸­</p><script type="math/tex; mode=display">e_{ij}=\frac{(\mathbf{x}_i\mathbf{W}^Q+\mathbf{u})(\mathbf{x}_j\mathbf{W}^K)^T+(\mathbf{x}_i\mathbf{W}^Q+\mathbf{v})(\mathbf{s}_{i-j}\mathbf{W}^R)^T}{\sqrt{d_z}},</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositionalEmbedding</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, demb</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(PositionalEmbedding, self).__init__()</span><br><span class="line">        self.demb = demb</span><br><span class="line">        inv_freq = <span class="number">1</span> / (<span class="number">10000</span> ** (torch.arange(<span class="number">0.0</span>, demb, <span class="number">2.0</span>) / demb))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, pos_seq</span>):</span></span><br><span class="line">        sinusoid_inp = torch.outer(pos_seq, self.inv_freq) <span class="comment"># å‘é‡ä¹‹é—´ç›¸ä¹˜</span></span><br><span class="line">        pos_emb = torch.cat([sinusoid_inp.sin(), sinusoid_inp.cos()], dim=-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> pos_emb[:,<span class="literal">None</span>,:]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">w_head_q = w_head_q.view(qlen, bsz, self.n_head, self.d_head)           <span class="comment"># qlen x bsz x n_head x d_head</span></span><br><span class="line">w_head_k = w_head_k.view(klen, bsz, self.n_head, self.d_head)           <span class="comment"># qlen x bsz x n_head x d_head</span></span><br><span class="line">w_head_v = w_head_v.view(klen, bsz, self.n_head, self.d_head)           <span class="comment"># qlen x bsz x n_head x d_head</span></span><br><span class="line"></span><br><span class="line">r_head_k = r_head_k.view(rlen, self.n_head, self.d_head)                <span class="comment"># qlen x n_head x d_head</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### compute attention score</span></span><br><span class="line">rw_head_q = w_head_q + r_w_bias   <span class="comment">#åŠ ä¸Šbiase                                       # qlen x bsz x n_head x d_head</span></span><br><span class="line">AC = torch.einsum(<span class="string">&#x27;ibnd,jbnd-&gt;ijbn&#x27;</span>, (rw_head_q, w_head_k))             <span class="comment"># qlen x klen x bsz x n_head</span></span><br><span class="line"></span><br><span class="line">rr_head_q = w_head_q + r_r_bias  <span class="comment">#åŠ ä¸Šbiase  </span></span><br><span class="line">BD = torch.einsum(<span class="string">&#x27;ibnd,jnd-&gt;ijbn&#x27;</span>, (rr_head_q, r_head_k))              <span class="comment"># qlen x klen x bsz x n_head</span></span><br><span class="line">BD = self._rel_shift(BD)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [qlen x klen x bsz x n_head]</span></span><br><span class="line">attn_score = AC + BD</span><br><span class="line">attn_score.mul_(self.scale)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­u,væ˜¯ä¸¤ä¸ªå¯å­¦ä¹ å‚æ•°,W^R^æ˜¯ä¸€ä¸ªçŸ©é˜µå°†s~i-j~æŠ•å½±åˆ°ä¸€ä¸ªä¸ä½ç½®ç›¸å…³çš„keyå‘é‡.</p><h4 id="Music-transformer"><a href="#Music-transformer" class="headerlink" title="Music transformer"></a>Music transformer</h4><p>åæ¥Huangå¯¹shawçš„ç›¸å¯¹ä½ç½®ç¼–ç è¿›è¡Œæ”¹è¿›</p><p><img data-src="https://s2.loli.net/2024/02/16/PX9Ev1HjwKDB5xt.png" alt="image-20240216225143335" style="zoom: 67%;" /></p><h4 id="Huang"><a href="#Huang" class="headerlink" title="Huang"></a>Huang</h4><p>æ­¤å¤–è¿˜æœ‰<a href="https://arxiv.org/pdf/2009.13658.pdf">2009.13658.pdf (arxiv.org)</a>æå‡ºçš„</p><script type="math/tex; mode=display">e_{ij}=\frac{(\mathbf{x}_i\mathbf{W}^Q+\mathbf{p}_{ij})(\mathbf{x}_j\mathbf{W}^K+\mathbf{p}_{ij})^T-\mathbf{p}_{ij}\mathbf{p}_{ij}^T}{\sqrt{d_z}},</script><h4 id="T5"><a href="#T5" class="headerlink" title="T5"></a>T5</h4><p><img data-src="https://pic1.zhimg.com/80/v2-16c2aa40bbf7a888a62d9dc1373d6c94_720w.webp" alt="img" style="zoom:50%;" /></p><h4 id="DeBERTa"><a href="#DeBERTa" class="headerlink" title="DeBERTa"></a>DeBERTa</h4><p><img data-src="https://pic3.zhimg.com/80/v2-b5436edfcde32b292cdf24c7f39d9c0e_720w.webp" alt="img"></p><p>æ€»ç»“ä¸‹æ¥å°±æ˜¯åœ¨è®¡ç®—attentionæƒé‡æ—¶æˆ–è€…åœ¨è®¡ç®—æœ€åçš„æ³¨æ„åŠ›æ—¶åŠ ä¸Šä¸€ä¸ªä¸ç›¸å¯¹ä½ç½®ä¿¡æ¯ç›¸å…³çš„å€¼.è¿™ä¸ªå€¼çš„è®¡ç®—é€šå¸¸ç±»ä¼¼å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shaw&#x27;s relative positional embedding</span></span><br><span class="line">seq = torch.arange(n, device=device)</span><br><span class="line">dist = rearrange(seq, <span class="string">&quot;i -&gt; i ()&quot;</span>) - rearrange(seq, <span class="string">&quot;j -&gt; () j&quot;</span>)</span><br><span class="line">dist = dist.clamp(-max_pos_emb, max_pos_emb) + max_pos_emb</span><br><span class="line">rel_pos_emb = self.rel_pos_emb(dist).to(q)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå¤§å¤šç”¨äº1Dæ•°æ®æ¯”å¦‚éŸ³é¢‘å’Œæ–‡å­—.</p><h3 id="2Dæ•°æ®"><a href="#2Dæ•°æ®" class="headerlink" title="2Dæ•°æ®"></a>2Dæ•°æ®</h3><h4 id="Stand-Alone-Self-Attention-in-Vision-Models"><a href="#Stand-Alone-Self-Attention-in-Vision-Models" class="headerlink" title="Stand-Alone Self-Attention in Vision Models"></a>Stand-Alone Self-Attention in Vision Models</h4><p><img data-src="https://user-images.githubusercontent.com/19909320/137499552-3bdf3189-7f57-4f95-a85e-8d5dd2ef6fd0.png" alt="SASA" style="zoom:50%;" /></p><p>å…¬å¼å¦‚ä¸‹</p><script type="math/tex; mode=display">y_{ij}=\sum_{a,b\in\mathcal{N}_{k}(i,j)}\text{softmax}_{ab}\left(q_{ij}^{\top}k_{ab}+q_{ij}^{\top}r_{a-i,b-j}\right)v_{ab}</script><p>å¯¹ç›¸å¯¹è·ç¦»è¿›è¡Œç»´åº¦åˆ†è§£ï¼Œæ¯ä¸ªå…ƒç´ abâˆˆN~k(i,j)~å¾—åˆ°ä¸¤ä¸ªè·ç¦»ï¼šè¡Œåç§»é‡a-iå’Œåˆ—åç§»é‡b-j .</p><p>è¡Œåç§»å’Œåˆ—åç§»åˆ†åˆ«ä¸ä¸€ä¸ªåµŒå…¥r~a-i~å’Œr~b-j~ç›¸å…³è”ï¼Œæ¯ä¸ªåµŒå…¥ç»´åº¦ä¸º1/2d~out~,è¡Œåç§»åµŒå…¥å’Œåˆ—åç§»åµŒå…¥è¢«ä¸²è”èµ·æ¥å½¢æˆr~a-i,b-j~ã€‚</p><p>æˆ–è€…è¡¨ç¤ºå¦‚ä¸‹</p><script type="math/tex; mode=display">e_{ij}=\frac{(\mathbf{x}_i\mathbf{W}^Q)(\mathbf{x}_j\mathbf{W}^K+concat(\mathbf{p}_{\delta\bar{x}}^K,\mathbf{p}_{\delta\bar{y}}^K))^T}{\sqrt{d_z}},</script><p>å…¶ä¸­pæ˜¯å¯è®­ç»ƒå‚æ•°,é•¿åº¦æ˜¯1/2d~z~</p><p><img data-src="https://s2.loli.net/2024/02/17/2S9UbyF7DYfujVw.png" alt="image-20240217180330619"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line">use_cuda = torch.cuda.is_available()</span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> use_cuda <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SASA_Layer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, kernel_size=<span class="number">7</span>, num_heads=<span class="number">8</span>, image_size=<span class="number">224</span>, inference=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SASA_Layer, self).__init__()</span><br><span class="line">        self.kernel_size = <span class="built_in">min</span>(kernel_size, image_size) <span class="comment"># receptive field shouldn&#x27;t be larger than input H/W         </span></span><br><span class="line">        self.num_heads = num_heads</span><br><span class="line">        self.dk = self.dv = in_channels</span><br><span class="line">        self.dkh = self.dk // self.num_heads</span><br><span class="line">        self.dvh = self.dv // self.num_heads</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> self.dk % self.num_heads == <span class="number">0</span>, <span class="string">&quot;dk should be divided by num_heads. (example: dk: 32, num_heads: 8)&quot;</span></span><br><span class="line">        <span class="keyword">assert</span> self.dk % self.num_heads == <span class="number">0</span>, <span class="string">&quot;dv should be divided by num_heads. (example: dv: 32, num_heads: 8)&quot;</span>  </span><br><span class="line">        </span><br><span class="line">        self.k_conv = nn.Conv2d(self.dk, self.dk, kernel_size=<span class="number">1</span>).to(device)</span><br><span class="line">        self.q_conv = nn.Conv2d(self.dk, self.dk, kernel_size=<span class="number">1</span>).to(device)</span><br><span class="line">        self.v_conv = nn.Conv2d(self.dv, self.dv, kernel_size=<span class="number">1</span>).to(device)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Positional encodings</span></span><br><span class="line">        self.rel_encoding_h = nn.Parameter(torch.randn(self.dk // <span class="number">2</span>, self.kernel_size, <span class="number">1</span>), requires_grad=<span class="literal">True</span>)</span><br><span class="line">        self.rel_encoding_w = nn.Parameter(torch.randn(self.dk // <span class="number">2</span>, <span class="number">1</span>, self.kernel_size), requires_grad=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># later access attention weights</span></span><br><span class="line">        self.inference = inference</span><br><span class="line">        <span class="keyword">if</span> self.inference:</span><br><span class="line">            self.register_parameter(<span class="string">&#x27;weights&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        batch_size, _, height, width = x.size()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Compute k, q, v</span></span><br><span class="line">        padded_x = F.pad(x, [(self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>, (self.kernel_size-<span class="number">1</span>)-((self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>), (self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>, (self.kernel_size-<span class="number">1</span>)-((self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>)])</span><br><span class="line">        k = self.k_conv(padded_x)</span><br><span class="line">        q = self.q_conv(x)</span><br><span class="line">        v = self.v_conv(padded_x)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Unfold patches into [BS, num_heads*depth, horizontal_patches, vertical_patches, kernel_size, kernel_size]</span></span><br><span class="line">        k = k.unfold(<span class="number">2</span>, self.kernel_size, <span class="number">1</span>).unfold(<span class="number">3</span>, self.kernel_size, <span class="number">1</span>)</span><br><span class="line">        v = v.unfold(<span class="number">2</span>, self.kernel_size, <span class="number">1</span>).unfold(<span class="number">3</span>, self.kernel_size, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Reshape into [BS, num_heads, horizontal_patches, vertical_patches, depth_per_head, kernel_size*kernel_size]</span></span><br><span class="line">        k = k.reshape(batch_size, self.num_heads, height, width, self.dkh, -<span class="number">1</span>)</span><br><span class="line">        v = v.reshape(batch_size, self.num_heads, height, width, self.dvh, -<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Reshape into [BS, num_heads, height, width, depth_per_head, 1]</span></span><br><span class="line">        q = q.reshape(batch_size, self.num_heads, height, width, self.dkh, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        qk = torch.matmul(q.transpose(<span class="number">4</span>, <span class="number">5</span>), k)    </span><br><span class="line">        qk = qk.reshape(batch_size, self.num_heads, height, width, self.kernel_size, self.kernel_size)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add positional encoding</span></span><br><span class="line">        qr_h = torch.einsum(<span class="string">&#x27;bhxydz,cij-&gt;bhxyij&#x27;</span>, q, self.rel_encoding_h)</span><br><span class="line">        qr_w = torch.einsum(<span class="string">&#x27;bhxydz,cij-&gt;bhxyij&#x27;</span>, q, self.rel_encoding_w)</span><br><span class="line">        qk += qr_h</span><br><span class="line">        qk += qr_w</span><br><span class="line">        </span><br><span class="line">        qk = qk.reshape(batch_size, self.num_heads, height, width, <span class="number">1</span>, self.kernel_size*self.kernel_size)</span><br><span class="line">        weights = F.softmax(qk, dim=-<span class="number">1</span>)    </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.inference:</span><br><span class="line">            self.weights = nn.Parameter(weights)</span><br><span class="line">        </span><br><span class="line">        attn_out = torch.matmul(weights, v.transpose(<span class="number">4</span>, <span class="number">5</span>)) </span><br><span class="line">        attn_out = attn_out.reshape(batch_size, -<span class="number">1</span>, height, width)</span><br><span class="line">        <span class="keyword">return</span> attn_out</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å¯èƒ½æœ‰äº›é—®é¢˜,åº”è¯¥æ˜¯å°†i,jçš„è·ç¦»å·®åµŒå…¥åˆ°ä¸€ä¸ª<code>embedding</code>ä¸­æ›´åˆé€‚</p><h4 id="Rethinking-and-Improving-Relative-Position-Encoding-for-Vision-Transformer"><a href="#Rethinking-and-Improving-Relative-Position-Encoding-for-Vision-Transformer" class="headerlink" title="Rethinking and Improving Relative Position Encoding for Vision Transformer"></a>Rethinking and Improving Relative Position Encoding for Vision Transformer</h4><p>è¿™æ˜¯ç¯‡å¥½æ–‡ç« ,å…³äºæ³¨æ„åŠ›ä¸­ç›¸å¯¹ä½ç½®ç”¨äº2då›¾åƒæ•°æ®çš„æ–¹æ³•.ä¹Ÿæ˜¯åœ¨ä¸Šé¢SASAçš„ä¸€ç§æ”¹è¿›.</p><p><img data-src="https://s2.loli.net/2024/02/17/CHqOLZKXNxhIdzj.png" alt="image-20240217181329312"></p><p>ä»¥å¾€çš„ç›¸å¯¹ä½ç½®ç¼–ç æ–¹æ³•éƒ½ä¾èµ–äºè¾“å…¥åµŒå…¥ã€‚è¿™å°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå³ç¼–ç èƒ½å¦ç‹¬ç«‹äºè¾“å…¥?</p><p>è®ºæ–‡å¼•å…¥ç›¸å¯¹ä½ç½®ç¼–ç çš„åå‘æ¨¡å¼å’Œè¯­å¢ƒæ¨¡å¼æ¥ç ”ç©¶è¯¥é—®é¢˜ã€‚å‰è€…ç‹¬ç«‹äºè¾“å…¥åµŒå…¥ï¼Œè€Œåè€…è€ƒè™‘äº†ä¸æŸ¥è¯¢ã€é”®æˆ–å€¼çš„äº¤äº’ã€‚ä¹Ÿå°±ä¸Šå›¾çš„ä¸¤ç§æ¨¡å¼.</p><script type="math/tex; mode=display">e_{ij}=\frac{(\mathbf{x}_i\mathbf{W}^Q)(\mathbf{x}_j\mathbf{W}^K)^T\color{blue}{+}b_{ij}}{\sqrt{d_z}} \\b_{ij}=\bold{r}_{ij} \space for \space  bias \space mode\\b_{ij}=(x_{i}W^Q)r_{ij}\space for\space  context  \space mode\\</script><p>è®¡ç®—attention weightåŠ ä¸Šä¸€ä¸ªåç½®,åœ¨biasæ¨¡å¼ä¸‹,è¿™ä¸ªåç½®æ˜¯ä¸€ä¸ªå¯å­¦ä¹ çš„å‚æ•°,è¡¨ç¤ºç›¸å¯¹ä½ç½®çš„æƒé‡.</p><p>åœ¨contextæ¨¡å¼ä¸‹,æœ‰å¤šç§å¯è¡Œçš„æ–¹å¼.å…¶ä¸­ræ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„å‘é‡,ä¹Ÿè¡¨ç¤ºç›¸å¯¹ä½ç½®,ä½†å®ƒä¼šä¸Qæˆ–Käº¤äº’.</p><script type="math/tex; mode=display">b_{ij}=(\mathbf{x}_i\mathbf{W}^Q)(\mathbf{r}_{ij}^K)^T+(\mathbf{x}_j\mathbf{W}^K)(\mathbf{r}_{ij}^Q)^T</script><p>æ­¤å¤–contextæ¨¡å¼ä¹Ÿå¯ä»¥åº”ç”¨äºvalueåµŒå…¥</p><script type="math/tex; mode=display">\mathbf{z}_i=\sum_{j=1}^n\alpha_{ij}(\mathbf{x}_j\mathbf{W}^V\color{red}{+}\mathbf{r}_{ij}^V),</script><p>ä¸ºäº†è®¡ç®—äºŒç»´å›¾åƒå¹³é¢ä¸Šçš„ç›¸å¯¹ä½ç½®å¹¶å®šä¹‰ç›¸å¯¹æƒé‡r~ij~,æå‡ºäº†ä¸¤ç§æ— å‘æ˜ å°„æ–¹æ³•Euclideanå’ŒQuantizationï¼Œä»¥åŠä¸¤ç§æœ‰å‘æ˜ å°„æ–¹æ³•Crosså’ŒProductã€‚</p><script type="math/tex; mode=display">\mathbf{r}_{ij}=\mathbf{p}_{I(i,j)},</script><script type="math/tex; mode=display">I(i,j)=g(\sqrt{(\tilde{x}_i-\tilde{x}_j)^2+(\tilde{y}_i-\tilde{y}_j)^2}),</script><p>åœ¨ä¸Šè¿°æ¬§å‡ é‡Œå¾—æ–¹æ³•ä¸­ï¼Œè·ç¦»è¾ƒè¿‘çš„ä¸¤ä¸ªå…·æœ‰ä¸åŒç›¸å¯¹è·ç¦»çš„é‚»å±…å¯èƒ½è¢«æ˜ å°„åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä¾‹å¦‚äºŒç»´ç›¸å¯¹ä½ç½®( 1ã€0 )å’Œ( 1 , 1)éƒ½è¢«æ˜ å°„åˆ°ç´¢å¼•1ä¸­ã€‚å‡è®¾è¿‘é‚»åº”è¯¥æ˜¯åˆ†ç¦»çš„ã€‚å› æ­¤å¯¹æ¬§æ°è·ç¦»è¿›è¡Œé‡åŒ–ï¼Œå³å°†ä¸åŒçš„å®æ•°æ˜ å°„æˆä¸åŒçš„æ•´æ•°ã€‚</p><script type="math/tex; mode=display">I(i,j)=g(quant(\sqrt{(\tilde{x}_i-\tilde{x}_j)^2+(\tilde{y}_i-\tilde{y}_j)^2}).</script><p>è¿ç®—quant ( Â· )å°†ä¸€ç»„å®æ•°{ 0ï¼Œ1ï¼Œ1.41ï¼Œ2ï¼Œ2.24ï¼Œ.. }æ˜ å°„ä¸ºä¸€ç»„æ•´æ•°{ 0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ.. } .è¿™ç§æ–¹æ³•ä¹Ÿæ˜¯æ— å‘çš„.</p><p>åƒç´ çš„ä½ç½®æ–¹å‘å¯¹å›¾åƒä¹Ÿå¾ˆé‡è¦ï¼Œå› æ­¤æå‡ºäº†æœ‰å‘æ˜ å°„æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•è¢«ç§°ä¸ºCrossæ–¹æ³•ï¼Œå®ƒåˆ†åˆ«åœ¨æ°´å¹³å’Œå‚ç›´æ–¹å‘ä¸Šè®¡ç®—ç¼–ç ï¼Œç„¶åè¿›è¡Œæ±‡æ€»ã€‚æ–¹æ³•å¦‚ä¸‹</p><script type="math/tex; mode=display">\begin{gathered}\mathbf{r}_{ij}=\mathbf{p}_{I^{\tilde{x}}(i,j)}^{\tilde{x}}+\mathbf{p}_{I^{\tilde{y}}(i,j)}^{\tilde{y}}, \\I^{\tilde{x}}(i,j)=g(\tilde{x_{i}}-\tilde{x_{j}}), \\I^{\tilde{y}}(i,j)=g(\tilde{y}_i-\tilde{y}_j), \end{gathered}</script><p>å¦‚æœæŸä¸ªæ–¹å‘ä¸Šçš„è·ç¦»æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆCrossæ–¹æ³•å°†ä¸åŒçš„ç›¸å¯¹ä½ç½®ç¼–ç åˆ°åŒä¸€ä¸ªåµŒå…¥ä¸­ï¼Œæ­¤å¤–å¸¦æ¥äº†é¢å¤–çš„è®¡ç®—å¼€é”€ã€‚ä¸ºäº†æé«˜æ•ˆç‡å¹¶åŒ…å«æ›´å¤šçš„æ–¹å‘æ€§ä¿¡æ¯ï¼Œè®¾è®¡äº†Productæ–¹æ³•ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><p><img data-src="https://s2.loli.net/2024/02/17/2rIStXgva96PhTZ.png" alt="image-20240217223648427"></p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><h3 id="Swin-transformer"><a href="#Swin-transformer" class="headerlink" title="Swin transformer"></a>Swin transformer</h3><p><a href="https://arxiv.org/abs/2103.14030">[2103.14030] Swin Transformer: Hierarchical Vision Transformer using Shifted Windows (arxiv.org)</a></p><p><a href="https://arxiv.org/abs/2111.09883">[2111.09883] Swin Transformer V2: Scaling Up Capacity and Resolution (arxiv.org)</a></p><p><img data-src="https://s2.loli.net/2024/02/18/NMFCXv8EKabh6cp.png" alt="image-20240218140849412"></p><script type="math/tex; mode=display">\begin{aligned}\Omega(\mathbf{MSA})&=4hwC^2+2(hw)^2C,\\\Omega(\mathbf{W-MSA})&=4hwC^2+2M^2hwC,\end{aligned}</script><p><img data-src="https://s2.loli.net/2024/02/18/WBD3do8KnrHqlLU.png" alt="image-20240218141119075"></p><blockquote><p>å°†Transformerä»è¯­è¨€è½¬æ¢åˆ°è§†è§‰çš„æŒ‘æˆ˜æ¥è‡ªäºä¸¤ä¸ªé¢†åŸŸä¹‹é—´çš„å·®å¼‚ï¼Œä¾‹å¦‚è§†è§‰å®ä½“çš„å°ºåº¦å˜åŒ–è¾ƒå¤§ï¼Œå›¾åƒä¸­çš„åƒç´ ç›¸å¯¹äºæ–‡æœ¬ä¸­çš„æ–‡å­—åˆ†è¾¨ç‡è¾ƒé«˜ã€‚</p><p>ä¸ºäº†è§£å†³è¿™äº›å·®å¼‚ï¼Œæå‡ºäº†ä¸€ä¸ªåˆ†å±‚Transformerï¼Œå…¶è¡¨ç¤ºç”±Shiftedçª—å£è®¡ç®—ã€‚ç§»ä½çª—å£æ–¹æ¡ˆé€šè¿‡å°†è‡ªæ³¨æ„åŠ›è®¡ç®—é™åˆ¶åœ¨ä¸é‡å çš„å±€éƒ¨çª—å£ï¼ŒåŒæ—¶å…è®¸è·¨çª—å£è¿æ¥ï¼Œä»è€Œå¸¦æ¥æ›´é«˜çš„æ•ˆç‡ã€‚è¿™ç§åˆ†å±‚æ¶æ„å…·æœ‰åœ¨å„ç§å°ºåº¦ä¸‹å»ºæ¨¡çš„çµæ´»æ€§ï¼Œå¹¶ä¸”å…·æœ‰ä¸å›¾åƒå¤§å°ç›¸å…³çš„çº¿æ€§è®¡ç®—å¤æ‚åº¦ã€‚</p></blockquote><p><img data-src="https://s2.loli.net/2024/02/21/If19Km8TFPneM6x.png" alt="image-20240221231106703"></p><h3 id="Swin-transformerV2"><a href="#Swin-transformerV2" class="headerlink" title="Swin-transformerV2"></a>Swin-transformerV2</h3><p><a href="https://arxiv.org/abs/2111.09883">[2111.09883] Swin Transformer V2: Scaling Up Capacity and Resolution (arxiv.org)</a></p><p><img data-src="https://s2.loli.net/2024/02/21/6izranSXgP7CobN.png" alt="image-20240221231423057"></p><h3 id="Twins"><a href="#Twins" class="headerlink" title="Twins"></a>Twins</h3><p><a href="https://arxiv.org/abs/2104.13840">[2104.13840] Twins: Revisiting the Design of Spatial Attention in Vision Transformers (arxiv.org)</a></p><p><img data-src="https://github.com/lucidrains/vit-pytorch/raw/main/images/twins_svt.png" alt="img" style="zoom:67%;" /></p><p><img data-src="https://s2.loli.net/2024/02/18/1Zf5pWymzPTaHoB.png" alt="image-20240218141741213"></p><blockquote><p>åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œé‡æ–°å®¡è§†äº†ç©ºé—´æ³¨æ„åŠ›çš„è®¾è®¡ï¼Œå¹¶è¯æ˜äº†ä¸€ä¸ªç²¾å¿ƒè®¾è®¡ä½†ç®€å•çš„ç©ºé—´æ³¨æ„åŠ›æœºåˆ¶ä¸æœ€å…ˆè¿›çš„æ–¹æ¡ˆç›¸æ¯”å…·æœ‰è‰¯å¥½çš„æ€§èƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸¤ç§è§†è§‰è½¬æ¢å™¨ç»“æ„ï¼Œå³Twins - PCPVTå’ŒTwinsSVTã€‚æˆ‘ä»¬æå‡ºçš„æ¶æ„é«˜æ•ˆä¸”æ˜“äºå®ç°ï¼Œåªæ¶‰åŠåœ¨ç°ä»£æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­é«˜åº¦ä¼˜åŒ–çš„çŸ©é˜µä¹˜æ³•ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ‰€æå‡ºçš„æ¶æ„åœ¨åŒ…æ‹¬å›¾åƒçº§claåœ¨å†…çš„å¹¿æ³›çš„è§†è§‰ä»»åŠ¡ä¸Šå–å¾—äº†ä¼˜å¼‚çš„æ€§èƒ½</p></blockquote><p>æ­¤å¤–éšç€æ—¶é—´å‘å±•,ç›®å‰å·²ç»æœ‰äº†ç©ºé—´æ³¨æ„åŠ›,é€šé“æ³¨æ„åŠ›ç­‰ç­‰å¯ä»¥ç”¨äº2Dæ•°æ®çš„æ³¨æ„åŠ›æ¨¡å‹.ä½†æ˜¯åŸºæœ¬æ€æƒ³æ˜¯ç±»ä¼¼çš„.</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://zhuanlan.zhihu.com/p/364828960">Relative position embedding - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://arxiv.org/abs/1803.02155">[1803.02155] Self-Attention with Relative Position Representations (arxiv.org)</a></li><li><a href="https://placebokkk.github.io/asr/2021/01/14/asr-rpe.html">Relative Positional Embedding | Chao Yang (placebokkk.github.io)</a></li><li><a href="https://aclanthology.org/2020.findings-emnlp.298.pdf">Improve Transformer Models with Better Relative Position Embeddings (aclanthology.org)</a></li><li><a href="https://zhuanlan.zhihu.com/p/352898810">è®©ç ”ç©¶äººå‘˜ç»å°½è„‘æ±çš„Transformerä½ç½®ç¼–ç  - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://zhuanlan.zhihu.com/p/669523714">ã€ŠA survey of the Vision Transformers and its CNN-Transformer based Variantsã€‹ç¬¬ä¸€æœŸ - çŸ¥ä¹ (zhihu.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿™é‡Œä»‹ç»ä¸€äº›ç»†èŠ‚ä¿¡æ¯.æœ‰å…³ä½ç½®ç¼–ç ä¿¡æ¯å’Œç”¨äºå›¾åƒçš„transformer.&lt;br&gt;</summary>
    
    
    
    
    <category term="transformers" scheme="https://www.sekyoro.top/tags/transformers/"/>
    
    <category term="attention" scheme="https://www.sekyoro.top/tags/attention/"/>
    
  </entry>
  
  <entry>
    <title>TypeScript on the way:å­¦ä¹ TypeScript</title>
    <link href="https://www.sekyoro.top/2024/02/11/TypeScript-on-the-way-%E5%AD%A6%E4%B9%A0TypeScript/"/>
    <id>https://www.sekyoro.top/2024/02/11/TypeScript-on-the-way-%E5%AD%A6%E4%B9%A0TypeScript/</id>
    <published>2024-02-11T08:01:13.000Z</published>
    <updated>2024-02-13T12:02:04.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æ—©è¯¥å­¦å­¦äº†.<br><span id="more"></span></p><p>ä¹‹å‰å†™è¿‡Pythonçš„ç±»å‹ç³»ç»Ÿ,å¦‚æœå¯¹äºå†™C++,Java,C#ç­‰è¿™ç±»è¯­è¨€æ¥è¯´,typingæ ¹æœ¬ä¸æˆé—®é¢˜,æ‰€ä»¥ç†è§£TypeScriptä¹Ÿä¸æ˜¯é—®é¢˜.</p><h2 id="ç‰¹æ®Šçš„ç±»å‹"><a href="#ç‰¹æ®Šçš„ç±»å‹" class="headerlink" title="ç‰¹æ®Šçš„ç±»å‹"></a>ç‰¹æ®Šçš„ç±»å‹</h2><h3 id="any-unknownä¸never"><a href="#any-unknownä¸never" class="headerlink" title="any,unknownä¸never"></a>any,unknownä¸never</h3><p>any,unknownæ˜¯â€é¡¶å±‚ç±»å‹â€,neveræ˜¯â€åº•å±‚ç±»å‹â€.neverç±»å‹æ˜¯æ‰€æœ‰ç±»å‹å…±æœ‰çš„,anyç±»å‹åŸºæœ¬æ²¡æœ‰é™åˆ¶,unknownç±»å‹ä¸èƒ½ç›´æ¥è°ƒç”¨å¹¶ä¸”è¿ç®—æ˜¯æœ‰é™çš„,åªèƒ½è¿›è¡Œæ¯”è¾ƒè¿ç®—.æ¨èä½¿ç”¨unknownä»£æ›¿anyç„¶åä½¿ç”¨asè½¬æ¢ç±»å‹.</p><h2 id="ç±»å‹ç³»ç»Ÿ"><a href="#ç±»å‹ç³»ç»Ÿ" class="headerlink" title="ç±»å‹ç³»ç»Ÿ"></a>ç±»å‹ç³»ç»Ÿ</h2><h3 id="Stringä¸string-Numberä¸number"><a href="#Stringä¸string-Numberä¸number" class="headerlink" title="Stringä¸string,Numberä¸number"></a>Stringä¸string,Numberä¸number</h3><p>Stringä¸stringæ˜¯ä¸åŒçš„,å‰è€…æ˜¯å¯ä»¥åŒ…å«åè€…çš„.ä½†æ˜¯åœ¨tsä¸­,å¾ˆå¤šæ–¹æ³•åªèƒ½ä½¿ç”¨åè€….</p><p>æ‰€ä»¥æ¨èåªä½¿ç”¨åè€….</p><p><img data-src="https://s2.loli.net/2024/02/11/4DiknPFr569Ulgp.png" alt="image-20240211171858237"></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj: <span class="built_in">Object</span>;</span><br><span class="line"><span class="keyword">let</span> obj2:&#123;&#125;;</span><br><span class="line">obj = &#123; <span class="attr">name</span>: <span class="string">&quot;John&quot;</span> &#125;;</span><br><span class="line">obj = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–Objectç±»å‹åŒ…æ‹¬é™¤äº†undefinedå’Œnullçš„åŸºæœ¬ç±»å‹.æ‰€ä»¥è¿™å¹¶ä¸ç¬¦åˆç›´è§‰,æ¨èä½¿ç”¨<code>object</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj3:<span class="built_in">object</span>;</span><br><span class="line">obj3 = &#123;<span class="attr">name</span>:<span class="string">&quot;John&quot;</span>&#125;;</span><br><span class="line">obj3 = <span class="number">13</span>; <span class="comment">//æŠ¥é”™ ä¸èƒ½å°†numberåˆ†é…ç»™ç±»å‹object</span></span><br></pre></td></tr></table></figure><p>objectç±»å‹åŒ…å«å¯¹è±¡,æ•°ç»„,å‡½æ•°.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ccx = &#123; <span class="attr">foo</span>: <span class="number">1</span> &#125;;</span><br><span class="line">ccx.foo = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">let</span> t = &#123; <span class="attr">foo</span>: <span class="number">1</span> &#125;;</span><br><span class="line">t.foo = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> hh:<span class="built_in">object</span> = &#123;<span class="attr">foo</span>:<span class="number">1</span>&#125;</span><br><span class="line"><span class="comment">// hh.foo æŠ¥é”™ ç±»å‹ä¸å¯¹</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–undefinedå’Œnullä¹Ÿå¯ä»¥èµ‹å€¼ä¸ºnumber,objectç­‰ç­‰.</p><p>TypeScriptä¸­å•ä¸ªå€¼ä¹Ÿæ˜¯ç±»å‹æˆä¸ºå€¼ç±»å‹</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> t: <span class="string">&quot;dfasdf&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> xy = <span class="string">&quot;https&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(xy);</span><br></pre></td></tr></table></figure><p>å°†å¤šä¸ªç±»å‹ç»„åˆèµ·æ¥å°±æ˜¯è”åˆç±»å‹,å¦‚æœä¸¥æ ¼æ£€æŸ¥ä¹Ÿå°±æ˜¯è®¾ç½®<code>strictNullChecks</code>,ä½¿å¾—å…¶ä»–ç±»å‹å˜é‡ä¸èƒ½è¢«èµ‹å€¼ä¸ºundefinedæˆ–null.è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨è”åˆç±»å‹</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> setting: <span class="literal">true</span> | <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> gender: <span class="string">&quot;male&quot;</span> | <span class="string">&quot;female&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rainbowColor: <span class="string">&quot;èµ¤&quot;</span> | <span class="string">&quot;æ©™&quot;</span> | <span class="string">&quot;é»„&quot;</span> | <span class="string">&quot;ç»¿&quot;</span> | <span class="string">&quot;é’&quot;</span> | <span class="string">&quot;è“&quot;</span> | <span class="string">&quot;ç´«&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> name: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;John&quot;</span>;</span><br><span class="line">name = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>å¯¹è±¡çš„åˆæˆå¯ä»¥ç»™å¯¹è±¡æ·»åŠ æ–°çš„å±æ€§,å±äºäº¤å‰ç±»å‹.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj5: &#123; <span class="attr">foo</span>: <span class="built_in">string</span> &#125; &amp; &#123; <span class="attr">bar</span>: <span class="built_in">number</span> &#125;;</span><br></pre></td></tr></table></figure><h3 id="ç±»å‹åˆ«å"><a href="#ç±»å‹åˆ«å" class="headerlink" title="ç±»å‹åˆ«å"></a>ç±»å‹åˆ«å</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Age = <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">let</span> age:Age =  <span class="number">55</span>;</span><br></pre></td></tr></table></figure><p>è·ŸPythonçš„typingå’ŒGoè¯­è¨€ç±»ä¼¼.</p><h2 id="æ•°ç»„-å…ƒç»„"><a href="#æ•°ç»„-å…ƒç»„" class="headerlink" title="æ•°ç»„ å…ƒç»„"></a>æ•°ç»„ å…ƒç»„</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr: <span class="built_in">number</span>[] = [];</span><br><span class="line"><span class="keyword">let</span> arr2: (<span class="built_in">number</span>|<span class="built_in">string</span>)[] = [];</span><br><span class="line"><span class="keyword">let</span> arr3: <span class="built_in">Array</span>&lt;<span class="built_in">number</span>&gt; = [];</span><br></pre></td></tr></table></figure><p>constæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¯ä»¥æ”¹å˜çš„,æ‰€ä»¥åœ¨tsä¸­å¢åŠ äº†<code>readonly</code>,readonlyæ•°ç»„æ˜¯åŸæœ¬æ•°ç»„çš„å­ç±»å‹.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr5: <span class="built_in">number</span>[] = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">arr5[<span class="number">0</span>] = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> arr6: <span class="keyword">readonly</span> <span class="built_in">number</span>[] = arr5;</span><br></pre></td></tr></table></figure><p>å£°æ˜readonlyæ•°ç»„</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> aa: <span class="keyword">readonly</span> <span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> a1: ReadonlyArray&lt;<span class="built_in">number</span>&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> a2: Readonly&lt;<span class="built_in">number</span>[]&gt; = [];</span><br><span class="line"><span class="keyword">let</span> a3 = [] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure><blockquote><p>TypeScript æ¨æ–­ç±»å‹æ—¶ï¼Œé‡åˆ°<code>const</code>å‘½ä»¤å£°æ˜çš„å˜é‡ï¼Œå¦‚æœä»£ç é‡Œé¢æ²¡æœ‰æ³¨æ˜ç±»å‹ï¼Œå°±ä¼šæ¨æ–­è¯¥å˜é‡æ˜¯å€¼ç±»å‹ã€‚</p><p><code>const</code>å‘½ä»¤å£°æ˜çš„å˜é‡ï¼Œå¦‚æœèµ‹å€¼ä¸ºå¯¹è±¡ï¼Œå¹¶ä¸ä¼šæ¨æ–­ä¸ºå€¼ç±»å‹,è¿™æ˜¯å› ä¸º JavaScript é‡Œé¢ï¼Œ<code>const</code>å˜é‡èµ‹å€¼ä¸ºå¯¹è±¡æ—¶ï¼Œå±æ€§å€¼æ˜¯å¯ä»¥æ”¹å˜çš„(æ•°ç»„ç­‰åŒç†)</p></blockquote><h3 id="å…ƒç»„tuple"><a href="#å…ƒç»„tuple" class="headerlink" title="å…ƒç»„tuple"></a>å…ƒç»„tuple</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s: [<span class="built_in">string</span>, <span class="built_in">string</span>, <span class="built_in">boolean</span>] = [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="literal">true</span>];</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å…ƒç»„æ—¶å¿…é¡»å£°æ˜ç±»å‹ä¸ç„¶ä¼šé»˜è®¤æ•°ç»„.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ot: [<span class="built_in">number</span>, <span class="built_in">string</span>?] | <span class="literal">undefined</span> = [<span class="number">1</span>];</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦å¯ä»¥ä¸ä¸‹æˆå‘˜æ•°é‡çš„å…ƒç»„.</p><p>å…ƒç»„ä¹Ÿæœ‰åªè¯»å…ƒç»„</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> readonlyTuple: <span class="keyword">readonly</span> [<span class="built_in">number</span>] = [<span class="number">1</span>];</span><br><span class="line"><span class="keyword">let</span> point = [<span class="number">3</span>, <span class="number">4</span>] <span class="keyword">as</span> <span class="keyword">const</span>;</span><br></pre></td></tr></table></figure><h3 id="symbolç±»å‹"><a href="#symbolç±»å‹" class="headerlink" title="symbolç±»å‹"></a>symbolç±»å‹</h3><p>symbolä¸»è¦ç”¨äºç±»çš„å±æ€§.</p><p>tså¢åŠ äº†unique symbolä½œä¸ºsymbolçš„å­ç±»å‹.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£ç¡®</span></span><br><span class="line"><span class="keyword">const</span> x: unique symbol = <span class="built_in">Symbol</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ¥é”™</span></span><br><span class="line"><span class="keyword">let</span> y: unique symbol = <span class="built_in">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> x: unique symbol = <span class="built_in">Symbol</span>();</span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line"><span class="keyword">const</span> x = <span class="built_in">Symbol</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> a: unique symbol = <span class="built_in">Symbol</span>();</span><br><span class="line"><span class="keyword">const</span> b: <span class="keyword">typeof</span> a = a; <span class="comment">// æ­£ç¡®</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰å¹³å¸¸å¯èƒ½ç”¨ä¸ä¸Šâ€¦</p><h3 id="å‡½æ•°-å¯¹è±¡-interface"><a href="#å‡½æ•°-å¯¹è±¡-interface" class="headerlink" title="å‡½æ•° å¯¹è±¡ interface"></a>å‡½æ•° å¯¹è±¡ interface</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">txt: <span class="built_in">string</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;hello &quot;</span> + txt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™æ³•ä¸€</span></span><br><span class="line"><span class="keyword">const</span> hello = <span class="function"><span class="keyword">function</span> (<span class="params">txt: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;hello &quot;</span> + txt);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™æ³•äºŒ</span></span><br><span class="line"><span class="keyword">const</span> hello: <span class="function">(<span class="params">txt: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span> = <span class="function"><span class="keyword">function</span> (<span class="params">txt</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;hello &quot;</span> + txt);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å£°æ˜ä¸å‡½æ•°å˜é‡å£°æ˜.å‰è€…éœ€è¦å£°æ˜å‚æ•°ç±»å‹,å¦åˆ™é»˜è®¤ä¸ºany.åè€…å¯ä»¥åœ¨é€‰æ‹©åœ¨èµ‹å€¼æ—¶å†™å‡ºç±»å‹æˆ–è€…åœ¨å£°æ˜å˜é‡æ—¶æ·»åŠ ç±»å‹.æ­¤å¤–è¿˜æœ‰è¿™ç§å†™æ³•</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> add: &#123;</span><br><span class="line">  (x: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">add = <span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="ç®­å¤´å‡½æ•°"><a href="#ç®­å¤´å‡½æ•°" class="headerlink" title="ç®­å¤´å‡½æ•°"></a>ç®­å¤´å‡½æ•°</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> repeat = (str: <span class="built_in">string</span>, <span class="attr">times</span>: <span class="built_in">number</span>): <span class="function"><span class="params">string</span> =&gt;</span> str.repeat(times);</span><br></pre></td></tr></table></figure><p>å¦å¤–ä½¿ç”¨?è¡¨ç¤ºå¯é€‰å‚æ•°</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x?: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(); <span class="comment">// OK</span></span><br><span class="line">f(<span class="number">10</span>); <span class="comment">// OK</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤å€¼ä¹Ÿç±»ä¼¼.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPoint</span>(<span class="params">x: <span class="built_in">number</span> = <span class="number">0</span>, y: <span class="built_in">number</span> = <span class="number">0</span></span>): [<span class="title">number</span>, <span class="title">number</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [x, y];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createPoint(); <span class="comment">// [0, 0]</span></span><br></pre></td></tr></table></figure><p>restå‚æ•°ä¹Ÿå¯ä»¥ç”¨äºå°†å¤šä¸ªå€¼åŒ…è£¹ä¸ºæ•°ç»„æˆ–å…ƒç»„</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">joinNum</span>(<span class="params">...nums: [...<span class="built_in">number</span>[]]</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(nums);</span><br><span class="line">  <span class="keyword">return</span> nums.join(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">joinNum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">joinNumAndString</span>(<span class="params">...args: [<span class="built_in">string</span>, <span class="built_in">number</span>]</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">joinNumAndString(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨readonlyè¿›è¡Œä¿®é¥°.</p><p>æ­¤å¤–å‡½æ•°è¿”å›æœ‰voidå’Œneverç±»å‹.å‰è€…è¡¨ç¤ºæ²¡æœ‰è¿”å›å€¼(æˆ–undefined)åè€…è¡¨ç¤ºä¸ä¼šé€€å‡º,å¸¸ç”¨äºä¸¢é”™è¯¯æˆ–å¾ªç¯.</p><h4 id="å‡½æ•°é‡è½½"><a href="#å‡½æ•°é‡è½½" class="headerlink" title="å‡½æ•°é‡è½½"></a>å‡½æ•°é‡è½½</h4><p>ä¸åŒäºå…¶ä»–è¯­è¨€é‡è½½,</p><blockquote><p>æœ‰ä¸€äº›ç¼–ç¨‹è¯­è¨€å…è®¸ä¸åŒçš„å‡½æ•°å‚æ•°ï¼Œå¯¹åº”ä¸åŒçš„å‡½æ•°å®ç°ã€‚ä½†æ˜¯ï¼ŒJavaScript å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªå®ç°ï¼Œå¿…é¡»åœ¨è¿™ä¸ªå®ç°å½“ä¸­ï¼Œå¤„ç†ä¸åŒçš„å‚æ•°ã€‚å› æ­¤ï¼Œå‡½æ•°ä½“å†…éƒ¨å°±éœ€è¦åˆ¤æ–­å‚æ•°çš„ç±»å‹åŠä¸ªæ•°ï¼Œå¹¶æ ¹æ®åˆ¤æ–­ç»“æœæ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">str: <span class="built_in">string</span></span>): <span class="title">string</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">arr: <span class="built_in">any</span>[]</span>): <span class="title">any</span>[]</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">stringOrArray: <span class="built_in">string</span> | <span class="built_in">any</span>[]</span>): <span class="title">string</span> | <span class="title">any</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> stringOrArray === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> stringOrArray.split(<span class="string">&quot;&quot;</span>).reverse().join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span> stringOrArray.slice().reverse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡è½½å£°æ˜çš„æ’åºå¾ˆé‡è¦ï¼Œå› ä¸º TypeScript æ˜¯æŒ‰ç…§é¡ºåºè¿›è¡Œæ£€æŸ¥çš„ï¼Œä¸€æ—¦å‘ç°ç¬¦åˆæŸä¸ªç±»å‹å£°æ˜ï¼Œå°±ä¸å†å¾€ä¸‹æ£€æŸ¥äº†ï¼Œæ‰€ä»¥ç±»å‹æœ€å®½çš„å£°æ˜åº”è¯¥æ”¾åœ¨æœ€åé¢ï¼Œé˜²æ­¢è¦†ç›–å…¶ä»–ç±»å‹å£°æ˜</p><p><strong>æ„é€ å‡½æ•°</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AnimalConstructor = <span class="keyword">new</span> () =&gt; Animal;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">c: AnimalConstructor</span>): <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> c();</span><br><span class="line">&#125;</span><br><span class="line">create(Animal);</span><br></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°çš„ç±»å‹å†™æ³•ï¼Œå°±æ˜¯åœ¨å‚æ•°åˆ—è¡¨å‰é¢åŠ ä¸Š<code>new</code>å‘½ä»¤</p><p>æ­¤å¤–ä¹Ÿæœ‰å¯¹è±¡å½¢å¼å†™æ³•</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> F = &#123;</span><br><span class="line">  <span class="keyword">new</span> (s: <span class="built_in">string</span>): <span class="built_in">object</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹å¯¹è±¡,æ—¢å¯ä»¥ä½¿ç”¨<code>type</code>åˆ«åä¹Ÿå¯ä»¥ä½¿ç”¨<code>interface</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> ReadOnlyPerson &#123;</span><br><span class="line">  <span class="keyword">readonly</span> name: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">readonly</span> age: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> w:ReadOnlyPerson = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">22</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç©ºå¯¹è±¡æ˜¯ TypeScript çš„ä¸€ç§ç‰¹æ®Šå€¼ï¼Œä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹ã€‚</p><blockquote><p>TypeScript ä¸å…è®¸åŠ¨æ€æ·»åŠ å±æ€§ï¼Œæ‰€ä»¥å¯¹è±¡ä¸èƒ½åˆ†æ­¥ç”Ÿæˆï¼Œå¿…é¡»ç”Ÿæˆæ—¶ä¸€æ¬¡æ€§å£°æ˜æ‰€æœ‰å±æ€§ã€‚</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">obj.prop = <span class="number">123</span>; <span class="comment">// æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>å› ä¸º<code>Object</code>å¯ä»¥æ¥å—å„ç§ç±»å‹çš„å€¼ï¼Œè€Œç©ºå¯¹è±¡æ˜¯<code>Object</code>ç±»å‹çš„ç®€å†™ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæœ‰ä¸¥æ ¼å­—é¢é‡æ£€æŸ¥ï¼Œèµ‹å€¼æ—¶æ€»æ˜¯å…è®¸å¤šä½™çš„å±æ€§ï¼Œåªæ˜¯ä¸èƒ½è¯»å–è¿™äº›å±æ€§ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Empty &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> b: Empty = &#123; <span class="attr">myProp</span>: <span class="number">1</span>, <span class="attr">anotherProp</span>: <span class="number">2</span> &#125;; <span class="comment">// æ­£ç¡®</span></span><br><span class="line">b.myProp; <span class="comment">// æŠ¥é”™</span></span><br><span class="line"><span class="keyword">let</span> d: &#123;&#125;;</span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line"><span class="comment">// let d:Object;</span></span><br><span class="line"></span><br><span class="line">d = &#123;&#125;;</span><br><span class="line">d = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;;</span><br><span class="line">d = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">d = <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>interface æ˜¯å¯¹è±¡çš„æ¨¡æ¿ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ç±»å‹çº¦å®šï¼Œä¸­æ–‡è¯‘ä¸ºâ€œæ¥å£â€ã€‚ä½¿ç”¨äº†æŸä¸ªæ¨¡æ¿çš„å¯¹è±¡ï¼Œå°±æ‹¥æœ‰äº†æŒ‡å®šçš„ç±»å‹ç»“æ„ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Person &#123;</span><br><span class="line">  <span class="attr">firstName</span>: <span class="built_in">string</span>;</span><br><span class="line">  lastName: <span class="built_in">string</span>;</span><br><span class="line">  age: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>interface å¯ä»¥è¡¨ç¤ºå¯¹è±¡çš„å„ç§è¯­æ³•ï¼Œå®ƒçš„æˆå‘˜æœ‰ 5 ç§å½¢å¼ã€‚</p><ul><li>å¯¹è±¡å±æ€§</li><li>å¯¹è±¡çš„å±æ€§ç´¢å¼•</li><li>å¯¹è±¡æ–¹æ³•</li><li>å‡½æ•°</li><li>æ„é€ å‡½æ•°</li></ul></blockquote><p>interface ä¸ type çš„åŒºåˆ«æœ‰ä¸‹é¢å‡ ç‚¹ã€‚</p><p>ï¼ˆ1ï¼‰<code>type</code>èƒ½å¤Ÿè¡¨ç¤ºéå¯¹è±¡ç±»å‹ï¼Œè€Œ<code>interface</code>åªèƒ½è¡¨ç¤ºå¯¹è±¡ç±»å‹ï¼ˆåŒ…æ‹¬æ•°ç»„ã€å‡½æ•°ç­‰ï¼‰ã€‚</p><p>ï¼ˆ2ï¼‰<code>interface</code>å¯ä»¥ç»§æ‰¿å…¶ä»–ç±»å‹ï¼Œ<code>type</code>ä¸æ”¯æŒç»§æ‰¿ã€‚</p><p>å¯ä»¥åœ¨interfaceä¸­å†™æ–¹æ³•ä»¥åŠåˆ©ç”¨interfaceå†™å‡½æ•°,æ„é€ å‡½æ•°.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™æ³•ä¸€</span></span><br><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  f(x: <span class="built_in">boolean</span>): <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™æ³•äºŒ</span></span><br><span class="line"><span class="keyword">interface</span> B &#123;</span><br><span class="line">  <span class="attr">f</span>: <span class="function">(<span class="params">x: <span class="built_in">boolean</span></span>) =&gt;</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™æ³•ä¸‰</span></span><br><span class="line"><span class="keyword">interface</span> C &#123;</span><br><span class="line">  <span class="attr">f</span>: &#123; (x: <span class="built_in">boolean</span>): <span class="built_in">string</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Add &#123;</span><br><span class="line">  (x: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myAdd: Add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> ErrorConstructor &#123;</span><br><span class="line">  <span class="keyword">new</span> (message?: <span class="built_in">string</span>): <span class="built_in">Error</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>interfaceå¯ä»¥å®ç°ç»§æ‰¿,è€Œtypeä¸è¡Œ.è€Œä¸”å¯ä»¥å¤šç»§æ‰¿.å¤šé‡ç»§æ‰¿æ—¶,å¦‚æœå¤šä¸ªçˆ¶æ¥å£å­˜åœ¨åŒåå±æ€§,é‚£ä¹ˆè¿™äº›åŒåå±æ€§ä¸èƒ½æœ‰ç±»å‹å†²çª,å¦åˆ™ä¼šæŠ¥é”™</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Circle <span class="keyword">extends</span> Shape &#123;</span><br><span class="line">  <span class="attr">radius</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Style &#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Circle <span class="keyword">extends</span> Style, Shape &#123;</span><br><span class="line">  <span class="attr">radius</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Country = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  capital: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> CountryWithPop <span class="keyword">extends</span> Country &#123;</span><br><span class="line">  <span class="attr">population</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œå¦‚æœ<code>type</code>å‘½ä»¤å®šä¹‰çš„ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œinterface å°±æ— æ³•ç»§æ‰¿</p><p>å¤šä¸ªåŒåæ¥å£ä¼šè¿›è¡Œåˆå¹¶.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Box &#123;</span><br><span class="line">  <span class="attr">height</span>: <span class="built_in">number</span>;</span><br><span class="line">  width: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Box &#123;</span><br><span class="line">  <span class="attr">length</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸¾ä¾‹æ¥è¯´ï¼ŒWeb ç½‘é¡µå¼€å‘ç»å¸¸ä¼šå¯¹<code>windows</code>å¯¹è±¡å’Œ<code>document</code>å¯¹è±¡æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼Œä½†æ˜¯ TypeScript ä¼šæŠ¥é”™ï¼Œå› ä¸ºåŸå§‹å®šä¹‰æ²¡æœ‰è¿™äº›å±æ€§ã€‚è§£å†³æ–¹æ³•å°±æ˜¯æŠŠè‡ªå®šä¹‰å±æ€§å†™æˆ interfaceï¼Œåˆå¹¶è¿›åŸå§‹å®šä¹‰ã€‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  f(x: <span class="string">&quot;foo&quot;</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  f(x: <span class="built_in">any</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  f(x: <span class="string">&quot;foo&quot;</span>): <span class="built_in">boolean</span>;</span><br><span class="line">  f(x: <span class="built_in">any</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ª interface ç»„æˆçš„è”åˆç±»å‹å­˜åœ¨åŒåå±æ€§ï¼Œé‚£ä¹ˆè¯¥å±æ€§çš„ç±»å‹ä¹Ÿæ˜¯è”åˆç±»å‹</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Circle &#123;</span><br><span class="line">  <span class="attr">area</span>: bigint;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Rectangle &#123;</span><br><span class="line">  <span class="attr">area</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> s: Circle | Rectangle;</span><br><span class="line"></span><br><span class="line">s.area; <span class="comment">// bigint | number</span></span><br></pre></td></tr></table></figure><h3 id="ç±»"><a href="#ç±»" class="headerlink" title="ç±»"></a>ç±»</h3><p>å¯¹äºé¡¶å±‚å£°æ˜çš„å±æ€§ï¼Œå¯ä»¥åœ¨å£°æ˜æ—¶åŒæ—¶ç»™å‡ºç±»å‹,å¦‚æœä¸ç»™å£°æ˜é»˜è®¤any.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="attr">x</span>: <span class="built_in">number</span>;</span><br><span class="line">  y: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>TypeScript æœ‰ä¸€ä¸ªé…ç½®é¡¹<code>strictPropertyInitialization</code>ï¼Œåªè¦æ‰“å¼€ï¼Œå°±ä¼šæ£€æŸ¥å±æ€§æ˜¯å¦è®¾ç½®äº†åˆå€¼ï¼Œå¦‚æœæ²¡æœ‰å°±æŠ¥é”™ã€‚</p></blockquote><p><img data-src="https://s2.loli.net/2024/02/12/4chodubBD5QySIM.png" alt="image-20240212174733858"></p><p>å¦‚æœæ‰“å¼€äº†è¿™ä¸ªè®¾ç½®ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œä¸æ˜¯åœ¨å£°æ˜æ—¶èµ‹å€¼æˆ–åœ¨æ„é€ æ–¹æ³•é‡Œé¢èµ‹å€¼ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªè®¾ç½®æŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨éç©ºæ–­è¨€ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  x!: <span class="built_in">number</span>;</span><br><span class="line">  y!: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³›å‹ç±»</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">Type</span>&gt; </span>&#123;</span><br><span class="line">  <span class="attr">contents</span>: Type;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">value: Type</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contents = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b: Box&lt;<span class="built_in">string</span>&gt; = <span class="keyword">new</span> Box(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="attr">key</span>: K;</span><br><span class="line">  value: V;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŠ½è±¡ç±»</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">  <span class="attr">bar</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠ½è±¡ç±»çš„å†…éƒ¨å¯ä»¥æœ‰å·²ç»å®ç°å¥½çš„å±æ€§å’Œæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æœ‰è¿˜æœªå®ç°çš„å±æ€§å’Œæ–¹æ³•ã€‚åè€…å°±å«åšâ€œæŠ½è±¡æˆå‘˜â€ï¼ˆabstract memberï¼‰ï¼Œå³å±æ€§åå’Œæ–¹æ³•åæœ‰<code>abstract</code>å…³é”®å­—ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦å­ç±»å®ç°ã€‚å¦‚æœå­ç±»æ²¡æœ‰å®ç°æŠ½è±¡æˆå‘˜ï¼Œå°±ä¼šæŠ¥é”™ã€‚</p><h3 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFirst</span>&lt;<span class="title">Type</span>&gt;(<span class="params">arr: Type[]</span>): <span class="title">Type</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¸ºäº†æ–¹ä¾¿ï¼Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå¾€å¾€çœç•¥ä¸å†™ç±»å‹å‚æ•°çš„å€¼ï¼Œè®© TypeScript è‡ªå·±æ¨æ–­,æœ‰äº›å¤æ‚çš„ä½¿ç”¨åœºæ™¯ï¼ŒTypeScript å¯èƒ½æ¨æ–­ä¸å‡ºç±»å‹å‚æ•°çš„å€¼ï¼Œè¿™æ—¶å°±å¿…é¡»æ˜¾å¼ç»™å‡º.</p><blockquote><p>ç±»å‹å‚æ•°çš„åå­—ï¼Œå¯ä»¥éšä¾¿å–ï¼Œä½†æ˜¯å¿…é¡»ä¸ºåˆæ³•çš„æ ‡è¯†ç¬¦ã€‚ä¹ æƒ¯ä¸Šï¼Œç±»å‹å‚æ•°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¾€å¾€é‡‡ç”¨å¤§å†™å­—æ¯ã€‚ä¸€èˆ¬ä¼šä½¿ç”¨<code>T</code>ï¼ˆtype çš„ç¬¬ä¸€ä¸ªå­—æ¯ï¼‰ä½œä¸ºç±»å‹å‚æ•°çš„åå­—ã€‚å¦‚æœæœ‰å¤šä¸ªç±»å‹å‚æ•°ï¼Œåˆ™ä½¿ç”¨ T åé¢çš„ Uã€V ç­‰å­—æ¯å‘½åï¼Œå„ä¸ªå‚æ•°ä¹‹é—´ä½¿ç”¨é€—å·ï¼ˆâ€œ,â€ï¼‰åˆ†éš”ã€‚</p></blockquote><p>æ³›å‹ä¸»è¦ç”¨åœ¨å››ä¸ªåœºåˆï¼šå‡½æ•°ã€æ¥å£ã€ç±»å’Œåˆ«åã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">id</span>&lt;<span class="title">T</span>&gt;(<span class="params">arg: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">id</span>&lt;<span class="title">T</span>&gt;(<span class="params">arg: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> myid: &lt;T&gt;<span class="function">(<span class="params">arg: T</span>) =&gt;</span> T = id;</span><br><span class="line"><span class="keyword">interface</span> Box&lt;Type&gt; &#123;</span><br><span class="line">  <span class="attr">contents</span>: Type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> box: Box&lt;<span class="built_in">string</span>&gt;;</span><br></pre></td></tr></table></figure><p><strong>ç±»å‹åˆ«å</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Nullable&lt;T&gt; = T | <span class="literal">undefined</span> | <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Container&lt;T&gt; = &#123; <span class="attr">value</span>: T &#125;;</span><br><span class="line"><span class="keyword">type</span> Tree&lt;T&gt; = &#123;</span><br><span class="line">  <span class="attr">value</span>: T;</span><br><span class="line">  left: Tree&lt;T&gt; | <span class="literal">null</span>;</span><br><span class="line">  right: Tree&lt;T&gt; | <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç±»å‹å‚æ•°é»˜è®¤å€¼</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFirst_</span>&lt;<span class="title">T</span> = <span class="title">string</span>&gt;(<span class="params">arr: T[]</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»å‹å‚æ•°çš„çº¦æŸæ¡ä»¶</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">comp</span>&lt;<span class="title">Type</span> <span class="title">extends</span> </span>&#123; length: <span class="built_in">number</span> &#125;&gt;(a: Type, <span class="attr">b</span>: Type) &#123;</span><br><span class="line">  <span class="keyword">if</span> (a.length &gt; b.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Fn&lt;A <span class="keyword">extends</span> <span class="built_in">string</span>, B <span class="keyword">extends</span> <span class="built_in">string</span> = <span class="string">&quot;world&quot;</span>&gt; = [A, B];</span><br><span class="line"><span class="keyword">type</span> Result = Fn&lt;<span class="string">&quot;hello&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>ç±»å‹å‚æ•°çš„çº¦æŸæ¡ä»¶å¦‚ä¸‹</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;TypeParameter <span class="keyword">extends</span> ConstraintType&gt;</span><br></pre></td></tr></table></figure><p>æ³›å‹ä½¿ç”¨æ³¨æ„:</p><ol><li><strong>å°½é‡å°‘ç”¨æ³›å‹</strong></li><li><strong>ç±»å‹å‚æ•°è¶Šå°‘è¶Šå¥½</strong></li><li><strong>ç±»å‹å‚æ•°éœ€è¦å‡ºç°ä¸¤æ¬¡</strong></li><li><strong>æ³›å‹å¯ä»¥åµŒå¥—</strong></li></ol><h3 id="Enumç±»å‹"><a href="#Enumç±»å‹" class="headerlink" title="Enumç±»å‹"></a>Enumç±»å‹</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">enum</span> Color &#123;</span><br><span class="line">  Red, <span class="comment">// 0</span></span><br><span class="line">  Green, <span class="comment">// 1</span></span><br><span class="line">  Blue, <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">enum</span> Direction &#123;</span><br><span class="line">  Up = <span class="string">&quot;UP&quot;</span>,</span><br><span class="line">  Down = <span class="string">&quot;DOWN&quot;</span>,</span><br><span class="line">  Left = <span class="string">&quot;LEFT&quot;</span>,</span><br><span class="line">  Right = <span class="string">&quot;RIGHT&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Enum ç»“æ„æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç±»å‹ã€‚æ¯”å¦‚ï¼Œä¸Šä¾‹çš„å˜é‡<code>c</code>ç­‰äº<code>1</code>ï¼Œå®ƒçš„ç±»å‹å¯ä»¥æ˜¯ Colorï¼Œä¹Ÿå¯ä»¥æ˜¯<code>number</code></p><p>å¤šä¸ªåŒåçš„ Enum ç»“æ„ä¼šè‡ªåŠ¨åˆå¹¶ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">enum</span> MediaTypes &#123;</span><br><span class="line">  <span class="built_in">JSON</span> = <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">  XML = <span class="string">&quot;application/xml&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">fetch(url, &#123;</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="attr">Accept</span>: MediaTypes.JSON,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ç±»å‹æ–­è¨€"><a href="#ç±»å‹æ–­è¨€" class="headerlink" title="ç±»å‹æ–­è¨€"></a>ç±»å‹æ–­è¨€</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯­æ³•ä¸€</span></span><br><span class="line"><span class="keyword">let</span> bar: T = &lt;T&gt;foo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯­æ³•äºŒ</span></span><br><span class="line"><span class="keyword">let</span> bar: T = foo <span class="keyword">as</span> T;</span><br></pre></td></tr></table></figure><p>ç±»å‹æ–­è¨€è¦æ±‚å®é™…çš„ç±»å‹ä¸æ–­è¨€çš„ç±»å‹å…¼å®¹ï¼Œå®é™…ç±»å‹å¯ä»¥æ–­è¨€ä¸ºä¸€ä¸ªæ›´åŠ å®½æ³›çš„ç±»å‹ï¼ˆçˆ¶ç±»å‹ï¼‰ï¼Œä¹Ÿå¯ä»¥æ–­è¨€ä¸ºä¸€ä¸ªæ›´åŠ ç²¾ç¡®çš„ç±»å‹ï¼ˆå­ç±»å‹ï¼‰ï¼Œä½†ä¸èƒ½æ–­è¨€ä¸ºä¸€ä¸ªå®Œå…¨æ— å…³çš„ç±»å‹</p><p>æ­¤å¤–è¿˜æœ‰as constæ–­è¨€,<code>s const</code>æ–­è¨€åªèƒ½ç”¨äºå­—é¢é‡,<code>as const</code>ä¹Ÿä¸èƒ½ç”¨äºè¡¨è¾¾å¼</p><p>æˆ–è€…å…ˆæ–­è¨€ä¸ºunknown.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">as</span> unknown <span class="keyword">as</span> T;</span><br></pre></td></tr></table></figure><p>å¯¹äºé‚£äº›å¯èƒ½ä¸ºç©ºçš„å˜é‡ï¼ˆå³å¯èƒ½ç­‰äº<code>undefined</code>æˆ–<code>null</code>ï¼‰ï¼ŒTypeScript æä¾›äº†éç©ºæ–­è¨€ï¼Œä¿è¯è¿™äº›å˜é‡ä¸ä¼šä¸ºç©ºï¼Œå†™æ³•æ˜¯åœ¨å˜é‡ååé¢åŠ ä¸Šæ„Ÿå¹å·<code>!</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> root = <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>)!;</span><br></pre></td></tr></table></figure><p>æ–­è¨€å‡½æ•°</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">value: unknown</span>): <span class="title">asserts</span> <span class="title">value</span> <span class="title">is</span> <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">&quot;string&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;Not a string&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¨¡å—å’Œnamespace"><a href="#æ¨¡å—å’Œnamespace" class="headerlink" title="æ¨¡å—å’Œnamespace"></a>æ¨¡å—å’Œnamespace</h3><p>TypeScript æ¨¡å—é™¤äº†æ”¯æŒæ‰€æœ‰ ES æ¨¡å—çš„è¯­æ³•ï¼Œç‰¹åˆ«ä¹‹å¤„åœ¨äºå…è®¸è¾“å‡ºå’Œè¾“å…¥ç±»å‹ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Bool = <span class="literal">true</span> | <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p>æ¨¡å—åŠ è½½æ–¹å¼æœ‰classicå’ŒNode,ä¹Ÿå°±æ˜¯Command jså’ŒES6.</p><p>namespace ç”¨æ¥å»ºç«‹ä¸€ä¸ªå®¹å™¨ï¼Œå†…éƒ¨çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°ï¼Œéƒ½å¿…é¡»åœ¨è¿™ä¸ªå®¹å™¨é‡Œé¢ä½¿ç”¨ã€‚</p><blockquote><p>å®ƒå‡ºç°åœ¨ ES æ¨¡å—è¯ç”Ÿä¹‹å‰ï¼Œä½œä¸º TypeScript è‡ªå·±çš„æ¨¡å—æ ¼å¼è€Œå‘æ˜çš„ã€‚ä½†æ˜¯ï¼Œè‡ªä»æœ‰äº† ES æ¨¡å—ï¼Œå®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ namespace äº†ã€‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Utils &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">value: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;string&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ­£ç¡®</span></span><br><span class="line">  isString(<span class="string">&quot;yes&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Utils.isString(<span class="string">&quot;no&quot;</span>); <span class="comment">// æŠ¥é”™</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¦åœ¨å‘½åç©ºé—´ä»¥å¤–ä½¿ç”¨å†…éƒ¨æˆå‘˜ï¼Œå°±å¿…é¡»ä¸ºè¯¥æˆå‘˜åŠ ä¸Š<code>export</code>å‰ç¼€ï¼Œè¡¨ç¤ºå¯¹å¤–è¾“å‡ºè¯¥æˆå‘˜</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Utility &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">msg: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">msg: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Utility.log(<span class="string">&quot;Call me&quot;</span>);</span><br><span class="line">Utility.error(<span class="string">&quot;maybe!&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h3><p>è£…é¥°å™¨ï¼ˆDecoratorï¼‰æ˜¯ä¸€ç§è¯­æ³•ç»“æ„ï¼Œç”¨æ¥åœ¨å®šä¹‰æ—¶ä¿®æ”¹ç±»ï¼ˆclassï¼‰çš„è¡Œä¸ºã€‚</p><p>åœ¨è¯­æ³•ä¸Šï¼Œè£…é¥°å™¨æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹å¾ã€‚</p><p>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆæˆ–è€…è¯´å‰ç¼€ï¼‰æ˜¯<code>@</code>ï¼Œåé¢æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ã€‚</p><p>ï¼ˆ2ï¼‰<code>@</code>åé¢çš„è¡¨è¾¾å¼ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆæˆ–è€…æ‰§è¡Œåå¯ä»¥å¾—åˆ°ä¸€ä¸ªå‡½æ•°ï¼‰ã€‚</p><p>ï¼ˆ3ï¼‰è¿™ä¸ªå‡½æ•°æ¥å—æ‰€ä¿®é¥°å¯¹è±¡çš„ä¸€äº›ç›¸å…³å€¼ä½œä¸ºå‚æ•°ã€‚</p><p>ï¼ˆ4ï¼‰è¿™ä¸ªå‡½æ•°è¦ä¹ˆä¸è¿”å›å€¼ï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ªæ–°å¯¹è±¡å–ä»£æ‰€ä¿®é¥°çš„ç›®æ ‡å¯¹è±¡ã€‚</p><p>è£…é¥°å™¨å‡½æ•°å’Œè£…é¥°å™¨æ–¹æ³•</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Decorator = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  value: DecoratedValue,</span></span></span><br><span class="line"><span class="params"><span class="function">  context: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    kind: <span class="built_in">string</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="built_in">string</span> | symbol;</span></span></span><br><span class="line"><span class="params"><span class="function">    addInitializer?(initializer: () =&gt; <span class="built_in">void</span>): <span class="built_in">void</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">static</span>?: <span class="built_in">boolean</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span>?: <span class="built_in">boolean</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    access: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">      get?(): unknown;</span></span></span><br><span class="line"><span class="params"><span class="function">      set?(value: unknown): <span class="built_in">void</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> <span class="built_in">void</span> | ReplacementValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ClassDecorator = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  value: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  context: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    kind: <span class="string">&quot;class&quot;</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="built_in">string</span> | <span class="literal">undefined</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    addInitializer(initializer: () =&gt; <span class="built_in">void</span>): <span class="built_in">void</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> <span class="built_in">Function</span> | <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">countInstances</span>(<span class="params">value: <span class="built_in">any</span>, context: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> instanceCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> wrapper = <span class="function"><span class="keyword">function</span> (<span class="params">...args: <span class="built_in">any</span>[]</span>) </span>&#123;</span><br><span class="line">    instanceCount++;</span><br><span class="line">    <span class="keyword">const</span> instance = <span class="keyword">new</span> value(...args);</span><br><span class="line">    instance.count = instanceCount;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125; <span class="keyword">as</span> unknown <span class="keyword">as</span> <span class="keyword">typeof</span> MyClass;</span><br><span class="line"></span><br><span class="line">  wrapper.prototype = value.prototype; <span class="comment">// A</span></span><br><span class="line">  <span class="keyword">return</span> wrapper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@countInstances</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> inst1 = <span class="keyword">new</span> MyClass();</span><br><span class="line">inst1 <span class="keyword">instanceof</span> MyClass; <span class="comment">// true</span></span><br><span class="line">inst1.count; <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><h3 id="declareå…³é”®å­—"><a href="#declareå…³é”®å­—" class="headerlink" title="declareå…³é”®å­—"></a>declareå…³é”®å­—</h3><p>declare å…³é”®å­—ç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨ï¼ŒæŸä¸ªç±»å‹æ˜¯å­˜åœ¨çš„ï¼Œå¯ä»¥åœ¨å½“å‰æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</p><p>å®ƒçš„ä¸»è¦ä½œç”¨ï¼Œå°±æ˜¯è®©å½“å‰æ–‡ä»¶å¯ä»¥ä½¿ç”¨å…¶ä»–æ–‡ä»¶å£°æ˜çš„ç±»å‹ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œè‡ªå·±çš„è„šæœ¬ä½¿ç”¨å¤–éƒ¨åº“å®šä¹‰çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šå› ä¸ºä¸çŸ¥é“å¤–éƒ¨å‡½æ•°çš„ç±»å‹å®šä¹‰è€ŒæŠ¥é”™ï¼Œè¿™æ—¶å°±å¯ä»¥åœ¨è‡ªå·±çš„è„šæœ¬é‡Œé¢ä½¿ç”¨<code>declare</code>å…³é”®å­—ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¤–éƒ¨å‡½æ•°çš„ç±»å‹ã€‚è¿™æ ·çš„è¯ï¼Œç¼–è¯‘å•ä¸ªè„šæœ¬å°±ä¸ä¼šå› ä¸ºä½¿ç”¨äº†å¤–éƒ¨ç±»å‹è€ŒæŠ¥é”™ã€‚</p><p>declare å…³é”®å­—å¯ä»¥æè¿°ä»¥ä¸‹ç±»å‹ã€‚</p><ul><li>å˜é‡ï¼ˆconstã€letã€var å‘½ä»¤å£°æ˜ï¼‰</li><li>type æˆ–è€… interface å‘½ä»¤å£°æ˜çš„ç±»å‹</li><li>class</li><li>enum</li><li>å‡½æ•°ï¼ˆfunctionï¼‰</li><li>æ¨¡å—ï¼ˆmoduleï¼‰</li><li>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">let</span> x: <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name: <span class="built_in">string</span></span>): <span class="title">void</span></span>;</span><br><span class="line"></span><br><span class="line">sayHello(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line"><span class="keyword">declare</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>);</span><br><span class="line">  eat(): <span class="built_in">void</span>;</span><br><span class="line">  sleep(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">namespace</span> AnimalLib &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>);</span><br><span class="line">    eat(): <span class="built_in">void</span>;</span><br><span class="line">    sleep(): <span class="built_in">void</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">type</span> Animals = <span class="string">&quot;Fish&quot;</span> | <span class="string">&quot;Dog&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line"><span class="keyword">declare</span> <span class="built_in">module</span> AnimalLib &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>);</span><br><span class="line">    eat(): <span class="built_in">void</span>;</span><br><span class="line">    sleep(): <span class="built_in">void</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">type</span> Animals = <span class="string">&quot;Fish&quot;</span> | <span class="string">&quot;Dog&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="d-tsç±»å‹å£°æ˜æ–‡ä»¶"><a href="#d-tsç±»å‹å£°æ˜æ–‡ä»¶" class="headerlink" title="d.tsç±»å‹å£°æ˜æ–‡ä»¶"></a>d.tsç±»å‹å£°æ˜æ–‡ä»¶</h2><p>å¯ä»¥ä¸ºæ¯ä¸ªæ¨¡å—è„šæœ¬ï¼Œå®šä¹‰ä¸€ä¸ª<code>.d.ts</code>æ–‡ä»¶ï¼ŒæŠŠè¯¥è„šæœ¬ç”¨åˆ°çš„ç±»å‹å®šä¹‰éƒ½æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ã€‚ä½†æ˜¯ï¼Œæ›´æ–¹ä¾¿çš„åšæ³•æ˜¯ä¸ºæ•´ä¸ªé¡¹ç›®ï¼Œå®šä¹‰ä¸€ä¸ªå¤§çš„<code>.d.ts</code>æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ä½¿ç”¨<code>declare module</code>å®šä¹‰æ¯ä¸ªæ¨¡å—è„šæœ¬çš„ç±»å‹</p><p>ä½¿ç”¨æ—¶ï¼Œè‡ªå·±çš„è„šæœ¬ä½¿ç”¨ä¸‰æ–œæ å‘½ä»¤ï¼ŒåŠ è½½è¿™ä¸ªç±»å‹å£°æ˜æ–‡ä»¶ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference path=&quot;node.d.ts&quot;/&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ä¸Šé¢è¿™ä¸€è¡Œå‘½ä»¤ï¼Œè‡ªå·±çš„è„šæœ¬ä½¿ç”¨å¤–éƒ¨æ¨¡å—æ—¶ï¼Œå°±éœ€è¦åœ¨è„šæœ¬é‡Œé¢ä½¿ç”¨ declare å‘½ä»¤å•ç‹¬ç»™å‡ºå¤–éƒ¨æ¨¡å—çš„ç±»å‹ã€‚</p><blockquote><p>å•ç‹¬ä½¿ç”¨çš„æ¨¡å—ï¼Œä¸€èˆ¬ä¼šåŒæ—¶æä¾›ä¸€ä¸ªå•ç‹¬çš„ç±»å‹å£°æ˜æ–‡ä»¶ï¼ˆdeclaration fileï¼‰ï¼ŒæŠŠæœ¬æ¨¡å—çš„å¤–éƒ¨æ¥å£çš„æ‰€æœ‰ç±»å‹éƒ½å†™åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œä¾¿äºæ¨¡å—ä½¿ç”¨è€…äº†è§£æ¥å£ï¼Œä¹Ÿä¾¿äºç¼–è¯‘å™¨æ£€æŸ¥ä½¿ç”¨è€…çš„ç”¨æ³•æ˜¯å¦æ­£ç¡®ã€‚</p><p>ç±»å‹å£°æ˜æ–‡ä»¶é‡Œé¢åªæœ‰ç±»å‹ä»£ç ï¼Œæ²¡æœ‰å…·ä½“çš„ä»£ç å®ç°ã€‚å®ƒçš„æ–‡ä»¶åä¸€èˆ¬ä¸º<code>[æ¨¡å—å].d.ts</code>çš„å½¢å¼ï¼Œå…¶ä¸­çš„<code>d</code>è¡¨ç¤º declarationï¼ˆå£°æ˜ï¼‰</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference path=&quot;node.d.ts&quot;/&gt;</span></span><br><span class="line"><span class="keyword">import</span> &#123; test &#125; <span class="keyword">from</span> <span class="string">&quot;./test&quot;</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">let</span> x: <span class="built_in">number</span>;</span><br><span class="line">x = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(x);</span><br><span class="line"><span class="built_in">console</span>.log(test);</span><br><span class="line"><span class="keyword">let</span> p: Post = &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">title</span>: <span class="string">&quot;title&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;content&quot;</span> &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node.d.ts</span></span><br><span class="line"><span class="keyword">interface</span> Post &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line">  title: <span class="built_in">string</span>;</span><br><span class="line">  content: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ¨èä¸¤ä¸ªç»ƒä¹ ç½‘ç«™:</p><ul><li><a href="https://typehero.dev/">TypeHero</a></li><li><a href="https://github.com/type-challenges/type-challenges">type-challenges/type-challenges: Collection of TypeScript type challenges with online judge (github.com)</a></li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://typescript.p6p.net">https://typescript.p6p.net</a></li><li><a href="https://www.typescriptlang.org/docs/handbook/intro.html">TypeScript: Handbook - The TypeScript Handbook (typescriptlang.org)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ—©è¯¥å­¦å­¦äº†.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å›å¤´å†çœ‹å‰ç«¯æ¡†æ¶</title>
    <link href="https://www.sekyoro.top/2024/02/03/%E5%9B%9E%E5%A4%B4%E5%86%8D%E7%9C%8B%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    <id>https://www.sekyoro.top/2024/02/03/%E5%9B%9E%E5%A4%B4%E5%86%8D%E7%9C%8B%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/</id>
    <published>2024-02-03T06:34:45.000Z</published>
    <updated>2024-02-11T07:28:06.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>é©¬ä¸Šåˆè¦åˆ°å†œå†æ–°å¹´äº†,è¶ç°åœ¨å›é¡¾ä¸€ä¸‹è¿‡å»ä¸€å¹´çš„å‰ç«¯å‘å±•.å½“ç„¶æ˜¯ç«™åœ¨æˆ‘çš„è§’åº¦,å› ä¸ºæœ‰è®¸å¤šæ–°çš„æŠ€æœ¯,å¯¹äºä¸åŒé¢†åŸŸçš„äººä»¥åŠä¸åŒå±‚é¢çš„å¼€å‘è€…éƒ½æœ‰ä¸åŒçš„æ„å‘³.<br>å¯¹äºæˆ‘æ¥è¯´,å¿«æ·ã€è½»æ¾çš„å¼€å‘ä½“éªŒæ˜¯æ¯”è¾ƒé‡è¦çš„,è‡ƒè‚¿çš„å¤§å‹æ¡†æ¶å¹¶ä¸æ˜¯ä¼˜ç§€çš„ä»£åè¯,æ‰€ä»¥æˆ‘ä¼šå°½é‡ä½¿ç”¨æˆ–è€…å€¾å‘å–œæ¬¢ä¸€äº›ç”Ÿæ€å‘å±•å¥½,å¼€å‘è€…ä½¿ç”¨ä½“éªŒå¥½,ç¤¾åŒºä¹Ÿæ¯”è¾ƒæ´»è·ƒçš„æ¡†æ¶æˆ–è€…æŠ€æœ¯.æ­¤å¤–,éšç€äº‹ä»¶å‘å±•è‚¯å®šä¼šä¸æ–­æ¶Œç°ä¸€äº›æ–°å‹æŠ€æœ¯ç”šè‡³æ–°çš„æ€æƒ³,å¯¹äºå­¦ä¹ è€…æ¥è¯´,è¿™äº›ä¸œè¥¿è¿˜éœ€è¦ä¸€äº›è§‚æœ›.<br><span id="more"></span></p><p>é™¤å¼€ä¸€äº›åŸºæœ¬æ¦‚å¿µ,æˆ‘æ¥å†™ä¸€äº›æˆ‘å¹³å¸¸ä¼šç”¨çš„æ¡†æ¶å’ŒæŠ€æœ¯.å½“ç„¶æˆ‘è¿™é‡Œå¹¶ä¸æ˜¯æƒ³åšä¸€ä¸ªæŠ€æœ¯æ ˆçš„ä»‹ç»,æ›´å¤šçš„æ˜¯åœ¨åšä¸€ä¸ªwebå‰ç«¯é¡¹ç›®æ—¶å¯ä»¥è€ƒè™‘çš„æå‡å¼€å‘æ•ˆç‡çš„å·¥å…·.</p><h2 id="Tailwind-css"><a href="#Tailwind-css" class="headerlink" title="Tailwind css"></a>Tailwind css</h2><p>è™½ç„¶æœ‰äº‰è®®,ä½†è¿™ä¸ªcsså·¥å…·å·²ç»æ˜¯æä¸ºæ–¹ä¾¿çš„å·¥å…·äº†,ç›®å‰æµè§ˆå™¨å·²ç»æ”¯æŒè®¸å¤šcssæ–°çš„ç‰¹æ€§,æ‰€ä»¥æˆ‘è§‰å¾—å¯ä»¥è¯´,ç±»ä¼¼lesså’Œscssçš„å·¥å…·æ˜¯ä¸éœ€è¦çš„äº†.</p><p>Bootstrapæˆ–è®¸è¿‡äºè‡ƒè‚¿,ä½¿ç”¨tailwind cssæœ¬èº«å¹¶æ²¡æœ‰ç»„ä»¶åº“,è¿™é‡Œæˆ‘æ¨èä¸¤ä¸ªç»„ä»¶åº“ï¼Œä¸€ä¸ªæ˜¯<a href="https://daisyui.com/">daisyUI â€” Tailwind CSS Components ( version 4 update is here )</a>å¦ä¸€ä¸ªæ˜¯<a href="https://ui.shadcn.com/docs">Introduction - shadcn/ui</a></p><p>æ­é…ç°ä»£çš„cssç‰¹æ€§,è¿™æ ·å†™cssåŸºæœ¬å°±å¤Ÿäº†.å®åœ¨è§‰å¾—ä¸è¡Œå¯ä»¥å†å¾€Element-Plusä¹Ÿå°±æ˜¯æ›´æŠ½è±¡é«˜çº§çš„ç»„ä»¶åº“ä¸Šé .</p><h2 id="React"><a href="#React" class="headerlink" title="React"></a>React</h2><p>reactçš„ç”Ÿæ€å¾ˆå¥½,çŠ¶æ€ç®¡ç†å·¥å…·ä»¥åŠæ­é…çš„ä¸€äº›åŠ¨æ•ˆåº“éƒ½å¾ˆå¤š.æ­¤å¤–æ­é…Next.js,Remix.jsç­‰ç­‰æˆä¸ºä¸€ä¸ªè¾ƒä¸ºå®Œæ•´çš„webå‰ç«¯è§£å†³æ–¹æ¡ˆ.Reactæ˜¯ä¸€ä¸ªlibrary,å…³é”®æ˜¯ä½¿ç”¨äº†JSX,å¾ˆå¤šå…¶ä»–åº“ä¹Ÿæ˜¯å—æ­¤å½±å“,æ¯”å¦‚Solid,Preact,Millionsç­‰ç­‰.</p><h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><p>Vueåœ¨å›½å†…ç”¨çš„å¾ˆå¤š,å½“ç„¶å›½å¤–ä¹Ÿä¸å°‘.ç›¸å¯¹æ¥è¯´æˆ‘è®¤ä¸ºè¾ƒå¤§çš„å·®åˆ«æ˜¯Vueçš„å®˜æ–¹æœ¬èº«å·²ç»æä¾›äº†æ•´å¥—çš„è§£å†³æ–¹æ¡ˆ,Vueä¹Ÿæœ‰Nuxtè§£å†³SSRçš„é—®é¢˜,å®ƒæœ‰Piniaè§£å†³çŠ¶æ€ç®¡ç†çš„é—®é¢˜,ä¸åƒReactçŠ¶æ€ç®¡ç†é€šå¸¸ä¼šé€‰ç”¨ç¬¬ä¸‰æ–¹çš„Zuslandæˆ–è€…jotaiç­‰ç­‰(å½“ç„¶,å¦‚æœéœ€è¦ç®¡ç†çš„ä¸å¤šç›´æ¥ä½¿ç”¨contextä¹Ÿå¯ä»¥).ç›®å‰vue2å·²ç»ä¸åœ¨ç»´æŠ¤äº†,æˆ‘ä¹Ÿå¤§åŠ›æ¨èç›´æ¥ä¸Švue3.Vueä½¿ç”¨å•ç‹¬çš„ä¸€ä¸ª.vueæ–‡ä»¶è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶,svelteæ¡†æ¶ä¹Ÿç±»ä¼¼.</p><p>å¯ä»¥è¿™ä¹ˆè¯´,å¦‚æœè¦åšä¸€ä¸ªä¸­å¤§å‹çš„å‰ç«¯é¡¹ç›®,ä½¿ç”¨vueæˆ–è€…reactçš„ä»¥åŠå®ƒä»¬å„è‡ªçš„ç”Ÿæ€å·¥å…·æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜,ä¹Ÿæ²¡æœ‰å¤ªå¤§å·®å¼‚çš„.è€Œä¸”vueå¯¹äºå›½å†…å¼€å‘è€…è¿˜æ˜¯æ¯”è¾ƒå‹å¥½çš„,å„ç±»æ–‡æ¡£çš„ä¸­æ–‡æ”¯æŒè¿˜æ˜¯è¦æ¯”reactå¥½.</p><p>Reactå’ŒVueéƒ½æœ‰SSRçš„æ¡†æ¶,åˆ†åˆ«æ˜¯Nextå’ŒNuxt,å½“ç„¶Reactè¿˜æœ‰Gatsby,Expoè¿™äº›</p><h2 id="Svelte-or-Solid"><a href="#Svelte-or-Solid" class="headerlink" title="Svelte or Solid"></a>Svelte or Solid</h2><p>åœ¨virtual domä¸Šä¸å†èµ˜è¿°.è€Œsvelteå’Œsolidéƒ½æ˜¯ä½¿ç”¨çš„çœŸå®çš„dom.</p><p>æœ‰çš„æ—¶å€™ä½ å¹¶ä¸éœ€è¦ä¹Ÿå¹¶ä¸æƒ³è¦å†™ä¸€ä¸ªè¾ƒå¤§çš„åº”ç”¨,å¹¶ä¸æƒ³å¼•å…¥è¿‡å¤šä¾èµ–,ä½†æ˜¯åˆæƒ³ä½¿ç”¨ä¸€äº›æ–¹ä¾¿çš„åº“.</p><p>è¿™æ—¶å€™react,vueå°±å¯ä»¥ç¨å¾®é€€é€€,ä½¿ç”¨ä¸€äº›æ—¢æ–°é¢–åˆæˆç†Ÿçš„æ–¹æ¡ˆ,æ¯”å¦‚Svelte,Solid,Preactæˆ–è€…Millionç­‰ç­‰.å‰ç«¯æ¡†æ¶çš„å‘å±•ç‰¹åˆ«å¿«,åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æŒæ¡ä¸€äº›åŸºæœ¬æ¦‚å¿µä¼šæ›´å¥½.</p><p>åœ¨æµè§ˆè¿™äº›æ¡†æ¶æ—¶,æˆ‘ä¹Ÿä½“ä¼šåˆ°ä¸€ä¸ªæ·±åˆ»çš„äº‹æƒ…,ä½œä¸ºæ™®é€šå¼€å‘è€…åœ¨é€‰æ‹©è¿™äº›æ¡†æ¶æ—¶,å³ä½¿æ–‡æ¡£å®£ä¼ æœ‰å¤šä¹ˆå¥½å¤šä¹ˆå¿«,å¦‚æœèƒŒåçš„ç¤¾åŒºä¸åšæŒåšä¸‹å»ä¸åšæŒå®£ä¼ ,èƒŒåçš„ç”Ÿæ€,èƒŒåæ²¡æœ‰ä¸€ä¸ªè¾ƒä¸ºç»Ÿä¸€çš„è§£å†³æ–¹æ¡ˆ,è¿˜æ˜¯æ— æ³•åšçš„é•¿ä¹….</p><p>æˆ‘è¯´è¿™äº›è¯çš„æ„æ€æ˜¯,åœ¨è¿™ä¹ˆå¤šå‰ç«¯æ¡†æ¶å‡ºç°çš„ä»Šå¤©,å¦‚æœæƒ³è¦æœ‰ä¸€ä¸ªé¡ºç•…çš„å¼€å‘ä½“éªŒ,é™¤äº†æ¡†æ¶æœ¬èº«å®£ä¼ çš„æŠ€æœ¯,è¿˜æœ‰èƒŒåçš„ç”Ÿæ€å·¥å…·é“¾ä¹Ÿå¾ˆé‡è¦,æ¯•ç«Ÿ,å½“é¡¹ç›®ä½“ç§¯å˜å¤§,äº‹æƒ…å°±æ›´å¤æ‚äº†.</p><p>Svelteå®˜æ–¹æä¾›äº†ä¸€ä¸ªSvelteKitå·¥å…·,ä¹Ÿæ”¯æŒSSRç­‰åŠŸèƒ½.</p><p>Solidä¹Ÿæ˜¯ç±»ä¼¼.å¯ä»¥ç®€å•ç²—æš´åœ°è¯´åœ¨è¯­æ³•ä¸ŠSvelteæ›´åƒVue,Solidæ›´åƒReact.è€Œä¸”åä¸¤è€…éƒ½æä¾›äº†SSRçš„èƒ½åŠ›.</p><h2 id="å¯¹æ¯”ä¸€ä¸‹Next-Nuxtä»¥åŠSvelteKitå’Œsolid-js"><a href="#å¯¹æ¯”ä¸€ä¸‹Next-Nuxtä»¥åŠSvelteKitå’Œsolid-js" class="headerlink" title="å¯¹æ¯”ä¸€ä¸‹Next,Nuxtä»¥åŠSvelteKitå’Œsolid.js"></a>å¯¹æ¯”ä¸€ä¸‹Next,Nuxtä»¥åŠSvelteKitå’Œsolid.js</h2><p>å¹³å¸¸æˆ‘ä»¬å†™å‰ç«¯ä»£ç å…³æ³¨å“ªäº›ç‚¹?</p><p>Nextå®˜ç½‘ç»™äº†ä»¥ä¸‹å‡ ç‚¹</p><p><img data-src="https://s2.loli.net/2024/02/03/gZW9YjzshmFBXnx.png" alt="image-20240203185447263" style="zoom:67%;" /></p><h3 id="æ„å»ºå·¥å…·"><a href="#æ„å»ºå·¥å…·" class="headerlink" title="æ„å»ºå·¥å…·"></a>æ„å»ºå·¥å…·</h3><p>å¯¹äºNext,å¯ä»¥ä½¿ç”¨<code>create-next-app</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app@latest</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨Nextæˆ–è€…Nuxtä¸€èˆ¬ä¸»è¦ç›®çš„æ˜¯ä½¿ç”¨SSRåŠŸèƒ½.å½“ç„¶é™¤äº†SSRä¹‹å¤–è¿™äº›æ¡†æ¶æœ¬èº«ä¹Ÿæä¾›äº†å¾ˆå¤šåŠŸèƒ½,ä¸€äº›å¼€ç®±å³ç”¨çš„åº“,ä¸€äº›é»˜è®¤çš„ç›®å½•ç»“æ„.ä¸è¿‡ä¸æ˜¯ä¸ºäº†å¼ºè°ƒSSR,SEO,è²Œä¼¼ä¹Ÿæ²¡æœ‰å¿…è¦ä½¿ç”¨Next(äº‹å®ä¸Šä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™äº›æ¡†æ¶ä½†ä¸è¿‡å¤šä½¿ç”¨å®ƒä»¬çš„ä¸€äº›feature,å¥½å¤„æ˜¯ä¸ç”¨è´¹æ—¶è´¹åŠ›å®‰è£…ä¸€äº›å¸¸ç”¨åº“)</p><p>å¦‚æœä¸ä½¿ç”¨Nextè€Œæ˜¯ç”¨React,å¯ä»¥è€ƒè™‘ä½¿ç”¨Viteç­‰æ„å»ºå·¥å…·.</p><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><p>ä½¿ç”¨ä¸åŒçš„æ„å»ºå·¥å…·æˆ–è€…æ¡†æ¶ä¼šé»˜è®¤ä¸€äº›ç›®å½•ç»“æ„.</p><p>Nextä½¿ç”¨åŸºäºæ–‡ä»¶ç»“æ„çš„è·¯ç”±,æ‰€å½•åœ¨ç›®å½•ç»“æ„ä¸Šéœ€è¦æ³¨æ„çš„.åœ¨Nextçš„å¤§æ›´æ–°ä¹Ÿå°±æ˜¯v13ä¹‹å,è·¯ç”±é»˜è®¤ä½¿ç”¨App Router. App Routeré»˜è®¤ä½¿ç”¨appç›®å½•è¿›è¡Œè·¯ç”±,è€ŒPage Router ä½¿ç”¨Pageç›®å½•.</p><p>æ¨èåªæ˜¯ç”¨app routerå°±å¤Ÿäº†.</p><p>åœ¨<code>app/layout.tsx</code>ä¸­åˆ›å»ºhtml,åœ¨<code>app/page.tsx</code>ä¸­åˆ›å»ºç»„ä»¶,ç„¶ååˆ›å»ºpublicæ–‡ä»¶å¤¹æ”¾å›¾åƒå’Œå­—ä½“ç­‰é™æ€æ–‡ä»¶.</p><p>å…·ä½“Nexté¡¹ç›®ç»“æ„å‚çœ‹<a href="https://nextjs.org/docs/getting-started/project-structure">Getting Started: Project Structure | Next.js (nextjs.org)</a>,å¯ä»¥çœ‹åˆ°è¿˜æ˜¯æœ‰å¾ˆå¤šé»˜è®¤è§„åˆ™çš„.</p><h3 id="å¦‚ä½•å†™ä¸€ä¸ªç»„ä»¶"><a href="#å¦‚ä½•å†™ä¸€ä¸ªç»„ä»¶" class="headerlink" title="å¦‚ä½•å†™ä¸€ä¸ªç»„ä»¶"></a>å¦‚ä½•å†™ä¸€ä¸ªç»„ä»¶</h3><p>ç”±äºæœ‰äº†SSRåŠŸèƒ½,ç»„ä»¶åˆ†ä¸ºäº†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶</p><h4 id="æœåŠ¡ç«¯ç»„ä»¶"><a href="#æœåŠ¡ç«¯ç»„ä»¶" class="headerlink" title="æœåŠ¡ç«¯ç»„ä»¶"></a>æœåŠ¡ç«¯ç»„ä»¶</h4><p>æœåŠ¡å™¨ç»„ä»¶ç›¸æ¯”äºåŸæœ¬çš„CSRåº”ç”¨æœ‰å¾ˆå¤šå¥½å¤„.æ¯”å¦‚æ•°æ®è·å–æ›´å¿«,æ›´å®‰å…¨,æœ‰ç¼“å­˜,å®¢æˆ·ç«¯éœ€è¦çš„Bundleæ›´å°,æ›´å¥½çš„SEO.</p><p>æ¸²æŸ“è¿‡ç¨‹:åœ¨æœåŠ¡å™¨ä¸Šï¼ŒNext.jsä½¿ç”¨Reactçš„APIæ¥ç¼–æ’æ¸²æŸ“ã€‚æ¸²æŸ“å·¥ä½œåˆ†ä¸ºå¤šä¸ªå—ï¼šæŒ‰å„ä¸ªroute segmentså’Œsuspense boundariesã€‚</p><p>æ¯ä¸ªå—(chunks)åˆ†ä¸¤ä¸ªæ­¥éª¤å‘ˆç°ï¼šReactå°†æœåŠ¡å™¨ç»„ä»¶å‘ˆç°ä¸ºä¸€ç§ç‰¹æ®Šçš„æ•°æ®æ ¼å¼ï¼Œç§°ä¸ºReactæœåŠ¡å™¨ç»„ä»¶æœ‰æ•ˆè½½è·ï¼ˆRSC Payloadï¼‰ã€‚Next.jsä½¿ç”¨RSC Payloadå’ŒClient Component JavaScriptæŒ‡ä»¤åœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°HTMLã€‚</p><p>ç„¶åï¼Œåœ¨å®¢æˆ·ç«¯ä¸Šï¼šHTMLç”¨äºç«‹å³æ˜¾ç¤ºå¯¹åº”è·¯ç”±çš„å¿«é€Ÿéäº¤äº’å¼é¢„è§ˆ-è¿™ä»…ç”¨äºåˆå§‹é¡µé¢åŠ è½½ã€‚ReactæœåŠ¡å™¨ç»„ä»¶æœ‰æ•ˆè´Ÿè½½ç”¨äºåè°ƒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç»„ä»¶æ ‘ï¼Œå¹¶æ›´æ–°DOMã€‚JavaScriptæŒ‡ä»¤ç”¨äºæ°´åˆå®¢æˆ·ç«¯ç»„ä»¶å¹¶ä½¿åº”ç”¨ç¨‹åºå…·æœ‰äº¤äº’æ€§ã€‚</p><p><strong>æ¸²æŸ“ç­–ç•¥</strong></p><p>æœ‰é™æ€æ¸²æŸ“,åŠ¨æ€æ¸²æŸ“</p><p>é»˜è®¤æ˜¯é™æ€æ¸²æŸ“,ä½¿ç”¨é™æ€æ¸²æŸ“ï¼Œè·¯ç”±åœ¨æ„å»ºæ—¶æ¸²æŸ“ï¼Œæˆ–åœ¨æ•°æ®é‡æ–°éªŒè¯ååœ¨åå°æ¸²æŸ“ã€‚ç»“æœè¢«ç¼“å­˜ï¼Œå¹¶ä¸”å¯ä»¥è¢«æ¨é€åˆ°å†…å®¹äº¤ä»˜ç½‘ç»œï¼ˆCDNï¼‰ã€‚æ­¤ä¼˜åŒ–å…è®¸æ‚¨åœ¨ç”¨æˆ·å’ŒæœåŠ¡å™¨è¯·æ±‚ä¹‹é—´å…±äº«æ¸²æŸ“å·¥ä½œçš„ç»“æœã€‚å½“è·¯ç”±åŒ…å«çš„æ•°æ®ä¸æ˜¯é’ˆå¯¹ç”¨æˆ·ä¸ªæ€§åŒ–çš„ï¼Œå¹¶ä¸”å¯èƒ½åœ¨æ„å»ºæ—¶å·²çŸ¥æ—¶ï¼ˆä¾‹å¦‚é™æ€åšå®¢æ–‡ç« æˆ–äº§å“é¡µé¢ï¼‰ï¼Œé™æ€æ¸²æŸ“éå¸¸æœ‰ç”¨ã€‚</p><p>ä½¿ç”¨åŠ¨æ€æ¸²æŸ“ï¼Œ<strong>å¯ä»¥åœ¨è¯·æ±‚æ—¶ä¸ºæ¯ä¸ªç”¨æˆ·æ¸²æŸ“è·¯ç”±</strong>ã€‚å½“è·¯ç”±å…·æœ‰é’ˆå¯¹ç”¨æˆ·ä¸ªæ€§åŒ–çš„æ•°æ®æˆ–å…·æœ‰åªèƒ½åœ¨è¯·æ±‚æ—¶æ‰çŸ¥é“çš„ä¿¡æ¯ï¼ˆå¦‚cookieæˆ–URLçš„æœç´¢å‚æ•°ï¼‰æ—¶ï¼ŒåŠ¨æ€å‘ˆç°éå¸¸æœ‰ç”¨ã€‚</p><blockquote><p>ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæ‚¨ä¸éœ€è¦åœ¨é™æ€å’ŒåŠ¨æ€æ¸²æŸ“ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œå› ä¸ºNext.jsä¼šæ ¹æ®æ‰€ä½¿ç”¨çš„åŠŸèƒ½å’ŒAPIè‡ªåŠ¨ä¸ºæ¯æ¡è·¯ç”±é€‰æ‹©æœ€ä½³æ¸²æŸ“ç­–ç•¥ã€‚ç›¸åï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä½•æ—¶ç¼“å­˜æˆ–é‡æ–°éªŒè¯ç‰¹å®šæ•°æ®ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æµå¼å¤„ç†UIçš„éƒ¨åˆ†å†…å®¹ã€‚</p></blockquote><p>æ­¤å¤–è¿˜æœ‰streaming,æµå¼å¤„ç†ä½¿æ‚¨èƒ½å¤Ÿä»æœåŠ¡å™¨é€æ­¥æ¸²æŸ“UIã€‚å·¥ä½œè¢«åˆ†å‰²æˆå—ï¼Œå¹¶åœ¨å‡†å¤‡å°±ç»ªæ—¶æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚è¿™å…è®¸ç”¨æˆ·åœ¨æ•´ä¸ªå†…å®¹å®Œæˆå‘ˆç°ä¹‹å‰ç«‹å³æŸ¥çœ‹é¡µé¢çš„éƒ¨åˆ†å†…å®¹ã€‚</p><h4 id="å®¢æˆ·ç«¯ç»„ä»¶"><a href="#å®¢æˆ·ç«¯ç»„ä»¶" class="headerlink" title="å®¢æˆ·ç«¯ç»„ä»¶"></a>å®¢æˆ·ç«¯ç»„ä»¶</h4><p>å®¢æˆ·ç«¯ç»„ä»¶<strong>å¯ä»¥ä½¿ç”¨state,effectsä»¥åŠäº‹ä»¶ç›‘å¬.æ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨æµè§ˆå™¨çš„API</strong>.</p><p>â€œuse clientâ€ç”¨äºå£°æ˜æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶æ¨¡å—ä¹‹é—´çš„è¾¹ç•Œã€‚è¿™æ„å‘³ç€ï¼Œé€šè¿‡åœ¨æ–‡ä»¶ä¸­å®šä¹‰â€œuse clinetâ€ï¼Œå¯¼å…¥å…¶ä¸­çš„æ‰€æœ‰å…¶ä»–æ¨¡å—ï¼ŒåŒ…æ‹¬å­ç»„ä»¶ï¼Œéƒ½è¢«è§†ä¸ºå®¢æˆ·ç«¯æ†ç»‘åŒ…çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ä¸€æ—¦å®šä¹‰äº†è¾¹ç•Œï¼Œå¯¼å…¥å…¶ä¸­çš„æ‰€æœ‰å­ç»„ä»¶å’Œæ¨¡å—éƒ½å°†è¢«è§†ä¸ºå®¢æˆ·ç«¯æ†ç»‘åŒ…çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="styling"><a href="#styling" class="headerlink" title="styling"></a>styling</h3><p>ä¸€èˆ¬æ¥è¯´å¯ä»¥ä½¿ç”¨tailwind css,åƒè¿™ç§ä¸»è¦å…³æ³¨çš„æ˜¯ç»„ä»¶åŒ–,ä¹Ÿå°±æ˜¯ä¸åŒçš„ç»„ä»¶ä¹‹é—´çš„cssä¸è¦äº’ç›¸æ±¡æŸ“.å…¨å±€çš„csså¯ä»¥æ–¹ä¾¿æ’å…¥.é™¤äº†tailwind csså¤–è¿˜æœ‰css in js,css modulesç­‰æ–¹æ³•,æˆ‘å»ºè®®ä½¿ç”¨å…¶ä¸­ä¸¤ç§æ­é…å°±è¡Œäº†,ä¸ç„¶ä¼šè®©äººconfused(æ¨ècss moduleså’Œtailwind cssæ­é…).</p><h3 id="è·¯ç”±"><a href="#è·¯ç”±" class="headerlink" title="è·¯ç”±"></a>è·¯ç”±</h3><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fterminology-url-anatomy.png&amp;w=3840&amp;q=75&amp;dpl=dpl_8JSreCCcxctwsnJ6FNFujsNZdfsZ" alt="Terminology for URL Anatomy"></p><p>Nextçš„app routeræ”¯æŒå…±äº«å¸ƒå±€,åµŒå¥—è·¯ç”±,åŠ è½½çŠ¶æ€,é”™è¯¯å¤„ç†ç­‰ç­‰.æ–‡ä»¶ç”¨äºå®šä¹‰è·¯ç”±.</p><p>æ¯ä¸ªç›®å½•è¡¨ç¤ºä¸€ä¸ªè·¯ç”±æ®µ,ä½¿ç”¨<code>page.tsx</code>è¡¨ç¤ºå¯¹äºé‚£ä¸ªè¯¥è·¯ç”±çš„ç»„ä»¶.</p><p>pageé»˜è®¤æ˜¯æœåŠ¡ç«¯ç»„ä»¶,å¯ä»¥æ”¹ä¸ºå®¢æˆ·ç«¯ç»„ä»¶</p><p>layoutsåœ¨ä¸åŒpagesä¸­æ˜¯å…±äº«çš„,è·³è½¬æ—¶layoutsä¿ç•™state,ä¸å†é‡æ–°æ¸²æŸ“.è¿™ä¸ªç»„ä»¶åº”è¯¥æ¥å—ä¸€ä¸ª<code>children</code>å±æ€§ä½œä¸ºä¸€ä¸ªchild layoutæˆ–è€…ä¸€ä¸ªchild page.</p><p>é¡¶å±‚æœ‰ä¸€ä¸ªRoot Layout,è¿™æ˜¯å¿…é¡»çš„.åœ¨æ‰€æœ‰pagesä¸­å…±äº«.åŒ…å«htmlå’Œbody.</p><p>æ¯ä¸ªè·¯ç”±æ®µå¯ä»¥é€‰æ‹©æ€§å®šä¹‰è‡ªå·±çš„layout,è·¯ç”±ä¸­çš„layouté»˜è®¤è¢«åŒ…å«,æ¯ä¸ªçˆ¶layoutæŠŠå­layouté€šè¿‡childrenåŒ…å«åœ¨ä¸€èµ·.layoutå’Œpageå¯ä»¥åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹,layoputä¼šåŒ…å«è¿™ä¸ªpage.</p><p>æ­¤å¤–Nextè¿˜æœ‰template,è·Ÿlayoutsç±»ä¼¼,ä½†æ˜¯å®ƒå¹¶ä¸ä¼šä¿æŒroutesä¹‹é—´çš„state,è¿™æ„æ€æ˜¯å½“ä¸€ä¸ªç”¨æˆ·åœ¨å…±äº«ä¸€ä¸ªtemplateçš„ä¸åŒè·¯ç”±ä¹‹é—´è·³è½¬æ—¶,ä¸ä¼šä¿æŒçŠ¶æ€.ä¼šé‡æ–°æ¸²æŸ“å…ƒç´ .</p><p>åœ¨å®šä¹‰metadataä¿¡æ¯æ—¶å¯ä»¥åœ¨pageæˆ–è€…layoutä¸­å¯¼å‡ºmetadataå¯¹è±¡.</p><h3 id="é“¾æ¥ä¸é¡µé¢å¯¼èˆª"><a href="#é“¾æ¥ä¸é¡µé¢å¯¼èˆª" class="headerlink" title="é“¾æ¥ä¸é¡µé¢å¯¼èˆª"></a>é“¾æ¥ä¸é¡µé¢å¯¼èˆª</h3><p>Nextæœ‰å››ç§è·³è½¬è·¯ç”±çš„æ–¹å¼</p><ol><li>ä½¿ç”¨Linkç»„ä»¶</li><li>ä½¿ç”¨useRouter hook(å®¢æˆ·ç«¯ç»„ä»¶)</li><li>ä½¿ç”¨redirectå‡½æ•°(æœåŠ¡ç«¯ç»„ä»¶)</li><li>æµè§ˆå™¨çš„History API</li></ol><h4 id="Linkç»„ä»¶"><a href="#Linkç»„ä»¶" class="headerlink" title="Linkç»„ä»¶"></a>Linkç»„ä»¶</h4><p>ç»§æ‰¿äº†\<a\>æ ‡ç­¾å¹¶ä¸”ä½¿å¾—åœ¨å®¢æˆ·ç«¯è·³è½¬æä¾›äº†prefetchingåŠŸèƒ½,ä¼˜é€‰æ–¹å¼</p><p>è·³è½¬è·¯ç”±æ—¶é»˜è®¤è¡Œä¸ºä¼šåˆ°é¡¶ç«¯,å¯ä»¥ä½¿ç”¨å±æ€§<code>scroll=&#123;false&#125;</code></p><h4 id="useRouter"><a href="#useRouter" class="headerlink" title="useRouter"></a>useRouter</h4><p>ä½¿ç”¨useRouter hook</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;use client&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/navigation&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Page</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> router = useRouter()</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> router.push(&#x27;/dashboard&#x27;)&#125;&gt;</span></span><br><span class="line"><span class="xml">      Dashboard</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæœåŠ¡ç«¯ç»„ä»¶,å¯ä»¥ä½¿ç”¨redirect.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; redirect &#125; <span class="keyword">from</span> <span class="string">&#x27;next/navigation&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchTeam</span>(<span class="params">id: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://...&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (!res.ok) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> res.json()</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">Profile</span>(<span class="params">&#123; params &#125;: &#123; params: &#123; id: string &#125; &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> team = <span class="keyword">await</span> fetchTeam(params.id)</span><br><span class="line">  <span class="keyword">if</span> (!team) &#123;</span><br><span class="line">    redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Next.jsè·¯ç”±é»˜è®¤ç¼“å­˜ç­‰æœºåˆ¶.</p><p>ä½¿ç”¨<code>loading.js</code>åŠ è½½ä¸€äº›å†…å®¹,åŸæœ¬æ˜¯Reactä¸­çš„suspense.</p><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Floading-ui.png&amp;w=3840&amp;q=75&amp;dpl=dpl_7E1cZLB9sZWvkjQY6Ei4tJ18mYN7" alt="Loading UI"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default function Loading() &#123;</span><br><span class="line">  // You can add any UI inside Loading, including a Skeleton.</span><br><span class="line">  return &lt;LoadingSkeleton /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨loading.jsä¸suspenseå¯ä»¥è·å¾—<strong>Streaming Server Rendering</strong> å’Œ<strong>Selective Hydration</strong>çš„æ•ˆæœ.</p><h4 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h4><p>ä½¿ç”¨error.jsè¿›è¡Œé”™è¯¯å¤„ç†.å¦‚æœè¦å¤„ç†æ ¹ç›®å½•ä¸‹çš„é”™è¯¯,éœ€è¦ä½¿ç”¨<code>global-error.tsx</code>æ–‡ä»¶,å®ƒå¯ä»¥å¤„ç†åŒ…æ‹¬æ ¹ä¸‹layout.tsxå’Œtemplate.tsxä¸­ä¸¢å‡ºçš„é”™è¯¯,æ­¤å¤–ä¹Ÿæ¨èå†å®šä¹‰error.tsxå¤„ç†æ ¹ä¸‹page.tsxä¸­çš„é”™è¯¯.</p><p>error.tsxæ–‡ä»¶ä¼šè¢«åµŒå…¥åˆ°layoutä¹‹ä¸­,æ‰€ä»¥ä¸ä¼šå¤„ç†layout.tsxä¸­ä¸¢å‡ºçš„é”™è¯¯.</p><h4 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h4><p><img data-src="https://s2.loli.net/2024/02/06/Zav7h3fXBkOIR8g.png" alt="image-20240206130511356"></p><p>é‡å®šå‘è·Ÿè·¯ç”±ç±»ä¼¼,ä¹Ÿåˆ†åœ¨æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ä½¿ç”¨.</p><h4 id="redirect"><a href="#redirect" class="headerlink" title="redirect"></a>redirect</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x27;use server&#x27;</span><br><span class="line"> </span><br><span class="line">import &#123; redirect &#125; from &#x27;next/navigation&#x27;</span><br><span class="line">import &#123; revalidatePath &#125; from &#x27;next/cache&#x27;</span><br><span class="line"> </span><br><span class="line">export async function createPost(id: string) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // Call database</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    // Handle errors</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  revalidatePath(&#x27;/posts&#x27;) // Update cached posts</span><br><span class="line">  redirect(`/post/$&#123;id&#125;`) // Navigate to the new post page</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åœ¨<code>next.config.js</code>ä¸­è®¾ç½®redirectsä½¿å¾—åœ¨è¯·æ±‚çš„é¡µé¢æ¸²æŸ“ä¹‹å‰è¿›è¡Œè·³è½¬.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">redirects</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="comment">// Basic redirect</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">source</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">        <span class="attr">destination</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">permanent</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Wildcard path matching</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">source</span>: <span class="string">&#x27;/blog/:slug&#x27;</span>,</span><br><span class="line">        <span class="attr">destination</span>: <span class="string">&#x27;/news/:slug&#x27;</span>,</span><br><span class="line">        <span class="attr">permanent</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰åœ¨Middlewareä¸­çš„è·³è½¬,æ–¹ä¾¿åœ¨è¿›è¡ŒéªŒè¯ä¹‹åè¿›è¡Œé€‰æ‹©æ€§è·³è½¬.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NextResponse, NextRequest &#125; <span class="keyword">from</span> <span class="string">&#x27;next/server&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; authenticate &#125; <span class="keyword">from</span> <span class="string">&#x27;auth-provider&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware</span>(<span class="params">request: NextRequest</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isAuthenticated = authenticate(request)</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// If the user is authenticated, continue as normal</span></span><br><span class="line">  <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">    <span class="keyword">return</span> NextResponse.next()</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Redirect to login page if not authenticated</span></span><br><span class="line">  <span class="keyword">return</span> NextResponse.redirect(<span class="keyword">new</span> URL(<span class="string">&#x27;/login&#x27;</span>, request.url))</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="attr">matcher</span>: <span class="string">&#x27;/dashboard/:path*&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è·¯ç”±ç»„"><a href="#è·¯ç”±ç»„" class="headerlink" title="è·¯ç”±ç»„"></a>è·¯ç”±ç»„</h4><p>è·¯ç”±ç»„å¯ä»¥å°†è·¯ç”±åˆ†æˆä¸€ç»„,åŒæ—¶ä½¿å¾—åœ¨ä¸€ä¸ªè·¯ç”±æ®µå»ºç«‹å¤šä¸ªåµŒå¥—çš„layout.</p><p>ä½¿ç”¨<code>()</code>åŒ…å«ä¸€ä¸ªç›®å½•å,è¿™ä¸ªç›®å½•ä¸ä¼šè¢«å½“ä½œä¸€ä¸ªè·¯ç”±.åœ¨è¿™ä¸ªè·¯ç”±ç»„ä¸­çš„è·¯ç”±å¯ä»¥å…±äº«ä¸€ä¸ªlayout.è¿™ä¸ªç›®å½•ä¸ä¼šè¢«å¤„ç†æˆè·¯ç”±æ®µ,æ­¤å¤–å¯ä»¥åˆ©ç”¨è¿™ä¸ªåˆ›å»ºå¤šä¸ªroot layout.</p><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Froute-group-multiple-root-layouts.png&amp;w=3840&amp;q=75&amp;dpl=dpl_Fr1VCq6W9RFeEuXYFe2L4sUmaW7a" alt="Route Groups with Multiple Root Layouts"></p><h4 id="é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶å®‰æ’"><a href="#é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶å®‰æ’" class="headerlink" title="é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶å®‰æ’"></a>é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶å®‰æ’</h4><p>åœ¨ç›®å½•å‰åŠ <code>_</code>ä½¿å¾—å…¶ä¸å¯è®¿é—®.</p><blockquote><p>ï¼š_folderNameè¿™è¡¨ç¤ºæ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªä¸“ç”¨çš„å®ç°ç»†èŠ‚ï¼Œè·¯ç”±ç³»ç»Ÿä¸åº”è€ƒè™‘å®ƒï¼Œä»è€Œé€‰æ‹©ä¸è·¯ç”±æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å­æ–‡ä»¶å¤¹ã€‚</p></blockquote><p>è¿™æ ·åšå¯ä»¥ä½¿å¾—UIä¸è·¯ç”±åˆ†å¼€.</p><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fproject-organization-private-folders.png&w=3840&q=75&dpl=dpl_FhZP1LTtukMJX1yNmAQ5DmdgAZ2Q" alt="An example folder structure using private folders" style="zoom:67%;" /></p><p>æ­¤å¤–å¯ä»¥é…ç½®module aliasesæ–¹ä¾¿å¯¼å…¥.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;baseUrl&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;paths&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@/components/*&quot;</span>: [<span class="string">&quot;components/*&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é¡¹ç›®ç»„ç»‡ç­–ç•¥</strong></p><p>å¯ä»¥å°†ç»„ä»¶å’Œlibåº“æ”¾åœ¨æ ¹ç›®å½•,è·Ÿappç›®å½•åŒå±‚.</p><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fproject-organization-project-root.png&w=3840&q=75&dpl=dpl_FhZP1LTtukMJX1yNmAQ5DmdgAZ2Q" alt="An example folder structure with project files outside of app" style="zoom:50%;" /></p><p>è¿˜å¯ä»¥å°†è¿™äº›ç›®å½•æ”¾åœ¨appç›®å½•ä¸‹,æ­¤å¤–è¿˜å¯ä»¥æ”¾åœ¨è·¯ç”±ç›®å½•ä¸‹.</p><p><img data-src="https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fproject-organization-app-root-split.png&amp;w=3840&amp;q=75&amp;dpl=dpl_FhZP1LTtukMJX1yNmAQ5DmdgAZ2Q" alt="An example folder structure with project files split by feature or route"></p><h4 id="åŠ¨æ€è·¯ç”±"><a href="#åŠ¨æ€è·¯ç”±" class="headerlink" title="åŠ¨æ€è·¯ç”±"></a>åŠ¨æ€è·¯ç”±</h4><p>ç»™ç›®å½•å‘½åçš„æ—¶å€™ä½¿ç”¨<code>[]</code>,è¿™æ ·åœ¨layout,page,routeæˆ–è€…generateMetadataå‡½æ•°ä¸­å¯ä»¥è®¿é—®åŠ¨æ€è·¯ç”±çš„å‚æ•°.</p><p>æ­¤å¤–ä½¿ç”¨<code>[...slug]</code>ä¸ä»…å¯ä»¥æ•è·è¯¥è·¯ç”±ä¸‹å…¶ä¸‹çš„å­è·¯ç”±ä¹Ÿèƒ½è¢«æ•è·</p><p>ä½¿ç”¨<code>dynamicParams</code>æ§åˆ¶<code>generateStaticParams</code>å¾—åˆ°çš„ç»“æœä¹‹å¤–çš„èƒ½å¦è®¿é—®.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export const dynamicParams = false</span><br></pre></td></tr></table></figure><p>å­˜åœ¨multiple-dynamic routeä»¥åŠcatch-all segments</p><p><img data-src="https://s2.loli.net/2024/02/06/rcxIzpTYlAGDZPK.png" alt="image-20240206163014573"></p><p>æ­¤å¤–è¿˜æœ‰Optional Catch-all Segments,<code>[[...]]</code>æ—¢å¯ä»¥åŒ¹é…åŸæœ¬è·¯ç”±ä¹Ÿå¯ä»¥åŒ¹é…å­è·¯ç”±</p><h4 id="å¹¶è¡Œè·¯ç”±"><a href="#å¹¶è¡Œè·¯ç”±" class="headerlink" title="å¹¶è¡Œè·¯ç”±"></a>å¹¶è¡Œè·¯ç”±</h4><p>å¹¶è¡Œè·¯ç”±å…è®¸æ‚¨åŒæ—¶æˆ–æœ‰æ¡ä»¶åœ°å‘ˆç°åŒä¸€å¸ƒå±€ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªé¡µé¢ã€‚å®ƒä»¬é€‚ç”¨äºåº”ç”¨ç¨‹åºçš„é«˜åº¦åŠ¨æ€éƒ¨åˆ†ï¼Œå¦‚ç¤¾äº¤ç½‘ç«™ä¸Šçš„ä»ªè¡¨æ¿å’Œæè¦ã€‚</p><p>ä½¿ç”¨<code>@</code>å¼€å¤´çš„ç›®å½•,ç±»ä¼¼slotå¯ä»¥æ’å…¥åˆ°layoutä¸­.</p><h4 id="æ’å…¥è·¯ç”±"><a href="#æ’å…¥è·¯ç”±" class="headerlink" title="æ’å…¥è·¯ç”±"></a>æ’å…¥è·¯ç”±</h4><p>æˆªå–è·¯ç”±å…è®¸æ‚¨åœ¨å½“å‰å¸ƒå±€ä¸­ä»åº”ç”¨ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†åŠ è½½è·¯ç”±ã€‚å½“æ‚¨å¸Œæœ›åœ¨ä¸è®©ç”¨æˆ·åˆ‡æ¢åˆ°ä¸åŒä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹æ˜¾ç¤ºè·¯çº¿çš„å†…å®¹æ—¶ï¼Œè¿™ç§è·¯ç”±èŒƒä¾‹å¯èƒ½å¾ˆæœ‰ç”¨ã€‚</p><h4 id="è·¯ç”±å¤„ç†å™¨"><a href="#è·¯ç”±å¤„ç†å™¨" class="headerlink" title="è·¯ç”±å¤„ç†å™¨"></a>è·¯ç”±å¤„ç†å™¨</h4><p>è¿™ä¹Ÿæ˜¯Nextèƒ½ä½œä¸ºå…¨æ ˆæ¡†æ¶çš„åŸå› ,å½“ç„¶åœ¨è¿™æ–¹é¢ä¸å¦‚Nest.</p><p>è·¯ç”±å¤„ç†å™¨ç±»ä¼¼page.jsè€Œä¸”ä¸èƒ½è·Ÿå…¶é‡åˆ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const dynamic = &#x27;force-dynamic&#x27; // defaults to auto</span><br><span class="line">export async function GET(request: Request) &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨GETæ–¹æ³•å¹¶ç”¨Responseè¿”å›èƒ½è‡ªåŠ¨ç¼“å­˜.å¹¶ä¸”å¯ä»¥ä½¿ç”¨revalidateéªŒè¯ç¼“å­˜æ•°æ®.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export async function GET() &#123;</span><br><span class="line">  const res = await fetch(&#x27;https://data.mongodb-api.com/...&#x27;, &#123;</span><br><span class="line">    next: &#123; revalidate: 60 &#125;, // Revalidate every 60 seconds</span><br><span class="line">  &#125;)</span><br><span class="line">  const data = await res.json()</span><br><span class="line"> </span><br><span class="line">  return Response.json(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>page,layoutå’Œroute handleræœ‰ä¸ª<code>dynamic</code>å±æ€§,æ§åˆ¶é™æ€å’ŒåŠ¨æ€çš„æ¸²æŸ“å’Œç¼“å­˜.</p><p>é»˜è®¤ä¸º<code>auto</code>è¡¨ç¤ºå°½å¯èƒ½åœ°ç¼“å­˜,<code>force-dynamic</code>è¡¨ç¤ºå¼ºåˆ¶åŠ¨æ€æ¸²æŸ“,ä½¿å¾—æ¯æ­¤æ¸²æŸ“åœ¨æ¯æ¬¡è¯·æ±‚çš„æ—¶å€™æ¸²æŸ“.<code>error</code>å¦‚æœæ¯ä¸ªç»„ä»¶ä½¿ç”¨äº†åŠ¨æ€å‡½æ•°æˆ–è€…æ²¡æœ‰ç¼“å­˜çš„æ•°æ®åŸºä¼šæŠ¥é”™.</p><p><code>force-static</code>å¼ºåˆ¶é™æ€æ¸²æŸ“å¹¶ä¸”ç¼“å­˜æ•°æ®,cookieså’Œheadersç­‰è¿”å›ç©ºå€¼.</p><p>åŠ¨æ€å‡½æ•°åŒ…æ‹¬cookieså’Œheaders.</p><p>åŠ¨æ€è·¯ç”±ä¹Ÿå¯ä»¥å¤„ç†è¯·æ±‚çš„å‚æ•°.</p><h4 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h4><blockquote><p>Middlewareå…è®¸åœ¨è¯·æ±‚å®Œæˆä¹‹å‰è¿è¡Œä»£ç ã€‚ç„¶åï¼Œæ ¹æ®ä¼ å…¥çš„è¯·æ±‚ï¼Œæ‚¨å¯ä»¥é€š<strong>è¿‡é‡å†™ã€é‡å®šå‘ã€ä¿®æ”¹è¯·æ±‚æˆ–å“åº”æ ‡å¤´æˆ–ç›´æ¥å“åº”</strong>æ¥ä¿®æ”¹å“åº”ã€‚</p></blockquote><p>åœ¨æ ¹ç›®å½•ä½¿ç”¨<code>middleware.ts</code>è¿›è¡Œå¯¹è¯·æ±‚çš„æ‹¦æˆªç›¸åº”.</p><p><img data-src="https://s2.loli.net/2024/02/07/z9TjK2Om3EcICDY.png" alt="image-20240207234054276"></p><h3 id="Data-Fetching"><a href="#Data-Fetching" class="headerlink" title="Data Fetching"></a>Data Fetching</h3><p>ç”±äºå¼•å…¥äº†SSRç­‰,æ•°æ®è·å–ä¹Ÿæœ‰äº†å˜åŒ–.åˆ†ä¸ºåœ¨serverä¸Šå’Œåœ¨clientä¸Š.</p><h4 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h4><p>åœ¨Next.jsæœåŠ¡ç«¯ä¸­,fetchå¯ä»¥é…ç½®ç¼“å­˜å’Œé‡éªŒè¯.</p><p>åœ¨å®¢æˆ·ç«¯ä¸­å¯ä»¥è°ƒç”¨route handlerè·å–æ•°æ®,ä¹Ÿå¯ä»¥ä½¿ç”¨React Queryç­‰ç¬¬ä¸‰æ–¹åº“.</p><h4 id="Server-Actionså’ŒMutations"><a href="#Server-Actionså’ŒMutations" class="headerlink" title="Server Actionså’ŒMutations"></a>Server Actionså’ŒMutations</h4><p>Server Actionsæ˜¯åœ¨æœåŠ¡ä¸Šçš„å¼‚æ­¥å‡½æ•°,æ—¢å¯ä»¥åœ¨æœåŠ¡å’Œå®¢æˆ·ç«¯çš„ç»„ä»¶æ¥å¤„ç†æäº¤å’Œå’Œæ•°æ®æ”¹å˜.</p><p>å¯¹äºæœåŠ¡ç«¯ç»„ä»¶,å°†â€use serverâ€æ”¾åœ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°çš„æœ€é¡¶éƒ¨.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Server Component</span><br><span class="line">export default function Page() &#123;</span><br><span class="line">  // Server Action</span><br><span class="line">  async function create() &#123;</span><br><span class="line">    &#x27;use server&#x27;</span><br><span class="line"> </span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  return (</span><br><span class="line">    // ...</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå®¢æˆ·ç«¯ç»„ä»¶,å°†â€use serverâ€æ”¾åœ¨å®¢æˆ·ç«¯ç»„ä»¶æœ€é¡¶éƒ¨.</p><h3 id="Nuxt"><a href="#Nuxt" class="headerlink" title="Nuxt"></a>Nuxt</h3><p>Vueçš„SSRæ¡†æ¶,Nuxté»˜è®¤ä½¿ç”¨Viteæ„å»ºå·¥å…·.å®˜æ–¹æ–‡æ¡£å°†å®ƒçš„å’Œæ ¸å¿ƒæ¦‚å¿µåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†</p><p><img data-src="https://s2.loli.net/2024/02/06/iU72dluEKhtOkI9.png" alt="image-20240206000905397"></p><p>æ€»ä½“çœ‹æ¥è·ŸNextå·®åˆ«ä¸å¤§,å…·ä½“çš„å¯ä»¥æŸ¥çœ‹<a href="https://nuxt.com/docs/getting-started/introduction">Introduction Â· Get Started with Nuxt</a>.</p><h3 id="SvelteKit"><a href="#SvelteKit" class="headerlink" title="SvelteKit"></a>SvelteKit</h3><p>SvelteKité»˜è®¤ä½¿ç”¨Viteæ„å»º,æ¨èä½¿ç”¨SvelteKitåˆ›å»ºä¸€ä¸ªsvelteé¡¹ç›®</p><blockquote><p>SvelteKitå°†å¤„ç†è°ƒç”¨Svelteç¼–è¯‘å™¨ï¼Œå°†.Svelteæ–‡ä»¶è½¬æ¢ä¸º.jsæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶åˆ›å»ºDOMå’Œ.cssæ–‡ä»¶ã€‚å®ƒè¿˜æä¾›æ„å»ºwebåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰å…¶ä»–éƒ¨åˆ†ï¼Œå¦‚å¼€å‘æœåŠ¡å™¨ã€è·¯ç”±ã€éƒ¨ç½²ä»¥åŠSSRæ”¯æŒ.</p></blockquote><p><img data-src="https://s2.loli.net/2024/02/03/kOdja1mSY925byP.png" alt="image-20240203190856868"></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯,Svelteæ˜¯çš„æ›´æ–°æ˜¯åŸºäºèµ‹å€¼,ä½¿ç”¨æ•°ç»„çš„pushç­‰æ“ä½œä¸ä¼šè‡ªåŠ¨æ›´æ–°.</p><p>sveltekitç±»ä¼¼Nextä¹Ÿåœ¨è·¯ç”±,fetchæ•°æ®,headers,cookiesç­‰æœ‰å¾ˆå¤šopinionedçš„é…ç½®.</p><h3 id="Solid"><a href="#Solid" class="headerlink" title="Solid"></a>Solid</h3><p>Solidä¹Ÿæ˜¯ä½¿ç”¨Viteæ„å»º,ä½¿ç”¨<code>createSignal</code>æ¥ç®¡ç†çŠ¶æ€å®ç°äº¤äº’æ€§.ç›®å‰githubä¸Šçš„staræ²¡æœ‰svelteå¤š,å› ä¸ºå‘å±•æˆç†Ÿåº¦è¿˜æ²¡æœ‰svelteé«˜,ä½†æ˜¯solidç›®å‰æ›´åƒä¸€ä¸ªæ–¹ä¾¿çš„åŠ¨æ€åº“,æ¯”è¾ƒè½»å·§.</p><p>Solidçš„SSRæ”¯æŒæœ‰ç‚¹ç‰¹åˆ«.</p><blockquote><p>Solidæœ‰ä¸€ä¸ªåŠ¨æ€æœåŠ¡å™¨ç«¯æ¸²æŸ“è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å®ç°çœŸæ­£åŒæ„çš„å¼€å‘ä½“éªŒã€‚é€šè¿‡ä½¿ç”¨æˆ‘ä»¬çš„ResourceåŸè¯­ï¼Œå¯ä»¥è½»æ¾åœ°è¿›è¡Œå¼‚æ­¥æ•°æ®è¯·æ±‚ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’Œæµè§ˆå™¨ä¹‹é—´è‡ªåŠ¨åºåˆ—åŒ–å’ŒåŒæ­¥ã€‚</p></blockquote><p>Solidçš„å“åº”å¼åŸºäºSignal,Memoä»¥åŠEffect.</p><p>ç›®å‰Solidæ­£åœ¨å¼€å‘Solid Start,ç›®çš„ä¹Ÿæ˜¯æä¾›ä¸€ä¸ªè¾ƒä¸ºæ•´ä½“çš„Solidç”Ÿæ€çš„è§£å†³æ–¹æ¡ˆ.</p><p><img data-src="https://s2.loli.net/2024/02/08/CwB6zkX5yPvnf4q.png" alt="image-20240208002623304"></p><p>Solidå’ŒSvelteéƒ½æœ‰å¾ˆå¥½çš„tutorialè€Œä¸”åœ¨æŒæ¡vueæˆ–è€…reactä¹‹åå†å»çœ‹å®ƒä»¬çš„æ–‡æ¡£ä¹Ÿå¹¶ä¸å›°éš¾.</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>å¯¹äºè¿™ä¸€ç±»å‰ç«¯æ¡†æ¶,ä»¥åå¯èƒ½è¿˜ä¼šä¸æ–­æ¶Œç°,ä½†æ˜¯å…¶ä¸­çš„ç”Ÿæ€è¿˜æ˜¯å¾ˆé‡è¦çš„,å¦‚æœæƒ³è¦å¿«é€Ÿæ²¡æœ‰å¤ªå¤šå¿ƒæ™ºè´Ÿæ‹…çš„å¼€å‘ä¸€ä¸ªè¾ƒä¸ºæˆç†Ÿç”Ÿäº§åº”ç”¨,è¿˜æ˜¯æ¨èä½¿ç”¨Reactæˆ–è€…Vueç­‰è¾ƒä¸ºæˆç†Ÿçš„æ¡†æ¶æˆ–è€…åº“.æ­¤å¤–è¿™äº›æ¡†æ¶å…¶ä¸­çš„è¦è§£å†³çš„é—®é¢˜æ˜¯ä¸€è‡´çš„,è§£å†³æ–¹æ³•ä¹Ÿæ˜¯è¶‹åŒçš„.</p><p>å“åº”æ€§,ç»„ä»¶åˆ›å»º,ç”Ÿå‘½å‘¨æœŸç­‰ç­‰,æ­¤å¤–é™„å¸¦è·¯ç”±,çŠ¶æ€ç®¡ç†,æ•°æ®è·å–æ“ä½œç­‰ç­‰éƒ½æœ‰è§£å†³æ–¹æ³•.</p><h2 id="Astro"><a href="#Astro" class="headerlink" title="Astro"></a>Astro</h2><p>æˆ‘ä¸€çœ‹åˆ°è¿™ä¸ªæ¡†æ¶çš„å®˜ç½‘ä»‹ç»å°±è§‰å¾—è¿™ä¸ªæ¡†æ¶é€‚åˆå†™åšå®¢.å½“ç„¶å®ƒå¾ˆçµæ´»,åŠŸèƒ½å¾ˆå¼ºå¤§.</p><p>Astroæœ¬èº«å¹¶ä¸ä¸Reactå’ŒVueå†²çª,æ‰€ä»¥ä¸€èµ·ç”¨å¹¶æ²¡é—®é¢˜.<a href="https://docs.astro.build/zh-cn/guides/integrations-guide/">ä½¿ç”¨é›†æˆ | Docs (astro.build)</a></p><h2 id="Typescript"><a href="#Typescript" class="headerlink" title="Typescript"></a>Typescript</h2><p>ç°åœ¨æµè¡Œç”¨tsä»£æ›¿jsäº†,æ‰€ä»¥è¿˜æ˜¯å­¦ä¹ ä¸€ä¸‹.å…¶å®å¹¶ä¸æ˜¯å¾ˆéš¾.</p><h2 id="Bun-Deno"><a href="#Bun-Deno" class="headerlink" title="Bun?Deno?"></a>Bun?Deno?</h2><p>nodeä¹‹åçš„è¿è¡Œæ—¶.Denoç°åœ¨æ²¡å£°äº†,å¯ä»¥è€ƒè™‘ç”¨ç”¨Bun.</p><blockquote><p>å¼€å‘ã€æµ‹è¯•ã€è¿è¡Œå’Œæ†ç»‘JavaScript&amp;TypeScripté¡¹ç›®â€”â€”æ‰€æœ‰è¿™äº›éƒ½ä½¿ç”¨Bunã€‚Bunæ˜¯ä¸€ä¸ªä¸€ä½“åŒ–çš„JavaScriptè¿è¡Œæ—¶å’Œå·¥å…·åŒ…ï¼Œä¸“ä¸ºé€Ÿåº¦è€Œè®¾è®¡ï¼Œé…æœ‰bundlerã€æµ‹è¯•è¿è¡Œç¨‹åºå’ŒNode.jså…¼å®¹çš„åŒ…ç®¡ç†å™¨ã€‚</p></blockquote><h2 id="htmlx"><a href="#htmlx" class="headerlink" title="htmlx??"></a>htmlx??</h2><p>æœ€è¿‘æ¯”è¾ƒç«,ä½†å…¶å®æœ¬èº«å°±æ˜¯ä½¿ç”¨htmlçš„è¯­æ³•å¢åŠ äº†ä¸€äº›åŸæœ¬ç”¨jsæ‰èƒ½å®ç°çš„æ¯”å¦‚ä¼ æ–‡ä»¶ã€å‘é€è¯·æ±‚çš„åŠŸèƒ½.</p><p>ä½†æˆ‘æ€»æ„Ÿè§‰å®šåˆ¶åŒ–èƒ½åŠ›æœ‰ç‚¹å¼±,å¯èƒ½æœ¬èº«ä¹Ÿæ˜¯ä¸ºäº†å¿«é€Ÿå¼€å‘ä¸€äº›webå·¥å…·ç”¨çš„.</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ‰å¾ˆå¤šæŠ€æœ¯æˆ‘å¹¶æ²¡æœ‰æåˆ°,æ¯”å¦‚è¿˜æœ‰å‰ç«¯æ¡†æ¶Angularä»¥åŠWASM<a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly">WebAssembly | MDN (mozilla.org)</a>,Qwikç­‰ç­‰,å› ä¸ºæˆ‘ç°å®ä¸­å¹¶æ²¡æœ‰è¿‡å¤šä½¿ç”¨å®ƒä»¬,è¿˜æ˜¯è®©å­å¼¹é£ä¸€ä¼šå§.</p><p>ä¸€äº›å‰ç«¯æ¡†æ¶çš„é»‘ç›’æœ‰ç‚¹å¤š,å¯¹äºåˆå­¦è€…è¿˜æ˜¯è¦å¤šå¤šå­¦ä¹ åŸºç¡€,å­¦ä¹ æ¡†æ¶æ—¶å»ºè®®ä»ç®€å•å…¥æ‰‹,æ…¢æ…¢æ·±å…¥,æ¯•ç«Ÿå¾ˆå¤šæ¡†æ¶çš„ä¸€äº›åŠŸèƒ½å…¶å®å¹³å¸¸å¯èƒ½ç”¨ä¸ä¸Š.æˆ‘æ¨èåœ¨æŒæ¡React,Nextä¹‹åå¯ä»¥å¾€Svelteæˆ–è€…Solidæ¡†æ¶å­¦ä¹ .å› ä¸ºVueä»ä¸€äº›æ¦‚å¿µä¸Šæˆ‘è§‰å¾—å¹¶æ²¡æœ‰ä¸Reactå¤ªå¤§çš„å·®å¼‚,ä¸»è¦æ˜¯ç”Ÿæ€ä¸Šå·®åˆ«,Vueçš„å®˜æ–¹ç»™çš„å·¥å…·é“¾å·²ç»æ¯”è¾ƒé½å…¨äº†,è€ŒReactçš„ç”Ÿæ€å¯ä»¥è¯´æ¯”è¾ƒå¤šæ ·åŒ–,ä½†ä¹Ÿä¼šå¯¼è‡´åœ¨é€‰æ‹©å·¥å…·ä¸Šçš„çŠ¹è±«å’Œå›°éš¾.</p><p>Solidç›®å‰æ­£åœ¨å¼€å‘Solid Startæ¡†æ¶,é¢„è®¡åº”è¯¥æ˜¯ç±»ä¼¼äºSvelteKitä¹‹äºSvelte,æœŸå¾…åç»­å‘å±•.</p><p>è€ŒAstroè¿™ç±»æ¡†æ¶ç”¨äºä¸ªäººåšå®¢ç­‰ç­‰è¿˜æ˜¯å¾ˆä¸é”™çš„.æœ€åæ¨èå‡ ä½Youtubeä¸Šçš„å‰ç«¯åšä¸»,<a href="https://www.youtube.com/@WebDevSimplified">Web Dev Simplified - YouTube</a>,<a href="https://www.youtube.com/@TraversyMedia">Traversy Media - YouTube</a>,<a href="https://www.youtube.com/@Fireship">Fireship - YouTube</a>ä»¥åŠ<a href="https://www.youtube.com/@freecodecamp">freeCodeCamp.org - YouTube</a>.å½“ç„¶ä¸åªæ˜¯å‰ç«¯ä»¥åŠä¸€äº›æŠ€æœ¯è¶‹åŠ¿.</p><h2 id="å¯ä»¥è§‚çœ‹çš„ä¸€äº›è§†é¢‘å’Œæ–‡ç« "><a href="#å¯ä»¥è§‚çœ‹çš„ä¸€äº›è§†é¢‘å’Œæ–‡ç« " class="headerlink" title="å¯ä»¥è§‚çœ‹çš„ä¸€äº›è§†é¢‘å’Œæ–‡ç« "></a>å¯ä»¥è§‚çœ‹çš„ä¸€äº›è§†é¢‘å’Œæ–‡ç« </h2><ol><li><a href="https://www.youtube.com/watch?v=Gc4Xh8u19NU">YouTube</a></li><li><a href="https://www.youtube.com/watch?v=9He4UBLyk8Y&amp;list=PLWKjhJtqVAbmMuZ3saqRIBimAKIMYkt0E&amp;ab_channel=freeCodeCamp.org">Front End Developer Roadmap 2024 - YouTube</a></li><li><a href="https://www.youtube.com/watch?v=8sXRyHI3bLw&amp;ab_channel=TraversyMedia">Web Development In 2024 - A Practical Guide (youtube.com)</a></li><li><a href="https://risingstars.js.org/2023/en">2023 JavaScript Rising Stars</a></li><li><a href="https://www.satellytes.com/blog/post/getting-started-gatsby-next-remix/">Getting Started: Gatsby vs. Next.js vs. Remix | Satellytes</a></li><li><a href="https://clonecoding.com/zh-cn/next-js-ä¸‰ç§æ¸²æŸ“æ–¹å¼-ssr-csr-ssg-ä¼˜ç¼ºç‚¹åˆ†æ/">[Next.js] ä¸‰ç§æ¸²æŸ“æ–¹å¼ - SSRã€CSRã€SSGï¼šä¼˜ç¼ºç‚¹åˆ†æ - CloneCoding</a></li><li><a href="https://juejin.cn/post/7145669817428049957">åèµ·ä¹‹ç§€svelteå’Œsolidæ˜¯å¦å€¼å¾—èŠ±æ—¶é—´å­¦ä¹ ï¼Ÿ - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://www.jdon.com/59675.html">æ¯”è¾ƒå‰ç«¯æ¡†æ¶ReactJsã€SolidJSã€Svelteå’ŒLitåº•å±‚é€»è¾‘ - Smashing - æé“ (jdon.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;é©¬ä¸Šåˆè¦åˆ°å†œå†æ–°å¹´äº†,è¶ç°åœ¨å›é¡¾ä¸€ä¸‹è¿‡å»ä¸€å¹´çš„å‰ç«¯å‘å±•.å½“ç„¶æ˜¯ç«™åœ¨æˆ‘çš„è§’åº¦,å› ä¸ºæœ‰è®¸å¤šæ–°çš„æŠ€æœ¯,å¯¹äºä¸åŒé¢†åŸŸçš„äººä»¥åŠä¸åŒå±‚é¢çš„å¼€å‘è€…éƒ½æœ‰ä¸åŒçš„æ„å‘³.&lt;br&gt;å¯¹äºæˆ‘æ¥è¯´,å¿«æ·ã€è½»æ¾çš„å¼€å‘ä½“éªŒæ˜¯æ¯”è¾ƒé‡è¦çš„,è‡ƒè‚¿çš„å¤§å‹æ¡†æ¶å¹¶ä¸æ˜¯ä¼˜ç§€çš„ä»£åè¯,æ‰€ä»¥æˆ‘ä¼šå°½é‡ä½¿ç”¨æˆ–è€…å€¾å‘å–œæ¬¢ä¸€äº›ç”Ÿæ€å‘å±•å¥½,å¼€å‘è€…ä½¿ç”¨ä½“éªŒå¥½,ç¤¾åŒºä¹Ÿæ¯”è¾ƒæ´»è·ƒçš„æ¡†æ¶æˆ–è€…æŠ€æœ¯.æ­¤å¤–,éšç€äº‹ä»¶å‘å±•è‚¯å®šä¼šä¸æ–­æ¶Œç°ä¸€äº›æ–°å‹æŠ€æœ¯ç”šè‡³æ–°çš„æ€æƒ³,å¯¹äºå­¦ä¹ è€…æ¥è¯´,è¿™äº›ä¸œè¥¿è¿˜éœ€è¦ä¸€äº›è§‚æœ›.&lt;br&gt;</summary>
    
    
    
    
    <category term="front end" scheme="https://www.sekyoro.top/tags/front-end/"/>
    
  </entry>
  
  <entry>
    <title>ååŒèåˆä»£ç å­¦ä¹ </title>
    <link href="https://www.sekyoro.top/2024/01/31/%E5%8D%8F%E5%90%8C%E8%9E%8D%E5%90%88%E4%BB%A3%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    <id>https://www.sekyoro.top/2024/01/31/%E5%8D%8F%E5%90%8C%E8%9E%8D%E5%90%88%E4%BB%A3%E7%A0%81%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-01-31T11:15:43.000Z</published>
    <updated>2024-04-01T05:49:42.449Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä»£ç è¿˜æ˜¯å¾ˆé‡è¦çš„,è™½ç„¶å‘ç°æœ‰äº›ä»£ç åº“ä¸æ€ä¹ˆæ ·.<br><span id="more"></span></p><p>ç›®å‰ååŒæ„ŸçŸ¥ç®—æ³•ä¸»è¦å°±æ˜¯åˆ©ç”¨æ³¨æ„åŠ›æœºåˆ¶å’Œå›¾ç¥ç»ç½‘ç»œ,åˆ©ç”¨backbone(åŒ…æ‹¬voxelNet,Point Pillarç­‰ç½‘ç»œ)å¤„ç†åçš„ç‰¹å¾è¿›è¡Œèåˆ,å…·ä½“çš„codebaseæˆ‘æ‰¾åˆ°ä¸‰ä¸ª(æ­¤å¤–è¿˜æœ‰å¾ˆå¤šåŸºäºOpenCOODçš„å¤šæ¨¡æ€ã€å…³æ³¨å…¶ä»–é—®é¢˜çš„ä»£ç ,è¿™é‡Œå°±æ”¾ä¸€äº›åŸºç¡€çš„).</p><ul><li>ä¸€ä¸ªæ˜¯<a href="https://github.com/coperception/where2comm?tab=readme-ov-file">coperception/where2comm: [NeurIPS 2022] Where2comm (github.com)</a>,</li><li>è¿˜æœ‰<a href="https://github.com/GT-RIPL/MultiAgentPerception">GT-RIPL/MultiAgentPerception: Official source code to CVPRâ€™20 paper, â€œWhen2com: Multi-Agent Perception via Communication Graph Groupingâ€ (github.com)</a>.</li><li>å¦ä¸€ä¸ªæ˜¯<a href="https://github.com/DerrickXuNu/OpenCOOD">DerrickXuNu/OpenCOOD: [ICRA 2022] An opensource framework for cooperative detection. Official implementation for OPV2V. (github.com)</a>.å¯ä»¥è¯´åŒ…å«è®¸å¤š20å¹´åˆ°ç°åœ¨çš„ç»å…¸è½¦è¾†ååŒæ„ŸçŸ¥çš„ç®—æ³•ä»£ç äº†,æ­¤å¤–è¿˜æœ‰ä¸€äº›é›¶æ•£çš„ç®—æ³•ä»£ç ,è¿™é‡Œå’±å°±ç»†ç»†æŠŠç©ä¸€ä¸‹.</li></ul><h2 id="Coperceptions"><a href="#Coperceptions" class="headerlink" title="Coperceptions"></a>Coperceptions</h2><p>åŒ…æ‹¬where2comm,v2vnet,disconet,v2x-vitä»¥åŠwhen2commçš„ä»£ç .</p><p><img data-src="https://github.com/coperception/where2comm/raw/gh-pages/static/images/Intro.png" alt="Where2comm"></p><p>æœ¬èº«æœ‰mean,max,catä»¥åŠagentçš„èåˆæ–¹å¼.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeanFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> torch.mean(torch.stack(self.neighbor_feat_list), dim=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>ç»§æ‰¿è‡ªFusionBase,è€Œ<code>FusionBase</code>åˆç»§æ‰¿è‡ª<code>SegModelBase</code>,åè€…å®ç°äº†ä¸€ç³»åˆ—æ¨¡å‹.åœ¨<code>FusionBase</code>ä¸­,é¦–å…ˆå¯¹ç‰¹å¾è¿›è¡Œä¸‹é‡‡æ ·,ç„¶åè½¬æ¢é™¤äº†ego agentçš„ç‰¹å¾,ç„¶åè¿›è¡Œèåˆ,æœ€åå†ä¸Šé‡‡æ ·.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> coperception.models.seg.SegModelBase <span class="keyword">import</span> SegModelBase</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FusionBase</span>(<span class="params">SegModelBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self, n_channels, n_classes, num_agent=<span class="number">5</span>, kd_flag=<span class="literal">False</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line">        self.neighbor_feat_list = <span class="literal">None</span></span><br><span class="line">        self.tg_agent = <span class="literal">None</span></span><br><span class="line">        self.current_num_agent = <span class="literal">None</span></span><br><span class="line">        self.kd_flag = kd_flag</span><br><span class="line">        self.only_v2i = only_v2i</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(</span><br><span class="line">            <span class="string">&quot;Please implement this method for specific fusion strategies&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, trans_matrices, num_agent_tensor</span>):</span></span><br><span class="line">        x1 = self.inc(x)</span><br><span class="line">        x2 = self.down1(x1)</span><br><span class="line">        x3 = self.down2(x2)</span><br><span class="line">        x4 = self.down3(x3)  <span class="comment"># b 512 32 32</span></span><br><span class="line">        size = (<span class="number">1</span>, <span class="number">512</span>, <span class="number">32</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.compress_level &gt; <span class="number">0</span>:</span><br><span class="line">            x4 = F.relu(self.bn_compress(self.com_compresser(x4)))</span><br><span class="line">            x4 = F.relu(self.bn_decompress(self.com_decompresser(x4)))</span><br><span class="line"></span><br><span class="line">        batch_size = x.size(<span class="number">0</span>) // self.num_agent</span><br><span class="line">        feat_list = <span class="built_in">super</span>().build_feat_list(x4, batch_size)</span><br><span class="line"></span><br><span class="line">        local_com_mat = torch.cat(<span class="built_in">tuple</span>(feat_list), <span class="number">1</span>)</span><br><span class="line">        local_com_mat_update = torch.cat(<span class="built_in">tuple</span>(feat_list), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">            self.com_num_agent = num_agent_tensor[b, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            agent_feat_list = <span class="built_in">list</span>()</span><br><span class="line">            <span class="keyword">for</span> nb <span class="keyword">in</span> <span class="built_in">range</span>(self.com_num_agent):</span><br><span class="line">                agent_feat_list.append(local_com_mat[b, nb])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.com_num_agent):</span><br><span class="line">                self.tg_agent = local_com_mat[b, i]</span><br><span class="line"></span><br><span class="line">                self.neighbor_feat_list = <span class="built_in">list</span>()</span><br><span class="line">                self.neighbor_feat_list.append(self.tg_agent)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(self.com_num_agent):</span><br><span class="line">                    <span class="keyword">if</span> j != i:</span><br><span class="line">                        <span class="keyword">if</span> self.only_v2i <span class="keyword">and</span> i != <span class="number">0</span> <span class="keyword">and</span> j != <span class="number">0</span>:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                        self.neighbor_feat_list.append(</span><br><span class="line">                            <span class="built_in">super</span>().feature_transformation(</span><br><span class="line">                                b,</span><br><span class="line">                                j,</span><br><span class="line">                                i,</span><br><span class="line">                                local_com_mat,</span><br><span class="line">                                size,</span><br><span class="line">                                trans_matrices,</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                local_com_mat_update[b, i] = self.fusion()</span><br><span class="line"></span><br><span class="line">        feat_mat = <span class="built_in">super</span>().agents_to_batch(local_com_mat_update)</span><br><span class="line"></span><br><span class="line">        x5 = self.down4(feat_mat)</span><br><span class="line">        x6 = self.up1(x5, feat_mat)</span><br><span class="line">        x7 = self.up2(x6, x3)</span><br><span class="line">        x8 = self.up3(x7, x2)</span><br><span class="line">        x9 = self.up4(x8, x1)</span><br><span class="line">        logits = self.outc(x9)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.kd_flag:</span><br><span class="line">            <span class="keyword">return</span> logits, x9, x8, x7, x6, x5, feat_mat</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†è¿ç»­çš„ä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·,å…ˆä¸‹é‡‡æ ·,ç„¶åè¿›è¡Œèåˆå†è¿›è¡Œä¸Šé‡‡æ ·.è¿™å‡ ç§èåˆæ–¹å¼çœŸæ˜¯ä¸€å±‚å¥—ä¸€å±‚,è¿™ä¹ˆå¤šå‚æ•°æ•ˆæœä¸å˜å¼ºæ‰æ€ªâ€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegModelBase</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self, n_channels, n_classes, bilinear=<span class="literal">True</span>, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.n_channels = n_channels</span><br><span class="line">        self.n_classes = n_classes</span><br><span class="line">        self.bilinear = bilinear</span><br><span class="line">        self.num_agent = num_agent</span><br><span class="line">        self.only_v2i = only_v2i</span><br><span class="line"></span><br><span class="line">        self.inc = DoubleConv(n_channels, <span class="number">64</span>)</span><br><span class="line">        self.down1 = Down(<span class="number">64</span>, <span class="number">128</span>)</span><br><span class="line">        self.down2 = Down(<span class="number">128</span>, <span class="number">256</span>)</span><br><span class="line">        self.down3 = Down(<span class="number">256</span>, <span class="number">512</span>)</span><br><span class="line">        factor = <span class="number">2</span> <span class="keyword">if</span> bilinear <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        self.down4 = Down(<span class="number">512</span>, <span class="number">1024</span> // factor)</span><br><span class="line">        self.up1 = Up(<span class="number">1024</span>, <span class="number">512</span> // factor, bilinear)</span><br><span class="line">        self.up2 = Up(<span class="number">512</span>, <span class="number">256</span> // factor, bilinear)</span><br><span class="line">        self.up3 = Up(<span class="number">256</span>, <span class="number">128</span> // factor, bilinear)</span><br><span class="line">        self.up4 = Up(<span class="number">128</span>, <span class="number">64</span>, bilinear)</span><br><span class="line">        self.outc = OutConv(<span class="number">64</span>, n_classes)</span><br><span class="line"></span><br><span class="line">        self.compress_level = compress_level</span><br><span class="line">        <span class="keyword">if</span> compress_level &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">assert</span> compress_level &lt;= <span class="number">9</span></span><br><span class="line">            feat_map_channel_num = <span class="number">512</span></span><br><span class="line">            compress_channel_num = feat_map_channel_num // (<span class="number">2</span>**compress_level)</span><br><span class="line"></span><br><span class="line">            self.com_compresser = nn.Conv2d(</span><br><span class="line">                feat_map_channel_num, compress_channel_num, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">            self.bn_compress = nn.BatchNorm2d(compress_channel_num)</span><br><span class="line"></span><br><span class="line">            self.com_decompresser = nn.Conv2d(</span><br><span class="line">                compress_channel_num, feat_map_channel_num, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">            self.bn_decompress = nn.BatchNorm2d(feat_map_channel_num)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_feat_list</span>(<span class="params">self, feat_maps, batch_size</span>):</span></span><br><span class="line">        feat_maps = torch.flip(feat_maps, (<span class="number">2</span>,))</span><br><span class="line"></span><br><span class="line">        tmp_feat_map = &#123;&#125;</span><br><span class="line">        feat_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_agent):</span><br><span class="line">            tmp_feat_map[i] = torch.unsqueeze(</span><br><span class="line">                feat_maps[batch_size * i : batch_size * (i + <span class="number">1</span>)], <span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">            feat_list.append(tmp_feat_map[i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> feat_list</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">feature_transformation</span>(<span class="params">b, j, agent_idx, local_com_mat, size, trans_matrices</span>):</span></span><br><span class="line">        device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">        nb_agent = torch.unsqueeze(local_com_mat[b, j], <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        tfm_ji = trans_matrices[b, j, agent_idx]</span><br><span class="line">        M = (</span><br><span class="line">            torch.hstack((tfm_ji[:<span class="number">2</span>, :<span class="number">2</span>], -tfm_ji[:<span class="number">2</span>, <span class="number">3</span>:<span class="number">4</span>])).<span class="built_in">float</span>().unsqueeze(<span class="number">0</span>)</span><br><span class="line">        )  <span class="comment"># [1,2,3]</span></span><br><span class="line">        M = M.to(device)</span><br><span class="line"></span><br><span class="line">        mask = torch.tensor([[[<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span> / <span class="number">128</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span> / <span class="number">128</span>]]], device=M.device)</span><br><span class="line"></span><br><span class="line">        M *= mask</span><br><span class="line"></span><br><span class="line">        grid = F.affine_grid(M, size=torch.Size(size))</span><br><span class="line">        warp_feat = F.grid_sample(nb_agent, grid).squeeze()</span><br><span class="line">        <span class="keyword">return</span> warp_feat</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">agents_to_batch</span>(<span class="params">self, feats</span>):</span></span><br><span class="line">        feat_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_agent):</span><br><span class="line">            feat_list.append(feats[:, i, :, :, :])</span><br><span class="line">        feat_mat = torch.cat(feat_list, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        feat_mat = torch.flip(feat_mat, (<span class="number">2</span>,))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> feat_mat</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubleConv</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels, mid_channels=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mid_channels:</span><br><span class="line">            mid_channels = out_channels</span><br><span class="line">        self.double_conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, mid_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.BatchNorm2d(mid_channels),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(mid_channels, out_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.BatchNorm2d(out_channels),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.double_conv(x)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Down</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.maxpool_conv = nn.Sequential(</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">            DoubleConv(in_channels, out_channels),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.maxpool_conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Up</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels, bilinear=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">if</span> bilinear:</span><br><span class="line">            self.up = nn.Upsample(scale_factor=<span class="number">2</span>, mode=<span class="string">&quot;bilinear&quot;</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">            self.conv = DoubleConv(in_channels, out_channels, in_channels // <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.up = nn.ConvTranspose2d(</span><br><span class="line">                in_channels, in_channels // <span class="number">2</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            self.conv = DoubleConv(in_channels, out_channels)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x1, x2</span>):</span></span><br><span class="line">        x1 = self.up(x1)</span><br><span class="line">        diff_y = x2.size()[<span class="number">2</span>] - x1.size()[<span class="number">2</span>]</span><br><span class="line">        diff_x = x2.size()[<span class="number">3</span>] - x1.size()[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        x1 = F.pad(</span><br><span class="line">            x1, [diff_x // <span class="number">2</span>, diff_x - diff_x // <span class="number">2</span>, diff_y // <span class="number">2</span>, diff_y - diff_y // <span class="number">2</span>]</span><br><span class="line">        )</span><br><span class="line">        x = torch.cat([x2, x1], dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br></pre></td></tr></table></figure><p>mean,maxå’Œsumä¸ç”¨å¤šè¯´,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> coperception.models.seg.FusionBase <span class="keyword">import</span> FusionBase</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SumFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> torch.<span class="built_in">sum</span>(torch.stack(self.neighbor_feat_list), dim=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeanFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> torch.mean(torch.stack(self.neighbor_feat_list), dim=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> torch.<span class="built_in">max</span>(torch.stack(self.neighbor_feat_list), dim=<span class="number">0</span>).values</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>catFusionå°†å…¶ä»–ç‰¹å¾åšä¸ªmeanç„¶åä¸è‡ªå·±çš„ç‰¹å¾è¿æ¥èµ·æ¥.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CatFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent, compress_level, only_v2i</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line">        self.modulation_layer_3 = ModulationLayer3()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        mean_feat = torch.mean(torch.stack(self.neighbor_feat_list), dim=<span class="number">0</span>)  <span class="comment"># [c, h, w]</span></span><br><span class="line">        cat_feat = torch.cat([self.tg_agent, mean_feat], dim=<span class="number">0</span>)</span><br><span class="line">        cat_feat = cat_feat.unsqueeze(<span class="number">0</span>)  <span class="comment"># [1, 1, c, h, w]</span></span><br><span class="line">        <span class="keyword">return</span> self.modulation_layer_3(cat_feat)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">FIXME:</span> Change size</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModulationLayer3</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ModulationLayer3, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.conv1_1 = nn.Conv2d(<span class="number">1024</span>, <span class="number">512</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.bn1_1 = nn.BatchNorm2d(<span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = x.view(-<span class="number">1</span>, x.size(-<span class="number">3</span>), x.size(-<span class="number">2</span>), x.size(-<span class="number">1</span>))</span><br><span class="line">        x_1 = F.relu(self.bn1_1(self.conv1_1(x)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x_1</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰ä¸ª<code>AgentWiseWeightedFusion</code>,æ¯ä¸ªego_agentå•ç‹¬å’Œæ¯ä¸ªå…¶ä»–ç‰¹å¾catåœ¨ä¸€èµ·å†é€šè¿‡,ç„¶åè®¡ç®—ä¸€ä¸ªèåˆç‰¹å¾,å†è®¡ç®—ä¸€ä¸ªsoftmaxä½œä¸ºç‰¹å¾çš„æƒé‡.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AgentWiseWeightedFusion</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, num_agent=<span class="number">5</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels, n_classes, num_agent=num_agent, compress_level=compress_level, only_v2i=only_v2i</span><br><span class="line">        )</span><br><span class="line">        self.agent_weighted_fusion = AgentWeightedFusion()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        agent_weight_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(self.com_num_agent):</span><br><span class="line">            cat_feat = torch.cat([self.tg_agent, self.neighbor_feat_list[k]], dim=<span class="number">0</span>)</span><br><span class="line">            cat_feat = cat_feat.unsqueeze(<span class="number">0</span>)</span><br><span class="line">            agent_weight = self.agent_weighted_fusion(cat_feat)</span><br><span class="line">            agent_weight_list.append(agent_weight)</span><br><span class="line"></span><br><span class="line">        soft_agent_weight_list = torch.squeeze(</span><br><span class="line">            F.softmax(torch.tensor(agent_weight_list).unsqueeze(<span class="number">0</span>), dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        agent_wise_weight_feat = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(self.com_num_agent):</span><br><span class="line">            agent_wise_weight_feat = (</span><br><span class="line">                agent_wise_weight_feat</span><br><span class="line">                + soft_agent_weight_list[k] * self.neighbor_feat_list[k]</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> agent_wise_weight_feat</span><br></pre></td></tr></table></figure><p>discoNetç‰¹åˆ«ä¹‹å¤„å°±åœ¨äºä½¿ç”¨äº†æ‰€è°“å­¦ç”Ÿ-æ•™å¸ˆæ¨¡å‹è¿›è¡ŒçŸ¥è¯†è’¸é¦,åœ¨ä»£ç ä¸­æ·»åŠ äº†è¿™ä¸ª.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parser.add_argument(</span><br><span class="line">    <span class="string">&quot;--kd_flag&quot;</span>,</span><br><span class="line">    default=<span class="number">0</span>,</span><br><span class="line">    <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">    <span class="built_in">help</span>=<span class="string">&quot;Whether to enable distillation (only DiscNet is 1 )&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># è¿˜æ·»åŠ äº†æƒé‡å‚æ•°,å¯è§æƒé‡åŠ å¾—è¿˜æŒºå¤§çš„.</span></span><br><span class="line">parser.add_argument(<span class="string">&quot;--kd_weight&quot;</span>, default=<span class="number">100000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&quot;KD loss weight&quot;</span>)</span><br></pre></td></tr></table></figure><p>ç„¶åç±»ä¼¼<code>AgentWiseWeightedFusion</code>,å°†egoçš„ç‰¹å¾ä¸é€šä¿¡çš„å•ç‹¬æ¯è¾†è½¦çš„ç‰¹å¾catåœ¨ä¸€èµ·ä¼ å…¥ä¸€ä¸ªç½‘ç»œä¸­,è®¡ç®—å¾—åˆ°æ‰€æœ‰å€¼çš„å¹‚å’Œ.ç„¶åå†ç”¨å„è‡ªçš„å€¼ä¹˜ä»¥å’Œ(è·Ÿsoftmaxå·®ä¸å¤š).ç®—æŒ‰å‡ºæ¥æƒé‡å†ä¹˜ä»¥å¯¹åº”çš„ç‰¹å¾.æœ€åçš„å€¼æ˜¯ç›¸åŠ èµ·æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiscoNet</span>(<span class="params">FusionBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        self, n_channels, n_classes, num_agent, kd_flag=<span class="literal">True</span>, compress_level=<span class="number">0</span>, only_v2i=<span class="literal">False</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            n_channels,</span><br><span class="line">            n_classes,</span><br><span class="line">            num_agent,</span><br><span class="line">            kd_flag=kd_flag,</span><br><span class="line">            compress_level=compress_level,</span><br><span class="line">            only_v2i=only_v2i,</span><br><span class="line">        )</span><br><span class="line">        self.pixel_weighted_fusion = PixelWeightedFusionSoftmax(<span class="number">512</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fusion</span>(<span class="params">self</span>):</span></span><br><span class="line">        tmp_agent_weight_list = <span class="built_in">list</span>()</span><br><span class="line">        sum_weight = <span class="number">0</span></span><br><span class="line">        nb_len = <span class="built_in">len</span>(self.neighbor_feat_list)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(nb_len):</span><br><span class="line">            cat_feat = torch.cat([self.tg_agent, self.neighbor_feat_list[k]], dim=<span class="number">0</span>)</span><br><span class="line">            cat_feat = cat_feat.unsqueeze(<span class="number">0</span>)</span><br><span class="line">            agent_weight = torch.squeeze(self.pixel_weighted_fusion(cat_feat))</span><br><span class="line">            tmp_agent_weight_list.append(torch.exp(agent_weight))</span><br><span class="line">            sum_weight = sum_weight + torch.exp(agent_weight)</span><br><span class="line"></span><br><span class="line">        agent_weight_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(nb_len):</span><br><span class="line">            agent_weight = torch.div(tmp_agent_weight_list[k], sum_weight)</span><br><span class="line">            agent_weight.expand([<span class="number">256</span>, -<span class="number">1</span>, -<span class="number">1</span>])</span><br><span class="line">            agent_weight_list.append(agent_weight)</span><br><span class="line"></span><br><span class="line">        agent_wise_weight_feat = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(nb_len):</span><br><span class="line">            agent_wise_weight_feat = (</span><br><span class="line">                agent_wise_weight_feat</span><br><span class="line">                + agent_weight_list[k] * self.neighbor_feat_list[k]</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> agent_wise_weight_feat</span><br></pre></td></tr></table></figure><h3 id="V2VNet"><a href="#V2VNet" class="headerlink" title="V2VNet"></a>V2VNet</h3><p><img data-src="https://s2.loli.net/2024/02/13/LK8F15wDS6jdkPJ.png" alt="image-20240213170444226"></p><p>è¯´å®è¯,çœ‹äº†ä»£ç æ„Ÿè§‰ä¹Ÿå°±é‚£æ ·â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Hao Xiang &lt;haxiang@g.ucla.edu&gt;</span></span><br><span class="line"><span class="comment"># License: TDG-Attribution-NonCommercial-NoDistrib</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Implementation of V2VNet Fusion</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> opencood.models.sub_modules.torch_transformation_utils <span class="keyword">import</span> \</span><br><span class="line">    get_discretized_transformation_matrix, get_transformation_matrix, \</span><br><span class="line">    warp_affine, get_rotated_roi</span><br><span class="line"><span class="keyword">from</span> opencood.models.sub_modules.convgru <span class="keyword">import</span> ConvGRU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2VNetFusion</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(V2VNetFusion, self).__init__()</span><br><span class="line">        </span><br><span class="line">        in_channels = args[<span class="string">&#x27;in_channels&#x27;</span>]</span><br><span class="line">        H, W = args[<span class="string">&#x27;conv_gru&#x27;</span>][<span class="string">&#x27;H&#x27;</span>], args[<span class="string">&#x27;conv_gru&#x27;</span>][<span class="string">&#x27;W&#x27;</span>]</span><br><span class="line">        kernel_size = args[<span class="string">&#x27;conv_gru&#x27;</span>][<span class="string">&#x27;kernel_size&#x27;</span>]</span><br><span class="line">        num_gru_layers = args[<span class="string">&#x27;conv_gru&#x27;</span>][<span class="string">&#x27;num_layers&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.discrete_ratio = args[<span class="string">&#x27;voxel_size&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        self.downsample_rate = args[<span class="string">&#x27;downsample_rate&#x27;</span>]</span><br><span class="line">        self.num_iteration = args[<span class="string">&#x27;num_iteration&#x27;</span>]</span><br><span class="line">        self.gru_flag = args[<span class="string">&#x27;gru_flag&#x27;</span>]</span><br><span class="line">        self.agg_operator = args[<span class="string">&#x27;agg_operator&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.msg_cnn = nn.Conv2d(in_channels * <span class="number">2</span>, in_channels, kernel_size=<span class="number">3</span>,</span><br><span class="line">                                 stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.conv_gru = ConvGRU(input_size=(H, W),</span><br><span class="line">                                input_dim=in_channels * <span class="number">2</span>,</span><br><span class="line">                                hidden_dim=[in_channels],</span><br><span class="line">                                kernel_size=kernel_size,</span><br><span class="line">                                num_layers=num_gru_layers,</span><br><span class="line">                                batch_first=<span class="literal">True</span>,</span><br><span class="line">                                bias=<span class="literal">True</span>,</span><br><span class="line">                                return_all_layers=<span class="literal">False</span>)</span><br><span class="line">        self.mlp = nn.Linear(in_channels, in_channels)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">regroup</span>(<span class="params">self, x, record_len</span>):</span></span><br><span class="line">        cum_sum_len = torch.cumsum(record_len, dim=<span class="number">0</span>)</span><br><span class="line">        split_x = torch.tensor_split(x, cum_sum_len[:-<span class="number">1</span>].cpu())</span><br><span class="line">        <span class="keyword">return</span> split_x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, record_len, pairwise_t_matrix</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Fusion forwarding.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        x : torch.Tensor</span></span><br><span class="line"><span class="string">            input data, (B, C, H, W)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        record_len : list</span></span><br><span class="line"><span class="string">            shape: (B)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        pairwise_t_matrix : torch.Tensor</span></span><br><span class="line"><span class="string">            The transformation matrix from each cav to ego, </span></span><br><span class="line"><span class="string">            shape: (B, L, L, 4, 4) </span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns</span></span><br><span class="line"><span class="string">        -------</span></span><br><span class="line"><span class="string">        Fused feature.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        _, C, H, W = x.shape</span><br><span class="line">        B, L = pairwise_t_matrix.shape[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># split x:[(L1, C, H, W), (L2, C, H, W)]</span></span><br><span class="line">        split_x = self.regroup(x, record_len)</span><br><span class="line">        <span class="comment"># (B,L,L,2,3)</span></span><br><span class="line">        pairwise_t_matrix = get_discretized_transformation_matrix(</span><br><span class="line">            pairwise_t_matrix.reshape(-<span class="number">1</span>, L, <span class="number">4</span>, <span class="number">4</span>), self.discrete_ratio,</span><br><span class="line">            self.downsample_rate).reshape(B, L, L, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="comment"># (B*L,L,1,H,W)</span></span><br><span class="line">        roi_mask = get_rotated_roi((B * L, L, <span class="number">1</span>, H, W),</span><br><span class="line">                                   pairwise_t_matrix.reshape(B * L * L, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">        roi_mask = roi_mask.reshape(B, L, L, <span class="number">1</span>, H, W)</span><br><span class="line">        batch_node_features = split_x</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># iteratively update the features for num_iteration times</span></span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(self.num_iteration):</span><br><span class="line"></span><br><span class="line">            batch_updated_node_features = []</span><br><span class="line">            <span class="comment"># iterate each batch</span></span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(B):</span><br><span class="line"></span><br><span class="line">                <span class="comment"># number of valid agent</span></span><br><span class="line">                N = record_len[b]</span><br><span class="line">                <span class="comment"># (N,N,4,4)</span></span><br><span class="line">                <span class="comment"># t_matrix[i, j]-&gt; from i to j</span></span><br><span class="line">                t_matrix = pairwise_t_matrix[b][:N, :N, :, :]</span><br><span class="line">                updated_node_features = []</span><br><span class="line">                <span class="comment"># update each node i</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">                    <span class="comment"># (N,1,H,W)</span></span><br><span class="line">                    mask = roi_mask[b, :N, i, ...]</span><br><span class="line"></span><br><span class="line">                    current_t_matrix = t_matrix[:, i, :, :]</span><br><span class="line">                    current_t_matrix = get_transformation_matrix(</span><br><span class="line">                        current_t_matrix, (H, W))</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># (N,C,H,W)</span></span><br><span class="line">                    neighbor_feature = warp_affine(batch_node_features[b],</span><br><span class="line">                                                   current_t_matrix,</span><br><span class="line">                                                   (H, W))</span><br><span class="line">                    <span class="comment"># (N,C,H,W)</span></span><br><span class="line">                    ego_agent_feature = batch_node_features[b][i].unsqueeze(</span><br><span class="line">                        <span class="number">0</span>).repeat(N, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                    <span class="comment">#(N,2C,H,W)</span></span><br><span class="line">                    neighbor_feature = torch.cat(</span><br><span class="line">                        [neighbor_feature, ego_agent_feature], dim=<span class="number">1</span>)</span><br><span class="line">                    <span class="comment"># (N,C,H,W)</span></span><br><span class="line">                    message = self.msg_cnn(neighbor_feature) * mask</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># (C,H,W)</span></span><br><span class="line">                    <span class="keyword">if</span> self.agg_operator==<span class="string">&quot;avg&quot;</span>:</span><br><span class="line">                        agg_feature = torch.mean(message, dim=<span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">elif</span> self.agg_operator==<span class="string">&quot;max&quot;</span>:</span><br><span class="line">                        agg_feature = torch.<span class="built_in">max</span>(message, dim=<span class="number">0</span>)[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">raise</span> ValueError(<span class="string">&quot;agg_operator has wrong value&quot;</span>)</span><br><span class="line">                    <span class="comment"># (2C, H, W)</span></span><br><span class="line">                    cat_feature = torch.cat(</span><br><span class="line">                        [batch_node_features[b][i, ...], agg_feature], dim=<span class="number">0</span>)</span><br><span class="line">                    <span class="comment"># (C,H,W)</span></span><br><span class="line">                    <span class="keyword">if</span> self.gru_flag:</span><br><span class="line">                        gru_out = \</span><br><span class="line">                            self.conv_gru(cat_feature.unsqueeze(<span class="number">0</span>).unsqueeze(<span class="number">0</span>))[</span><br><span class="line">                                <span class="number">0</span>][</span><br><span class="line">                                <span class="number">0</span>].squeeze(<span class="number">0</span>).squeeze(<span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        gru_out = batch_node_features[b][i, ...] + agg_feature</span><br><span class="line">                    updated_node_features.append(gru_out.unsqueeze(<span class="number">0</span>))</span><br><span class="line">                <span class="comment"># (N,C,H,W)</span></span><br><span class="line">                batch_updated_node_features.append(</span><br><span class="line">                    torch.cat(updated_node_features, dim=<span class="number">0</span>))</span><br><span class="line">            batch_node_features = batch_updated_node_features</span><br><span class="line">        <span class="comment"># (B,C,H,W)</span></span><br><span class="line">        out = torch.cat(</span><br><span class="line">            [itm[<span class="number">0</span>, ...].unsqueeze(<span class="number">0</span>) <span class="keyword">for</span> itm <span class="keyword">in</span> batch_node_features], dim=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># (B,C,H,W)</span></span><br><span class="line">        out = self.mlp(out.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)).permute(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><p>æœ‰çš„å®ç°æ²¡æœ‰RNNæ¯”å¦‚ä¸Šé¢ä»£ç ,ä¹Ÿæœ‰çš„ç”¨äº†RNNå’ŒLSTM.åè€…ä»£ç ä»£ç ç®€ç›´å°±æ˜¯å±â€¦</p><h3 id="V2xvit"><a href="#V2xvit" class="headerlink" title="V2xvit"></a>V2xvit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> v2xvit.models.sub_modules.base_transformer <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> v2xvit.models.sub_modules.hmsa <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> v2xvit.models.sub_modules.mswin <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> v2xvit.models.sub_modules.torch_transformation_utils <span class="keyword">import</span> \</span><br><span class="line">    get_transformation_matrix, warp_affine, get_roi_and_cav_mask, \</span><br><span class="line">    get_discretized_transformation_matrix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">STTF</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(STTF, self).__init__()</span><br><span class="line">        self.discrete_ratio = args[<span class="string">&#x27;voxel_size&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        self.downsample_rate = args[<span class="string">&#x27;downsample_rate&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask, spatial_correction_matrix</span>):</span></span><br><span class="line">        x = x.permute(<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">        dist_correction_matrix = get_discretized_transformation_matrix(</span><br><span class="line">            spatial_correction_matrix, self.discrete_ratio,</span><br><span class="line">            self.downsample_rate)</span><br><span class="line">        <span class="comment"># Only compensate non-ego vehicles</span></span><br><span class="line">        B, L, C, H, W = x.shape</span><br><span class="line"></span><br><span class="line">        T = get_transformation_matrix(</span><br><span class="line">            dist_correction_matrix[:, <span class="number">1</span>:, :, :].reshape(-<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), (H, W))</span><br><span class="line">        cav_features = warp_affine(x[:, <span class="number">1</span>:, :, :, :].reshape(-<span class="number">1</span>, C, H, W), T,</span><br><span class="line">                                   (H, W))</span><br><span class="line">        cav_features = cav_features.reshape(B, -<span class="number">1</span>, C, H, W)</span><br><span class="line">        x = torch.cat([x[:, <span class="number">0</span>, :, :, :].unsqueeze(<span class="number">1</span>), cav_features], dim=<span class="number">1</span>)</span><br><span class="line">        x = x.permute(<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RelTemporalEncoding</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implement the Temporal Encoding (Sinusoid) function.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_hid, RTE_ratio, max_len=<span class="number">100</span>, dropout=<span class="number">0.2</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(RelTemporalEncoding, self).__init__()</span><br><span class="line">        position = torch.arange(<span class="number">0.</span>, max_len).unsqueeze(<span class="number">1</span>)</span><br><span class="line">        div_term = torch.exp(torch.arange(<span class="number">0</span>, n_hid, <span class="number">2</span>) *</span><br><span class="line">                             -(math.log(<span class="number">10000.0</span>) / n_hid))</span><br><span class="line">        emb = nn.Embedding(max_len, n_hid)</span><br><span class="line">        emb.weight.data[:, <span class="number">0</span>::<span class="number">2</span>] = torch.sin(position * div_term) / math.sqrt(</span><br><span class="line">            n_hid)</span><br><span class="line">        emb.weight.data[:, <span class="number">1</span>::<span class="number">2</span>] = torch.cos(position * div_term) / math.sqrt(</span><br><span class="line">            n_hid)</span><br><span class="line">        emb.requires_grad = <span class="literal">False</span></span><br><span class="line">        self.RTE_ratio = RTE_ratio</span><br><span class="line">        self.emb = emb</span><br><span class="line">        self.lin = nn.Linear(n_hid, n_hid)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, t</span>):</span></span><br><span class="line">        <span class="comment"># When t has unit of 50ms, rte_ratio=1.</span></span><br><span class="line">        <span class="comment"># So we can train on 100ms but test on 50ms</span></span><br><span class="line">        <span class="keyword">return</span> x + self.lin(self.emb(t * self.RTE_ratio)).unsqueeze(</span><br><span class="line">            <span class="number">0</span>).unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RTE</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim, RTE_ratio=<span class="number">2</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(RTE, self).__init__()</span><br><span class="line">        self.RTE_ratio = RTE_ratio</span><br><span class="line"></span><br><span class="line">        self.emb = RelTemporalEncoding(dim, RTE_ratio=self.RTE_ratio)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, dts</span>):</span></span><br><span class="line">        <span class="comment"># x: (B,L,H,W,C)</span></span><br><span class="line">        <span class="comment"># dts: (B,L)</span></span><br><span class="line">        rte_batch = []</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(x.shape[<span class="number">0</span>]):</span><br><span class="line">            rte_list = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x.shape[<span class="number">1</span>]):</span><br><span class="line">                rte_list.append(</span><br><span class="line">                    self.emb(x[b, i, :, :, :], dts[b, i]).unsqueeze(<span class="number">0</span>))</span><br><span class="line">            rte_batch.append(torch.cat(rte_list, dim=<span class="number">0</span>).unsqueeze(<span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> torch.cat(rte_batch, dim=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2XFusionBlock</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, num_blocks, cav_att_config, pwindow_config</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># first multi-agent attention and then multi-window attention</span></span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        self.num_blocks = num_blocks</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks):</span><br><span class="line">            att = HGTCavAttention(cav_att_config[<span class="string">&#x27;dim&#x27;</span>],</span><br><span class="line">                                  heads=cav_att_config[<span class="string">&#x27;heads&#x27;</span>],</span><br><span class="line">                                  dim_head=cav_att_config[<span class="string">&#x27;dim_head&#x27;</span>],</span><br><span class="line">                                  dropout=cav_att_config[<span class="string">&#x27;dropout&#x27;</span>]) <span class="keyword">if</span> \</span><br><span class="line">                cav_att_config[<span class="string">&#x27;use_hetero&#x27;</span>] <span class="keyword">else</span> \</span><br><span class="line">                CavAttention(cav_att_config[<span class="string">&#x27;dim&#x27;</span>],</span><br><span class="line">                             heads=cav_att_config[<span class="string">&#x27;heads&#x27;</span>],</span><br><span class="line">                             dim_head=cav_att_config[<span class="string">&#x27;dim_head&#x27;</span>],</span><br><span class="line">                             dropout=cav_att_config[<span class="string">&#x27;dropout&#x27;</span>])</span><br><span class="line">            self.layers.append(nn.ModuleList([</span><br><span class="line">                PreNorm(cav_att_config[<span class="string">&#x27;dim&#x27;</span>], att),</span><br><span class="line">                PreNorm(cav_att_config[<span class="string">&#x27;dim&#x27;</span>],</span><br><span class="line">                        PyramidWindowAttention(pwindow_config[<span class="string">&#x27;dim&#x27;</span>],</span><br><span class="line">                                               heads=pwindow_config[<span class="string">&#x27;heads&#x27;</span>],</span><br><span class="line">                                               dim_heads=pwindow_config[</span><br><span class="line">                                                   <span class="string">&#x27;dim_head&#x27;</span>],</span><br><span class="line">                                               drop_out=pwindow_config[</span><br><span class="line">                                                   <span class="string">&#x27;dropout&#x27;</span>],</span><br><span class="line">                                               window_size=pwindow_config[</span><br><span class="line">                                                   <span class="string">&#x27;window_size&#x27;</span>],</span><br><span class="line">                                               relative_pos_embedding=</span><br><span class="line">                                               pwindow_config[</span><br><span class="line">                                                   <span class="string">&#x27;relative_pos_embedding&#x27;</span>],</span><br><span class="line">                                               fuse_method=pwindow_config[</span><br><span class="line">                                                   <span class="string">&#x27;fusion_method&#x27;</span>]))]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask, prior_encoding</span>):</span></span><br><span class="line">        <span class="keyword">for</span> cav_attn, pwindow_attn <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = cav_attn(x, mask=mask, prior_encoding=prior_encoding) + x</span><br><span class="line">            x = pwindow_attn(x) + x</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2XTEncoder</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        cav_att_config = args[<span class="string">&#x27;cav_att_config&#x27;</span>]</span><br><span class="line">        pwindow_att_config = args[<span class="string">&#x27;pwindow_att_config&#x27;</span>]</span><br><span class="line">        feed_config = args[<span class="string">&#x27;feed_forward&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        num_blocks = args[<span class="string">&#x27;num_blocks&#x27;</span>]</span><br><span class="line">        depth = args[<span class="string">&#x27;depth&#x27;</span>]</span><br><span class="line">        mlp_dim = feed_config[<span class="string">&#x27;mlp_dim&#x27;</span>]</span><br><span class="line">        dropout = feed_config[<span class="string">&#x27;dropout&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.downsample_rate = args[<span class="string">&#x27;sttf&#x27;</span>][<span class="string">&#x27;downsample_rate&#x27;</span>]</span><br><span class="line">        self.discrete_ratio = args[<span class="string">&#x27;sttf&#x27;</span>][<span class="string">&#x27;voxel_size&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        self.use_roi_mask = args[<span class="string">&#x27;use_roi_mask&#x27;</span>]</span><br><span class="line">        self.use_RTE = cav_att_config[<span class="string">&#x27;use_RTE&#x27;</span>]</span><br><span class="line">        self.RTE_ratio = cav_att_config[<span class="string">&#x27;RTE_ratio&#x27;</span>]</span><br><span class="line">        self.sttf = STTF(args[<span class="string">&#x27;sttf&#x27;</span>])</span><br><span class="line">        <span class="comment"># adjust the channel numbers from 256+3 -&gt; 256</span></span><br><span class="line">        self.prior_feed = nn.Linear(cav_att_config[<span class="string">&#x27;dim&#x27;</span>] + <span class="number">3</span>,</span><br><span class="line">                                    cav_att_config[<span class="string">&#x27;dim&#x27;</span>])</span><br><span class="line">        self.layers = nn.ModuleList([])</span><br><span class="line">        <span class="keyword">if</span> self.use_RTE:</span><br><span class="line">            self.rte = RTE(cav_att_config[<span class="string">&#x27;dim&#x27;</span>], self.RTE_ratio)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">            self.layers.append(nn.ModuleList([</span><br><span class="line">                V2XFusionBlock(num_blocks, cav_att_config, pwindow_att_config),</span><br><span class="line">                PreNorm(cav_att_config[<span class="string">&#x27;dim&#x27;</span>],</span><br><span class="line">                        FeedForward(cav_att_config[<span class="string">&#x27;dim&#x27;</span>], mlp_dim,</span><br><span class="line">                                    dropout=dropout))</span><br><span class="line">            ]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask, spatial_correction_matrix</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># transform the features to the current timestamp</span></span><br><span class="line">        <span class="comment"># velocity, time_delay, infra</span></span><br><span class="line">        <span class="comment"># (B,L,H,W,3)</span></span><br><span class="line">        prior_encoding = x[..., -<span class="number">3</span>:]</span><br><span class="line">        <span class="comment"># (B,L,H,W,C)</span></span><br><span class="line">        x = x[..., :-<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> self.use_RTE:</span><br><span class="line">            <span class="comment"># dt: (B,L)</span></span><br><span class="line">            dt = prior_encoding[:, :, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>].to(torch.<span class="built_in">int</span>)</span><br><span class="line">            x = self.rte(x, dt)</span><br><span class="line">        x = self.sttf(x, mask, spatial_correction_matrix)</span><br><span class="line">        com_mask = mask.unsqueeze(<span class="number">1</span>).unsqueeze(<span class="number">2</span>).unsqueeze(</span><br><span class="line">            <span class="number">3</span>) <span class="keyword">if</span> <span class="keyword">not</span> self.use_roi_mask <span class="keyword">else</span> get_roi_and_cav_mask(x.shape,</span><br><span class="line">                                                                  mask,</span><br><span class="line">                                                                  spatial_correction_matrix,</span><br><span class="line">                                                                  self.discrete_ratio,</span><br><span class="line">                                                                  self.downsample_rate)</span><br><span class="line">        <span class="keyword">for</span> attn, ff <span class="keyword">in</span> self.layers:</span><br><span class="line">            x = attn(x, mask=com_mask, prior_encoding=prior_encoding)</span><br><span class="line">            x = ff(x) + x</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V2XTransformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(V2XTransformer, self).__init__()</span><br><span class="line"></span><br><span class="line">        encoder_args = args[<span class="string">&#x27;encoder&#x27;</span>]</span><br><span class="line">        self.encoder = V2XTEncoder(encoder_args)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, mask, spatial_correction_matrix</span>):</span></span><br><span class="line">        output = self.encoder(x, mask, spatial_correction_matrix)</span><br><span class="line">        output = output[:, <span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure><p>å…³é”®æ˜¯è„±ç¦»äº†agent2agent,è€Œæ˜¯vehicle2everything,å‘å¼‚æ„å¤šæ¨¡æ€å‘å±•.</p><h3 id="DiscoNet"><a href="#DiscoNet" class="headerlink" title="DiscoNet"></a>DiscoNet</h3><p>ä¸»è¦æ˜¯åˆ©ç”¨äº†è’¸é¦,æ•™å¸ˆ-å­¦ç”Ÿæ¨¡å‹è¿™ç§ç†è®º.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.kd_flag == <span class="number">1</span>:</span><br><span class="line">        teacher = TeacherNet(config)</span><br><span class="line">        teacher = nn.DataParallel(teacher)</span><br><span class="line">        teacher = teacher.to(device)</span><br><span class="line">        faf_module = FaFModule(</span><br><span class="line">            model, teacher, config, optimizer, criterion, args.kd_flag</span><br><span class="line">        )</span><br><span class="line">        checkpoint_teacher = torch.load(args.resume_teacher)</span><br><span class="line">        start_epoch_teacher = checkpoint_teacher[<span class="string">&quot;epoch&quot;</span>]</span><br><span class="line">        faf_module.teacher.load_state_dict(checkpoint_teacher[<span class="string">&quot;model_state_dict&quot;</span>])</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&quot;Load teacher model from &#123;&#125;, at epoch &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                args.resume_teacher, start_epoch_teacher</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        faf_module.teacher.<span class="built_in">eval</span>()</span><br></pre></td></tr></table></figure><p>å…ˆä½¿ç”¨tearcherNetæ‹¿æ•°æ®è¿›è¡Œè®­ç»ƒ,ç„¶åæ‹¿è®­ç»ƒåçš„æ¨¡å‹åŠ è½½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherNet</span>(<span class="params">NonIntermediateModelBase</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;The teacher net for knowledged distillation in DiscoNet.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, config</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(TeacherNet, self).__init__(config, compress_level=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, bevs, maps=<span class="literal">None</span>, vis=<span class="literal">None</span></span>):</span></span><br><span class="line">        bevs = bevs.permute(<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">3</span>)  <span class="comment"># (Batch, seq, z, h, w)</span></span><br><span class="line">        <span class="comment"># vis = vis.permute(0, 3, 1, 2)</span></span><br><span class="line">        <span class="keyword">return</span> self.stpn(bevs)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ•™å¸ˆæ¨¡å‹å¾—åˆ°çš„ç»“æœå’ŒåŸæœ¬æ¨¡å‹å¾—åˆ°çš„ç»“æœ(ä¸€äº›ä¸­é—´èåˆå±‚)è®¡ç®—æŸå¤±,ä»£ç ä¸­ç”¨çš„KLäº¤å‰ç†µæŸå¤±</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_kd_loss</span>(<span class="params">self, batch_size, data, fused_layer, num_agent, x_5, x_6, x_7</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.kd_flag:</span><br><span class="line">        bev_seq_teacher = data[<span class="string">&quot;bev_seq_teacher&quot;</span>]</span><br><span class="line">        kd_weight = data[<span class="string">&quot;kd_weight&quot;</span>]</span><br><span class="line">        (</span><br><span class="line">            x_8_teacher,</span><br><span class="line">            x_7_teacher,</span><br><span class="line">            x_6_teacher,</span><br><span class="line">            x_5_teacher,</span><br><span class="line">            x_3_teacher,</span><br><span class="line">            x_2_teacher,</span><br><span class="line">        ) = self.teacher(bev_seq_teacher)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># for k, v in self.teacher.named_parameters():</span></span><br><span class="line">        <span class="comment"># if k != &#x27;xxx.weight&#x27; and k != &#x27;xxx.bias&#x27;:</span></span><br><span class="line">        <span class="comment"># print(v.requires_grad)  # should be False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># for k, v in self.model.named_parameters():</span></span><br><span class="line">        <span class="comment"># if k != &#x27;xxx.weight&#x27; and k != &#x27;xxx.bias&#x27;:</span></span><br><span class="line">        <span class="comment"># print(v.requires_grad)  # should be False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -------- KD loss---------#</span></span><br><span class="line">        kl_loss_mean = nn.KLDivLoss(size_average=<span class="literal">True</span>, reduce=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># target_x8 = x_8_teacher.permute(0, 2, 3, 1).reshape(5 * batch_size * 256 * 256, -1)</span></span><br><span class="line">        <span class="comment"># student_x8 = x_8.permute(0, 2, 3, 1).reshape(5 * batch_size * 256 * 256, -1)</span></span><br><span class="line">        <span class="comment"># kd_loss_x8 = kl_loss_mean(F.log_softmax(student_x8, dim=1), F.softmax(target_x8, dim=1))</span></span><br><span class="line">        <span class="comment"># #</span></span><br><span class="line">        target_x7 = x_7_teacher.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">128</span> * <span class="number">128</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        student_x7 = x_7.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">128</span> * <span class="number">128</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        kd_loss_x7 = kl_loss_mean(</span><br><span class="line">            F.log_softmax(student_x7, dim=<span class="number">1</span>), F.softmax(target_x7, dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        target_x6 = x_6_teacher.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">64</span> * <span class="number">64</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        student_x6 = x_6.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">64</span> * <span class="number">64</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        kd_loss_x6 = kl_loss_mean(</span><br><span class="line">            F.log_softmax(student_x6, dim=<span class="number">1</span>), F.softmax(target_x6, dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># #</span></span><br><span class="line">        target_x5 = x_5_teacher.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">32</span> * <span class="number">32</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        student_x5 = x_5.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">32</span> * <span class="number">32</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        kd_loss_x5 = kl_loss_mean(</span><br><span class="line">            F.log_softmax(student_x5, dim=<span class="number">1</span>), F.softmax(target_x5, dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        target_x3 = x_3_teacher.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">32</span> * <span class="number">32</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        student_x3 = fused_layer.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(</span><br><span class="line">            num_agent * batch_size * <span class="number">32</span> * <span class="number">32</span>, -<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        kd_loss_fused_layer = kl_loss_mean(</span><br><span class="line">            F.log_softmax(student_x3, dim=<span class="number">1</span>), F.softmax(target_x3, dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        kd_loss = kd_weight * (</span><br><span class="line">            kd_loss_x7 + kd_loss_x6 + kd_loss_x5 + kd_loss_fused_layer</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># kd_loss = kd_weight * (kd_loss_x6 + kd_loss_x5 + kd_loss_fused_layer)</span></span><br><span class="line">        <span class="comment"># print(kd_loss)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        kd_loss = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> kd_loss</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>KLæŸå¤±å®šä¹‰å¦‚ä¸‹</p><p><img data-src="https://s2.loli.net/2024/02/27/CQuUxlwvFV7ceB5.png" alt="image-20240227225503889"></p><h2 id="Comunicaton-Mechanism"><a href="#Comunicaton-Mechanism" class="headerlink" title="Comunicaton Mechanism"></a>Comunicaton Mechanism</h2><p>ä¹‹å‰çš„æ–¹æ³•åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨é€šä¿¡èŒƒå›´å†…å›ºå®šè½¦è¾†çš„æ‰€æœ‰ç‰¹å¾,ä¹‹åæœ‰äº†è‡ªå®šä¹‰çš„é€šä¿¡æœºåˆ¶,å¯¹é€šä¿¡çš„è½¦è¾†,ç‰¹å¾ç­‰è¿›è¡Œé€‰æ‹©.</p><h3 id="who2com-2020"><a href="#who2com-2020" class="headerlink" title="who2com 2020"></a>who2com 2020</h3><p><a href="https://arxiv.org/abs/2003.09575">[2003.09575] Who2com: Collaborative Perception via Learnable Handshake Communication (arxiv.org)</a></p><p><img data-src="https://s2.loli.net/2024/02/29/muRMCOTiKLwl6X9.png" alt="image-20240229143700618"></p><p><img data-src="https://s2.loli.net/2024/02/29/ZheUYj6bvl9T7XP.png" alt="image-20240229143720495"></p><p><strong>Who2com å»ºç«‹äº†é¦–ä¸ªå¸¦å®½é™åˆ¶ä¸‹çš„é€šä¿¡æœºåˆ¶</strong>ï¼Œé€šè¿‡ä¸‰é˜¶æ®µæ¡æ‰‹å®ç°ã€‚å…·ä½“æ¥è¯´ï¼Œ<strong>Who2com ä½¿ç”¨ä¸€èˆ¬æ³¨æ„åŠ›å‡½æ•°è®¡ç®—ä»£ç†ä¹‹é—´çš„åŒ¹é…åˆ†æ•°ï¼Œå¹¶é€‰æ‹©æœ€éœ€è¦çš„ä»£ç†ï¼Œä»è€Œæœ‰æ•ˆå‡å°‘å¸¦å®½</strong>ã€‚</p><p>å®šä¹‰äº†ä¸€ä¸ªä¸‰é˜¶æ®µçš„handshakeé€šä¿¡æœºåˆ¶,åˆ†ä¸ºrequest,match,connect.</p><p>å…·ä½“æ¥è¯´ï¼Œä»£ç†é¦–å…ˆå‘é‚»è¿‘çš„ä»£ç†å¹¿æ’­å…¶è¯·æ±‚ä¿¡æ¯ Î¼~j~âˆˆ R~m~ï¼Œä»£ç†è®¡ç®—å…¶keys Îºiâˆˆ R~k~ ä¸è¯·æ±‚ä¿¡æ¯ä¹‹é—´çš„åŒ¹é…å¾—åˆ† s~ji~ã€‚</p><p>ä¸€æ—¦ç†å°†å…¶åŒ¹é…åˆ†æ•°è¿”å›ç»™é™çº§egoä»£ç†,egoä»£ç†ä¼šè¿›ä¸€æ­¥é€‰æ‹©æœ€ä½³çš„ n ä¸ªä»£ç†ä¸ä¹‹è¿æ¥</p><p>åœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæ¯ä¸ªä»£ç† i å¯ä»¥é€šè¿‡keyç”Ÿæˆå™¨ G~i~^k^ã€ä¿¡æ¯ç”Ÿæˆå™¨ G~i~^m^ã€å›¾åƒç¼–ç å™¨ E~i~ å’Œä»»åŠ¡è§£ç å™¨ D~i~ å¯¹ä¿¡æ¯è¿›è¡Œå‹ç¼©ã€‚</p><p>ç®€å•æ¥è¯´,å¯¹äºä¸€ä¸ªegoä»£ç†,é¦–å…ˆä½¿ç”¨ä¸€ä¸ªrequestç”Ÿæˆå™¨(å°±æ˜¯ä¸€ä¸ªç½‘ç»œ)å¾—åˆ°ä¸€ä¸ªä¿¡æ¯.æ­¤å¤–å…¶ä»–è½¦ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªkeyå‘é€ç»™egoä»£ç†,ç„¶åä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶è®¡ç®—ä¸¤è€…å€¼ä½œä¸ºç›¸ä¼¼åº¦.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># # Message generator</span></span><br><span class="line">       self.query_key_net = policy_net4(n_classes=n_classes, in_channels=in_channels, enc_backbone=enc_backbone)</span><br><span class="line">       <span class="keyword">if</span> self.has_query:</span><br><span class="line">           self.query_net = linear(out_size=self.query_size, input_feat_sz=image_size / <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">       self.key_net = linear(out_size=self.key_size, input_feat_sz=image_size / <span class="number">32</span>)</span><br><span class="line">       <span class="keyword">if</span> attention == <span class="string">&#x27;additive&#x27;</span>:</span><br><span class="line">           self.attention_net = AdditiveAttentin()</span><br><span class="line">       <span class="keyword">elif</span> attention == <span class="string">&#x27;general&#x27;</span>:</span><br><span class="line">           self.attention_net = GeneralDotProductAttention(self.query_size, self.key_size)</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           self.attention_net = ScaledDotProductAttention(<span class="number">128</span> ** <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure><script type="math/tex; mode=display">\mu_j=G_m^j(\tilde{x}_j;\theta_m)\in\mathbb{R}^m \\s_{ji}=\Phi(\mu_j,\kappa_i),\quad\kappa_i=G_k^i(x_i;\theta_k)\in\mathbb{R}^k \\\text{General: }\Phi=\mu_j^TW_a\kappa_i \\\tilde{\boldsymbol{y}}_j=D^j([\tilde{\boldsymbol{f}}_j;f_{\hat{\imath}}];\boldsymbol{\theta}_d) \\f_{\hat{\imath}}=E^i(x_{\hat{\imath}};\boldsymbol{\theta}_e)\in\mathbb{R}^{d_f\times d_f\times d_c}   \tilde{\boldsymbol{f}}_j=E^j(\tilde{\boldsymbol{x}}_j;\boldsymbol{\theta}_e) \\\tilde{y}_{j}=D^{j}([\tilde{f}_{j};f_{sum}];\theta_{d}),\quad f_{sum}=\sum_{i=1}^{N}\alpha_{j,i}f_{i} \\\hat{i}=\underset{i}{\operatorname*{argmax}}s_{ji}</script><blockquote><p>Î±~j,i~ is ith element of Î±~j~ = Ï([s~j1~; â€¦; s~jN~ ]) âˆˆ R^N^ and Ï is a softmax operation</p></blockquote><p>attentionæ–¹æ³•å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaledDotProductAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; Scaled Dot-Product Attention &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, temperature, attn_dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.temperature = temperature</span><br><span class="line">        self.sparsemax = Sparsemax(dim=<span class="number">1</span>)</span><br><span class="line">        self.softmax = nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, q, k, v, sparse=<span class="literal">True</span></span>):</span></span><br><span class="line">        attn_orig = torch.bmm(k, q.transpose(<span class="number">2</span>, <span class="number">1</span>))</span><br><span class="line">        attn_orig = attn_orig / self.temperature</span><br><span class="line">        <span class="keyword">if</span> sparse:</span><br><span class="line">            attn_orig = self.sparsemax(attn_orig)  </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            attn_orig = self.softmax(attn_orig)  </span><br><span class="line">        attn = torch.unsqueeze(torch.unsqueeze(attn_orig, <span class="number">3</span>), <span class="number">4</span>)  </span><br><span class="line">        output = attn * v  <span class="comment"># (batch,4,channel,size,size)</span></span><br><span class="line">        output = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line">        <span class="keyword">return</span> output, attn_orig.transpose(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">AdditiveAttentin</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># self.dropout = nn.Dropout(attn_dropout)</span></span><br><span class="line">        self.softmax = nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line">        self.sparsemax = Sparsemax(dim=<span class="number">1</span>)</span><br><span class="line">        self.linear_feat = nn.Linear(<span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">        self.linear_context = nn.Linear(<span class="number">128</span>, <span class="number">128</span>)</span><br><span class="line">        self.linear_out = nn.Linear(<span class="number">128</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, q, k, v, sparse=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="comment"># q (batch,1,128)</span></span><br><span class="line">        <span class="comment"># k (batch,4,128)</span></span><br><span class="line">        <span class="comment"># v (batch,4,channel,size,size)</span></span><br><span class="line">        temp1 = self.linear_feat(k)  <span class="comment"># (batch,4,128)</span></span><br><span class="line">        temp2 = self.linear_context(q)  <span class="comment"># (batch,1,128)</span></span><br><span class="line">        attn_orig = self.linear_out(temp1 + temp2)  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        <span class="keyword">if</span> sparse:</span><br><span class="line">            attn_orig = self.sparsemax(attn_orig)  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            attn_orig = self.softmax(attn_orig)  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        attn = torch.unsqueeze(torch.unsqueeze(attn_orig, <span class="number">3</span>), <span class="number">4</span>)  <span class="comment"># (batch,4,1,1,1)</span></span><br><span class="line">        output = attn * v</span><br><span class="line">        output = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line">        <span class="keyword">return</span> output, attn_orig.transpose(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeneralDotProductAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; Scaled Dot-Product Attention &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, query_size, key_size, attn_dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.sparsemax = Sparsemax(dim=<span class="number">1</span>)</span><br><span class="line">        self.softmax = nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line">        self.linear = nn.Linear(query_size, key_size)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Msg size: &#x27;</span>,query_size,<span class="string">&#x27;  Key size: &#x27;</span>, key_size)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, q, k, v, sparse=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="comment"># q (batch,1,128)</span></span><br><span class="line">        <span class="comment"># k (batch,4,128)</span></span><br><span class="line">        <span class="comment"># v (batch,4,channel*size*size)</span></span><br><span class="line">        query = self.linear(q)  <span class="comment"># (batch,1,key_size)</span></span><br><span class="line">        attn_orig = torch.bmm(k, query.transpose(<span class="number">2</span>, <span class="number">1</span>))  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        <span class="keyword">if</span> sparse:</span><br><span class="line">            attn_orig = self.sparsemax(attn_orig)  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            attn_orig = self.softmax(attn_orig)  <span class="comment"># (batch,4,1)</span></span><br><span class="line">        attn = torch.unsqueeze(torch.unsqueeze(attn_orig, <span class="number">3</span>), <span class="number">4</span>)  <span class="comment"># (batch,4,1,1,1)</span></span><br><span class="line">        output = attn * v  <span class="comment"># (batch,4,channel,size,size)</span></span><br><span class="line">        output = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line">        <span class="keyword">return</span> output, attn_orig.transpose(<span class="number">2</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="when2comm-2020"><a href="#when2comm-2020" class="headerlink" title="when2comm 2020"></a>when2comm 2020</h3><p>who2commçš„åŒä½œè€….</p><p>åœ¨ Who2com çš„åŸºç¡€ä¸Šï¼ŒWhen2comå¼•å…¥äº†ç¼©æ”¾ä¸€èˆ¬æ³¨æ„åŠ›æ¥å†³å®šä½•æ—¶ä¸ä»–äººäº¤æµã€‚è¿™æ ·ï¼Œè‡ªæˆ‘ä»£ç†åªæœ‰åœ¨ä¿¡æ¯ä¸è¶³æ—¶æ‰ä¼šä¸ä»–äººäº¤æµï¼Œä»è€Œæœ‰æ•ˆåœ°èŠ‚çœäº†åä½œèµ„æºã€‚</p><p><img data-src="https://s2.loli.net/2024/02/29/COiPgxUSrsYvqQL.png" alt="image-20240229162328653"></p><p>when2commçš„ä»£ç å°±è¦å¤æ‚çš„å¤š,å®ƒæ„å»ºäº†å¾ˆå¤šå—.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KmGenerator</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, out_size=<span class="number">128</span>, input_feat_sz=<span class="number">32.0</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(KmGenerator, self).__init__()</span><br><span class="line">        feat_map_sz = input_feat_sz // <span class="number">4</span></span><br><span class="line">        self.n_feat = <span class="built_in">int</span>(<span class="number">256</span> * feat_map_sz * feat_map_sz)</span><br><span class="line">        self.fc = nn.Sequential(</span><br><span class="line">            nn.Linear(self.n_feat, <span class="number">256</span>),  <span class="comment">#</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(<span class="number">256</span>, <span class="number">128</span>),  <span class="comment">#</span></span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(<span class="number">128</span>, out_size),</span><br><span class="line">        )  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, features_map</span>):</span></span><br><span class="line">        outputs = self.fc(features_map.view(-<span class="number">1</span>, self.n_feat))</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PolicyNet4</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels=<span class="number">13</span>, input_feat_sz=<span class="number">32</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(PolicyNet4, self).__init__()</span><br><span class="line">        feat_map_sz = input_feat_sz // <span class="number">4</span></span><br><span class="line">        self.n_feat = <span class="built_in">int</span>(<span class="number">256</span> * feat_map_sz * feat_map_sz)</span><br><span class="line">        self.lidar_encoder = LidarEncoder(height_feat_size=in_channels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        <span class="comment"># down 1</span></span><br><span class="line">        self.conv1 = Conv2DBatchNormRelu(<span class="number">512</span>, <span class="number">512</span>, k_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.conv2 = Conv2DBatchNormRelu(<span class="number">512</span>, <span class="number">256</span>, k_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.conv3 = Conv2DBatchNormRelu(<span class="number">256</span>, <span class="number">256</span>, k_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># down 2</span></span><br><span class="line">        self.conv4 = Conv2DBatchNormRelu(<span class="number">256</span>, <span class="number">256</span>, k_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.conv5 = Conv2DBatchNormRelu(<span class="number">256</span>, <span class="number">256</span>, k_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, features_map</span>):</span></span><br><span class="line">        _, _, _, _, outputs1 = self.lidar_encoder(features_map)</span><br><span class="line">        outputs = self.conv1(outputs1)</span><br><span class="line">        outputs = self.conv2(outputs)</span><br><span class="line">        outputs = self.conv3(outputs)</span><br><span class="line">        outputs = self.conv4(outputs)</span><br><span class="line">        outputs = self.conv5(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">   </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LidarEncoder</span>(<span class="params">Backbone</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;The encoder class. Encodes input features in forward pass.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, height_feat_size=<span class="number">13</span>, compress_level=<span class="number">0</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(height_feat_size, compress_level)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().encode(x)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LidarDecoder</span>(<span class="params">Backbone</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;The decoder class. Decodes input features in forward pass.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, height_feat_size=<span class="number">13</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(height_feat_size)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, x_1, x_2, x_3, x_4, batch, kd_flag=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().decode(x, x_1, x_2, x_3, x_4, batch, kd_flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨encodeè¿›è¡Œé™é‡‡æ ·,é€‰æ‹©æŸä¸€å±‚é‡‡æ ·åçš„è¾“å‡º,åˆ©ç”¨é‡‡æ ·åçš„è¾“å‡ºè®¡ç®—q,k,vä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶èåˆ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">self.key_net = KmGenerator(</span><br><span class="line">    out_size=self.key_size, input_feat_sz=image_size / <span class="number">32</span></span><br><span class="line">)</span><br><span class="line">self.attention_net = MIMOGeneralDotProductAttention(</span><br><span class="line">    self.query_size, self.key_size, self.warp_flag</span><br><span class="line">)</span><br><span class="line"><span class="comment"># # Message generator</span></span><br><span class="line">self.query_key_net = PolicyNet4(in_channels=in_channels)</span><br><span class="line"><span class="keyword">if</span> self.has_query:</span><br><span class="line">    self.query_net = KmGenerator(</span><br><span class="line">        out_size=self.query_size, input_feat_sz=image_size / <span class="number">32</span></span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨query_key_netç”Ÿæˆç‰¹å¾,å†åˆ©ç”¨key_netç”Ÿæˆkey,query_netç”Ÿæˆquery,ä½¿ç”¨attention_netåˆ©ç”¨æ³¨æ„åŠ›æœºåˆ¶è¿›è¡Œèåˆ.val_matå°±æ˜¯é‡‡æ ·åçš„è¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key_mat = torch.cat(<span class="built_in">tuple</span>(key_list), <span class="number">1</span>)</span><br><span class="line">query_mat = torch.cat(<span class="built_in">tuple</span>(query_list), <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ç”¨çš„å°±æ˜¯ç‚¹ç§¯æ³¨æ„åŠ›,ç„¶åä½¿ç”¨decoderå›å».</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># hand-shake</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MIMOGeneralDotProductAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Scaled Dot-Product Attention&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, query_size, key_size, warp_flag, attn_dropout=<span class="number">0.1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.sparsemax = Sparsemax(dim=<span class="number">1</span>)</span><br><span class="line">        self.softmax = nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line">        self.linear = nn.Linear(query_size, key_size)</span><br><span class="line">        self.warp_flag = warp_flag</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Msg size: &quot;</span>, query_size, <span class="string">&quot;  Key size: &quot;</span>, key_size)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, qu, k, v, sparse=<span class="literal">True</span></span>):</span></span><br><span class="line">      </span><br><span class="line">        query = self.linear(qu)  <span class="comment"># (batch,5,key_size)</span></span><br><span class="line">        attn_orig = torch.bmm(</span><br><span class="line">            k, query.transpose(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        )  </span><br><span class="line">        attn_orig_softmax = self.softmax(attn_orig)  <span class="comment"># (batch,5,5)</span></span><br><span class="line"></span><br><span class="line">        attn_shape = attn_orig_softmax.shape</span><br><span class="line">        bats, key_num, query_num = attn_shape[<span class="number">0</span>], attn_shape[<span class="number">1</span>], attn_shape[<span class="number">2</span>]</span><br><span class="line">        attn_orig_softmax_exp = attn_orig_softmax.view(</span><br><span class="line">            bats, key_num, query_num, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.warp_flag == <span class="number">1</span>:</span><br><span class="line">            v_exp = v</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v_exp = torch.unsqueeze(v, <span class="number">2</span>)</span><br><span class="line">            v_exp = v_exp.expand(-<span class="number">1</span>, -<span class="number">1</span>, query_num, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        output = attn_orig_softmax_exp * v_exp  <span class="comment"># (batch,5,channel,size,size)</span></span><br><span class="line">        output_sum = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output_sum, attn_orig_softmax</span><br></pre></td></tr></table></figure><p>è®­ç»ƒçš„æ—¶å€™åŸºæœ¬å°±æ‹¿è¿™äº›ç‰¹å¾ç»™åˆ†ç±»å’Œå›å½’çš„headåšè¾“å‡ºäº†.ä½†æ˜¯inferenceçš„æ—¶å€™è®¾ç½®äº†å¤šç§è¾“å‡º.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> inference == <span class="string">&#x27;softmax&#x27;</span>:</span><br><span class="line">              action = torch.argmax(prob_action, dim=<span class="number">2</span>)</span><br><span class="line">              num_connect = <span class="number">4</span></span><br><span class="line">              <span class="keyword">return</span> pred, prob_action, action, num_connect</span><br><span class="line">          <span class="keyword">elif</span> inference == <span class="string">&#x27;argmax_test&#x27;</span>:</span><br><span class="line">              action = torch.argmax(prob_action, dim=<span class="number">2</span>)</span><br><span class="line">              feat_argmax, num_connect = self.argmax_select(feat_map1, feat_map2, feat_map3, feat_map4, feat_map5,</span><br><span class="line">                                                            action, batch_size)</span><br><span class="line">              featmaps_argmax = feat_argmax.detach()</span><br><span class="line">              pred_argmax = self.decoder(featmaps_argmax)</span><br><span class="line">              <span class="keyword">return</span> pred_argmax, prob_action, action, num_connect</span><br><span class="line">          <span class="keyword">elif</span> inference == <span class="string">&#x27;activated&#x27;</span>:</span><br><span class="line">              feat_act, action, num_connect = self.activated_select(vals, prob_action)</span><br><span class="line">              featmaps_act = feat_act.detach()</span><br><span class="line">              pred_act = self.decoder(featmaps_act)</span><br><span class="line">              <span class="keyword">return</span> pred_act, prob_action, action, num_connect</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">              <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Incorrect inference mode&#x27;</span>)</span><br></pre></td></tr></table></figure><p>argmax_selectå’Œactivatedåˆ†åˆ«å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">argmax_select</span>(<span class="params">self, val_mat, prob_action</span>):</span></span><br><span class="line">        <span class="comment"># v(batch, query_num, channel, size, size)</span></span><br><span class="line">        cls_num = prob_action.shape[<span class="number">1</span>]</span><br><span class="line"><span class="comment">#  è¿›è¡Œone hotç¼–ç ,</span></span><br><span class="line">        coef_argmax = F.one_hot(prob_action.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">1</span>],  num_classes=cls_num).<span class="built_in">type</span>(torch.cuda.FloatTensor)</span><br><span class="line">        coef_argmax = coef_argmax.transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        attn_shape = coef_argmax.shape</span><br><span class="line">        bats, key_num, query_num = attn_shape[<span class="number">0</span>], attn_shape[<span class="number">1</span>], attn_shape[<span class="number">2</span>]</span><br><span class="line">        coef_argmax_exp = coef_argmax.view(bats, key_num, query_num, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        v_exp = torch.unsqueeze(val_mat, <span class="number">2</span>)</span><br><span class="line">        v_exp = v_exp.expand(-<span class="number">1</span>, -<span class="number">1</span>, query_num, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        output = coef_argmax_exp * v_exp  <span class="comment"># (batch,4,channel,size,size)</span></span><br><span class="line">        feat_argmax = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># compute connect</span></span><br><span class="line">        count_coef = copy.deepcopy(coef_argmax)</span><br><span class="line">        ind = np.diag_indices(self.agent_num)</span><br><span class="line">        count_coef[:, ind[<span class="number">0</span>], ind[<span class="number">1</span>]] = <span class="number">0</span></span><br><span class="line">        num_connect = torch.nonzero(count_coef).shape[<span class="number">0</span>] / (self.agent_num * count_coef.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> feat_argmax, coef_argmax, num_connect</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">activated_select</span>(<span class="params">self, val_mat, prob_action, thres=<span class="number">0.2</span></span>):</span></span><br><span class="line"></span><br><span class="line">        coef_act = torch.mul(prob_action, (prob_action &gt; thres).<span class="built_in">float</span>())</span><br><span class="line">        attn_shape = coef_act.shape</span><br><span class="line">        bats, key_num, query_num = attn_shape[<span class="number">0</span>], attn_shape[<span class="number">1</span>], attn_shape[<span class="number">2</span>]</span><br><span class="line">        coef_act_exp = coef_act.view(bats, key_num, query_num, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        v_exp = torch.unsqueeze(val_mat, <span class="number">2</span>)</span><br><span class="line">        v_exp = v_exp.expand(-<span class="number">1</span>, -<span class="number">1</span>, query_num, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        output = coef_act_exp * v_exp  <span class="comment"># (batch,4,channel,size,size)</span></span><br><span class="line">        feat_act = output.<span class="built_in">sum</span>(<span class="number">1</span>)  <span class="comment"># (batch,1,channel,size,size)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># compute connect</span></span><br><span class="line">        count_coef = coef_act.clone()</span><br><span class="line">        ind = np.diag_indices(self.agent_num)</span><br><span class="line">        count_coef[:, ind[<span class="number">0</span>], ind[<span class="number">1</span>]] = <span class="number">0</span></span><br><span class="line">        num_connect = torch.nonzero(count_coef).shape[<span class="number">0</span>] / (self.agent_num * count_coef.shape[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span> feat_act, coef_act, num_connect\</span><br></pre></td></tr></table></figure><h3 id="where2comm-2022"><a href="#where2comm-2022" class="headerlink" title="where2comm 2022"></a>where2comm 2022</h3><p><img data-src="https://s2.loli.net/2024/02/28/5jYTmRyw2iIEQeb.png" alt="image-20240228210811764"></p><p><img data-src="https://s2.loli.net/2024/02/28/Cj1SE42UmL9IWYR.png" alt="image-20240228170628090"></p><p>å…¶ä¸­ where2comm åŒ…æ‹¬observation encoderã€spatial confidence generatorã€the spatial confidence-aware communication moduleã€the spatial confidence-aware message fusionå’Œdetection decoder.</p><p>åœ¨äº”ä¸ªæ¨¡å—ä¸­ï¼Œ<strong>spatial confidence generator</strong>å¯ç”Ÿæˆç©ºé—´ç½®ä¿¡åº¦å›¾,åŸºäºè¯¥ç©ºé—´ç½®ä¿¡åº¦å›¾ï¼Œ<strong>ç©ºé—´ç½®ä¿¡åº¦æ„ŸçŸ¥é€šä¿¡</strong>(spatial confidence-aware communication)å¯ç”Ÿæˆç´§å‡‘çš„ä¿¡æ¯å’Œç¨€ç–çš„é€šä¿¡å›¾ï¼Œä»¥èŠ‚çœé€šä¿¡å¸¦å®½.<strong>spatial confidence-aware message fusion</strong> moduleåˆ©ç”¨ä¿¡æ¯ä¸°å¯Œçš„ç©ºé—´ç½®ä¿¡åº¦å…ˆéªŒæ¥å®ç°æ›´å¥½çš„èšåˆ.</p><p>æˆ‘ä»¬ä½¿ç”¨æ£€æµ‹è§£ç å™¨ç»“æ„æ¥ç”Ÿæˆæ£€æµ‹ç½®ä¿¡åº¦å›¾ã€‚ç»™å®šç¬¬ k è½®é€šä¿¡çš„ç‰¹å¾å›¾ F (k) iï¼Œç›¸åº”çš„ç©ºé—´ç½®ä¿¡åº¦å›¾ä¸º</p><script type="math/tex; mode=display">\mathbf{C}_i^{(k)}=\Phi_\text{generator}(\mathcal{F}_i^{(k)})\in[0,1]^{H\times W}</script><p>ä¸ºäº†åœ¨ä¸å½±å“æ„ŸçŸ¥çš„æƒ…å†µä¸‹å‡å°‘é€šä¿¡å¸¦å®½ï¼Œæˆ‘ä»¬åˆ©ç”¨ç©ºé—´ç½®ä¿¡åº¦å›¾æ¥é€‰æ‹©ç‰¹å¾å›¾ä¸­ä¿¡æ¯é‡æœ€å¤§çš„ç©ºé—´åŒºåŸŸï¼ˆåœ¨å“ªé‡Œé€šä¿¡ï¼‰ï¼Œå¹¶å†³å®šæœ€æœ‰åˆ©çš„åˆä½œå¯¹è±¡ï¼ˆè°æ¥é€šä¿¡ï¼‰ã€‚</p><p>è¿™ä¸ªcommunicationåŒ…æ‹¬message packingã€‚message packingå†³å®šäº†è¦å‘é€çš„ä¿¡æ¯ä¸­åº”åŒ…å«å“ªäº›ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼ši) ä¸€å¼ requestå›¾ï¼Œè¡¨æ˜ä»£ç†éœ€è¦äº†è§£å“ªäº›ç©ºé—´åŒºåŸŸçš„æ›´å¤šä¿¡æ¯ï¼›ii) ä¸€å¼ ç©ºé—´ç¨€ç–ä½†æ„ŸçŸ¥å…³é”®çš„ç‰¹å¾å›¾ã€‚</p><h3 id="what2comm-2023"><a href="#what2comm-2023" class="headerlink" title="what2comm 2023"></a>what2comm 2023</h3><h4 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h4><p>å¤šæ™ºèƒ½ä½“ååŒæ„ŸçŸ¥ä½œä¸ºé©¾é©¶åœºæ™¯çš„æ–°å…´åº”ç”¨å—åˆ°è¶Šæ¥è¶Šå¤šçš„å…³æ³¨ã€‚å°½ç®¡ä»¥å‰çš„æ–¹æ³•å–å¾—äº†è¿›æ­¥ï¼Œä½†ç”±äº<strong>å†—ä½™çš„é€šä¿¡æ¨¡å¼</strong>å’Œ<strong>è„†å¼±çš„åä½œè¿‡ç¨‹</strong>ï¼ŒæŒ‘æˆ˜ä»ç„¶å­˜åœ¨ã€‚</p><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æå‡ºäº†What2commï¼Œä¸€ä¸ª<strong>ç«¯åˆ°ç«¯åä½œæ„ŸçŸ¥æ¡†æ¶ï¼Œä»¥å®ç°æ„ŸçŸ¥æ€§èƒ½å’Œé€šä¿¡å¸¦å®½ä¹‹é—´çš„æƒè¡¡</strong>ã€‚æˆ‘ä»¬çš„æ–°å¥‡æ€§åœ¨äºä¸‰ä¸ªæ–¹é¢</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ç§åŸºäº<strong>ç‰¹å¾è§£è€¦çš„é«˜æ•ˆé€šä¿¡æœºåˆ¶</strong>ï¼Œåœ¨å¼‚æ„ä»£ç†ä¹‹é—´ä¼ è¾“æ’ä»–çš„å’Œå…±åŒçš„ç‰¹å¾æ˜ å°„ï¼Œä»¥æä¾›æ„ŸçŸ¥ä¸Šçš„æ•´ä½“æ¶ˆæ¯ã€‚</p><p>å…¶æ¬¡ï¼Œ<strong>å¼•å…¥äº†ä¸€ä¸ªæ—¶ç©ºåä½œæ¨¡å—æ¥æ•´åˆæ¥è‡ªåä½œè€…çš„äº’è¡¥ä¿¡æ¯å’Œæ—¶é—´è‡ªæˆ‘çº¿ç´¢</strong>ï¼Œä»è€Œå½¢æˆä¸€ä¸ª<strong>é’ˆå¯¹ä¼ è¾“å»¶è¿Ÿå’Œå®šä½è¯¯å·®</strong>çš„é²æ£’åä½œè¿‡ç¨‹ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§<strong>å…¬å…±æ„ŸçŸ¥çš„èåˆç­–ç•¥</strong>æ¥ç»†åŒ–å…·æœ‰ä¿¡æ¯å…±åŒç‰¹å¾çš„æœ€ç»ˆè¡¨ç¤ºã€‚</p><p>åœ¨çœŸå®ä¸–ç•Œå’Œæ¨¡æ‹Ÿåœºæ™¯ä¸­è¿›è¡Œçš„ç»¼åˆå®éªŒè¯æ˜äº†What2é€šä¿¡çš„æœ‰æ•ˆæ€§ã€‚</p><p>DAIR-V2X:ç¬¬ä¸€ä¸ªç”¨äºæ”¯æŒåä½œæ„ŸçŸ¥çš„å¤§è§„æ¨¡çœŸå®ä¸–ç•Œæ•°æ®é›†ï¼Œå®ƒåŒ…å«äº†æ ‡è®°çš„è½¦è¾†å’ŒåŸºç¡€è®¾æ–½çš„æ¿€å…‰é›·è¾¾ç‚¹äº‘ã€‚å®ƒåŒ…æ‹¬100ä¸ªè‡ªåŠ¨é©¾é©¶åœºæ™¯å’Œ18000ä¸ªæ•°æ®æ ·æœ¬ï¼Œå…¶ä¸­è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†ä»¥5ï¼š2ï¼š3çš„æ¯”ä¾‹è¢«åˆ†å‰²ã€‚</p><p>V2XSet </p><p>OPV2V</p><h4 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h4><p>å…ƒæ•°æ®ç¼–ç å’Œç‰¹å¾æŠ•å½±ã€åŸºäºè§£è€¦çš„é€šä¿¡æœºåˆ¶ã€æ—¶ç©ºåä½œæ¨¡å—ã€commonæ„ŸçŸ¥èåˆç­–ç•¥å’Œæ£€æµ‹è§£ç å™¨ã€‚</p><p> This framework comprises five parts: metadata encoding and feature projection, decoupling-based communication mechanism, spatio-temporal collaboration module, common-aware</p><p>fusion strategy, and detection decoders</p><blockquote><p><strong>ç‰¹å¾è§£è€¦</strong>å‰ææ˜¯å­¦ä¹ ç‰¹å¾ï¼Œ<strong>è§£è€¦æ˜¯åˆ†ç¦»å‡ºä»»åŠ¡ç›¸å…³ç‰¹å¾å’Œæ— å…³ç‰¹å¾</strong>ï¼Œä»¥åˆ†ç±»ä¸ºä¾‹ï¼Œè§£è€¦çš„æ˜¯ç±»åˆ«ç‰¹å¾å’Œæ— å…³çš„èƒŒæ™¯åŠæ ·å¼ç­‰ç‰¹å¾ã€‚ç‰¹å¾è§£è€¦ä¸€èˆ¬åˆ©ç”¨ä¿¡æ¯ç†µæˆ–è€…å˜æ¢ç©ºé—´åçš„æ•°å­¦ç‰¹æ€§æ¥å®Œæˆã€‚</p><p>åªè¦ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨ä¸€æ–¹ä¾èµ–ä¸€æ–¹çš„å…³ç³»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç§°è¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨è€¦åˆã€‚</p><p>ä½œè€…ï¼šå¤§è™ç”œé¢é…±<br>é“¾æ¥ï¼š<a href="https://www.jianshu.com/p/67dc5f5e05da">https://www.jianshu.com/p/67dc5f5e05da</a><br>æ¥æºï¼šç®€ä¹¦<br>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p></blockquote><p><img data-src="https://s2.loli.net/2024/02/28/Jr9OnUyvfEkcxtD.png" alt="image-20240228101157638"></p><p><img data-src="https://s2.loli.net/2024/02/28/WFc8MJjfDOny1Zt.png" alt="image-20240228165036544"></p><p>åˆ›æ–°ç‚¹:feature decoupling,latency-aware ä½¿ç”¨è¿‡å»çš„ç‰¹å¾.</p><h3 id="how2comm-2023"><a href="#how2comm-2023" class="headerlink" title="how2comm 2023"></a>how2comm 2023</h3><p>ç³»what2commåŒä½œè€…</p><h2 id="Spatio-Temporal-Domain-Awareness-for-Multi-Agent-Collaborative-Perception"><a href="#Spatio-Temporal-Domain-Awareness-for-Multi-Agent-Collaborative-Perception" class="headerlink" title="Spatio-Temporal Domain Awareness for Multi-Agent Collaborative Perception"></a>Spatio-Temporal Domain Awareness for Multi-Agent Collaborative Perception</h2><p>åœ¨æ¥æ”¶åˆ°è‡ªæˆ‘ä»£ç†æ’­æ”¾çš„å…ƒæ•°æ®ï¼ˆå¦‚å§¿åŠ¿å’Œå¤–éƒ¨ç‰¹å¾ï¼‰åï¼Œåˆä½œè€…å°†å…¶æœ¬åœ°æ¿€å…‰é›·è¾¾ç‚¹äº‘æŠ•å°„åˆ°è‡ªæˆ‘ä»£ç†çš„åæ ‡ç³»ä¸­ã€‚åŒæ ·ï¼Œ<strong>è‡ªæˆ‘ä»£ç†ä¹‹å‰çš„ç‚¹äº‘å¸§ä¹Ÿä¼šåŒæ­¥åˆ°å½“å‰å¸§</strong>ã€‚</p><p>ç»™å®šç¬¬ k ä¸ªä»£ç†åœ¨æ—¶é—´æˆ³ t å¤„çš„ç‚¹äº‘ X (t) kï¼Œæå–çš„ç‰¹å¾ä¸º F (t) k =f enc (X (t) k )âˆˆR C Ã—H Ã—W ï¼Œå…¶ä¸­ f enc (-) æ˜¯æ‰€æœ‰ä»£ç†å…±äº«çš„ PointPillarç¼–ç å™¨ï¼ŒCã€Hã€W åˆ†åˆ«ä»£è¡¨é€šé“ã€é«˜åº¦å’Œå®½åº¦ã€‚</p><h3 id="Context-aware-Information-Aggregation"><a href="#Context-aware-Information-Aggregation" class="headerlink" title="Context-aware Information Aggregation"></a>Context-aware Information Aggregation</h3><p>è§£å†³latencyçš„é—®é¢˜</p><p><img data-src="https://s2.loli.net/2024/03/04/4Qqgwk9uGciJBYj.png" alt="image-20240304214842491"></p><p>é—æ†¾çš„æ˜¯ï¼Œç›®å‰çš„å¤šæœºå™¨äººåä½œæ€»æ˜¯ä¸“æ³¨äºæ¢ç´¢å½“å‰å¸§ï¼Œè€Œå¿½ç•¥äº†ä¹‹å‰å¸§çš„ä¸Šä¸‹æ–‡çº¿ç´¢ã€‚ç”±äºç‚¹äº‘çš„ç¨€ç–æ€§å’Œä¸è¶³ï¼Œå•å¸§è§£å†³æ–¹æ¡ˆæ— æ³•æœ‰æ•ˆæ£€æµ‹å¿«é€Ÿç§»åŠ¨çš„ç‰©ä½“ï¼ˆå¦‚å‘¨å›´çš„è½¦è¾†ï¼‰ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªæƒ…å¢ƒæ„ŸçŸ¥ä¿¡æ¯èšåˆï¼ˆCIAï¼‰ç»„ä»¶ï¼Œç”¨äºæ•æ‰è‡ªæˆ‘ä»£ç†<strong>ä¹‹å‰å¸§çš„æ—¶ç©ºè¡¨å¾ï¼Œä»¥èåˆæœ‰ä»·å€¼çš„è¯­ä¹‰</strong>ã€‚</p><p>é€‰æ‹©æ€§ä¿¡æ¯è¿‡æ»¤ã€‚è¿™ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯é€šè¿‡è¿‡æ»¤ç›®æ ‡ F (t) i âˆˆR C Ã—H Ã—W ä¸­çš„å†—ä½™ç‰¹å¾ï¼Œå¹¶ä»å…ˆå‰çš„ F^(t-Ï„)^~i~ âˆˆR Ï„ Ã—CÃ—HÃ—W ä¸­æç‚¼å‡ºæœ‰æ„ä¹‰çš„ç‰¹å¾ï¼Œä»è€Œæå–ç²¾ç‚¼ä¿¡æ¯ï¼Œå…¶ä¸­ Ï„ æ˜¯æ—¶é—´åç§»ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œé¦–å…ˆåˆ©ç”¨é€šé“å¹³å‡å’Œæœ€å¤§æ± åŒ–è¿ç®— Î¨ a/m (-) èšåˆä¸°å¯Œçš„é€šé“è¯­ä¹‰</p><script type="math/tex; mode=display">\mathcal{U}=\sigma\cdot\aleph(\mathcal{M}_{a}^{(t)}\|\mathcal{M}_{m}^{(t)}+\mathcal{M}_{a}^{(\tau)}\|\mathcal{M}_{m}^{(\tau)})\in\mathbb{R}^{H\times W}</script><p>å°†è¿‡å»å¸§ç›¸åŠ åšä¸ªmaxä¸avgæ± åŒ–ç„¶åconcatèµ·æ¥,å½“å‰çš„å¸§ä¹ŸåŒæ ·å¤„ç†,ç„¶ååŠ èµ·æ¥åšä¸ªconv.å°†è¿™äº›ç»†åŒ–çš„ç‰¹å¾å›¾ç»“åˆèµ·æ¥ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªç²¾å¿ƒé€‰æ‹©çš„ç©ºé—´é€‰æ‹©å›¾</p><script type="math/tex; mode=display">H_i^{(\tau)}=(1-\mathcal{U})\odot tanh(F_i^{(t)})+\mathcal{U}\odot F_i^{(t-\tau)}</script><h4 id="Spatio-temporal-Feature-Integration"><a href="#Spatio-temporal-Feature-Integration" class="headerlink" title="Spatio-temporal Feature Integration."></a>Spatio-temporal Feature Integration.</h4><p>ä¸ºäº†æ•´åˆhistorical prototypeä»¥æé«˜å½“å‰è¡¨å¾çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œæˆ‘ä»¬å¼•å…¥äº†é‡‘å­—å¡” LSTMæ¥å­¦ä¹ å¸§é—´ç‰¹å¾ F (t) i âˆ¥H (Ï„ ) i çš„ä¸Šä¸‹æ–‡ä¾èµ–å…³ç³»ã€‚</p><p>åœ¨å®è·µä¸­ï¼Œå¤šå°ºåº¦ç©ºé—´ç‰¹å¾æ˜¯é€šè¿‡åœ¨ä¸åŒå°ºåº¦ä¹‹é—´è¿ç»­è¿›è¡Œä¸¤æ¬¡äºŒç»´å·ç§¯ï¼Œç„¶åè¿›è¡Œæ‰¹é‡å½’ä¸€åŒ–å’Œ ReLU æ¿€æ´»æ¥æå–çš„ã€‚ä¸ºäº†å®ç°å¤šå±‚æ¬¡ç©ºé—´è¯­ä¹‰èåˆï¼Œ<strong>é™ä½é‡‡æ ·ç‡çš„ç‰¹å¾ä¼šé€šè¿‡æ¨ªå‘è¿æ¥é€æ­¥æ’å€¼åˆ°æé«˜é‡‡æ ·ç‡çš„å±‚</strong>ã€‚</p><h3 id="Confidence-aware-Cross-agent-Collaboration"><a href="#Confidence-aware-Cross-agent-Collaboration" class="headerlink" title="Confidence-aware Cross-agent Collaboration"></a>Confidence-aware Cross-agent Collaboration</h3><p>è·¨ä»£ç†åä½œçš„ç›®æ ‡æ˜¯é€šè¿‡èšåˆåä½œè€…å…±äº«ç‰¹å¾çš„äº’è¡¥è¯­ä¹‰æ¥å¢å¼ºè‡ªæˆ‘ä»£ç†çš„è§†è§‰è¡¨å¾ã€‚</p><p>ç°æœ‰ç ”ç©¶æå‡ºäº†åŸºäºæ³¨æ„åŠ›çš„per-locationç‰¹å¾èåˆæ–¹æ³•ï¼Œä½†è¿™ç§æ–¹æ³•å®¹æ˜“å—åˆ°å®šä½è¯¯å·®çš„å½±å“ï¼Œè€Œä¸”å¿½ç•¥äº†ç‚¹äº‘çš„ç¨€ç–æ€§ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†a <strong>novel Confidenceaware Cross-agent Collaboration (CCC) component</strong></p><p><img data-src="https://s2.loli.net/2024/03/04/4zjauARgEMekoSt.png" alt="image-20240304221451619"></p><p>CCC ç»„ä»¶å°†ç‰¹å¾å’Œç½®ä¿¡åº¦å›¾ç¼–ç ä¸ºä¸‰ä¸ªå°ºåº¦ï¼Œ<strong>å¹¶åœ¨æ¯ä¸ªå°ºåº¦ä¸Šè¿›è¡Œç‰¹å¾èåˆ</strong>ã€‚</p><p>F^(t)^~k,l~ å’Œ S^(t)^~k,l~ è¡¨ç¤ºç¬¬ l ä¸ªå°ºåº¦çš„ç‰¹å¾å›¾å’Œç½®ä¿¡åº¦å›¾.</p><p>ä¸ºäº†é¢„æµ‹åŒ…å«æœ‰æ„ä¹‰ç‰©ä½“ä¿¡æ¯çš„ç©ºé—´ä½ç½®ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ç½®ä¿¡åº¦å›¾çš„å…ƒç´ æ±‚å’Œ.</p><p>ç”±äºç½®ä¿¡åº¦å›¾åæ˜ çš„æ˜¯ç©ºé—´ä¸´ç•Œæ°´å¹³ï¼ŒS^(t)^~sum,l~ æ˜¾ç¤ºçš„æ˜¯æ¢æµ‹èŒƒå›´å†…ç›®æ ‡çš„æ½œåœ¨ä½ç½®ï¼Œç§°ä¸ºå‚è€ƒç‚¹ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬é‡‡ç”¨åŸºäºé˜ˆå€¼çš„é€‰æ‹©å‡½æ•° fsel(-) æ¥æå–å‚è€ƒç‚¹ S^(t)^~re,l~ã€‚è¿™ç§è®¾è®¡å¯ä»¥ç§¯æå¼•å¯¼åç»­çš„èåˆç½‘ç»œé›†ä¸­åœ¨é‡è¦çš„ç©ºé—´åŒºåŸŸã€‚</p><p><strong>Deformable Cross-attention Module</strong> æˆ‘ä»¬åœ¨å‚è€ƒç‚¹æå–è‡ªæˆ‘ä»£ç†çš„ç‰¹å¾ F^(t)^ ~i,l~ ä½œä¸ºåˆå§‹æŸ¥è¯¢åµŒå…¥ï¼Œå¹¶<strong>åº”ç”¨çº¿æ€§å±‚å°†å‚è€ƒç‚¹çš„ä½ç½®ç¼–ç ä¸ºä½ç½®åµŒå…¥</strong></p><p>ä¸ºäº†è§£å†³ç‰¹å¾å›¾çš„ä¸å¯¹é½é—®é¢˜ï¼Œå¹¶è·å¾—æ›´ç¨³å¥çš„è¡¨å¾ä»¥æŠµå¾¡å®šä½è¯¯å·®ï¼Œå¯å˜å½¢äº¤å‰æ³¨æ„æ¨¡å—ï¼ˆDCMï¼‰é€šè¿‡å¯å˜å½¢äº¤å‰æ³¨æ„å±‚èšåˆæ¥è‡ªé‡‡æ ·å…³é”®ç‚¹çš„ä¿¡æ¯</p><script type="math/tex; mode=display">\mathrm{DCM}(q)=\sum_{a=1}^{\Lambda}W_{a}[\sum_{k=1}^{K}\sum_{m=1}^{M}\phi(W_{b}F_{i,l}^{(t)}(q))F_{k,l}^{(t)}(q+\Delta q_{m})],</script><p>Wa/b æ˜¯å¯å­¦ä¹ æƒé‡ï¼ŒÏ†(-) æ˜¯è½¯æœ€å¤§å‡½æ•°ã€‚æœ€åï¼Œæˆ‘ä»¬å¾—å‡ºä¸€ä¸ªå¡«å……æ“ä½œï¼Œæ ¹æ®åˆå§‹ä½ç½® q å°† DCM(q) å¡«å……åˆ°è‡ªæˆ‘ä»£ç†çš„ç‰¹å¾ F (t) i,l ä¸­ï¼Œå¹¶è¾“å‡º Z(t) i,l</p><p>ä¸‰ä¸ªå°ºåº¦ä¸‹çš„è¾“å‡ºå¢å¼ºç‰¹å¾è¢«ç¼–ç æˆç›¸åŒçš„å¤§å°ï¼Œå¹¶åœ¨é€šé“ç»´åº¦ä¸Šè¿›è¡Œä¸²è”ã€‚æˆ‘ä»¬åˆ©ç”¨ 1 Ã— 1 å·ç§¯å±‚èåˆä¸‰ä¸ªå°ºåº¦çš„ä¿¡æ¯ï¼Œå¾—åˆ°æœ€ç»ˆçš„åä½œç‰¹å¾ Z^(t)^~i~âˆˆ R^CÃ—HÃ—W^</p><h3 id="Importance-aware-Adaptive-Fusion"><a href="#Importance-aware-Adaptive-Fusion" class="headerlink" title="Importance-aware Adaptive Fusion"></a>Importance-aware Adaptive Fusion</h3><p>å°½ç®¡ä¹‹å‰çš„ç ”ç©¶é€šè¿‡æ±‡æ€»åä½œä¿¡æ¯çš„è‡ªæˆ‘ç‰¹å¾å–å¾—äº†ä»¤äººå°è±¡æ·±åˆ»çš„æ€§èƒ½ï¼Œä½†å®ƒä»¬å¯èƒ½ä¼šå—åˆ°å¼‚æ­¥æµ‹é‡çš„åä½œè€…å¸¦æ¥çš„å™ªå£°å¹²æ‰°ã€‚A promising solution is to <strong>consider purely ego-centered characteristics</strong>, which contain the natural perception advantages of the target agent.</p><p>æˆ‘ä»¬æå‡ºäº†ä¸€ç§é‡è¦æ€§æ„ŸçŸ¥è‡ªé€‚åº”èåˆï¼ˆIAFï¼‰ç»„ä»¶ï¼Œæ ¹æ®å¤šæºç‰¹å¾çš„äº’è¡¥æ€§å¯¹å…¶è¿›è¡Œèåˆã€‚</p><script type="math/tex; mode=display">\mathcal{H}_{i}^{(t)},\mathcal{Z}_{i}^{(t)},\mathcal{S}_{i}^{(t)}=\sigma\cdot\Psi_{m}(f_{gen}(H_{i}^{(t)},Z_{i}^{(t)},F_{i}^{(t)}))</script><script type="math/tex; mode=display">\mathcal{E}_{\mathcal{H}}^{(t)}=\phi(\mathcal{H}_{i}^{(t)})=\frac{exp(\mathcal{H}_{i}^{(t)})}{exp(\mathcal{H}_{i}^{(t)})+exp(\mathcal{Z}_{i}^{(t)})+exp(\mathcal{S}_{i}^{(t)})}.$$â€‹$$\mathcal{F}_i^{(t)}=\mathcal{E}_{\mathcal{H}}^{(t)}\odot H_i^{(t)}+\mathcal{E}_{\mathcal{Z}}^{(t)}\odot Z_i^{(t)}+\mathcal{E}_{\mathcal{S}}^{(t)}\odot F_i^{(t)}.</script><h3 id="FPV-RCNN-2021"><a href="#FPV-RCNN-2021" class="headerlink" title="FPV-RCNN 2021"></a>FPV-RCNN 2021</h3><p><a href="https://arxiv.org/abs/2109.11615">[2109.11615] Keypoints-Based Deep Feature Fusion for Cooperative Vehicle Detection of Autonomous Driving (arxiv.org)</a></p><h3 id="Collaborative-3d-object-detection-for-automatic-vehicle-systems-via-learnable-communications-2022"><a href="#Collaborative-3d-object-detection-for-automatic-vehicle-systems-via-learnable-communications-2022" class="headerlink" title="Collaborative 3d object detection for automatic vehicle systems via learnable communications 2022"></a>Collaborative 3d object detection for automatic vehicle systems via learnable communications 2022</h3><p><a href="https://arxiv.org/pdf/2205.11849.pdf">2205.11849.pdf (arxiv.org)</a></p><p><img data-src="https://s2.loli.net/2024/02/29/RANi2pLbKPZslu5.png" alt="image-20240229172548113"></p><p><img data-src="https://s2.loli.net/2024/02/29/RP1nMsk5h2B4pzj.png" alt="image-20240229172522190"></p><h2 id="Customized-Loss"><a href="#Customized-Loss" class="headerlink" title="Customized Loss"></a>Customized Loss</h2><p>é™¤äº†åˆ†ç±»å’Œå›å½’æŸå¤±ä¹‹å¤–ï¼Œè™½ç„¶ V2V é€šä¿¡ä¸ºè‡ªæˆ‘è½¦è¾†æä¾›äº†ç›¸å¯¹ä¸°å¯Œçš„æ„ŸçŸ¥è§†é‡ï¼Œä½†<strong>å…±äº«ä¿¡æ¯çš„å†—ä½™æ€§</strong>å’Œ<strong>ä¸ç¡®å®šæ€§</strong>å¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ã€‚</p><p>åœ¨åä½œåœºæ™¯ä¸­ï¼Œé‚»å±…ä»£ç†æä¾›çš„ç±»ä¼¼ä¿¡æ¯å¯¹è‡ªæˆ‘è½¦è¾†æ¥è¯´æ˜¯å†—ä½™çš„ã€‚ä¸ºäº†æœ‰æ•ˆåˆ©ç”¨åä½œä¿¡æ¯ï¼ŒLuo ç­‰äººæå‡ºäº†ä¸€ç§äº’è¡¥å¢å¼ºå’Œå†—ä½™æœ€å°åŒ–çš„åä½œç½‘ç»œï¼ˆCRCNetï¼‰ã€‚å…·ä½“æ¥è¯´ï¼ŒCRCNet æœ‰ä¸¤ä¸ªæ¨¡å—æ¥å¼•å¯¼ç½‘ç»œã€‚åœ¨äº’è¡¥æ€§å¢å¼ºæ¨¡å—ä¸­ï¼ŒCRCNet åˆ©ç”¨å¯¹æ¯”å­¦ä¹ æ¥å¢å¼ºä¿¡æ¯å¢ç›Šã€‚åœ¨å†—ä½™æœ€å°åŒ–æ¨¡å—ä¸­ï¼ŒCRCNet åˆ©ç”¨äº’ä¿¡æ¯é¼“åŠ±èåˆç‰¹å¾å¯¹ä¸­çš„ä¾èµ–æ€§ã€‚åœ¨ä¸Šè¿°æ¨¡å—çš„æŒ‡å¯¼ä¸‹ï¼ŒCRCNet èƒ½å¤Ÿåœ¨èåˆç‰¹å¾æ—¶ä»ç›¸é‚»ä»£ç†ä¸­é€‰æ‹©äº’è¡¥ä¿¡æ¯ã€‚</p><script type="math/tex; mode=display">P_{i}=P_{i}+W_{k\rightarrow i}^{C}\odot P_{k\rightarrow i}\odot W_{k\rightarrow i}^{s} \\\delta_{k}=\sum_{n}L_{cls}\big(p_{j}^{n}(P_{i}),y_{j}^{n}\big)-\sum_{n}L_{cls}\big(p_{j}^{n}(P_{i}+T_{i}^{k}),y_{j}^{n}\big) \\L_{eff}=\sum_k\min(\delta_k-\delta_{thd},0)^2 \\I[T_i^k;T_i^l]=\sum\limits_{x\in T_i^k}\sum\limits_{y\in T_i^l}p(x,y)\log\frac{p(x,y)}{p(x)p(y)} \\\begin{aligned}I[T_{i}^{k};T_{i}^{l}]=& \mathbb{E}_{p(T_{i}^{k};T_{i}^{l})}[\logq_{\theta_{2}}(T_{i}^{l}/T_{i}^{k})]  \\&-\mathbb{E}_{p(T_{i}^{k})}\mathbb{E}_{p(T_{i}^{l})}[\logq_{\theta_{2}}(T_{i}^{l}/T_{i}^{k})],\end{aligned} \\L_{red}=\sum_k\sum_l[\logq_{\theta_2}(T_i^l/T_i^k)-\logq_{\theta_2}(T_i^l/T_n^k)]\\min_{Q}L_{KL}=KL(p(T_i^k/T_i^l)||q_{\theta_2}(T_i^k/T_i^l) \\L=L_{cls}+L_{loc}+L_{red}+L_{eff}\\</script><p><img data-src="https://s2.loli.net/2024/02/29/a5NIGnJloEwK4Hp.png" alt="image-20240229180846509"></p><p>é™¤äº†å†—ä½™ä¿¡æ¯ï¼Œåä½œä¿¡æ¯è¿˜åŒ…å«æ„ŸçŸ¥ä¸Šçš„ä¸ç¡®å®šæ€§ï¼Œè¿™åæ˜ äº†æ„ŸçŸ¥ä¸Šçš„ä¸å‡†ç¡®æˆ–ä¼ æ„Ÿå™¨å™ªå£°ã€‚Su ç­‰äººé¦–å…ˆæ¢è®¨äº†åä½œæ„ŸçŸ¥ä¸­çš„ä¸ç¡®å®šæ€§ã€‚å…·ä½“æ¥è¯´ï¼Œä»–ä»¬è®¾è®¡äº†ä¸€ç§é‡èº«å®šåˆ¶çš„ç§»åŠ¨å—å¼•å¯¼æ–¹æ³•æ¥ä¼°è®¡æ¨¡å‹å’Œæ•°æ®çš„ä¸ç¡®å®šæ€§ï¼Œå¹¶è®¾è®¡äº†ä¸€ä¸ªè‰¯å¥½çš„æŸå¤±å‡½æ•°æ¥ç›´æ¥æ•æ‰æ•°æ®çš„ä¸ç¡®å®šæ€§ã€‚å®éªŒè¡¨æ˜ï¼Œåœ¨ä¸åŒçš„åä½œæ–¹æ¡ˆä¸­ï¼Œä¸ç¡®å®šæ€§ä¼°è®¡å¯ä»¥å‡å°‘ä¸ç¡®å®šæ€§å¹¶æé«˜å‡†ç¡®æ€§ã€‚</p><h3 id="FeaCo-2023-MM"><a href="#FeaCo-2023-MM" class="headerlink" title="FeaCo 2023 MM"></a>FeaCo 2023 MM</h3><p><img data-src="https://github.com/jmgu0212/FeaCo/raw/main/images/Overview.png" alt="FeaCo_Overview"></p><p>ä¸»è¦çœ‹å…¶ä¸­çš„èåˆæ¨¡å—</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240401134935564.png" alt="image-20240401134935564"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»£ç è¿˜æ˜¯å¾ˆé‡è¦çš„,è™½ç„¶å‘ç°æœ‰äº›ä»£ç åº“ä¸æ€ä¹ˆæ ·.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>transformer and attention(äºŒ):various attention modules</title>
    <link href="https://www.sekyoro.top/2024/01/23/transformer-and-attention-%E4%BA%8C-various-attention-modules/"/>
    <id>https://www.sekyoro.top/2024/01/23/transformer-and-attention-%E4%BA%8C-various-attention-modules/</id>
    <published>2024-01-23T12:18:17.000Z</published>
    <updated>2024-01-24T06:01:28.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä»‹ç»ç°åœ¨çš„å„ç§å„æ ·(ç©ºé—´ä¸Š,é€šé“ä¸Š)çš„attentionæ¨¡å—ä»¥åŠç›¸å…³ä»£ç .<br><span id="more"></span></p><h2 id="Squeeze-and-Excitation-Networks-2018"><a href="#Squeeze-and-Excitation-Networks-2018" class="headerlink" title="Squeeze-and-Excitation Networks 2018"></a>Squeeze-and-Excitation Networks 2018</h2><p><img data-src="https://s2.loli.net/2024/01/10/Lq6VRkQuoUpYSmc.png" alt="image-20240110094833740"></p><blockquote><ol><li>SENeté€šè¿‡å­¦ä¹ channelä¹‹é—´çš„ç›¸å…³æ€§ï¼Œç­›é€‰å‡ºäº†é’ˆå¯¹é€šé“çš„æ³¨æ„åŠ›ï¼Œç¨å¾®å¢åŠ äº†ä¸€ç‚¹è®¡ç®—é‡ï¼Œä½†æ˜¯æ•ˆæœæå‡è¾ƒæ˜æ˜¾</li><li>Squeeze-and-Excitation(SE) blockæ˜¯ä¸€ä¸ªå­ç»“æ„ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åµŒåˆ°å…¶ä»–åˆ†ç±»æˆ–æ£€æµ‹æ¨¡å‹ä¸­ã€‚</li><li>SENetçš„æ ¸å¿ƒæ€æƒ³åœ¨äºé€šè¿‡ç½‘ç»œæ ¹æ®losså»å­¦ä¹ feature mapçš„ç‰¹å¾æƒé‡æ¥ä½¿æ¨¡å‹è¾¾åˆ°æ›´å¥½çš„ç»“æœ</li><li>SEæ¨¡å—æœ¬è´¨ä¸Šæ˜¯ä¸€ç§attentionæœºåˆ¶</li></ol></blockquote><p><img data-src="https://s2.loli.net/2024/01/10/ZrhKeEALunoDxpF.png" alt="image-20240110095007870"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># implement SEAttention</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SEAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, channel=<span class="number">512</span>, reduction=<span class="number">16</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SEAttention, self).__init__()</span><br><span class="line">        self.avg_pool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">        self.fc = nn.Sequential(</span><br><span class="line">            nn.Linear(channel, channel // reduction),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(channel // reduction, channel),</span><br><span class="line">            nn.Sigmoid()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                init.kaiming_normal_(m.weight, mode=<span class="string">&#x27;fan_out&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                init.constant_(m.weight, <span class="number">1</span>)</span><br><span class="line">                init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">                init.normal_(m.weight, std=<span class="number">0.001</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        b, c, _, _ = x.size()</span><br><span class="line">        y = self.avg_pool(x).view(b, c)</span><br><span class="line">        y = self.fc(y).view(b, c, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x * y.expand_as(x)</span><br></pre></td></tr></table></figure><h2 id="Bottlenet-attention-Module-BAM-2018"><a href="#Bottlenet-attention-Module-BAM-2018" class="headerlink" title="Bottlenet attention Module (BAM) 2018"></a>Bottlenet attention Module (BAM) 2018</h2><p><img data-src="https://s2.loli.net/2024/01/23/7XzeCTDLwFEuiSM.png" alt="image-20240123200825093"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> init</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flatten</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, <span class="built_in">input</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">input</span>.view(<span class="built_in">input</span>.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChannelAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,channel,reduction:<span class="built_in">int</span>=<span class="number">16</span>,num_layer:<span class="built_in">int</span>=<span class="number">3</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.avg_pool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">        gate_channels = [channel]</span><br><span class="line">        gate_channels += [channel // reduction] * num_layer</span><br><span class="line">        gate_channels += [channel]</span><br><span class="line"></span><br><span class="line">        self.ca = nn.Sequential()</span><br><span class="line">        self.ca.add_module(<span class="string">&#x27;flatten&#x27;</span>,Flatten())</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_layer):</span><br><span class="line">            self.ca.add_module(<span class="string">&#x27;fc&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i),nn.Linear(gate_channels[i],gate_channels[i+<span class="number">1</span>]))</span><br><span class="line">            self.ca.add_module(<span class="string">&#x27;bn%d&#x27;</span> % i, nn.BatchNorm1d(gate_channels[i+<span class="number">1</span>]))</span><br><span class="line">            self.ca.add_module(<span class="string">&#x27;relu&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i),nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.ca.add_module(<span class="string">&#x27;last_fc&#x27;</span>,nn.Linear(gate_channels[-<span class="number">2</span>],gate_channels[-<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">        res = self.avg_pool(x)</span><br><span class="line">        res = self.ca(res)</span><br><span class="line">        <span class="keyword">return</span> res.unsqueeze(-<span class="number">1</span>).unsqueeze(-<span class="number">1</span>).expand_as(x)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpatialAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,channel,reduction=<span class="number">16</span>,num_layers=<span class="number">3</span>,dia_val=<span class="number">2</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.sa = nn.Sequential()</span><br><span class="line">        self.sa.add_module(<span class="string">&#x27;conv_reduce1&#x27;</span>,nn.Conv2d(in_channels=channel,out_channels=channel//reduction,kernel_size=<span class="number">1</span>))</span><br><span class="line">        self.sa.add_module(<span class="string">&#x27;bn_reduce1&#x27;</span>,nn.BatchNorm2d(channel//reduction))</span><br><span class="line">        self.sa.add_module(<span class="string">&#x27;relu_reduce1&#x27;</span>,nn.ReLU())</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_layers):</span><br><span class="line">            self.sa.add_module(<span class="string">&#x27;conv_%d&#x27;</span> % i,nn.Conv2d(in_channels=channel//reduction,out_channels=channel//reduction,kernel_size=<span class="number">3</span>,padding=<span class="number">1</span>,dilation=dia_val))</span><br><span class="line">            self.sa.add_module(<span class="string">&#x27;bn_%d&#x27;</span> % i,nn.BatchNorm2d(channel//reduction))</span><br><span class="line">            self.sa.add_module(<span class="string">&#x27;relu_%d&#x27;</span> % i,nn.ReLU())</span><br><span class="line">        self.sa.add_module(<span class="string">&#x27;conv_last&#x27;</span>,nn.Conv2d(in_channels=channel//reduction,out_channels=channel,kernel_size=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">        res = self.sa(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.expand_as(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BAMBlock</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,channel:<span class="built_in">int</span>=<span class="number">512</span>,reduction:<span class="built_in">int</span>=<span class="number">16</span>,dia_val:<span class="built_in">int</span>=<span class="number">2</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.ca = ChannelAttention(channel=channel,reduction=reduction)</span><br><span class="line">        self.sa = SpatialAttention(channel=channel,reduction=reduction,dia_val=dia_val)</span><br><span class="line">        self.sigmoid = nn.Sigmoid()</span><br><span class="line">        self.init_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">        b, c, _, _ = x.size()</span><br><span class="line">        sa_out = self.sa(x)</span><br><span class="line">        ca_out = self.ca(x)</span><br><span class="line">        weight = self.sigmoid(sa_out + ca_out)</span><br><span class="line">        out = (<span class="number">1</span> + weight) * x</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># initial weights for the model</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">&#x27;fan_in&#x27;</span>, nonlinearity=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m,nn.BatchNorm2d):</span><br><span class="line">                init.constant_(m.weight,<span class="number">1</span>)</span><br><span class="line">                init.constant_(m.bias,<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m,nn.Linear):</span><br><span class="line">                init.normal_(m.weight,std=<span class="number">0.001</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    init.constant_(m.bias,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/01/23/3PEUjp2y9aMLI8u.png" alt="image-20240123200842336"></p><h2 id="DANet-Dual-Attention-Network-2018"><a href="#DANet-Dual-Attention-Network-2018" class="headerlink" title="DANet: Dual Attention Network 2018"></a>DANet: Dual Attention Network 2018</h2><p><img data-src="https://s2.loli.net/2024/01/23/R9GMVDrs23ca7Qp.png" alt="image-20240123210612879"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositionAttentionModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,d_model=<span class="number">512</span>,kernel_size=<span class="number">3</span>,H=<span class="number">7</span>,W=<span class="number">7</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.cnn=nn.Conv2d(d_model,d_model,kernel_size=kernel_size,padding=(kernel_size-<span class="number">1</span>)//<span class="number">2</span>)</span><br><span class="line">        self.pa=ScaledDotProductAttention(d_model,d_k=d_model,d_v=d_model,h=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">        bs,c,h,w=x.shape</span><br><span class="line">        y=self.cnn(x)</span><br><span class="line">        y=y.view(bs,c,-<span class="number">1</span>).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>) <span class="comment">#bs,h*w,c</span></span><br><span class="line">        y=self.pa(y,y,y) <span class="comment">#bs,h*w,c</span></span><br><span class="line">        <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChannelAttentionModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,d_model=<span class="number">512</span>,kernel_size=<span class="number">3</span>,H=<span class="number">7</span>,W=<span class="number">7</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.cnn=nn.Conv2d(d_model,d_model,kernel_size=kernel_size,padding=(kernel_size-<span class="number">1</span>)//<span class="number">2</span>)</span><br><span class="line">        self.pa=SimplifiedScaledDotProductAttention(H*W,h=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,x</span>):</span></span><br><span class="line">        bs,c,h,w=x.shape</span><br><span class="line">        y=self.cnn(x)</span><br><span class="line">        y=y.view(bs,c,-<span class="number">1</span>) <span class="comment">#bs,c,h*w</span></span><br><span class="line">        y=self.pa(y,y,y) <span class="comment">#bs,c,h*w</span></span><br><span class="line">        <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DAModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,d_model=<span class="number">512</span>,kernel_size=<span class="number">3</span>,H=<span class="number">7</span>,W=<span class="number">7</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.position_attention_module=PositionAttentionModule(d_model=<span class="number">512</span>,kernel_size=<span class="number">3</span>,H=<span class="number">7</span>,W=<span class="number">7</span>)</span><br><span class="line">        self.channel_attention_module=ChannelAttentionModule(d_model=<span class="number">512</span>,kernel_size=<span class="number">3</span>,H=<span class="number">7</span>,W=<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self,<span class="built_in">input</span></span>):</span></span><br><span class="line">        bs,c,h,w=<span class="built_in">input</span>.shape</span><br><span class="line">        p_out=self.position_attention_module(<span class="built_in">input</span>)</span><br><span class="line">        c_out=self.channel_attention_module(<span class="built_in">input</span>)</span><br><span class="line">        p_out=p_out.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>).view(bs,c,h,w)</span><br><span class="line">        c_out=c_out.view(bs,c,h,w)</span><br><span class="line">        <span class="keyword">return</span> p_out+c_out</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CBAM-Convolutional-Block-Attention-Module-2018"><a href="#CBAM-Convolutional-Block-Attention-Module-2018" class="headerlink" title="CBAM: Convolutional Block Attention Module 2018"></a>CBAM: Convolutional Block Attention Module 2018</h2><p><img data-src="https://s2.loli.net/2024/01/10/uPRhgXEveC9JbFS.png" alt="image-20240110104503985"></p><p>é€šé“æ³¨æ„åŠ›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChannelAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_planes, ratio=<span class="number">16</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ChannelAttention, self).__init__()</span><br><span class="line">        self.avg_pool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">        self.max_pool = nn.AdaptiveMaxPool2d(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.fc1   = nn.Conv2d(in_planes, in_planes // <span class="number">16</span>, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.relu1 = nn.ReLU()</span><br><span class="line">        self.fc2   = nn.Conv2d(in_planes // <span class="number">16</span>, in_planes, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.sigmoid = nn.Sigmoid()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        avg_out = self.fc2(self.relu1(self.fc1(self.avg_pool(x))))</span><br><span class="line">        max_out = self.fc2(self.relu1(self.fc1(self.max_pool(x))))</span><br><span class="line">        out = avg_out + max_out</span><br><span class="line">        <span class="keyword">return</span> self.sigmoid(out)</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/01/10/wxDGep963Qzs5tq.png" alt="image-20240110104513785"></p><p>ç©ºé—´æ³¨æ„åŠ›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpatialAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, kernel_size=<span class="number">7</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SpatialAttention, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> kernel_size <span class="keyword">in</span> (<span class="number">3</span>, <span class="number">7</span>), <span class="string">&#x27;kernel size must be 3 or 7&#x27;</span></span><br><span class="line">        padding = <span class="number">3</span> <span class="keyword">if</span> kernel_size == <span class="number">7</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">2</span>, <span class="number">1</span>, kernel_size, padding=padding, bias=<span class="literal">False</span>)</span><br><span class="line">        self.sigmoid = nn.Sigmoid()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        avg_out = torch.mean(x, dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        max_out, _ = torch.<span class="built_in">max</span>(x, dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        x = torch.cat([avg_out, max_out], dim=<span class="number">1</span>)</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        <span class="keyword">return</span> self.sigmoid(x)</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/01/10/hyUFPErbDKB3TwI.png" alt="image-20240110104523806"></p><script type="math/tex; mode=display">\begin{aligned}\mathbf{F^{\prime}=M_c(F)\otimes F,}\\\mathbf{F^{\prime\prime}=M_s(F^{\prime})\otimes F^{\prime},}\end{aligned}</script><script type="math/tex; mode=display">\begin{gathered}\mathbf{M_{c}}(\mathbf{F}) =\sigma(MLP(AvgPool(\mathbf{F}))+MLP(MaxPool(\mathbf{F}))) \\=\sigma(\mathbf{W_1}(\mathbf{W_0}(\mathbf{F_{avg}^c}))+\mathbf{W_1}(\mathbf{W_0}(\mathbf{F_{max}^c}))), \end{gathered}</script><script type="math/tex; mode=display">\begin{aligned}\mathbf{M_{s}}(\mathbf{F})& =\sigma(f^{7\times7}([AvgPool(\mathbf{F});MaxPool(\mathbf{F})]))  \\&=\sigma(f^{7\times7}([\mathbf{F_{avg}^{s}};\mathbf{F_{max}^{s}}])),\end{aligned}</script><p><img data-src="https://s2.loli.net/2024/01/10/MQNWLjZP2yH8cwd.png" alt="image-20240110142553774"></p><h2 id="Non-Local-2018"><a href="#Non-Local-2018" class="headerlink" title="Non-Local 2018"></a>Non-Local 2018</h2><p><img data-src="https://s2.loli.net/2024/01/11/IW6cKRTQN178kp4.png" alt="image-20240111161108109"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonLocalNet</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, input_dim=<span class="number">64</span>, output_dim=<span class="number">64</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(NonLocalNet, self).__init__()</span><br><span class="line">        intermediate_dim = input_dim // <span class="number">2</span></span><br><span class="line">        self.to_q = nn.Conv2d(input_dim, intermediate_dim, <span class="number">1</span>)</span><br><span class="line">        self.to_k = nn.Conv2d(input_dim, intermediate_dim, <span class="number">1</span>)</span><br><span class="line">        self.to_v = nn.Conv2d(input_dim, intermediate_dim, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.conv = nn.Conv2d(intermediate_dim, output_dim, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        q = self.to_q(x).squeeze()</span><br><span class="line">        k = self.to_k(x).squeeze()</span><br><span class="line">        v = self.to_v(x).squeeze()</span><br><span class="line"></span><br><span class="line">        u = torch.bmm(q, k.transpose(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">        u = torch.softmax(u, dim=<span class="number">1</span>)</span><br><span class="line">        out = torch.bmm(u, v)</span><br><span class="line">        out = out.unsqueeze(<span class="number">2</span>)</span><br><span class="line">        out = self.conv(out)</span><br><span class="line">        <span class="keyword">return</span> out + x</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/01/19/9eNWHCpuiFsYLtU.png" alt="image-20240119110302126"></p><h2 id="SKNet-2019"><a href="#SKNet-2019" class="headerlink" title="SKNet 2019"></a>SKNet 2019</h2><p><img data-src="https://s2.loli.net/2024/01/23/ypZfsSKPBq9iLV6.png" alt="image-20240123192700386"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SKConv</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    https://arxiv.org/pdf/1903.06586.pdf</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, feature_dim, WH, M, G, r, stride=<span class="number">1</span>, L=<span class="number">32</span></span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot; Constructor</span></span><br><span class="line"><span class="string">         Args:</span></span><br><span class="line"><span class="string">             features: input channel dimensionality.</span></span><br><span class="line"><span class="string">             WH: input spatial dimensionality, used for GAP kernel size.</span></span><br><span class="line"><span class="string">             M: the number of branchs.</span></span><br><span class="line"><span class="string">             G: num of convolution groups.</span></span><br><span class="line"><span class="string">             r: the radio for compute d, the length of z.</span></span><br><span class="line"><span class="string">             stride: stride, default 1.</span></span><br><span class="line"><span class="string">             L: the minimum dim of the vector z in paper, default 32.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        d = <span class="built_in">max</span>(<span class="built_in">int</span>(feature_dim / r), L)</span><br><span class="line">        self.M = M</span><br><span class="line">        self.feature_dim = feature_dim</span><br><span class="line">        self.convs = nn.ModuleList()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line">            self.convs.append(nn.Sequential(</span><br><span class="line">                nn.Conv2d(feature_dim, feature_dim, kernel_size=<span class="number">3</span> + i * <span class="number">2</span>, stride=stride, padding=<span class="number">1</span> + i, groups=G),</span><br><span class="line">                nn.BatchNorm2d(feature_dim),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">False</span>)</span><br><span class="line">            ))</span><br><span class="line">        self.gap = nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.fc = nn.Linear(feature_dim, d)</span><br><span class="line">        self.fcs = nn.ModuleList()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line">            self.fcs.append(</span><br><span class="line">                nn.Linear(d, feature_dim)</span><br><span class="line">            )</span><br><span class="line">        self.softmax = nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i, conv <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.convs):</span><br><span class="line">            feat = conv(x).unsqueeze_(dim=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                feas = feat</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                feas = torch.cat((feas, feat), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        fea_U = torch.<span class="built_in">sum</span>(feas, dim=<span class="number">1</span>)</span><br><span class="line">        fea_s = self.gap(fea_U).squeeze_()</span><br><span class="line">        fea_z = self.fc(fea_s)</span><br><span class="line">        <span class="keyword">for</span> i, fc <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.fcs):</span><br><span class="line">            vector = fc(fea_z).unsqueeze_(dim=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                attention_vectors = vector</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                attention_vectors = torch.cat((attention_vectors, vector), dim=<span class="number">1</span>)</span><br><span class="line">        attention_vectors = self.softmax(attention_vectors)</span><br><span class="line">        attention_vectors = attention_vectors.unsqueeze(-<span class="number">1</span>).unsqueeze(-<span class="number">1</span>)</span><br><span class="line">        fea_v = (feas*attention_vectors).<span class="built_in">sum</span>(dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> fea_v</span><br></pre></td></tr></table></figure><h2 id="CC-Netå’ŒAxial-Attention"><a href="#CC-Netå’ŒAxial-Attention" class="headerlink" title="CC-Netå’ŒAxial Attention"></a>CC-Netå’ŒAxial Attention</h2><p>çœ‹è®ºæ–‡æ—¶æåˆ°äº†CC-Netä½¿ç”¨äº†äº¤å‰æ³¨æ„äº†.</p><p>å‚è€ƒ<a href="https://www.codenong.com/cs106760382/">Axial Attention å’Œ Criss-Cross AttentionåŠå…¶ä»£ç å®ç° | ç å†œå®¶å›­ (codenong.com)</a>è¿™ç¯‡blog,å†™çš„ä¸é”™.</p><h2 id="Axial-Attention"><a href="#Axial-Attention" class="headerlink" title="Axial Attention"></a>Axial Attention</h2><p>è½´å‘æ³¨æ„åŠ›,Axial Attention çš„æ„Ÿå—é‡æ˜¯ç›®æ ‡åƒç´ çš„åŒä¸€è¡Œ(æˆ–è€…åŒä¸€åˆ—) çš„W(æˆ–H)ä¸ªåƒç´ </p><p>æ¯”å¦‚row attention</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®ç°è½´å‘æ³¨æ„åŠ›ä¸­çš„ row Attention</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> Softmax</span><br><span class="line"></span><br><span class="line"><span class="comment"># device = torch.device(&#x27;cuda:0&#x27; if torch.cuda.is_available() else &#x27;cpu&#x27;)</span></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.device_count() &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RowAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_dim, q_k_dim, device</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        in_dim : int</span></span><br><span class="line"><span class="string">            channel of input img tensor</span></span><br><span class="line"><span class="string">        q_k_dim: int</span></span><br><span class="line"><span class="string">            channel of Q, K vector</span></span><br><span class="line"><span class="string">        device : torch.device</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">super</span>(RowAttention, self).__init__()</span><br><span class="line">        self.in_dim = in_dim</span><br><span class="line">        self.q_k_dim = q_k_dim</span><br><span class="line">        self.device = device</span><br><span class="line">        </span><br><span class="line">        self.query_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.q_k_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.key_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.q_k_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.value_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.in_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.softmax = Softmax(dim=<span class="number">2</span>)</span><br><span class="line">        self.gamma = nn.Parameter(torch.zeros(<span class="number">1</span>)).to(self.device)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        x : Tensor</span></span><br><span class="line"><span class="string">            4-D , (batch, in_dims, height, width) -- (b,c1,h,w)</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">## c1 = in_dims; c2 = q_k_dim</span></span><br><span class="line">        b, _, h, w = x.size()</span><br><span class="line">        </span><br><span class="line">        Q = self.query_conv(x) <span class="comment">#size = (b,c2, h,w)</span></span><br><span class="line">        K = self.key_conv(x)   <span class="comment">#size = (b, c2, h, w)</span></span><br><span class="line">        V = self.value_conv(x) <span class="comment">#size = (b, c1,h,w)</span></span><br><span class="line">        </span><br><span class="line">        Q = Q.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(b*h, -<span class="number">1</span>,w).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>) <span class="comment">#size = (b*h,w,c2)</span></span><br><span class="line">        K = K.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(b*h, -<span class="number">1</span>,w)  <span class="comment">#size = (b*h,c2,w)</span></span><br><span class="line">        V = V.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(b*h, -<span class="number">1</span>,w)  <span class="comment">#size = (b*h, c1,w)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#size = (b*h,w,w) [:,i,j] è¡¨ç¤ºQçš„æ‰€æœ‰hçš„ç¬¬ Wiè¡Œä½ç½®ä¸Šæ‰€æœ‰é€šé“å€¼ä¸ Kçš„æ‰€æœ‰hçš„ç¬¬ Wjåˆ—ä½ç½®ä¸Šçš„æ‰€æœ‰é€šé“å€¼çš„ä¹˜ç§¯ï¼Œ</span></span><br><span class="line">        <span class="comment"># å³(1,c2) * (c2,1) = (1,1)</span></span><br><span class="line">        row_attn = torch.bmm(Q,K) </span><br><span class="line">        <span class="comment">########</span></span><br><span class="line">        <span class="comment">#æ­¤æ—¶çš„ row_attençš„[:,i,0:w] è¡¨ç¤ºQçš„æ‰€æœ‰hçš„ç¬¬ Wiè¡Œä½ç½®ä¸Šæ‰€æœ‰é€šé“å€¼ä¸ Kçš„æ‰€æœ‰è¡Œçš„ æ‰€æœ‰åˆ—(0:w)çš„é€ä¸ªä½ç½®ä¸Šçš„æ‰€æœ‰é€šé“å€¼çš„ä¹˜ç§¯</span></span><br><span class="line">        <span class="comment">#æ­¤æ“ä½œå³ä¸º Qçš„æŸä¸ªï¼ˆi,jï¼‰ä¸ Kçš„ï¼ˆi,0:wï¼‰é€ä¸ªä½ç½®çš„å€¼çš„ä¹˜ç§¯ï¼Œå¾—åˆ°è¡Œattn</span></span><br><span class="line">        <span class="comment">########</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#å¯¹row_attnè¿›è¡Œsoftmax</span></span><br><span class="line">        row_attn = self.softmax(row_attn) <span class="comment">#å¯¹åˆ—è¿›è¡Œsoftmaxï¼Œå³[k,i,0:w] ï¼ŒæŸä¸€è¡Œçš„æ‰€æœ‰åˆ—åŠ èµ·æ¥ç­‰äº1ï¼Œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#size = (b*h,c1,w) è¿™é‡Œå…ˆéœ€è¦å¯¹row_attenè¿›è¡Œ è¡Œåˆ—ç½®æ¢ï¼Œä½¿å¾—æŸä¸€åˆ—çš„æ‰€æœ‰è¡ŒåŠ èµ·æ¥ç­‰äº1</span></span><br><span class="line">        <span class="comment">#[:,i,j]å³ä¸ºVçš„æ‰€æœ‰è¡Œçš„æŸä¸ªé€šé“ä¸Šï¼Œæ‰€æœ‰åˆ—çš„å€¼ ä¸ row_attnçš„è¡Œçš„ä¹˜ç§¯ï¼Œå³æ±‚æƒé‡å’Œ</span></span><br><span class="line">        out = torch.bmm(V,row_attn.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>)) </span><br><span class="line">        <span class="comment">#size = (b,c1,h,2)</span></span><br><span class="line">        out = out.view(b,h,-<span class="number">1</span>,w).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>)  </span><br><span class="line">        out = self.gamma*out + x </span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"><span class="comment">#å®ç°è½´å‘æ³¨æ„åŠ›ä¸­çš„ cols Attention</span></span><br><span class="line">x = torch.randn(<span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">20</span>).to(device)</span><br><span class="line">row_attn = RowAttention(in_dim = <span class="number">8</span>, q_k_dim = <span class="number">4</span>,device = device).to(device)</span><br><span class="line"><span class="built_in">print</span>(row_attn(x).size())</span><br></pre></td></tr></table></figure><p>åˆ—æ³¨æ„åŠ›åŒç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®ç°è½´å‘æ³¨æ„åŠ›ä¸­çš„ column Attention</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> Softmax</span><br><span class="line"></span><br><span class="line"><span class="comment"># device = torch.device(&#x27;cuda:0&#x27; if torch.cuda.is_available() else &#x27;cpu&#x27;)</span></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.device_count() &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_dim, q_k_dim, device</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        in_dim : int</span></span><br><span class="line"><span class="string">            channel of input img tensor</span></span><br><span class="line"><span class="string">        q_k_dim: int</span></span><br><span class="line"><span class="string">            channel of Q, K vector</span></span><br><span class="line"><span class="string">        device : torch.device</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">super</span>(ColAttention, self).__init__()</span><br><span class="line">        self.in_dim = in_dim</span><br><span class="line">        self.q_k_dim = q_k_dim</span><br><span class="line">        self.device = device</span><br><span class="line">        </span><br><span class="line">        self.query_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.q_k_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.key_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.q_k_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.value_conv = nn.Conv2d(in_channels=in_dim, out_channels = self.in_dim, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.softmax = Softmax(dim=<span class="number">2</span>)</span><br><span class="line">        self.gamma = nn.Parameter(torch.zeros(<span class="number">1</span>)).to(self.device)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Parameters</span></span><br><span class="line"><span class="string">        ----------</span></span><br><span class="line"><span class="string">        x : Tensor</span></span><br><span class="line"><span class="string">            4-D , (batch, in_dims, height, width) -- (b,c1,h,w)</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">## c1 = in_dims; c2 = q_k_dim</span></span><br><span class="line">        b, _, h, w = x.size()</span><br><span class="line">        </span><br><span class="line">        Q = self.query_conv(x) <span class="comment">#size = (b,c2, h,w)</span></span><br><span class="line">        K = self.key_conv(x)   <span class="comment">#size = (b, c2, h, w)</span></span><br><span class="line">        V = self.value_conv(x) <span class="comment">#size = (b, c1,h,w)</span></span><br><span class="line">        </span><br><span class="line">        Q = Q.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(b*w, -<span class="number">1</span>,h).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>) <span class="comment">#size = (b*w,h,c2)</span></span><br><span class="line">        K = K.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(b*w, -<span class="number">1</span>,h)  <span class="comment">#size = (b*w,c2,h)</span></span><br><span class="line">        V = V.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(b*w, -<span class="number">1</span>,h)  <span class="comment">#size = (b*w,c1,h)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#size = (b*w,h,h) [:,i,j] è¡¨ç¤ºQçš„æ‰€æœ‰Wçš„ç¬¬ Hiè¡Œä½ç½®ä¸Šæ‰€æœ‰é€šé“å€¼ä¸ Kçš„æ‰€æœ‰Wçš„ç¬¬ Hjåˆ—ä½ç½®ä¸Šçš„æ‰€æœ‰é€šé“å€¼çš„ä¹˜ç§¯ï¼Œ</span></span><br><span class="line">        <span class="comment"># å³(1,c2) * (c2,1) = (1,1)</span></span><br><span class="line">        col_attn = torch.bmm(Q,K) </span><br><span class="line">        <span class="comment">########</span></span><br><span class="line">        <span class="comment">#æ­¤æ—¶çš„ col_attençš„[:,i,0:w] è¡¨ç¤ºQçš„æ‰€æœ‰Wçš„ç¬¬ Hiè¡Œä½ç½®ä¸Šæ‰€æœ‰é€šé“å€¼ä¸ Kçš„æ‰€æœ‰Wçš„ æ‰€æœ‰åˆ—(0:h)çš„é€ä¸ªä½ç½®ä¸Šçš„æ‰€æœ‰é€šé“å€¼çš„ä¹˜ç§¯</span></span><br><span class="line">        <span class="comment">#æ­¤æ“ä½œå³ä¸º Qçš„æŸä¸ªï¼ˆi,jï¼‰ä¸ Kçš„ï¼ˆi,0:hï¼‰é€ä¸ªä½ç½®çš„å€¼çš„ä¹˜ç§¯ï¼Œå¾—åˆ°åˆ—attn</span></span><br><span class="line">        <span class="comment">########</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#å¯¹row_attnè¿›è¡Œsoftmax</span></span><br><span class="line">        col_attn = self.softmax(col_attn) <span class="comment">#å¯¹åˆ—è¿›è¡Œsoftmaxï¼Œå³[k,i,0:w] ï¼ŒæŸä¸€è¡Œçš„æ‰€æœ‰åˆ—åŠ èµ·æ¥ç­‰äº1ï¼Œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#size = (b*w,c1,h) è¿™é‡Œå…ˆéœ€è¦å¯¹col_attenè¿›è¡Œ è¡Œåˆ—ç½®æ¢ï¼Œä½¿å¾—æŸä¸€åˆ—çš„æ‰€æœ‰è¡ŒåŠ èµ·æ¥ç­‰äº1</span></span><br><span class="line">        <span class="comment">#[:,i,j]å³ä¸ºVçš„æ‰€æœ‰è¡Œçš„æŸä¸ªé€šé“ä¸Šï¼Œæ‰€æœ‰åˆ—çš„å€¼ ä¸ col_attnçš„è¡Œçš„ä¹˜ç§¯ï¼Œå³æ±‚æƒé‡å’Œ</span></span><br><span class="line">        out = torch.bmm(V,col_attn.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>)) </span><br><span class="line">        </span><br><span class="line">        <span class="comment">#size = (b,c1,h,w)</span></span><br><span class="line">        out = out.view(b,w,-<span class="number">1</span>,h).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        out = self.gamma*out + x </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    </span><br><span class="line"><span class="comment">#å®ç°è½´å‘æ³¨æ„åŠ›ä¸­çš„ cols Attention</span></span><br><span class="line">x = torch.randn(<span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">20</span>).to(device)</span><br><span class="line">col_attn = ColAttention(<span class="number">8</span>, <span class="number">4</span>, device = device)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(col_attn(x).size())</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Criss-Cross-Attention-Module-2019"><a href="#Criss-Cross-Attention-Module-2019" class="headerlink" title="Criss-Cross Attention Module 2019"></a>Criss-Cross Attention Module 2019</h2><p><img data-src="https://pic4.zhimg.com/80/v2-322dae3099e1ed29c2751c7c7efd88b7_720w.webp" alt="img"></p><p>CC-Attention çš„æ„Ÿå—é‡æ˜¯ä¸ç›®æ ‡åƒç´ çš„åŒä¸€è¡Œå’ŒåŒä¸€åˆ—çš„(H + W - 1)ä¸ªåƒç´ ,ç›®æ ‡å…ƒç´ çš„åŒä¸€è¡Œå’ŒåŒä¸€åˆ—.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CrissCrossAttention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Criss-Cross Attention Module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    reference: https://github.com/speedinghzl/CCNet</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_dim</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(CrissCrossAttention,self).__init__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.query_conv = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels=in_dim, out_channels=in_dim, kernel_size=<span class="number">1</span>),</span><br><span class="line">                nn.BatchNorm2d(in_dim,eps=<span class="number">1e-5</span>, momentum=<span class="number">0.01</span>, affine=<span class="literal">True</span>),</span><br><span class="line">                nn.ReLU()</span><br><span class="line">            )</span><br><span class="line">        self.key_conv = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels=in_dim, out_channels=in_dim, kernel_size=<span class="number">1</span>),</span><br><span class="line">                nn.BatchNorm2d(in_dim,eps=<span class="number">1e-5</span>, momentum=<span class="number">0.01</span>, affine=<span class="literal">True</span>),</span><br><span class="line">                nn.ReLU()</span><br><span class="line">            )</span><br><span class="line">        self.value_conv = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels=in_dim, out_channels=in_dim, kernel_size=<span class="number">1</span>),</span><br><span class="line">                nn.BatchNorm2d(in_dim,eps=<span class="number">1e-5</span>, momentum=<span class="number">0.01</span>, affine=<span class="literal">True</span>),</span><br><span class="line">                nn.ReLU()</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.softmax = Softmax(dim=<span class="number">3</span>)</span><br><span class="line">        self.INF = INF</span><br><span class="line">        self.gamma = nn.Parameter(torch.zeros(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, query, key, value</span>):</span></span><br><span class="line">        m_batchsize, _, height, width = query.size()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        proj_query = self.query_conv(query)</span><br><span class="line">        proj_query_H = proj_query.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(m_batchsize*width,-<span class="number">1</span>,height).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        proj_query_W = proj_query.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(m_batchsize*height,-<span class="number">1</span>,width).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        proj_key = self.key_conv(key)</span><br><span class="line">        proj_key_H = proj_key.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(m_batchsize*width,-<span class="number">1</span>,height)</span><br><span class="line">        proj_key_W = proj_key.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(m_batchsize*height,-<span class="number">1</span>,width)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        proj_value = self.value_conv(value)</span><br><span class="line">        proj_value_H = proj_value.permute(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>).contiguous().view(m_batchsize*width,-<span class="number">1</span>,height)</span><br><span class="line">        proj_value_W = proj_value.permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(m_batchsize*height,-<span class="number">1</span>,width)</span><br><span class="line">        energy_H = (torch.bmm(proj_query_H, proj_key_H)+self.INF(m_batchsize, height, width)).view(m_batchsize,width,height,height).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">        energy_W = torch.bmm(proj_query_W, proj_key_W).view(m_batchsize,height,width,width)</span><br><span class="line">        concate = self.softmax(torch.cat([energy_H, energy_W], <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">        att_H = concate[:,:,:,<span class="number">0</span>:height].permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).contiguous().view(m_batchsize*width,height,height)</span><br><span class="line">        att_W = concate[:,:,:,height:height+width].contiguous().view(m_batchsize*height,width,width)</span><br><span class="line">        out_H = torch.bmm(proj_value_H, att_H.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)).view(m_batchsize,width,-<span class="number">1</span>,height).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">        out_W = torch.bmm(proj_value_W, att_W.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)).view(m_batchsize,height,-<span class="number">1</span>,width).permute(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> self.gamma*(out_H + out_W) + value</span><br></pre></td></tr></table></figure><p><img data-src="https://pic4.zhimg.com/80/v2-03942c1de5a5a77aafbdb1a1fe697fb3_720w.webp" alt="img"></p><h2 id="Coordinate-Attention-2021"><a href="#Coordinate-Attention-2021" class="headerlink" title="Coordinate Attention 2021"></a>Coordinate Attention 2021</h2><p><img data-src="https://s2.loli.net/2024/01/19/ZrmAMkChLcbFpfg.png" alt="image-20240119195945841"></p><p>åœ¨é€šé“æ³¨æ„åŠ›çš„åŸºç¡€ä¸Šå…¼é¡¾å…¶ä½ç½®å…³ç³»ï¼Œå°†é€šé“æ³¨æ„åŠ›ä¸ç©ºé—´æ³¨æ„åŠ›è”åˆèµ·æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">h_sigmoid</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, inplace=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(h_sigmoid, self).__init__()</span><br><span class="line">        self.relu = nn.ReLU6(inplace=inplace)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.relu(x + <span class="number">3</span>) / <span class="number">6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">h_swish</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, inplace=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(h_swish, self).__init__()</span><br><span class="line">        self.sigmoid = h_sigmoid(inplace=inplace)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x * self.sigmoid(</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CA</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, inp, reduction</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(CA, self).__init__()</span><br><span class="line">        <span class="comment"># h:height(è¡Œ)   w:width(åˆ—)</span></span><br><span class="line">        self.pool_h = nn.AdaptiveAvgPool2d((<span class="literal">None</span>, <span class="number">1</span>))  <span class="comment"># (b,c,h,w)--&gt;(b,c,h,1)</span></span><br><span class="line">        self.pool_w = nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="literal">None</span>))  <span class="comment"># (b,c,h,w)--&gt;(b,c,1,w)</span></span><br><span class="line"></span><br><span class="line">         <span class="comment"># mip = max(8, inp // reduction)  è®ºæ–‡ä½œè€…æ‰€ç”¨</span></span><br><span class="line">        mip =  inp // reduction  </span><br><span class="line"> </span><br><span class="line">        self.conv1 = nn.Conv2d(inp, mip, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(mip)</span><br><span class="line">        self.act = h_swish()</span><br><span class="line"> </span><br><span class="line">        self.conv_h = nn.Conv2d(mip, inp, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.conv_w = nn.Conv2d(mip, inp, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        identity = x</span><br><span class="line"> </span><br><span class="line">        n, c, h, w = x.size()</span><br><span class="line">        x_h = self.pool_h(x)  <span class="comment"># (b,c,h,1)</span></span><br><span class="line">        x_w = self.pool_w(x).permute(<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)  <span class="comment"># (b,c,w,1)</span></span><br><span class="line"> </span><br><span class="line">        y = torch.cat([x_h, x_w], dim=<span class="number">2</span>)</span><br><span class="line">        y = self.conv1(y)</span><br><span class="line">        y = self.bn1(y)</span><br><span class="line">        y = self.act(y)</span><br><span class="line"> </span><br><span class="line">        x_h, x_w = torch.split(y, [h, w], dim=<span class="number">2</span>)</span><br><span class="line">        x_w = x_w.permute(<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line">        a_h = self.conv_h(x_h).sigmoid()</span><br><span class="line">        a_w = self.conv_w(x_w).sigmoid()</span><br><span class="line"> </span><br><span class="line">        out = identity * a_w * a_h</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure><h2 id="Attentional-Feature-Fusion-2021"><a href="#Attentional-Feature-Fusion-2021" class="headerlink" title="Attentional Feature Fusion  2021"></a>Attentional Feature Fusion  2021</h2><p><a href="https://openaccess.thecvf.com/content/WACV2021/html/Dai_Attentional_Feature_Fusion_WACV_2021_paper.html">WACV 2021 Open Access Repository (thecvf.com)</a></p><p><a href="https://github.com/YimianDai/open-aff">YimianDai/open-aff: code and trained models for â€œAttentional Feature Fusionâ€ (github.com)</a></p><p>è¿™äº›æ³¨æ„åŠ›æ¨¡å—é€šå¸¸ç”¨åœ¨ä¸€äº›block(æˆ–å«unit)å—ä¸­,ç„¶åä¸€èˆ¬æŠŠè¿™äº›å—æ”¾åˆ°å¤šå°ºåº¦çš„ç½‘ç»œä¸‹</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://blog.csdn.net/weixin_43718675/article/details/106760382">Axial Attention å’Œ Criss-Cross AttentionåŠå…¶ä»£ç å®ç°_cross attentionä»£ç -CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/qwedsaewq/article/details/89052643">skneté˜…è¯»ç¬”è®°åŠpytorchå®ç°ä»£ç _pytorch sknet-CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/weixin_43427721/article/details/124652525?ops_request_misc=%7B%22request%5Fid%22%3A%22170601489116800226596213%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fblog.%22%7D&amp;request_id=170601489116800226596213&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-124652525-null-null.nonecase&amp;utm_term=æ³¨æ„åŠ›&amp;spm=1018.2226.3001.4450">ã€æ³¨æ„åŠ›æœºåˆ¶é›†é”¦ã€‘Channel Attentioné€šé“æ³¨æ„åŠ›ç½‘ç»œç»“æ„ã€æºç è§£è¯»ç³»åˆ—ä¸€_é€šé“æ³¨æ„åŠ›æœºåˆ¶ç»“æ„å›¾-CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/weixin_43427721/article/details/124766242">ã€æ³¨æ„åŠ›æœºåˆ¶é›†é”¦2ã€‘BAM&amp;SGE&amp;DANåŸæ–‡ã€ç»“æ„ã€æºç è¯¦è§£_bamæ³¨æ„åŠ›æœºåˆ¶-CSDNåšå®¢</a></li></ol><p>Thanks to <a href="https://github.com/lyp2333/External-Attention-pytorch/tree/master">lyp2333/External-Attention-pytorch (github.com)</a> and <a href="https://github.com/xmu-xiaoma666/External-Attention-pytorch">xmu-xiaoma666/External-Attention-pytorch: ğŸ€ Pytorch implementation of various Attention Mechanisms, MLP, Re-parameter, Convolution, which is helpful to further understand papers.â­â­â­ (github.com)</a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»‹ç»ç°åœ¨çš„å„ç§å„æ ·(ç©ºé—´ä¸Š,é€šé“ä¸Š)çš„attentionæ¨¡å—ä»¥åŠç›¸å…³ä»£ç .&lt;br&gt;</summary>
    
    
    
    <category term="deep learning" scheme="https://www.sekyoro.top/categories/deep-learning/"/>
    
    
    <category term="deep learning" scheme="https://www.sekyoro.top/tags/deep-learning/"/>
    
  </entry>
  
  <entry>
    <title>Golangå­¦ä¹ :ä½¿ç”¨Gin</title>
    <link href="https://www.sekyoro.top/2024/01/17/Golang%E5%AD%A6%E4%B9%A0-%E4%BD%BF%E7%94%A8Gin/"/>
    <id>https://www.sekyoro.top/2024/01/17/Golang%E5%AD%A6%E4%B9%A0-%E4%BD%BF%E7%94%A8Gin/</id>
    <published>2024-01-17T10:17:45.000Z</published>
    <updated>2024-01-17T10:46:30.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Goè¯­è¨€simpleå¹¶ä¸”easy,å†…ç½®äº†å¾ˆå¤šæœ‰ç”¨çš„åº“,å¯¹å¹¶å‘æ”¯æŒæ¯”è¾ƒå¥½å¹¶ä¸”å®˜æ–¹(æŒ‡Google)è¿˜æ˜¯æ¯”è¾ƒé‡è§†çš„.<br><span id="more"></span><br>Goçš„å®˜æ–¹èµ„æ–™å°±æ¯”è¾ƒå¥½å­¦ä¹ <a href="https://go.dev/">The Go Programming Language</a>,æœ‰ä¸ªtutorialè¿˜æœ‰ä¸ªexamples.å†™äº†ä¸ªä½¿ç”¨Collyç”¨æ¥çˆ¬å–å›¾ç‰‡å’ŒGinç”¨æ¥æ˜¾ç¤ºå›¾ç‰‡çš„ä»£ç .</p><p>ç›®å½•ç»“æ„æ¯”è¾ƒç®€å•</p><p><img data-src="https://s2.loli.net/2024/01/17/xMBdCzhvfZEgVAT.png" alt="image-20240117183718713"></p><p>ä½¿ç”¨Goçš„modè¿›è¡Œé…ç½®é¡¹ç›®,æ¯”å¦‚<code>go mod init &lt;project name&gt;</code>åˆå§‹åŒ–</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;sekyoro.top/Goimg/routes&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := gin.Default()</span><br><span class="line">r := router.Group(<span class="string">&quot;/api&quot;</span>)</span><br><span class="line">router.Static(<span class="string">&quot;/img&quot;</span>, <span class="string">&quot;./imgs&quot;</span>)</span><br><span class="line">routes.DownloadPicRoutes(r)</span><br><span class="line">routes.ShowPicRoutes(r)</span><br><span class="line">routes.GetPicRoutes(r</span><br><span class="line">router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè®¾ç½®äº†é™æ€èµ„æºå¹¶ä½¿ç”¨åˆ†ç»„è·¯ç”±æ„å»ºè·¯ç”±åˆ°å¤„ç†çš„æ–¹æ³•.</p><p>åœ¨routesæ–‡ä»¶å¤¹ä¸‹å°±æœ‰å¯¹åº”çš„è·¯ç”±,æ¯”å¦‚åœ¨ä¸‹è½½æ–‡ä»¶ä¸‹,è®¾ç½®äº†ä¸¤ä¸ªè·¯ç”±.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> routes</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;sekyoro.top/Goimg/handlers&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DownloadPicRoutes</span><span class="params">(router *gin.RouterGroup)</span></span> &#123;</span><br><span class="line">router.GET(<span class="string">&quot;/pix&quot;</span>, handlers.DownloadPixvisionPicHandler)</span><br><span class="line">router.GET(<span class="string">&quot;/booru/:type&quot;</span>, handlers.DownloadBooruPicHandler)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨downloaderç›®å½•ä¸‹å†™è¿›è¡Œå¤„ç†çš„æ–¹æ³•.æ¯”å¦‚ä¸‹é¢æ˜¯<code>DownloadPixvisionPicHandler.go</code>å»çˆ¬å–å›¾ç‰‡å¹¶ä¿å­˜åˆ°æœ¬åœ°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handlers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gocolly/colly/v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DownloadPixvisionPicHandler</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">counter  := <span class="number">0</span></span><br><span class="line">allow_img_site := checkAllowSite()</span><br><span class="line"><span class="comment">// fmt.Println(allow_img_site)</span></span><br><span class="line">c := colly.NewCollector(colly.UserAgent(userAgent), colly.AllowedDomains(allow_img_site...),</span><br><span class="line">colly.Async())</span><br><span class="line">c.SetRequestTimeout(<span class="number">20</span> * time.Second)</span><br><span class="line"></span><br><span class="line">c.Limit(&amp;colly.LimitRule&#123;</span><br><span class="line">DomainGlob:  <span class="string">&quot;*pximg.*&quot;</span>,</span><br><span class="line">Parallelism: <span class="number">5</span>,</span><br><span class="line"><span class="comment">//Delay:      5 * time.Second,</span></span><br><span class="line">RandomDelay: <span class="number">500</span> * time.Duration(time.Millisecond),</span><br><span class="line">&#125;)</span><br><span class="line">c.Limit(&amp;colly.LimitRule&#123;</span><br><span class="line">DomainGlob:  <span class="string">&quot;*pixivision.*&quot;</span>,</span><br><span class="line">Parallelism: <span class="number">5</span>,</span><br><span class="line">Delay:       <span class="number">200</span> * time.Duration(time.Millisecond),</span><br><span class="line">RandomDelay: <span class="number">500</span> * time.Duration(time.Millisecond),</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> proxy != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> proxy[<span class="string">&quot;http&quot;</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">err := c.SetProxy(fmt.Sprintf(<span class="string">&quot;http://%s&quot;</span>, proxy[<span class="string">&quot;http&quot;</span>].(<span class="keyword">string</span>)))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Panic(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> proxy[<span class="string">&quot;socks5&quot;</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">err := c.SetProxy(fmt.Sprintf(<span class="string">&quot;socks5://%s&quot;</span>, proxy[<span class="string">&quot;socks5&quot;</span>].(<span class="keyword">string</span>)))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Panic(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">limit_page, ok := conf[<span class="string">&quot;limit_page&quot;</span>].(<span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">log.Panic(<span class="string">&quot;çˆ¬å–å›¾ç‰‡ç›®å½•æ•°é…ç½®å‡ºé”™&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">log.Panic(<span class="string">&quot;ä¸‹è½½è·¯å¾„é…ç½®å‡ºé”™&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find and visit all links</span></span><br><span class="line">c.OnHTML(<span class="string">&quot;a[href]&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(e *colly.HTMLElement)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> e.DOM.Parent().HasClass(<span class="string">&quot;arc__title&quot;</span>) &#123;</span><br><span class="line">log.Default().Println(<span class="string">&quot;Link found:&quot;</span>, e.Attr(<span class="string">&quot;href&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> counter &gt;= limit_page &#123;</span><br><span class="line">ctx.JSON(http.StatusOK, fmt.Sprintf(<span class="string">&quot;success! %d directory image&quot;</span>, limit_page))</span><br><span class="line">&#125;</span><br><span class="line">e.Request.Visit(e.Attr(<span class="string">&quot;href&quot;</span>))</span><br><span class="line">counter += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">c.OnHTML(<span class="string">&quot;div[class=&#x27;_article-main&#x27;]&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(e *colly.HTMLElement)</span></span> &#123;</span><br><span class="line">title := e.ChildText(<span class="string">&quot;h1[class=&#x27;am__title&#x27;]&quot;</span>)</span><br><span class="line"><span class="comment">// log.Default().Println(&quot;title:&quot;, title)</span></span><br><span class="line"><span class="comment">// p := Pics&#123;title: title, pics: make(map[string]string)&#125;</span></span><br><span class="line">err := os.MkdirAll(filepath.Join(download_root_folder, title), os.ModePerm)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Default().Println(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">e.ForEach(<span class="string">&quot;div.article-item:not(._feature-article-body__paragraph) div.am__work__main&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, h *colly.HTMLElement)</span></span> &#123;</span><br><span class="line">log.Default().Println(<span class="string">&quot;pic:&quot;</span>, h.ChildAttr(<span class="string">&quot;img&quot;</span>, <span class="string">&quot;src&quot;</span>))</span><br><span class="line">img_src := h.ChildAttr(<span class="string">&quot;img&quot;</span>, <span class="string">&quot;src&quot;</span>)</span><br><span class="line">h.Request.Visit(img_src)</span><br><span class="line">h.Request.Ctx.Put(<span class="string">&quot;title&quot;</span>, title)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">c.OnResponse(<span class="function"><span class="keyword">func</span><span class="params">(r *colly.Response)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> img_url URL_path = url_path(r.Request.URL.Path)</span><br><span class="line"><span class="comment">// log.Default().Println(&quot;img_name:&quot;, img_name)</span></span><br><span class="line"><span class="keyword">if</span> img_url.isPic() &#123;</span><br><span class="line">img_path := filepath.Join(download_root_folder,r.Ctx.Get(<span class="string">&quot;title&quot;</span>), <span class="keyword">string</span>(img_url.(url_path)))</span><br><span class="line">r.Save(img_path)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">c.OnRequest(<span class="function"><span class="keyword">func</span><span class="params">(r *colly.Request)</span></span> &#123;</span><br><span class="line">log.Default().Println(<span class="string">&quot;Visiting&quot;</span>, r.URL)</span><br><span class="line"><span class="keyword">if</span> r.URL.Host == <span class="string">&quot;i.pximg.net&quot;</span> &#123;</span><br><span class="line">r.Headers.Set(<span class="string">&quot;Referer&quot;</span>, <span class="string">&quot;https://www.pixivision.net/&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">c.OnError(<span class="function"><span class="keyword">func</span><span class="params">(r *colly.Response, err error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">log.Default().Println(<span class="string">&quot;Request URL:&quot;</span>, r.Request.URL, <span class="string">&quot;failed with response:&quot;</span>, <span class="keyword">string</span>(r.Body), <span class="string">&quot;\nError:&quot;</span>, err.Error())</span><br><span class="line">&#125;)</span><br><span class="line">c.Visit(pixivision_site)</span><br><span class="line">c.Wait()</span><br><span class="line">ctx.JSON(http.StatusOK, fmt.Sprintf(<span class="string">&quot;success! %d directory image&quot;</span>, limit_page))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨<code>configure.yaml</code>ä¸­è¿›è¡Œé…ç½®ç›¸å…³ä¿¡æ¯.</p><p>æœ€åéƒ¨ç½²å¯ä»¥è€ƒè™‘ä½¿ç”¨render<a href="https://render.com/">Cloud Application Hosting for Developers | Render</a>,æ¥ç©ç©å§<a href="https://go-img.onrender.com/api/show">https://go-img.onrender.com/api/show</a></p><p>å®Œæ•´ä»£ç å¯ä»¥åœ¨æˆ‘çš„github<a href="https://github.com/drowning-in-codes/myGo">drowning-in-codes/myGo (github.com)</a>ä¸Šçœ‹,æˆ‘ä¹Ÿä¸Šä¼ äº†docker<a href="https://hub.docker.com/r/proanimer/goimg">proanimer/goimg - Docker Image</a>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull proanimer/goimg</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Goè¯­è¨€simpleå¹¶ä¸”easy,å†…ç½®äº†å¾ˆå¤šæœ‰ç”¨çš„åº“,å¯¹å¹¶å‘æ”¯æŒæ¯”è¾ƒå¥½å¹¶ä¸”å®˜æ–¹(æŒ‡Google)è¿˜æ˜¯æ¯”è¾ƒé‡è§†çš„.&lt;br&gt;</summary>
    
    
    
    
    <category term="Golang" scheme="https://www.sekyoro.top/tags/Golang/"/>
    
    <category term="Gin" scheme="https://www.sekyoro.top/tags/Gin/"/>
    
  </entry>
  
  <entry>
    <title>gRPCå­¦ä¹ </title>
    <link href="https://www.sekyoro.top/2024/01/05/grpc%E5%AD%A6%E4%B9%A0/"/>
    <id>https://www.sekyoro.top/2024/01/05/grpc%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-01-05T11:16:58.000Z</published>
    <updated>2024-01-06T08:03:34.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>RPCæ˜¯è¿œç¨‹è°ƒç”¨,è€Œgoogleå®ç°äº†grpcæ¯”è¾ƒæ–¹ä¾¿åœ°å®ç°äº†è¿œç¨‹è°ƒç”¨,gRPCæ˜¯ä¸€ä¸ªç°ä»£çš„å¼€æºè¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æ¡†æ¶<br><span id="more"></span></p><h2 id="æ¦‚å¿µä»‹ç»"><a href="#æ¦‚å¿µä»‹ç»" class="headerlink" title="æ¦‚å¿µä»‹ç»"></a>æ¦‚å¿µä»‹ç»</h2><p>åœ¨gRPCä¸­ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è°ƒç”¨å¦ä¸€å°è®¡ç®—æœºä¸Šçš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸Šçš„æ–¹æ³•ï¼Œå°±å¥½åƒå®ƒæ˜¯æœ¬åœ°å¯¹è±¡ä¸€æ ·ã€‚</p><blockquote><p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient/Serverï¼‰çš„ä¾‹å­ï¼Œå®ƒç®€å•è€Œåˆå¹¿å—æ¬¢è¿ã€‚<br>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ€»æ˜¯ç”±å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªæ‰§è¡Œè‹¥å¹²è¿‡ç¨‹è¯·æ±‚ï¼Œå¹¶ç”¨å®¢æˆ·ç«¯æä¾›çš„å‚æ•°ã€‚æ‰§è¡Œç»“æœå°†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br>ç”±äºå­˜åœ¨å„å¼å„æ ·çš„å˜ä½“å’Œç»†èŠ‚å·®å¼‚ï¼Œå¯¹åº”åœ°æ´¾ç”Ÿäº†å„å¼è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œè€Œä¸”å®ƒä»¬å¹¶ä¸äº’ç›¸å…¼å®¹ã€‚</p><p>ä¸ºäº†å…è®¸ä¸åŒçš„å®¢æˆ·ç«¯å‡èƒ½è®¿é—®æœåŠ¡å™¨ï¼Œ<strong>è®¸å¤šæ ‡å‡†åŒ–çš„ RPC ç³»ç»Ÿåº”è¿è€Œç”Ÿäº†ã€‚å…¶ä¸­å¤§éƒ¨åˆ†é‡‡ç”¨æ¥å£æè¿°è¯­è¨€ï¼ˆInterface Description Languageï¼ŒIDLï¼‰ï¼Œæ–¹ä¾¿è·¨å¹³å°çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨</strong>ã€‚</p></blockquote><p>ä¸è®¸å¤šRPCç³»ç»Ÿä¸€æ ·ï¼ŒgRPCåŸºäºå®šä¹‰æœåŠ¡çš„æ€æƒ³ï¼ŒæŒ‡å®šå¯ä»¥é€šè¿‡å…¶å‚æ•°å’Œè¿”å›ç±»å‹è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•ã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå¹¶è¿è¡ŒgRPCæœåŠ¡å™¨æ¥å¤„ç†å®¢æˆ·ç«¯è°ƒç”¨ã€‚åœ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æœ‰ä¸€ä¸ªstubï¼ˆåœ¨æŸäº›è¯­è¨€ä¸­ç§°ä¸ºå®¢æˆ·ç«¯ï¼‰ï¼Œå®ƒæä¾›ä¸æœåŠ¡å™¨ç›¸åŒçš„æ–¹æ³•ã€‚</p><p>å®ƒå…·æœ‰è®¸å¤šç‰¹æ€§</p><ol><li><strong>å¼ºå¤§çš„IDLç‰¹æ€§</strong><br>RPCä½¿ç”¨ProtoBufæ¥å®šä¹‰æœåŠ¡ï¼ŒProtoBufæ˜¯ç”±Googleå¼€å‘çš„ä¸€ç§æ•°æ®åºåˆ—åŒ–åè®®ï¼Œæ€§èƒ½å‡ºä¼—ï¼Œå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚</li><li>æ”¯æŒå¤šç§è¯­è¨€<br>æ”¯æŒC++ã€Javaã€Goã€Pythonã€Rubyã€C#ã€Node.jsã€Android Javaã€Objective-Cã€PHPç­‰ç¼–ç¨‹è¯­è¨€ã€‚</li><li>åŸºäº<strong>HTTP/2</strong>æ ‡å‡†è®¾è®¡</li></ol><p><img data-src="https://grpc.io/img/landing-2.svg" alt="Concept Diagram"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒgRPCä½¿ç”¨<strong>Protocol Buffers</strong>ï¼Œè¿™æ˜¯è°·æ­Œæˆç†Ÿçš„å¼€æºæœºåˆ¶ï¼Œ<strong>ç”¨äºåºåˆ—åŒ–ç»“æ„åŒ–æ•°æ®(å°½ç®¡å®ƒå¯ä»¥ä¸JSONç­‰å…¶ä»–æ•°æ®æ ¼å¼ä¸€èµ·ä½¿ç”¨)</strong></p><h3 id="ä¸RESTå·®å¼‚"><a href="#ä¸RESTå·®å¼‚" class="headerlink" title="ä¸RESTå·®å¼‚"></a>ä¸RESTå·®å¼‚</h3><p>RPC çš„æ¶ˆæ¯ä¼ è¾“å¯ä»¥é€šè¿‡ TCPã€UDP æˆ–è€… HTTPç­‰ï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ç§°ä¹‹ä¸º RPC over TCPã€ RPC over HTTPã€‚</p><p>RPC é€šè¿‡ HTTP ä¼ è¾“æ¶ˆæ¯çš„æ—¶å€™å’Œ RESTfulçš„æ¶æ„æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸åŒã€‚</p><blockquote><ul><li>gRPCä½¿ç”¨HTTP/2ï¼Œè€ŒRESTä½¿ç”¨HTTP1.1</li><li>gRPCä½¿ç”¨åè®®ç¼“å†²åŒºæ•°æ®æ ¼å¼ï¼Œè€Œä¸æ˜¯REST APIä¸­é€šå¸¸ä½¿ç”¨çš„æ ‡å‡†JSONæ•°æ®æ ¼å¼</li><li>ä½¿ç”¨gRPC,å¯ä»¥åˆ©ç”¨HTTP/2åŠŸèƒ½ï¼Œå¦‚æœåŠ¡å™¨ç«¯æµå¼ä¼ è¾“ã€å®¢æˆ·ç«¯æµå¼ä¼ è¾“ï¼Œç”šè‡³åŒå‘æµå¼ä¼ è¾“</li></ul></blockquote><p>é¦–å…ˆ RPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¸ˆç´§è€¦åˆçš„ï¼Œå®¢æˆ·ç«¯éœ€è¦çŸ¥é“è°ƒç”¨çš„è¿‡ç¨‹çš„åå­—ï¼Œè¿‡ç¨‹çš„å‚æ•°ä»¥åŠå®ƒä»¬çš„ç±»å‹ã€é¡ºåºç­‰ã€‚<strong>ä¸€æ—¦æœåŠ¡å™¨æ›´æ”¹äº†è¿‡ç¨‹çš„å®ç°ï¼Œå®¢æˆ·ç«¯çš„å®ç°å¾ˆå®¹æ˜“å‡ºé—®é¢˜</strong>ã€‚RESTfulåŸºäº httpçš„è¯­ä¹‰æ“ä½œèµ„æºï¼Œå‚æ•°çš„é¡ºåºä¸€èˆ¬æ²¡æœ‰å…³ç³»ï¼Œä¹Ÿå¾ˆå®¹æ˜“çš„<strong>é€šè¿‡ä»£ç†è½¬æ¢é“¾æ¥å’Œèµ„æºä½ç½®</strong>ï¼Œä»è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼ŒRESTful æ›´çµæ´»ã€‚</p><p>å…¶æ¬¡ï¼Œå®ƒä»¬æ“ä½œçš„å¯¹è±¡ä¸ä¸€æ ·ã€‚ RPC æ“ä½œçš„æ˜¯æ–¹æ³•å’Œè¿‡ç¨‹ï¼Œå®ƒè¦æ“ä½œçš„æ˜¯æ–¹æ³•å¯¹è±¡ã€‚ RESTful æ“ä½œçš„æ˜¯èµ„æº(resource)ï¼Œè€Œä¸æ˜¯æ–¹æ³•ã€‚</p><p>ç¬¬ä¸‰ï¼ŒRESTfulæ‰§è¡Œçš„æ˜¯å¯¹èµ„æºçš„æ“ä½œï¼Œå¢åŠ ã€æŸ¥æ‰¾ã€ä¿®æ”¹å’Œåˆ é™¤ç­‰,ä¸»è¦æ˜¯CURDï¼Œæ‰€ä»¥å¦‚æœä½ è¦å®ç°ä¸€ä¸ªç‰¹å®šç›®çš„çš„æ“ä½œï¼Œæ¯”å¦‚ä¸ºåå­—å§“å¼ çš„å­¦ç”Ÿçš„æ•°å­¦æˆç»©éƒ½åŠ ä¸Š10è¿™æ ·çš„æ“ä½œï¼Œ<br>RESTfulçš„APIè®¾è®¡èµ·æ¥å°±ä¸æ˜¯é‚£ä¹ˆç›´è§‚æˆ–è€…æœ‰æ„ä¹‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹, RPCçš„å®ç°æ›´æœ‰æ„ä¹‰ï¼Œå®ƒå¯ä»¥å®ç°ä¸€ä¸ªç›´æ¥çš„æ–¹æ³•æ–¹æ³•ä¾›å®¢æˆ·ç«¯è°ƒç”¨</p><p><strong>RPC over TCPå¯ä»¥é€šè¿‡é•¿è¿æ¥å‡å°‘è¿æ¥çš„å»ºç«‹æ‰€äº§ç”Ÿçš„èŠ±è´¹</strong>ï¼Œåœ¨è°ƒç”¨æ¬¡æ•°éå¸¸å·¨å¤§çš„æ—¶å€™(è¿™æ˜¯ç›®å‰äº’è”ç½‘å…¬å¸ç»å¸¸é‡åˆ°çš„æƒ…å†µ,å¤§å¹¶å‘çš„æƒ…å†µä¸‹)ï¼Œè¿™ä¸ªèŠ±è´¹å½±å“æ˜¯éå¸¸å·¨å¤§çš„ã€‚<br>å½“ç„¶ RESTful ä¹Ÿå¯ä»¥é€šè¿‡ keep-alive å®ç°é•¿è¿æ¥, ä½†æ˜¯å®ƒæœ€å¤§çš„ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒçš„<strong>request-responseæ¨¡å‹æ˜¯é˜»å¡çš„</strong> (http1.0å’Œ http1.1, http 2.0æ²¡è¿™ä¸ªé—®é¢˜)ï¼Œ<br>å‘é€ä¸€ä¸ªè¯·æ±‚ååªæœ‰ç­‰åˆ°responseè¿”å›æ‰èƒ½å‘é€ç¬¬äºŒä¸ªè¯·æ±‚ (æœ‰äº›http serverå®ç°äº†pipelingçš„åŠŸèƒ½ï¼Œä½†ä¸æ˜¯æ ‡é…), RPCçš„å®ç°æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚</p><h3 id="å…¶ä»–RPCæ¡†æ¶"><a href="#å…¶ä»–RPCæ¡†æ¶" class="headerlink" title="å…¶ä»–RPCæ¡†æ¶"></a>å…¶ä»–RPCæ¡†æ¶</h3><p>ç›®å‰çš„ RPC æ¡†æ¶å¤§è‡´æœ‰ä¸¤ç§ä¸åŒçš„ä¾§é‡æ–¹å‘,ä¸€ç§<strong>åé‡äºæœåŠ¡æ²»ç†</strong>,å¦ä¸€ç§<strong>åé‡äºè·¨è¯­è¨€è°ƒç”¨</strong>ã€‚</p><p>æœåŠ¡æ²»ç†å‹çš„ RPC æ¡†æ¶æœ‰Alibabs <strong>Dubbo</strong>ã€Motan ç­‰ï¼Œè¿™ç±»çš„ RPC æ¡†æ¶çš„ç‰¹ç‚¹æ˜¯åŠŸèƒ½ä¸°å¯Œï¼Œ<strong>æä¾›é«˜æ€§èƒ½çš„è¿œç¨‹è°ƒç”¨ä»¥åŠæœåŠ¡å‘ç°å’Œæ²»ç†åŠŸèƒ½</strong>ï¼Œé€‚ç”¨äºå¤§å‹æœåŠ¡çš„å¾®æœåŠ¡åŒ–æ‹†åˆ†ä»¥åŠç®¡ç†ï¼Œå¯¹äºç‰¹å®šè¯­è¨€ï¼ˆJavaï¼‰çš„é¡¹ç›®å¯ä»¥ååˆ†å‹å¥½çš„é€æ˜åŒ–æ¥å…¥ã€‚ä½†ç¼ºç‚¹æ˜¯è¯­è¨€è€¦åˆåº¦è¾ƒé«˜ï¼Œè·¨è¯­è¨€æ”¯æŒéš¾åº¦è¾ƒå¤§ã€‚</p><p>è·¨è¯­è¨€è°ƒç”¨å‹çš„ RPC æ¡†æ¶æœ‰ Thriftã€<strong>gRPC</strong>ã€Hessianã€Finagle ç­‰ï¼Œ<strong>è¿™ä¸€ç±»çš„ RPC æ¡†æ¶é‡ç‚¹å…³æ³¨äºæœåŠ¡çš„è·¨è¯­è¨€è°ƒç”¨ï¼Œèƒ½å¤Ÿæ”¯æŒå¤§éƒ¨åˆ†çš„è¯­è¨€è¿›è¡Œè¯­è¨€æ— å…³çš„è°ƒç”¨</strong>ï¼Œéå¸¸é€‚åˆäºä¸ºä¸åŒè¯­è¨€æä¾›é€šç”¨è¿œç¨‹æœåŠ¡çš„åœºæ™¯ã€‚ä½†è¿™ç±»æ¡†æ¶æ²¡æœ‰æœåŠ¡å‘ç°ç›¸å…³æœºåˆ¶ï¼Œå®é™…ä½¿ç”¨æ—¶ä¸€èˆ¬éœ€è¦ä»£ç†å±‚è¿›è¡Œè¯·æ±‚è½¬å‘å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥æ§åˆ¶ã€‚</p><p><a href="https://thrift.apache.org/">thrift</a>æ˜¯Apacheçš„ä¸€ä¸ªè·¨è¯­è¨€çš„é«˜æ€§èƒ½çš„æœåŠ¡æ¡†æ¶ï¼Œä¹Ÿå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚å®ƒçš„åŠŸèƒ½ç±»ä¼¼ gRPC, æ”¯æŒè·¨è¯­è¨€ï¼Œä¸æ”¯æŒæœåŠ¡æ²»ç†ã€‚</p><p><a href="https://github.com/smallnest/rpcx">rpcx</a> æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„Goè¯­è¨€çš„ RPC æ¡†æ¶ï¼Œæ”¯æŒZookepperã€etcdã€consulå¤šç§æœåŠ¡å‘ç°æ–¹å¼ï¼Œå¤šç§æœåŠ¡è·¯ç”±æ–¹å¼ï¼Œ æ˜¯ç›®å‰æ€§èƒ½æœ€å¥½çš„ RPC æ¡†æ¶ä¹‹ä¸€</p><h3 id="ä½¿ç”¨protobuf"><a href="#ä½¿ç”¨protobuf" class="headerlink" title="ä½¿ç”¨protobuf"></a>ä½¿ç”¨protobuf</h3><p>å®šä¹‰è¦åœ¨protoæ–‡ä»¶ä¸­åºåˆ—åŒ–çš„æ•°æ®çš„ç»“æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ‰©å±•åä¸º.protoçš„æ™®é€šæ–‡æœ¬æ–‡ä»¶ã€‚åè®®ç¼“å†²åŒºæ•°æ®è¢«æ„é€ ä¸ºæ¶ˆæ¯ï¼Œå…¶ä¸­æ¯ä¸ªæ¶ˆæ¯éƒ½æ˜¯ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—åå€¼å¯¹ï¼ˆç§°ä¸ºå­—æ®µï¼‰çš„ä¿¡æ¯çš„å°é€»è¾‘è®°å½•ã€‚</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> id = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">bool</span> has_ponycopter = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šäº†æ•°æ®ç»“æ„,å°±å¯ä»¥<strong>ä½¿ç”¨åè®®ç¼“å†²åŒºç¼–è¯‘å™¨protocä»protoå®šä¹‰ä¸­ç”Ÿæˆé¦–é€‰è¯­è¨€çš„æ•°æ®è®¿é—®ç±»</strong>.</p><p>å®ƒä»¬ä¸ºæ¯ä¸ªå­—æ®µæä¾›äº†ç®€å•çš„è®¿é—®å™¨,å¦‚name()å’Œset_name()ï¼Œä»¥åŠå°†æ•´ä¸ªç»“æ„åºåˆ—åŒ–åˆ°åŸå§‹å­—èŠ‚/ä»åŸå§‹å­—èŠ‚è§£ææ•´ä¸ªç»“æ„çš„æ–¹æ³•ã€‚</p><p>å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœé€‰æ‹©çš„è¯­è¨€æ˜¯C++ï¼Œé‚£ä¹ˆåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­è¿è¡Œç¼–è¯‘å™¨å°†ç”Ÿæˆä¸€ä¸ªåä¸ºPersonçš„ç±»ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ­¤ç±»æ¥å¡«å……ã€åºåˆ—åŒ–å’Œæ£€ç´¢Personåè®®ç¼“å†²åŒºæ¶ˆæ¯ã€‚</p><p>gRPCä½¿ç”¨protocå’Œä¸€ä¸ªç‰¹æ®Šçš„gRPCæ’ä»¶ä»protoæ–‡ä»¶ä¸­ç”Ÿæˆä»£ç ï¼š<strong>å¯ä»¥è·å¾—ç”Ÿæˆçš„gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ï¼Œä»¥åŠç”¨äºå¡«å……ã€åºåˆ—åŒ–å’Œæ£€ç´¢æ¶ˆæ¯ç±»å‹çš„å¸¸è§„åè®®ç¼“å†²åŒºä»£ç ã€‚</strong>(æˆªè‡³ç›®å‰protobufæœ€æ–°ç‰ˆæœ¬æ˜¯v3)</p><h2 id="gRPC-in-Go"><a href="#gRPC-in-Go" class="headerlink" title="gRPC in Go"></a>gRPC in Go</h2><h3 id="ä¸‹è½½protoc"><a href="#ä¸‹è½½protoc" class="headerlink" title="ä¸‹è½½protoc"></a>ä¸‹è½½protoc</h3><blockquote><p>è™½ç„¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†gRPCåº”ç”¨ç¨‹åºé€šå¸¸åˆ©ç”¨proto bufferè¿›è¡ŒæœåŠ¡å®šä¹‰å’Œæ•°æ®åºåˆ—åŒ–ã€‚</p></blockquote><p><a href="https://github.com/protocolbuffers/protobuf/releases">Releases Â· protocolbuffers/protobuf (github.com)</a></p><p>protocç”¨äºç¼–è¯‘.protoæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æœåŠ¡å’Œæ¶ˆæ¯å®šä¹‰,Linuxæˆ–Macç›´æ¥ä½¿ç”¨å¯¹åº”åŒ…ç®¡ç†å™¨ä¸‹è½½å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install -y protobuf-compiler</span><br><span class="line">protoc --version  <span class="comment"># Ensure compiler version is 3+</span></span><br></pre></td></tr></table></figure><p>Windowsåœ¨githubä¸Šä¸‹è½½äºŒè¿›åˆ¶åŒ…<a href="https://github.com/protocolbuffers/protobuf/releases">Releases Â· protocolbuffers/protobuf (github.com)</a></p><h3 id="protocol-compilerçš„Goæ’ä»¶"><a href="#protocol-compilerçš„Goæ’ä»¶" class="headerlink" title="protocol compilerçš„Goæ’ä»¶"></a>protocol compilerçš„Goæ’ä»¶</h3><h4 id="ä¸‹è½½protoc-go-gen"><a href="#ä¸‹è½½protoc-go-gen" class="headerlink" title="ä¸‹è½½protoc-go-gen"></a>ä¸‹è½½protoc-go-gen</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span><br><span class="line">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span><br></pre></td></tr></table></figure><p>ä¸‹è½½zipçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b v1.60.1 --depth 1 https://github.com/grpc/grpc-go</span><br></pre></td></tr></table></figure><h4 id="protoæ–‡ä»¶"><a href="#protoæ–‡ä»¶" class="headerlink" title="protoæ–‡ä»¶"></a>protoæ–‡ä»¶</h4><p>ä¸‹é¢å®šä¹‰äº†æœåŠ¡</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface exported by the server.</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">RouteGuide</span> </span>&#123;</span><br><span class="line">  <span class="comment">// A simple RPC.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Obtains the feature at a given position.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// A feature with an empty name is returned if there&#x27;s no feature at the given</span></span><br><span class="line">  <span class="comment">// position.</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetFeature(Point) <span class="keyword">returns</span> (Feature) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A server-to-client streaming RPC.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Obtains the Features available within the given Rectangle.  Results are</span></span><br><span class="line">  <span class="comment">// streamed rather than returned at once (e.g. in a response message with a</span></span><br><span class="line">  <span class="comment">// repeated field), as the rectangle may cover a large area and contain a</span></span><br><span class="line">  <span class="comment">// huge number of features.</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListFeatures(Rectangle) <span class="keyword">returns</span> (stream Feature) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A client-to-server streaming RPC.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Accepts a stream of Points on a route being traversed, returning a</span></span><br><span class="line">  <span class="comment">// RouteSummary when traversal is completed.</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> RecordRoute(stream Point) <span class="keyword">returns</span> (RouteSummary) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A Bidirectional streaming RPC.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Accepts a stream of RouteNotes sent while a route is being traversed,</span></span><br><span class="line">  <span class="comment">// while receiving other RouteNotes (e.g. from other users).</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> RouteChat(stream RouteNote) <span class="keyword">returns</span> (stream RouteNote) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¶‰åŠåˆ°ä¸€äº›å‚æ•°messageè¡¨ç¤ºä¼ é€’æ•°æ®.</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Points are represented as latitude-longitude pairs in the E7 representation</span></span><br><span class="line"><span class="comment">// (degrees multiplied by 10**7 and rounded to the nearest integer).</span></span><br><span class="line"><span class="comment">// Latitudes should be in the range +/- 90 degrees and longitude should be in</span></span><br><span class="line"><span class="comment">// the range +/- 180 degrees (inclusive).</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> latitude = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> longitude = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A latitude-longitude rectangle, represented as two diagonally opposite</span></span><br><span class="line"><span class="comment">// points &quot;lo&quot; and &quot;hi&quot;.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line">  <span class="comment">// One corner of the rectangle.</span></span><br><span class="line">  Point lo = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The other corner of the rectangle.</span></span><br><span class="line">  Point hi = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A feature names something at a given point.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If a feature could not be named, the name is empty.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Feature</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The name of the feature.</span></span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The point where the feature is detected.</span></span><br><span class="line">  Point location = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A RouteNote is a message sent while at a given point.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">RouteNote</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The location from which the message is sent.</span></span><br><span class="line">  Point location = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The message to be sent.</span></span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 2;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">// <span class="title">A</span> RouteSummary is received in response to a RecordRoute rpc.</span></span><br><span class="line"><span class="class">//</span></span><br><span class="line"><span class="class">// It contains the number of individual points received, the number of</span></span><br><span class="line"><span class="class">// detected features, and the total distance covered as the cumulative sum of</span></span><br><span class="line"><span class="class">// the distance between each point.</span></span><br><span class="line"><span class="class">message RouteSummary </span>&#123;</span><br><span class="line">  <span class="comment">// The number of points received.</span></span><br><span class="line">  <span class="built_in">int32</span> point_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The number of known features passed while traversing the route.</span></span><br><span class="line">  <span class="built_in">int32</span> feature_count = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The distance covered in metres.</span></span><br><span class="line">  <span class="built_in">int32</span> distance = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The duration of the traversal in seconds.</span></span><br><span class="line">  <span class="built_in">int32</span> elapsed_time = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ä¸¤ä¸ªæ–‡ä»¶åŒ…æ‹¬messageå®ç°å’Œç”¨äºserver,clientçš„ä»£ç </p><p>åœ¨pb.goæ–‡ä»¶ä¸­å¯¹äºæ¯ä¸ªmessageå®ç°äº†å…¶type,æ¯”å¦‚å¯¹äº<code>Rectangle</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</span><br><span class="line">state         protoimpl.MessageState</span><br><span class="line">sizeCache     protoimpl.SizeCache</span><br><span class="line">unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line"><span class="comment">// One corner of the rectangle.</span></span><br><span class="line">Lo *Point <span class="string">`protobuf:&quot;bytes,1,opt,name=lo,proto3&quot; json:&quot;lo,omitempty&quot;`</span></span><br><span class="line"><span class="comment">// The other corner of the rectangle.</span></span><br><span class="line">Hi *Point <span class="string">`protobuf:&quot;bytes,2,opt,name=hi,proto3&quot; json:&quot;hi,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *Rectangle)</span> <span class="title">Reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">*x = Rectangle&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> protoimpl.UnsafeEnabled &#123;</span><br><span class="line">mi := &amp;file_routeguide_route_guide_proto_msgTypes[<span class="number">1</span>]</span><br><span class="line">ms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))</span><br><span class="line">ms.StoreMessageInfo(mi)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *Rectangle)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> protoimpl.X.MessageStringOf(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Rectangle)</span> <span class="title">ProtoMessage</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *Rectangle)</span> <span class="title">ProtoReflect</span><span class="params">()</span> <span class="title">protoreflect</span>.<span class="title">Message</span></span> &#123;</span><br><span class="line">mi := &amp;file_routeguide_route_guide_proto_msgTypes[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">if</span> protoimpl.UnsafeEnabled &amp;&amp; x != <span class="literal">nil</span> &#123;</span><br><span class="line">ms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))</span><br><span class="line"><span class="keyword">if</span> ms.LoadMessageInfo() == <span class="literal">nil</span> &#123;</span><br><span class="line">ms.StoreMessageInfo(mi)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ms</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mi.MessageOf(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deprecated: Use Rectangle.ProtoReflect.Descriptor instead.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Rectangle)</span> <span class="title">Descriptor</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> file_routeguide_route_guide_proto_rawDescGZIP(), []<span class="keyword">int</span>&#123;<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *Rectangle)</span> <span class="title">GetLo</span><span class="params">()</span> *<span class="title">Point</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> x != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> x.Lo</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *Rectangle)</span> <span class="title">GetHi</span><span class="params">()</span> *<span class="title">Point</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> x != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> x.Hi</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºClientæ¥è¯´,å®šä¹‰æ¥å£.é¦–å…ˆä½¿ç”¨grpcåº“ä¸­çš„<code>grpc.ClientConnInterface</code>ä½œä¸ºrouteGuideClientçš„æˆå‘˜.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> routeGuideClient <span class="keyword">struct</span> &#123;</span><br><span class="line">cc grpc.ClientConnInterface</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»™ç»“æ„ä½“<code>routeGuideClient</code>å®ç°å¤šä¸ªæ–¹æ³•,å¹¶å®šä¹‰æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RouteGuideClient <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// A simple RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Obtains the feature at a given position.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A feature with an empty name is returned if there&#x27;s no feature at the given</span></span><br><span class="line"><span class="comment">// position.</span></span><br><span class="line">GetFeature(ctx context.Context, in *Point, opts ...grpc.CallOption) (*Feature, error)</span><br><span class="line"><span class="comment">// A server-to-client streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Obtains the Features available within the given Rectangle.  Results are</span></span><br><span class="line"><span class="comment">// streamed rather than returned at once (e.g. in a response message with a</span></span><br><span class="line"><span class="comment">// repeated field), as the rectangle may cover a large area and contain a</span></span><br><span class="line"><span class="comment">// huge number of features.</span></span><br><span class="line">ListFeatures(ctx context.Context, in *Rectangle, opts ...grpc.CallOption) (RouteGuide_ListFeaturesClient, error)</span><br><span class="line"><span class="comment">// A client-to-server streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Accepts a stream of Points on a route being traversed, returning a</span></span><br><span class="line"><span class="comment">// RouteSummary when traversal is completed.</span></span><br><span class="line">RecordRoute(ctx context.Context, opts ...grpc.CallOption) (RouteGuide_RecordRouteClient, error)</span><br><span class="line"><span class="comment">// A Bidirectional streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Accepts a stream of RouteNotes sent while a route is being traversed,</span></span><br><span class="line"><span class="comment">// while receiving other RouteNotes (e.g. from other users).</span></span><br><span class="line">RouteChat(ctx context.Context, opts ...grpc.CallOption) (RouteGuide_RouteChatClient, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡<code>NewRouteGuideClient</code>è¿”å›ç»“æ„ä½“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouteGuideClient</span><span class="params">(cc grpc.ClientConnInterface)</span> <span class="title">RouteGuideClient</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;routeGuideClient&#123;cc&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ç»“æ„ä½“çš„æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *routeGuideClient)</span> <span class="title">GetFeature</span><span class="params">(ctx context.Context, in *Point, opts ...grpc.CallOption)</span> <span class="params">(*Feature, error)</span></span> &#123;</span><br><span class="line">out := <span class="built_in">new</span>(Feature)</span><br><span class="line">err := c.cc.Invoke(ctx, RouteGuide_GetFeature_FullMethodName, in, out, opts...)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> out, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *routeGuideClient)</span> <span class="title">ListFeatures</span><span class="params">(ctx context.Context, in *Rectangle, opts ...grpc.CallOption)</span> <span class="params">(RouteGuide_ListFeaturesClient, error)</span></span> &#123;</span><br><span class="line">stream, err := c.cc.NewStream(ctx, &amp;RouteGuide_ServiceDesc.Streams[<span class="number">0</span>], RouteGuide_ListFeatures_FullMethodName, opts...)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">x := &amp;routeGuideListFeaturesClient&#123;stream&#125;</span><br><span class="line"><span class="keyword">if</span> err := x.ClientStream.SendMsg(in); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := x.ClientStream.CloseSend(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> x, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ¶‰åŠstreamè¿˜æœ‰æ–°çš„ç»“æ„,å®šä¹‰ç»“æ„ä½“,æ–¹æ³•å’Œæ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> RouteGuide_ListFeaturesClient <span class="keyword">interface</span> &#123;</span><br><span class="line">Recv() (*Feature, error)</span><br><span class="line">grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> routeGuideListFeaturesClient <span class="keyword">struct</span> &#123;</span><br><span class="line">grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *routeGuideListFeaturesClient)</span> <span class="title">Recv</span><span class="params">()</span> <span class="params">(*Feature, error)</span></span> &#123;</span><br><span class="line">m := <span class="built_in">new</span>(Feature)</span><br><span class="line"><span class="keyword">if</span> err := x.ClientStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºserverç±»ä¼¼,å®šä¹‰æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RouteGuideServer <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// A simple RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Obtains the feature at a given position.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A feature with an empty name is returned if there&#x27;s no feature at the given</span></span><br><span class="line"><span class="comment">// position.</span></span><br><span class="line">GetFeature(context.Context, *Point) (*Feature, error)</span><br><span class="line"><span class="comment">// A server-to-client streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Obtains the Features available within the given Rectangle.  Results are</span></span><br><span class="line"><span class="comment">// streamed rather than returned at once (e.g. in a response message with a</span></span><br><span class="line"><span class="comment">// repeated field), as the rectangle may cover a large area and contain a</span></span><br><span class="line"><span class="comment">// huge number of features.</span></span><br><span class="line">ListFeatures(*Rectangle, RouteGuide_ListFeaturesServer) error</span><br><span class="line"><span class="comment">// A client-to-server streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Accepts a stream of Points on a route being traversed, returning a</span></span><br><span class="line"><span class="comment">// RouteSummary when traversal is completed.</span></span><br><span class="line">RecordRoute(RouteGuide_RecordRouteServer) error</span><br><span class="line"><span class="comment">// A Bidirectional streaming RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Accepts a stream of RouteNotes sent while a route is being traversed,</span></span><br><span class="line"><span class="comment">// while receiving other RouteNotes (e.g. from other users).</span></span><br><span class="line">RouteChat(RouteGuide_RouteChatServer) error</span><br><span class="line">mustEmbedUnimplementedRouteGuideServer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°serverå’Œclient"><a href="#å®ç°serverå’Œclient" class="headerlink" title="å®ç°serverå’Œclient"></a>å®ç°serverå’Œclient</h4><p>å½“ä½¿ç”¨protocç”Ÿæˆæ–‡ä»¶ä¹‹å,å°±å¯ä»¥å†™serverå’Œclientäº†.</p><h5 id="server"><a href="#server" class="headerlink" title="server"></a>server</h5><p>å®šä¹‰ç»“æ„ä½“,æ³¨æ„å®šä¹‰æ—¶åŠ ä¸Š<code>pb.UnimplementedRouteGuideServer</code>è¿™æ ·é¿å…æœ‰äº›æ–¹æ³•æ²¡æœ‰å®ç°.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> routeGuideServer <span class="keyword">struct</span> &#123;</span><br><span class="line">pb.UnimplementedRouteGuideServer</span><br><span class="line">savedFeatures []*pb.Feature <span class="comment">// read-only after initialized</span></span><br><span class="line"></span><br><span class="line">mu         sync.Mutex <span class="comment">// protects routeNotes</span></span><br><span class="line">routeNotes <span class="keyword">map</span>[<span class="keyword">string</span>][]*pb.RouteNote</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°æ¥å£æ»¡è¶³çš„æ–¹æ³•.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *routeGuideServer)</span> <span class="title">GetFeature</span><span class="params">(ctx context.Context, point *pb.Point)</span> <span class="params">(*pb.Feature, error)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *routeGuideServer)</span> <span class="title">ListFeatures</span><span class="params">(rect *pb.Rectangle, stream pb.RouteGuide_ListFeaturesServer)</span></span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *routeGuideServer)</span> <span class="title">RecordRoute</span><span class="params">(stream pb.RouteGuide_RecordRouteServer)</span></span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *routeGuideServer)</span> <span class="title">RouteChat</span><span class="params">(stream pb.RouteGuide_RouteChatServer)</span></span></span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨tcpé“¾æ¥æ–°å»ºgrpcæœåŠ¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="string">&quot;localhost:%d&quot;</span>, *port))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> opts []grpc.ServerOption</span><br><span class="line"><span class="keyword">if</span> *tls &#123;</span><br><span class="line"><span class="keyword">if</span> *certFile == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">*certFile = data.Path(<span class="string">&quot;x509/server_cert.pem&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> *keyFile == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">*keyFile = data.Path(<span class="string">&quot;x509/server_key.pem&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">creds, err := credentials.NewServerTLSFromFile(*certFile, *keyFile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Failed to generate credentials: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">opts = []grpc.ServerOption&#123;grpc.Creds(creds)&#125;</span><br><span class="line">&#125;</span><br><span class="line">grpcServer := grpc.NewServer(opts...)</span><br><span class="line">pb.RegisterRouteGuideServer(grpcServer, newServer())</span><br><span class="line">grpcServer.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä½¿ç”¨<code>pb.RegisterRouteGuideServer</code>æ³¨å†ŒæœåŠ¡,å‚æ•°åˆ†åˆ«æ˜¯grpcæœåŠ¡å’Œ<code>newServer</code>è¿”å›çš„ç»“æ„ä½“</p><h5 id="client"><a href="#client" class="headerlink" title="client"></a>client</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printFeature</span><span class="params">(client pb.RouteGuideClient, point *pb.Point)</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Getting feature for point (%d, %d)&quot;</span>, point.Latitude, point.Longitude)</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">feature, err := client.GetFeature(ctx, point)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;client.GetFeature failed: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Println(feature)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨contextåˆ›å»ºctxå’Œcancel,åˆ©ç”¨<code>client := pb.NewRouteGuideClient(conn)</code>åˆ›å»ºclientè°ƒç”¨æ–¹æ³•.</p><p><code>NewRouteGuideClient</code>è¿”å›å¯¹åº”çš„clientæ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouteGuideClient</span><span class="params">(cc grpc.ClientConnInterface)</span> <span class="title">RouteGuideClient</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;routeGuideClient&#123;cc&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gRPCé¢ä¸´çš„æŒ‘æˆ˜"><a href="#gRPCé¢ä¸´çš„æŒ‘æˆ˜" class="headerlink" title="gRPCé¢ä¸´çš„æŒ‘æˆ˜"></a>gRPCé¢ä¸´çš„æŒ‘æˆ˜</h2><p>è™½ç„¶gRPCç¡®å®å…è®¸æ‚¨ä½¿ç”¨è¿™äº›è¾ƒæ–°çš„æŠ€æœ¯ï¼Œä½†gRPCæœåŠ¡çš„åŸå‹è®¾è®¡æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå› ä¸º<strong>æ— æ³•ä½¿ç”¨Postman HTTPå®¢æˆ·ç«¯ç­‰å·¥å…·æ¥è½»æ¾åœ°ä¸æ‚¨å…¬å¼€çš„gRPCæœåŠ¡äº¤äº’</strong>ã€‚ä½ ç¡®å®æœ‰ä¸€äº›é€‰æ‹©å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ç§åœ¨æœ¬åœ°å°±å¯ä»¥è·å¾—çš„ä¸œè¥¿ã€‚</p><p>æœ‰ä¸€äº›é€‰é¡¹å¯ä»¥ä½¿ç”¨è¯¸å¦‚ç‰¹ä½¿ä¹‹ç±»çš„å·¥å…·æ¥åè½¬ä»£ç†æ ‡å‡†JSONè¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬ç ä¸ºæ­£ç¡®çš„æ•°æ®æ ¼å¼ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé¢å¤–çš„ä¾èµ–é¡¹ï¼Œå¯¹äºç®€å•çš„é¡¹ç›®æ¥è¯´ï¼Œè®¾ç½®å®ƒå¯èƒ½å¾ˆå›°éš¾ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://grpc.io/docs/">Documentation | gRPC</a></li><li><a href="https://tutorialedge.net/golang/go-grpc-beginners-tutorial/">Go gRPC Beginners Tutorial | TutorialEdge.net</a></li><li><a href="https://www.bookstack.cn/read/go-rpc-programming-guide/part1-gorpc.md">Go RPCå¼€å‘ç®€ä»‹ - å®˜æ–¹RPCåº“ - ã€ŠGo RPCå¼€å‘æŒ‡å— [ä¸­æ–‡æ–‡æ¡£]ã€‹ - ä¹¦æ ˆç½‘ Â· BookStack</a></li><li><a href="http://ruanyifeng.com/blog/2018/10/restful-api-best-practices.html">RESTful API æœ€ä½³å®è·µ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)</a></li><li><a href="https://grpc.io/docs/languages/go/basics/">Basics tutorial | Go | gRPC</a></li><li><a href="https://grpc.io/docs/what-is-grpc/">What is gRPC? | gRPC</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;RPCæ˜¯è¿œç¨‹è°ƒç”¨,è€Œgoogleå®ç°äº†grpcæ¯”è¾ƒæ–¹ä¾¿åœ°å®ç°äº†è¿œç¨‹è°ƒç”¨,gRPCæ˜¯ä¸€ä¸ªç°ä»£çš„å¼€æºè¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)æ¡†æ¶&lt;br&gt;</summary>
    
    
    
    
    <category term="grpc" scheme="https://www.sekyoro.top/tags/grpc/"/>
    
  </entry>
  
  <entry>
    <title>gradioå­¦ä¹ </title>
    <link href="https://www.sekyoro.top/2023/12/25/gradio%E5%AD%A6%E4%B9%A0/"/>
    <id>https://www.sekyoro.top/2023/12/25/gradio%E5%AD%A6%E4%B9%A0/</id>
    <published>2023-12-25T13:12:10.000Z</published>
    <updated>2023-12-26T04:22:18.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Gradioå¥½å•Š,å¥½å•Š,å¥½å•Š.Hugging Faceå¥½å•Š,å¥½å•Š.<br><span id="more"></span></p><blockquote><p>Gradioæ˜¯ä¸€ä¸ªå¼€æºPythonåŒ…ï¼Œå…è®¸æ‚¨ä¸ºæœºå™¨å­¦ä¹ æ¨¡å‹ã€APIæˆ–ä»»ä½•ä»»æ„Pythonå‡½æ•°å¿«é€Ÿæ„å»ºæ¼”ç¤ºæˆ–webåº”ç”¨ç¨‹åºã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Gradioçš„å†…ç½®å…±äº«åŠŸèƒ½ï¼Œåœ¨å‡ ç§’é’Ÿå†…å…±äº«æ¼”ç¤ºæˆ–webåº”ç”¨ç¨‹åºçš„é“¾æ¥ã€‚æ— éœ€JavaScriptã€CSSæˆ–ç½‘ç»œæ‰˜ç®¡ç»éªŒï¼</p></blockquote><h2 id="Hot-reload"><a href="#Hot-reload" class="headerlink" title="Hot reload"></a>Hot reload</h2><p><a href="https://www.gradio.app/guides/developing-faster-with-reload-mode">Developing Faster With Reload Mode (gradio.app)</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradio run.py</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨é‡è½½æ¨¡å¼æ—¶,Gradioä¸“é—¨åœ¨ä»£ç ä¸­å¯»æ‰¾ä¸€ä¸ªåä¸ºdemoçš„Gradio Blocks/Interfaceæ¼”ç¤ºã€‚å¦‚æœæ‚¨å°†æ‚¨çš„demoå‘½åä¸ºå…¶ä»–åç§°ï¼Œåˆ™éœ€è¦å°†æ¼”ç¤ºçš„åç§°ä½œä¸ºä»£ç ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çš„run.pyæ–‡ä»¶æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gradio <span class="keyword">as</span> gr</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> gr.Blocks() <span class="keyword">as</span> my_demo:</span><br><span class="line">    gr.Markdown(<span class="string">&quot;# Greetings from Gradio!&quot;</span>)</span><br><span class="line">    inp = gr.Textbox(placeholder=<span class="string">&quot;What is your name?&quot;</span>)</span><br><span class="line">    out = gr.Textbox()</span><br><span class="line"></span><br><span class="line">    inp.change(fn=<span class="keyword">lambda</span> x: <span class="string">f&quot;Welcome, <span class="subst">&#123;x&#125;</span>!&quot;</span>,</span><br><span class="line">               inputs=inp,</span><br><span class="line">               outputs=out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    my_demo.launch()<span class="keyword">import</span> gradio <span class="keyword">as</span> gr</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> gr.Blocks() <span class="keyword">as</span> my_demo:</span><br><span class="line">    gr.Markdown(<span class="string">&quot;# Greetings from Gradio!&quot;</span>)</span><br><span class="line">    inp = gr.Textbox(placeholder=<span class="string">&quot;What is your name?&quot;</span>)</span><br><span class="line">    out = gr.Textbox()</span><br><span class="line"></span><br><span class="line">    inp.change(fn=<span class="keyword">lambda</span> x: <span class="string">f&quot;Welcome, <span class="subst">&#123;x&#125;</span>!&quot;</span>,</span><br><span class="line">               inputs=inp,</span><br><span class="line">               outputs=out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    my_demo.launch()</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¯åŠ¨reloadæ¨¡å¼</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradio run.py my_demo.</span><br></pre></td></tr></table></figure><p>æˆ‘å‘ç°å¼€å‘æ—¶ä½¿ç”¨reloadæœ€å¥½æŠŠlaunchæ”¾åœ¨<strong>name</strong> == â€œ<strong>main</strong>â€œä¸‹<a href="https://github.com/gradio-app/gradio/issues/4755">Unable to launch with reload mode with default port Â· Issue #4755 Â· gradio-app/gradio (github.com)</a></p><h3 id="launchå‚æ•°"><a href="#launchå‚æ•°" class="headerlink" title="launchå‚æ•°"></a>launchå‚æ•°</h3><p>åœ¨reloadæ¨¡å¼ä¸‹æ²¡ç”¨,å¼€å‘å®Œæ¯•åå¯ä»¥ä½¿ç”¨,ç”¨äºæ”¹å˜ç«¯å£ã€è·å¾—å…¬ç½‘åœ°å€ç”¨äºåˆ†äº«ç­‰.</p><h2 id="Interface-Class"><a href="#Interface-Class" class="headerlink" title="Interface Class"></a><strong><code>Interface</code> Class</strong></h2><p>Interfaceç±»æ—¨åœ¨ä¸ºæœºå™¨å­¦ä¹ æ¨¡å‹åˆ›å»ºæ¼”ç¤ºï¼Œè¿™äº›æ¨¡å‹æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªæˆ–æ›´å¤šè¾“å‡º.</p><p>Interfaceç±»æœ‰ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°ï¼š</p><ul><li>fnï¼šåŒ…è£…ç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰çš„å‡½æ•°</li><li>inputsï¼šç”¨äºè¾“å…¥çš„Gradioç»„ä»¶ã€‚ç»„ä»¶çš„æ•°é‡åº”ä¸å‡½æ•°ä¸­çš„å‚æ•°æ•°é‡ç›¸åŒ¹é…ã€‚</li><li>outputsï¼šç”¨äºè¾“å‡ºçš„Gradioç»„ä»¶ã€‚ç»„ä»¶çš„æ•°é‡åº”è¯¥ä¸å‡½æ•°è¿”å›å€¼çš„æ•°é‡ç›¸åŒ¹é…ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">demo = gr.Interface(</span><br><span class="line">    fn=greet,</span><br><span class="line">    inputs=[gr.components.Textbox(placeholder=<span class="string">&quot;input your words&quot;</span>), gr.Textbox(placeholder=<span class="string">&quot;&quot;</span>),gr.components.Slider()],</span><br><span class="line">    outputs=[<span class="string">&quot;text&quot;</span>,gr.Checkbox(label=<span class="string">&quot;é€‰æ‹©&quot;</span>)],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å¤šä¸ªè¾“å…¥,å¤šä¸ªè¾“å‡º,è¾“å‡ºç”±fnè®¡ç®—å¾—åˆ°,ä½†æ˜¯è²Œä¼¼è¿™åªèƒ½æ„å»ºä¸€ä¸ªå•ç»„ä»¶.</p><h2 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h2><blockquote><p>Blocksæ˜¯Gradioçš„ä½çº§APIï¼Œå®ƒå…è®¸æ‚¨åˆ›å»ºæ¯”Interfacesæ›´å¤šçš„è‡ªå®šä¹‰webåº”ç”¨ç¨‹åºå’Œæ¼”ç¤ºï¼ˆä½†ä»ç„¶å®Œå…¨ä½¿ç”¨Pythonï¼‰ã€‚</p></blockquote><p>ä¸Interfaceç±»ç›¸æ¯”ï¼ŒBlocksæä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œæ§åˆ¶ï¼š</p><p>ï¼ˆ1ï¼‰ç»„ä»¶çš„å¸ƒå±€ï¼ˆ</p><p>2ï¼‰è§¦å‘åŠŸèƒ½æ‰§è¡Œçš„äº‹ä»¶</p><p>ï¼ˆ3ï¼‰æ•°æ®æµï¼ˆä¾‹å¦‚ï¼Œè¾“å…¥å¯ä»¥è§¦å‘è¾“å‡ºï¼Œè¿™å¯ä»¥è§¦å‘ä¸‹ä¸€çº§çš„è¾“å‡ºï¼‰</p><p>Blocksè¿˜æä¾›äº†å°†ç›¸å…³æ¼”ç¤ºåˆ†ç»„åœ¨ä¸€èµ·çš„æ–¹æ³•ï¼Œä¾‹å¦‚ä½¿ç”¨é€‰é¡¹å¡ã€‚å—çš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼šåˆ›å»ºä¸€ä¸ªå—å¯¹è±¡ï¼Œç„¶åå°†å…¶ç”¨ä½œä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨â€œwithâ€è¯­å¥ï¼‰ï¼Œç„¶ååœ¨å—ä¸Šä¸‹æ–‡ä¸­å®šä¹‰å¸ƒå±€ã€ç»„ä»¶æˆ–äº‹ä»¶ã€‚æœ€åï¼Œè°ƒç”¨launchï¼ˆï¼‰æ–¹æ³•æ¥å¯åŠ¨æ¼”ç¤ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span> + name + <span class="string">&quot;!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> gr.Blocks() <span class="keyword">as</span> demo:</span><br><span class="line">    gr.Markdown(<span class="string">&quot;## Hello World&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> gr.Row():</span><br><span class="line">        textbox = gr.Textbox(placeholder=<span class="string">&quot;input your words&quot;</span>)</span><br><span class="line">        slider = gr.components.Slider()</span><br><span class="line">    btn = gr.Button(<span class="string">&quot;Run&quot;</span>)</span><br><span class="line">    btn.click(fn=update,<span class="built_in">input</span>=textbox,output=slider)</span><br><span class="line">demo.launch()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gradio <span class="keyword">as</span> gr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increase</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">return</span> num + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> gr.Blocks() <span class="keyword">as</span> demo:</span><br><span class="line">    a = gr.Number(label=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    b = gr.Number(label=<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    atob = gr.Button(<span class="string">&quot;a &gt; b&quot;</span>)</span><br><span class="line">    btoa = gr.Button(<span class="string">&quot;b &gt; a&quot;</span>)</span><br><span class="line">    atob.click(increase, a, b)</span><br><span class="line">    btoa.click(increase, b, a)</span><br><span class="line"></span><br><span class="line">demo.launch()</span><br></pre></td></tr></table></figure><h2 id="TabbedInterface"><a href="#TabbedInterface" class="headerlink" title="TabbedInterface"></a>TabbedInterface</h2><p>TabbedInterfaceæ˜¯é€šè¿‡æä¾›ä¸€ä¸ªæ¥å£åˆ—è¡¨æ¥åˆ›å»ºçš„ï¼Œæ¯ä¸ªæ¥å£éƒ½åœ¨ä¸€ä¸ªå•ç‹¬çš„é€‰é¡¹å¡ä¸­å‘ˆç°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span> + name + <span class="string">&quot;!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> gr.Blocks(theme=gr.themes.Glass()) <span class="keyword">as</span> test:</span><br><span class="line">    gr.Markdown(<span class="string">&quot;## Hello World&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> gr.Row():</span><br><span class="line">        textbox = gr.Textbox(placeholder=<span class="string">&quot;input your words&quot;</span>,label=<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        slider = gr.components.Slider(label=<span class="string">&quot;Greet&quot;</span>,interactive=<span class="literal">True</span>)</span><br><span class="line">    btn = gr.Button(<span class="string">&quot;Run&quot;</span>)</span><br><span class="line">    btn.click(fn=update, inputs=textbox, outputs=slider)</span><br><span class="line"></span><br><span class="line">stt_demo = gr.load(</span><br><span class="line">    <span class="string">&quot;huggingface/facebook/wav2vec2-base-960h&quot;</span>,</span><br><span class="line">    title=<span class="literal">None</span>,</span><br><span class="line">    inputs=<span class="string">&quot;mic&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;Let me try to guess what you&#x27;re saying!&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">demo = gr.TabbedInterface([stt_demo,test],[<span class="string">&quot;STT&quot;</span>,<span class="string">&quot;Hello World&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    demo.launch()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ChatInterface"><a href="#ChatInterface" class="headerlink" title="ChatInterface"></a>ChatInterface</h2><blockquote><p>èŠå¤©æœºå™¨äººæ˜¯å¤§å‹è¯­è¨€æ¨¡å‹çš„ä¸€ä¸ªæµè¡Œåº”ç”¨ç¨‹åºã€‚ä½¿ç”¨gradioï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°æ„å»ºèŠå¤©æœºå™¨äººæ¨¡å‹çš„æ¼”ç¤ºå¹¶ä¸ç”¨æˆ·å…±äº«ï¼Œæˆ–è€…ä½¿ç”¨ç›´è§‚çš„èŠå¤©æœºå™¨äººUIè‡ªå·±å°è¯•ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> gradio <span class="keyword">as</span> gr</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_response</span>(<span class="params">message, history</span>):</span></span><br><span class="line"> <span class="keyword">return</span> random.choice([<span class="string">&quot;Yes&quot;</span>, <span class="string">&quot;No&quot;</span>])</span><br><span class="line"></span><br><span class="line">gr.ChatInterface(random_response).launch()</span><br></pre></td></tr></table></figure><h3 id="streaming"><a href="#streaming" class="headerlink" title="streaming"></a>streaming</h3><p>å¦‚æœåº”ç”¨ç¨‹åºé¢„è®¡æµé‡ä¼šå¾ˆå¤§ï¼Œè¯·ä½¿ç”¨queueï¼ˆï¼‰æ–¹æ³•æ¥æ§åˆ¶å¤„ç†é€Ÿç‡ã€‚</p><p>å¯ä»¥æ­é…Openaiæˆ–è€…Hugging Faceä¸Šçš„å¤§è¯­è¨€æ¨¡å‹ä½¿ç”¨.åŒæ—¶æ­é…LangChainä½¿ç”¨.</p><p>ä¸Šé¢å°±æ˜¯åŸºæœ¬çš„å››ä¸ªå¤§æ¨¡å—,æ­¤å¤–è¿˜æœ‰è®¸å¤šç»„ä»¶,é‡ç‚¹æ˜¯<strong>ä¸€äº›ç»„ä»¶å¦‚ä½•ç»„åˆ</strong>,ä¸€èˆ¬æ¥è¯´ä½¿ç”¨<code>gr.Blocks</code>è¿›è¡Œæ„å»º.</p><h2 id="èµ„æ–™"><a href="#èµ„æ–™" class="headerlink" title="èµ„æ–™"></a>èµ„æ–™</h2><ol><li><a href="https://www.gradio.app/guides">Gradio Guides</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Gradioå¥½å•Š,å¥½å•Š,å¥½å•Š.Hugging Faceå¥½å•Š,å¥½å•Š.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
