<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sekyoroçš„åšå®¢å°å±‹</title>
  
  
  <link href="https://www.sekyoro.top/atom.xml" rel="self"/>
  
  <link href="https://www.sekyoro.top/"/>
  <updated>2024-09-05T06:16:50.189Z</updated>
  <id>https://www.sekyoro.top/</id>
  
  <author>
    <name>Sekyoro</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¤§æ¨¡å‹å¹»è§‰</title>
    <link href="https://www.sekyoro.top/2024/09/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B9%BB%E8%A7%89/"/>
    <id>https://www.sekyoro.top/2024/09/05/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%B9%BB%E8%A7%89/</id>
    <published>2024-09-05T06:15:40.000Z</published>
    <updated>2024-09-05T06:16:50.189Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>å¤§æ¨¡å‹å¹»è§‰ç ”ç©¶,ä¸»è¦æ¥è‡ªäº<a href="https://lilianweng.github.io/posts/2024-07-07-hallucination/">Extrinsic Hallucinations in LLMs | Lilâ€™Log (lilianweng.github.io)</a></p><span id="more"></span><blockquote><p>å¤§å‹è¯­è¨€æ¨¡å‹ä¸­çš„å¹»è§‰é€šå¸¸æ˜¯æŒ‡äº§ç”Ÿä¸å¿ å®ã€æé€ ã€ä¸ä¸€è‡´æˆ–æ— æ„ä¹‰å†…å®¹çš„æ¨¡å‹ã€‚ä½œä¸ºä¸€ä¸ªæœ¯è¯­ï¼Œå¹»è§‰åœ¨æŸç§ç¨‹åº¦ä¸Šè¢«æ¨å¹¿åˆ°æ¨¡å‹å‡ºé”™çš„æƒ…å†µã€‚åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³æŠŠå¹»è§‰çš„é—®é¢˜ç¼©å°åˆ°æ¨¡å‹è¾“å‡ºæ˜¯è™šæ„çš„ï¼Œè€Œä¸æ˜¯åŸºäºæ‰€æä¾›çš„èƒŒæ™¯æˆ–ä¸–ç•ŒçŸ¥è¯†çš„æƒ…å†µã€‚</p></blockquote><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤§æ¨¡å‹å¹»è§‰ç ”ç©¶,ä¸»è¦æ¥è‡ªäº&lt;a href=&quot;https://lilianweng.github.io/posts/2024-07-07-hallucination/&quot;&gt;Extrinsic Hallucinations in LLMs | Lilâ€™Log (lilianweng.github.io)&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="hallucination" scheme="https://www.sekyoro.top/tags/hallucination/"/>
    
  </entry>
  
  <entry>
    <title>cs144:intro to computer network</title>
    <link href="https://www.sekyoro.top/2024/09/01/cs144-intro-to-computer-network/"/>
    <id>https://www.sekyoro.top/2024/09/01/cs144-intro-to-computer-network/</id>
    <published>2024-09-01T11:50:34.000Z</published>
    <updated>2024-09-09T03:51:59.736Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>å¼€å§‹è®¡åˆ’åšç‚¹è®¡ç®—æœºè¯¾ç¨‹lab,æ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿã€å¹¶è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿ,è®¡ç®—æœºç½‘ç»œ,æ•°æ®åº“ç³»ç»Ÿç­‰ç­‰.<br><span id="more"></span></p><h2 id="Lab0"><a href="#Lab0" class="headerlink" title="Lab0"></a>Lab0</h2><p>ç¬¬ä¸€ä¸ªé¡¹ç›®minnow,çœ‹çœ‹<code>CMakeLists.txt</code>,å†™å¾—æ˜¯çœŸçš„å¥½.</p><p>é¦–å…ˆç¡®ä¿generatorå¿…é¡»æ˜¯Unix Makefiles,ç„¶åä¿è¯out of build(ä¹Ÿå°±æ˜¯srcå’Œbuildç›®å½•ä¸åŒ,ä½¿ç”¨cmake -B build)</p><p>ç„¶åæ·»åŠ å…¶ä»–è¾…åŠ©cmakeè„šæœ¬,è¿™é‡Œé€šè¿‡<code>include</code>æŒ‡ä»¤æ·»åŠ ,åº”è¯¥æ˜¯ä¸ºäº†è®¿é—®çˆ¶ä½œç”¨åŸŸçš„å˜é‡. ç„¶åæ·»åŠ å¤´æ–‡ä»¶ç›®å½•,æœ€åä½¿ç”¨<code>add_subdirectory</code>æ·»åŠ éœ€è¦ç¼–è¯‘çš„å­é¡¹ç›®.æ¯ä¸ªç›®å½•ä¸‹éƒ½æ˜¯ä¸€ä¸ª<code>CMakeLists.txt</code>,è®¾ç½®<code>CMAKE_EXPORT_COMPILE_COMMANDS</code>å¾—åˆ°ç¼–è¯‘æŒ‡ä»¤(ä¹Ÿæ˜¯ä¸ºäº†æ­é…ä¸€äº›ç¼–è¾‘å™¨ä½¿ç”¨).å…‰æ˜¯CmakeLists.txtå°±å­¦åˆ°å¾ˆå¤šc++é¡¹ç›®ç»„ç»‡çš„çŸ¥è¯†.</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.24</span>.<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(minnow CXX)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;CMAKE_GENERATOR&#125;</span> <span class="keyword">STREQUAL</span> <span class="string">&quot;Unix Makefiles&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_MAKE_PROGRAM <span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/scripts/make-parallel.sh&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span> <span class="keyword">STREQUAL</span> <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>)</span><br><span class="line">  <span class="keyword">message</span>(FATAL_ERROR <span class="string">&quot;Minnow must be built outside its source directory, e.g. `cmake -B build`.&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(etc/build_type.cmake)</span><br><span class="line"><span class="keyword">include</span>(etc/cflags.cmake)</span><br><span class="line"><span class="keyword">include</span>(etc/scanners.cmake)</span><br><span class="line"><span class="keyword">include</span>(etc/tests.cmake)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/util&quot;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/src&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/util&quot;</span>)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/src&quot;</span>)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/tests&quot;</span>)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/apps&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure><p>åœ¨æ·»åŠ çš„cmakeè„šæœ¬ä¸­,åŒ…æ‹¬è®¾ç½®æ„å»ºç±»å‹çš„(Debugæˆ–Release),ä¸€äº›ç¼–è¯‘å™¨è®¾ç½®,clang-tidyå’Œformatç”¨äºè¯­æ³•æç¤ºå’Œæ ¼å¼åŒ–,ä»¥åŠä¸€äº›æµ‹è¯•.</p><p>åœ¨ä»£ç ä¸­,è®¸å¤šc++17å’Œ20æ–°ä¸œè¥¿éƒ½ç”¨ä¸Šäº†,æ¯”å¦‚string_view,spanç­‰,</p><p>ç¬¬ä¸€æ¬¡ä½œä¸šè¦æ±‚å†™ä¸€ä¸ªbytestreamçš„readerå’Œwriter,åˆ†åˆ«è¯»å–å’Œå†™å…¥å­—èŠ‚æµ. æˆ‘çœ‹äº†ä¸€äº›ç½‘ä¸Šçš„å®ç°,å¤ªå“äººäº†,è¿˜ä½¿ç”¨<code>`std::deque</code>ç­‰å®¹å™¨,æ ¹æœ¬æ²¡å¿…è¦,è¿˜å¯èƒ½åœ¨æäº¤æµ‹è¯•æ—¶å‡ºç°heap overflow. ç›´æ¥ä½¿ç”¨stringå³å¯,ç†Ÿæ‚‰ä¸€ä¸‹ä¸€äº›STLå¸¸ç”¨æ“ä½œ.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;byte_stream.hh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">ByteStream::<span class="built_in">ByteStream</span>(<span class="keyword">uint64_t</span> capacity) : <span class="built_in">capacity_</span>(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Writer::is_closed</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> _is_closed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Writer::push</span><span class="params">(string data)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  std::<span class="keyword">size_t</span> data_len = data.<span class="built_in">length</span>();</span><br><span class="line">  std::<span class="keyword">size_t</span> avai_cap = <span class="keyword">this</span>-&gt;<span class="built_in">available_capacity</span>();</span><br><span class="line">  <span class="keyword">if</span> (data_len &gt;= avai_cap) &#123;</span><br><span class="line">    _buffer.<span class="built_in">insert</span>(_buffer.<span class="built_in">end</span>(), data.<span class="built_in">begin</span>(), data.<span class="built_in">begin</span>() + avai_cap);</span><br><span class="line">    push_counts += avai_cap;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _buffer.<span class="built_in">insert</span>(_buffer.<span class="built_in">end</span>(), data.<span class="built_in">begin</span>(), data.<span class="built_in">end</span>());</span><br><span class="line">    push_counts += data_len;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Writer::close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  _is_closed = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">Writer::available_capacity</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> capacity_ - _buffer.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">Writer::bytes_pushed</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> push_counts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Reader::is_finished</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> _is_closed &amp;&amp; _buffer.<span class="built_in">empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">Reader::bytes_popped</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> pop_counts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string_view <span class="title">Reader::peek</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">if</span> (_buffer.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  string_view sv&#123;&amp;*_buffer.<span class="built_in">begin</span>(), _buffer.<span class="built_in">size</span>()&#125;;</span><br><span class="line">  <span class="keyword">return</span> sv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reader::pop</span><span class="params">(<span class="keyword">uint64_t</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">if</span> (_buffer.<span class="built_in">size</span>() &lt;= len) &#123;</span><br><span class="line">    pop_counts += _buffer.<span class="built_in">size</span>();</span><br><span class="line">    _buffer.<span class="built_in">clear</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _buffer.<span class="built_in">assign</span>(_buffer.<span class="built_in">begin</span>() + len, _buffer.<span class="built_in">end</span>());</span><br><span class="line">    pop_counts += len;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">Reader::bytes_buffered</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Your code here.</span></span><br><span class="line">  <span class="keyword">return</span> _buffer.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/09/03/7M1R6WH3g8iKQdc.png" alt="image-20240903120538215"></p><blockquote><p>åé¢æˆ‘çœ‹åˆ°æœ‰äººä½¿ç”¨queue\<string>,æ•ˆæœè¿˜ä¸é”™.æ‰€ä»¥æˆ‘åˆæ”¹äº†ğŸ˜…</p><p>é€»è¾‘æ˜¯æ¯æ¬¡pushæ•°æ®,éƒ½æ˜¯æ¨ä¸€ä¸ªæ–°çš„string,å¦‚æœæ²¡æœ‰è¶…è¿‡å®¹é‡ç›´æ¥æ¨,å¦‚æœè¶…äº†å°±æˆªæ–­åå†æ¨.</p><p>popæ•°æ®æ—¶,å¦‚æœqueueä¸­stringæ•°æ®é•¿åº¦å¤§äºlen,å°±ä¸éœ€è¦å°†è¯¥æ•°æ®popæ‰,è€Œæ˜¯è®¾ç½®ä¸ºremoved_prefix,æ–¹ä¾¿peekæ—¶è¿”å›. å¦‚æœå°äºç­‰äº,å°±å°†å…¶æ¨æ‰å†çœ‹ä¸‹ä¸€ä¸ªstringçš„é•¿åº¦.</p></blockquote><h2 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h2><p>ç¬¬ä¸€ä¸ªå®éªŒå°±æŠ˜ç£¨äº†æˆ‘å¾ˆä¹…,å†™ä¸€ä¸ªå¯¹ä¹±åº(æ˜¯æŒ‡çš„å‘é€çš„æ•°æ®æ®µçš„åºåˆ—æ˜¯ä¹±çš„,æ•°æ®æ®µsubstringå†…éƒ¨æ˜¯é¡ºåºçš„)çš„å­—èŠ‚æµè¿›è¡Œé‡æ’çš„reassembler.</p><p><img data-src="https://s2.loli.net/2024/09/06/gJCwbV4RtfLrW9j.png" alt="image-20240906172137248"></p><p>é‡ç‚¹å°±æ˜¯ä¸Šé¢çš„å›¾,ç»¿è‰²åŠ çº¢è‰²çš„æ®µè½æ˜¯å›ºå®šé•¿åº¦å¹¶ä¸”åªä¼šå¾€å³ç§»åŠ¨åˆ°å‘é€è¿‡æ¥çš„æ•°æ®æœ€å¤§é•¿åº¦.</p><p>å¦‚æœæ¥çš„æ•°æ®æ®µfirst_indexä¸ºfirst_unasembled_index,é‚£å°±è¯´æ˜æ¥å¯¹äº†.ä½†æ˜¯åœ¨pushåˆ°bytestreamä¹‹å‰,éœ€è¦æ³¨æ„å¯èƒ½æœ‰é‡å éƒ¨åˆ†,</p><p><img data-src="https://s2.loli.net/2024/09/06/cgsVmdDfLGSXWBj.png" alt="image-20240906172716413"></p><p>æ¯”å¦‚ä¸Šé¢æœ‰é‡å éƒ¨åˆ†,éœ€è¦æˆªæ–­æ•°æ®,æ¯”è¾ƒå¥½çš„æ–¹æ³•æ˜¯å°†incoming dataå‰é¢æ²¡æœ‰é‡å çš„éƒ¨åˆ†å–å‡ºæ¥ä½œä¸ºæ–°çš„æ•°æ®,åé¢å‡†å¤‡ç›´æ¥pushåˆ°bytestream</p><p><img data-src="https://s2.loli.net/2024/09/06/RvQ3uFjrKMeIVwX.png" alt="image-20240906173236584"></p><p>æœ‰äººå°±è¦é—®äº†,ä¸ºå•¥ä¸ç›´æ¥å°†è¿™æ®µæ•°æ®ç›´æ¥éƒ½æ¨è¿›å»,å°±åƒä¸‹å›¾ä¸­çº¢æ¡†è¿™æ ·,å¦‚æœåƒä¸Šé¢é‚£æ ·æˆªæ–­,ä¸å°±è¦åé¢å¤šæ¨ä¸€æ¬¡å—ï¼Ÿ</p><p><img data-src="https://s2.loli.net/2024/09/06/84oJBaVHhO1PkDj.png" alt="image-20240906173340799"></p><p>ç†è®ºä¸Šæ¥è¯´ä¹Ÿæ˜¯å¯è¡Œçš„,åŒ…æ‹¬ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·æˆªæ–­,ä½†éšå«çš„é—®é¢˜æ˜¯,è¿™ä¸¤ç§æ–¹æ³•åé¢çš„æ•°æ®éƒ½æœ‰å¯èƒ½overlap.</p><p><img data-src="https://s2.loli.net/2024/09/06/wGFBxXy8jOcgWkr.png" alt="image-20240906173540255"></p><p>è€Œåƒç¬¬ä¸€ç§æˆªæ–­æ–¹æ³•ä¸­ç»¿è‰²é‚£ä¸€æ®µæ•°æ®å°±ä¸ä¼šæœ‰overlap.  è€Œä¸”åé¢çš„æ•°æ®é‡å¤æ®µå¯èƒ½ä¸æ­¢ä¸€ä¸ª,éœ€è¦è¿ç»­å¤„ç†çŸ¥é“å¤„ç†å®Œåé¢çš„æ‰€æœ‰æ•°æ®æˆ–è€…éƒ¨åˆ†é‡å .</p><p>å¦‚æœæ˜¯å®Œå…¨é‡å ,å°±å¯ä»¥ç›´æ¥åˆ æ‰è¿™æ®µ,æ¯”å¦‚ä¸‹é¢çš„çº¢è‰²æ®µæ•°æ®.</p><p><img data-src="https://s2.loli.net/2024/09/06/UjCw2PEJ9mtbeAp.png" alt="image-20240906174432079"></p><p>é™¤äº†å¯¹åé¢çš„æ•°æ®åšæˆªæ–­,é’ˆå¯¹æ’åœ¨å‰é¢çš„æ•°æ®ä¹Ÿæ˜¯ç±»ä¼¼. æ³¨æ„,åœ¨è¿™é‡Œå¹¶æ²¡æœ‰å¯¹è¶…è¿‡first_unaccepted_indexçš„æ•°æ®æ®µè¿›è¡Œæˆªå–.</p><p><img data-src="https://s2.loli.net/2024/09/06/letiLN4d5mMpsHS.png" alt="image-20240906173933135"></p><p>æ€»çš„æ¥è¯´,é¦–å…ˆéœ€è¦å¯¹æ•°æ®çš„first_indexå’Œå¤§å°è¿›è¡Œè°ƒæ•´,æ¯”å¦‚æˆªæ–­å•¥çš„. ä½¿å¾—å®ƒæ²¡æœ‰ä¸å…¶ä»–æ•°æ®æ®µé‡å .</p><p>ç„¶åå°±æ˜¯åˆ¤æ–­æ›´æ–°åçš„first_indexä¸first_unassemble_index,å¦‚æœç›¸ç­‰,pushæ•°æ®(ç”±äºåœ¨ä¸Šä¸€èŠ‚pushçš„å®ç°ä¸­,å¦‚æœæ•°æ®é•¿åº¦å¤§äºcapacity,å°±åªä¼šå°†æ•°æ®å¡«æ»¡,è¶…è¿‡çš„æ•°æ®å¿½ç•¥),å¦åˆ™æ”¾åœ¨ä¸€ä¸ªmap<uint64_t,string>ä¸­,ç§°ä¸ºsubstrings,æ³¨æ„è¿™é‡Œæœ‰å¤šç§é€‰æ‹©,ä½ å¯ä»¥å°†å…¶è¶…è¿‡first_unassemble_indexçš„æ®µæˆªæ–­,ä¹Ÿå¯ä»¥å…ˆç›´æ¥æ¨è¿›å»,åé¢å†å¤„ç†,ä½†ä¸ºäº†èŠ‚çœå†…å­˜,å¯ä»¥ç›´æ¥å…ˆæˆªæ–­.</p><p>å¯èƒ½åˆ°è¿™é‡Œæœ‰äººä»¥ä¸ºå·²ç»ç»“æŸäº†,ä½†å½“æ¨é€äº†æŸä¸ªæ•°æ®ä¹‹å,å¯èƒ½åé¢çš„substringså°±èƒ½ä½¿ç”¨ä¸Šäº†,å°±éœ€è¦è¿›è¡Œå¤„ç†.å¦‚æœæ˜¯next_assembled_idx(å…¶å®å°±æ˜¯first_unassemble_idx==bytes_pushed),å°±ç»§ç»­æ¨,å› ä¸ºå‰é¢å­˜substringsä¸­çš„æ•°æ®æ—¶å·²ç»è€ƒè™‘åˆ°äº†æˆªæ–­è¶…è¿‡first_unassemble_indexçš„æ•°æ®,æ•°æ®é•¿åº¦åŠ èµ·æ¥è‚¯å®šå°äºå®¹é‡,è¿™é‡Œç›´æ¥æ¨è¿›å»å°±è¡Œäº†.</p><p><img data-src="https://s2.loli.net/2024/09/06/Czik8Pc4KM2rBHE.png" alt="image-20240906173613597" style="zoom:50%;" /></p><h2 id="Lab2"><a href="#Lab2" class="headerlink" title="Lab2"></a>Lab2</h2><blockquote><p>TCPæ˜¯ä¸€ç§åè®®ï¼Œå®ƒåœ¨ä¸å¯é çš„æ•°æ®æŠ¥ä¸Šå¯é åœ°ä¼ è¾“ä¸€å¯¹æµæ§åˆ¶çš„å­—èŠ‚æµ(æ¯ä¸ªæ–¹å‘ä¸€ä¸ª)ã€‚åŒæ–¹æˆ–â€œpeersâ€å‚ä¸TCPè¿æ¥ï¼Œæ¯ä¸ªpeerséƒ½å……å½“(å…¶è‡ªèº«è¾“å‡ºå­—èŠ‚æµçš„)â€œå‘é€è€…â€å’Œâ€œæ¥æ”¶è€…â€</p></blockquote><p><img data-src="https://s2.loli.net/2024/09/06/nzAsKGwy4xWNqH3.png" alt="image-20240906180021011"></p><p>é¦–å…ˆéœ€è¦å®ç°ä¸€ä¸ª32-bitçš„ç›¸å¯¹ç´¢å¼•wrapperä¸64ä½ç»å¯¹ç´¢å¼•ç›¸äº’è½¬æ¢.</p><p><img data-src="https://s2.loli.net/2024/09/06/dD4tQgeqRLTm8vj.png" alt="image-20240906234140049"></p><p>è€Œæ³¨æ„åœ¨æ¥å—çš„æ•°æ®æ®µ(stream index),æ˜¯ç›´æ¥ä»0å¼€å§‹,ä¸åŒ…æ‹¬SYNçš„.</p><p>ä»æ¥æ”¶åˆ°çš„absolute seqno-&gt;seqno,ä¹Ÿå°±æ˜¯ä»64ä½è½¬ä¸º32ä½,æ¯”è¾ƒç®€å•,å¯ä»¥é‡‡å–å–ä½™æˆ–è€…ç›´æ¥<code>static_cat&lt;uint32_t&gt;</code>å³å¯,ç›¸å½“äºæŠŠå¤šå‡ºçš„æˆªæ–­.ä»seqno-&gt;absolute seqno,æœ‰éå¸¸å¤šå¯èƒ½,æ¯”å¦‚å‡è®¾seqno-zero_pointçš„å€¼æ˜¯144,é‚£ä¹ˆå°±æœ‰å¯èƒ½æ˜¯144+GAP*k,å…¶ä¸­GAPæ˜¯<code>1UL&lt;&lt;32</code>. æ‰€ä»¥éœ€è¦ä¸€ä¸ªå€¼å¸®åŠ©ç¡®å®š,checkpointå°±æ˜¯è¿™ä¸ªå€¼,ç¦»å®ƒæœ€è¿‘çš„å°±æ˜¯è¿™ä¸ªabsolute seqno. éœ€è¦åšçš„å°±æ˜¯æ±‚k. kæ˜¯(checkpoint-absolute seqno)/(1UL&lt;&lt;32)çš„å››èˆäº”å…¥å€¼.  ä½†æ˜¯è¦æ³¨æ„,å¦‚æœchecpoint&lt;absolute seqno,ä¸Šé¢çš„å…¬å¼å°±ä¼šå‡ºé—®é¢˜.</p><p>å½“checpoint&lt;absolute seqnoæ—¶,ç›´æ¥è¿”å›<code>seqno-zero_point</code>å³å¯.</p><p>åœ¨æ­¤åŸºç¡€ä¸Šéœ€è¦å®ç°TCP receiver.</p><p>å®ƒå°†(1)ä»peerçš„å‘é€æ–¹æ¥æ”¶æ¶ˆæ¯å¹¶ä½¿ç”¨Reassembleré‡æ–°ç»„è£…å­—èŠ‚æµ</p><p>(2)å°†åŒ…å«ç¡®è®¤å·(ackno)å’Œçª—å£å¤§å°çš„æ¶ˆæ¯å‘é€å›peerçš„å‘é€æ–¹.</p><p>æ³¨æ„SYNå’ŒFINå¹¶ä¸åŒ…å«åœ¨æ•°æ®payloadä¸­,ä½†æ˜¯åœ¨è®¡ç®—acknoæ—¶éœ€è¦åŠ ä¸Šç›¸åº”çš„å€¼ä»¥ç¡®å®šéœ€è¦çš„æ•°æ®index. </p><p>æ¥æ”¶åˆ°æ•°æ®æ—¶,å¦‚æœå¸¦æœ‰SYNåˆ™å¯¹åº”çš„seqnoå°±æ˜¯zero_point(å¹¶ä¸æ˜¯æ•°æ®çš„å¼€å§‹,zero_point+1æ‰æ˜¯æ•°æ®),æˆ‘ä»¬æœ¬èº«éœ€è¦çš„æ˜¯å‘è¿‡æ¥çš„æ•°æ®åœ¨absolute seqnoä¸­çš„ç´¢å¼•,ä½†è¿™ä¸ªå€¼æˆ‘ä»¬æ— æ³•ç¡®å®š,checkpointå¯ä»¥è®¾ç½®ä¸ºbytes_pushedä¹Ÿå°±æ˜¯first_unassembled_index,å› ä¸ºè¿™æ˜¯æˆ‘ä»¬éœ€è¦çš„å€¼.åœ¨è·å¾—absolute seqnoåè¿˜éœ€è¦-1é™¤å»SYN,ç„¶åå†insertæ•°æ®. å¦‚æœwriterå…³é—­åˆ™è®¾ç½®FINå…³é—­,æ–¹ä¾¿åé¢sendåŠæ—¶å…³é—­.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TCPSenderMessage</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Wrap32 seqno &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">bool</span> SYN &#123;&#125;;</span><br><span class="line">std::string payload &#123;&#125;;</span><br><span class="line"><span class="keyword">bool</span> FIN &#123;&#125;;</span><br><span class="line"><span class="keyword">bool</span> RST &#123;&#125;;</span><br><span class="line"><span class="comment">// How many sequence numbers does this segment use?</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">sequence_length</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> SYN + payload.<span class="built_in">size</span>() + FIN; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TCPReceiverMessage</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">std::optional&lt;Wrap32&gt; ackno &#123;&#125;;</span><br><span class="line"><span class="keyword">uint16_t</span> window_size &#123;&#125;;</span><br><span class="line"><span class="keyword">bool</span> RST &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPReceiver</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">// Construct with given Reassembler</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">TCPReceiver</span><span class="params">( Reassembler&amp;&amp; reassembler )</span> : reassembler_( std::move( reassembler ) ) &#123;</span>&#125;</span><br><span class="line"><span class="comment">// The TCPReceiver receives TCPSenderMessages from the peer&#x27;s TCPSender.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receive</span><span class="params">( TCPSenderMessage message )</span></span>;</span><br><span class="line"><span class="comment">// The TCPReceiver sends TCPReceiverMessages to the peer&#x27;s TCPSender.</span></span><br><span class="line"><span class="function">TCPReceiverMessage <span class="title">send</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// Access the output (only Reader is accessible non-const)</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> Reassembler&amp; <span class="title">reassembler</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> reassembler_; &#125;</span><br><span class="line"><span class="function">Reader&amp; <span class="title">reader</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> reassembler_.<span class="built_in">reader</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">const</span> Reader&amp; <span class="title">reader</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> reassembler_.<span class="built_in">reader</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">const</span> Writer&amp; <span class="title">writer</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> reassembler_.<span class="built_in">writer</span>(); &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">Reassembler reassembler_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨sendä¸­,éœ€è¦è¿”å›acknoå’Œwindow_size,åè€…å°±æ˜¯writer().available_capacity(),ä½†æ³¨æ„å¦‚æœåˆå§‹åŒ–æ—¶è¶…è¿‡äº†å°±è®¾ç½®MAX.</p><p>å‰è€…å°±æ˜¯ç›®å‰æ¥æ”¶åˆ°çš„æ•°æ®åŠ ä¸Šæ ‡å¿—ä½.</p><p>å‘é€æ•°æ®æ—¶é¦–å…ˆåˆå§‹åŒ–SYNä½œä¸ºå¼€å§‹ä½ç½®,å¼€å§‹ä½ç½®ä¹‹åçš„ä¸€ä¸ªä½ç½®æ˜¯æ•°æ®ä½ç½®.å‘é€æ•°æ®æ—¶æºå¸¦è¿™ä¸ªæ ‡å¿—å’Œæ•°æ®payload,åŒæ—¶æ¯æ¬¡åªå…è®¸æœ€å¤šå‘é€uint_32_tæ•°æ®,æ‰€ä»¥å‘é€æ•°æ®æ—¶éœ€è¦å°†åŸæœ¬64ä½çš„ç´¢å¼•è½¬æˆ32ä½</p><blockquote><p>åœ¨TCPæŠ¥å¤´ä¸­ï¼Œç©ºé—´æ˜¯å®è´µçš„ï¼Œæµä¸­çš„æ¯ä¸ªå­—èŠ‚çš„ç´¢å¼•ä¸æ˜¯ç”¨64ä½ç´¢å¼•è¡¨ç¤ºï¼Œè€Œæ˜¯ç”¨32ä½çš„â€œåºåˆ—å·â€æˆ–â€œseqnoâ€è¡¨ç¤ºã€‚è¿™å¢åŠ äº†å¤æ‚æ€§</p></blockquote><p><img data-src="https://s2.loli.net/2024/09/07/gE7IOc6ZdzyKbel.png" alt="image-20240907145920140"></p><p>å½“æ¥æ”¶è€…æ‹¿åˆ°32ä½çš„ç›¸å¯¹ç´¢å¼•æ—¶å¦‚ä½•çŸ¥é“åœ¨ç»å¯¹ä½ç½®ä¸Šçš„ç´¢å¼•å‘¢<img data-src="https://s2.loli.net/2024/09/07/HRkMqCVI5ApihuJ.png" alt="image-20240907151332005"></p><p>å…³é”®æ˜¯ç¡®å®šcheckpoint,å› ä¸ºabsolute seqnoå¯èƒ½æ˜¯k*GAP+offset,offsetæ˜¯å°äºGAPçš„.</p><p>å‡è®¾å¦‚ä¸‹å›¾,å¦‚æœæ­¤æ—¶å‘é€ä¸€ä¸ªä¹‹å‰çš„é‡å¤æ®µ,å®é™…çš„absolute seqnoæ¯”è¾ƒå°,å¦‚æœä½¿ç”¨bytes_pushed,é‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´å¾—åˆ°çš„first_indexæ¯”è¾ƒå¤§. å‡ºç°è¿™ç§æƒ…å†µçš„å‰ææ˜¯,bytes_pushed&gt;uint32_t,å› ä¸ºæ­¤æ—¶ä¼šæœ‰å¤šä¸ªå¯èƒ½çš„ç»å¯¹ä½ç½®,å¦‚æœå†å‘é€ä¹‹å‰çš„æ•°æ®,é‚£ä¹ˆabsolute seqnoçš„first_indexå°±ä¼šé€‰æ‹©é”™è¯¯.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240907152015454.png" alt="image-20240907152015454"></p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240907155828700.png" alt="image-20240907155828700"></p><p>å½“æˆ‘å°è¯•è¿™ä¹ˆæµ‹è¯•æ—¶,è¦ä¹ˆæŠ¥é”™oomè¦ä¹ˆtimeout.</p><h2 id="Lab3"><a href="#Lab3" class="headerlink" title="Lab3"></a>Lab3</h2><p>å®ç°TcpSender.åœ¨æ–‡æ¡£ä¸­éœ€è¦è¦ç‚¹éƒ½è¯´äº†.ä½†æ˜¯æœ‰äº›ç»†èŠ‚è¿˜æ˜¯å®¹æ˜“å¿˜.</p><p>é¦–å…ˆåœ¨pushæ–¹æ³•ä¸­,ä»€ä¹ˆæ—¶å€™å‘é€æ•°æ®?</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240908231650614.png" alt="image-20240908231650614"></p><p>åªè¦æœ‰å¯è¯»æ•°æ®å¹¶ä¸”ç©ºä½™çš„window_sizeå°±èƒ½ä½¿ç”¨transmitè¯»å–æ•°æ®.ä»€ä¹ˆå«åšç©ºä½™çš„window_size,åªè¦window_sizeå¤§äº0å°±èƒ½å‘é€æ•°æ®å—,äº‹å®ä¸Šå¹¶ä¸æ˜¯,æ¯”å¦‚å¦‚æœæˆ‘è¿ç»­å‘é€äº†å¾ˆå¤šæ•°æ®,ä½†æ˜¯window_sizeä¸€ç›´ä¸º0,æˆ‘è¿˜éœ€è¦ä¸æ–­å‘é€ç›´åˆ°è¯»å®Œæ‰€æœ‰æ•°æ®å—,è²Œä¼¼ä¹Ÿæ˜¯å¯è¡Œçš„. æ›´å¥½çš„æ–¹å¼æ˜¯window_sizeå¦‚æœå°äºoutstanding_bytesçš„æ•°é‡,é‚£å°±å…ˆç­‰ç€,ç›´åˆ°æ¥æ”¶åˆ°peerå‘æ¥çš„acknoæ›´æ–°window_size.  æ¯æ¬¡å‘é€çš„æ•°æ®å°±æ˜¯window_size-outstanding_bytes,ä½†æ˜¯æœ‰ä¸ªMAX_PAYLOAD_SIZEçš„é™åˆ¶,å¦å¤–æ³¨æ„å‘é€çš„æ•°æ®å¤§å°æ˜¯åŒ…å«SYNçš„,ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ˜¯å¼€å§‹çš„æ•°æ®,window_size =100,é‚£ä¹ˆåªèƒ½å‘é€99ä¸ªæ•°æ®.payloadå¤§å°æ˜¯99.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240907171424559.png" alt="image-20240907171424559"></p><p>å¦‚ä½•ç¡®å®šsenderéœ€è¦å‘é€FINï¼Ÿ</p><p>é¦–å…ˆreaderéœ€è¦ç»“æŸ,ä¹Ÿå°±æ˜¯reader().is_finished() (æ³¨æ„ä¸æ˜¯bytes_bufferd==0,è¿˜éœ€è¦readerå…³é—­,å› ä¸ºè¿˜æ²¡æœ‰å…³é—­æ—¶ä¹Ÿæœ‰å¯èƒ½å­˜åœ¨bufferä¸ºç©ºçš„æƒ…å†µ).æ­¤å¤–å‰©ä½™çš„æ•°æ®å·²ç»å°äºwindow_size-outstanding_bytes(ç›¸å½“äºpeerè¿˜å‰©çš„ç©ºé—´).</p><p>ç„¶åå‘é€æ•°æ®,å¼€å¯è®¡æ—¶åŒæ—¶å¢åŠ å‘é€çš„indexå’Œoutstanding_bytes,ä¿å­˜å‘é€çš„ä¿¡æ¯. å½“æ¥æ”¶åˆ°acknoå’Œwindow_sizeæ—¶è¿›è¡Œæ›´æ–°çª—å£å¤§å°,å¹¶æ ¹æ®acknoåˆ é™¤æ•°æ®,å¦‚æœç¡®å®è¶…è¿‡äº†ä¿ç•™æ•°æ®çš„ackno+seq_len,é‚£å°±æ›´æ–°ack_abs_seqno,æ­¤å¤–é‡æ–°è®¾ç½®timer,å¦‚æœæ¸…ç©ºäº†outstanding_byte_stream,é‚£å°±å…³é—­å®šæ—¶å™¨,å¦åˆ™è¿˜æ˜¯æ‰“å¼€ä½†éœ€è¦é‡ç½®æ—¶é—´.tickæ–¹æ³•è®¡æ—¶å™¨è¶…æ—¶å¹¶ä¸”è¿˜æœ‰é‡ä¼ æ•°æ®æ—¶,å‘é€æœ€æ—©çš„é‡ä¼ æ•°æ®,é‡ç½®timer,å¦‚æœwindow_sizeä¸ä¸º0,doubleé‡ä¼ æ—¶é—´,é‡ä¼ æ¬¡æ•°+1,èƒŒåçš„é€»è¾‘å¯èƒ½æ˜¯,å¦‚æœwindow_sizeä¸º0,è¡¨ç¤ºpeeræ²¡æœ‰ä»€ä¹ˆè¦æ¥å—çš„,æ²¡æœ‰é‚£ä¹ˆæ€¥</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240908234129034.png" alt="image-20240908234129034"></p><p>æ³¨æ„,å½“window_sizeä¸º0æ—¶,è¯´æ˜peeræ²¡æœ‰éœ€è¦çš„æ•°æ®äº†,ä½†å¦‚æœä¾ç„¶èƒ½å‘é€(&gt;outstanding_bytes),å°±éœ€è¦å¤šå‘é€1byteæ•°æ®æ¥æŸ¥çœ‹peerè¿˜èƒ½å¦æ‰©å±•ç©ºé—´.å¦‚æœæ²¡æœ‰æ•°æ®äº†å°±ä¸å‘äº†. </p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240908235508628.png" alt="image-20240908235508628"></p><p>æƒ³è±¡ä¸€ä¸‹,å¦‚æœpeerä¾ç„¶å‘é€window_size=0,åœ¨tickä¸­æˆ‘ä»¬å°±ä¼šä¸æ–­é‡è¯•,ç›´åˆ°è¶…è¿‡æ¬¡æ•°ç„¶åé€€å‡º.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240908235847377.png" alt="image-20240908235847377" style="zoom:50%;" /></p><h2 id="Lab4"><a href="#Lab4" class="headerlink" title="Lab4"></a>Lab4</h2><p>ä½¿ç”¨ä¹‹å‰çš„å·¥å…·è¿›è¡Œæ•°æ®åˆ†æ.æ— ä»£ç </p><h2 id="Lab5"><a href="#Lab5" class="headerlink" title="Lab5"></a>Lab5</h2><p>åœ¨æœ‰äº†TCPå®ç°ä¹‹å,è¿˜éœ€è¦æ€ä¹ˆå°è£…æ‰èƒ½ä¼ è¾“ä¿¡æ¯?</p><ul><li>TCP-in-UDP-in-IP:TCPæ®µå¯ä»¥åœ¨ç”¨æˆ·æ•°æ®æŠ¥çš„æœ‰æ•ˆè½½è·ä¸­æºå¸¦ã€‚åœ¨æ­£å¸¸(ç”¨æˆ·ç©ºé—´)è®¾ç½®ä¸­å·¥ä½œæ—¶ï¼Œè¿™æ˜¯æœ€å®¹æ˜“å®ç°çš„:Linuxæä¾›äº†ä¸€ä¸ªæ¥å£(â€œæ•°æ®æŠ¥å¥—æ¥å­—â€ï¼ŒUDPSocket)ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºåªæä¾›ç”¨æˆ·æ•°æ®æŠ¥çš„æœ‰æ•ˆè½½è·å’Œç›®æ ‡åœ°å€ï¼Œå†…æ ¸è´Ÿè´£æ„é€ UDPæŠ¥å¤´ã€IPæŠ¥å¤´å’Œä»¥å¤ªç½‘æŠ¥å¤´ï¼Œç„¶åå°†æ•°æ®åŒ…å‘é€åˆ°é€‚å½“çš„ä¸‹ä¸€è·³</li><li>å†…æ ¸ç¡®ä¿æ¯ä¸ªå¥—æ¥å­—å…·æœ‰æœ¬åœ°å’Œè¿œç¨‹åœ°å€å’Œç«¯å£å·çš„ç‹¬å ç»„åˆï¼Œå¹¶ä¸”ç”±äºå†…æ ¸è´Ÿè´£å°†è¿™äº›å†™å…¥UDPå’ŒIPå¤´ï¼Œå› æ­¤å®ƒå¯ä»¥ä¿è¯ä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´çš„éš”ç¦»</li><li>TCP-in-IP:åœ¨é€šå¸¸çš„ç”¨æ³•ä¸­ï¼ŒTCPæ®µå‡ ä¹æ€»æ˜¯ç›´æ¥æ”¾åœ¨äº’è”ç½‘æ•°æ®æŠ¥ä¸­ï¼Œåœ¨IPå’ŒTCPå¤´ä¹‹é—´æ²¡æœ‰UDPå¤´ã€‚è¿™å°±æ˜¯äººä»¬æ‰€è¯´çš„â€œTCP/IPâ€.â€œè¿™æœ‰ç‚¹éš¾ä»¥å®æ–½ã€‚Linuxæä¾›äº†ä¸€ä¸ªç§°ä¸ºTUNè®¾å¤‡çš„æ¥å£ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªå®Œæ•´çš„Internetæ•°æ®æŠ¥ï¼Œå†…æ ¸è´Ÿè´£å…¶ä½™çš„å·¥ä½œ(å†™å…¥ä»¥å¤ªç½‘å¤´ï¼Œå¹¶å®é™…é€šè¿‡ç‰©ç†ä»¥å¤ªç½‘å¡å‘é€ï¼Œç­‰ç­‰)ã€‚ä½†æ˜¯åº”ç”¨ç¨‹åºå¿…é¡»è‡ªå·±æ„é€ å®Œæ•´çš„IPæŠ¥å¤´ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ‰æ•ˆè´Ÿè½½</li><li>TCP-in-IP-in-Ethernet: åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ä»ç„¶ä¾èµ–Linuxå†…æ ¸æ¥å®ç°éƒ¨åˆ†ç½‘ç»œå †æ ˆã€‚æ¯æ¬¡ä»£ç å‘TUNè®¾å¤‡å†™å…¥IPæ•°æ®æŠ¥æ—¶ï¼ŒLinuxéƒ½å¿…é¡»ç”¨IPæ•°æ®æŠ¥ä½œä¸ºæœ‰æ•ˆè´Ÿè½½æ„å»ºä¸€ä¸ªé€‚å½“çš„é“¾è·¯å±‚(ä»¥å¤ªç½‘)å¸§ã€‚è¿™æ„å‘³ç€Linuxå¿…é¡»æ‰¾å‡ºä¸‹ä¸€è·³ä»¥å¤ªç½‘ç›®çš„åœ°å€ï¼Œç»™å®šä¸‹ä¸€è·³çš„IPåœ°å€ã€‚å¦‚æœä¸çŸ¥é“,Linuxå¹¿æ’­ä¸€ä¸ªæŸ¥è¯¢:â€œè°å£°æ˜äº†ä»¥ä¸‹å†…å®¹?IPåœ°å€?ä»¥å¤ªç½‘åœ°å€æ˜¯ä»€ä¹ˆ?ï¼Œç„¶åç­‰å¾…å›å¤ã€‚è¿™äº›åŠŸèƒ½ç”±ç½‘ç»œæ¥å£æ‰§è¡Œ:ä¸€ä¸ªå°†å‡ºç«™IPæ•°æ®æŠ¥è½¬æ¢ä¸ºé“¾è·¯å±‚(ä¾‹å¦‚ï¼Œä»¥å¤ªç½‘)å¸§çš„ç»„ä»¶ï¼Œåä¹‹äº¦ç„¶ã€‚(åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæ¥å£é€šå¸¸æœ‰eth0ã€eth1ã€wlan0ç­‰åç§°)</li></ul><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240908231059785.png" alt="image-20240908231059785" style="zoom: 50%;" /></p><p>è¿™ä¸€èŠ‚è¯´ç™½äº†å°±æ˜¯å®ç°ç®€å•çš„ARP,ä¿å­˜IPåœ°å€ä¸MAC(ä»¥å¤ªç½‘)åœ°å€æ˜ å°„.</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://github.com/Kiprey/sponge/tree/master">Kiprey/sponge: CS144 Lab Assignments (github.com)</a></li><li><a href="https://github.com/Kenshin2438/CS144">Kenshin2438/CS144: CS 144: Introduction to Computer Networking, Winter 2024 (github.com)</a></li><li><a href="https://cs144.github.io/">CS 144: Introduction to Computer Networking</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å§‹è®¡åˆ’åšç‚¹è®¡ç®—æœºè¯¾ç¨‹lab,æ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿã€å¹¶è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿ,è®¡ç®—æœºç½‘ç»œ,æ•°æ®åº“ç³»ç»Ÿç­‰ç­‰.&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>dive deeper into functional programming</title>
    <link href="https://www.sekyoro.top/2024/08/17/dive-deeper-into-functional-programming/"/>
    <id>https://www.sekyoro.top/2024/08/17/dive-deeper-into-functional-programming/</id>
    <published>2024-08-17T06:49:47.000Z</published>
    <updated>2024-08-29T12:43:37.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æˆ‘ä»¬åœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€ä¸­éƒ½èƒ½çœ‹åˆ°ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹,å…¶æœ€åˆèµ·æºäºå¤§å­¦å®éªŒå®¤ã€æ•°å­¦æ¨ç†çš„æ€æƒ³,è™½ç„¶åœ¨ç›®å‰å¤§å‹è½¯ä»¶çš„æºä»£ç ä¸­ç›¸å¯¹OOPç¼–ç¨‹å¹¶æ²¡æœ‰é‚£ä¹ˆå¤š,ä½†æ˜¯åœ¨ä¸€äº›æ ¸å¿ƒæ•°æ®å¤„ç†ä¸­åˆ©ç”¨å‡½æ•°å¼ç¼–ç¨‹èƒ½ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ç¨‹åºæ­£ç¡®æ€§.è¿™é‡Œä½¿ç”¨<a href="https://ocaml.org/">ocaml.org</a>å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹.</p><span id="more"></span><p>ç›¸å¯¹æ¥è¯´,ocaml,elixir,scalaä»¥åŠclojureç­‰åœ¨å·¥ä¸šç•Œç”¨å¾—æ¯”å…¶ä»–è¯­è¨€è¦å¤šä¸€ç‚¹,ä¸»è¦åŸå› ä¸ªäººè®¤ä¸ºè¿˜æ˜¯å¯¹äºå¤§æ•°æ®ã€å¤šçº¿ç¨‹çš„å¤„ç†ä»¥åŠè¯­æ³•ä¸Šçš„å¯è¯»æ€§.  å­¦ä¹ è¿™äº›è¯­è¨€èƒ½å¸®åŠ©æ‰©å±•æ€ç»´ä»¥åŠåœ¨å…¶ä»–ç°ä»£çš„ç¼–ç¨‹è¯­è¨€ä¸­,ä½ å¾ˆå¯èƒ½ä¼šçœ‹è§ç±»ä¼¼çš„è®¾è®¡å’Œæ€æƒ³.</p><p>å‡½æ•°å¼è¯­è¨€çš„è®¾è®¡å¾€å¾€éå¸¸ä¼˜é›…ä¸¥è°¨,ä»¥æ­¤è¾¾åˆ°ç¼–å†™æ­£ç¡®ä¼˜ç¾çš„ä»£ç .ä¸‹é¢ä»¥ocamlä½œä»‹ç».</p><h2 id="è¡¨è¾¾å¼"><a href="#è¡¨è¾¾å¼" class="headerlink" title="è¡¨è¾¾å¼"></a>è¡¨è¾¾å¼</h2><p>OCamlè¯­æ³•çš„ä¸»è¦éƒ¨åˆ†æ˜¯è¡¨è¾¾å¼ã€‚å°±åƒå‘½ä»¤å¼è¯­è¨€ä¸­çš„ç¨‹åºä¸»è¦ç”±å‘½ä»¤æ„å»ºä¸€æ ·ï¼Œå‡½æ•°å¼è¯­è¨€ä¸­çš„ç¨‹åºä¸»è¦ç”±è¡¨è¾¾å¼æ„å»ºã€‚è¡¨è¾¾å¼çš„ä¾‹å­åŒ…æ‹¬2+2å’Œincrement 21</p><p>åœ¨å‡½æ•°å¼è¯­è¨€ä¸­ï¼Œè®¡ç®—çš„ä¸»è¦ä»»åŠ¡æ˜¯å°†è¡¨è¾¾å¼æ±‚å€¼ä¸ºä¸€ä¸ªå€¼ã€‚å€¼æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒä¸éœ€è¦æ‰§è¡Œä»»ä½•è®¡ç®—ã€‚æ‰€ä»¥ï¼Œ<strong>æ‰€æœ‰çš„å€¼éƒ½æ˜¯è¡¨è¾¾å¼ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„è¡¨è¾¾å¼éƒ½æ˜¯å€¼</strong>ã€‚å€¼çš„ä¾‹å­åŒ…æ‹¬2ã€trueå’Œâ€yay!â€</p><h3 id="Assertions"><a href="#Assertions" class="headerlink" title="Assertions"></a>Assertions</h3><p>è¡¨è¾¾å¼assert eæ±‚eçš„å€¼ã€‚å¦‚æœç»“æœä¸ºçœŸï¼Œåˆ™ä¸å†å‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œæ•´ä¸ªè¡¨è¾¾å¼çš„æ±‚å€¼ä¸ºä¸€ä¸ªåä¸ºunitçš„ç‰¹æ®Šå€¼ã€‚unitå†™ä½œ()ï¼Œç±»å‹ä¸ºunitã€‚ä½†å¦‚æœç»“æœä¸ºfalseï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸ã€‚</p><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="literal">()</span> = <span class="keyword">assert</span> (f input1 = output1)</span><br><span class="line"><span class="keyword">let</span> <span class="literal">()</span> = <span class="keyword">assert</span> (f input2 = output2)</span><br><span class="line"><span class="keyword">let</span> <span class="literal">()</span> = <span class="keyword">assert</span> (f input3 = output3)</span><br></pre></td></tr></table></figure><h3 id="ifè¡¨è¾¾å¼"><a href="#ifè¡¨è¾¾å¼" class="headerlink" title="ifè¡¨è¾¾å¼"></a>ifè¡¨è¾¾å¼</h3><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="number">3</span> + <span class="number">5</span> &gt; <span class="number">2</span> <span class="keyword">then</span> <span class="string">&quot;yay!&quot;</span> <span class="keyword">else</span> <span class="string">&quot;boo!&quot;</span></span><br></pre></td></tr></table></figure><h3 id="letè¡¨è¾¾å¼"><a href="#letè¡¨è¾¾å¼" class="headerlink" title="letè¡¨è¾¾å¼"></a>letè¡¨è¾¾å¼</h3><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">42</span> <span class="keyword">in</span> x + <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„<code>let x = 42;;</code>æ˜¯å®šä¹‰è€Œä¸æ˜¯è¡¨è¾¾å¼</p><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">(** [fact n] is [n!].</span></span><br><span class="line"><span class="comment">    Requires: [n &gt;= 0]. *)</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> fact n = <span class="keyword">if</span> n = <span class="number">0</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> n * fact (n - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">let</span> inc x = x + <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> inc = <span class="keyword">fun</span> x -&gt; x + <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">square (inc <span class="number">5</span>);;</span><br><span class="line"><span class="number">5</span> |&gt; inc |&gt; square;;</span><br></pre></td></tr></table></figure><h3 id="é«˜é˜¶å‡½æ•°"><a href="#é«˜é˜¶å‡½æ•°" class="headerlink" title="é«˜é˜¶å‡½æ•°"></a>é«˜é˜¶å‡½æ•°</h3><p>è¿™æ˜¯åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­éå¸¸å¸¸è§çš„,åŒ…æ‹¬map,filter,foldç­‰ç­‰æ“ä½œ</p><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">(** [add1 lst] adds 1 to each element of [lst]. *)</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> add1 = <span class="keyword">function</span></span><br><span class="line">  | <span class="literal">[]</span> -&gt; <span class="literal">[]</span></span><br><span class="line">  | h :: t -&gt; (h + <span class="number">1</span>) :: add1 t</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> lst1 = add1 [<span class="number">1</span>; <span class="number">2</span>; <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> map f = <span class="keyword">function</span></span><br><span class="line">  | <span class="literal">[]</span> -&gt; <span class="literal">[]</span></span><br><span class="line">  | h :: t -&gt; f h :: map f t</span><br><span class="line"></span><br><span class="line"><span class="comment">(** [add1 lst] adds 1 to each element of [lst]. *)</span></span><br><span class="line"><span class="keyword">let</span> add1 = map (<span class="keyword">fun</span> x -&gt; x + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">(** [concat_bang lst] concatenates &quot;!&quot; to each element of [lst]. *)</span></span><br><span class="line"><span class="keyword">let</span> concat_bang = map (<span class="keyword">fun</span> x -&gt; x ^ <span class="string">&quot;!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p x = print_int x; print_newline<span class="literal">()</span>; x + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> lst = map p [<span class="number">1</span>; <span class="number">2</span>]</span><br></pre></td></tr></table></figure><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> filter p = <span class="keyword">function</span></span><br><span class="line">  | <span class="literal">[]</span> -&gt; <span class="literal">[]</span></span><br><span class="line">  | h :: t -&gt; <span class="keyword">if</span> p h <span class="keyword">then</span> h :: filter p t <span class="keyword">else</span> filter p t</span><br></pre></td></tr></table></figure><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> combine op init = <span class="keyword">function</span></span><br><span class="line">            | <span class="literal">[]</span> -&gt; init</span><br><span class="line">            | h::t -&gt; op h (combine op init t)</span><br><span class="line"><span class="keyword">let</span> sum = combine ( + ) <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> concat = combine (^) <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><h2 id="primitive-typeså’Œvalues"><a href="#primitive-typeså’Œvalues" class="headerlink" title="primitive typeså’Œvalues"></a>primitive typeså’Œvalues</h2><p>åŸºæœ¬ç±»å‹æ˜¯å†…ç½®çš„å’Œæœ€åŸºæœ¬çš„ç±»å‹:æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ã€‚å®ƒä»¬å°†è¢«è¯†åˆ«ä¸ºç±»ä¼¼äºå…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­çš„åŸºæœ¬ç±»å‹.</p><p>é™¤äº†ä¸Šé¢ä¹‹å¤–,Ocamlè¿˜æœ‰è®¸å¤šä¸œè¥¿,ä½†æˆ‘ä¹Ÿå°±æ­¢äºæ­¤äº†.ç›®å‰æˆ‘ä¸»è¦å…³æ³¨çš„è¿˜é«˜é˜¶å‡½æ•°</p><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://cs3110.github.io/textbook/chapters/intro/past.html">1.1. The Past of OCaml â€” OCaml Programming: Correct + Efficient + Beautiful (cs3110.github.io)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘ä»¬åœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€ä¸­éƒ½èƒ½çœ‹åˆ°ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹,å…¶æœ€åˆèµ·æºäºå¤§å­¦å®éªŒå®¤ã€æ•°å­¦æ¨ç†çš„æ€æƒ³,è™½ç„¶åœ¨ç›®å‰å¤§å‹è½¯ä»¶çš„æºä»£ç ä¸­ç›¸å¯¹OOPç¼–ç¨‹å¹¶æ²¡æœ‰é‚£ä¹ˆå¤š,ä½†æ˜¯åœ¨ä¸€äº›æ ¸å¿ƒæ•°æ®å¤„ç†ä¸­åˆ©ç”¨å‡½æ•°å¼ç¼–ç¨‹èƒ½ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ç¨‹åºæ­£ç¡®æ€§.è¿™é‡Œä½¿ç”¨&lt;a href=&quot;https://ocaml.org/&quot;&gt;ocaml.org&lt;/a&gt;å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>CUDA101</title>
    <link href="https://www.sekyoro.top/2024/08/16/CUDA101/"/>
    <id>https://www.sekyoro.top/2024/08/16/CUDA101/</id>
    <published>2024-08-16T10:23:41.000Z</published>
    <updated>2024-08-29T12:43:37.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä½œä¸ºæ—¢å¯¹AIåˆå¯¹sysã€hpcæ„Ÿå…´è¶£çš„äººæ¥è¯´,cudaç¼–ç¨‹åº”è¯¥æ˜¯ä¸å¯ä¸çœ‹çš„,æˆ‘ä¹Ÿæ—©æœ‰è€³é—».è¿™é‡Œç®€å•å­¦ä¹ ä¸€ä¸‹.<br><span id="more"></span></p><p>ç›®å‰AIå¤§æ¨¡å‹çš„æ¨ç†ä»¥åŠAI+HPCã€æ·±åº¦å­¦ä¹ ç³»ç»Ÿæ„å»ºç­‰éƒ½éœ€è¦äº†è§£cudaä»¥åŠä½¿ç”¨cudaç¼–ç¨‹,é€šè¿‡ä½¿ç”¨cudaã€c++ä»¥åŠpybindå†™ä¸€äº›æ·±åº¦å­¦ä¹ ç®—å­ç­‰æå‡è¿è¡Œé€Ÿåº¦éƒ½æ˜¯ä¸€äº›å¸¸è§åº”ç”¨é€”å¾„.</p><h2 id="ä»‹ç»CUDA"><a href="#ä»‹ç»CUDA" class="headerlink" title="ä»‹ç»CUDA"></a>ä»‹ç»CUDA</h2><blockquote><p><a href="https://www.geeksforgeeks.org/how-to-run-cuda-c-c-on-jupyter-notebook-in-google-colaboratory/">CUDA</a> stands for Compute Unified Device Architecture. It is an extension of C/C++ programming. CUDA is a programming language that uses the Graphical Processing Unit (GPU). It is a parallel computing platform and an API (Application Programming Interface) model, Compute Unified Device Architecture was developed by Nvidia. This allows computations to be performed in parallel while providing well-formed speed. Using CUDA, one can harness the power of the Nvidia GPU to perform common computing tasks, such as processing matrices and other linear algebra operations, rather than simply performing graphical calculations.</p></blockquote><p><img data-src="https://media.geeksforgeeks.org/wp-content/uploads/20211007112954/UntitledDiagram1.jpg" alt="img" style="zoom:67%;" /></p><ul><li>ä¸Šå›¾å±•ç¤ºäº†16ä¸ªå¹¶è¡Œ(æµ)å¤š(streaming multiprocessor)å¤„ç†å—(digrams)</li><li>æ¯ä¸ªå¹¶è¡Œå¤šå¤„ç†å—æœ‰8ä¸ªå¹¶è¡Œå¤„ç†å™¨(streanming processors),æ‰€ä»¥ä¸€å…±128ä¸ªå¹¶è¡Œå¤„ç†å™¨</li><li>æ¯ä¸ªå¹¶è¡Œå¤„ç†å™¨æœ‰ä¸€ä¸ªä¹˜åŠ å•å…ƒ (Multiplication and Addition Unit)å’Œä¸€ä¸ªåŠ å•å…ƒ(multiplication unit).</li><li>ä¸€å¼ GT200æ˜¾å¡æœ‰30ä¸ªå¹¶è¡Œå¤šå¤„ç†å™¨,æ¯ä¸ªå¤„ç†å™¨æœ‰8ä¸ªå¹¶è¡Œå¤„ç†å™¨,æ‰€ä»¥ä¸€å…±240ä¸ªå¹¶è¡Œå¤„ç†å™¨,æœ‰å¤šä½™1çš„TFLOPå¤„ç†èƒ½åŠ›</li><li>æ¯ä¸ªæµå¤„ç†å™¨éƒ½æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥è¿è¡Œæ•°åƒä¸ªçº¿ç¨‹</li><li>G80å¡æœ‰16ä¸ªæµå¤šå¤„ç†å™¨(SMs)ï¼Œæ¯ä¸ªSMæœ‰8ä¸ªæµå¤„ç†å™¨(SPs)ï¼Œå³æ€»å…±128ä¸ªSPsï¼Œæ¯ä¸ªæµå¤šå¤„ç†å™¨æ”¯æŒ768ä¸ªçº¿ç¨‹(æ³¨æ„:ä¸æ˜¯æ¯ä¸ªSP)ã€‚</li><li>æœ€ç»ˆï¼Œæ¯ä¸ªæµå¼å¤šå¤„ç†å™¨æœ‰ 8 ä¸ª SP åï¼Œæ¯ä¸ª SP æœ€å¤šæ”¯æŒ <strong>768/8 = 96 ä¸ªçº¿ç¨‹</strong>ã€‚å¯åœ¨ 128 ä¸ª SP ä¸Šè¿è¡Œçš„çº¿ç¨‹æ€»æ•° - 128* 96 = 12 228 æ¬¡(=16*768)</li><li>å› æ­¤ï¼Œè¿™äº›å¤„ç†å™¨è¢«ç§°ä¸ºå¤§è§„æ¨¡å¹¶è¡Œå¤„ç†å™¨(massively parallel)ã€‚</li><li>G80 èŠ¯ç‰‡çš„å†…å­˜å¸¦å®½ä¸º 86.4GB/sã€‚</li><li>G80 èŠ¯ç‰‡çš„å†…å­˜å¸¦å®½ä¸º 86.4GB/sï¼Œä¸ CPU ä¹‹é—´çš„é€šä¿¡é€šé“ä¸º 8GB/sï¼ˆ4GB/s ä¸Šä¼ åˆ° CPU RAMï¼Œ4GB/s ä» CPU RAM ä¸‹è½½ï¼‰ã€‚</li></ul><h4 id="CUDAå·¥ä½œ"><a href="#CUDAå·¥ä½œ" class="headerlink" title="CUDAå·¥ä½œ"></a>CUDAå·¥ä½œ</h4><ul><li>GPU ä¸€æ¬¡è¿è¡Œä¸€ä¸ªå†…æ ¸ï¼ˆä¸€ç»„ä»»åŠ¡ï¼‰ã€‚</li><li>æ¯ä¸ªå†…æ ¸ç”±ç‹¬ç«‹çš„ ALU ç»„å—ç»„æˆã€‚</li><li>æ¯ä¸ªåŒºå—åŒ…å«çº¿ç¨‹ï¼Œçº¿ç¨‹æ˜¯è®¡ç®—çš„å±‚æ¬¡ã€‚</li><li>æ¯ä¸ªå—ä¸­çš„çº¿ç¨‹é€šå¸¸å…±åŒè®¡ç®—ä¸€ä¸ªå€¼ã€‚</li><li>åŒä¸€åŒºå—ä¸­çš„çº¿ç¨‹å¯ä»¥å…±äº«å†…å­˜ã€‚</li><li>åœ¨ CUDA ä¸­ï¼Œä» CPU å‘ GPU å‘é€ä¿¡æ¯é€šå¸¸æ˜¯è®¡ç®—ä¸­æœ€å…¸å‹çš„éƒ¨åˆ†ã€‚</li><li>å¯¹æ¯ä¸ªçº¿ç¨‹è€Œè¨€ï¼Œæœ¬åœ°å†…å­˜é€Ÿåº¦æœ€å¿«ï¼Œå…±äº«å†…å­˜æ¬¡ä¹‹ï¼Œå…¨å±€ã€é™æ€å’Œçº¹ç†å†…å­˜é€Ÿåº¦æœ€æ…¢ã€‚</li></ul><h4 id="CUDAä»¥åŠå·¥ä½œæµç¨‹"><a href="#CUDAä»¥åŠå·¥ä½œæµç¨‹" class="headerlink" title="CUDAä»¥åŠå·¥ä½œæµç¨‹"></a>CUDAä»¥åŠå·¥ä½œæµç¨‹</h4><ul><li>å°†æ•°æ®åŠ è½½åˆ° CPU å†…å­˜</li><li>å°†æ•°æ®ä» CPU å¤åˆ¶åˆ° GPU å†…å­˜ - ä¾‹å¦‚ï¼ŒcudaMemcpy(â€¦, cudaMemcpyHostToDevice)</li><li>ä½¿ç”¨è®¾å¤‡å˜é‡è°ƒç”¨ GPU å†…æ ¸ - ä¾‹å¦‚ï¼Œkernel&lt;&lt;&lt;&gt;&gt; (gpuVar)</li><li>å°†ç»“æœä» GPU å¤åˆ¶åˆ° CPU å†…å­˜ - ä¾‹å¦‚ï¼ŒcudaMemcpy(â€¦, cudaMemcpyDeviceToHost)</li><li>åœ¨ CPU ä¸Šä½¿ç”¨ç»“æœ</li></ul><h2 id="ç¼–å†™CUDAä»£ç "><a href="#ç¼–å†™CUDAä»£ç " class="headerlink" title="ç¼–å†™CUDAä»£ç "></a>ç¼–å†™CUDAä»£ç </h2><p>éœ€è¦åœ¨Nvidiaæ˜¾å¡ä¸‹å®‰è£…cudatoolkit,ä»¥ä½¿ç”¨nvccç¼–è¯‘å™¨å’Œä¸€äº›åº“.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__global__ void cuda_hello()&#123;</span><br><span class="line">    printf(&quot;Hello World from GPU!\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    cuda_hello&lt;&lt;&lt;1,1&gt;&gt;&gt;(); </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_<em>global_</em>è¯´æ˜ç¬¦è¡¨ç¤ºåœ¨è®¾å¤‡(GPU)ä¸Šè¿è¡Œçš„å‡½æ•°.è¿™æ ·çš„å‡½æ•°å¯ä»¥é€šè¿‡å®¿ä¸»ä»£ç è°ƒç”¨,ä¾‹å¦‚ç¤ºä¾‹ä¸­çš„main()å‡½æ•°,ä¹Ÿè¢«ç§°ä¸ºâ€œ<em>kernel</em>â€</p><p>å½“è°ƒç”¨å†…æ ¸æ—¶ï¼Œå®ƒçš„æ‰§è¡Œé…ç½®é€šè¿‡&lt;&lt;&lt;â€¦&gt;&gt;&gt;è¯­æ³•ï¼Œä¾‹å¦‚cuda_hello&lt;&lt;<1,1>&gt;&gt;()ã€‚åœ¨CUDAæœ¯è¯­ä¸­ï¼Œè¿™è¢«ç§°ä¸ºâ€œ<em>kernel launch</em>â€</p><p>CPUå’ŒGPUæ˜¯ç‹¬ç«‹çš„å®ä½“ã€‚å®ƒä»¬éƒ½æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ã€‚CPUä¸èƒ½ç›´æ¥è®¿é—®GPUå†…å­˜ï¼Œåä¹‹äº¦ç„¶ã€‚åœ¨CUDAæœ¯è¯­ä¸­ï¼ŒCPUå†…å­˜ç§°ä¸ºä¸»æœºå†…å­˜ï¼ŒGPUå†…å­˜ç§°ä¸ºè®¾å¤‡å†…å­˜ã€‚æŒ‡å‘CPUå’ŒGPUå†…å­˜çš„æŒ‡é’ˆåˆ†åˆ«ç§°ä¸ºä¸»æœºæŒ‡é’ˆå’Œè®¾å¤‡æŒ‡é’ˆ.</p><p>å¯¹äºGPUå¯ä»¥è®¿é—®çš„æ•°æ®ï¼Œå®ƒå¿…é¡»å‘ˆç°åœ¨è®¾å¤‡å†…å­˜ä¸­ã€‚CUDAæä¾›äº†ç”¨äºåˆ†é…è®¾å¤‡å†…å­˜å’Œä¸»æœºä¸è®¾å¤‡å†…å­˜ä¹‹é—´æ•°æ®ä¼ è¾“çš„apiã€‚</p><ol><li>åˆ†ä¸ºå®¿ä¸»å†…å­˜ç»™å®¿ä¸»æ•°æ®</li><li>åˆ†é…è®¾å¤‡å†…å­˜</li><li>å°†è¾“å…¥æ•°æ®ä»å®¿ä¸»å†…å­˜è½¬åˆ°è®¾å¤‡å†…å­˜</li><li>æ‰§è¡Œkernels(_<em>global\</em>_æ ‡è¯† )</li><li>å°†è¾“å‡ºä»è®¾å¤‡è½¬ç§»åˆ°å®¿ä¸»</li></ol><p>CUDAæä¾›äº†å‡ ä¸ªç”¨äºåˆ†é…è®¾å¤‡å†…å­˜çš„å‡½æ•°ã€‚æœ€å¸¸è§çš„æ˜¯<code>cudaMalloc()</code>å’Œ<code>cudaFree()</code></p><p>åˆ†é…äº†GPUå†…å­˜åéœ€è¦å°†cpuå†…å­˜ä¸Šçš„æ•°æ®copyåˆ°è®¾å¤‡ä¸Š,åˆ©ç”¨<code>cudaMemcpy</code></p><p>ç„¶åè°ƒç”¨kernel(å†…æ ¸æ‰§è¡Œé…ç½®&lt;<1,1>&gt;&gt;è¡¨ç¤ºå†…æ ¸å¯åŠ¨æ—¶åªæœ‰1ä¸ªçº¿ç¨‹),åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œ,æœ€åè¿›è¡Œfree<code>cudaFree(void *devPtr);</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cudaMalloc(void **devPtr, size_t count);</span><br><span class="line">cudaFree(void *devPtr);</span><br><span class="line">cudaMemcpy(void *dst, void *src, size_t count, cudaMemcpyKind kind)</span><br></pre></td></tr></table></figure><h4 id="æ€§èƒ½è¯„ä¼°"><a href="#æ€§èƒ½è¯„ä¼°" class="headerlink" title="æ€§èƒ½è¯„ä¼°"></a>æ€§èƒ½è¯„ä¼°</h4><p>NVIDIAæä¾›äº†ä¸€ä¸ªåä¸ºnvprofçš„å‘½ä»¤è¡Œåˆ†æå™¨å·¥å…·ï¼Œå®ƒå¯ä»¥æ›´æ·±å…¥åœ°äº†è§£CUDAç¨‹åºçš„æ€§èƒ½ã€‚</p><p>CUDAä½¿ç”¨å†…æ ¸æ‰§è¡Œé…ç½®&lt;&lt;&lt;â€¦&gt;&gt;&gt;å‘Šè¯‰CUDA<strong>è¿è¡Œæ—¶åœ¨GPUä¸Šå¯åŠ¨å¤šå°‘çº¿ç¨‹</strong></p><p>CUDAå°†çº¿ç¨‹ç»„ç»‡æˆä¸€ä¸ªç§°ä¸ºâ€œthread blockâ€çš„ç»„ã€‚å†…æ ¸å¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹å—ï¼Œç»„ç»‡æˆä¸€ä¸ªâ€œgridâ€ç»“æ„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt; <span class="string">M , T &gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>è¡¨ç¤ºå¯åŠ¨Mä¸ªçº¿ç¨‹å—,æ¯ä¸ªçº¿ç¨‹å—åŒ…æ‹¬Tä¸ªçº¿ç¨‹.</p><h4 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h4><p>CUDAä¸ºè®¿é—®çº¿ç¨‹ä¿¡æ¯æä¾›äº†å†…ç½®å˜é‡ã€‚å…¶ä¸­çš„<code>threadIdx.x</code>å’Œ<code>blockDim.x</code>åˆ†åˆ«è¡¨ç¤º,ä¸€ä¸ªå—å†…çº¿ç¨‹çš„ç´¢å¼•ä»¥åŠä¸€ä¸ªå—ä¸­çº¿ç¨‹æ•°é‡.</p><p>å‡è®¾åœ¨ä¸€ä¸ªå—å†…çš„å¤šä¸ªçº¿ç¨‹æ‰§è¡Œå¹¶è¡Œç¨‹åº.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__global__ void vector_add(float *out, float *a, float *b, int n) &#123;</span><br><span class="line">    int index = 0;</span><br><span class="line">    int stride = 1</span><br><span class="line">    for(int i = index; i &lt; n; i += stride)&#123;</span><br><span class="line">        out[i] = a[i] + b[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://cuda-tutorial.readthedocs.io/en/latest/tutorials/tutorial02/01_parallel_thread.png" alt="parallel thread"></p><p>å‡è®¾Nä¸ªæ•°æ®,ä¸€å…±256ä¸ªçº¿ç¨‹,é‚£ä¹ˆå¯¹äºç¬¬kä¸ªçº¿ç¨‹,å®ƒä¼šæ‰§è¡ŒN/256æ¬¡iteration,æ¯æ¬¡æ‰§è¡Œkernelä¸­çš„ä»£ç </p><h4 id="thread-blocks"><a href="#thread-blocks" class="headerlink" title="thread blocks"></a>thread blocks</h4><p>CUDA gpuæœ‰å‡ ä¸ªå¹¶è¡Œå¤„ç†å™¨ï¼Œç§°ä¸ºæµå¤šå¤„ç†å™¨æˆ–SMsã€‚æ¯ä¸ªSMç”±å¤šä¸ªå¹¶è¡Œå¤„ç†å™¨ç»„æˆï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªå¹¶å‘çº¿ç¨‹å—ã€‚ä¸ºäº†åˆ©ç”¨CUDA gpuï¼Œå†…æ ¸åº”è¯¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹å—ã€‚</p><p>å¯¹äºblock,æœ‰<code>blockIdx.x</code>ä»¥åŠ<code>gridDim.x</code>åˆ†åˆ«è¡¨ç¤ºå—ç´¢å¼•å’Œå—çš„æ•°é‡.</p><p><img data-src="https://cuda-tutorial.readthedocs.io/en/latest/tutorials/tutorial02/02_parallel_block.png" alt="parallel block"></p><p>è¦å°†çº¿ç¨‹åˆ†é…ç»™ç‰¹å®šå…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ¯ä¸ªçº¿ç¨‹çš„å”¯ä¸€ç´¢å¼•ã€‚è¯¥æŒ‡æ•°å¯è®¡ç®—å¦‚ä¸‹</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int tid <span class="operator">=</span> blockIdx.<span class="keyword">x</span> * blockDim.<span class="keyword">x</span> + threadaddx.<span class="keyword">x</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†åˆ©ç”¨å¹¶è¡Œå¤šçº¿ç¨‹çš„ä¼˜åŠ¿(å¦åˆ™å°±æ˜¯å¤šä¸ªçº¿ç¨‹è®¡ç®—ç›¸åŒçš„ä»£ç ),éœ€è¦å°†å¯¹åº”çš„æ•°æ®ç´¢å¼•ä¿®æ”¹ä¸ºçº¿ç¨‹çš„ç´¢å¼•.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#define N 100000</span><br><span class="line">__global__ void addOfblocks(int n, float *x, float *y) &#123;</span><br><span class="line">  int idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  int stride = blockDim.x * gridDim.x;</span><br><span class="line">  for (int i = idx; i &lt; n; i += stride) y[i] = x[i] + y[i];</span><br><span class="line">&#125;</span><br><span class="line">__global__ void addOfThreads(int n, float *x, float *y) &#123;</span><br><span class="line">  int idx = threadIdx.x;</span><br><span class="line">  int stride = blockDim.x;</span><br><span class="line">  for (int i = idx; i &lt; n; i += blockDim) y[i] = x[i] + y[i];</span><br><span class="line">&#125;</span><br><span class="line">int main() &#123;</span><br><span class="line">  float *a, *out;</span><br><span class="line"></span><br><span class="line">  cudaMallocManaged(&amp;a, N * sizeof(float));</span><br><span class="line">  cudaMallocManaged(&amp;out, N * sizeof(float));</span><br><span class="line">  for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">    a[i] = 2;</span><br><span class="line">    b[i] = 4;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add&lt;&lt;&lt;2, 4&gt;&gt;&gt;(N, a, b);</span><br><span class="line">  cudaDeviceSynchronize();</span><br><span class="line"></span><br><span class="line">  cudaFree(a);</span><br><span class="line">  cudaFree(b);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›ä¾‹å­"><a href="#ä¸€äº›ä¾‹å­" class="headerlink" title="ä¸€äº›ä¾‹å­"></a>ä¸€äº›ä¾‹å­</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#define N 10000000</span><br><span class="line">__global__ void vector_add(float* out, float* a, float* b, int n) &#123;</span><br><span class="line">  int stride = 1;</span><br><span class="line">  for (int i = 0; i &lt; n; i += stride) &#123;</span><br><span class="line">    out[i] = a[i] + b[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__global__ void cuda_hello() &#123;</span><br><span class="line">  printf(&quot;Hello from block %d, thread %d\n&quot;, blockDim.x, threadIdx.x);</span><br><span class="line">&#125;</span><br><span class="line">int main() &#123;</span><br><span class="line">  cuda_hello&lt;&lt;&lt;1, 4&gt;&gt;&gt;();</span><br><span class="line">  float *a, *b, *out;</span><br><span class="line">  float *d_a, *d_b, *d_out;</span><br><span class="line">  a = (float*)malloc(N * sizeof(float));</span><br><span class="line">  b = (float*)malloc(N * sizeof(float));</span><br><span class="line">  for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">    a[i] = 2;</span><br><span class="line">  &#125;</span><br><span class="line">  for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">    b[i] = 4;</span><br><span class="line">  &#125;</span><br><span class="line">  out = (float*)malloc(N * sizeof(float));</span><br><span class="line">  cudaMalloc((void**)&amp;d_b, sizeof(float) * N);</span><br><span class="line">  cudaMemcpy(d_b, b, sizeof(float) * N, cudaMemcpyHostToDevice);</span><br><span class="line"></span><br><span class="line">  cudaMalloc((void**)&amp;d_out, sizeof(float) * N);</span><br><span class="line">  cudaMemcpy(d_out, out, sizeof(float) * N, cudaMemcpyHostToDevice);</span><br><span class="line"></span><br><span class="line">  cudaMalloc((void**)&amp;d_a, sizeof(float) * N);</span><br><span class="line">  cudaMemcpy(d_a, a, sizeof(float) * N, cudaMemcpyHostToDevice);</span><br><span class="line">  vector_add&lt;&lt;&lt;1, 1&gt;&gt;&gt;(d_out, d_a, d_b, N);</span><br><span class="line">  cudaMemcpy(out, d_out, sizeof(float) * N, cudaMemcpyDeviceToHost);</span><br><span class="line">  printf(&quot;out[0] = %f\n&quot;, out[0]);</span><br><span class="line">  cudaFree(d_a);</span><br><span class="line">  free(a);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;math.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">// Kernel function to add the elements of two arrays</span><br><span class="line">__global__ void add(int n, float *x, float *y) &#123;</span><br><span class="line">  int idx = threadIdx.x;</span><br><span class="line">  int stride = blockDim.x;</span><br><span class="line">  for (int i = idx; i &lt; n; i+=stride) y[i] = x[i] + y[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void) &#123;</span><br><span class="line">  int N = 1 &lt;&lt; 20;</span><br><span class="line">  float *x, *y;</span><br><span class="line"></span><br><span class="line">  // Allocate Unified Memory â€“ accessible from CPU or GPU</span><br><span class="line">  cudaMallocManaged(&amp;x, N * sizeof(float));</span><br><span class="line">  cudaMallocManaged(&amp;y, N * sizeof(float));</span><br><span class="line"></span><br><span class="line">  // initialize x and y arrays on the host</span><br><span class="line">  for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">    x[i] = 1.0f;</span><br><span class="line">    y[i] = 2.0f;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Run kernel on 1M elements on the GPU</span><br><span class="line">  add&lt;&lt;&lt;1, 1&gt;&gt;&gt;(N, x, y);</span><br><span class="line"></span><br><span class="line">  // Wait for GPU to finish before accessing on host</span><br><span class="line">  cudaDeviceSynchronize();</span><br><span class="line"></span><br><span class="line">  // Check for errors (all values should be 3.0f)</span><br><span class="line">  float maxError = 0.0f;</span><br><span class="line">  for (int i = 0; i &lt; N; i++) maxError = fmax(maxError, fabs(y[i] - 3.0f));</span><br><span class="line">  std::cout &lt;&lt; &quot;Max error: &quot; &lt;&lt; maxError &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  // Free memory</span><br><span class="line">  cudaFree(x);</span><br><span class="line">  cudaFree(y);</span><br><span class="line"></span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h3><ol><li><a href="https://github.com/cuda-mode/lectures?tab=readme-ov-file">cuda-mode/lectures: Material for cuda-mode lectures (github.com)</a></li><li><a href="https://github.com/CodedK/CUDA-by-Example-source-code-for-the-book-s-examples-/tree/master">CodedK/CUDA-by-Example-source-code-for-the-book-s-examples-: CUDA by Example, written by two senior members of the CUDA software platform team, shows programmers how to employ this new technology. The authors introduce each area of CUDA development through working examples. (github.com)</a></li><li><a href="https://gist.github.com/diorahman/648478c2c5c24d819f0f">CUDA Books: Self taught (github.com)</a> maybe this is what all we need.</li><li><a href="https://developer.nvidia.com/blog/even-easier-introduction-cuda/">An Even Easier Introduction to CUDA | NVIDIA Technical Blog</a></li><li><a href="https://github.com/whutbd/cuda-learn-note?tab=readme-ov-file">whutbd/cuda-learn-note: ğŸ‰CUDA ç¬”è®° / é«˜é¢‘é¢è¯•é¢˜æ±‡æ€» / C++ç¬”è®°ï¼Œä¸ªäººç¬”è®°ï¼Œæ›´æ–°éšç¼˜: sgemmã€sgemvã€warp reduceã€block reduceã€dot productã€elementwiseã€softmaxã€layernormã€rmsnormã€hist etc. (github.com)</a></li><li><a href="https://cuda-tutorial.readthedocs.io/en/latest/tutorials/tutorial01/">Tutorial 01: Say Hello to CUDA - CUDA Tutorial (cuda-tutorial.readthedocs.io)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½œä¸ºæ—¢å¯¹AIåˆå¯¹sysã€hpcæ„Ÿå…´è¶£çš„äººæ¥è¯´,cudaç¼–ç¨‹åº”è¯¥æ˜¯ä¸å¯ä¸çœ‹çš„,æˆ‘ä¹Ÿæ—©æœ‰è€³é—».è¿™é‡Œç®€å•å­¦ä¹ ä¸€ä¸‹.&lt;br&gt;</summary>
    
    
    
    
    <category term="cuda" scheme="https://www.sekyoro.top/tags/cuda/"/>
    
  </entry>
  
  <entry>
    <title>typstå­¦ä¹ ä¸å·¥å…·ä½¿ç”¨</title>
    <link href="https://www.sekyoro.top/2024/08/11/typst%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/"/>
    <id>https://www.sekyoro.top/2024/08/11/typst%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/</id>
    <published>2024-08-11T08:51:38.000Z</published>
    <updated>2024-08-29T12:43:42.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ç›®å‰ä½¿ç”¨Latexçš„çš„ä¸€äº›é—®é¢˜,ä¹Ÿæ˜¯å¾ˆå¤šæ–°æ‰‹å¸¸å¸¸é‡åˆ°çš„</p><ul><li>ä¸€äº›å‘½ä»¤ä¸çŸ¥é“åå­—æˆ–è€…ä¸çŸ¥é“æ˜¯å¦æœ‰ç±»ä¼¼çš„å‘½ä»¤,<strong>å®˜æ–¹æ²¡æœ‰å‹å¥½çš„reference</strong>.</li><li><strong>æŠ¥é”™ä¿¡æ¯</strong>æœ‰äº›è®©äººç–‘æƒ‘,ä¸€äº›æ ‡è®°è¯­æ³•å†™æ³•è®©ç¨‹åºå‘˜å¾ˆéš¾å—.</li><li><strong>Latexç¼–è¯‘é€Ÿåº¦å¹¶ä¸å¿«</strong></li><li>æœ¬åœ°ç¼–å†™Latexå…‰è£…ç¯å¢ƒå°±éš¾å€’ä¸€æ‰¹äºº.</li><li>ä¸€äº›åº“ä¹‹é—´å†²çªå¤ªå¤š,æœ‰äº›æ—¶å€™æ’ç‰ˆä¹Ÿä¸è‡ªç„¶.</li></ul><p>äºæ˜¯æˆ‘æƒ³å°è¯•ä¸€äº›typstä½œä¸ºå†™ä¸€äº›å°æ–‡ç« ã€ç®€å†ç”šè‡³slides.</p><span id="more"></span><p>å®˜æ–¹<a href="https://typst.app/">Typst: Compose papers faster</a>æä¾›äº†åœ¨çº¿çš„å·¥å…·<a href="https://typst.app/">Typst: Compose papers faster</a>,ç›®å‰ç¤¾åŒºä¹ŸæŒºæ´»è·ƒçš„,å½“ç„¶å†™å­¦æœ¯è®ºæ–‡å¯èƒ½è¿˜æ˜¯Latexå æ®ç»å¤§å¤šæ•°ç”Ÿæ€,ä¸è¿‡åœ¨å†™ä¸ªäººæ–‡ç« æˆ–è€…ç®€å†æ–¹é¢Typstè¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„</p><p>ä¸‹é¢ä»¥å®˜æ–¹ä»‹ç»å’Œä½¿ç”¨Latexçš„äººçš„è§†è§’å­¦å­¦Typst.é¦–å…ˆå¯ä»¥ä½¿ç”¨vscodeå®‰è£…ç›¸å…³æ’ä»¶æˆ–è€…å®˜æ–¹åœ¨çº¿å·¥å…·æ–¹ä¾¿åä½œ(å¸Œæœ›åæœŸèƒ½è¶…è¶ŠOverleaf).</p><h2 id="Scripting"><a href="#Scripting" class="headerlink" title="Scripting"></a>Scripting</h2><blockquote><p>åƒå†™ä»£ç ä¸€æ ·å†™typst</p></blockquote><h3 id="è¡¨è¾¾å¼"><a href="#è¡¨è¾¾å¼" class="headerlink" title="è¡¨è¾¾å¼"></a>è¡¨è¾¾å¼</h3><p>åœ¨Typstä¸­ï¼Œæ ‡è®°å’Œä»£ç èåˆä¸ºä¸€ä½“ã€‚<strong>é™¤äº†æœ€å¸¸è§çš„å…ƒç´ (åŠ ç²—ã€æ–œä½“ç­‰è¡¨ç¤º)å¤–ï¼Œæ‰€æœ‰å…ƒç´ éƒ½æ˜¯ç”¨å‡½æ•°åˆ›å»ºçš„</strong>ã€‚ä¸ºäº†å°½å¯èƒ½æ–¹ä¾¿ï¼ŒTypstæä¾›äº†ç´§å‡‘çš„è¯­æ³•æ¥å°†ä»£ç è¡¨è¾¾å¼åµŒå…¥åˆ°æ ‡è®°ä¸­:ç”¨#ç¬¦å·å¼•å…¥è¡¨è¾¾å¼ï¼Œåœ¨è¡¨è¾¾å¼å®Œæˆåç»§ç»­æ­£å¸¸çš„æ ‡è®°è§£æã€‚å¦‚æœä¸€ä¸ªå­—ç¬¦å°†ç»§ç»­è¡¨è¾¾å¼ï¼Œä½†åº”è¢«è§£é‡Šä¸ºæ–‡æœ¬ï¼Œåˆ™è¡¨è¾¾å¼å¯ä»¥å¼ºåˆ¶ä»¥åˆ†å·(;)ç»“æŸã€‚</p><h3 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h3><p>æœ‰ä¸¤ç§å—,code blockså’Œcontent block,å¯ä»¥éšæ„åœ°åµŒå¥—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#&#123;</span><br><span class="line">  let a = [from]</span><br><span class="line">  let b = [*world*]</span><br><span class="line">  [hello ]</span><br><span class="line">  a + [ the ] + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»‘å®šå’Œè§£æ„"><a href="#ç»‘å®šå’Œè§£æ„" class="headerlink" title="ç»‘å®šå’Œè§£æ„"></a>ç»‘å®šå’Œè§£æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#let name = &quot;Typst&quot;</span><br><span class="line">This is #name&#x27;s documentation.</span><br><span class="line">It explains #name.</span><br><span class="line"></span><br><span class="line">#let add(x, y) = x + y</span><br><span class="line">Sum is #add(2, 3).</span><br></pre></td></tr></table></figure><p>Letç»‘å®šä¹Ÿå¯ä»¥ç”¨æ¥è§£æ„æ•°ç»„å’Œå­—å…¸ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œèµ‹å€¼çš„å·¦ä¾§åº”è¯¥é•œåƒä¸€ä¸ªæ•°ç»„æˆ–å­—å…¸ã€‚. .æ“ä½œç¬¦å¯ä»¥åœ¨æ¨¡å¼ä¸­ä½¿ç”¨ä¸€æ¬¡ï¼Œä»¥æ”¶é›†æ•°ç»„æˆ–å­—å…¸é¡¹çš„å‰©ä½™éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#let (x, y) = (1, 2)</span><br><span class="line">The coordinates are #x, #y.</span><br><span class="line"></span><br><span class="line">#let (a, .., b) = (1, 2, 3, 4)</span><br><span class="line">The first element is #a.</span><br><span class="line">The last element is #b.</span><br><span class="line"></span><br><span class="line">#let books = (</span><br><span class="line">  Shakespeare: &quot;Hamlet&quot;,</span><br><span class="line">  Homer: &quot;The Odyssey&quot;,</span><br><span class="line">  Austen: &quot;Persuasion&quot;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">#let (Austen,) = books</span><br><span class="line">Austen wrote #Austen.</span><br><span class="line"></span><br><span class="line">#let (Homer: h) = books</span><br><span class="line">Homer wrote #h.</span><br><span class="line"></span><br><span class="line">#let (Homer, ..other) = books</span><br><span class="line">#for (author, title) in other [</span><br><span class="line">  #author wrote #title.</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="æ§åˆ¶è¯­å¥"><a href="#æ§åˆ¶è¯­å¥" class="headerlink" title="æ§åˆ¶è¯­å¥"></a>æ§åˆ¶è¯­å¥</h3><p>ifå’Œloops</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#if 1 &lt; 2 [</span><br><span class="line">  This is shown</span><br><span class="line">] else [</span><br><span class="line">  This is not.</span><br><span class="line">]</span><br><span class="line">#for c in &quot;ABC&quot; [</span><br><span class="line">  #c is a letter.</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">#let n = 2</span><br><span class="line">#while n &lt; 10 &#123;</span><br><span class="line">  n = (n * 2) - 1</span><br><span class="line">  (n,)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><p>ä¼—æ‰€å‘¨çŸ¥,æˆ‘ä»¬å¸¸ç”¨çš„ä¸€äº›æ“ä½œåŒ…æ‹¬é’ˆå¯¹å­—ä½“,åŒ…æ‹¬æ–œä½“ã€åŠ ç²—ã€å„ç§æ•°å­¦æ ¼å¼ï¼Œé’ˆå¯¹å›¾(Figure)ã€è¡¨(Table,å¸¸ç”¨ä¸‰çº¿è¡¨)ã€å…¬å¼(åŒ…æ‹¬å†…è”çš„ä»¥åŠå æ®æ•´è¡Œçš„)ï¿¥%â€¦â€¦&amp;*ï¼ˆ|</p><p><img data-src="https://s2.loli.net/2024/08/11/ygxDBYOMmH2pCv5.png" alt="image-20240811172259678"></p><p>æ­¤å¤–é’ˆå¯¹è®ºæ–‡,æœ‰å¼•ç”¨,è®ºæ–‡å‚è€ƒ,ä½œè€…ä»‹ç»(åœ¨Latexä¸­å¸¸ç”¨<code>\thanks</code>)ç­‰ç­‰.ä¸Šé¢åˆ—ä¸¾äº†ä¸€äº›å¸¸ç”¨ ç´ .</p><p>Typstç›®å‰çš„commandæœ‰markupæ¨¡å¼(é»˜è®¤)å’Œcodeæ¨¡å¼,markupæ¨¡å¼å°±åƒæ˜¯è¾“å…¥æ­£å¸¸çš„å†…å®¹,åœ¨è¿›é˜¶ä¸€ç‚¹å°±æ˜¯é€šè¿‡ä¸€äº›ç®€å•çš„æ ‡è®°markupæ”¹å˜å†…å®¹è¡¨ç°,codeæ¨¡å¼åŠçœ‹èµ·æ¥æ›´å¼ºå¤§,èƒ½è°ƒç”¨è®¸å¤šå‘½ä»¤.</p><p>é€šè¿‡#ä½¿ç”¨codeæ¨¡å¼,[]åœ¨codeæ¨¡å¼ä¸­å°†ä½¿ç”¨content.</p><div class="table-container"><table><thead><tr><th>New mode</th><th>Syntax</th><th>Example</th></tr></thead><tbody><tr><td>Code</td><td>Prefix the code with <code>#</code></td><td><code>Number: #(1 + 2)</code></td></tr><tr><td>Math</td><td>Surround equation with <script type="math/tex">..</script></td><td><script type="math/tex">-x$ is the opposite of $x</script></td></tr><tr><td>Markup</td><td>Surround markup with <code>[..]</code></td><td><code>let name = [*Typst!*]</code></td></tr></tbody></table></div><h2 id="Arguments"><a href="#Arguments" class="headerlink" title="Arguments"></a>Arguments</h2><p>codeæ¨¡å¼å°±åƒå‡½æ•°ä¸€æ ·,æœ‰å‚æ•°,ä¹Ÿéœ€è¦content(ç›¸å½“äºè¾“å…¥).</p><blockquote><p>ä¸€ä¸ªå‡½æ•°å¯ä»¥æœ‰å¤šä¸ªå‚æ•°ã€‚æœ‰äº›å‚æ•°æ˜¯ä½ç½®å‚æ•°ã€‚</p><p>è®¸å¤šå‡½æ•°ä½¿ç”¨å‘½åå‚æ•°è€Œä¸æ˜¯ä½ç½®å‚æ•°æ¥æé«˜å¯è¯»æ€§ã€‚</p></blockquote><p><img data-src="https://s2.loli.net/2024/08/11/iRjep4UnkyCWsOb.png" alt="image-20240811183015272" style="zoom: 80%;" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Typst is an #underline[alternative]</span><br><span class="line">to LaTeX.</span><br><span class="line"></span><br><span class="line">#rect(fill: aqua)[Get started here!]</span><br></pre></td></tr></table></figure><h2 id="Data-Types"><a href="#Data-Types" class="headerlink" title="Data Types"></a>Data Types</h2><div class="table-container"><table><thead><tr><th style="text-align:left">Data type</th><th style="text-align:left">Example</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/foundations/content/">Content</a></td><td style="text-align:left"><code>[*fast* typesetting]</code></td></tr><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/foundations/str/">String</a></td><td style="text-align:left"><code>&quot;Pietro S. Author&quot;</code></td></tr><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/foundations/int/">Integer</a></td><td style="text-align:left"><code>23</code></td></tr><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/foundations/float/">Floating point number</a></td><td style="text-align:left"><code>1.459</code></td></tr><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/layout/length/">Absolute length</a></td><td style="text-align:left"><code>12pt</code>, <code>5in</code>, <code>0.3cm</code>, â€¦</td></tr><tr><td style="text-align:left"><a href="https://typst.app/docs/reference/layout/ratio/">Relative length</a></td><td style="text-align:left"><code>65%</code></td></tr></tbody></table></div><blockquote><p>å†…å®¹å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œå†…å®¹å¯ä»¥åŒ…å«æ ‡è®°ï¼ŒåŒ…æ‹¬å‡½æ•°è°ƒç”¨ï¼Œè€Œå­—ç¬¦ä¸²å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦åºåˆ—</p></blockquote><p>Typstæä¾›æ§åˆ¶æµç»“æ„å’Œæ“ä½œç¬¦ï¼Œä¾‹å¦‚ç”¨äºæ·»åŠ å†…å®¹çš„+æˆ–ç”¨äºæ£€æŸ¥ä¸¤ä¸ªå˜é‡ä¹‹é—´æ˜¯å¦ç›¸ç­‰çš„==</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#if 1 &lt; 2 [</span><br><span class="line">  This is shown</span><br><span class="line">] else [</span><br><span class="line">  This is not.</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="show-rule"><a href="#show-rule" class="headerlink" title="show rule"></a>show rule</h2><p>ä½¿ç”¨showè§„åˆ™ï¼Œæ‚¨å¯ä»¥é‡æ–°å®šä¹‰Typstå¦‚ä½•æ˜¾ç¤ºæŸäº›å…ƒç´ ã€‚æŒ‡å®šTypståº”è¯¥ä»¥ä¸åŒçš„æ–¹å¼æ˜¾ç¤ºå“ªäº›å…ƒç´ ä»¥åŠå®ƒä»¬çš„å¤–è§‚ã€‚Showè§„åˆ™å¯ä»¥åº”ç”¨äºæ–‡æœ¬å®ä¾‹ã€è®¸å¤šå‡½æ•°ï¼Œç”šè‡³æ•´ä¸ªæ–‡æ¡£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#show &quot;ArtosFlow&quot;: name =&gt; box[</span><br><span class="line">  #box(image(</span><br><span class="line">    &quot;logo.svg&quot;,</span><br><span class="line">    height: 0.7em,</span><br><span class="line">  ))</span><br><span class="line">  #name</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/08/11/VjBAwbrCaTmlitu.png" alt="image-20240811220712931" style="zoom:50%;" /></p><p>ä¸Šé¢ç¬¬ä¸€ä¸ªä¹Ÿå¯ä»¥çœç•¥å†…å®¹å‚æ•°,ç›´æ¥å†™å‡½æ•°</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#show</span>: <span class="selector-tag">project</span><span class="selector-class">.with</span>(</span><br><span class="line">  <span class="attribute">theme</span>: rgb(<span class="string">&quot;#0F83C0&quot;</span>),</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">&quot;proanimer&quot;</span>,</span><br><span class="line">  <span class="attribute">title</span>: <span class="string">&quot;Software Engineer&quot;</span>,</span><br><span class="line">  <span class="attribute">contact</span>:(</span><br><span class="line">    contact(</span><br><span class="line">      <span class="attribute">text</span>: <span class="string">&quot;personal blog&quot;</span>,</span><br><span class="line">      <span class="attribute">link</span>: <span class="string">&quot;https://sekyoro.top&quot;</span></span><br><span class="line">    ),</span><br><span class="line">    contact(</span><br><span class="line">      <span class="attribute">text</span>: <span class="string">&quot;gmail&quot;</span>,</span><br><span class="line">      <span class="attribute">link</span>:<span class="string">&quot;mailto:bukalala174@gmail.com&quot;</span></span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="set-rule"><a href="#set-rule" class="headerlink" title="set rule"></a>set rule</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#set heading(numbering: &quot;I.&quot;)</span><br><span class="line">#set text(</span><br><span class="line">  font: &quot;New Computer Modern&quot;</span><br><span class="line">)</span><br><span class="line">#set text(</span><br><span class="line">  font: &quot;New Computer Modern&quot;,</span><br><span class="line">  size: 10pt</span><br><span class="line">)</span><br><span class="line">#set page(</span><br><span class="line">  paper: &quot;a6&quot;,</span><br><span class="line">  margin: (x: 1.8cm, y: 1.5cm),</span><br><span class="line">)</span><br><span class="line">#set par(</span><br><span class="line">  justify: true,</span><br><span class="line">  leading: 0.52em,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>showå’Œsetæ˜¯ä¸¤ç§å…¨å±€è®¾ç½®æ ·å¼çš„è¡¨è¾¾å¼,å·®åˆ«æ˜¯show æ›´ç»†è‡´,é’ˆå¯¹é€‰æ‹©çš„å…ƒç´ </p><ul><li><a href="https://typst.app/docs/reference/text/text/"><code>text</code></a> to set font family, size, color, and other properties of text</li><li><a href="https://typst.app/docs/reference/layout/page/"><code>page</code></a> to set the page size, margins, headers, enable columns, and footers</li><li><a href="https://typst.app/docs/reference/model/par/"><code>par</code></a> to justify paragraphs, set line spacing, and more</li><li><a href="https://typst.app/docs/reference/model/heading/"><code>heading</code></a> to set the appearance of headings and enable numbering</li><li><a href="https://typst.app/docs/reference/model/document/"><code>document</code></a> to set the metadata contained in the PDF output, such as title and autho</li></ul><h3 id="Fieldè·å–"><a href="#Fieldè·å–" class="headerlink" title="Fieldè·å–"></a>Fieldè·å–</h3><p>å¯ä»¥ä½¿ç”¨ç‚¹è¡¨ç¤ºæ³•è®¿é—®å€¼ä¸Šçš„å­—æ®µã€‚å€¼å¯ä»¥æ˜¯:</p><ul><li>a <a href="https://typst.app/docs/reference/foundations/dictionary/">dictionary</a> that has the specified key,</li><li>a <a href="https://typst.app/docs/reference/symbols/symbol/">symbol</a> that has the specified modifier,</li><li>a <a href="https://typst.app/docs/reference/foundations/module/">module</a> containing the specified definition,</li><li><a href="https://typst.app/docs/reference/foundations/content/">content</a> consisting of an element that has the specified field. The available fields match the arguments of the <a href="https://typst.app/docs/reference/foundations/function/#element-functions">element function</a> that were given when the element was constructed.</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#let dict = (greet: &quot;Hello&quot;)</span><br><span class="line">#dict.greet \</span><br><span class="line">#emoji.face</span><br><span class="line"></span><br><span class="line">#let it = [= Heading]</span><br><span class="line">#it.body \</span><br><span class="line">#it.depth</span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜å†™ä¸€ä¸ªç®€å†"><a href="#å®æˆ˜å†™ä¸€ä¸ªç®€å†" class="headerlink" title="å®æˆ˜å†™ä¸€ä¸ªç®€å†"></a>å®æˆ˜å†™ä¸€ä¸ªç®€å†</h2><p>ä½ å¹¶ä¸éœ€è¦çœ‹æ¯ä¸€ä¸ªæ–¹æ³•çš„ä»‹ç»,çœ‹å¤šäº†ä¹Ÿæ²¡ç”¨,å…ˆæ¥çœ‹çœ‹å…¶ä»–äººæ€ä¹ˆå†™çš„.</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>é¦–å…ˆéœ€è¦ä¸€ä¸ªåŸºæœ¬æ¨¡æ¿,æ¨¡æ¿ä¸­åŒ…æ‹¬<strong>è®¾ç½®ä¸€äº›åŸºæœ¬å€¼</strong>,ä»¥åŠ<strong>ä¸€äº›è¾…åŠ©å‡½æ•°</strong>.</p><p>åŸºæœ¬å€¼åŒ…æ‹¬å­—ä½“ã€é¡µé¢ç­‰é…ç½®.ä¸€èˆ¬ä½¿ç”¨<code>#set</code>å’Œ<code>#show</code>è®¾ç½®. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#set par(justify: true)</span><br><span class="line">#set text(</span><br><span class="line">font: &quot;Linux Libertine&quot;,</span><br><span class="line">size: 11pt,</span><br><span class="line">) </span><br><span class="line">#set page(</span><br><span class="line">paper: &quot;us-letter&quot;,</span><br><span class="line">header: align(</span><br><span class="line">  right + horizon,</span><br><span class="line">  title</span><br><span class="line">),</span><br><span class="line">...</span><br><span class="line">)</span><br><span class="line">//è®¾ç½®é¡µé¢,æ®µè½ä¸å­—ä½“</span><br></pre></td></tr></table></figure><p>è€ƒè™‘é€šè¿‡ä¸€ä¸ªshow ruleå’Œå‡½æ•°åŒ…è£…èµ·æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#let conf(title,doc) = &#123;</span><br><span class="line">  set par(justify: true,)</span><br><span class="line">  set text(font:&quot;0xProto Nerd Font Propo&quot;,size:11pt)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#show: doc =&gt; conf(</span><br><span class="line">  &quot;Paper title&quot;,</span><br><span class="line">  doc</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½åå‚æ•°,è¿™æ ·éœ€è¦åœ¨å†™å‡½æ•°æ—¶è®¾ç½®é»˜è®¤å€¼.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#let conf(</span><br><span class="line">  title: none,</span><br><span class="line">  authors: (),</span><br><span class="line">  abstract: [],</span><br><span class="line">  doc,</span><br><span class="line">) = &#123;</span><br><span class="line">  // Set and show rules from before.</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  set align(center)</span><br><span class="line">  text(17pt, title)</span><br><span class="line"></span><br><span class="line">  let count = authors.len()</span><br><span class="line">  let ncols = calc.min(count, 3)</span><br><span class="line">  grid(</span><br><span class="line">    columns: (1fr,) * ncols,</span><br><span class="line">    row-gutter: 24pt,</span><br><span class="line">    ..authors.map(author =&gt; [</span><br><span class="line">      #author.name \</span><br><span class="line">      #author.affiliation \</span><br><span class="line">      #link(&quot;mailto:&quot; + author.email)</span><br><span class="line">    ]),</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  par(justify: false)[</span><br><span class="line">    *Abstract* \</span><br><span class="line">    #abstract</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  set align(left)</span><br><span class="line">  columns(2, doc)</span><br><span class="line">&#125;</span><br><span class="line">#show: doc =&gt; conf(</span><br><span class="line">  title: [Towards Improved Modelling],</span><br><span class="line">  authors: (</span><br><span class="line">    (</span><br><span class="line">      name: &quot;Theresa Tungsten&quot;,</span><br><span class="line">      affiliation: &quot;Artos Institute&quot;,</span><br><span class="line">      email: &quot;tung@artos.edu&quot;,</span><br><span class="line">    ),</span><br><span class="line">    (</span><br><span class="line">      name: &quot;Eugene Deklan&quot;,</span><br><span class="line">      affiliation: &quot;Honduras State&quot;,</span><br><span class="line">      email: &quot;e.deklan@hstate.hn&quot;,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">  abstract: lorem(80),</span><br><span class="line">  doc,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­å†™æ¨¡æ¿,ä½¿ç”¨<code>import</code>å¯¼å…¥å¹¶ä½¿ç”¨å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;conf.typ&quot;: conf</span><br><span class="line">#show: doc =&gt; conf(</span><br><span class="line">  title: [</span><br><span class="line">    Towards Improved Modelling</span><br><span class="line">  ],</span><br><span class="line">  authors: (</span><br><span class="line">    (</span><br><span class="line">      name: &quot;Theresa Tungsten&quot;,</span><br><span class="line">      affiliation: &quot;Artos Institute&quot;,</span><br><span class="line">      email: &quot;tung@artos.edu&quot;,</span><br><span class="line">    ),</span><br><span class="line">    (</span><br><span class="line">      name: &quot;Eugene Deklan&quot;,</span><br><span class="line">      affiliation: &quot;Honduras State&quot;,</span><br><span class="line">      email: &quot;e.deklan@hstate.hn&quot;,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">  abstract: lorem(80),</span><br><span class="line">  doc,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">= Introduction</span><br><span class="line">#lorem(90)</span><br><span class="line"></span><br><span class="line">== Motivation</span><br><span class="line">#lorem(140)</span><br><span class="line"></span><br><span class="line">== Problem Statement</span><br><span class="line">#lorem(50)</span><br><span class="line"></span><br><span class="line">= Related Work</span><br><span class="line">#lorem(200)</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>#import &quot;temp.typ&quot;: *</code>å¯¼å…¥å»æ‰å‘½åç©ºé—´. </p><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Call a function.</span><br><span class="line">#list([A], [B])</span><br><span class="line"></span><br><span class="line">// Named arguments and trailing</span><br><span class="line">// content blocks.</span><br><span class="line">#enum(start: 2)[A][B]</span><br><span class="line"></span><br><span class="line">// Version without parentheses.</span><br><span class="line">#list[A][B]</span><br></pre></td></tr></table></figure><p>å‡½æ•°æ˜¯Typstçš„åŸºæœ¬æ„å»ºå—ã€‚Typstæä¾›äº†å„ç§æ’ç‰ˆä»»åŠ¡çš„å‡½æ•°ã€‚æ­¤å¤–ï¼Œæ‚¨ç¼–å†™çš„æ ‡è®°æ˜¯ç”±å‡½æ•°æ”¯æŒçš„ï¼Œæ‰€æœ‰çš„æ ·å¼éƒ½æ˜¯é€šè¿‡å‡½æ•°å®ç°çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#let alert(body, fill: red) = &#123;</span><br><span class="line">  set text(white)</span><br><span class="line">  set align(center)</span><br><span class="line">  rect(</span><br><span class="line">    fill: fill,</span><br><span class="line">    inset: 8pt,</span><br><span class="line">    radius: 4pt,</span><br><span class="line">    [*Warning:\ #body*],</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#alert[</span><br><span class="line">  Danger is imminent!</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">#alert(fill: blue)[</span><br><span class="line">  KEEP OFF TRACKS</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å‡½æ•°æœ‰<code>with</code>å’Œ<code>where</code>,<code>with</code>è¿”å›ä¸€ä¸ªé¢„å…ˆåº”ç”¨äº†ç»™å®šå‚æ•°çš„æ–°å‡½æ•°</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè¯¥é€‰æ‹©å™¨ç­›é€‰å±äºæ­¤å‡½æ•°çš„å…ƒç´ ï¼Œå…¶å­—æ®µå…·æœ‰ç»™å®šå‚æ•°çš„å€¼</span></span><br><span class="line">#show heading.where(level: 2): set text(blue)</span><br><span class="line"><span class="section">= Section</span></span><br><span class="line"><span class="section">== Subsection</span></span><br><span class="line"><span class="section">=== Sub-subection</span></span><br></pre></td></tr></table></figure><h3 id="çœ‹çœ‹åˆ«äººçš„"><a href="#çœ‹çœ‹åˆ«äººçš„" class="headerlink" title="çœ‹çœ‹åˆ«äººçš„"></a>çœ‹çœ‹åˆ«äººçš„</h3><p>æˆ‘åœ¨Githubä¸Šæœåˆ®äº†ä¸€å †åˆ«äººçš„æ¨¡æ¿,å†™çš„å¾ˆä¸é”™. ä¸»è¦ä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯ä¸Šé¢æåˆ°çš„å‡½æ•°ã€set rule,show ruleä»¥åŠmap,joinç­‰æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">#let contact(text:&quot;&quot;,link:none) = &#123;</span><br><span class="line">  (text:text,link:link)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#let subSection(title:&quot;&quot;,titleEnd:none,subTitle:none,subTitleEnd:none,content:[]) = &#123;</span><br><span class="line">  (title:title,titleEnd:titleEnd,subTitle:subTitle,subTitleEnd:subTitleEnd,content:content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#let section(title:&quot;&quot;,content:subSection()) = &#123;</span><br><span class="line">  (title:title,content:content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#let project(</span><br><span class="line">  theme:rgb(&quot;#4273B0&quot;),</span><br><span class="line">  name:&quot;&quot;,</span><br><span class="line">  email:none,</span><br><span class="line">  title:none,</span><br><span class="line">  contact:((text:[],link:&quot;&quot;)),</span><br><span class="line">  skills:(</span><br><span class="line">    languages:()</span><br><span class="line">  ),</span><br><span class="line">  main:(</span><br><span class="line">   ( title:&quot;&quot;,content:[])</span><br><span class="line">  ),</span><br><span class="line">  sidebar:(),</span><br><span class="line">  body</span><br><span class="line">) = &#123;</span><br><span class="line">  let backgroundTitle(content) = &#123;</span><br><span class="line">    align(center,box(fill:theme,text(white,size:1.25em,weight:&quot;bold&quot;,upper(content)),width:1fr,inset:0.3em))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let secondaryTitle(content) = &#123;</span><br><span class="line">    text(weight:&quot;bold&quot;,size:1.125em,upper(content))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let italicColorTitle(content) = &#123;</span><br><span class="line">    text(weight:&quot;bold&quot;,style:&quot;italic&quot;,size:1.125em,theme,content)</span><br><span class="line">  &#125;</span><br><span class="line">  let contactColumn = align(center)[#contact.map(c =&gt; &#123;</span><br><span class="line">    if c.link == none [</span><br><span class="line">      #c.text\</span><br><span class="line">    ] else [</span><br><span class="line">      #underline(link(c.link,text(theme,c.text)))\</span><br><span class="line">    ]</span><br><span class="line">  &#125;).join()]</span><br><span class="line"></span><br><span class="line">  grid(</span><br><span class="line">    columns:(1fr,2fr),</span><br><span class="line">    column-gutter:2em,</span><br><span class="line">    contactColumn,</span><br><span class="line">    titleColumn</span><br><span class="line">  )</span><br><span class="line">  set par(justify: true)</span><br><span class="line">  let formattedLanguageSkills = [</span><br><span class="line">    #text(skills.languages.join(&quot; â€¢ &quot;))</span><br><span class="line">  ]</span><br><span class="line">  let createLeftRight(left:[],right:none)=&#123;</span><br><span class="line">    if(right == none) &#123;</span><br><span class="line">      align(start,text(left))</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      grid(</span><br><span class="line">        columns:(1fr,1fr),</span><br><span class="line">        align(start,text(left)),</span><br><span class="line">        align(end,right) </span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let parseSubSections(subSections) = &#123;</span><br><span class="line">    subSections.map(s=&gt;&#123;</span><br><span class="line">      [</span><br><span class="line">        #createLeftRight(</span><br><span class="line">          left:secondaryTitle(s.title),</span><br><span class="line">          right:if s.titleEnd != none [</span><br><span class="line">            #italicColorTitle(s.titleEnd)</span><br><span class="line">          ]</span><br><span class="line">        )</span><br><span class="line">        #if s.subTitle != none or s.subTitleEnd != none [</span><br><span class="line">          #text(top-edge: 0.2em,</span><br><span class="line">          createLeftRight(left: italicColorTitle(s.subTile),right:s.subTitleEnd)</span><br><span class="line">          )</span><br><span class="line">        ]</span><br><span class="line">        #s.content</span><br><span class="line">      ]</span><br><span class="line">    &#125;).join()</span><br><span class="line">  &#125;</span><br><span class="line">  let parseSection(seciton) = &#123;</span><br><span class="line">    section.map(m=&gt;&#123;</span><br><span class="line">      [</span><br><span class="line">        #backgroundTitle(m.title),</span><br><span class="line">        #parseSubSections(m.content)</span><br><span class="line">      ]</span><br><span class="line">    &#125;).join()</span><br><span class="line">  &#125;</span><br><span class="line">  let mainSection = parseSection(main)</span><br><span class="line">  let sidebarSection = parseSection(sidebar)</span><br><span class="line">  grid(</span><br><span class="line">    columns: (1fr,2fr),</span><br><span class="line">  column-gutter: 1em,</span><br><span class="line">  sidebarSection,</span><br><span class="line">  mainSection</span><br><span class="line">  )</span><br><span class="line">// Main body.</span><br><span class="line">  set par(justify:true)</span><br><span class="line">  show: columns.with(3,gutter:1.3em)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;template.typ&quot;: *</span><br><span class="line"></span><br><span class="line">#set page(</span><br><span class="line">  margin:(</span><br><span class="line">    left: 10mm,</span><br><span class="line">    right: 10mm,</span><br><span class="line">    top: 15mm,</span><br><span class="line">    bottom: 15mm</span><br><span class="line">  )</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line">#set text(font: &quot;Mulish&quot;)</span><br><span class="line"></span><br><span class="line">#show: project.with(</span><br><span class="line">  theme: rgb(&quot;#0F83C0&quot;),</span><br><span class="line">  name: &quot;proanimer&quot;,</span><br><span class="line">  title: &quot;Software Engineer&quot;,</span><br><span class="line">  contact:(</span><br><span class="line">    contact(</span><br><span class="line">      text: &quot;personal blog&quot;,</span><br><span class="line">      link: &quot;https://sekyoro.top&quot;</span><br><span class="line">    ),</span><br><span class="line">    contact(</span><br><span class="line">      text: &quot;gmail&quot;,</span><br><span class="line">      link:&quot;mailto:bukalala174@gmail.com&quot;</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  main:(</span><br><span class="line">    section(</span><br><span class="line">      title:&quot;Work Experience&quot;,</span><br><span class="line">      content:(</span><br><span class="line">        subSection(</span><br><span class="line">          title: &quot;Freelancer&quot;,</span><br><span class="line">          subTitle: &quot;Software Engineer&quot;,</span><br><span class="line">          content:list(</span><br><span class="line">            [&quot;Developed a personal blog using Gatsby and React, with a focus on performance and accessibility.&quot;],</span><br><span class="line">            [&quot;Implemented a custom CMS using React and Firebase, allowing for easy content management.&quot;],</span><br><span class="line">            [&quot;Optimized the blog for SEO, resulting in a 50% increase in organic traffic.&quot;],</span><br><span class="line">            [&quot;Designed and implemented a custom theme, resulting in a 30% increase in user engagement.&quot;]</span><br><span class="line">          )</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  sidebar:(</span><br><span class="line">    section(</span><br><span class="line">      title: &quot;Skills&quot;,</span><br><span class="line">      content:(</span><br><span class="line">        subSection(</span><br><span class="line">          title: &quot;Languages&quot;,</span><br><span class="line">          content: list(</span><br><span class="line">            [&quot;JavaScript&quot;, &quot;TypeScript&quot;, &quot;Python&quot;, &quot;Java&quot;, &quot;C++&quot;]</span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      section(</span><br><span class="line">        title:&quot;Education&quot;,</span><br><span class="line">        content:(</span><br><span class="line">          subSection(</span><br><span class="line">            title: &quot;University of British Columbia&quot;,</span><br><span class="line">            titleEnd: &quot;Vancouver, BC&quot;,</span><br><span class="line">            subTitle: &quot;Bachelor of Computer Science&quot;,</span><br><span class="line">            subTitleEnd: &quot;(2018 - 2022)&quot;</span><br><span class="line">          )</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è‚¯å®šæ²¡æœ‰å¿…è¦ä½¿ç”¨typstå†™ç®€å†çš„,ä¸»è¦è¿˜æ˜¯æƒ³æ›¿ä»£Latexå†™ç‚¹å°è®ºæ–‡æˆ–è€…æ–‡ç« ,å¯ä»¥æ‹¿ç®€å†ç»ƒç»ƒæ‰‹.</p><p>å¦‚æœçœŸéœ€è¦ç®€å†å¯ä»¥åœ¨ç½‘ä¸Šå¡«å†™ä¿¡æ¯ç›´æ¥ç”Ÿæˆ.</p><h2 id="å¦‚ä½•å†™ä¸€ä¸ªå¹»ç¯ç‰‡"><a href="#å¦‚ä½•å†™ä¸€ä¸ªå¹»ç¯ç‰‡" class="headerlink" title="å¦‚ä½•å†™ä¸€ä¸ªå¹»ç¯ç‰‡"></a>å¦‚ä½•å†™ä¸€ä¸ªå¹»ç¯ç‰‡</h2><blockquote><p>ç”¨æ‰‹æ‹–æ¥æ‹–å»åˆ¶ä½œå¹»ç¯ç‰‡å®åœ¨å¤ªéº»çƒ¦äº†,æˆ‘ä»¬å–œæ¬¢ç®€æ´ã€å¯æ§ä¸é‡ç”¨.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ä¸ºäº†è·¨é¡¹ç›®é‡ç”¨æ„å»ºå—,å¯ä»¥åˆ›å»ºå’Œå¯¼å…¥TypståŒ….åŒ…å¯¼å…¥è¢«æŒ‡å®šä¸ºåç§°ç©ºé—´ã€åç§°å’Œç‰ˆæœ¬çš„ä¸‰å…ƒç»„</span><br><span class="line">#import &quot;@preview/example:0.1.0&quot;: add</span><br><span class="line">#add(2, 7)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¼–ç¨‹çš„æ–¹å¼å†™pptä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿å†™å…¬å¼,å›¾ç‰‡æ‘†æ”¾ä»¥åŠæ›´åŠ ç®€æ´.è¿™é‡Œä½¿ç”¨touyingåŒ…åˆ¶ä½œ,ç›®å‰typstéƒ½æ˜¯ç”Ÿæˆpdfæ ¼å¼çš„,ä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨ç›¸å…³è½¯ä»¶æ’­æ”¾.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;@preview/touying:0.4.2&quot;: *</span><br><span class="line"></span><br><span class="line">#let s = themes.simple.register()</span><br><span class="line">#let (init, slides) = utils.methods(s)</span><br><span class="line">#show: init</span><br><span class="line"></span><br><span class="line">#let (slide, empty-slide) = utils.slides(s)</span><br><span class="line">#show: slides</span><br><span class="line"></span><br><span class="line">= Title</span><br><span class="line"></span><br><span class="line">This is written in Typst.</span><br><span class="line"></span><br><span class="line">== First Slide</span><br><span class="line"></span><br><span class="line">Hello, Touying!</span><br><span class="line">This is written in Typst.</span><br><span class="line">Attention = $frac(Q*K^(T),sqrt(d))*V$</span><br><span class="line"></span><br><span class="line">#pause</span><br><span class="line"></span><br><span class="line">Hello, Typst!</span><br></pre></td></tr></table></figure><p>æœ€åè¯´ä¸€ä¸‹,åˆ©ç”¨<a href="https://github.com/jgm/pandoc">jgm/pandoc: Universal markup converter (github.com)</a>å®Œå…¨å¯ä»¥å®ç°latexä¸typstäº’æ¢.</p><h2 id="ä½¿ç”¨ä½“éªŒ"><a href="#ä½¿ç”¨ä½“éªŒ" class="headerlink" title="ä½¿ç”¨ä½“éªŒ"></a>ä½¿ç”¨ä½“éªŒ</h2><p>ç›®å‰ä½¿ç”¨æ„Ÿè§‰è¿˜æ˜¯å¾ˆä¸é”™,ä¼˜ç‚¹åŒ…æ‹¬ä¸¤ä¸ª</p><ul><li>ä½¿ç”¨å‘½ä»¤è¯­æ³•å¯¹ç¨‹åºå‘˜å‹å¥½,å®˜æ–¹æ–‡æ¡£å…¨é¢</li><li>ç¼–è¯‘é€Ÿåº¦å¿«,æœ¬åœ°å†™ä¹Ÿå¾ˆæ–¹ä¾¿</li></ul><p>å¦‚æœè¦è¯´ç¼ºç‚¹å°±æ˜¯ ç”Ÿæ€ç›¸å¯¹Latexæ²¡é‚£ä¹ˆå¥½,å¦‚æœæƒ³è¦å®ç°ä¸€äº›æ•ˆæœç½‘ä¸Šå¯èƒ½æ²¡æœ‰ç°æˆæ–¹æ³•,æœ‰äº›ä¸œè¥¿ç›®å‰ä¹Ÿæ²¡æœ‰æ”¯æŒ<a href="https://typst.app/docs/roadmap/">Roadmap â€“ Typst Documentation</a></p><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><ol><li><a href="https://typst.app/docs">Typst Documentation</a></li><li><a href="https://typst.app/universe/package/touying/">touying â€“ Typst Universe</a> typstå†™å¹»ç¯ç‰‡, æ­¤å¤–Latexä¹Ÿæœ‰beamer<a href="https://latex-beamer.com/quick-start/">LaTeX Beamer introduction / Quick-start guide - LaTeX Beamer (latex-beamer.com)</a>åº“ç±»ä¼¼çš„åŠŸèƒ½</li><li><a href="https://github.com/jgm/pandoc">jgm/pandoc: Universal markup converter (github.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç›®å‰ä½¿ç”¨Latexçš„çš„ä¸€äº›é—®é¢˜,ä¹Ÿæ˜¯å¾ˆå¤šæ–°æ‰‹å¸¸å¸¸é‡åˆ°çš„&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€äº›å‘½ä»¤ä¸çŸ¥é“åå­—æˆ–è€…ä¸çŸ¥é“æ˜¯å¦æœ‰ç±»ä¼¼çš„å‘½ä»¤,&lt;strong&gt;å®˜æ–¹æ²¡æœ‰å‹å¥½çš„reference&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æŠ¥é”™ä¿¡æ¯&lt;/strong&gt;æœ‰äº›è®©äººç–‘æƒ‘,ä¸€äº›æ ‡è®°è¯­æ³•å†™æ³•è®©ç¨‹åºå‘˜å¾ˆéš¾å—.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Latexç¼–è¯‘é€Ÿåº¦å¹¶ä¸å¿«&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;æœ¬åœ°ç¼–å†™Latexå…‰è£…ç¯å¢ƒå°±éš¾å€’ä¸€æ‰¹äºº.&lt;/li&gt;
&lt;li&gt;ä¸€äº›åº“ä¹‹é—´å†²çªå¤ªå¤š,æœ‰äº›æ—¶å€™æ’ç‰ˆä¹Ÿä¸è‡ªç„¶.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;äºæ˜¯æˆ‘æƒ³å°è¯•ä¸€äº›typstä½œä¸ºå†™ä¸€äº›å°æ–‡ç« ã€ç®€å†ç”šè‡³slides.&lt;/p&gt;</summary>
    
    
    
    
    <category term="å†™ä½œ" scheme="https://www.sekyoro.top/tags/%E5%86%99%E4%BD%9C/"/>
    
  </entry>
  
  <entry>
    <title>profile a deep learning model</title>
    <link href="https://www.sekyoro.top/2024/07/30/profile-a-deep-learning-model/"/>
    <id>https://www.sekyoro.top/2024/07/30/profile-a-deep-learning-model/</id>
    <published>2024-07-30T07:34:36.000Z</published>
    <updated>2024-07-31T03:54:33.021Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>è¿™æ˜¯å¤§å‹è½¯ä»¶ã€ç®—æ³•å¼€å‘ä¸­å®¹æ˜“è¢«å¿½è§†åŒæ—¶ä¹Ÿå¹¶ä¸ç®€å•çš„ä¸€ç¯,å¦‚ä½•åˆ†æä¸€ä¸ªç¨‹åº.è¿™æ¶‰åŠåˆ°åˆ†æå†…å­˜ã€ä½¿ç”¨ä¸€ç³»åˆ—ç°æœ‰å·¥å…·å¹¶è¿›è¡Œå¯èƒ½å†—é•¿çš„æµ‹è¯•. ä½†ä¸ç®¡æ€æ ·,è¿™æ˜¯èµ°å‘æˆç†Ÿåº”ç”¨å…³é”®çš„ä¸€æ­¥,</p><span id="more"></span><h3 id="å¦‚ä½•è¿›è¡Œæ€§èƒ½åˆ†æ"><a href="#å¦‚ä½•è¿›è¡Œæ€§èƒ½åˆ†æ" class="headerlink" title="å¦‚ä½•è¿›è¡Œæ€§èƒ½åˆ†æ"></a>å¦‚ä½•è¿›è¡Œæ€§èƒ½åˆ†æ</h3><blockquote><p>è¿‡æ—©çš„æ€§èƒ½åˆ†ææ˜¯ä¸‡æ¶ä¹‹æº</p></blockquote><p>ä½ å¯ä»¥å…ˆå®Œæˆç¨‹åºçš„åŸºæœ¬åŠŸèƒ½å†è¿›è¡Œä¼˜åŒ–,åˆ†æçš„æ–¹å¼å’Œå·¥å…·å¾ˆå¤š.æœ€åŸºç¡€çš„åŒ…æ‹¬è®¡æ—¶.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time, random</span><br><span class="line">n = random.randint(<span class="number">1</span>, <span class="number">10</span>) * <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å½“å‰æ—¶é—´ </span></span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Sleeping for &#123;&#125; ms&quot;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">time.sleep(n/<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯”è¾ƒå½“å‰æ—¶é—´å’Œèµ·å§‹æ—¶é—´</span></span><br><span class="line"><span class="built_in">print</span>(time.time() - start)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Output</span></span><br><span class="line"><span class="comment"># Sleeping for 500 ms</span></span><br><span class="line"><span class="comment"># 0.5713930130004883</span></span><br></pre></td></tr></table></figure><p>è€ƒè™‘åˆ°ä¸€ä¸ªç¨‹åºæ‰§è¡Œæ—¶é—´åŒ…å«å¤ªå¤šéƒ¨åˆ†,æ¯”å¦‚å¦‚æœä½ çš„ç”µè„‘åŒæ—¶è·‘ç€å¤ªå¤šç¨‹åºå¹¶ä¸”å†…å­˜ä¸å¤ªå¤Ÿ,é€ æˆçš„ä¸­æ–­ç­‰ä¹Ÿä¼šå½±å“æ—¶é—´.</p><p>å¯¹äºå·¥å…·æ¥è¯´,éœ€è¦åŒºåˆ†çœŸå®æ—¶é—´ã€ç”¨æˆ·æ—¶é—´å’Œç³»ç»Ÿæ—¶é—´.é€šå¸¸æ¥è¯´,ç”¨æˆ·æ—¶é—´+ç³»ç»Ÿæ—¶é—´ä»£è¡¨äº†è¿›ç¨‹æ‰€æ¶ˆè€—çš„å®é™… CPU .</p><ul><li>çœŸå®æ—¶é—´ - ä»ç¨‹åºå¼€å§‹åˆ°ç»“æŸæµå¤±æ‰çš„çœŸå®æ—¶é—´ï¼ŒåŒ…æ‹¬å…¶ä»–è¿›ç¨‹çš„æ‰§è¡Œæ—¶é—´ä»¥åŠé˜»å¡æ¶ˆè€—çš„æ—¶é—´ï¼ˆä¾‹å¦‚ç­‰å¾… I/Oæˆ–ç½‘ç»œï¼‰ï¼›</li><li><em>User</em> - CPU æ‰§è¡Œç”¨æˆ·ä»£ç æ‰€èŠ±è´¹çš„æ—¶é—´ï¼›</li><li><em>Sys</em> - CPU æ‰§è¡Œç³»ç»Ÿå†…æ ¸ä»£ç æ‰€èŠ±è´¹çš„æ—¶é—´</li></ul><p>å¯¹äºcpu,å†…å­˜,äº‹ä»¶åˆ†æä»¥åŠå¯è§†åŒ–ç­‰,éƒ½æœ‰ä¸€ç³»åˆ—å·¥å…·å¤„ç†,å…·ä½“å¯çœ‹<a href="https://missing-semester-cn.github.io/2020/debugging-profiling/">è°ƒè¯•åŠæ€§èƒ½åˆ†æ Â· the missing semester of your cs education (missing-semester-cn.github.io)</a></p><h3 id="æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½åˆ†æ"><a href="#æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½åˆ†æ" class="headerlink" title="æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½åˆ†æ"></a>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½åˆ†æ</h3><p>å¦‚ä½•è¯„ä¼°ä¸€ä¸ªæ¨¡å‹åœ¨å®é™…éƒ¨ç½²æˆ–è€…æ¨ç†æ—¶çš„æ•ˆæœ,è®¡ç®—é‡å’Œå‚æ•°éƒ½æ˜¯é‡è¦å› ç´ ,ä¸€ä¸ªé™åˆ¶GPU/CPU,ä¸€ä¸ªé™åˆ¶å†…å­˜.<br>æ­¤å¤–å¯¹äºå›¾åƒæˆ–è§†é¢‘,fpsä¹Ÿæ˜¯é‡è¦å› ç´ ,å¯¹äºå¤§æ¨¡å‹è€Œè¨€å°±æ˜¯è¾“å‡ºtokençš„é€Ÿåº¦,è¯´ç™½äº†å°±æ˜¯è¾“å‡ºæ—¶é—´,å½±å“äº†å®æ—¶æ€§å’Œç”¨æˆ·ä½¿ç”¨ä½“éªŒ,ä¸ªäººè®¤ä¸ºè¿™ä¸ªå› ç´ ä¹Ÿè·Ÿè®¡ç®—é‡å’Œå‚æ•°ç›¸å…³.<br>é‚£ä¹ˆå¦‚ä½•è®¡ç®—æ¨¡å‹è®¡ç®—é‡å’Œå‚æ•°é‡å‘¢?<br>æ ¹æ®å­—é¢æ„æ€,å‚æ•°é‡å¥½ç†è§£,æ— éå‡ ç§ç½‘ç»œç»“æ„,æ¯ç§ç½‘ç»œç»“æ„éƒ½æˆ–å¤šæˆ–å°‘æœ‰å‚æ•°,æ¯ä¸ªå‚æ•°å½“ä½œf32æˆ–è€…å…¶ä»–ç±»å‹è®¡ç®—å³å¯. å½“ç„¶å®é™…æ¨ç†æˆ–è€…éƒ¨ç½²å®Œå…¨å¯ä»¥ä½¿ç”¨é‡åŒ–çš„æ–¹æ³•å¾—åˆ°æ•´æ•°,ç”šè‡³æ˜¯i8ç±»å‹.è¿™æ ·å°±æŠŠå‚æ•°é‡é™ä½äº†,æ­¤å¤–æµ®ç‚¹æ•°å˜æˆäº†æ•´æ•°,äº‹å®ä¸Šè®¡ç®—ä¹Ÿé™ä½äº†å¤æ‚åº¦,å› ä¸ºæµ®ç‚¹æ•°è®¡ç®—åœ¨CPU/GPUä¸Šå¾€å¾€æ›´å¤æ‚.</p><p>è¿™æ ·ä¸€æƒ³,è®¡ç®—å‚æ•°é‡å°±æ¯”è¾ƒç®€å•äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_param</span>(<span class="params">model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Calculate the number of parameters in the model.</span></span><br><span class="line"><span class="string">    :param model: model</span></span><br><span class="line"><span class="string">    :return: number of parameters</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    param_num =  <span class="built_in">sum</span>(p.numel() <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters() <span class="keyword">if</span> p.requires_grad)</span><br><span class="line">    <span class="built_in">print</span>(param_num*<span class="number">4</span>/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">&#x27;MB&#x27;</span>) <span class="comment"># assume dtype float32</span></span><br></pre></td></tr></table></figure><p>é‚£å¦‚ä½•è®¡ç®—è®¡ç®—é‡å‘¢,ç”±äºæµ®ç‚¹æ•°å’Œæ•´æ•°è¿ç®—ä¸Šåœ¨CPUè®¡ç®—çš„ä¸åŒ,æˆ‘ä»¬åªè€ƒè™‘æ›´ä¸ºå¤æ‚çš„æµ®ç‚¹æ•°è®¡ç®—,å°±æœ‰äº†FLOPs. FLOPSè®¡ç®—å¦‚ä¸‹,å·ç§¯å±‚å’Œå…¨è¿æ¥è®¡ç®—ä¸åŒ</p><p><img data-src="https://s2.loli.net/2024/07/30/QchEs9vxK1unXjH.png" alt="image-20240730111224462"></p><p>è¿˜æœ‰äº›åœ°æ–¹ä½¿ç”¨çš„æ˜¯MACså’ŒMAdds,</p><p>MACï¼šMultiply Accumulateï¼Œä¹˜åŠ è¿ç®—ã€‚ä¹˜ç§¯ç´¯åŠ è¿ç®—ï¼ˆè‹±è¯­ï¼šMultiply Accumulate, MACï¼‰æ˜¯åœ¨æ•°å­—ä¿¡å·å¤„ç†å™¨æˆ–ä¸€äº›å¾®å¤„ç†å™¨ä¸­çš„ç‰¹æ®Šè¿ç®—ã€‚å®ç°æ­¤è¿ç®—æ“ä½œçš„ç¡¬ä»¶ç”µè·¯å•å…ƒï¼Œè¢«ç§°ä¸ºâ€œä¹˜æ•°ç´¯åŠ å™¨â€ã€‚è¿™ç§è¿ç®—çš„æ“ä½œï¼Œæ˜¯å°†ä¹˜æ³•çš„ä¹˜ç§¯ç»“æœå’Œç´¯åŠ å™¨çš„å€¼ç›¸åŠ ï¼Œå†å­˜å…¥ç´¯åŠ å™¨ï¼š</p><script type="math/tex; mode=display">a â† a + b Ã— c</script><p>ä½¿ç”¨MACå¯ä»¥å°†åŸæœ¬éœ€è¦çš„ä¸¤ä¸ªæŒ‡ä»¤æ“ä½œå‡å°‘åˆ°ä¸€ä¸ªæŒ‡ä»¤æ“ä½œï¼Œä»è€Œæé«˜è¿ç®—æ•ˆç‡ã€‚</p><blockquote><p>MAdds æœ¬è´¨ä¸Šä¸ MACs ç›¸åŒï¼Œéƒ½æ˜¯æŒ‡ä¸€æ¬¡ä¹˜æ³•å’Œä¸€æ¬¡åŠ æ³•çš„ç»„åˆã€‚æœ¯è¯­ MAdds æ›´å¸¸è§äºä¸€äº›æ–‡çŒ®ä¸­ï¼Œå°¤å…¶æ˜¯æ—©æœŸçš„æ–‡çŒ®ã€‚å®é™…ä¸Šï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒMACs å’Œ MAdds å¯ä»¥äº’æ¢ä½¿ç”¨.</p><p>1ä¸ª MACs åŒ…å«ä¸€ä¸ªä¹˜æ³•æ“ä½œä¸ä¸€ä¸ªåŠ æ³•æ“ä½œï¼Œå¤§çº¦åŒ…å«2ä¸ª FLOPsã€‚å› æ­¤ï¼Œé€šå¸¸ MACs ä¸ FLOPs å­˜åœ¨ä¸€ä¸ª2å€çš„å…³ç³»ã€‚(ä½†æ˜¯å¾ˆå¤šæ—¶å€™åˆä¼šæŠŠå®ƒä»¬ä¼šæ··æ·†åˆåœ¨ä¸€èµ·)</p></blockquote><p>æŠ½è±¡åœ°é«˜åº¦æ¥è¯´</p><blockquote><ul><li>è®¡ç®—é‡æ˜¯æŒ‡ç½‘ç»œæ¨¡å‹éœ€è¦è®¡ç®—çš„<strong>è¿ç®—æ¬¡æ•°</strong>ï¼Œå‚æ•°é‡æ˜¯æŒ‡ç½‘ç»œæ¨¡å‹è‡ªå¸¦çš„<strong>å‚æ•°æ•°é‡</strong>å¤šå°‘</li><li>è®¡ç®—é‡å¯¹åº”<strong>æ—¶é—´å¤æ‚åº¦</strong>ï¼Œå‚æ•°é‡å¯¹åº”äº<strong>ç©ºé—´å¤æ‚åº¦</strong></li><li>è®¡ç®—é‡å†³å®šäº†<strong>ç½‘ç»œæ‰§è¡Œæ—¶é—´çš„é•¿çŸ­</strong>ï¼Œå‚æ•°é‡å†³å®šäº†å ç”¨æ˜¾å­˜çš„é‡</li></ul></blockquote><p><a href="https://blog.csdn.net/qq_33952811/article/details/124276599">5ç§æ–¹æ³•è·å–Torchç½‘ç»œæ¨¡å‹å‚æ•°é‡è®¡ç®—é‡ç­‰ä¿¡æ¯_æŸ¥çœ‹æ¨¡å‹å‚æ•°é‡-CSDNåšå®¢</a></p><h3 id="fvcore"><a href="#fvcore" class="headerlink" title="fvcore"></a>fvcore</h3><p>Metaçš„å¼€æºå·¥å…·,åŒ…å«pytorch layers,è®¡ç®—flop,è®¡ç®—å‚æ•°,</p><p><strong>FlopCountAnalysis</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from fvcore<span class="selector-class">.nn</span> import FlopCountAnalysis</span><br><span class="line">flops = FlopCountAnalysis(model, input)</span><br><span class="line">flops<span class="selector-class">.total</span>()</span><br><span class="line">flops<span class="selector-class">.by_operator</span>()</span><br><span class="line"><span class="function"><span class="title">Counter</span><span class="params">(&#123;<span class="string">&#x27;conv&#x27;</span>: <span class="number">194616</span>, <span class="string">&#x27;addmm&#x27;</span>: <span class="number">80040</span>&#125;)</span></span></span><br><span class="line">flops<span class="selector-class">.by_module</span>()</span><br><span class="line">Counter(&#123;<span class="string">&#x27;&#x27;</span>: <span class="number">274656</span>, <span class="string">&#x27;conv1&#x27;</span>: <span class="number">48600</span>,</span><br><span class="line">         <span class="string">&#x27;conv2&#x27;</span>: <span class="number">146016</span>, <span class="string">&#x27;fc1&#x27;</span>: <span class="number">69120</span>,</span><br><span class="line">         <span class="string">&#x27;fc2&#x27;</span>: <span class="number">10080</span>, <span class="string">&#x27;fc3&#x27;</span>: <span class="number">840</span>&#125;)</span><br><span class="line">flops<span class="selector-class">.by_module_and_operator</span>()</span><br><span class="line">&#123;<span class="string">&#x27;&#x27;</span>: Counter(&#123;<span class="string">&#x27;conv&#x27;</span>: <span class="number">194616</span>, <span class="string">&#x27;addmm&#x27;</span>: <span class="number">80040</span>&#125;),</span><br><span class="line"> <span class="string">&#x27;conv1&#x27;</span>: Counter(&#123;<span class="string">&#x27;conv&#x27;</span>: <span class="number">48600</span>&#125;),</span><br><span class="line"> <span class="string">&#x27;conv2&#x27;</span>: Counter(&#123;<span class="string">&#x27;conv&#x27;</span>: <span class="number">146016</span>&#125;),</span><br><span class="line"> <span class="string">&#x27;fc1&#x27;</span>: Counter(&#123;<span class="string">&#x27;addmm&#x27;</span>: <span class="number">69120</span>&#125;),</span><br><span class="line"> <span class="string">&#x27;fc2&#x27;</span>: Counter(&#123;<span class="string">&#x27;addmm&#x27;</span>: <span class="number">10080</span>&#125;),</span><br><span class="line"> <span class="string">&#x27;fc3&#x27;</span>: Counter(&#123;<span class="string">&#x27;addmm&#x27;</span>: <span class="number">840</span>&#125;)&#125;</span><br></pre></td></tr></table></figure><p><strong>flop_count_table</strong></p><p>Format the per-module parameters and flops of a model in a table</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(flop_count_table(FlopCountAnalysis(model, inputs)))</span><br></pre></td></tr></table></figure><p>å¯ä»¥å•ç‹¬çœ‹æŸä¸ªæ¨¡å—çš„å‚æ•°é‡å’Œè®¡ç®—é‡.</p><h3 id="torch-profiler"><a href="#torch-profiler" class="headerlink" title="torch profiler"></a>torch profiler</h3><p>pytorchå®˜æ–¹å·¥å…·</p><blockquote><p>PyTorch Profileræ˜¯ä¸€ä¸ªå…è®¸åœ¨è®­ç»ƒå’Œæ¨ç†æœŸé—´æ”¶é›†æ€§èƒ½æŒ‡æ ‡çš„å·¥å…·ã€‚Profilerçš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨APIå¯ä»¥ç”¨æ¥æ›´å¥½åœ°ç†è§£å“ªäº›æ¨¡å‹æ“ä½œç¬¦æ˜¯æœ€æ˜‚è´µçš„ï¼Œæ£€æŸ¥å®ƒä»¬çš„è¾“å…¥å½¢çŠ¶å’Œå †æ ˆè·Ÿè¸ªï¼Œç ”ç©¶è®¾å¤‡å†…æ ¸æ´»åŠ¨å¹¶å¯è§†åŒ–æ‰§è¡Œè·Ÿè¸ª</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">with</span> profile(activities=[ProfilerActivity.CUDA], record_shapes=<span class="literal">True</span>, use_cuda=<span class="literal">True</span>) <span class="keyword">as</span> prof:</span><br><span class="line">        <span class="keyword">with</span> record_function(<span class="string">&quot;model_inference&quot;</span>):</span><br><span class="line">            model(input_data[<span class="string">&#x27;ego&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;GPU time sorted operators:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(prof.key_averages().table(sort_by=<span class="string">&quot;cuda_time_total&quot;</span>, row_limit=<span class="number">10</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CPU time sorted operators:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(prof.key_averages().table(sort_by=<span class="string">&quot;cpu_time_total&quot;</span>, row_limit=<span class="number">10</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è®¡ç®—äº†GPUå’ŒCPUçš„æ—¶é—´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.profiler.profile(</span><br><span class="line">    activities=[</span><br><span class="line">        torch.profiler.ProfilerActivity.CPU,</span><br><span class="line">        torch.profiler.ProfilerActivity.CUDA,</span><br><span class="line">    ]</span><br><span class="line">) <span class="keyword">as</span> p:</span><br><span class="line">    code_to_profile()</span><br><span class="line"><span class="built_in">print</span>(p.key_averages().table(</span><br><span class="line">    sort_by=<span class="string">&quot;self_cuda_time_total&quot;</span>, row_limit=-<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/07/31/3yWSVITxsYGHbR8.png" alt="image-20240731115415621"></p><h3 id="deepspeed"><a href="#deepspeed" class="headerlink" title="deepspeed"></a>deepspeed</h3><p>å¤§æ¨¡å‹è®­ç»ƒçš„åŠ é€Ÿæ¡†æ¶,å¾®è½¯å¼€æºçš„.ä¸€èˆ¬çš„æ¨¡å‹ä¸Šé¢ä¸¤ä¸ªè¶³ä»¥.è¿™é‡Œä¸è¿‡å¤šä»‹ç».</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> deepspeed.profiling.flops_profiler <span class="keyword">import</span> FlopsProfiler</span><br><span class="line"></span><br><span class="line">model = Model()</span><br><span class="line">prof = FlopsProfiler(model)</span><br><span class="line"></span><br><span class="line">profile_step = <span class="number">5</span></span><br><span class="line">print_profile= <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step, batch <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">  <span class="comment"># start profiling at training step &quot;profile_step&quot;</span></span><br><span class="line">  <span class="keyword">if</span> step == profile_step:</span><br><span class="line">    prof.start_profile()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># forward() method</span></span><br><span class="line">  loss = model(batch)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># end profiling and print output</span></span><br><span class="line">  <span class="keyword">if</span> step == profile_step: <span class="comment"># if using multi nodes, check global_rank == 0 as well</span></span><br><span class="line">    prof.stop_profile()</span><br><span class="line">    flops = prof.get_total_flops()</span><br><span class="line">    macs = prof.get_total_macs()</span><br><span class="line">    params = prof.get_total_params()</span><br><span class="line">    <span class="keyword">if</span> print_profile:</span><br><span class="line">        prof.print_model_profile(profile_step=profile_step)</span><br><span class="line">    prof.end_profile()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># runs backpropagation</span></span><br><span class="line">  loss.backward()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># weight update</span></span><br><span class="line">  optimizer.step()</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>é™¤äº†ä¸Šé¢å‡ ä¸ªä¹‹å¤–,è¿˜æœ‰thop,statä»¥åŠptflopsç­‰,å…¶ä¸­ä¸€ä¸ªé—®é¢˜æ—¶,å¾ˆå¤šåº“è¦æ±‚ç»™å‡ºè¾“å‡ºçš„tensor shape,ä½†å®é™…æƒ…å†µæ˜¯è¾“å…¥çš„æ˜¯ä¸€ä¸ªlistæˆ–è€…dictç„¶ååœ¨æ¨¡å‹ä¸­è¿›è¡Œå¤„ç†,ä¸ºäº†é¿å…æ¨¡å‹æ”¹åŠ¨,æˆ‘æ¨èå¯ä»¥ä½¿ç”¨thop.</p></blockquote><h3 id="è¿è¡Œæ¨¡å‹æ—¶é—´"><a href="#è¿è¡Œæ¨¡å‹æ—¶é—´" class="headerlink" title="è¿è¡Œæ¨¡å‹æ—¶é—´"></a>è¿è¡Œæ¨¡å‹æ—¶é—´</h3><p>å‰é¢è®²åˆ°å¦‚æœè¦æµ‹è¯•ç¨‹åºæ—¶é—´,å¹¶æ²¡æœ‰æƒ³çš„é‚£ä¹ˆç®€å•.åœ¨pytorchä¸­æä¾›äº†<code>torch.cuda.Event</code></p><p><a href="https://github.com/yifanlu0227/HEAL/blob/4882bd02514725fa5e2e5717d410de739f33790e/opencood/tools/profiler/params_calc.py">HEAL/opencood/tools/profiler/params_calc.py at 4882bd02514725fa5e2e5717d410de739f33790e Â· yifanlu0227/HEAL (github.com)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inference_throughput_cuda_event</span>(<span class="params">model, data</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start inference throughput performance test&quot;</span>)</span><br><span class="line">    run_num = <span class="number">50</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;warm up ...\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad(): <span class="comment"># warm up</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(run_num):</span><br><span class="line">            output = model(data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;warm up done.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># synchronize ç­‰å¾…æ‰€æœ‰ GPU ä»»åŠ¡å¤„ç†å®Œæ‰è¿”å› CPU ä¸»çº¿ç¨‹</span></span><br><span class="line">    torch.cuda.synchronize()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®ç”¨äºæµ‹é‡æ—¶é—´çš„ cuda Event, è¿™æ˜¯PyTorch å®˜æ–¹æ¨èçš„æ¥å£</span></span><br><span class="line">    starter, ender = torch.cuda.Event(enable_timing=<span class="literal">True</span>), torch.cuda.Event(enable_timing=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªæ—¶é—´å®¹å™¨</span></span><br><span class="line">    run_num = <span class="number">200</span></span><br><span class="line">    timings = np.zeros((run_num,))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start testing ...\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(run_num):</span><br><span class="line">            starter.record()</span><br><span class="line">            output = model(data)</span><br><span class="line">            ender.record()</span><br><span class="line">            torch.cuda.synchronize() <span class="comment"># ç­‰å¾…GPUä»»åŠ¡å®Œæˆ</span></span><br><span class="line">            curr_time = starter.elapsed_time(ender) <span class="comment"># ä» starter åˆ° ender ä¹‹é—´ç”¨æ—¶,å•ä½ä¸ºæ¯«ç§’</span></span><br><span class="line">            timings[i] = curr_time / <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    infer_thro = run_num / timings.<span class="built_in">sum</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;inference throughput (cuda event): &quot;</span>, infer_thro)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> infer_thro</span><br></pre></td></tr></table></figure><p>ç»è¿‡æˆ‘è‡ªå·±æµ‹è¯•,å¦‚æœæ˜¾å­˜è¶³å¤Ÿçš„æƒ…å†µä¸‹,å¾ˆå¤šæ—¶å€™ç›´æ¥ä½¿ç”¨timeç»“æœç±»ä¼¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start_time = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(run_num):</span><br><span class="line">    output = model(data)</span><br><span class="line">end_time = time.time()</span><br><span class="line">infer_thro = run_num / (end_time - start_time)</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><p><a href="https://missing-semester-cn.github.io/2020/debugging-profiling/">è°ƒè¯•åŠæ€§èƒ½åˆ†æ Â· the missing semester of your cs education (missing-semester-cn.github.io)</a></p></li><li><p><a href="https://discuss.pytorch.org/t/correct-way-to-calculate-flops-in-model/67198/14">Correct way to calculate FLOPS in model - PyTorch Forums</a></p><p>ä»¥ä¸‹æ˜¯æˆ‘çœ‹åˆ°çš„åˆ†ææ·±åº¦å­¦ä¹ æ¨¡å‹è®¡ç®—é‡å’Œå‚æ•°é‡çš„å·¥å…·</p><ul><li><a href="https://pytorch.org/docs/stable/profiler.html">torch.profiler â€” PyTorch 2.4 documentation</a></li><li><a href="https://www.deepspeed.ai/tutorials/flops-profiler/">Flops Profiler - DeepSpeed</a></li><li><a href="https://github.com/facebookresearch/fvcore">facebookresearch/fvcore: Collection of common code thatâ€™s shared among different research projects in FAIR computer vision team. (github.com)</a> </li></ul></li></ol><p>profiler <a href="https://github.com/yifanlu0227/HEAL/tree/4882bd02514725fa5e2e5717d410de739f33790e/opencood/tools/profiler">HEAL/opencood/tools/profiler at 4882bd02514725fa5e2e5717d410de739f33790e Â· yifanlu0227/HEAL (github.com)</a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿™æ˜¯å¤§å‹è½¯ä»¶ã€ç®—æ³•å¼€å‘ä¸­å®¹æ˜“è¢«å¿½è§†åŒæ—¶ä¹Ÿå¹¶ä¸ç®€å•çš„ä¸€ç¯,å¦‚ä½•åˆ†æä¸€ä¸ªç¨‹åº.è¿™æ¶‰åŠåˆ°åˆ†æå†…å­˜ã€ä½¿ç”¨ä¸€ç³»åˆ—ç°æœ‰å·¥å…·å¹¶è¿›è¡Œå¯èƒ½å†—é•¿çš„æµ‹è¯•. ä½†ä¸ç®¡æ€æ ·,è¿™æ˜¯èµ°å‘æˆç†Ÿåº”ç”¨å…³é”®çš„ä¸€æ­¥,&lt;/p&gt;</summary>
    
    
    
    
    <category term="deep learning" scheme="https://www.sekyoro.top/tags/deep-learning/"/>
    
    <category term="profiler" scheme="https://www.sekyoro.top/tags/profiler/"/>
    
  </entry>
  
  <entry>
    <title>Go+HTMX: webå¼€å‘é™ä½å¿ƒæ™ºè´Ÿæ‹…çš„ä¸€ç§é€‰æ‹©?</title>
    <link href="https://www.sekyoro.top/2024/07/27/go-htmx-web%E5%BC%80%E5%8F%91%E9%99%8D%E4%BD%8E%E5%BF%83%E6%99%BA%E8%B4%9F%E6%8B%85%E7%9A%84%E4%B8%80%E7%A7%8D%E9%80%89%E6%8B%A9/"/>
    <id>https://www.sekyoro.top/2024/07/27/go-htmx-web%E5%BC%80%E5%8F%91%E9%99%8D%E4%BD%8E%E5%BF%83%E6%99%BA%E8%B4%9F%E6%8B%85%E7%9A%84%E4%B8%80%E7%A7%8D%E9%80%89%E6%8B%A9/</id>
    <published>2024-07-27T02:35:43.000Z</published>
    <updated>2024-07-28T08:53:33.521Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¼—æ‰€å‘¨çŸ¥,ä¸€æ®µæ—¶é—´å‰æˆ‘ä¸€ç›´åœ¨å…³æ³¨webå¼€å‘æ¡†æ¶,æ€»çš„æ¥è¯´,å¤§åŒå°å¼‚. å¦‚ä½•è¿›è¡Œå¿«é€Ÿå¼€å‘å°åº”ç”¨,æ˜¯ä¸€ä¸ªå¹¶ä¸ç®€å•å›ç­”çš„é—®é¢˜.è¿™é‡Œæˆ‘ç»™å‡ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆ:Go+HTMX.<br><span id="more"></span></p><p>è¿™ä¸¤ä¸ªæŠ€æœ¯æˆ‘ä¸è¿‡å¤šä»‹ç»,htmxé¡¾åæ€ä¹‰,åœ¨htmlä¸Šå°äº†ä¸€å±‚æä¾›ä¸åç«¯äº¤äº’çš„åŠŸèƒ½. ä½¿ç”¨Goå› ä¸ºå®ƒçš„ç®€æ´ä¸”è‡ªå¸¦GC,ä¸åƒc++å’Œrustéœ€è¦ä»”ç»†å°å¿ƒç®¡ç†å†…å­˜,æ²¡æœ‰é€‰ç”¨Java/C#ä¹Ÿæ˜¯å› ä¸ºåä¸¤è€…ä½¿ç”¨é€šå¸¸éƒ½è¦å¸¦ä¸Šå·¨å¤§çš„åº“(å¤§å‹åº“ä¼šå¸¦æ¥ä¾èµ–ä¸Šçš„å®‰è£…ã€ç®¡ç†ä»¥åŠå¿ƒæ™ºè´Ÿæ‹…),åœ¨å¼€å‘å°åº”ç”¨æ—¶å¾€å¾€æ²¡æœ‰å¿…è¦.  HTMXä¸»è¦æ‰¿æ‹…äº†ä¸€éƒ¨åˆ†jsçš„ä½œç”¨.</p><p>htmlxåªæœ‰14kçš„å¤§å°,æ²¡æœ‰å…¶ä»–ä¾èµ–,å¢å¼ºäº†htmlçš„åŠŸèƒ½. å†æ¬¡è¯´æ˜,æˆ‘ä»‹ç»è¿™ä¸ªæŠ€æœ¯æ ˆç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿå¼€å‘ä¸­å°åº”ç”¨,å¦‚æœä¸ºäº†å·¥ä½œæˆ–æ˜¯è¿›ä¸€æ­¥å­¦ä¹ ,æ¨èJava/C#/Goç­‰,å†ä¸æµä¹Ÿæ˜¯Python/PHP/Ruby.æ­é…vue/react/svelte/solid.</p><p>å…³äºGoçš„webå¼€å‘,å¸¸ç”¨Ginä½œä¸ºæ¡†æ¶,ä¸»è¦å†™REST APIå’Œè‡ªå¸¦çš„æ¨¡æ¿å¼•æ“è§£æhtml,è¿™é‡Œä¸å¤šèµ˜è¿°.</p><p>ä¸‹é¢ä»‹ç»htmxçš„ä¸€äº›é‡è¦åŠŸèƒ½</p><h2 id="HTMX"><a href="#HTMX" class="headerlink" title="HTMX"></a>HTMX</h2><h3 id="AJAX"><a href="#AJAX" class="headerlink" title="AJAX"></a>AJAX</h3><p>ä½¿ç”¨htmlçš„å±æ€§å‘é€è¯·æ±‚.</p><h4 id="è¯·æ±‚æ–¹æ³•"><a href="#è¯·æ±‚æ–¹æ³•" class="headerlink" title="è¯·æ±‚æ–¹æ³•"></a>è¯·æ±‚æ–¹æ³•</h4><div class="table-container"><table><thead><tr><th style="text-align:left">Attribute</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://htmx.org/attributes/hx-get/">hx-get</a></td><td style="text-align:left">Issues a <code>GET</code> request to the given URL</td></tr><tr><td style="text-align:left"><a href="https://htmx.org/attributes/hx-post/">hx-post</a></td><td style="text-align:left">Issues a <code>POST</code> request to the given URL</td></tr><tr><td style="text-align:left"><a href="https://htmx.org/attributes/hx-put/">hx-put</a></td><td style="text-align:left">Issues a <code>PUT</code> request to the given URL</td></tr><tr><td style="text-align:left"><a href="https://htmx.org/attributes/hx-patch/">hx-patch</a></td><td style="text-align:left">Issues a <code>PATCH</code> request to the given URL</td></tr><tr><td style="text-align:left"><a href="https://htmx.org/attributes/hx-delete/">hx-delete</a></td><td style="text-align:left">Issues a <code>DELETE</code> request to the given URL</td></tr></tbody></table></div><h4 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h4><p>é€šè¿‡<code>hx-trigger</code>è®¾ç½®è§¦å‘åŠ¨ä½œ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-post</span>=<span class="string">&quot;/mouse_entered&quot;</span> <span class="attr">hx-trigger</span>=<span class="string">&quot;mouseenter&quot;</span>&gt;</span></span><br><span class="line">    [Here Mouse, Mouse!]</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥è®¾ç½®mofierså’Œfiltersä¿®æ”¹é»˜è®¤è¡Œä¸º.</p><p>è¿˜å¯ä»¥ä½¿ç”¨è½®è¯¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-get</span>=<span class="string">&quot;/news&quot;</span> <span class="attr">hx-trigger</span>=<span class="string">&quot;every 2s&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-get</span>=<span class="string">&quot;/messages&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">hx-trigger</span>=<span class="string">&quot;load delay:1s&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">hx-swap</span>=<span class="string">&quot;outerHTML&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®indicatorè¡¨æ˜å·²ç»å‘å‡ºè¯·æ±‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-get</span>=<span class="string">&quot;/click&quot;</span>&gt;</span></span><br><span class="line">    Click Me!</span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;htmx-indicator&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/spinner.gif&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.htmx-indicator</span>&#123;</span><br><span class="line">    <span class="attribute">display</span>:none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.htmx-request</span> <span class="selector-class">.htmx-indicator</span>&#123;</span><br><span class="line">    <span class="attribute">display</span>:inline;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.htmx-request</span><span class="selector-class">.htmx-indicator</span>&#123;</span><br><span class="line">    <span class="attribute">display</span>:inline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“htmxå‘å‡ºè¯·æ±‚æ—¶ï¼Œå®ƒå°†æŠŠä¸€ä¸ªhtmx-requestç±»æ”¾åˆ°ä¸€ä¸ªå…ƒç´ ä¸Š(å¦‚æœæŒ‡å®šï¼Œå¯ä»¥æ˜¯è¯·æ±‚å…ƒç´ æˆ–å¦ä¸€ä¸ªå…ƒç´ )ã€‚htmx-requestç±»ä¼šä½¿å¸¦æœ‰html-indicatorç±»çš„å­å…ƒç´ çš„ä¸é€æ˜åº¦å˜ä¸º1ã€‚</p><p>å¯ä»¥è®¾ç½®ä¿®æ”¹çš„å…ƒç´ .</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-get</span>=<span class="string">&quot;/click&quot;</span> <span class="attr">hx-indicator</span>=<span class="string">&quot;#indicator&quot;</span>&gt;</span></span><br><span class="line">        Click Me!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;indicator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;htmx-indicator&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/spinner.gif&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="target"><a href="#target" class="headerlink" title="target"></a>target</h4><p>å“åº”é»˜è®¤åŠ è½½åˆ°è¯·æ±‚çš„å…ƒç´ ä¸­,å¯ä»¥ä¿®æ”¹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;q&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">hx-get</span>=<span class="string">&quot;/trigger_delay&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">hx-trigger</span>=<span class="string">&quot;keyup delay:500ms changed&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">hx-target</span>=<span class="string">&quot;#search-results&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">placeholder</span>=<span class="string">&quot;Search...&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;search-results&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="swap"><a href="#swap" class="headerlink" title="swap"></a>swap</h4><p>htmxæä¾›äº†å‡ ç§ä¸åŒçš„æ–¹æ³•æ¥å°†è¿”å›çš„HTMLäº¤æ¢åˆ°DOM.é»˜è®¤æƒ…å†µä¸‹,å†…å®¹ä¼šæ›¿æ¢ç›®æ ‡å…ƒç´ çš„innerHTML.å¯ä»¥é€šè¿‡ä½¿ç”¨hx-swapå±æ€§æ¥ä¿®æ”¹è¿™ä¸ªå€¼:</p><div class="table-container"><table><thead><tr><th style="text-align:left">Name</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>innerHTML</code></td><td style="text-align:left">the default, puts the content inside the target element</td></tr><tr><td style="text-align:left"><code>outerHTML</code></td><td style="text-align:left">replaces the entire target element with the returned content</td></tr><tr><td style="text-align:left"><code>afterbegin</code></td><td style="text-align:left">prepends the content before the first child inside the target</td></tr><tr><td style="text-align:left"><code>beforebegin</code></td><td style="text-align:left">prepends the content before the target in the targetâ€™s parent element</td></tr><tr><td style="text-align:left"><code>beforeend</code></td><td style="text-align:left">appends the content after the last child inside the target</td></tr><tr><td style="text-align:left"><code>afterend</code></td><td style="text-align:left">appends the content after the target in the targetâ€™s parent element</td></tr><tr><td style="text-align:left"><code>delete</code></td><td style="text-align:left">deletes the target element regardless of the response</td></tr><tr><td style="text-align:left"><code>none</code></td><td style="text-align:left">does not append content from response (<a href="https://htmx.org/docs/#oob_swaps">Out of Band Swaps</a> and <a href="https://htmx.org/docs/#response-headers">Response Headers</a> will still be processed)</td></tr></tbody></table></div><p>ä»¥ä¸Šå°±æ˜¯htmxä¸­Ajaxçš„åŸºæœ¬ä½¿ç”¨,å¦‚æœçŸ¥é“ajaxçš„è¿ä½œ,é‚£ä¹ˆä½¿ç”¨å°±ä¸ä¼šå¤ªéš¾.</p><h3 id="å±æ€§ç»§æ‰¿"><a href="#å±æ€§ç»§æ‰¿" class="headerlink" title="å±æ€§ç»§æ‰¿"></a>å±æ€§ç»§æ‰¿</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-confirm</span>=<span class="string">&quot;Are you sure?&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-delete</span>=<span class="string">&quot;/account&quot;</span>&gt;</span></span><br><span class="line">        Delete My Account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-put</span>=<span class="string">&quot;/account&quot;</span>&gt;</span></span><br><span class="line">        Update My Account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªbuttonç»§æ‰¿äº†hx-confirmçš„å€¼</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-confirm</span>=<span class="string">&quot;Are you sure?&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-delete</span>=<span class="string">&quot;/account&quot;</span>&gt;</span></span><br><span class="line">        Delete My Account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-put</span>=<span class="string">&quot;/account&quot;</span>&gt;</span></span><br><span class="line">        Update My Account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">hx-confirm</span>=<span class="string">&quot;unset&quot;</span> <span class="attr">hx-get</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        Cancel</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨unsetå–æ¶ˆ</p><h3 id="å¢å¼ºè¡¨å•å’Œé“¾æ¥"><a href="#å¢å¼ºè¡¨å•å’Œé“¾æ¥" class="headerlink" title="å¢å¼ºè¡¨å•å’Œé“¾æ¥"></a>å¢å¼ºè¡¨å•å’Œé“¾æ¥</h3><p>HTMLæ”¯æŒä½¿ç”¨hx-boostå±æ€§â€œå¢å¼ºâ€å¸¸è§„HTMLé”šå’Œè¡¨å•.è¯¥å±æ€§å°†æŠŠæ‰€æœ‰é”šæ ‡è®°å’Œè¡¨å•è½¬æ¢ä¸ºAJAXè¯·æ±‚,é»˜è®¤æƒ…å†µä¸‹,è¿™äº›è¯·æ±‚ä»¥é¡µé¢ä¸»ä½“ä¸ºç›®æ ‡ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">hx-boost</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog&quot;</span>&gt;</span>Blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªdivä¸­çš„é”šæ ‡è®°å°†å‘/blogå‘å‡ºä¸€ä¸ªAJAX GETè¯·æ±‚ï¼Œå¹¶å°†å“åº”äº¤æ¢åˆ°bodyæ ‡è®°ä¸­</p><h3 id="é…ç½®å“åº”å¤„ç†"><a href="#é…ç½®å“åº”å¤„ç†" class="headerlink" title="é…ç½®å“åº”å¤„ç†"></a>é…ç½®å“åº”å¤„ç†</h3><p>htmxæœŸæœ›å¯¹å®ƒå‘å‡ºçš„AJAXè¯·æ±‚çš„å“åº”æ˜¯HTML,é€šå¸¸æ˜¯HTMLç‰‡æ®µ(å°½ç®¡ä¸hx-selectæ ‡è®°åŒ¹é…çš„å®Œæ•´HTMLæ–‡æ¡£ä¹Ÿå¾ˆæœ‰ç”¨).ç„¶å,HTMLå°†è¿”å›çš„HTMLäº¤æ¢åˆ°æŒ‡å®šç›®æ ‡çš„æ–‡æ¡£ä¸­,å¹¶ä½¿ç”¨æŒ‡å®šçš„äº¤æ¢ç­–ç•¥.<br>æœ‰æ—¶æ‚¨å¯èƒ½ä¸å¸Œæœ›åœ¨äº¤æ¢ä¸­æ‰§è¡Œä»»ä½•æ“ä½œ,ä½†ä»ç„¶å¯èƒ½è§¦å‘å®¢æˆ·ç«¯äº‹ä»¶.<br>å¯¹äºè¿™ç§æƒ…å†µ,é»˜è®¤æƒ…å†µä¸‹,æ‚¨å¯ä»¥è¿”å›204 - No Contentå“åº”ä»£ç ï¼Œå¹¶ä¸”htmlå°†å¿½ç•¥å“åº”çš„å†…å®¹.<br>åœ¨æœåŠ¡å™¨é”™è¯¯å“åº”çš„äº‹ä»¶ä¸­(ä¾‹å¦‚404æˆ–501)ï¼Œhtmlå°†è§¦å‘html:responseerroräº‹ä»¶ï¼Œä½ å¯ä»¥å¤„ç†ã€‚<br>å¦‚æœå‡ºç°è¿æ¥é”™è¯¯ï¼Œå°†è§¦å‘html:sendErroräº‹ä»¶ã€‚</p><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">responseHandling: [</span><br><span class="line">     &#123;code:<span class="string">&quot;204&quot;</span>, swap: <span class="literal">false</span>&#125;,   <span class="comment">// 204 - No Content by default does nothing, but is not an error</span></span><br><span class="line">     &#123;code:<span class="string">&quot;[23]..&quot;</span>, swap: <span class="literal">true</span>&#125;, <span class="comment">// 200 &amp; 300 responses are non-errors and are swapped</span></span><br><span class="line">     &#123;code:<span class="string">&quot;[45]..&quot;</span>, swap: <span class="literal">false</span>, <span class="keyword">error</span>:<span class="literal">true</span>&#125;, <span class="comment">// 400 &amp; 500 responses are not swapped and are errors</span></span><br><span class="line"> ]</span><br></pre></td></tr></table></figure><p>å¯ä»¥é…ç½®ä¸‹é¢è¿™äº›é€‰é¡¹:</p><ul><li><code>code</code> - a String representing a regular expression that will be tested against response codes.</li><li><code>swap</code> - <code>true</code> if the response should be swapped into the DOM, <code>false</code> otherwise</li><li><code>error</code> - <code>true</code> if htmx should treat this response as an error</li><li><code>ignoreTitle</code> - <code>true</code> if htmx should ignore title tags in the response</li><li><code>select</code> - A CSS selector to use to select content from the response</li><li><code>target</code> - A CSS selector specifying an alternative target for the response</li><li><code>swapOverride</code> - An alternative swap mechanism for the response</li></ul><h3 id="é…ç½®è¯·æ±‚å¤´å’Œå“åº”å¤´"><a href="#é…ç½®è¯·æ±‚å¤´å’Œå“åº”å¤´" class="headerlink" title="é…ç½®è¯·æ±‚å¤´å’Œå“åº”å¤´"></a>é…ç½®è¯·æ±‚å¤´å’Œå“åº”å¤´</h3><h4 id="Request-Headers"><a href="#Request-Headers" class="headerlink" title="Request Headers"></a>Request Headers</h4><p>htmx includes a number of useful headers in requests:</p><div class="table-container"><table><thead><tr><th style="text-align:left">Header</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><code>HX-Boosted</code></td><td style="text-align:left">indicates that the request is via an element using <a href="https://htmx.org/attributes/hx-boost/">hx-boost</a></td></tr><tr><td style="text-align:left"><code>HX-Current-URL</code></td><td style="text-align:left">the current URL of the browser</td></tr><tr><td style="text-align:left"><code>HX-History-Restore-Request</code></td><td style="text-align:left">â€œtrueâ€ if the request is for history restoration after a miss in the local history cache</td></tr><tr><td style="text-align:left"><code>HX-Prompt</code></td><td style="text-align:left">the user response to an <a href="https://htmx.org/attributes/hx-prompt/">hx-prompt</a></td></tr><tr><td style="text-align:left"><code>HX-Request</code></td><td style="text-align:left">always â€œtrueâ€</td></tr><tr><td style="text-align:left"><code>HX-Target</code></td><td style="text-align:left">the <code>id</code> of the target element if it exists</td></tr><tr><td style="text-align:left"><code>HX-Trigger-Name</code></td><td style="text-align:left">the <code>name</code> of the triggered element if it exists</td></tr><tr><td style="text-align:left"><code>HX-Trigger</code></td><td style="text-align:left">the <code>id</code> of the triggered element if it exists</td></tr></tbody></table></div><h4 id="Response-Headers"><a href="#Response-Headers" class="headerlink" title="Response Headers"></a>Response Headers</h4><ul><li><a href="https://htmx.org/headers/hx-location/"><code>HX-Location</code></a> - allows you to do a client-side redirect that does not do a full page reload</li><li><a href="https://htmx.org/headers/hx-push-url/"><code>HX-Push-Url</code></a> - pushes a new url into the history stack</li><li><code>HX-Redirect</code> - can be used to do a client-side redirect to a new location</li><li><code>HX-Refresh</code> - if set to â€œtrueâ€ the client-side will do a full refresh of the page</li><li><a href="https://htmx.org/headers/hx-replace-url/"><code>HX-Replace-Url</code></a> - replaces the current URL in the location bar</li><li><code>HX-Reswap</code> - allows you to specify how the response will be swapped. See <a href="https://htmx.org/attributes/hx-swap/">hx-swap</a> for possible values</li><li><code>HX-Retarget</code> - a CSS selector that updates the target of the content update to a different element on the page</li><li><code>HX-Reselect</code> - a CSS selector that allows you to choose which part of the response is used to be swapped in. Overrides an existing <a href="https://htmx.org/attributes/hx-select/"><code>hx-select</code></a> on the triggering element</li><li><a href="https://htmx.org/headers/hx-trigger/"><code>HX-Trigger</code></a> - allows you to trigger client-side events</li><li><a href="https://htmx.org/headers/hx-trigger/"><code>HX-Trigger-After-Settle</code></a> - allows you to trigger client-side events after the settle step</li><li><a href="https://htmx.org/headers/hx-trigger/"><code>HX-Trigger-After-Swap</code></a> - allows you to trigger client-side events after the swap step</li></ul><p>htmxè¯·æ±‚çš„é¡ºåº:</p><ul><li>å…ƒç´ è¢«trigger<ul><li>æ”¶é›†éœ€è¦å‘é€çš„æ•°æ®</li><li><code>htmx-request</code>ç±»è¢«æ”¾åœ¨å…ƒç´ ä¸Š</li><li>é€šè¿‡AJAXå¼‚æ­¥åœ°è¯·æ±‚<ul><li>è·å¾—å“åº”åä¸ <code>htmx-swapping</code>ç±»åœ°å†…å®¹è½¬æ¢</li><li>å¯é€‰çš„swapå»¶è¿Ÿ</li><li>å®é™…äº¤æ¢å†…å®¹å®Œæˆ<ul><li><code>htmx-swapping</code> ç±»è¢«ç§»é™¤</li><li><code>htmx-added</code> ç±»è¢«æ·»åŠ åˆ°æ¯ä¸ªæ›´æ”¹çš„å…ƒç´ ä¸Š</li><li><code>htmx-settling</code> ç±»æ·»åŠ åˆ°targetä¸Š</li><li>é»˜è®¤å»¶è¿Ÿ</li><li>DOMå®Œæˆ</li><li><code>htmx-settling</code> è¢«ç§»é™¤</li><li><code>htmx-added</code>ç±»è¢«ç§»é™¤</li></ul></li></ul></li></ul></li></ul><h3 id="FYI"><a href="#FYI" class="headerlink" title="FYI"></a>FYI</h3><ol><li><a href="https://www.youtube.com/watch?v=jeT8m7490Pg">https://www.youtube.com/watch?v=jeT8m7490Pg</a></li><li><a href="https://htmx.org/"> htmx - high power tools for html</a>äº‹å®ä¸Š,htmxæ˜¯æœ‰äº‰è®®çš„æŠ€æœ¯,ä½†ä¸å¦¨ç¢å®ƒä¾æ—§å¾ˆå—æ¬¢è¿</li><li><a href="https://golang-china.github.io/gopl-zh/ch1/ch1-01.html">Hello, World - Goè¯­è¨€åœ£ç» (golang-china.github.io)</a></li><li><a href="https://golang.google.cn/learn/">Get Started - The Go Programming Language (google.cn)</a></li><li>More htmx examples<a href="https://htmx.org/examples/"> htmx ~ Examples</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥,ä¸€æ®µæ—¶é—´å‰æˆ‘ä¸€ç›´åœ¨å…³æ³¨webå¼€å‘æ¡†æ¶,æ€»çš„æ¥è¯´,å¤§åŒå°å¼‚. å¦‚ä½•è¿›è¡Œå¿«é€Ÿå¼€å‘å°åº”ç”¨,æ˜¯ä¸€ä¸ªå¹¶ä¸ç®€å•å›ç­”çš„é—®é¢˜.è¿™é‡Œæˆ‘ç»™å‡ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆ:Go+HTMX.&lt;br&gt;</summary>
    
    
    
    
    <category term="web" scheme="https://www.sekyoro.top/tags/web/"/>
    
    <category term="htmx" scheme="https://www.sekyoro.top/tags/htmx/"/>
    
  </entry>
  
  <entry>
    <title>building makemore</title>
    <link href="https://www.sekyoro.top/2024/07/24/building-makemore/"/>
    <id>https://www.sekyoro.top/2024/07/24/building-makemore/</id>
    <published>2024-07-24T03:12:49.000Z</published>
    <updated>2024-07-24T03:13:21.123Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p><a href="https://karpathy.ai/zero-to-hero.html">Neural Networks: Zero To Hero (karpathy.ai)</a><br><span id="more"></span></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://karpathy.ai/zero-to-hero.html&quot;&gt;Neural Networks: Zero To Hero (karpathy.ai)&lt;/a&gt;&lt;br&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>BTMC:é‡è¿”Modern Cpp</title>
    <link href="https://www.sekyoro.top/2024/07/21/BTMC-%E9%87%8D%E8%BF%94Modern-Cpp/"/>
    <id>https://www.sekyoro.top/2024/07/21/BTMC-%E9%87%8D%E8%BF%94Modern-Cpp/</id>
    <published>2024-07-21T07:13:09.000Z</published>
    <updated>2024-09-09T15:25:54.716Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¹‹å‰å†™è¿‡modern cppå­¦ä¹ ,ä½†æ˜¯åªæ˜¯è¿‡äº†ä¸€éæ–‡å­—. æœ€è¿‘æˆ‘åœ¨ä½¿ç”¨c++é‡å†™karpathyçš„micrograd,å­¦åˆ°äº†å¾ˆå¤š.è¿™é‡Œè®°å½•ä¸€ä¸‹é‡è¦çš„ä¸œè¥¿</p><span id="more"></span><h3 id="æ¨¡æ¿é»‘é­”æ³•"><a href="#æ¨¡æ¿é»‘é­”æ³•" class="headerlink" title="æ¨¡æ¿é»‘é­”æ³•"></a>æ¨¡æ¿é»‘é­”æ³•</h3><blockquote><p>é»‘é­”æ³•æ˜¯å¸¸äººæ— æ³•å‚é€çš„,è¿™é‡Œä»…ä½œç®€å•ä»‹ç»</p></blockquote><p>TODO:</p><h3 id="æ¨¡æ¿ç‰¹åŒ–"><a href="#æ¨¡æ¿ç‰¹åŒ–" class="headerlink" title="æ¨¡æ¿ç‰¹åŒ–"></a>æ¨¡æ¿ç‰¹åŒ–</h3><p>æ¨¡æ¿ç‰¹åŒ–æ˜¯C++æ¨¡æ¿æœºåˆ¶ä¸­çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå…è®¸ç¨‹åºå‘˜é’ˆå¯¹ç‰¹å®šçš„æ•°æ®ç±»å‹æˆ–ä¸€ç»„æ•°æ®ç±»å‹å¯¹æ¨¡æ¿è¿›è¡Œå®šåˆ¶ã€‚å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªç‰¹åŒ–çš„æ¨¡æ¿å®ä¾‹æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ç‰¹åŒ–ç‰ˆæœ¬è€Œä¸æ˜¯é€šç”¨æ¨¡æ¿ç‰ˆæœ¬ã€‚è¿™å¯ä»¥ç”¨äºä¼˜åŒ–ç‰¹å®šç±»å‹çš„æ€§èƒ½ï¼Œå¤„ç†ä¸åŒæ•°æ®ç±»å‹ä¹‹é—´çš„å·®å¼‚ï¼Œæˆ–è€…å®ç°å®Œå…¨ä¸åŒçš„è¡Œä¸ºã€‚</p><h4 id="æ¨¡æ¿ç‰¹åŒ–æ¦‚è¿°"><a href="#æ¨¡æ¿ç‰¹åŒ–æ¦‚è¿°" class="headerlink" title="æ¨¡æ¿ç‰¹åŒ–æ¦‚è¿°"></a>æ¨¡æ¿ç‰¹åŒ–æ¦‚è¿°</h4><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°<code>identity</code>ï¼Œå®ƒçš„ä½œç”¨æ˜¯è¿”å›ä¼ å…¥çš„å‚æ•°æœ¬èº«ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">identity</span><span class="params">(T x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åŸºæœ¬æ¨¡æ¿"><a href="#åŸºæœ¬æ¨¡æ¿" class="headerlink" title="åŸºæœ¬æ¨¡æ¿"></a>åŸºæœ¬æ¨¡æ¿</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">identity</span><span class="params">(T x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°æ¨¡æ¿ç‰¹åŒ–"><a href="#å‡½æ•°æ¨¡æ¿ç‰¹åŒ–" class="headerlink" title="å‡½æ•°æ¨¡æ¿ç‰¹åŒ–"></a>å‡½æ•°æ¨¡æ¿ç‰¹åŒ–</h4><p>ä½ å¯ä»¥ä¸ºç‰¹å®šç±»å‹ï¼ˆå¦‚<code>std::string</code>ï¼‰ç‰¹åŒ–è¿™ä¸ªæ¨¡æ¿ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line">std::string identity&lt;std::string&gt;(<span class="keyword">const</span> std::string&amp; s) &#123;</span><br><span class="line">    <span class="comment">// å¯ä»¥æ·»åŠ ä¸€äº›ç‰¹å®šäºstd::stringçš„æ“ä½œ</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚ï¼Œè½¬æ¢ä¸ºå¤§å†™</span></span><br><span class="line">    std::string result = s;</span><br><span class="line">    std::<span class="built_in">transform</span>(result.<span class="built_in">begin</span>(), result.<span class="built_in">end</span>(), result.<span class="built_in">begin</span>(), ::toupper);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯¹äº<code>std::string</code>ç±»å‹ï¼Œ<code>identity</code>å‡½æ•°å°†è¿”å›ä¸€ä¸ªå…¨éƒ¨å­—ç¬¦è½¬ä¸ºå¤§å†™çš„å­—ç¬¦ä¸²ï¼Œè€Œå¯¹å…¶ä»–ç±»å‹åˆ™ä¿æŒåŸæ ·ã€‚</p><h4 id="ç±»æ¨¡æ¿ç‰¹åŒ–"><a href="#ç±»æ¨¡æ¿ç‰¹åŒ–" class="headerlink" title="ç±»æ¨¡æ¿ç‰¹åŒ–"></a>ç±»æ¨¡æ¿ç‰¹åŒ–</h4><p>ç±»æ¨¡æ¿ä¹Ÿå¯ä»¥è¢«ç‰¹åŒ–ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç±»æ¨¡æ¿<code>Box</code>ï¼Œå®ƒå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">const</span> T&amp; value)</span> </span>&#123; data = value; &#125;</span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> data; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä¸º<code>int</code>ç±»å‹ç‰¹åŒ–<code>Box</code>ç±»ï¼Œä»¥ä¾¿ä¸ºæ•´æ•°æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è‡ªåŠ¨å¢åŠ ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;</span><span class="keyword">int</span>&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; data = value + <span class="number">1</span>; &#125; <span class="comment">// è‡ªåŠ¨å¢åŠ </span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> data; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œ<code>Box&lt;int&gt;</code>çš„è¡Œä¸ºå°±ä¸<code>Box&lt;T&gt;</code>çš„é€šç”¨ç‰ˆæœ¬ä¸åŒäº†ã€‚</p><h4 id="å®Œå…¨ç‰¹åŒ–ä¸éƒ¨åˆ†ç‰¹åŒ–"><a href="#å®Œå…¨ç‰¹åŒ–ä¸éƒ¨åˆ†ç‰¹åŒ–" class="headerlink" title="å®Œå…¨ç‰¹åŒ–ä¸éƒ¨åˆ†ç‰¹åŒ–"></a>å®Œå…¨ç‰¹åŒ–ä¸éƒ¨åˆ†ç‰¹åŒ–</h4><p>å®Œå…¨ç‰¹åŒ–æ˜¯æŒ‡ä¸ºæ¨¡æ¿çš„æ‰€æœ‰å‚æ•°æŒ‡å®šç‰¹å®šç±»å‹ï¼Œå¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤ºã€‚éƒ¨åˆ†ç‰¹åŒ–æ˜¯æŒ‡åªæŒ‡å®šæ¨¡æ¿çš„éƒ¨åˆ†å‚æ•°ï¼Œé€šå¸¸ç”¨äºå¤šå‚æ•°æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éƒ¨åˆ†ç‰¹åŒ–Pair&lt;int, int&gt;</span></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;</span><span class="keyword">int</span>, <span class="keyword">int</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="å‡½æ•°æ¨¡æ¿å®ä¾‹åŒ–"><a href="#å‡½æ•°æ¨¡æ¿å®ä¾‹åŒ–" class="headerlink" title="å‡½æ•°æ¨¡æ¿å®ä¾‹åŒ–"></a>å‡½æ•°æ¨¡æ¿å®ä¾‹åŒ–</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">max</span><span class="params">(T a, T b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a &gt; b ? a : b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">10</span>, y = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">int</span> z = max&lt;<span class="keyword">int</span>&gt;(x, y); <span class="comment">// å‡½æ•°æ¨¡æ¿å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é™å®šç±»å‹"><a href="#é™å®šç±»å‹" class="headerlink" title="é™å®šç±»å‹"></a>é™å®šç±»å‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span> = std::<span class="keyword">enable_if_t</span>&lt;std::is_arithmetic_v&lt;T&gt;&gt;&gt;</span><br><span class="line">class NumericWrapper &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NumericWrapper</span>(T value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        data = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getData</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>c++20ä»¥ä¸Šä½¿ç”¨<strong>concept</strong>èƒ½å¤Ÿå¥½åšé™åˆ¶,è¿™é‡Œä¸åšè¯¦ç»†ä»‹ç».<a href="https://en.cppreference.com/w/cpp/concepts">Concepts library (since C++20) - cppreference.com</a></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">concept</span> NumericType = std::is_arithmetic_v&lt;T&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;NumericType T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumericWrapper</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NumericWrapper</span>(T value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        data = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getData</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">NumericWrapper&lt;<span class="keyword">int</span>&gt; <span class="title">intWrapper</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="function">NumericWrapper&lt;<span class="keyword">double</span>&gt; <span class="title">doubleWrapper</span><span class="params">(<span class="number">3.14</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„å£°æ˜ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯</span></span><br><span class="line">    <span class="comment">// NumericWrapper&lt;std::string&gt; stringWrapper(&quot;Hello&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SFINAEä¸enable-if"><a href="#SFINAEä¸enable-if" class="headerlink" title="SFINAEä¸enable_if"></a>SFINAEä¸enable_if</h4><p>ä½¿ç”¨ <code>std::enable_if</code> å’Œ SFINAEï¼ˆSubstitution Failure Is Not An Error,æ›¿ä»£é”™è¯¯ä¸æ˜¯é”™è¯¯ï¼‰æ¥é™å®šç±»å‹ã€‚è¿™ç§æ–¹æ³•å…è®¸ä½ åœ¨æ¨¡æ¿çš„å®šä¹‰é˜¶æ®µå°±æ’é™¤ä¸ç¬¦åˆè¦æ±‚çš„ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> = <span class="keyword">void</span>&gt;</span><br><span class="line">class NumericWrapper &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NumericWrapper</span>(T value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        data = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getData</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumericWrapper</span>&lt;</span>T, std::<span class="keyword">enable_if_t</span>&lt;std::is_arithmetic_v&lt;T&gt;&gt;&gt; &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NumericWrapper</span>(T value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        data = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getData</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">NumericWrapper&lt;<span class="keyword">int</span>&gt; <span class="title">intWrapper</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="function">NumericWrapper&lt;<span class="keyword">double</span>&gt; <span class="title">doubleWrapper</span><span class="params">(<span class="number">3.14</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„å£°æ˜ä¸ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œä½†ä¼šç”Ÿæˆä¸€ä¸ªç©ºæ¨¡æ¿å®ä¾‹</span></span><br><span class="line">    <span class="function">NumericWrapper&lt;std::string&gt; <span class="title">stringWrapper</span><span class="params">(<span class="string">&quot;Hello&quot;</span>)</span></span>; <span class="comment">// ä¸ç¬¦åˆè¦æ±‚çš„ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><p>æ¨¡æ¿ç‰¹åŒ–å¸¸ç”¨äºï¼š</p><ul><li>ä¸ºç‰¹å®šç±»å‹æä¾›æ›´é«˜æ•ˆçš„å®ç°ã€‚</li><li>è§£å†³æŸäº›ç±»å‹ä¸é€‚ç”¨çš„é€šç”¨ç®—æ³•é—®é¢˜ã€‚</li><li>æä¾›å¯¹åŸºæœ¬ç±»å‹å’Œç”¨æˆ·å®šä¹‰ç±»å‹çš„ç»Ÿä¸€æ¥å£ï¼ŒåŒæ—¶ä¿æŒå†…éƒ¨å®ç°çš„å·®å¼‚æ€§ã€‚</li></ul><h3 id="æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨åœºæ™¯"><a href="#æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨åœºæ™¯"></a>æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨åœºæ™¯</h3><p>æ™ºèƒ½æŒ‡é’ˆæ˜¯C++ä¸­ç”¨æ¥è‡ªåŠ¨ç®¡ç†åŠ¨æ€åˆ†é…å†…å­˜çš„ä¸€ç§æ‰‹æ®µï¼Œèƒ½å¸®åŠ©é¿å…å†…å­˜æ³„æ¼å’Œå…¶ä»–ä¸æ‰‹åŠ¨ç®¡ç†å†…å­˜ç›¸å…³çš„é—®é¢˜.</p><p>æ™ºèƒ½æŒ‡é’ˆæœ¬èº«ä¹Ÿæ˜¯æŒ‡é’ˆ,ä½†æ˜¯ä¼šé€šè¿‡ç¼–è¯‘å™¨è‡ªåŠ¨ç®¡ç†,è¡¨ç°è¡Œä¸ºåƒä¸€ä¸ªæ ˆä¸Šçš„å˜é‡ä¸€æ ·,åœ¨ä½œç”¨åŸŸä¹‹å¤–å°±ä¼šè‡ªåŠ¨ææ„.</p><p><code>std::unique_ptr</code>æ˜¯ä¸€ç§ç‹¬å æ‰€æœ‰æƒçš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒä¿è¯äº†å¯¹æ‰€æŒ‡å‘å¯¹è±¡çš„ç‹¬å è®¿é—®ã€‚è¿™æ„å‘³ç€åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ª<code>std::unique_ptr</code>å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨newåˆ†é…å†…å­˜ï¼Œå¹¶ä½¿ç”¨std::unique_ptrç®¡ç†</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;<span class="keyword">int</span>&gt; <span class="title">uptr</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨std::make_uniqueç®€åŒ–åˆ›å»ºè¿‡ç¨‹</span></span><br><span class="line">    std::unique_ptr&lt;<span class="keyword">int</span>&gt; uptr2 = std::make_unique&lt;<span class="keyword">int</span>&gt;(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¿é—®æ™ºèƒ½æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;uptr points to: &quot;</span> &lt;&lt; *uptr &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;uptr2 points to: &quot;</span> &lt;&lt; *uptr2 &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unique_ptråœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>std::shared_ptr</code>å…è®¸å¤šä¸ªæŒ‡é’ˆå…±äº«åŒä¸€å¯¹è±¡çš„æ‰€æœ‰æƒã€‚å½“æœ€åä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„<code>std::shared_ptr</code>é”€æ¯æ—¶ï¼Œå¯¹è±¡çš„å†…å­˜ä¼šè¢«é‡Šæ”¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªshared_ptr</span></span><br><span class="line">    std::shared_ptr&lt;<span class="keyword">int</span>&gt; sptr1 = std::make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»sptr1å¤åˆ¶æ‰€æœ‰æƒ</span></span><br><span class="line">    std::shared_ptr&lt;<span class="keyword">int</span>&gt; sptr2 = sptr1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¿é—®æ™ºèƒ½æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sptr1 points to: &quot;</span> &lt;&lt; *sptr1 &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sptr2 points to: &quot;</span> &lt;&lt; *sptr2 &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shared_ptråœ¨å¼•ç”¨è®¡æ•°å˜ä¸º0æ—¶é‡Šæ”¾å†…å­˜</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>std::weak_pträ¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå®ƒç”¨äºè§‚å¯Ÿstd::shared_ptræ‰€ç®¡ç†çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šå½±å“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“std::shared_pträ¸å†å­˜åœ¨æ—¶ï¼Œstd::weak_ptrå¯ä»¥è¢«ç”¨æ¥æ£€æŸ¥å¯¹è±¡æ˜¯å¦è¿˜æ´»ç€ï¼Œå¹¶é”å®šä¸€ä¸ªstd::shared_ptrã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªshared_ptr</span></span><br><span class="line">    std::shared_ptr&lt;<span class="keyword">int</span>&gt; sptr = std::make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªweak_ptr</span></span><br><span class="line">    std::weak_ptr&lt;<span class="keyword">int</span>&gt; wptr = sptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥weak_ptræ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (!wptr.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">        std::shared_ptr&lt;<span class="keyword">int</span>&gt; sptr2 = wptr.<span class="built_in">lock</span>(); <span class="comment">// é”å®šä¸€ä¸ªshared_ptr</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;wptr points to: &quot;</span> &lt;&lt; *sptr2 &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾shared_ptrï¼Œè§‚å¯Ÿweak_ptrçš„è¡Œä¸º</span></span><br><span class="line">    sptr.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†æ¬¡æ£€æŸ¥weak_ptræ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (wptr.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;The object has been deleted.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¨¡æ¿ç±»çš„å‹å…ƒå‡½æ•°é‡è½½-lt-lt-ç¬¦å·"><a href="#æ¨¡æ¿ç±»çš„å‹å…ƒå‡½æ•°é‡è½½-lt-lt-ç¬¦å·" class="headerlink" title="æ¨¡æ¿ç±»çš„å‹å…ƒå‡½æ•°é‡è½½&lt;&lt;ç¬¦å·"></a>æ¨¡æ¿ç±»çš„å‹å…ƒå‡½æ•°é‡è½½&lt;&lt;ç¬¦å·</h3><p>ç»™ä¸€ä¸ªæ¨¡æ¿ç±»å†™ä¸ªå‹å…ƒå‡½æ•°é‡è½½<code>&lt;&lt;</code>æ–¹ä¾¿ostreamè¾“å‡ºä¿¡æ¯,ä½†æ˜¯æŠ¥é”™é“¾æ¥å‡ºé”™.</p><p><a href="https://blog.csdn.net/Move_now/article/details/64530664">å‡½æ•°æ¨¡æ¿å’Œå‹å…ƒé‡è½½è¿ç®—ç¬¦æŠ¥â€æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦â€çš„è§£å†³æ–¹æ³•_è¾“å‡ºè¿ç®—ç¬¦é‡è½½ æ— æ³•è§£æ-CSDNåšå®¢</a></p><p><strong>ä¸¤æ¬¡ç¼–è¯‘çš„å‡½æ•°å¤´ä¸ä¸€æ ·ï¼Œå› ä¸ºå‹å…ƒå‡½æ•°å¹¶ä¸å±äºç±»çš„æˆå‘˜å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å£°æ˜æ­¤å‹å…ƒå‡½æ•°æ˜¯å‡½æ•°æ¨¡æ¿</strong>ï¼Œå¦‚æœæ²¡æœ‰å£°æ˜ï¼Œä½†æ˜¯åé¢åœ¨å®ç°çš„æ—¶å€™åˆä½¿ç”¨äº†<code>template &lt;class T&gt;</code>ï¼Œå°±ä¼šå¯¼è‡´é”™è¯¯çš„å‘ç”Ÿã€‚</p><h3 id="å³å€¼å’Œç§»åŠ¨"><a href="#å³å€¼å’Œç§»åŠ¨" class="headerlink" title="å³å€¼å’Œç§»åŠ¨"></a>å³å€¼å’Œç§»åŠ¨</h3><blockquote><p>Use std::move(x) to turn x, an l-value, to an r-value so  that you can immediately take its resources</p></blockquote><ul><li><p><strong>æ³›å·¦å€¼</strong>ï¼ˆâ€œæ³›åŒ– (generalized)â€çš„å·¦å€¼ï¼‰æ˜¯ä¸€ä¸ª<strong>æ±‚å€¼å¯ç¡®å®šæŸä¸ªå¯¹è±¡æˆ–å‡½æ•°çš„æ ‡è¯†çš„è¡¨è¾¾å¼</strong>ï¼›</p></li><li><p>çº¯å³å€¼</p><p>ï¼ˆâ€œçº¯ (pure)â€çš„å³å€¼ï¼‰æ˜¯æ±‚å€¼ç¬¦åˆä¸‹åˆ—ä¹‹ä¸€çš„è¡¨è¾¾å¼ï¼š</p><ul><li>è®¡ç®—æŸä¸ªè¿ç®—ç¬¦çš„æ“ä½œæ•°çš„å€¼ï¼ˆè¿™ç§çº¯å³å€¼æ²¡æœ‰<em>ç»“æœå¯¹è±¡</em>ï¼‰</li><li>åˆå§‹åŒ–æŸä¸ªå¯¹è±¡ï¼ˆç§°è¿™ç§çº¯å³å€¼æœ‰ä¸€ä¸ª<em>ç»“æœå¯¹è±¡</em>ï¼‰</li></ul></li><li><p><strong>äº¡å€¼</strong>ï¼ˆâ€œå°†äº¡ (expiring)â€çš„å€¼ï¼‰æ˜¯ä»£è¡¨å®ƒçš„èµ„æºèƒ½å¤Ÿè¢«é‡æ–°ä½¿ç”¨çš„å¯¹è±¡æˆ–ä½åŸŸçš„æ³›å·¦å€¼ï¼›</p></li><li><strong>å·¦å€¼ (lvalue)</strong> æ˜¯å¹¶éäº¡å€¼çš„æ³›å·¦å€¼ï¼›</li></ul><p>ç§»åŠ¨è¯­ä¹‰å…è®¸åœ¨å¯¹è±¡ä»ä¸€ä¸ªä½ç½®ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®æ—¶ï¼Œé€šè¿‡ç§»åŠ¨è€Œéå¤åˆ¶å¯¹è±¡çš„çŠ¶æ€ï¼Œä»è€Œé¿å…äº†æ˜‚è´µçš„å¤åˆ¶æ“ä½œã€‚è¿™åœ¨å¤„ç†å¤§å‹å¯¹è±¡æˆ–èµ„æºï¼ˆå¦‚æ–‡ä»¶å¥æŸ„ã€æ™ºèƒ½æŒ‡é’ˆï¼‰æ—¶å°¤å…¶é‡è¦ï¼Œå› ä¸ºç§»åŠ¨è¯­ä¹‰å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚</p><p>å³å€¼é€šå¸¸ç”¨æ¥è¡¨ç¤ºä¸´æ—¶å¯¹è±¡æˆ–å­—é¢é‡ï¼Œè¿™äº›å¯¹è±¡åœ¨è¡¨è¾¾å¼æ±‚å€¼åå°±ä¸å†éœ€è¦ã€‚ä¾‹å¦‚ï¼Œå‡½æ•°è¿”å›çš„ä¸´æ—¶å¯¹è±¡ã€æ„é€ å‡½æ•°å‚æ•°ä¸­çš„å­—é¢é‡ç­‰éƒ½æ˜¯å³å€¼</p><p>å³å€¼å¼•ç”¨ç”¨äºå®ç°ç§»åŠ¨è¯­ä¹‰</p><h3 id="OOP-in-C"><a href="#OOP-in-C" class="headerlink" title="OOP in C++"></a>OOP in C++</h3><blockquote><p>C++ä¸­çš„é¢å‘å¯¹è±¡è®¾è®¡ä¹Ÿè®¸å¹¶ä¸å¥½æˆ–è€…è¯´ç³Ÿç³•</p></blockquote><p>ç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªç±»é»˜è®¤ç”Ÿæˆç‰¹åˆ«æ–¹æ³•,åŒ…æ‹¬</p><ul><li>æ— å‚æ„é€ </li><li>æ‹·è´æ„é€ </li><li>æ‹·è´èµ‹å€¼</li><li>ç§»åŠ¨æ„é€ </li><li>ç§»åŠ¨èµ‹å€¼</li><li>ææ„æ–¹æ³•</li></ul><p>å¦‚æœç±»ä¸­çš„å˜é‡æ²¡æœ‰äººä¸ºå†…å­˜çš„åˆ†é…,ä¹Ÿè®¸ä½ å¹¶ä¸éœ€è¦æ˜¾å¼å£°æ˜æ‹·è´ã€ç§»åŠ¨ä¸ææ„æ–¹æ³•.</p><p>å½“å£°æ˜æ‹·è´æ„é€ ã€èµ‹å€¼æ—¶,æœ€å¥½å£°æ˜ç§»åŠ¨æ„é€ ã€èµ‹å€¼ä»¥åŠææ„æ–¹æ³•.</p><p><code>std::move</code>åœ¨ç§»åŠ¨æ„é€ ã€èµ‹å€¼ä¸­ä½¿ç”¨,è¡¨æ˜éœ€è¦ä½¿ç”¨ç§»åŠ¨æ“ä½œ,è€Œä¸è¦åœ¨mainä¸­ä½¿ç”¨.</p><h4 id="Type-Safety"><a href="#Type-Safety" class="headerlink" title="Type Safety"></a>Type Safety</h4><blockquote><p>Type Safety: The extent to  which a language prevents  typing errors</p></blockquote><p>ä½¿ç”¨<code>std::optional</code></p><h2 id="Beyond-C-2a"><a href="#Beyond-C-2a" class="headerlink" title="Beyond C++2a"></a>Beyond C++2a</h2><h3 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">concept</span> Addable = <span class="built_in">requries</span>(T a, T b) &#123;</span><br><span class="line">  a + b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">  <span class="keyword">requires</span> Addable&lt;T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">add</span><span class="params">(T a, T b)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;Addable T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">add</span><span class="params">(T a,T b)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™åˆ¶æ³›å‹ä¸­å‚æ•°çš„ç±»å‹. </p><p><img data-src="https://s2.loli.net/2024/08/19/C6l2sNhcEtTBwa7.png" alt="image-20240819005006425"></p><h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h3><p>ç›®å‰æˆ‘è®¤ä¸ºæ¨¡å—æœºåˆ¶åœ¨c++ç”Ÿæ€ç”¨å¾—ä¸æ˜¯å¾ˆå¤š,æƒå½“äº†è§£å³å¯.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">module</span> myModule</span></span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">import</span> myModule</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">sayHello</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.geeksforgeeks.org/modules-in-cpp-20/">Modules in C++ 20 - GeeksforGeeks</a></p><h3 id="std-ranges"><a href="#std-ranges" class="headerlink" title="std::ranges"></a>std::ranges</h3><p>å¼•å…¥å¤´æ–‡ä»¶<code>#include&lt;ranges&gt;</code>å’Œ<code>#include&lt;algorithms&gt;</code></p><p>å¸¸ç”¨çš„ä¸€äº›ç®—æ³•é€šå¸¸æ˜¯å¯¹è¿­ä»£å™¨è¿›è¡Œæ“ä½œ(STL)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="built_in">sort</span>(v.<span class="built_in">begin</span>(),v.<span class="built_in">end</span>());</span><br><span class="line">std::<span class="built_in">sort</span>(v.<span class="built_in">begin</span>()+<span class="number">1</span>,v.<span class="built_in">end</span>());</span><br></pre></td></tr></table></figure><p>åœ¨å¼•å…¥rangeså,æœ‰äº†æ›´åŠ ç»Ÿä¸€çš„æ–¹æ³•</p><blockquote><p>rangesæ˜¯â€œé¡¹çš„é›†åˆâ€æˆ–â€œå¯è¿­ä»£çš„ä¸œè¥¿â€çš„æŠ½è±¡ã€‚æœ€åŸºæœ¬çš„å®šä¹‰åªè¦æ±‚åœ¨rangesä¸Šå­˜åœ¨begin()å’Œend()</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::ranges::<span class="built_in">sort</span>(std::views::<span class="built_in">drop</span>(v,<span class="number">5</span>));</span><br><span class="line">std::ranges::<span class="built_in">sort</span>(std::views::<span class="built_in">reverse</span>(v));</span><br><span class="line">std::ranges::<span class="built_in">sort</span>(std::views::<span class="built_in">drop</span>(std::views::<span class="built_in">reverse</span>(v),<span class="number">5</span>));</span><br></pre></td></tr></table></figure><p>æœ‰å¤šä¸ªå…³äºrangesçš„concept</p><div class="table-container"><table><thead><tr><th>Concept</th><th>Description</th></tr></thead><tbody><tr><td><code>std::ranges::input_range</code></td><td>can be iterated from beginning to end <strong>at least once</strong></td></tr><tr><td><code>std::ranges::forward_range</code></td><td>can be iterated from beginning to end <strong>multiple times</strong></td></tr><tr><td><code>std::ranges::bidirectional_range</code></td><td>iterator can also move backwards with <code>--</code></td></tr><tr><td><code>std::ranges::random_access_range</code></td><td>you can jump to elements <strong>in constant-time</strong> <code>[]</code></td></tr><tr><td><code>std::ranges::contiguous_range</code></td><td>elements are always stored consecutively in memory</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th style="text-align:center"><code>std::forward_list</code></th><th style="text-align:center"><code>std::list</code></th><th style="text-align:center"><code>std::deque</code></th><th style="text-align:center"><code>std::array</code></th><th style="text-align:center"><code>std::vector</code></th><th></th></tr></thead><tbody><tr><td style="text-align:center"><code>std::ranges::input_range</code></td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td>âœ…</td></tr><tr><td style="text-align:center"><code>std::ranges::forward_range</code></td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td>âœ…</td></tr><tr><td style="text-align:center"><code>std::ranges::bidirectional_range</code></td><td style="text-align:center"></td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td>âœ…</td></tr><tr><td style="text-align:center"><code>std::ranges::random_access_range</code></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">âœ…</td><td style="text-align:center">âœ…</td><td>âœ…</td></tr><tr><td style="text-align:center"><code>std::ranges::contiguous_range</code></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">âœ…</td><td>âœ…</td></tr></tbody></table></div><p>viewsçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯ï¼Œæ— è®ºå®ƒä»¬åº”ç”¨äº†ä»€ä¹ˆè½¬æ¢ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨è¯·æ±‚å…ƒç´ çš„æ—¶å€™è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯åœ¨åˆ›å»ºviewsçš„æ—¶å€™</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::vector vec&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line"><span class="keyword">auto</span> v = vec | std::views::reverse | std::views::<span class="built_in">drop</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; *v.<span class="built_in">begin</span>() &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure><p>viewsæ˜¯ä¸€ç§ç‰¹å®šç±»å‹çš„rangesï¼Œåœ¨std::ranges::viewä¸­è¢«å½¢å¼åŒ–ã€‚</p><h3 id="C-20ä¹‹åå®šä¹‰æ¯”è¾ƒè¿ç®—ç¬¦"><a href="#C-20ä¹‹åå®šä¹‰æ¯”è¾ƒè¿ç®—ç¬¦" class="headerlink" title="C++20ä¹‹åå®šä¹‰æ¯”è¾ƒè¿ç®—ç¬¦"></a>C++20ä¹‹åå®šä¹‰æ¯”è¾ƒè¿ç®—ç¬¦</h3><p>ä¸ºäº†æ£€æŸ¥æ˜¯å¦ç›¸ç­‰ï¼Œç°åœ¨å®šä¹‰ == æ“ä½œç¬¦å°±å¤Ÿäº†ã€‚ <strong>å½“ç¼–è¯‘å™¨æ‰¾ä¸åˆ°è¡¨è¾¾å¼çš„åŒ¹é…å£°æ˜ a!=b æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé‡å†™è¡¨è¾¾å¼å¹¶æŸ¥æ‰¾!(a\==b)ã€‚è‹¥è¿™ä¸èµ·ä½œç”¨ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå°è¯•æ”¹å˜æ“ä½œæ•°çš„é¡ºåºï¼Œæ‰€ä»¥ä¹Ÿä¼šå°è¯•!(b==a)</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> TypeA&amp;, <span class="keyword">const</span> TypeB&amp;)Í¾</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">struct NullTerm &#123;</span><br><span class="line">  <span class="keyword">bool</span> <span class="keyword">operator</span>== (<span class="keyword">auto</span> pos) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *pos == <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// end is where iterator points to \verb+&#x27;\0&#x27;+</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ‰€æœ‰çš„å…³ç³»æ“ä½œç¬¦ï¼Œæ²¡æœ‰ç­‰ä»·çš„è§„åˆ™è¯´å®šä¹‰å°äºæ“ä½œç¬¦å°±è¶³å¤Ÿäº†ã€‚ä½†ç°åœ¨ï¼Œåªéœ€è¦å®šä¹‰æ–°çš„æ“ä½œç¬¦ &lt;=&gt; å³å¯ã€‚</p><p>é€šå¸¸ï¼Œ== å¯ä»¥é€šè¿‡å®šä¹‰ == å’Œ!= æ“ä½œç¬¦æ¥å¤„ç†å¯¹è±¡çš„ç›¸ç­‰æ€§ï¼Œè€Œ &lt;=&gt; æ“ä½œç¬¦é€šè¿‡å®šä¹‰å…³ç³»æ“ä½œ ç¬¦æ¥å¤„ç†å¯¹è±¡çš„é¡ºåºã€‚è‹¥é€šè¿‡ =default å£°æ˜æ“ä½œç¬¦ &lt;=&gt;ï¼Œåˆ™å¯ä»¥ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„è§„åˆ™ï¼Œå³é»˜è®¤æˆå‘˜æ“ä½œç¬¦ &lt;=&gt;:</p><p>â€¢ è‹¥æ¯”è¾ƒæˆå‘˜ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æ˜¯ noexcept </p><p>â€¢ è‹¥å¯åœ¨ç¼–è¯‘æ—¶æ¯”è¾ƒæˆå‘˜ï¼Œåˆ™æ˜¯ constexpr </p><p>â€¢ å› ä¸ºé‡å†™ï¼Œè¿˜å¯ä»¥æ”¯æŒç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„éšå¼ç±»å‹è½¬æ¢</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œ== å’Œ &lt;=&gt; æ“ä½œç¬¦å¤„ç†ä¸åŒä½†ç›¸å…³çš„äº‹æƒ…: â€¢ == æ“ä½œç¬¦å®šä¹‰ç›¸ç­‰æ€§ï¼Œå¯ç”±ç›¸ç­‰æ“ä½œç¬¦ == å’Œ!= ä½¿ç”¨ã€‚ â€¢ &lt;=&gt; æ“ä½œç¬¦å®šä¹‰äº†æ’åºï¼Œå¯ä»¥ç”±å…³ç³»æ“ä½œç¬¦ &lt;ã€&lt;=ã€&gt; å’Œ &gt;= ä½¿ç”¨</p><h3 id="autoç±»å‹æ¨æ–­"><a href="#autoç±»å‹æ¨æ–­" class="headerlink" title="autoç±»å‹æ¨æ–­"></a>autoç±»å‹æ¨æ–­</h3><p>c++20ä¹‹å,åœ¨æ™®é€šå‡½æ•°ä¸­å³å¯ä½¿ç”¨.</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol><li><p>static,inlineå’Œextern. é“¾æ¥ç±»å‹</p><p>é“¾æ¥ä½¿ç”¨linkerå°†å¤šä¸ªç¼–è¯‘å¾—åˆ°.oæ–‡ä»¶é“¾æ¥ä¸ºå¯æ‰§è¡Œç¨‹åº. å¤šä¸ªé“¾æ¥å•å…ƒä¸å…è®¸é‡å¤å®šä¹‰çš„å˜é‡æˆ–å‡½æ•°ç­‰.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240909213919267.png" alt="image-20240909213919267"></p></li></ol><p>inline,é¿å…å¤šæ¬¡å®šä¹‰<br>inline ä¿®é¥°çš„å‡½æ•°å…·æœ‰å¤–éƒ¨é“¾æ¥å±æ€§(externallinkage)ã€‚åœ¨é“¾æ¥æ—¶,åªä¼šä¿ç•™ä¸€ä¸ªå®šä¹‰ã€‚C++17 å¼•å…¥äº†å†…è”å˜é‡ï¼ˆinline variableï¼‰çš„æ¦‚å¿µï¼Œ<strong>å…è®¸åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å˜é‡è€Œä¸ä¼šè¿å One Definition Ruleï¼ˆODRï¼‰</strong>ã€‚<br>è¦å£°æ˜å†…è”å˜é‡,å¯ä»¥åœ¨å˜é‡å£°æ˜å‰åŠ ä¸Š inline å…³é”®å­—ã€‚è¿™å‘Šè¯‰ç¼–è¯‘å™¨å…è®¸å¤šä¸ªç¼–è¯‘å•å…ƒä¸­éƒ½æœ‰è¿™ä¸ªå˜é‡çš„å®šä¹‰,è€Œä¸ä¼šå¼•å‘ ODR é”™è¯¯<br>static,å†…éƒ¨é“¾æ¥å±æ€§(internal linkage),ä¿®é¥°çš„å…¨å±€å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå®šä¹‰å®ƒçš„æ–‡ä»¶ã€‚è¿™æ„å‘³ç€å…¶ä»–æ–‡ä»¶æ— æ³•è®¿é—®è¯¥å˜é‡,ä½¿ç”¨ static å¯ä»¥é¿å…å‘½åå†²çªï¼Œå› ä¸ºæ¯ä¸ªæºæ–‡ä»¶ä¸­çš„ staticå˜é‡æ˜¯ç‹¬ç«‹çš„ï¼Œå³ä½¿å®ƒä»¬åŒåä¹Ÿä¸ä¼šäº’ç›¸å¹²æ‰°<br>extern,ç”¨äºå£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡æˆ–å‡½æ•°,è¡¨æ˜è¯¥å˜é‡æˆ–å‡½æ•°åœ¨å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰ã€‚å®ƒå…è®¸åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨å¦ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡<br>å½“ extern ç”¨äºå£°æ˜ä¸€ä¸ªå˜é‡æˆ–å‡½æ•°æ—¶,å®ƒæŒ‡å®šè¯¥ç¬¦å·å…·æœ‰å¤–éƒ¨é“¾æ¥å±æ€§<br>é€šå¸¸åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰/å£°æ˜å…¨å±€å˜é‡ï¼Œä»¥ä¾¿å…¶ä»–æºæ–‡ä»¶å¯ä»¥åŒ…å«è¯¥å¤´æ–‡ä»¶å¹¶ä½¿ç”¨è¿™äº›å˜é‡<br>åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤å®šä¹‰åŒåçš„ extern å˜é‡,ä¼šå¯¼è‡´é“¾æ¥é”™è¯¯<br>å¤–éƒ¨é“¾æ¥å±æ€§æ„å‘³ç€è¯¥ç¬¦å·å¯ä»¥è¢«ç¨‹åºä¸­çš„å…¶ä»–ç¿»è¯‘å•å…ƒè®¿é—®ã€‚<br>å¯¹äºå‡½æ•°,é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬å°±å…·æœ‰å¤–éƒ¨é“¾æ¥å±æ€§,æ— éœ€ä½¿ç”¨ extern å…³é”®å­—ã€‚</p><blockquote><p>åœ¨ C++ ä¸­ï¼Œç±»çš„æˆå‘˜æ–¹æ³•å¦‚æœåœ¨ç±»çš„å®šä¹‰ä¸­ç›´æ¥å®ç°,åˆ™é»˜è®¤æ˜¯ <strong>inline</strong> çš„.å†…è”å‡½æ•°å…·æœ‰å¤–éƒ¨é“¾æ¥å±æ€§ï¼Œæ˜¯å¼±ç¬¦å·ã€‚åœ¨ç±»å¤–å®ç°é»˜è®¤ä¸æ˜¯inline,å¯¹åº”å¼ºç¬¦å·ã€‚</p><p>ä¸€èˆ¬å°†ä¸éœ€è¦å†…è”çš„æˆå‘˜å‡½æ•°çš„å®šä¹‰ç¼–å†™åœ¨.cppæ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯,è¿™æ ·å¤šä¸ªå…¶ä»–æ–‡ä»¶å¼•å…¥å¤´æ–‡ä»¶æ—¶ä¸ä¼šé€ æˆé‡å®šä¹‰.</p></blockquote><ol><li><p>æ¨¡æ¿å£°æ˜å’Œå®šä¹‰æ”¾ä¸€ä¸ªæ–‡ä»¶çš„ç›®çš„.</p><p>åœ¨ä½¿ç”¨æ¨¡æ¿æ—¶ï¼Œè¿™ç§ä¹ æƒ¯æ€§åšæ³•å°†å˜å¾—ä¸å†æœ‰ç”¨ï¼Œ<strong>å› ä¸ºå½“å®ä¾‹åŒ–ä¸€ä¸ªæ¨¡æ¿æ—¶ï¼Œç¼–è¯‘å™¨å¿…é¡»çœ‹åˆ°æ¨¡æ¿ç¡®åˆ‡çš„å®šä¹‰ï¼Œè€Œä¸ä»…ä»…æ˜¯å®ƒçš„å£°æ˜</strong>ã€‚å› æ­¤ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯å°†æ¨¡æ¿çš„å£°æ˜å’Œå®šä¹‰éƒ½æ”¾ç½®åœ¨åŒä¸€ä¸ª.hæ–‡ä»¶</p><p>å› ä¸ºåœ¨ç¼–è¯‘æ—¶æ¨¡æ¿å¹¶ä¸èƒ½ç”ŸæˆçœŸæ­£çš„äºŒè¿›åˆ¶ä»£ç ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘è°ƒç”¨æ¨¡æ¿ç±»æˆ–å‡½æ•°çš„CPPæ–‡ä»¶æ—¶æ‰ä¼šå»æ‰¾å¯¹åº”çš„æ¨¡æ¿å£°æ˜å’Œå®ç°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç¼–è¯‘å™¨æ˜¯ä¸çŸ¥é“å®ç°æ¨¡æ¿ç±»æˆ–å‡½æ•°çš„CPPæ–‡ä»¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥å®ƒåªèƒ½æ‰¾åˆ°æ¨¡æ¿ç±»æˆ–å‡½æ•°çš„å£°æ˜è€Œæ‰¾ä¸åˆ°å®ç°ï¼Œè€Œåªå¥½åˆ›å»ºä¸€ä¸ªç¬¦å·å¯„å¸Œæœ›äºé“¾æ¥ç¨‹åºæ‰¾åœ°å€ã€‚ä½†æ¨¡æ¿ç±»æˆ–å‡½æ•°çš„å®ç°å¹¶ä¸èƒ½è¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶ä»£ç ï¼Œç»“æœé“¾æ¥ç¨‹åºæ‰¾ä¸åˆ°åœ°å€åªå¥½æŠ¥é”™äº†ã€‚</p></li></ol><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.learncpp.com/">Learn C++ â€“ Skill up with our free tutorials (learncpp.com)</a></li><li><a href="https://cplusplus.com/">cplusplus.com</a></li><li><a href="https://en.cppreference.com/w/">cppreference.com</a></li><li><a href="https://changkun.de/modern-cpp/">ç°ä»£ C++ æ•™ç¨‹: é«˜é€Ÿä¸Šæ‰‹ C++ 11/14/17/20 - Modern C++ Tutorial: C++ 11/14/17/20 On the Fly (changkun.de)</a></li><li><a href="https://learn-cpp.guyutongxue.site/">é¦–é¡µ | è°·é›¨åŒå­¦çš„ C++ æ•™ç¨‹ (guyutongxue.site)</a></li><li><a href="https://web.stanford.edu/class/cs106l/index.html">CS 106L: Standard C++ Programming (stanford.edu)</a></li><li>Best Practices<a href="https://lefticus.gitbooks.io/cpp-best-practices/content">https://lefticus.gitbooks.io/cpp-best-practices/content</a></li></ul><p>cppä¹¦å•<a href="https://stackoverflow.com/questions/388242/the-definitive-c-book-guide-and-list">c++ faq - The Definitive C++ Book Guide and List - Stack Overflow</a></p><p>æ„Ÿè°¢å¤§æ¨¡å‹çš„è¾…åŠ©</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰å†™è¿‡modern cppå­¦ä¹ ,ä½†æ˜¯åªæ˜¯è¿‡äº†ä¸€éæ–‡å­—. æœ€è¿‘æˆ‘åœ¨ä½¿ç”¨c++é‡å†™karpathyçš„micrograd,å­¦åˆ°äº†å¾ˆå¤š.è¿™é‡Œè®°å½•ä¸€ä¸‹é‡è¦çš„ä¸œè¥¿&lt;/p&gt;</summary>
    
    
    
    
    <category term="cpp" scheme="https://www.sekyoro.top/tags/cpp/"/>
    
  </entry>
  
  <entry>
    <title>å­¦ä¹ llama3</title>
    <link href="https://www.sekyoro.top/2024/07/08/%E5%AD%A6%E4%B9%A0llama3/"/>
    <id>https://www.sekyoro.top/2024/07/08/%E5%AD%A6%E4%B9%A0llama3/</id>
    <published>2024-07-08T06:44:29.000Z</published>
    <updated>2024-07-08T15:22:46.235Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>llama3æ˜¯metaå¼€æºçš„å¤§æ¨¡å‹,åœ¨å¼€æºå¤§æ¨¡å‹ä¸­å ç€é‡è¦åœ°ä½,åœ¨è¿™ä¹‹å‰å¯èƒ½æ˜¯Mistral,ç›®å‰ä¹Ÿæœ‰gemma2,Qwen2ä»¥åŠå¾®è½¯çš„Phi3ç­‰.<br><span id="more"></span></p><p>llamaè¡¨ç°å¾ˆä¸é”™,<a href="https://toloka.ai/llm-leaderboard/">LLM Leaderboard (toloka.ai)</a>,å¾ˆå¤šæ¨¡å‹éƒ½æ˜¯åœ¨å®ƒåŸºç¡€ä¸Šå¾®è°ƒå¾—åˆ°çš„.</p><p>è¿™é‡Œå°†llamaä»‹ç»åˆ†ä¸ºä½ç½®ç¼–ç ,transformerå±‚,ffnå±‚ä»¥åŠå…¶ä¸­çš„normçš„æ”¹è¿›.</p><p>llama3ç›¸æ¯”äºllama2,ä¸Šä¸‹æ–‡çª—å£å¢å¤§,tokenizerä»sentencepieceå˜ä¸ºtiktoken,tokenæ•°ä¹Ÿå¢å¤šäº†.</p><div class="table-container"><table><thead><tr><th><strong>Feature</strong></th><th><strong>LLaMa 2</strong></th><th><strong>LLaMa 3</strong></th></tr></thead><tbody><tr><td><strong>Training Data Size</strong></td><td>2 trillion tokens</td><td>15 trillion tokens (7x larger)</td></tr><tr><td><strong>Context Window</strong></td><td>4K tokens</td><td>8k tokens</td></tr><tr><td><strong>Focus Area</strong></td><td>General language understanding</td><td>Nuance, context, complex tasks</td></tr><tr><td><strong>False Refusal Rate</strong></td><td>Higher</td><td>Lower</td></tr><tr><td><strong>Response Diversity</strong></td><td>Lower</td><td>Higher</td></tr><tr><td><strong>Code Generation</strong></td><td>Limited capability</td><td>Enhanced capability</td></tr></tbody></table></div><h2 id="æ—‹è½¬ä½ç½®ç¼–ç "><a href="#æ—‹è½¬ä½ç½®ç¼–ç " class="headerlink" title="æ—‹è½¬ä½ç½®ç¼–ç "></a>æ—‹è½¬ä½ç½®ç¼–ç </h2><blockquote><p>æ—‹è½¬ä½ç½®åµŒå…¥ï¼ˆRoPEï¼‰æ˜¯ä¸€ç§ç”¨äºåŸºäºtransformeræ¨¡å‹çš„æŠ€æœ¯ï¼Œå¯å°†ä½ç½®ä¿¡æ¯çº³å…¥æ ‡è®°è¡¨ç¤ºä¸­ã€‚ä¸ä¾èµ–æ­£å¼¦å’Œä½™å¼¦å‡½æ•°çš„ä¼ ç»Ÿä½ç½®ç¼–ç ä¸åŒï¼Œ<strong>RoPE åˆ©ç”¨æ—‹è½¬çŸ©é˜µæ¥ç¼–ç ç»å¯¹å’Œç›¸å¯¹ä½ç½®ä¿¡æ¯</strong>ã€‚è¿™ç§æ–¹æ³•çš„æå‡ºæ˜¯ä¸ºäº†æé«˜ä½ç½®åµŒå…¥åœ¨transformerä¸­çš„æœ‰æ•ˆæ€§ã€‚Metaçš„LLaMAã€æ¸…åçš„ChatGLMéƒ½é‡‡ç”¨äº†RoPE</p></blockquote><script type="math/tex; mode=display">\begin{aligned}\mathrm{RoPE}(x,m)& =xe^{mi\theta} \\\langle\mathrm{RoPE}(q_j,m),\mathrm{RoPE}(k_j,n)\rangle & =\langle q_je^{mi\theta},k_je^{ni\theta}\rangle  \\&=q_jk_je^{mi\theta}\overline{e^{ni\theta}} \\&=q_jk_je^{(m-n)i\theta} \\&=\mathrm{RoPE}(q_jk_j,m-n)\end{aligned}\begin{aligned}\mathrm{RoPE}(x,m)& =xe^{mi\theta} \\\langle\mathrm{RoPE}(q_j,m),\mathrm{RoPE}(k_j,n)\rangle & =\langle q_je^{mi\theta},k_je^{ni\theta}\rangle  \\&=q_jk_je^{mi\theta}\overline{e^{ni\theta}} \\&=q_jk_je^{(m-n)i\theta} \\&=\mathrm{RoPE}(q_jk_j,m-n)\end{aligned}</script><p>åœ¨llama3ä¸­ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">precompute_freqs_cis</span>(<span class="params">dim: <span class="built_in">int</span>, end: <span class="built_in">int</span>, theta: <span class="built_in">float</span> = <span class="number">10000.0</span></span>):</span></span><br><span class="line">    freqs = <span class="number">1.0</span> / (theta ** (torch.arange(<span class="number">0</span>, dim, <span class="number">2</span>)[: (dim // <span class="number">2</span>)].<span class="built_in">float</span>() / dim)) <span class="comment"># ä¸€ä¸ªä½ç½®ä¸Šçš„ç‰¹å¾</span></span><br><span class="line">    t = torch.arange(end, device=freqs.device, dtype=torch.float32)</span><br><span class="line">    freqs = torch.outer(t, freqs)</span><br><span class="line">    freqs_cis = torch.polar(torch.ones_like(freqs), freqs)  <span class="comment"># complex64 # å¾—åˆ°e^freqs^ shape [T,dim//2]</span></span><br><span class="line">    <span class="keyword">return</span> freqs_cis</span><br><span class="line"></span><br><span class="line">self.freqs_cis = precompute_freqs_cis(</span><br><span class="line">    params.dim // params.n_heads,</span><br><span class="line">    params.max_seq_len * <span class="number">2</span>,</span><br><span class="line">    params.rope_theta,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reshape_for_broadcast</span>(<span class="params">freqs_cis: torch.Tensor, x: torch.Tensor</span>):</span></span><br><span class="line">    ndim = x.ndim</span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= <span class="number">1</span> &lt; ndim</span><br><span class="line">    <span class="keyword">assert</span> freqs_cis.shape == (x.shape[<span class="number">1</span>], x.shape[-<span class="number">1</span>])</span><br><span class="line">    shape = [d <span class="keyword">if</span> i == <span class="number">1</span> <span class="keyword">or</span> i == ndim - <span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">for</span> i, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(x.shape)]</span><br><span class="line">    <span class="keyword">return</span> freqs_cis.view(*shape)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_rotary_emb</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        xq: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">        xk: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">        freqs_cis: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) -&gt; <span class="type">Tuple</span>[torch.Tensor, torch.Tensor]:</span></span><br><span class="line">    xq_ = torch.view_as_complex(xq.<span class="built_in">float</span>().reshape(*xq.shape[:-<span class="number">1</span>], -<span class="number">1</span>, <span class="number">2</span>)) <span class="comment">#shape [bs,seq_len,dim//2,2] -&gt; [bs,seq_len,dim]</span></span><br><span class="line">    xk_ = torch.view_as_complex(xk.<span class="built_in">float</span>().reshape(*xk.shape[:-<span class="number">1</span>], -<span class="number">1</span>, <span class="number">2</span>))<span class="comment">#shape [bs,seq_len,dim//2,2] -&gt; [bs,seq_len,dim]</span></span><br><span class="line">    freqs_cis = reshape_for_broadcast(freqs_cis, xq_) <span class="comment"># [1,seq_len,dim]</span></span><br><span class="line">    xq_out = torch.view_as_real(xq_ * freqs_cis).flatten(<span class="number">3</span>)<span class="comment">#[bs,seq_len,dim//2,2] type float32 -&gt; </span></span><br><span class="line">    xk_out = torch.view_as_real(xk_ * freqs_cis).flatten(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> xq_out.type_as(xq), xk_out.type_as(xk)</span><br><span class="line"></span><br><span class="line">xq, xk = apply_rotary_emb(xq, xk, freqs_cis=freqs_cis)</span><br></pre></td></tr></table></figure><p>è®¡ç®—freqs_cis,å…¶æ˜¯ä¸€ä¸ªå¤æ•°,æ—‹è½¬ç¼–ç é€šå¸¸åº”ç”¨åœ¨qå’Œkä¸Š.</p><script type="math/tex; mode=display">\mathrm{RoPE}(x_m^{(1)},x_m^{(2)},m)=\begin{bmatrix}\cos(m\theta)&-\sin(m\theta)\\\sin(m\theta)&\cos(m\theta)\end{bmatrix}\begin{bmatrix}x_m^{(1)}\\x_m^{(2)}\end{bmatrix}=\begin{bmatrix}x_m^{(1)}\cos(m\theta)-x_m^{(2)}\sin(m\theta)\\x_m^{(2)}\cos(m\theta)+x_m^{(1)}\sin(m\theta)\end{bmatrix}\\\Theta=\theta_i=10,000^{-\frac{2(i-1)}d},where(i\in[1,2,\ldots,d])\text{ for the $\frac{d}{2}$ pairs of features.}</script><p>ä¸‹é¢æ˜¯å¦ä¸€ç§å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RotaryPositionalEmbeddings</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d: <span class="built_in">int</span>, base: <span class="built_in">int</span> = <span class="number">10_000</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.base = base</span><br><span class="line">        self.d = d</span><br><span class="line">        self.cos_cached = <span class="literal">None</span></span><br><span class="line">        self.sin_cached = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_build_cache</span>(<span class="params">self, x: torch.Tensor</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.cos_cached <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> x.shape[<span class="number">0</span>] &lt;= self.cos_cached.shape[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        seq_len = x.shape[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># THETA = 10,000^(-2*i/d) or 1/10,000^(2i/d)</span></span><br><span class="line">        theta = <span class="number">1.</span> / (self.base ** (torch.arange(<span class="number">0</span>, self.d, <span class="number">2</span>).<span class="built_in">float</span>() / self.d)).to(x.device)</span><br><span class="line">        <span class="comment"># Position index [0,1,...]</span></span><br><span class="line">        seq_idx = torch.arange(seq_len, device=x.device).<span class="built_in">float</span>().to(x.device)</span><br><span class="line"></span><br><span class="line">        idx_theta = torch.einsum(<span class="string">&#x27;n,d-&gt;nd&#x27;</span>, seq_idx,</span><br><span class="line">                                 theta)  <span class="comment"># Calculates m*(THETA) = [ [0, 0...], [THETA_1, THETA_2...THETA_d/2], ... [seq-1*(THETA_1), seq-1*(THETA_2)...] ]</span></span><br><span class="line"></span><br><span class="line">        idx_theta2 = torch.cat([idx_theta, idx_theta],</span><br><span class="line">                               dim=<span class="number">1</span>)  <span class="comment"># [THETA_1, THETA_2...THETA_d/2] -&gt; [THETA_1, THETA_2...THETA_d]</span></span><br><span class="line">        self.cos_cached = idx_theta2.cos()[:, <span class="literal">None</span>, <span class="literal">None</span>, :]  <span class="comment"># Cache [cosTHETA_1, cosTHETA_2...cosTHETA_d]</span></span><br><span class="line">        self.sin_cached = idx_theta2.sin()[:, <span class="literal">None</span>, <span class="literal">None</span>, :]  <span class="comment"># cache [sinTHETA_1, sinTHETA_2...sinTHETA_d]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_neg_half</span>(<span class="params">self, x: torch.Tensor</span>):</span></span><br><span class="line">        d_2 = self.d // <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> torch.cat([-x[:, :, :, d_2:], x[:, :, :, :d_2]], dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x: torch.Tensor</span>):</span></span><br><span class="line">        self._build_cache(x)</span><br><span class="line">        neg_half_x = self._neg_half(x)</span><br><span class="line">        x_rope = (x * self.cos_cached[:x.shape[<span class="number">0</span>]]) + (neg_half_x * self.sin_cached[:x.shape[<span class="number">0</span>]])</span><br><span class="line">        <span class="keyword">return</span> x_rope</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    x = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]], dtype=torch.<span class="built_in">float</span>)</span><br><span class="line">    x = x[:, <span class="literal">None</span>, <span class="literal">None</span>, :]</span><br><span class="line"></span><br><span class="line">    p = RotaryPositionalEmbeddings(<span class="number">4</span>)(x)</span><br><span class="line">    <span class="built_in">print</span>(p)</span><br><span class="line"></span><br></pre></td></tr></table></figure><script type="math/tex; mode=display">\begin{bmatrix}x_m^{(i)}\\x_m^{(i+d/2)}\end{bmatrix}=\begin{bmatrix}x_m^{(i)}\cos(m\theta_i)-x_m^{(i+d/2)}\sin(m\theta_i)\\x_m^{(i+d/2)}\cos(m\theta_i)+x_m^{(i)}\sin(m\theta_i)\end{bmatrix}</script><h2 id="RSMNorm"><a href="#RSMNorm" class="headerlink" title="RSMNorm"></a>RSMNorm</h2><p>å¦ä¸€ç§è§„èŒƒåŒ–çš„æ–¹å¼,æ–¹æ³•æ˜¯åœ¨2019å¹´çš„è®ºæ–‡ä¸­æå‡ºçš„<a href="https://arxiv.org/pdf/1910.07467">1910.07467 (arxiv.org)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RMSNorm</span>(<span class="params">torch.nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dim: <span class="built_in">int</span>, eps: <span class="built_in">float</span> = <span class="number">1e-6</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.eps = eps</span><br><span class="line">        self.weight = nn.Parameter(torch.ones(dim))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_norm</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x * torch.rsqrt(x.<span class="built_in">pow</span>(<span class="number">2</span>).mean(-<span class="number">1</span>, keepdim=<span class="literal">True</span>) + self.eps)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        output = self._norm(x.<span class="built_in">float</span>()).type_as(x)</span><br><span class="line">        <span class="keyword">return</span> output * self.weight</span><br><span class="line"></span><br></pre></td></tr></table></figure><script type="math/tex; mode=display">y=\frac{x}{\sqrt{\text{RMS}[x]+\epsilon}}*\gamma</script><p>åœ¨llama3ä¸­,æœ‰ä¸‰ä¸ªåœ°æ–¹ä½¿ç”¨,åœ¨attention,ffnä»¥åŠåœ¨æ‰€æœ‰transformer layerä¹‹å,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h = x + self.attention(self.attention_norm(x), start_pos, freqs_cis, mask)</span><br><span class="line">out = h + self.feed_forward(self.ffn_norm(h))</span><br></pre></td></tr></table></figure><h2 id="GroupQuery-Attention-amp-amp-KVcache"><a href="#GroupQuery-Attention-amp-amp-KVcache" class="headerlink" title="GroupQuery Attention&amp;&amp;KVcache"></a>GroupQuery Attention&amp;&amp;KVcache</h2><p>GroupQuery:queryçš„headæ•°æ˜¯kvçš„headæ•°çš„è‹¥å¹²å€.</p><p>KV cache:åœ¨ç”Ÿæˆæ–°çš„tokenæ—¶,Kå’ŒVå¾€å¾€æ”¹å˜ä¸å¤§,ä¹Ÿå°±ä¸éœ€è¦æ€ä¹ˆè®¡ç®—,æ‰€ä»¥åªéœ€è¦å­˜ä¸‹è®¡ç®—çš„å€¼å³å¯.è¿™æ˜¯èŠ‚çº¦æ˜¾å­˜çš„æ“ä½œ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attention</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, args: ModelArgs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.n_kv_heads = args.n_heads <span class="keyword">if</span> args.n_kv_heads <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> args.n_kv_heads</span><br><span class="line">        model_parallel_size = fs_init.get_model_parallel_world_size()</span><br><span class="line">        self.n_local_heads = args.n_heads // model_parallel_size</span><br><span class="line">        self.n_local_kv_heads = self.n_kv_heads // model_parallel_size</span><br><span class="line">        self.n_rep = self.n_local_heads // self.n_local_kv_heads</span><br><span class="line">        self.head_dim = args.dim // args.n_heads</span><br><span class="line"></span><br><span class="line">        self.wq = ColumnParallelLinear(</span><br><span class="line">            args.dim,</span><br><span class="line">            args.n_heads * self.head_dim,</span><br><span class="line">            bias=<span class="literal">False</span>,</span><br><span class="line">            gather_output=<span class="literal">False</span>,</span><br><span class="line">            init_method=<span class="keyword">lambda</span> x: x,</span><br><span class="line">        )</span><br><span class="line">        self.wk = ColumnParallelLinear(</span><br><span class="line">            args.dim,</span><br><span class="line">            self.n_kv_heads * self.head_dim,</span><br><span class="line">            bias=<span class="literal">False</span>,</span><br><span class="line">            gather_output=<span class="literal">False</span>,</span><br><span class="line">            init_method=<span class="keyword">lambda</span> x: x,</span><br><span class="line">        )</span><br><span class="line">        self.wv = ColumnParallelLinear(</span><br><span class="line">            args.dim,</span><br><span class="line">            self.n_kv_heads * self.head_dim,</span><br><span class="line">            bias=<span class="literal">False</span>,</span><br><span class="line">            gather_output=<span class="literal">False</span>,</span><br><span class="line">            init_method=<span class="keyword">lambda</span> x: x,</span><br><span class="line">        )</span><br><span class="line">        self.wo = RowParallelLinear(</span><br><span class="line">            args.n_heads * self.head_dim,</span><br><span class="line">            args.dim,</span><br><span class="line">            bias=<span class="literal">False</span>,</span><br><span class="line">            input_is_parallel=<span class="literal">True</span>,</span><br><span class="line">            init_method=<span class="keyword">lambda</span> x: x,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.cache_k = torch.zeros(</span><br><span class="line">            (</span><br><span class="line">                args.max_batch_size,</span><br><span class="line">                args.max_seq_len,</span><br><span class="line">                self.n_local_kv_heads,</span><br><span class="line">                self.head_dim,</span><br><span class="line">            )</span><br><span class="line">        ).cuda()</span><br><span class="line">        self.cache_v = torch.zeros(</span><br><span class="line">            (</span><br><span class="line">                args.max_batch_size,</span><br><span class="line">                args.max_seq_len,</span><br><span class="line">                self.n_local_kv_heads,</span><br><span class="line">                self.head_dim,</span><br><span class="line">            )</span><br><span class="line">        ).cuda()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            self,</span></span></span><br><span class="line"><span class="params"><span class="function">            x: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">            start_pos: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            freqs_cis: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">            mask: <span class="type">Optional</span>[torch.Tensor],</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        bsz, seqlen, _ = x.shape</span><br><span class="line">        xq, xk, xv = self.wq(x), self.wk(x), self.wv(x)</span><br><span class="line"></span><br><span class="line">        xq = xq.view(bsz, seqlen, self.n_local_heads, self.head_dim)</span><br><span class="line">        xk = xk.view(bsz, seqlen, self.n_local_kv_heads, self.head_dim)</span><br><span class="line">        xv = xv.view(bsz, seqlen, self.n_local_kv_heads, self.head_dim)</span><br><span class="line"></span><br><span class="line">        xq, xk = apply_rotary_emb(xq, xk, freqs_cis=freqs_cis)</span><br><span class="line"></span><br><span class="line">        self.cache_k = self.cache_k.to(xq)</span><br><span class="line">        self.cache_v = self.cache_v.to(xq)</span><br><span class="line"></span><br><span class="line">        self.cache_k[:bsz, start_pos: start_pos + seqlen] = xk</span><br><span class="line">        self.cache_v[:bsz, start_pos: start_pos + seqlen] = xv</span><br><span class="line"></span><br><span class="line">        keys = self.cache_k[:bsz, : start_pos + seqlen]</span><br><span class="line">        values = self.cache_v[:bsz, : start_pos + seqlen]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># repeat k/v heads if n_kv_heads &lt; n_heads</span></span><br><span class="line">        keys = repeat_kv(</span><br><span class="line">            keys, self.n_rep</span><br><span class="line">        )  <span class="comment"># (bs, cache_len + seqlen, n_local_heads, head_dim)</span></span><br><span class="line">        values = repeat_kv(</span><br><span class="line">            values, self.n_rep</span><br><span class="line">        )  <span class="comment"># (bs, cache_len + seqlen, n_local_heads, head_dim)</span></span><br><span class="line"></span><br><span class="line">        xq = xq.transpose(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># (bs, n_local_heads, seqlen, head_dim)</span></span><br><span class="line">        keys = keys.transpose(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># (bs, n_local_heads, cache_len + seqlen, head_dim)</span></span><br><span class="line">        values = values.transpose(</span><br><span class="line">            <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">        )  <span class="comment"># (bs, n_local_heads, cache_len + seqlen, head_dim)</span></span><br><span class="line">        scores = torch.matmul(xq, keys.transpose(<span class="number">2</span>, <span class="number">3</span>)) / math.sqrt(self.head_dim)</span><br><span class="line">        <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            scores = scores + mask  <span class="comment"># (bs, n_local_heads, seqlen, cache_len + seqlen)</span></span><br><span class="line">        scores = F.softmax(scores.<span class="built_in">float</span>(), dim=-<span class="number">1</span>).type_as(xq)</span><br><span class="line">        output = torch.matmul(scores, values)  <span class="comment"># (bs, n_local_heads, seqlen, head_dim)</span></span><br><span class="line">        output = output.transpose(<span class="number">1</span>, <span class="number">2</span>).contiguous().view(bsz, seqlen, -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> self.wo(output)</span><br></pre></td></tr></table></figure><h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transformer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, params: ModelArgs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.params = params</span><br><span class="line">        self.vocab_size = params.vocab_size</span><br><span class="line">        self.n_layers = params.n_layers</span><br><span class="line"></span><br><span class="line">        self.tok_embeddings = VocabParallelEmbedding(</span><br><span class="line">            params.vocab_size, params.dim, init_method=<span class="keyword">lambda</span> x: x</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.layers = torch.nn.ModuleList()</span><br><span class="line">        <span class="keyword">for</span> layer_id <span class="keyword">in</span> <span class="built_in">range</span>(params.n_layers):</span><br><span class="line">            self.layers.append(TransformerBlock(layer_id, params))</span><br><span class="line"></span><br><span class="line">        self.norm = RMSNorm(params.dim, eps=params.norm_eps)</span><br><span class="line">        self.output = ColumnParallelLinear(</span><br><span class="line">            params.dim, params.vocab_size, bias=<span class="literal">False</span>, init_method=<span class="keyword">lambda</span> x: x</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.freqs_cis = precompute_freqs_cis(</span><br><span class="line">            params.dim // params.n_heads,</span><br><span class="line">            params.max_seq_len * <span class="number">2</span>,</span><br><span class="line">            params.rope_theta,</span><br><span class="line">        )</span><br><span class="line"><span class="meta">    @torch.inference_mode()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, tokens: torch.Tensor, start_pos: <span class="built_in">int</span></span>):</span></span><br><span class="line">        _bsz, seqlen = tokens.shape</span><br><span class="line">        h = self.tok_embeddings(tokens)</span><br><span class="line">        self.freqs_cis = self.freqs_cis.to(h.device)</span><br><span class="line">        freqs_cis = self.freqs_cis[start_pos: start_pos + seqlen]</span><br><span class="line"></span><br><span class="line">        mask = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> seqlen &gt; <span class="number">1</span>:</span><br><span class="line">            mask = torch.full((seqlen, seqlen), <span class="built_in">float</span>(<span class="string">&quot;-inf&quot;</span>), device=tokens.device)</span><br><span class="line"></span><br><span class="line">            mask = torch.triu(mask, diagonal=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># When performing key-value caching, we compute the attention scores</span></span><br><span class="line">            <span class="comment"># only for the new sequence. Thus, the matrix of scores is of size</span></span><br><span class="line">            <span class="comment"># (seqlen, cache_len + seqlen), and the only masked entries are (i, j) for</span></span><br><span class="line">            <span class="comment"># j &gt; cache_len + i, since row i corresponds to token cache_len + i.</span></span><br><span class="line">            mask = torch.hstack(</span><br><span class="line">                [torch.zeros((seqlen, start_pos), device=tokens.device), mask]</span><br><span class="line">            ).type_as(h)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            h = layer(h, start_pos, freqs_cis, mask)</span><br><span class="line">        h = self.norm(h)</span><br><span class="line">        output = self.output(h).<span class="built_in">float</span>()</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransformerBlock</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, layer_id: <span class="built_in">int</span>, args: ModelArgs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.n_heads = args.n_heads</span><br><span class="line">        self.dim = args.dim</span><br><span class="line">        self.head_dim = args.dim // args.n_heads</span><br><span class="line">        self.attention = Attention(args)</span><br><span class="line">        self.feed_forward = FeedForward(</span><br><span class="line">            dim=args.dim,</span><br><span class="line">            hidden_dim=<span class="number">4</span> * args.dim,</span><br><span class="line">            multiple_of=args.multiple_of,</span><br><span class="line">            ffn_dim_multiplier=args.ffn_dim_multiplier,</span><br><span class="line">        )</span><br><span class="line">        self.layer_id = layer_id</span><br><span class="line">        self.attention_norm = RMSNorm(args.dim, eps=args.norm_eps)</span><br><span class="line">        self.ffn_norm = RMSNorm(args.dim, eps=args.norm_eps)</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            self,</span></span></span><br><span class="line"><span class="params"><span class="function">            x: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">            start_pos: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            freqs_cis: torch.Tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">            mask: <span class="type">Optional</span>[torch.Tensor],</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        h = x + self.attention(self.attention_norm(x), start_pos, freqs_cis, mask)</span><br><span class="line">        out = h + self.feed_forward(self.ffn_norm(h))</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="siluæ¿€æ´»å‡½æ•°"><a href="#siluæ¿€æ´»å‡½æ•°" class="headerlink" title="siluæ¿€æ´»å‡½æ•°"></a>siluæ¿€æ´»å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedForward</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            self,</span></span></span><br><span class="line"><span class="params"><span class="function">            dim: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            hidden_dim: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            multiple_of: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            ffn_dim_multiplier: <span class="type">Optional</span>[<span class="built_in">float</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        hidden_dim = <span class="built_in">int</span>(<span class="number">2</span> * hidden_dim / <span class="number">3</span>)</span><br><span class="line">        <span class="comment"># custom dim factor multiplier</span></span><br><span class="line">        <span class="keyword">if</span> ffn_dim_multiplier <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            hidden_dim = <span class="built_in">int</span>(ffn_dim_multiplier * hidden_dim)</span><br><span class="line">        hidden_dim = multiple_of * ((hidden_dim + multiple_of - <span class="number">1</span>) // multiple_of)</span><br><span class="line"></span><br><span class="line">        self.w1 = ColumnParallelLinear(</span><br><span class="line">            dim, hidden_dim, bias=<span class="literal">False</span>, gather_output=<span class="literal">False</span>, init_method=<span class="keyword">lambda</span> x: x</span><br><span class="line">        )</span><br><span class="line">        self.w2 = RowParallelLinear(</span><br><span class="line">            hidden_dim, dim, bias=<span class="literal">False</span>, input_is_parallel=<span class="literal">True</span>, init_method=<span class="keyword">lambda</span> x: x</span><br><span class="line">        )</span><br><span class="line">        self.w3 = ColumnParallelLinear(</span><br><span class="line">            dim, hidden_dim, bias=<span class="literal">False</span>, gather_output=<span class="literal">False</span>, init_method=<span class="keyword">lambda</span> x: x</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.w2(F.silu(self.w1(x)) * self.w3(x)) <span class="comment">#æ³¨æ„è¿™é‡Œä¸ä¸€èˆ¬çš„ffnå·®åˆ«,F.silu(self.w1(x))èµ·äº†ç±»ä¼¼gateçš„ä½œç”¨</span></span><br></pre></td></tr></table></figure><p><img data-src="https://pytorch.org/docs/stable/_images/SiLU.png" alt="../_images/SiLU.png" style="zoom:67%;" /></p><script type="math/tex; mode=display">silu(x)=x*Ïƒ(x)</script><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://github.com/naklecha/llama3-from-scratch">naklecha/llama3-from-scratch: llama3 implementation one matrix multiplication at a time (github.com)</a></li><li><a href="https://github.com/meta-llama/llama3">github.com</a></li><li><a href="https://github.com/aju22/RoPE-PyTorch/blob/main/RoPE.ipynb">RoPE-PyTorch/RoPE.ipynb at main Â· aju22/RoPE-PyTorch (github.com)</a></li><li><a href="https://nn.labml.ai/transformers/rope/index.html">Rotary Positional Embeddings (RoPE) (labml.ai)</a></li><li><a href="https://mett29.github.io/posts/kv-cache/">What is the KV cache? | Matt Log (mett29.github.io)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;llama3æ˜¯metaå¼€æºçš„å¤§æ¨¡å‹,åœ¨å¼€æºå¤§æ¨¡å‹ä¸­å ç€é‡è¦åœ°ä½,åœ¨è¿™ä¹‹å‰å¯èƒ½æ˜¯Mistral,ç›®å‰ä¹Ÿæœ‰gemma2,Qwen2ä»¥åŠå¾®è½¯çš„Phi3ç­‰.&lt;br&gt;</summary>
    
    
    
    
    <category term="llm" scheme="https://www.sekyoro.top/tags/llm/"/>
    
  </entry>
  
  <entry>
    <title>from grad to tensor</title>
    <link href="https://www.sekyoro.top/2024/07/08/from-grad-to-tensor/"/>
    <id>https://www.sekyoro.top/2024/07/08/from-grad-to-tensor/</id>
    <published>2024-07-08T02:09:09.000Z</published>
    <updated>2024-07-16T14:40:36.858Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>inspired by <a href="https://github.com/karpathy/micrograd">karpathy/micrograd: A tiny scalar-valued autograd engine and a neural net library on top of it with PyTorch-like API (github.com)</a>and <a href="https://nrehiew.github.io/blog/pytorch/">Taking PyTorch for Granted | wh (nrehiew.github.io)</a>. </p><p>æ„Ÿè°¢Karpathyä»¥åŠxä¸Šæ‰€æœ‰çœŸå¿ƒæ¢è®¨æŠ€æœ¯çš„ç½‘å‹.è¿™å±äºkarpathyçš„<a href="https://github.com/karpathy/nn-zero-to-hero?tab=readme-ov-file">karpathy/nn-zero-to-hero: Neural Networks: Zero to Hero ,(github.com)</a>è¯¾ç¨‹.äº‹å®ä¸Šä»–è¿˜æœ‰å¾ˆå¤šå€¼å¾—ä¸€çœ‹çš„è¯¾ç¨‹å’Œrepos.</p><span id="more"></span><p>tensoråˆ†æˆå“ªäº›éƒ¨åˆ†?</p><blockquote><p>ä¸€ä¸ªtensorå¯ä»¥åˆ†ä¸ºå…ƒæ•°æ®åŒºå’Œå­˜å‚¨åŒºï¼ˆStorageï¼‰</p><p>ä¿¡æ¯åŒºä¸»è¦ä¿å­˜ç€tensorçš„å½¢çŠ¶ï¼ˆsizeï¼‰ã€æ­¥é•¿ï¼ˆstrideï¼‰ã€æ•°æ®ç±»å‹ï¼ˆtypeï¼‰,storage_offset,layoutç­‰ä¿¡æ¯,è€ŒçœŸæ­£çš„<strong>æ•°æ®åˆ™ä¿å­˜æˆè¿ç»­æ•°ç»„,å­˜å‚¨åœ¨å­˜å‚¨åŒº</strong></p></blockquote><h3 id="tensorçš„å­˜å‚¨"><a href="#tensorçš„å­˜å‚¨" class="headerlink" title="tensorçš„å­˜å‚¨"></a>tensorçš„å­˜å‚¨</h3><p>tensoræ•°æ®åº•å±‚å­˜å‚¨æ˜¯<strong>è¿ç»­çš„</strong>,<del>ç›¸å¯¹åº”çš„å°±æ˜¯é“¾è¡¨</del>. pytorchä½¿ç”¨Storageç±»å­˜å‚¨æ•°æ®. å¯ä»¥ä½¿ç”¨tensor.storage()è®¿é—®å­˜å‚¨çš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data = torch.arange(<span class="number">9</span>)</span><br><span class="line"><span class="built_in">print</span>(data.storage().dtype)</span><br><span class="line"><span class="built_in">print</span>(data.storage().device)</span><br><span class="line"><span class="built_in">print</span>(data.storage().data_ptr()) <span class="comment">#è¿™é‡Œ å­˜å‚¨æ•°æ®ä¹Ÿèƒ½è®¿é—®æ•°æ®çš„å±æ€§</span></span><br></pre></td></tr></table></figure><blockquote><p>All storage classes except for <a href="https://pytorch.org/docs/stable/storage.html#torch.UntypedStorage"><code>torch.UntypedStorage</code></a> will be removed in the future, and <a href="https://pytorch.org/docs/stable/storage.html#torch.UntypedStorage"><code>torch.UntypedStorage</code></a> will be used in all cases.</p></blockquote><p>ä½†æ˜¯åœ¨æœ€æ–°çš„pythonä¸­é™¤äº†untypedstorageç±»å…¶ä»–éƒ½å·²ç»deprecatedäº†,è€Œåœ¨untypedstorageä¸­æ•°æ®æ˜¯å­—èŠ‚ç±»å‹,å¹¶ä¸”ä¹Ÿæ— æ³•è°ƒç”¨<code>dtype</code>è¿™äº›å±æ€§,å˜å¾—æ›´åŠ çº¯ç²¹äº†.</p><p><img data-src="https://s2.loli.net/2024/07/10/Ns8SM3QlpoeB4Ix.png" alt="image-20240710221322389"></p><p>äº‹å®ä¸Š,å¤§å¤šæ•°ç±»ä¼¼çš„æ•°æ®éƒ½æ˜¯è¿™æ ·çš„,æ¯”å¦‚å¸¸ç”¨åº“numpy.</p><p><img data-src="https://www.tomasbeuzen.com/python-programming-for-data-science/_images/numpy_paper.png" alt="img" style="zoom:150%;" /></p><h3 id="tensorçš„è®¿é—®"><a href="#tensorçš„è®¿é—®" class="headerlink" title="tensorçš„è®¿é—®"></a>tensorçš„è®¿é—®</h3><p>pytorchæ•°æ®å­˜å‚¨æ˜¯ä¸€ç»´çš„,ä½†æ˜¯ä¼šæ ¹æ®å®ƒçš„ä¸€äº›å…ƒæ•°æ®æ”¹å˜å¯¹å®ƒçš„â€è§£é‡Šâ€,è€Œå½±å“è§£é‡Šçš„å…ƒæ•°æ®å°±æ˜¯tride (<code>as_strided</code>å¯ä»¥ä½¿å¾—ä¸¤ä¸ªtensorçš„size,strideå’Œstorage_offsetä¸€è‡´)</p><blockquote><p><strong>stride</strong> strideæ˜¯ä»ä¸€ä¸ªå…ƒç´ åˆ°æŒ‡å®šç»´åº¦çš„å¦ä¸€ä¸ªå…ƒç´ çš„é—´éš”æ•°,å¦‚æœä¸æŒ‡å®šç»´åº¦,å°±è¿”å›åœ¨æ¯ä¸ªç»´åº¦ä¸Šçš„strideçš„tuple</p><p>Stride is the jump necessary to go from one element to the next one in the specified dimension <a href="https://pytorch.org/docs/stable/generated/torch.Tensor.dim.html#torch.Tensor.dim"><code>dim</code></a>. </p><p>A tuple of all strides is returned when no argument is passed in. Otherwise, an integer value is returned as the stride in the particular dimension <a href="https://pytorch.org/docs/stable/generated/torch.Tensor.dim.html#torch.Tensor.dim"><code>dim</code></a>.</p><p><strong>storage_offset</strong>  è¿”å›tensorçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸storageçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»é‡ã€‚</p><p>Returns <code>self</code> tensorâ€™s offset in the underlying storage in terms of number of storage elements (not bytes).</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;x = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">&gt;x.storage_offset()</span><br><span class="line">&gt;x[<span class="number">3</span>:].storage_offset()</span><br></pre></td></tr></table></figure></blockquote><p>pytorchä¸­tensorå­˜å‚¨åŒºçš„æ•°æ®æ˜¯è¿ç»­çš„,è€Œstrideè§„å®šäº†å¦‚ä½•è®¿é—®.è®¿é—®çš„æ–¹å¼å°±æ˜¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data = torch.randn(<span class="number">1</span>,<span class="number">20</span>,<span class="number">20</span>) </span><br><span class="line">stride = data.stride() <span class="comment"># -&gt; (400, 20, 1)</span></span><br><span class="line">data[<span class="number">0</span>][<span class="number">2</span>][<span class="number">3</span>] -&gt;  <span class="number">0</span>*stride[<span class="number">0</span>]+<span class="number">2</span>*stride[<span class="number">2</span>]+<span class="number">3</span>*stride[<span class="number">3</span>]-&gt;ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ•°æ®åœ¨ç¬¬<span class="number">2</span>*<span class="number">20</span>+<span class="number">3</span>*<span class="number">1</span>=<span class="number">43</span>ä¸ª</span><br></pre></td></tr></table></figure><p>æ³¨æ„torchå­˜å‚¨æ•°æ®æ˜¯è¡Œä¼˜å…ˆ,ä¹Ÿå°±æ˜¯è¯´,åƒä¸‹é¢è¿™æ ·çš„æ•°æ®,ç¬¬äºŒä¸ªæ˜¯0.6960è€Œä¸æ˜¯-0.5163. æ‰€ä»¥è®¿é—®æ—¶å°±ç±»ä¼¼ç´¢å¼•ä¹˜ä»¥å¯¹åº”çš„è¡Œ/åˆ—æ•°,ä»è¿™ä¸ªè§’åº¦æ¥çœ‹,strideå°±æ˜¯ä¸€ä¸ªæ˜ å°„å‡½æ•°.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tensor([[ <span class="number">1.6427</span>,  <span class="number">0.6960</span>,  <span class="number">0.7865</span>,  <span class="number">0.9934</span>,  <span class="number">0.4952</span>],</span><br><span class="line">        [-<span class="number">0.5163</span>, -<span class="number">0.0823</span>, -<span class="number">1.2630</span>, -<span class="number">0.9474</span>,  <span class="number">1.1055</span>],</span><br><span class="line">        [ <span class="number">0.1538</span>,  <span class="number">1.0177</span>, -<span class="number">1.8064</span>,  <span class="number">0.6440</span>, -<span class="number">1.4661</span>],</span><br><span class="line">        [ <span class="number">0.3305</span>,  <span class="number">0.2681</span>,  <span class="number">0.2768</span>, -<span class="number">0.3924</span>,  <span class="number">0.1743</span>],</span><br><span class="line">        [-<span class="number">0.8965</span>, -<span class="number">0.5499</span>, -<span class="number">0.4545</span>, -<span class="number">1.1470</span>,  <span class="number">0.6883</span>]])</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/07/10/s7ZuEzmD3vnAoiH.png" alt="image-20240710220152997"></p><h3 id="tensoræ“ä½œ"><a href="#tensoræ“ä½œ" class="headerlink" title="tensoræ“ä½œ"></a>tensoræ“ä½œ</h3><p>å¯ä»¥å¯¹tensorçš„æ•°æ®è¿›è¡Œæ“ä½œ,æ¯”å¦‚ä¸‹é¢è¿ç®—,ä¼šæ”¹å˜tensorçš„å­˜å‚¨æ•°æ®.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data = torch.randn((<span class="number">4</span>, <span class="number">2</span>))</span><br><span class="line">stride = data.stride()</span><br><span class="line"><span class="built_in">print</span>(data, stride)</span><br><span class="line">data[<span class="number">0</span>, <span class="number">1</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(data, stride)</span><br><span class="line">data.add_(torch.ones((<span class="number">4</span>, <span class="number">2</span>)))</span><br><span class="line"><span class="built_in">print</span>(data, stride)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æœ‰äº›æ“ä½œä¸ä¼š,å…¶åªä¼šè¿”å›æ•°æ®ç›¸åŒ(æŒ‡çš„æ˜¯æ•°æ®åœ¨åº•å±‚å­˜å‚¨ä¸Šç›¸åŒ)çš„<strong>è§†å›¾</strong>(view),è¿™äº›æ“ä½œåŒ…æ‹¬<code>t()</code>,<code>expand</code>,<code>transpose</code>,<code>permute</code>,<code>view</code>,<code>squeeze</code>ç­‰ç­‰,æ“ä½œåçš„tensoræ•°æ®ä¸å˜(ä¹Ÿå°±æ˜¯views),ä½†stride<strong>å¯èƒ½</strong>ä¼šæ”¹å˜,ä¹Ÿå°±æ˜¯è¯´è§£é‡Šæ•°æ®çš„æ–¹å¼ä¼šå˜.</p><blockquote><p>åº•å±‚å­˜å‚¨å¹¶æ²¡æœ‰æ”¹å˜,åªéœ€å°†æ˜ å°„å‡½æ•°ä»æ—§å½¢çŠ¶çš„åæ ‡ç³»è°ƒæ•´ä¸ºæ–°å½¢çŠ¶çš„åæ ‡ç³»ã€‚ å¦‚æœæ˜ å°„å‡½æ•°å·²ç»å°†å½¢çŠ¶ä½œä¸ºè¾“å…¥,é‚£ä¹ˆåªéœ€æ›´æ”¹å½¢çŠ¶å±æ€§å³å¯ã€‚</p></blockquote><ul><li><code>reshape()</code>ã€<code>reshape_as()</code> å’Œ <code>flatten()</code> å¯ä»¥è¿”å›è§†å›¾æˆ–æ–°å¼ é‡,æ‰€ä»¥åç»­ä»£ç ä¸è¦å‡å®šå®ƒè¿”å›çš„å­˜å‚¨æ•°æ®æ˜¯å¦è·ŸåŸæœ¬è¾“å…¥ç›¸åŒ.</li><li>å¦‚æœè¾“å…¥çš„å¼ é‡å·²ç»è¿ç»­,<code>contiguous()</code> ä¼šè¿”å›è‡ªèº«,å¦åˆ™ä¼šé€šè¿‡å¤åˆ¶æ•°æ®è¿”å›ä¸€ä¸ªæ–°çš„è¿ç»­å¼ é‡.</li></ul><p>ä¸‹é¢ä¸€ä¸ªä¾‹å­æŠ¥é”™åŸå› ,å°±æ˜¯strideçš„é—®é¢˜,å…·ä½“æ¥è¯´,è¿™é‡Œè½¬ç½®ä¹‹åstrideå˜äº†,sizeæ²¡å˜,ä½¿å¾—åç»­çš„viewæ“ä½œä¸æ»¡è¶³æ¡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = torch.arange(<span class="number">9</span>).reshape(<span class="number">3</span>, <span class="number">3</span>) <span class="comment"># 3 x 3 stride (3,1)  size(3,3)</span></span><br><span class="line">x.t().view(<span class="number">1</span>, -<span class="number">1</span>) <span class="comment"># x.t() stride (1,3)  size(3,3)</span></span><br><span class="line"><span class="comment"># &gt;&gt; RuntimeError: view size is not compatible with input tensor&#x27;s </span></span><br><span class="line"><span class="comment"># size and stride. Use .reshape() instead</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆ,<code>view</code>ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªå­˜å‚¨æ•°æ®ç›¸åŒ,ä½†shape/sizeå¯èƒ½ä¸åŒçš„è§†å›¾,è¦æ±‚æ–°çš„è§†å›¾ä¸è¾“å…¥æ•°æ®<strong>ç›¸å…¼å®¹</strong>( 1.<strong>æ–°çš„è§†å›¾çš„æ¯ä¸ªdimensionå¿…é¡»æ˜¯è¾“å…¥çš„å­ç©ºé—´</strong>æˆ–è€…2.<strong>æ–°çš„è§†å›¾çš„ç»´åº¦æ»¡è¶³ä¸‹é¢æ¡ä»¶</strong>ï¼ˆè¿ç»­æ€§),å¦åˆ™ä¸èƒ½å¾—åˆ°æ–°çš„è§†å›¾.</p><script type="math/tex; mode=display">å‡è®¾å¾—åˆ°çš„æ–°çš„tensorç»´åº¦æ¶‰åŠd,..,d+k,å¯¹å…¶ä¸­æ‰€æœ‰ç»´åº¦è¦æ±‚:\\\text{stride}[i]=\text{stride}[i+1]\times\text{size}[i+1]</script><blockquote><p>å¦‚æœä¸æ¸…æ¥šæ˜¯å¦å¯ä»¥æ‰§è¡Œ view()ï¼Œå»ºè®®ä½¿ç”¨ reshape()</p><p>reshape:å¦‚æœå½¢çŠ¶å…¼å®¹,åˆ™è¿”å›è§†å›¾,å¦åˆ™è¿”å›æ‹·è´(ç›¸å½“äºè°ƒç”¨ contiguous)</p></blockquote><p>viewä¹‹åsizeå˜ä¸º(1,9),è¿™ç¬¦åˆæ¡ä»¶1,ä¹Ÿå°±æ˜¯sizeç›¸ç¬¦,å†çœ‹è¿™é‡Œ(1,9)è¡¨æ˜ç¬¬äºŒä¸ªç»´åº¦è·¨åŸŸ(span across)äº†åŸæœ¬è¾“å…¥çš„ä¸¤ä¸ªç»´åº¦,è€ŒåŸæœ¬è¾“å…¥çš„ä¸¤ä¸ªç»´åº¦ä¸­çš„ç¬¬ä¸€ä¸ªç»´åº¦éœ€è¦æ»¡è¶³è¿ç»­æ€§æ¡ä»¶,ä½†æ˜¯ stride[0] =  1 , stride[1]*size[1] = 1*3=3 ä¸ç¬¦åˆ,æ‰€ä»¥viewæ“ä½œå¤±è´¥.</p><p>æ›´æŠ½è±¡åœ°è¯´,å› ä¸ºæ²¡æœ‰åŠæ³•åœ¨ä¸æ”¹å˜åº•å±‚æ•°æ®çš„æƒ…å†µä¸‹å¯¹å¼ é‡è¿›è¡Œflattenå¤„ç†.</p><blockquote><p>æˆ‘ä»¬èƒ½å¦ä»tensorçš„stride(3,1)æ¨å¾—tensor sizeæ˜¯(3,3)?</p><p>ç­”æ¡ˆæ˜¯ä¸èƒ½,å®ƒçš„sizeä¹Ÿå®Œå…¨å¯ä»¥æ˜¯(4,3). åè¿‡æ¥sizeä¹Ÿä¸èƒ½æ¨å‡ºstride.</p></blockquote><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­,æ¯”å¦‚åº•å±‚æ•°æ®æ˜¯[1,2,3,4,5,6,7,8,9],strideæ˜¯[3,1]. ä¹Ÿå°±æ˜¯è¯´åœ¨ç¬¬ä¸€ä¸ªç»´åº¦ä¸‹,æ•°æ®åˆ°ç›¸åŒç»´åº¦çš„ä¸‹ä¸ªæ•°æ®é—´éš”ä¸º3,åŒç†ç¬¬äºŒä¸ªç»´åº¦é—´éš”ä¸º1,</p><p>ç»è¿‡è½¬ç½®ä¹‹å,å› ä¸ºè§£é‡Šæ•°æ®çš„æ–¹å¼å˜äº†,å› ä¸ºéœ€è¦æ”¹å˜è§£é‡Šæ•°æ®çš„æ–¹å¼,æ‰€ä»¥strideéœ€è¦æ”¹å˜ä¸º(1,3).  å†è¿›è¡Œview(1,-1),å¦‚æœä¸æŠ¥é”™çš„è¯,sizeå°±æ˜¯(1,9),ä½ å¯èƒ½ä¼šè®¤ä¸ºç»“æœä¸å°±æ˜¯[[1,4,7,2,5,8â€¦]]å—,ä½†è¿™ä¸ªtensorçš„strideä¸ºå¤šå°‘å‘¢? æ˜¯(9,1)å—,å¹¶ä¸æ˜¯.ä¸ºä»€ä¹ˆå‘¢,</p><p>å› ä¸ºåº•å±‚æ•°æ®[1,2,3,4,5,6,7,8,9],è¦æŸ¥æ‰¾ç¬¬äºŒä¸ªç»´åº¦ä¸Šçš„æ•°æ®,æ¯”å¦‚1åˆ°4,åœ¨åº•å±‚æ•°æ®ä¸­æ˜¯strideæ˜¯3,è€Œ4åˆ°7ä¹Ÿæ˜¯3,æ‰€ä»¥æ˜¯strideæ˜¯(9,3),ç„¶è€Œè¿™è·Ÿsize(1,9)ä¸åŒ¹é…(strideä¹˜èµ·æ¥åº”è¯¥è·Ÿsizeä¹˜èµ·æ¥åº”è¯¥ç›¸åŒ,è¿™æ˜¯æœ€èµ·ç çš„ä¿è¯).</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tensor(<span class="string">[[1, 2, 3],</span></span><br><span class="line"><span class="string">        [4, 5, 6],</span></span><br><span class="line"><span class="string">        [7, 8, 9]]</span>) </span><br><span class="line">        â¬‡â¬‡</span><br><span class="line">        tensor(<span class="string">[[1, 4, 7],</span></span><br><span class="line"><span class="string">        [2, 5, 8],</span></span><br><span class="line"><span class="string">        [3, 6, 9]]</span>)</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/07/13/XRp2T8JgGrNQBwY.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;" /></p><h3 id="tensorçš„å¹¿æ’­"><a href="#tensorçš„å¹¿æ’­" class="headerlink" title="tensorçš„å¹¿æ’­"></a>tensorçš„å¹¿æ’­</h3><p>PyTorch çš„å¹¿æ’­è§„åˆ™:(å¦‚ä½•è¯´ä¸€ä¸ªtensoræ˜¯å¯å¹¿æ’­çš„)</p><ul><li><p>ä¸¤ä¸ªå¼ é‡å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªç»´åº¦</p></li><li><p>ä»æœ€å³è¾¹çš„ç»´å¼€å§‹,ä¸¤ä¸ªç»´å¿…é¡»å¤§å°ç›¸ç­‰,å…¶ä¸­ä¸€ä¸ªä¸º 1 æˆ–è€…å…¶ä¸­ä¸€ä¸ªä¸å­˜åœ¨ã€‚</p><blockquote><p>Two tensors are â€œbroadcastableâ€ if the following rules hold:</p><ul><li>Each tensor has at least one dimension.</li><li>When iterating over the dimension sizes, starting at the trailing dimension, the dimension sizes must either be equal, one of them is 1, or one of them does not exist.</li></ul><p><a href="https://pytorch.org/docs/stable/notes/broadcasting.html#broadcasting-semantics">Broadcasting semantics â€” PyTorch 2.3 documentation</a></p><p>If two tensors <code>x</code>, <code>y</code> are â€œbroadcastableâ€, the resulting tensor size is calculated as follows:</p><ul><li>If the number of dimensions of <code>x</code> and <code>y</code> are not equal, prepend 1 to the dimensions of the tensor with fewer dimensions to make them equal length.</li><li>Then, for each dimension size, the resulting dimension size is the max of the sizes of <code>x</code> and <code>y</code> along that dimension.</li></ul></blockquote></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from https://nrehiew.github.io/blog/pytorch/</span></span><br><span class="line"><span class="keyword">for</span> each dimension, starting from the right:</span><br><span class="line"><span class="keyword">if</span> both shapes have this dimension:</span><br><span class="line"><span class="keyword">if</span> they are different:</span><br><span class="line">neither is 1: error</span><br><span class="line"><span class="keyword">else</span>: use larger dimension </span><br><span class="line"><span class="keyword">else</span> they are the same: use dimension</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">use whichever dimension exists</span><br></pre></td></tr></table></figure><p>å¹¿æ’­,ä¸å­˜åœ¨æ•°æ®copy.è¿™æ„å‘³ç€,å¦‚æœå°†ä¸€ä¸ªå°å¼ é‡å¹¿æ’­åˆ°ä¸€ä¸ªå¤§å¾—å¤šçš„å½¢çŠ¶,å°±ä¸ä¼šäº§ç”Ÿå†…å­˜æˆ–æ€§èƒ½å¼€é”€ã€‚</p><p>å…¶æ¬¡,ç”±äºè¾ƒå°å¼ é‡ä¸­ä½¿ç”¨çš„å®é™…å…ƒç´ æ˜¯ç›¸åŒçš„,å› æ­¤æ¢¯åº¦ä¼šæ²¿ç€è¿™ä¸ªè¾ƒå°ç»´åº¦ä¸­çš„é¡¹ç›®ç´¯ç§¯.è¿™åœ¨è°ƒè¯•æ¢¯åº¦æˆ–æ‰§è¡Œæ¶‰åŠå¹¿æ’­çš„è‡ªå®šä¹‰è‡ªåŠ¨æ¢¯åº¦å‡½æ•°æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x=torch.empty(<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">y=torch.empty(  <span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">(x+y).size()</span><br><span class="line"></span><br><span class="line">x=torch.empty(<span class="number">1</span>)</span><br><span class="line">y=torch.empty(<span class="number">3</span>,<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">(x+y).size()</span><br><span class="line"></span><br><span class="line">x=torch.empty(<span class="number">5</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">y=torch.empty(<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">(x+y).size()</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€ä¸ª PyTorch æ“ä½œæ”¯æŒå¹¿æ’­,é‚£ä¹ˆå®ƒçš„å¼ é‡æ•°æ®å°±ä¼šè‡ªåŠ¨æ‰©å±•ä¸ºå¤§å°ç›¸ç­‰çš„æ•°æ®(æ— éœ€å¤åˆ¶æ•°æ®),æ‰€ä»¥æœ¬è´¨ä¸Šä¹Ÿæ˜¯è¿”å›ä¸€ä¸ªè§†å›¾.</p><h3 id="åˆ©ç”¨çŸ©é˜µä¹˜æ³•è¿›è¡Œå¹¿æ’­"><a href="#åˆ©ç”¨çŸ©é˜µä¹˜æ³•è¿›è¡Œå¹¿æ’­" class="headerlink" title="åˆ©ç”¨çŸ©é˜µä¹˜æ³•è¿›è¡Œå¹¿æ’­"></a>åˆ©ç”¨çŸ©é˜µä¹˜æ³•è¿›è¡Œå¹¿æ’­</h3><p>çŸ©é˜µæ˜¯äºŒç»´çš„,ä½†æ˜¯tensoræ˜¯ä¸é™åˆ¶çš„.</p><p><strong>å¤šç»´tensorå¦‚ä½•ç›¸ä¹˜çš„å‘¢?</strong></p><ol><li>å–ä¸¤ä¸ªå¼ é‡çš„æœ€åä¸¤ä¸ªç»´åº¦,æ£€æŸ¥å®ƒä»¬æ˜¯å¦å¯ä»¥ç›¸ä¹˜.å¦‚æœä¸èƒ½,åˆ™å‡ºé”™</li><li>å¹¿æ’­å‰©ä½™ç»´æ•°.ç»“æœå½¢çŠ¶ä¸º [å¹¿æ’­åçš„ç»´æ•°] + [çŸ©é˜µä¹˜æ³•çš„ç»“æœå½¢çŠ¶]ã€‚</li><li>å°† [å¹¿æ’­åçš„ç»´æ•°] ä½œä¸ºæ‰¹å¤„ç†ç»´åº¦ï¼Œæ‰§è¡Œbatched matrix multiplication(å…¶å®å°±æ˜¯çŸ©é˜µä¹˜æ³•,ä½†æ˜¯ä¸¤ä¸ªç›¸ä¹˜çš„çŸ©é˜µåˆ†åˆ«æ¥è‡ªä¸åŒçš„batchä¸­çš„ç›¸åŒçš„index)</li></ol><p>ä½¿ç”¨torch.matmulè¿›è¡Œtensorç›¸ä¹˜,å®ƒçš„è®¡ç®—æ–¹å¼å¦‚ä¸‹</p><ul><li><p>å¦‚æœéƒ½æ˜¯ä¸€ç»´,è¿›è¡Œç‚¹ä¹˜</p></li><li><p>å¦‚æœéƒ½æ˜¯äºŒç»´,è¿›è¡ŒçŸ©é˜µä¹˜,,å¦‚æœæ˜¯1ç»´å’ŒäºŒç»´,åœ¨ä¸€ç»´åº¦ä¹‹å‰æ·»åŠ ä¸€ä¸ªç»´åº¦åœ¨è¿›è¡ŒçŸ©é˜µä¹˜,ä¹˜å®Œä¹‹åå†å»æ‰.</p></li><li><p>å¦‚æœæ˜¯äºŒç»´å’Œ1ç»´,è¿›è¡ŒçŸ©é˜µ-å‘é‡ä¹˜æ³•,å¾—åˆ°å‘é‡.</p></li><li><p>å¦‚æœä¸¤ä¸ªå‚æ•°éƒ½è‡³å°‘ä¸º 1 ç»´,ä¸”è‡³å°‘ä¸€ä¸ªå‚æ•°ä¸º N ç»´(N &gt; 2),åˆ™è¿”å›ä¸€ä¸ªbatched matrix multiplication.</p><p>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ç»´çš„,é‚£ä¹ˆåœ¨è¿›è¡Œbatched matrix multiplication,ä¼šåœ¨å…¶ç»´åº¦å‰æ·»åŠ ä¸€ç»´,ç„¶ååˆ é™¤.</p><p>å¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ç»´çš„,åˆ™åœ¨å…¶ç»´åº¦ååŠ ä¸Š 1,ä»¥ä¾¿è¿›è¡Œbatched matrix multiply,å¹¶åœ¨è¿ç®—ååˆ é™¤.</p><p>éçŸ©é˜µ(å³æ‰¹å¤„ç†)ç»´åº¦å°†è¢«å¹¿æ’­(å› æ­¤å¿…é¡»æ˜¯<strong>å¯å¹¿æ’­çš„</strong>)</p><p>æ¯”å¦‚(jx1xnxn)å’Œ(kxnxn)å¾—åˆ°(jxkxnxn),åœ¨batchä¸Šå¹¿æ’­å¾—åˆ°(jxk),ç®€å•æ¥è¯´å°±æ˜¯æœ€åä¸¤ç»´(ä¸å¤Ÿè¿›è¡Œå¹¿æ’­)è¿›è¡Œç›¸ä¹˜,é™¤äº†åé¢ä¸¤ç»´,å…¶ä»–ç»´åº¦ç›´æ¥è¿›è¡Œå¹¿æ’­.</p></li></ul><blockquote><p>æ³¨æ„:å¹¿æ’­é€»è¾‘åœ¨ç¡®å®šè¾“å…¥æ˜¯å¦å¯å¹¿æ’­æ—¶ï¼ŒåªæŸ¥çœ‹æ‰¹æ¬¡ç»´åº¦ï¼Œè€Œä¸æŸ¥çœ‹çŸ©é˜µç»´åº¦ã€‚</p><p>è¿™è·Ÿä¸Šé¢çš„å¹¿æ’­é€»è¾‘ä¸åŒ.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">a = torch.randn((<span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>)) <span class="comment"># 3 x 4 x 1 x 2</span></span><br><span class="line">b = torch.randn((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)) <span class="comment"># 1 x 2 x 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Matrix Multiply Shape: 1x2 @ 2x3 -&gt; 1x3</span></span><br><span class="line"><span class="comment"># Batch Shape: We broadcast (3, 4) and (1) -&gt; (3, 4)</span></span><br><span class="line"><span class="comment"># Result shape: 3 x 4 x 1 x 3</span></span><br><span class="line">c = torch.zeros((<span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>))</span><br><span class="line"><span class="comment"># iterate over the batch dimensions of (3, 4)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">a_slice = a[i][j] <span class="comment"># 1 x 2</span></span><br><span class="line">b_slice = b[<span class="number">0</span>] <span class="comment"># 2 x 3</span></span><br><span class="line">c[i][j] = a_slice @ b_slice <span class="comment"># 1 x 3</span></span><br><span class="line"><span class="keyword">assert</span> torch.equal(torch.matmul(a, b), c)</span><br></pre></td></tr></table></figure><h3 id="åå‘ä¼ æ’­"><a href="#åå‘ä¼ æ’­" class="headerlink" title="åå‘ä¼ æ’­"></a>åå‘ä¼ æ’­</h3><p>PyTorch çš„æ ¸å¿ƒæ˜¯å®ƒçš„è‡ªåŠ¨å¾®åˆ†å¼•æ“.ä¸€èˆ¬æ¥è¯´,<strong>æ¯æ¬¡åœ¨ä¸¤ä¸ªå¼ é‡ä¹‹é—´è¿›è¡Œå¾®åˆ†æ“ä½œæ—¶,PyTorch éƒ½ä¼šé€šè¿‡å›è°ƒå‡½æ•°è‡ªåŠ¨æ„å»ºå‡ºæ•´ä¸ªè®¡ç®—å›¾. ç„¶å,å½“è°ƒç”¨ .backward() æ—¶,æ¯ä¸ªå¼ é‡çš„æ¢¯åº¦éƒ½ä¼šè¢«æ›´æ–°</strong>. è¿™æ˜¯ PyTorch æœ€å¤§çš„æŠ½è±¡.</p><p>ä»æ ‡é‡çš„æ±‚å¯¼å¼€å§‹æ‰©å±•åˆ°é«˜ç»´,è¿™å¹¶ä¸å›°éš¾.é¦–å…ˆéœ€è¦ç†è§£æ ‡é‡çš„åŸºæœ¬è¿ç®—ä¸­çš„åŠ /å‡æ³•,ä¹˜æ³•,å¹‚ã€æŒ‡ä»¥åŠå¯¹æ•°.ä¸€ä¸ªsoftmaxæ“ä½œå°±åŒ…å«äº†åŠ ,å¹‚æŒ‡çš„æ“ä½œ.</p><p> å¯ä»¥å°†çŸ©é˜µä¹˜æ³•çœ‹ä½œæ˜¯å¤šä¸ªæ ‡é‡å€¼çš„ä¸€ç³»åˆ—ä¹˜æ³•å’ŒåŠ æ³•è¿ç®—,åªéœ€æŒ‡å®šè¿™äº›æ ‡é‡è¿ç®—çš„åå‘è¿ç®—,ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜çš„å¯¼æ•°å°±è‡ªç„¶è€Œç„¶åœ°äº§ç”Ÿäº†.</p><p>ä»æ ‡é‡çš„è§’åº¦æ¥è€ƒè™‘æ¢¯åº¦è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯ä»¥ç›´è§‚åœ°äº†è§£å¼ é‡æ“ä½œå¯¹æ¢¯åº¦çš„å½±å“ã€‚</p><p>ä¾‹å¦‚ï¼Œ.reshape()ã€.transpose()ã€.cat å’Œ .split()ç­‰æ“ä½œä¸ä¼šå½±å“å•ä¸ªå€¼åŠå…¶åœ¨æ ‡é‡çš„æ¢¯åº¦ã€‚ å› æ­¤è¿™äº›æ“ä½œå¯¹å¼ é‡æ¢¯åº¦çš„å½±å“è‡ªç„¶å°±æ˜¯æ“ä½œæ¢¯åº¦æœ¬èº«ã€‚ </p><p>ä¾‹å¦‚,ä½¿ç”¨ .reshape(-1) å¯¹å¼ é‡è¿›è¡Œæ‰å¹³åŒ–å¤„ç†,å¯¹æ¢¯åº¦çš„å½±å“ä¸è°ƒç”¨ .reshape(-1) å¯¹å¼ é‡çš„æ¢¯åº¦çš„å½±å“ç›¸åŒã€‚</p><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><h4 id="çŸ©é˜µç›¸ä¹˜"><a href="#çŸ©é˜µç›¸ä¹˜" class="headerlink" title="çŸ©é˜µç›¸ä¹˜"></a>çŸ©é˜µç›¸ä¹˜</h4><p>ä¸ä½¿ç”¨ GPU ä¹Ÿèƒ½å®ç°çš„ä¼˜åŒ–æ–¹æ³•.</p><p> ä¸€ç§å¯èƒ½çš„ä¼˜åŒ–æ–¹æ³•æ˜¯åˆ©ç”¨å†…å­˜è®¿é—®æ¨¡å¼,è€Œä¸æ˜¯æ”¹å˜ç®—æ³•ã€‚ å›æƒ³ä¸€ä¸‹,åœ¨ç»™å®š A @ B çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨é‡å¤è®¡ç®— A ä¸­çš„ä¸€è¡Œå’Œ B ä¸­çš„ä¸€åˆ—çš„ç‚¹ä¹˜. </p><p>ç®€å•çš„è§£å†³æ–¹æ³•æ˜¯è½¬ç½®,å°†å…¶è½¬ä¸ºåˆ—ä¸»æ¨¡å¼(column-first),è¿™æ ·æ¯æ¬¡ä»å†…å­˜åŠ è½½æ—¶,æˆ‘ä»¬å°±å¯ä»¥åœ¨åŒä¸€ç¼“å­˜è¡Œä¸­åŠ è½½ B åˆ—ä¸­çš„æ­£ç¡®é¡¹ç›®.</p><p>è½¬ç½®æ˜¯ä¸€ç§O(N) æ“ä½œï¼Œå› æ­¤åªé€‚ç”¨äºè¾ƒå¤§çš„çŸ©é˜µ.</p><p>å¦ä¸€ç§æ— éœ€ç¼“å­˜çš„ç®—æ³•æ˜¯å¯¹çŸ©é˜µå—è¿›è¡Œè¿ç®—ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¯¹æ•´ä¸ªçŸ©é˜µè¿›è¡Œè¿ç®—ã€‚ è¿™å°±æ˜¯æ‰€è°“çš„<strong>å—çŸ©é˜µä¹˜æ³•</strong>ã€‚ å…¶åŸç†æ˜¯å°†çŸ©é˜µåˆ†è§£æˆè¾ƒå°çš„å—ï¼Œç„¶ååœ¨è¿™äº›å—ä¸Šæ‰§è¡ŒçŸ©é˜µä¹˜æ³•ã€‚ è¿™æ ·åšçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å‡å°‘äº†é«˜é€Ÿç¼“å­˜çš„è¯»å–æ¬¡æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æ˜¯åœ¨çŸ©é˜µçš„è¾ƒå°å—ä¸Šè¿›è¡Œè¿ç®—ã€‚</p><h4 id="å†…å­˜å’Œä¸­é—´å€¼"><a href="#å†…å­˜å’Œä¸­é—´å€¼" class="headerlink" title="å†…å­˜å’Œä¸­é—´å€¼"></a>å†…å­˜å’Œä¸­é—´å€¼</h4><blockquote><p>è¿™é‡ŒåŸæ–‡<a href="https://nrehiew.github.io/blog/pytorch/">Taking PyTorch for Granted | wh (nrehiew.github.io)</a>ä¼¼ä¹æœ‰typos,æˆ‘è¿›è¡Œäº†ä¿®æ­£</p></blockquote><p>åœ¨åå‘ä¼ æ’­æ—¶,ç¬¦åˆç›´è§‰çš„æƒ³æ³•æ˜¯ä¿ç•™ä¸­é—´å€¼çš„æ¢¯åº¦,ä»¥ä¾¿åç»­è®¡ç®—leaf tensorçš„æ¢¯åº¦.ä½†æ˜¯æœ‰äº›æ—¶å€™å¹¶ä¸éœ€è¦ä¸­é—´å€¼çš„æ¢¯åº¦</p><p>æ¯”å¦‚(a*b)+(c*d)=e,è¿›è¡Œåå‘ä¼ æ’­æ±‚eåœ¨açš„æ¢¯åº¦æ—¶å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_t1 = a * b</span><br><span class="line">_t2 = c * d</span><br><span class="line">e = _t1 + _t2</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æ±‚b,æ‰€ä»¥å¹¶ä¸éœ€è¦ä¿ç•™_t1å’Œ_t2çš„å€¼.</p><h3 id="micrograd-from-scratch"><a href="#micrograd-from-scratch" class="headerlink" title="micrograd from scratch"></a>micrograd from scratch</h3><p>æ­¤å¤–è¿˜æœ‰ä¸ªtinygradçš„é¡¹ç›®ä¹Ÿæ˜¯å—æ­¤å¯å‘,åœ¨pytorchå’Œmicrogradä¸­å¾—åˆ°æ”¹è¿›.</p><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://github.com/karpathy/micrograd">karpathy/micrograd: A tiny scalar-valued autograd engine and a neural net library on top of it with PyTorch-like API (github.com)</a></li><li><a href="https://github.com/karpathy/nn-zero-to-hero?tab=readme-ov-file">karpathy/nn-zero-to-hero: Neural Networks: Zero to Hero (github.com)</a></li><li><a href="https://github.com/karpathy/nanoGPT">karpathy/nanoGPT: The simplest, fastest repository for training/finetuning medium-sized GPTs. (github.com)</a></li><li><a href="https://blog.csdn.net/weixin_44008424/article/details/110764494">pytorchç¬”è®°ï¼ˆä¸€ï¼‰â€”â€”tensorçš„storage()ã€stride()ã€storage_offsetï¼ˆï¼‰_pytorch storage-CSDNåšå®¢</a></li><li><a href="https://blog.csdn.net/m0_46653437/article/details/108742525">PyTorchä¸­å¼ é‡çš„shapeå’Œstrideçš„å…³ç³»_shapeå’Œstrides-CSDNåšå®¢</a></li><li><a href="http://blog.ezyang.com/2019/05/pytorch-internals/">PyTorch internals : ezyangâ€™s blog</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;inspired by &lt;a href=&quot;https://github.com/karpathy/micrograd&quot;&gt;karpathy/micrograd: A tiny scalar-valued autograd engine and a neural net library on top of it with PyTorch-like API (github.com)&lt;/a&gt;and &lt;a href=&quot;https://nrehiew.github.io/blog/pytorch/&quot;&gt;Taking PyTorch for Granted | wh (nrehiew.github.io)&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;æ„Ÿè°¢Karpathyä»¥åŠxä¸Šæ‰€æœ‰çœŸå¿ƒæ¢è®¨æŠ€æœ¯çš„ç½‘å‹.è¿™å±äºkarpathyçš„&lt;a href=&quot;https://github.com/karpathy/nn-zero-to-hero?tab=readme-ov-file&quot;&gt;karpathy/nn-zero-to-hero: Neural Networks: Zero to Hero ,(github.com)&lt;/a&gt;è¯¾ç¨‹.äº‹å®ä¸Šä»–è¿˜æœ‰å¾ˆå¤šå€¼å¾—ä¸€çœ‹çš„è¯¾ç¨‹å’Œrepos.&lt;/p&gt;</summary>
    
    
    
    
    <category term="tensor" scheme="https://www.sekyoro.top/tags/tensor/"/>
    
  </entry>
  
  <entry>
    <title>i3wm,Neovimä¸Alacrittyçš„ä½¿ç”¨ä¸é…ç½®</title>
    <link href="https://www.sekyoro.top/2024/07/06/i3wm%E3%80%81Neovim%E4%B8%8EAlacritty%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%85%8D%E7%BD%AE/"/>
    <id>https://www.sekyoro.top/2024/07/06/i3wm%E3%80%81Neovim%E4%B8%8EAlacritty%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%85%8D%E7%BD%AE/</id>
    <published>2024-07-06T03:54:41.000Z</published>
    <updated>2024-07-06T15:11:39.814Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>å¸¸ç”¨çš„çª—å£ç®¡ç†å™¨,ç¼–è¾‘å™¨ä¸ç»ˆç«¯æ¨¡æ‹Ÿå™¨ç­‰ç­‰<br><span id="more"></span><br>è¿™äº›å·¥å…·éƒ½æœ‰ç›¸å¯¹çš„ä¼˜åŠ£,æˆ‘ä¸ªäººè§‰å¾—<strong>ç”Ÿæ€</strong>,<strong>ç¨³å®šæ€§</strong>æ˜¯ä¸¤ä¸ªéå¸¸é‡è¦çš„å› ç´ . ç”Ÿæ€å¥½å°±ä¼šæœ‰ä¸æ–­çš„æ›´æ–°å’Œç»´æŠ¤,ç¨³å®šæ€§ä¼šè®©ç”¨æˆ·æ›´å¥½çš„é•¿æœŸé€‚åº”.</p><h3 id="i3wm"><a href="#i3wm" class="headerlink" title="i3wm"></a>i3wm</h3><p>i3wmæ˜¯ä¸ªåŸºäºx11çš„çª—å£ç®¡ç†å™¨,ç”Ÿæ€å¾ˆå¼º<a href="https://github.com/fz-wu/i3_user_guide_Chinese">fz-wu/i3_user_guide_Chinese: i3wmå®˜æ–¹æŒ‡å—,æ–¹ä¾¿åŒå­¦ä»¬å­¦ä¹ i3wm. i3æ˜¯ä¸€ä¸ªå¹³é“ºå¼çš„çª—å£ç®¡ç†å™¨ (github.com)</a></p><p><img data-src="https://i3wm.org/docs/modes.png" alt="Container modes"></p><p>ç±»ä¼¼çš„è¿˜æœ‰awesome wm,dwm,ä¹Ÿæœ‰åŸºäºwaylandçš„compositor hyprland(æ²¡æœ‰ä½¿ç”¨hyprlandä¹Ÿæ˜¯å› ä¸ºæ„Ÿè§‰è¿˜ä¸å¤ªç¨³å®š,ç­‰è¿‡æ®µæ—¶é—´å†çœ‹çœ‹).è¯¦æƒ…çœ‹<a href="https://wiki.archlinux.org/title/Comparison_of_tiling_window_managers">Comparison of tiling window managers - ArchWiki (archlinux.org)</a>å’Œ<a href="https://wiki.archlinux.org/title/Wayland#Tiling">Wayland - ArchWiki (archlinux.org)</a></p><p>å…·ä½“é…ç½®æ–‡æ¡£<a href="https://i3wm.org/docs/userguide.html#configuring">i3: i3 Userâ€™s Guide (i3wm.org)</a></p><p>ä¸€ä¸ªä¾‹å­<a href="https://github.com/levinit/i3wm-config/blob/master/i3/config">i3wm-config/i3/config at master Â· levinit/i3wm-config (github.com)</a></p><p>i3æœ¬èº«ä¸æ”¯æŒé€æ˜ç­‰åŠŸèƒ½,è¿˜éœ€è¦å®‰è£…å…¶ä»–å·¥å…·<a href="https://zocoxx.com/archlinux-i3wm.html">ArchLinuxç³»ç»Ÿi3wmé…ç½®åŠä½“éªŒè®°å½• â€“ ZocoXX</a>,<a href="https://levinit.github.io/i3wm-config/#:~:text=ç¼–è¾‘ i3%2Fconfig æ–‡ä»¶å¯åˆ‡æ¢æ¨¡å¼ã€‚,éšæœºæ¨¡å¼ï¼šè‡ªåŠ¨åˆ‡æ¢å£çº¸ï¼Œå°†è¦ç”¨ä½œå£çº¸çš„å›¾ç‰‡æ”¾åˆ° ~%2FPictures%2Fwallpapers å³å¯ã€‚">i3wm-config | my i3wm config (levinit.github.io)</a></p><h3 id="awesomewm"><a href="#awesomewm" class="headerlink" title="awesomewm"></a>awesomewm</h3><p>ä½¿ç”¨luaé…ç½®,ç›¸å¯¹i3çš„æ–‡æœ¬é…ç½®,ä¸ªäººè®¤ä¸ºæ›´å‹å¥½,ä¸Šæ‰‹é—¨æ§›æ›´ä½.<a href="https://github.com/atsepkov/awesome-awesome-wm">atsepkov/awesome-awesome-wm: A curated list of awesome tools/scripts/configs for Awesome Window Manager. (github.com)</a>,é™¤äº†æœ¬èº«çª—å£ç®¡ç†å¤–,è¿˜æœ‰æŸ¥çœ‹CPUèµ„æº,å›¾ç‰‡ç­‰å·¥å…·éœ€è¦é¢å¤–å®‰è£….</p><p>æ‰€ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„åšæ³•å°±æ˜¯cloneå…¶ä»–äººçš„é…ç½®ğŸ˜…</p><p><strong>i3</strong></p><ul><li><a href="https://github.com/addy-dclxvi/i3-starterpack">addy-dclxvi/i3-starterpack: A simple guide (and example of configuration) to install i3 &amp; its and essentials packages, then make them look eye candy. (github.com)</a></li><li><a href="https://github.com/sainathadapa/i3-wm-config">sainathadapa/i3-wm-config: I3 tiling window manager configuration (github.com)</a></li><li><a href="https://github.com/levinit/i3wm-config">levinit/i3wm-config: my i3wm config (github.com)</a></li><li><a href="https://github.com/typecraft-dev/dotfiles">typecraft-dev/dotfiles (github.com)</a></li></ul><p><strong>awesome</strong></p><ul><li><a href="https://github.com/raven2cz/dotfiles">raven2cz/dotfiles: Dotfiles are the customization files in GNU/Linux. This repository assembly together all my others github config repos to one union. You can choose this global conf for your system or check other repos.</a></li><li><a href="https://github.com/pw4ever/awesome-wm-config">pw4ever/awesome-wm-config: awesome window manager config with persistent dynamic tagging (github.com)</a></li></ul><p><strong>hyprland</strong><a href="https://wiki.hyprland.org/Configuring/">Configuring â€“ Hyprland Wiki</a></p><ul><li><a href="https://github.com/SolDoesTech/hyprland">SolDoesTech/hyprland: collection of dot config files for hyprland with a simple install script for a fresh Arch linux with yay (github.com)</a></li><li><a href="https://github.com/notwidow/hyprland">notwidow/hyprland: hyprland config (github.com)</a></li><li><a href="https://github.com/AhmedSaadi0/my-hyprland-config/blob/main/hyprland.conf">my-hyprland-config/hyprland.conf at main Â· AhmedSaadi0/my-hyprland-config (github.com)</a></li></ul><p>ä¸ªäººæ„Ÿè§‰è¿˜æ˜¯hyprlandçš„é…ç½®å’Œæ–‡æ¡£å¥½,ä½†æ˜¯ä½¿ç”¨ä¸Šbugå¯èƒ½ä¸å°‘.</p><h3 id="Neovim"><a href="#Neovim" class="headerlink" title="Neovim"></a>Neovim</h3><p>åŸºäºvimçš„ç¼–è¾‘å™¨,æ›´å¥½åœ°è¿›è¡Œé…ç½®ã€å®‰è£…æ’ä»¶.</p><p>ä¸»è¦æ˜¯éœ€è¦äº†è§£neovimçš„ä¸€äº›é…ç½®è¯­æ³•,å¦‚æœä¸ºäº†æ–¹ä¾¿ç›´æ¥ä½¿ç”¨lazyvimç­‰é…ç½®å³å¯.</p><p><a href="https://neovim.io/doc/user/lua-guide.html">Lua-guide - Neovim docs</a> neovimä½¿ç”¨vim.*ç­‰å˜é‡æ›¿ä»£äº†åŸæœ¬çš„vimscript,ä¸è¿‡ä½ ä¾ç„¶å¯ä»¥ä½¿ç”¨vim.cmdæ‰§è¡Œvimscript,ä½¿ç”¨vim.fnæ‰§è¡Œå‡½æ•°</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim.cmd(<span class="string">&quot;colorscheme habamax&quot;</span>)</span><br><span class="line">vim.cmd.highlight(&#123; <span class="string">&quot;Error&quot;</span>, <span class="string">&quot;guibg=red&quot;</span> &#125;)</span><br><span class="line"><span class="built_in">print</span>(vim.fn.printf(<span class="string">&#x27;Hello from %s&#x27;</span>, <span class="string">&#x27;Lua&#x27;</span>))</span><br><span class="line"><span class="keyword">local</span> reversed_list = vim.fn.<span class="built_in">reverse</span>(&#123; <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span> &#125;)</span><br><span class="line">vim.<span class="built_in">print</span>(reversed_list) <span class="comment">-- &#123; &quot;c&quot;, &quot;b&quot;, &quot;a&quot; &#125;</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">print_stdout</span><span class="params">(chan_id, data, name)</span></span></span><br><span class="line">  <span class="built_in">print</span>(data[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">vim.fn.jobstart(<span class="string">&#x27;ls&#x27;</span>, &#123; on_stdout = print_stdout &#125;)</span><br></pre></td></tr></table></figure><h4 id="vim-å˜é‡"><a href="#vim-å˜é‡" class="headerlink" title="vim.*å˜é‡"></a>vim.*å˜é‡</h4><p><a href="https://neovim.io/doc/user/lua.html#vim.g">vim.g</a>: global variables (<a href="https://neovim.io/doc/user/eval.html#g%3A">g:</a>)</p><p><a href="https://neovim.io/doc/user/lua.html#vim.b">vim.b</a>: variables for the current buffer (<a href="https://neovim.io/doc/user/eval.html#b%3A">b:</a>)</p><p><a href="https://neovim.io/doc/user/lua.html#vim.w">vim.w</a>: variables for the current window (<a href="https://neovim.io/doc/user/eval.html#w%3A">w:</a>)</p><p><a href="https://neovim.io/doc/user/lua.html#vim.t">vim.t</a>: variables for the current tabpage (<a href="https://neovim.io/doc/user/eval.html#t%3A">t:</a>)</p><p><a href="https://neovim.io/doc/user/lua.html#vim.v">vim.v</a>: predefined Vim variables (<a href="https://neovim.io/doc/user/eval.html#v%3A">v:</a>)</p><p><a href="https://neovim.io/doc/user/lua.html#vim.env">vim.env</a>: environment variables defined in the editor session</p><h4 id="è®¾ç½®options"><a href="#è®¾ç½®options" class="headerlink" title="è®¾ç½®options"></a>è®¾ç½®options</h4><p>optionså°±æ˜¯vimä¸­çš„è¡¨ç°æ¯”å¦‚set smarttab</p><p>è®¾ç½®å…¨å±€å’Œæœ¬åœ°é€‰é¡¹ï¼ˆä¾‹å¦‚åœ¨ init.lua ä¸­ï¼‰æœ€æ–¹ä¾¿çš„æ–¹æ³•æ˜¯é€šè¿‡ vim.opt.<br>è®¾ç½®å…¨å±€å’Œæœ¬åœ°é€‰é¡¹æœ€æ–¹ä¾¿çš„æ–¹æ³•æ˜¯é€šè¿‡ vim.opt å’Œå®ƒçš„æœ‹å‹ä»¬ï¼š<br>vim.opt: è¡Œä¸ºç±»ä¼¼äº :set<br>vim.opt_global: è¡Œä¸ºç±»ä¼¼äº :setglobal<br>vim.opt_localï¼šè¡Œä¸ºç±»ä¼¼äº :setlocal</p><h5 id="vim-opt"><a href="#vim-opt" class="headerlink" title="vim.opt"></a>vim.opt</h5><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim.opt.smarttab = <span class="literal">true</span></span><br><span class="line">vim.opt.smarttab = <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>ä»£ä»·æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®é€‰é¡¹å€¼ï¼Œè€Œå¿…é¡»<br>ä½¿ç”¨ vim.opt:get()ï¼š</p><h5 id="vim-o"><a href="#vim-o" class="headerlink" title="vim.o"></a>vim.o</h5><p>æœ‰ä¸€ç§æ›´ç›´æ¥çš„ç±»ä¼¼å˜é‡çš„è®¿é—®æ–¹å¼,ä½¿ç”¨ vim.o<br>vim.oï¼šè¡Œä¸ºç±»ä¼¼äº :set<br>vim.goï¼šè¡Œä¸ºç±»ä¼¼äº :setglobal<br>vim.boï¼šç”¨äºç¼“å†²åŒºé€‰é¡¹<br>vim.woï¼šç”¨äºçª—å£çš„é€‰é¡¹</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim.o.smarttab = <span class="literal">false</span> <span class="comment">-- :set nosmarttab</span></span><br><span class="line"><span class="built_in">print</span>(vim.o.smarttab)</span><br><span class="line"><span class="comment">--&gt; false</span></span><br><span class="line">vim.o.listchars = <span class="string">&#x27;space:_,tab:&gt;~&#x27;</span> <span class="comment">-- :set listchars=&#x27;space:_,tab:&gt;~&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(vim.o.listchars)</span><br><span class="line"><span class="comment">--&gt; &#x27;space:_,tab:&gt;~&#x27;</span></span><br><span class="line">vim.o.isfname = vim.o.isfname .. <span class="string">&#x27;,@-@&#x27;</span> <span class="comment">-- :set isfname+=@-@</span></span><br><span class="line"><span class="built_in">print</span>(vim.o.isfname)</span><br><span class="line"><span class="comment">--&gt; &#x27;@,48-57,/,.,-,_,+,,,#,$,%,~,=,@-@&#x27;</span></span><br><span class="line">vim.bo.shiftwidth = <span class="number">4</span> <span class="comment">-- :setlocal shiftwidth=4</span></span><br><span class="line"><span class="built_in">print</span>(vim.bo.shiftwidth)</span><br><span class="line"><span class="comment">--&gt; 4</span></span><br><span class="line">vim.bo[<span class="number">4</span>].expandtab = <span class="literal">true</span> <span class="comment">-- sets expandtab to true in buffer 4</span></span><br><span class="line">vim.wo.number = <span class="literal">true</span>       <span class="comment">-- sets number to true in current window</span></span><br><span class="line">vim.wo[<span class="number">0</span>].number = <span class="literal">true</span>    <span class="comment">-- same as above</span></span><br><span class="line">vim.wo[<span class="number">0</span>][<span class="number">0</span>].number = <span class="literal">true</span> <span class="comment">-- sets number to true in current buffer</span></span><br><span class="line">                           <span class="comment">-- in current window only</span></span><br><span class="line"><span class="built_in">print</span>(vim.wo[<span class="number">0</span>].number)    <span class="comment">--&gt; true</span></span><br></pre></td></tr></table></figure><h4 id="Mappings"><a href="#Mappings" class="headerlink" title="Mappings"></a>Mappings</h4><p>è®¾ç½®æ‰§è¡Œå‘½ä»¤çš„å¿«æ·é”®.</p><p>å¯ä»¥ä½¿ç”¨ vim.keymap.set() åˆ›å»ºæ˜ å°„ã€‚è¯¥å‡½æ•°éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼š<br>{mode} æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²è¡¨ï¼ŒåŒ…å«æ˜ å°„ç”Ÿæ•ˆçš„æ¨¡å¼å‰ç¼€ã€‚å‰ç¼€æ˜¯ :map-modes ä¸­åˆ—å‡ºçš„å‰ç¼€ï¼Œæˆ– :map! ä¸­çš„â€!â€ï¼Œæˆ– :map ä¸­çš„ç©ºå­—ç¬¦ä¸²ã€‚<br>{lhs} æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«åº”è§¦å‘æ˜ å°„çš„é”®åºåˆ—ã€‚<br>{rhs} æ˜¯åŒ…å« Vim å‘½ä»¤æˆ– Lua å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œå½“è¾“å…¥ {lhs} æ—¶åº”æ‰§è¡Œè¯¥å‘½ä»¤æˆ–å‡½æ•°ã€‚ç©ºå­—ç¬¦ä¸²ç­‰åŒäº <Nop>ï¼Œè¡¨ç¤ºç¦ç”¨æŒ‰é”®ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Normal mode mapping for Vim command</span></span><br><span class="line">vim.keymap.set(<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;&lt;Leader&gt;ex1&#x27;</span>, <span class="string">&#x27;&lt;cmd&gt;echo &quot;Example 1&quot;&lt;cr&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">-- Normal and Command-line mode mapping for Vim command</span></span><br><span class="line">vim.keymap.set(&#123;<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;c&#x27;</span>&#125;, <span class="string">&#x27;&lt;Leader&gt;ex2&#x27;</span>, <span class="string">&#x27;&lt;cmd&gt;echo &quot;Example 2&quot;&lt;cr&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">-- Normal mode mapping for Lua function</span></span><br><span class="line">vim.keymap.set(<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;&lt;Leader&gt;ex3&#x27;</span>, vim.treesitter.start)</span><br><span class="line"><span class="comment">-- Normal mode mapping for Lua function with arguments</span></span><br><span class="line">vim.keymap.set(<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;&lt;Leader&gt;ex4&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&#x27;Example 4&#x27;</span>) <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><h4 id="Autocommands"><a href="#Autocommands" class="headerlink" title="Autocommands"></a>Autocommands</h4><p>è‡ªåŠ¨å‘½ä»¤æ˜¯ä¸€ä¸ª Vim å‘½ä»¤æˆ–ä¸€ä¸ª Lua å‡½æ•°ï¼Œæ¯å½“è§¦å‘ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ï¼ˆå¦‚æ–‡ä»¶è¢«æ‰“å¼€ï¼‰æ—¶å°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim.api.nvim_create_autocmd(&#123;<span class="string">&quot;BufEnter&quot;</span>, <span class="string">&quot;BufWinEnter&quot;</span>&#125;, &#123;</span><br><span class="line">  pattern = &#123;<span class="string">&quot;*.c&quot;</span>, <span class="string">&quot;*.h&quot;</span>&#125;,</span><br><span class="line">  command = <span class="string">&quot;echo &#x27;Entering a C or C++ file&#x27;&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">-- Same autocommand written with a Lua function instead</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123;<span class="string">&quot;BufEnter&quot;</span>, <span class="string">&quot;BufWinEnter&quot;</span>&#125;, &#123;</span><br><span class="line">  pattern = &#123;<span class="string">&quot;*.c&quot;</span>, <span class="string">&quot;*.h&quot;</span>&#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;Entering a C or C++ file&quot;</span>) <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">-- User event triggered by MyPlugin</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;User&quot;</span>, &#123;</span><br><span class="line">  pattern = <span class="string">&quot;MyPlugin&quot;</span>,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;My Plugin Works!&quot;</span>) <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="User-commands"><a href="#User-commands" class="headerlink" title="User commands"></a>User commands</h4><p>ç”¨æˆ·å‘½ä»¤å¯é€šè¿‡ nvim_create_user_command() åˆ›å»ºã€‚è¯¥å‡½æ•°é¡»è¦ä¸‰ä¸ªå‚æ•°ï¼š<br>å‘½ä»¤åç§°å­—ç¬¦ä¸²ï¼ˆå¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œä»¥åŒºåˆ«äºå†…ç½®å‘½ä»¤ï¼‰ï¼›<br>ä¸€ä¸ªåŒ…å« Vim å‘½ä»¤æˆ– Lua å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œå‘½ä»¤è°ƒç”¨æ—¶æ‰§è¡Œè¯¥å­—ç¬¦ä¸²ï¼›<br>åŒ…å«å‘½ä»¤å±æ€§çš„è¡¨æ ¼ï¼›æ­¤å¤–ï¼Œå®ƒè¿˜å¯ä»¥åŒ…å«å…³é”®å­— descï¼ˆæè¿°å‘½ä»¤çš„å­—ç¬¦ä¸²ï¼‰ã€forceï¼ˆè®¾ç½®ä¸º false ä»¥é¿å…æ›¿æ¢å·²å­˜åœ¨çš„åŒåå‘½ä»¤ï¼‰å’Œ previewï¼ˆç”¨äº :command-preview çš„ Lua å‡½æ•°ï¼‰ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim.api.nvim_create_user_command(<span class="string">&#x27;Test&#x27;</span>, <span class="string">&#x27;echo &quot;It works!&quot;&#x27;</span>, &#123;&#125;)</span><br><span class="line">vim.cmd.Test()</span><br><span class="line"><span class="comment">--&gt; It works!</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨lazyvim,lunarvim,Astrovimæˆ–è€…nvchadç­‰é…ç½®æ–‡ä»¶,å·²ç»ä¸ºæˆ‘ä»¬é…ç½®å¥½äº†å¾ˆå¤šä¸œè¥¿.</p><h4 id="LazyVim"><a href="#LazyVim" class="headerlink" title="LazyVim"></a>LazyVim</h4><p><code>lazyvim</code>è§„å®šäº†æ¯ä¸ªlazyvimçš„åº“åº”è¯¥æ€ä¹ˆç¼–å†™,ç¼–å†™æ–¹å¼æŒ‰ç…§æ–‡æ¡£è§„å®š.<code>nvchad</code>,<code>astrovim</code>éƒ½æ˜¯æŒ‰ç…§è¿™ç§æ–¹å¼çš„.</p><p>é»˜è®¤keymaps<a href="https://www.lazyvim.org/keymaps">âŒ¨ï¸ Keymaps | LazyVim</a></p><p><a href="https://www.lazyvim.org/configuration/plugins">Plugins | LazyVim</a></p><p>æ‹¿Lazyvimä¸¾ä¾‹,ç›¸å½“äºpacker.nvimç­‰æ’ä»¶ç®¡ç†å™¨çš„æ›¿ä»£,<code>lazy.vim</code>ä¸­é»˜è®¤è®¾ç½®å¦‚ä¸‹</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  root = vim.fn.stdpath(<span class="string">&quot;data&quot;</span>) .. <span class="string">&quot;/lazy&quot;</span>, <span class="comment">-- directory where plugins will be installed</span></span><br><span class="line">  defaults = &#123;</span><br><span class="line">    <span class="comment">-- Set this to `true` to have all your plugins lazy-loaded by default.</span></span><br><span class="line">    <span class="comment">-- Only do this if you know what you are doing, as it can lead to unexpected behavior.</span></span><br><span class="line">    lazy = <span class="literal">false</span>, <span class="comment">-- should plugins be lazy-loaded?</span></span><br><span class="line">    <span class="comment">-- It&#x27;s recommended to leave version=false for now, since a lot the plugin that support versioning,</span></span><br><span class="line">    <span class="comment">-- have outdated releases, which may break your Neovim install.</span></span><br><span class="line">    version = <span class="literal">nil</span>, <span class="comment">-- always use the latest git commit</span></span><br><span class="line">    <span class="comment">-- version = &quot;*&quot;, -- try installing the latest stable version for plugins that support semver</span></span><br><span class="line">    <span class="comment">-- default `cond` you can use to globally disable a lot of plugins</span></span><br><span class="line">    <span class="comment">-- when running inside vscode for example</span></span><br><span class="line">    cond = <span class="literal">nil</span>, <span class="comment">---@type boolean|fun(self:LazyPlugin):boolean|nil</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- leave nil when passing the spec as the first argument to setup()</span></span><br><span class="line">  spec = <span class="literal">nil</span>, <span class="comment">---@type LazySpec</span></span><br><span class="line">  local_spec = <span class="literal">true</span>, <span class="comment">-- load project specific .lazy.lua spec files. They will be added at the end of the spec.</span></span><br><span class="line">  lockfile = vim.fn.stdpath(<span class="string">&quot;config&quot;</span>) .. <span class="string">&quot;/lazy-lock.json&quot;</span>, <span class="comment">-- lockfile generated after running update.</span></span><br><span class="line">  <span class="comment">---@type number? limit the maximum amount of concurrent tasks</span></span><br><span class="line">  concurrency = jit.<span class="built_in">os</span>:<span class="built_in">find</span>(<span class="string">&quot;Windows&quot;</span>) <span class="keyword">and</span> (vim.uv.available_parallelism() * <span class="number">2</span>) <span class="keyword">or</span> <span class="literal">nil</span>,</span><br><span class="line">  git = &#123;</span><br><span class="line">    <span class="comment">-- defaults for the `Lazy log` command</span></span><br><span class="line">    <span class="comment">-- log = &#123; &quot;--since=3 days ago&quot; &#125;, -- show commits from the last 3 days</span></span><br><span class="line">    <span class="built_in">log</span> = &#123; <span class="string">&quot;-8&quot;</span> &#125;, <span class="comment">-- show the last 8 commits</span></span><br><span class="line">    timeout = <span class="number">120</span>, <span class="comment">-- kill processes that take more than 2 minutes</span></span><br><span class="line">    url_format = <span class="string">&quot;https://github.com/%s.git&quot;</span>,</span><br><span class="line">    <span class="comment">-- lazy.nvim requires git &gt;=2.19.0. If you really want to use lazy with an older version,</span></span><br><span class="line">    <span class="comment">-- then set the below to false. This should work, but is NOT supported and will</span></span><br><span class="line">    <span class="comment">-- increase downloads a lot.</span></span><br><span class="line">    filter = <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  pkg = &#123;</span><br><span class="line">    enabled = <span class="literal">true</span>,</span><br><span class="line">    cache = vim.fn.stdpath(<span class="string">&quot;state&quot;</span>) .. <span class="string">&quot;/lazy/pkg-cache.lua&quot;</span>,</span><br><span class="line">    versions = <span class="literal">true</span>, <span class="comment">-- Honor versions in pkg sources</span></span><br><span class="line">    <span class="comment">-- the first package source that is found for a plugin will be used.</span></span><br><span class="line">    sources = &#123;</span><br><span class="line">      <span class="string">&quot;lazy&quot;</span>,</span><br><span class="line">      <span class="string">&quot;rockspec&quot;</span>,</span><br><span class="line">      <span class="string">&quot;packspec&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  rocks = &#123;</span><br><span class="line">    root = vim.fn.stdpath(<span class="string">&quot;data&quot;</span>) .. <span class="string">&quot;/lazy-rocks&quot;</span>,</span><br><span class="line">    server = <span class="string">&quot;https://nvim-neorocks.github.io/rocks-binaries/&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  dev = &#123;</span><br><span class="line">    <span class="comment">---@type string | fun(plugin: LazyPlugin): string directory where you store your local plugin projects</span></span><br><span class="line">    <span class="built_in">path</span> = <span class="string">&quot;~/projects&quot;</span>,</span><br><span class="line">    <span class="comment">---@type string[] plugins that match these patterns will use your local versions instead of being fetched from GitHub</span></span><br><span class="line">    patterns = &#123;&#125;, <span class="comment">-- For example &#123;&quot;folke&quot;&#125;</span></span><br><span class="line">    fallback = <span class="literal">false</span>, <span class="comment">-- Fallback to git when local plugin doesn&#x27;t exist</span></span><br><span class="line">  &#125;,</span><br><span class="line">  install = &#123;</span><br><span class="line">    <span class="comment">-- install missing plugins on startup. This doesn&#x27;t increase startup time.</span></span><br><span class="line">    missing = <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">-- try to load one of these colorschemes when starting an installation during startup</span></span><br><span class="line">    colorscheme = &#123; <span class="string">&quot;habamax&quot;</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ui = &#123;</span><br><span class="line">    <span class="comment">-- a number &lt;1 is a percentage., &gt;1 is a fixed size</span></span><br><span class="line">    size = &#123; width = <span class="number">0.8</span>, height = <span class="number">0.8</span> &#125;,</span><br><span class="line">    <span class="built_in">wrap</span> = <span class="literal">true</span>, <span class="comment">-- wrap the lines in the ui</span></span><br><span class="line">    <span class="comment">-- The border to use for the UI window. Accepts same border values as |nvim_open_win()|.</span></span><br><span class="line">    border = <span class="string">&quot;none&quot;</span>,</span><br><span class="line">    <span class="comment">-- The backdrop opacity. 0 is fully opaque, 100 is fully transparent.</span></span><br><span class="line">    backdrop = <span class="number">60</span>,</span><br><span class="line">    title = <span class="literal">nil</span>, <span class="comment">---@type string only works when border is not &quot;none&quot;</span></span><br><span class="line">    title_pos = <span class="string">&quot;center&quot;</span>, <span class="comment">---@type &quot;center&quot; | &quot;left&quot; | &quot;right&quot;</span></span><br><span class="line">    <span class="comment">-- Show pills on top of the Lazy window</span></span><br><span class="line">    pills = <span class="literal">true</span>, <span class="comment">---@type boolean</span></span><br><span class="line">    icons = &#123;</span><br><span class="line">      cmd = <span class="string">&quot;î¯‡ &quot;</span>,</span><br><span class="line">      <span class="built_in">config</span> = <span class="string">&quot;ï€“&quot;</span>,</span><br><span class="line">      event = <span class="string">&quot;îª† &quot;</span>,</span><br><span class="line">      favorite = <span class="string">&quot;ï€… &quot;</span>,</span><br><span class="line">      ft = <span class="string">&quot;ï€– &quot;</span>,</span><br><span class="line">      init = <span class="string">&quot;ï€“ &quot;</span>,</span><br><span class="line">      import = <span class="string">&quot;î‰½ &quot;</span>,</span><br><span class="line">      keys = <span class="string">&quot;ï„œ &quot;</span>,</span><br><span class="line">      lazy = <span class="string">&quot;ó°’² &quot;</span>,</span><br><span class="line">      <span class="built_in">loaded</span> = <span class="string">&quot;â—&quot;</span>,</span><br><span class="line">      not_loaded = <span class="string">&quot;â—‹&quot;</span>,</span><br><span class="line">      plugin = <span class="string">&quot;ï’‡ &quot;</span>,</span><br><span class="line">      runtime = <span class="string">&quot;îŸ… &quot;</span>,</span><br><span class="line">      <span class="built_in">require</span> = <span class="string">&quot;ó°¢± &quot;</span>,</span><br><span class="line">      source = <span class="string">&quot;ï„¡ &quot;</span>,</span><br><span class="line">      start = <span class="string">&quot;î«“ &quot;</span>,</span><br><span class="line">      task = <span class="string">&quot;âœ” &quot;</span>,</span><br><span class="line">      list = &#123;</span><br><span class="line">        <span class="string">&quot;â—&quot;</span>,</span><br><span class="line">        <span class="string">&quot;âœ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;â˜…&quot;</span>,</span><br><span class="line">        <span class="string">&quot;â€’&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">-- leave nil, to automatically select a browser depending on your OS.</span></span><br><span class="line">    <span class="comment">-- If you want to use a specific browser, you can define it here</span></span><br><span class="line">    browser = <span class="literal">nil</span>, <span class="comment">---@type string?</span></span><br><span class="line">    throttle = <span class="number">20</span>, <span class="comment">-- how frequently should the ui process render events</span></span><br><span class="line">    custom_keys = &#123;</span><br><span class="line">      <span class="comment">-- You can define custom key maps here. If present, the description will</span></span><br><span class="line">      <span class="comment">-- be shown in the help menu.</span></span><br><span class="line">      <span class="comment">-- To disable one of the defaults, set it to false.</span></span><br><span class="line"></span><br><span class="line">      [<span class="string">&quot;&lt;localleader&gt;l&quot;</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(plugin)</span></span></span><br><span class="line">          <span class="built_in">require</span>(<span class="string">&quot;lazy.util&quot;</span>).float_term(&#123; <span class="string">&quot;lazygit&quot;</span>, <span class="string">&quot;log&quot;</span> &#125;, &#123;</span><br><span class="line">            cwd = plugin.dir,</span><br><span class="line">          &#125;)</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        desc = <span class="string">&quot;Open lazygit log&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [<span class="string">&quot;&lt;localleader&gt;t&quot;</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(plugin)</span></span></span><br><span class="line">          <span class="built_in">require</span>(<span class="string">&quot;lazy.util&quot;</span>).float_term(<span class="literal">nil</span>, &#123;</span><br><span class="line">            cwd = plugin.dir,</span><br><span class="line">          &#125;)</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        desc = <span class="string">&quot;Open terminal in plugin dir&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  diff = &#123;</span><br><span class="line">    <span class="comment">-- diff command &lt;d&gt; can be one of:</span></span><br><span class="line">    <span class="comment">-- * browser: opens the github compare view. Note that this is always mapped to &lt;K&gt; as well,</span></span><br><span class="line">    <span class="comment">--   so you can have a different command for diff &lt;d&gt;</span></span><br><span class="line">    <span class="comment">-- * git: will run git diff and open a buffer with filetype git</span></span><br><span class="line">    <span class="comment">-- * terminal_git: will open a pseudo terminal with git diff</span></span><br><span class="line">    <span class="comment">-- * diffview.nvim: will open Diffview to show the diff</span></span><br><span class="line">    cmd = <span class="string">&quot;git&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  checker = &#123;</span><br><span class="line">    <span class="comment">-- automatically check for plugin updates</span></span><br><span class="line">    enabled = <span class="literal">false</span>,</span><br><span class="line">    concurrency = <span class="literal">nil</span>, <span class="comment">---@type number? set to 1 to check for updates very slowly</span></span><br><span class="line">    notify = <span class="literal">true</span>, <span class="comment">-- get a notification when new updates are found</span></span><br><span class="line">    frequency = <span class="number">3600</span>, <span class="comment">-- check for updates every hour</span></span><br><span class="line">    check_pinned = <span class="literal">false</span>, <span class="comment">-- check for pinned packages that can&#x27;t be updated</span></span><br><span class="line">  &#125;,</span><br><span class="line">  change_detection = &#123;</span><br><span class="line">    <span class="comment">-- automatically check for config file changes and reload the ui</span></span><br><span class="line">    enabled = <span class="literal">true</span>,</span><br><span class="line">    notify = <span class="literal">true</span>, <span class="comment">-- get a notification when changes are found</span></span><br><span class="line">  &#125;,</span><br><span class="line">  performance = &#123;</span><br><span class="line">    cache = &#123;</span><br><span class="line">      enabled = <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    reset_packpath = <span class="literal">true</span>, <span class="comment">-- reset the package path to improve startup time</span></span><br><span class="line">    rtp = &#123;</span><br><span class="line">      reset = <span class="literal">true</span>, <span class="comment">-- reset the runtime path to $VIMRUNTIME and your config directory</span></span><br><span class="line">      <span class="comment">---@type string[]</span></span><br><span class="line">      paths = &#123;&#125;, <span class="comment">-- add any custom paths here that you want to includes in the rtp</span></span><br><span class="line">      <span class="comment">---@type string[] list any plugins you want to disable here</span></span><br><span class="line">      disabled_plugins = &#123;</span><br><span class="line">        <span class="comment">-- &quot;gzip&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;matchit&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;matchparen&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;netrwPlugin&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;tarPlugin&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;tohtml&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;tutor&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;zipPlugin&quot;,</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- lazy can generate helptags from the headings in markdown readme files,</span></span><br><span class="line">  <span class="comment">-- so :help works even for plugins that don&#x27;t have vim docs.</span></span><br><span class="line">  <span class="comment">-- when the readme opens with :help it will be correctly displayed as markdown</span></span><br><span class="line">  readme = &#123;</span><br><span class="line">    enabled = <span class="literal">true</span>,</span><br><span class="line">    root = vim.fn.stdpath(<span class="string">&quot;state&quot;</span>) .. <span class="string">&quot;/lazy/readme&quot;</span>,</span><br><span class="line">    files = &#123; <span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;lua/**/README.md&quot;</span> &#125;,</span><br><span class="line">    <span class="comment">-- only generate markdown helptags for plugins that dont have docs</span></span><br><span class="line">    skip_if_doc_exists = <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  state = vim.fn.stdpath(<span class="string">&quot;state&quot;</span>) .. <span class="string">&quot;/lazy/state.json&quot;</span>, <span class="comment">-- state info for checker and other things</span></span><br><span class="line">  <span class="comment">-- Enable profiling of lazy.nvim. This will add some overhead,</span></span><br><span class="line">  <span class="comment">-- so only enable this when you are debugging lazy.nvim</span></span><br><span class="line">  profiling = &#123;</span><br><span class="line">    <span class="comment">-- Enables extra stats on the debug tab related to the loader cache.</span></span><br><span class="line">    <span class="comment">-- Additionally gathers stats about all package.loaders</span></span><br><span class="line">    loader = <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">-- Track each new require in the Lazy profiling tab</span></span><br><span class="line">    <span class="built_in">require</span> = <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>options.lua</code>ä¸­é…ç½®äº†ä¸€äº›å…¨å±€å˜é‡ä»¥åŠvimè®¸å¤šå±æ€§.</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This file is automatically loaded by plugins.core</span></span><br><span class="line">vim.g.mapleader = <span class="string">&quot; &quot;</span></span><br><span class="line">vim.g.maplocalleader = <span class="string">&quot;\\&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LazyVim auto format</span></span><br><span class="line">vim.g.autoformat = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LazyVim picker to use.</span></span><br><span class="line"><span class="comment">-- Can be one of: telescope, fzf</span></span><br><span class="line"><span class="comment">-- Leave it to &quot;auto&quot; to automatically use the picker</span></span><br><span class="line"><span class="comment">-- enabled with `:LazyExtras`</span></span><br><span class="line">vim.g.lazyvim_picker = <span class="string">&quot;auto&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LazyVim root dir detection</span></span><br><span class="line"><span class="comment">-- Each entry can be:</span></span><br><span class="line"><span class="comment">-- * the name of a detector function like `lsp` or `cwd`</span></span><br><span class="line"><span class="comment">-- * a pattern or array of patterns like `.git` or `lua`.</span></span><br><span class="line"><span class="comment">-- * a function with signature `function(buf) -&gt; string|string[]`</span></span><br><span class="line">vim.g.root_spec = &#123; <span class="string">&quot;lsp&quot;</span>, &#123; <span class="string">&quot;.git&quot;</span>, <span class="string">&quot;lua&quot;</span> &#125;, <span class="string">&quot;cwd&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LazyVim automatically configures lazygit:</span></span><br><span class="line"><span class="comment">--  * theme, based on the active colorscheme.</span></span><br><span class="line"><span class="comment">--  * editorPreset to nvim-remote</span></span><br><span class="line"><span class="comment">--  * enables nerd font icons</span></span><br><span class="line"><span class="comment">-- Set to false to disable.</span></span><br><span class="line">vim.g.lazygit_config = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Options for the LazyVim statuscolumn</span></span><br><span class="line">vim.g.lazyvim_statuscolumn = &#123;</span><br><span class="line">  folds_open = <span class="literal">false</span>, <span class="comment">-- show fold sign when fold is open</span></span><br><span class="line">  folds_githl = <span class="literal">false</span>, <span class="comment">-- highlight fold sign with git sign color</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Optionally setup the terminal to use</span></span><br><span class="line"><span class="comment">-- This sets `vim.o.shell` and does some additional configuration for:</span></span><br><span class="line"><span class="comment">-- * pwsh</span></span><br><span class="line"><span class="comment">-- * powershell</span></span><br><span class="line"><span class="comment">-- LazyVim.terminal.setup(&quot;pwsh&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Hide deprecation warnings</span></span><br><span class="line">vim.g.deprecation_warnings = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Set filetype to `bigfile` for files larger than 1.5 MB</span></span><br><span class="line"><span class="comment">-- Only vim syntax will be enabled (with the correct filetype)</span></span><br><span class="line"><span class="comment">-- LSP, treesitter and other ft plugins will be disabled.</span></span><br><span class="line"><span class="comment">-- mini.animate will also be disabled.</span></span><br><span class="line">vim.g.bigfile_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1.5</span> <span class="comment">-- 1.5 MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Show the current document symbols location from Trouble in lualine</span></span><br><span class="line">vim.g.trouble_lualine = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> opt = vim.opt</span><br><span class="line"></span><br><span class="line">opt.autowrite = <span class="literal">true</span> <span class="comment">-- Enable auto write</span></span><br><span class="line"><span class="comment">-- only set clipboard if not in ssh, to make sure the OSC 52</span></span><br><span class="line"><span class="comment">-- integration works automatically. Requires Neovim &gt;= 0.10.0</span></span><br><span class="line">opt.clipboard = vim.env.SSH_TTY <span class="keyword">and</span> <span class="string">&quot;&quot;</span> <span class="keyword">or</span> <span class="string">&quot;unnamedplus&quot;</span> <span class="comment">-- Sync with system clipboard</span></span><br><span class="line">opt.completeopt = <span class="string">&quot;menu,menuone,noselect&quot;</span></span><br><span class="line">opt.conceallevel = <span class="number">2</span> <span class="comment">-- Hide * markup for bold and italic, but not markers with substitutions</span></span><br><span class="line">opt.confirm = <span class="literal">true</span> <span class="comment">-- Confirm to save changes before exiting modified buffer</span></span><br><span class="line">opt.cursorline = <span class="literal">true</span> <span class="comment">-- Enable highlighting of the current line</span></span><br><span class="line">opt.expandtab = <span class="literal">true</span> <span class="comment">-- Use spaces instead of tabs</span></span><br><span class="line">opt.fillchars = &#123;</span><br><span class="line">  foldopen = <span class="string">&quot;ï‘¼&quot;</span>,</span><br><span class="line">  foldclose = <span class="string">&quot;ï‘ &quot;</span>,</span><br><span class="line">  fold = <span class="string">&quot; &quot;</span>,</span><br><span class="line">  foldsep = <span class="string">&quot; &quot;</span>,</span><br><span class="line">  diff = <span class="string">&quot;â•±&quot;</span>,</span><br><span class="line">  eob = <span class="string">&quot; &quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">opt.foldlevel = <span class="number">99</span></span><br><span class="line">opt.formatexpr = <span class="string">&quot;v:lua.require&#x27;lazyvim.util&#x27;.format.formatexpr()&quot;</span></span><br><span class="line">opt.formatoptions = <span class="string">&quot;jcroqlnt&quot;</span> <span class="comment">-- tcqj</span></span><br><span class="line">opt.grepformat = <span class="string">&quot;%f:%l:%c:%m&quot;</span></span><br><span class="line">opt.grepprg = <span class="string">&quot;rg --vimgrep&quot;</span></span><br><span class="line">opt.ignorecase = <span class="literal">true</span> <span class="comment">-- Ignore case</span></span><br><span class="line">opt.inccommand = <span class="string">&quot;nosplit&quot;</span> <span class="comment">-- preview incremental substitute</span></span><br><span class="line">opt.jumpoptions = <span class="string">&quot;view&quot;</span></span><br><span class="line">opt.laststatus = <span class="number">3</span> <span class="comment">-- global statusline</span></span><br><span class="line">opt.linebreak = <span class="literal">true</span> <span class="comment">-- Wrap lines at convenient points</span></span><br><span class="line">opt.list = <span class="literal">true</span> <span class="comment">-- Show some invisible characters (tabs...</span></span><br><span class="line">opt.mouse = <span class="string">&quot;a&quot;</span> <span class="comment">-- Enable mouse mode</span></span><br><span class="line">opt.number = <span class="literal">true</span> <span class="comment">-- Print line number</span></span><br><span class="line">opt.pumblend = <span class="number">10</span> <span class="comment">-- Popup blend</span></span><br><span class="line">opt.pumheight = <span class="number">10</span> <span class="comment">-- Maximum number of entries in a popup</span></span><br><span class="line">opt.relativenumber = <span class="literal">true</span> <span class="comment">-- Relative line numbers</span></span><br><span class="line">opt.scrolloff = <span class="number">4</span> <span class="comment">-- Lines of context</span></span><br><span class="line">opt.sessionoptions = &#123; <span class="string">&quot;buffers&quot;</span>, <span class="string">&quot;curdir&quot;</span>, <span class="string">&quot;tabpages&quot;</span>, <span class="string">&quot;winsize&quot;</span>, <span class="string">&quot;help&quot;</span>, <span class="string">&quot;globals&quot;</span>, <span class="string">&quot;skiprtp&quot;</span>, <span class="string">&quot;folds&quot;</span> &#125;</span><br><span class="line">opt.shiftround = <span class="literal">true</span> <span class="comment">-- Round indent</span></span><br><span class="line">opt.shiftwidth = <span class="number">2</span> <span class="comment">-- Size of an indent</span></span><br><span class="line">opt.shortmess:append(&#123; W = <span class="literal">true</span>, I = <span class="literal">true</span>, c = <span class="literal">true</span>, C = <span class="literal">true</span> &#125;)</span><br><span class="line">opt.showmode = <span class="literal">false</span> <span class="comment">-- Dont show mode since we have a statusline</span></span><br><span class="line">opt.sidescrolloff = <span class="number">8</span> <span class="comment">-- Columns of context</span></span><br><span class="line">opt.signcolumn = <span class="string">&quot;yes&quot;</span> <span class="comment">-- Always show the signcolumn, otherwise it would shift the text each time</span></span><br><span class="line">opt.smartcase = <span class="literal">true</span> <span class="comment">-- Don&#x27;t ignore case with capitals</span></span><br><span class="line">opt.smartindent = <span class="literal">true</span> <span class="comment">-- Insert indents automatically</span></span><br><span class="line">opt.spelllang = &#123; <span class="string">&quot;en&quot;</span> &#125;</span><br><span class="line">opt.spelloptions:append(<span class="string">&quot;noplainbuffer&quot;</span>)</span><br><span class="line">opt.splitbelow = <span class="literal">true</span> <span class="comment">-- Put new windows below current</span></span><br><span class="line">opt.splitkeep = <span class="string">&quot;screen&quot;</span></span><br><span class="line">opt.splitright = <span class="literal">true</span> <span class="comment">-- Put new windows right of current</span></span><br><span class="line">opt.statuscolumn = <span class="string">[[%!v:lua.require&#x27;lazyvim.util&#x27;.ui.statuscolumn()]]</span></span><br><span class="line">opt.tabstop = <span class="number">2</span> <span class="comment">-- Number of spaces tabs count for</span></span><br><span class="line">opt.termguicolors = <span class="literal">true</span> <span class="comment">-- True color support</span></span><br><span class="line">opt.timeoutlen = vim.g.vscode <span class="keyword">and</span> <span class="number">1000</span> <span class="keyword">or</span> <span class="number">300</span> <span class="comment">-- Lower than default (1000) to quickly trigger which-key</span></span><br><span class="line">opt.undofile = <span class="literal">true</span></span><br><span class="line">opt.undolevels = <span class="number">10000</span></span><br><span class="line">opt.updatetime = <span class="number">200</span> <span class="comment">-- Save swap file and trigger CursorHold</span></span><br><span class="line">opt.virtualedit = <span class="string">&quot;block&quot;</span> <span class="comment">-- Allow cursor to move where there is no text in visual block mode</span></span><br><span class="line">opt.wildmode = <span class="string">&quot;longest:full,full&quot;</span> <span class="comment">-- Command-line completion mode</span></span><br><span class="line">opt.winminwidth = <span class="number">5</span> <span class="comment">-- Minimum window width</span></span><br><span class="line">opt.<span class="built_in">wrap</span> = <span class="literal">false</span> <span class="comment">-- Disable line wrap</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> vim.fn.has(<span class="string">&quot;nvim-0.10&quot;</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">  opt.smoothscroll = <span class="literal">true</span></span><br><span class="line">  opt.foldexpr = <span class="string">&quot;v:lua.require&#x27;lazyvim.util&#x27;.ui.foldexpr()&quot;</span></span><br><span class="line">  opt.foldmethod = <span class="string">&quot;expr&quot;</span></span><br><span class="line">  opt.foldtext = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  opt.foldmethod = <span class="string">&quot;indent&quot;</span></span><br><span class="line">  opt.foldtext = <span class="string">&quot;v:lua.require&#x27;lazyvim.util&#x27;.ui.foldtext()&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Fix markdown indentation settings</span></span><br><span class="line">vim.g.markdown_recommended_style = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰çš„ä¸€äº›keymapå¦‚ä¸‹</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This file is automatically loaded by lazyvim.config.init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- DO NOT USE `LazyVim.safe_keymap_set` IN YOUR OWN CONFIG!!</span></span><br><span class="line"><span class="comment">-- use `vim.keymap.set` instead</span></span><br><span class="line"><span class="keyword">local</span> map = LazyVim.safe_keymap_set</span><br><span class="line"></span><br><span class="line"><span class="comment">-- better up/down</span></span><br><span class="line">map(&#123; <span class="string">&quot;n&quot;</span>, <span class="string">&quot;x&quot;</span> &#125;, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;v:count == 0 ? &#x27;gj&#x27; : &#x27;j&#x27;&quot;</span>, &#123; desc = <span class="string">&quot;Down&quot;</span>, expr = <span class="literal">true</span>, silent = <span class="literal">true</span> &#125;)</span><br><span class="line">map(&#123; <span class="string">&quot;n&quot;</span>, <span class="string">&quot;x&quot;</span> &#125;, <span class="string">&quot;&lt;Down&gt;&quot;</span>, <span class="string">&quot;v:count == 0 ? &#x27;gj&#x27; : &#x27;j&#x27;&quot;</span>, &#123; desc = <span class="string">&quot;Down&quot;</span>, expr = <span class="literal">true</span>, silent = <span class="literal">true</span> &#125;)</span><br><span class="line">map(&#123; <span class="string">&quot;n&quot;</span>, <span class="string">&quot;x&quot;</span> &#125;, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;v:count == 0 ? &#x27;gk&#x27; : &#x27;k&#x27;&quot;</span>, &#123; desc = <span class="string">&quot;Up&quot;</span>, expr = <span class="literal">true</span>, silent = <span class="literal">true</span> &#125;)</span><br><span class="line">map(&#123; <span class="string">&quot;n&quot;</span>, <span class="string">&quot;x&quot;</span> &#125;, <span class="string">&quot;&lt;Up&gt;&quot;</span>, <span class="string">&quot;v:count == 0 ? &#x27;gk&#x27; : &#x27;k&#x27;&quot;</span>, &#123; desc = <span class="string">&quot;Up&quot;</span>, expr = <span class="literal">true</span>, silent = <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Move to window using the &lt;ctrl&gt; hjkl keys</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-h&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;h&quot;</span>, &#123; desc = <span class="string">&quot;Go to Left Window&quot;</span>, remap = <span class="literal">true</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-j&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;j&quot;</span>, &#123; desc = <span class="string">&quot;Go to Lower Window&quot;</span>, remap = <span class="literal">true</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-k&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;k&quot;</span>, &#123; desc = <span class="string">&quot;Go to Upper Window&quot;</span>, remap = <span class="literal">true</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-l&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;l&quot;</span>, &#123; desc = <span class="string">&quot;Go to Right Window&quot;</span>, remap = <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Resize window using &lt;ctrl&gt; arrow keys</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Up&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;resize +2&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Increase Window Height&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Down&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;resize -2&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Decrease Window Height&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Left&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;vertical resize -2&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Decrease Window Width&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Right&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;vertical resize +2&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Increase Window Width&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Move Lines</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-j&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;m .+1&lt;cr&gt;==&quot;</span>, &#123; desc = <span class="string">&quot;Move Down&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-k&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;m .-2&lt;cr&gt;==&quot;</span>, &#123; desc = <span class="string">&quot;Move Up&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;&lt;A-j&gt;&quot;</span>, <span class="string">&quot;&lt;esc&gt;&lt;cmd&gt;m .+1&lt;cr&gt;==gi&quot;</span>, &#123; desc = <span class="string">&quot;Move Down&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;&lt;A-k&gt;&quot;</span>, <span class="string">&quot;&lt;esc&gt;&lt;cmd&gt;m .-2&lt;cr&gt;==gi&quot;</span>, &#123; desc = <span class="string">&quot;Move Up&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;&lt;A-j&gt;&quot;</span>, <span class="string">&quot;:m &#x27;&gt;+1&lt;cr&gt;gv=gv&quot;</span>, &#123; desc = <span class="string">&quot;Move Down&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;&lt;A-k&gt;&quot;</span>, <span class="string">&quot;:m &#x27;&lt;-2&lt;cr&gt;gv=gv&quot;</span>, &#123; desc = <span class="string">&quot;Move Up&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- buffers</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;S-h&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;bprevious&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Prev Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;S-l&gt;&quot;</span>, <span class="string">&quot;&lt;cmd&gt;bnext&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Next Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;[b&quot;</span>, <span class="string">&quot;&lt;cmd&gt;bprevious&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Prev Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;]b&quot;</span>, <span class="string">&quot;&lt;cmd&gt;bnext&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Next Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bb&quot;</span>, <span class="string">&quot;&lt;cmd&gt;e #&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Switch to Other Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;`&quot;</span>, <span class="string">&quot;&lt;cmd&gt;e #&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Switch to Other Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bd&quot;</span>, LazyVim.ui.bufremove, &#123; desc = <span class="string">&quot;Delete Buffer&quot;</span> &#125;)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bD&quot;</span>, <span class="string">&quot;&lt;cmd&gt;:bd&lt;cr&gt;&quot;</span>, &#123; desc = <span class="string">&quot;Delete Buffer and Window&quot;</span> &#125;)</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p><code>autocmd.lua</code>å¦‚ä¸‹</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This file is automatically loaded by lazyvim.config.init.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">augroup</span><span class="params">(name)</span></span></span><br><span class="line">  <span class="keyword">return</span> vim.api.nvim_create_augroup(<span class="string">&quot;lazyvim_&quot;</span> .. name, &#123; clear = <span class="literal">true</span> &#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check if we need to reload the file when it changed</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;FocusGained&quot;</span>, <span class="string">&quot;TermClose&quot;</span>, <span class="string">&quot;TermLeave&quot;</span> &#125;, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;checktime&quot;</span>),</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> vim.o.buftype ~= <span class="string">&quot;nofile&quot;</span> <span class="keyword">then</span></span><br><span class="line">      vim.cmd(<span class="string">&quot;checktime&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Highlight on yank</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;TextYankPost&quot;</span>, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;highlight_yank&quot;</span>),</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    vim.highlight.on_yank()</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- resize splits if window got resized</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;VimResized&quot;</span> &#125;, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;resize_splits&quot;</span>),</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> current_tab = vim.fn.tabpagenr()</span><br><span class="line">    vim.cmd(<span class="string">&quot;tabdo wincmd =&quot;</span>)</span><br><span class="line">    vim.cmd(<span class="string">&quot;tabnext &quot;</span> .. current_tab)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- go to last loc when opening a buffer</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;BufReadPost&quot;</span>, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;last_loc&quot;</span>),</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span></span><br><span class="line">    <span class="keyword">local</span> exclude = &#123; <span class="string">&quot;gitcommit&quot;</span> &#125;</span><br><span class="line">    <span class="keyword">local</span> buf = event.buf</span><br><span class="line">    <span class="keyword">if</span> vim.tbl_contains(exclude, vim.bo[buf].filetype) <span class="keyword">or</span> vim.b[buf].lazyvim_last_loc <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    vim.b[buf].lazyvim_last_loc = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">local</span> mark = vim.api.nvim_buf_get_mark(buf, <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">    <span class="keyword">local</span> lcount = vim.api.nvim_buf_line_count(buf)</span><br><span class="line">    <span class="keyword">if</span> mark[<span class="number">1</span>] &gt; <span class="number">0</span> <span class="keyword">and</span> mark[<span class="number">1</span>] &lt;= lcount <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">pcall</span>(vim.api.nvim_win_set_cursor, <span class="number">0</span>, mark)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- close some filetypes with &lt;q&gt;</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;FileType&quot;</span>, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;close_with_q&quot;</span>),</span><br><span class="line">  pattern = &#123;</span><br><span class="line">    <span class="string">&quot;PlenaryTestPopup&quot;</span>,</span><br><span class="line">    <span class="string">&quot;help&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lspinfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;notify&quot;</span>,</span><br><span class="line">    <span class="string">&quot;qf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;spectre_panel&quot;</span>,</span><br><span class="line">    <span class="string">&quot;startuptime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tsplayground&quot;</span>,</span><br><span class="line">    <span class="string">&quot;neotest-output&quot;</span>,</span><br><span class="line">    <span class="string">&quot;checkhealth&quot;</span>,</span><br><span class="line">    <span class="string">&quot;neotest-summary&quot;</span>,</span><br><span class="line">    <span class="string">&quot;neotest-output-panel&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dbout&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gitsigns.blame&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span></span><br><span class="line">    vim.bo[event.buf].buflisted = <span class="literal">false</span></span><br><span class="line">    vim.keymap.set(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;&lt;cmd&gt;close&lt;cr&gt;&quot;</span>, &#123; buffer = event.buf, silent = <span class="literal">true</span> &#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- make it easier to close man-files when opened inline</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;FileType&quot;</span>, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;man_unlisted&quot;</span>),</span><br><span class="line">  pattern = &#123; <span class="string">&quot;man&quot;</span> &#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span></span><br><span class="line">    vim.bo[event.buf].buflisted = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- wrap and check for spell in text filetypes</span></span><br><span class="line">vim.api.nvim_create_autocmd(<span class="string">&quot;FileType&quot;</span>, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;wrap_spell&quot;</span>),</span><br><span class="line">  pattern = &#123; <span class="string">&quot;*.txt&quot;</span>, <span class="string">&quot;*.tex&quot;</span>, <span class="string">&quot;*.typ&quot;</span>, <span class="string">&quot;gitcommit&quot;</span>, <span class="string">&quot;markdown&quot;</span> &#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    vim.opt_local.<span class="built_in">wrap</span> = <span class="literal">true</span></span><br><span class="line">    vim.opt_local.spell = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Fix conceallevel for json files</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;FileType&quot;</span> &#125;, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;json_conceal&quot;</span>),</span><br><span class="line">  pattern = &#123; <span class="string">&quot;json&quot;</span>, <span class="string">&quot;jsonc&quot;</span>, <span class="string">&quot;json5&quot;</span> &#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    vim.opt_local.conceallevel = <span class="number">0</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Auto create dir when saving a file, in case some intermediate directory does not exist</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;BufWritePre&quot;</span> &#125;, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;auto_create_dir&quot;</span>),</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span></span><br><span class="line">    <span class="keyword">if</span> event.<span class="built_in">match</span>:<span class="built_in">match</span>(<span class="string">&quot;^%w%w+:[\\/][\\/]&quot;</span>) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> file = vim.uv.fs_realpath(event.<span class="built_in">match</span>) <span class="keyword">or</span> event.<span class="built_in">match</span></span><br><span class="line">    vim.fn.mkdir(vim.fn.fnamemodify(file, <span class="string">&quot;:p:h&quot;</span>), <span class="string">&quot;p&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vim.filetype.add(&#123;</span><br><span class="line">  pattern = &#123;</span><br><span class="line">    [<span class="string">&quot;.*&quot;</span>] = &#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span><span class="params">(path, buf)</span></span></span><br><span class="line">        <span class="keyword">return</span> vim.bo[buf]</span><br><span class="line">            <span class="keyword">and</span> vim.bo[buf].filetype ~= <span class="string">&quot;bigfile&quot;</span></span><br><span class="line">            <span class="keyword">and</span> <span class="built_in">path</span></span><br><span class="line">            <span class="keyword">and</span> vim.fn.getfsize(<span class="built_in">path</span>) &gt; vim.g.bigfile_size</span><br><span class="line">            <span class="keyword">and</span> <span class="string">&quot;bigfile&quot;</span></span><br><span class="line">          <span class="keyword">or</span> <span class="literal">nil</span></span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;FileType&quot;</span> &#125;, &#123;</span><br><span class="line">  group = augroup(<span class="string">&quot;bigfile&quot;</span>),</span><br><span class="line">  pattern = <span class="string">&quot;bigfile&quot;</span>,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">(ev)</span></span></span><br><span class="line">    vim.b.minianimate_disable = <span class="literal">true</span></span><br><span class="line">    vim.schedule(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      vim.bo[ev.buf].syntax = vim.filetype.<span class="built_in">match</span>(&#123; buf = ev.buf &#125;) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="å¦‚ä½•é…ç½®Lazyvim"><a href="#å¦‚ä½•é…ç½®Lazyvim" class="headerlink" title="å¦‚ä½•é…ç½®Lazyvim"></a>å¦‚ä½•é…ç½®Lazyvim</h5><p>lazyvimçš„å®˜æ–¹å»ºè®®:</p><ol><li>æ–‡ä»¶ç»“æ„å¦‚ä¸‹,å¯ä»¥åœ¨pluginsæ–‡ä»¶å¤¹ä¸­è®¾ç½®</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/.config/nvim</span><br><span class="line">â”œâ”€â”€ <span class="keyword">lua</span></span><br><span class="line">â”‚   â”œâ”€â”€ config</span><br><span class="line">â”‚   â”‚   â””â”€â”€ lazy.<span class="keyword">lua</span></span><br><span class="line">â”‚   â””â”€â”€ plugins</span><br><span class="line">â”‚       â”œâ”€â”€ spec1.<span class="keyword">lua</span></span><br><span class="line">â”‚       â”œâ”€â”€ **</span><br><span class="line">â”‚       â””â”€â”€ spec2.<span class="keyword">lua</span></span><br><span class="line">â””â”€â”€ init.<span class="keyword">lua</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„<code>lazy.lua</code>å¤§æ¦‚é•¿ä¸‹é¢è¿™æ ·,é€šè¿‡lazy.luaä¿®æ”¹ä¸€äº›ç®€å•é…ç½®</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> lazypath = vim.fn.stdpath(<span class="string">&quot;data&quot;</span>) .. <span class="string">&quot;/lazy/lazy.nvim&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> (vim.uv <span class="keyword">or</span> vim.loop).fs_stat(lazypath) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">local</span> lazyrepo = <span class="string">&quot;https://github.com/folke/lazy.nvim.git&quot;</span></span><br><span class="line">  <span class="keyword">local</span> out = vim.fn.system(&#123; <span class="string">&quot;git&quot;</span>, <span class="string">&quot;clone&quot;</span>, <span class="string">&quot;--filter=blob:none&quot;</span>, <span class="string">&quot;--branch=stable&quot;</span>, lazyrepo, lazypath &#125;)</span><br><span class="line">  <span class="keyword">if</span> vim.v.shell_error ~= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    vim.api.nvim_echo(&#123;</span><br><span class="line">      &#123; <span class="string">&quot;Failed to clone lazy.nvim:\n&quot;</span>, <span class="string">&quot;ErrorMsg&quot;</span> &#125;,</span><br><span class="line">      &#123; out, <span class="string">&quot;WarningMsg&quot;</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;\nPress any key to exit...&quot;</span> &#125;,</span><br><span class="line">    &#125;, <span class="literal">true</span>, &#123;&#125;)</span><br><span class="line">    vim.fn.getchar()</span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">exit</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">vim.opt.rtp:prepend(lazypath)</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lazy&quot;</span>).setup(&#123;</span><br><span class="line">  spec = &#123;</span><br><span class="line">    <span class="comment">-- add LazyVim and import its plugins</span></span><br><span class="line">    &#123; <span class="string">&quot;LazyVim/LazyVim&quot;</span>, import = <span class="string">&quot;lazyvim.plugins&quot;</span> &#125;,</span><br><span class="line">    <span class="comment">-- import/override with your plugins</span></span><br><span class="line">    &#123; import = <span class="string">&quot;plugins&quot;</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  defaults = &#123;</span><br><span class="line">    <span class="comment">-- By default, only LazyVim plugins will be lazy-loaded. Your custom plugins will load during startup.</span></span><br><span class="line">    <span class="comment">-- If you know what you&#x27;re doing, you can set this to `true` to have all your custom plugins lazy-loaded by default.</span></span><br><span class="line">    lazy = <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">-- It&#x27;s recommended to leave version=false for now, since a lot the plugin that support versioning,</span></span><br><span class="line">    <span class="comment">-- have outdated releases, which may break your Neovim install.</span></span><br><span class="line">    version = <span class="literal">false</span>, <span class="comment">-- always use the latest git commit</span></span><br><span class="line">    <span class="comment">-- version = &quot;*&quot;, -- try installing the latest stable version for plugins that support semver</span></span><br><span class="line">  &#125;,</span><br><span class="line">  install = &#123; colorscheme = &#123; <span class="string">&quot;tokyonight&quot;</span>, <span class="string">&quot;habamax&quot;</span> &#125; &#125;,</span><br><span class="line">  checker = &#123; enabled = <span class="literal">true</span> &#125;, <span class="comment">-- automatically check for plugin updates</span></span><br><span class="line">  performance = &#123;</span><br><span class="line">    rtp = &#123;</span><br><span class="line">      <span class="comment">-- disable some rtp plugins</span></span><br><span class="line">      disabled_plugins = &#123;</span><br><span class="line">        <span class="string">&quot;gzip&quot;</span>,</span><br><span class="line">        <span class="comment">-- &quot;matchit&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;matchparen&quot;,</span></span><br><span class="line">        <span class="comment">-- &quot;netrwPlugin&quot;,</span></span><br><span class="line">        <span class="string">&quot;tarPlugin&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tohtml&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tutor&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zipPlugin&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="pugin-spec"><a href="#pugin-spec" class="headerlink" title="pugin spec"></a>pugin spec</h5><p>å¯ä»¥è¿™æ ·ä¿®æ”¹æ’ä»¶çš„ä¸€äº›é€‰é¡¹<a href="https://lazy.folke.io/spec">ğŸ”Œ Plugin Spec | lazy.nvim (folke.io)</a></p><p>æ­¤å¤–é€šè¿‡plugin specä¸‹è½½æˆ–è€…æ›´æ”¹æ’ä»¶çš„é…ç½®</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="comment">-- the colorscheme should be available when starting Neovim</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;folke/tokyonight.nvim&quot;</span>,</span><br><span class="line">    lazy = <span class="literal">false</span>, <span class="comment">-- make sure we load this during startup if it is your main colorscheme</span></span><br><span class="line">    priority = <span class="number">1000</span>, <span class="comment">-- make sure to load this before all the other start plugins</span></span><br><span class="line">    <span class="built_in">config</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      <span class="comment">-- load the colorscheme here</span></span><br><span class="line">      vim.cmd(<span class="string">[[colorscheme tokyonight]]</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- I have a separate config.mappings file where I require which-key.</span></span><br><span class="line">  <span class="comment">-- With lazy the plugin will be automatically loaded when it is required somewhere</span></span><br><span class="line">  &#123; <span class="string">&quot;folke/which-key.nvim&quot;</span>, lazy = <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;nvim-neorg/neorg&quot;</span>,</span><br><span class="line">    <span class="comment">-- lazy-load on filetype</span></span><br><span class="line">    ft = <span class="string">&quot;norg&quot;</span>,</span><br><span class="line">    <span class="comment">-- options for neorg. This will automatically call `require(&quot;neorg&quot;).setup(opts)`</span></span><br><span class="line">    opts = &#123;</span><br><span class="line">      <span class="built_in">load</span> = &#123;</span><br><span class="line">        [<span class="string">&quot;core.defaults&quot;</span>] = &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;dstein64/vim-startuptime&quot;</span>,</span><br><span class="line">    <span class="comment">-- lazy-load on a command</span></span><br><span class="line">    cmd = <span class="string">&quot;StartupTime&quot;</span>,</span><br><span class="line">    <span class="comment">-- init is called during startup. Configuration for vim plugins typically should be set in an init function</span></span><br><span class="line">    init = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      vim.g.startuptime_tries = <span class="number">10</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;hrsh7th/nvim-cmp&quot;</span>,</span><br><span class="line">    <span class="comment">-- load cmp on InsertEnter</span></span><br><span class="line">    event = <span class="string">&quot;InsertEnter&quot;</span>,</span><br><span class="line">    <span class="comment">-- these dependencies will only be loaded when cmp loads</span></span><br><span class="line">    <span class="comment">-- dependencies are always lazy-loaded unless specified otherwise</span></span><br><span class="line">    dependencies = &#123;</span><br><span class="line">      <span class="string">&quot;hrsh7th/cmp-nvim-lsp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;hrsh7th/cmp-buffer&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">config</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      <span class="comment">-- ...</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- if some code requires a module from an unloaded plugin, it will be automatically loaded.</span></span><br><span class="line">  <span class="comment">-- So for api plugins like devicons, we can always set lazy=true</span></span><br><span class="line">  &#123; <span class="string">&quot;nvim-tree/nvim-web-devicons&quot;</span>, lazy = <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- you can use the VeryLazy event for things that can</span></span><br><span class="line">  <span class="comment">-- load later and are not important for the initial UI</span></span><br><span class="line">  &#123; <span class="string">&quot;stevearc/dressing.nvim&quot;</span>, event = <span class="string">&quot;VeryLazy&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;Wansmer/treesj&quot;</span>,</span><br><span class="line">    keys = &#123;</span><br><span class="line">      &#123; <span class="string">&quot;J&quot;</span>, <span class="string">&quot;&lt;cmd&gt;TSJToggle&lt;cr&gt;&quot;</span>, desc = <span class="string">&quot;Join Toggle&quot;</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    opts = &#123; use_default_keymaps = <span class="literal">false</span>, max_join_length = <span class="number">150</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;monaqa/dial.nvim&quot;</span>,</span><br><span class="line">    <span class="comment">-- lazy-load on keys</span></span><br><span class="line">    <span class="comment">-- mode is `n` by default. For more advanced options, check the section on key mappings</span></span><br><span class="line">    keys = &#123; <span class="string">&quot;&lt;C-a&gt;&quot;</span>, &#123; <span class="string">&quot;&lt;C-x&gt;&quot;</span>, mode = <span class="string">&quot;n&quot;</span> &#125; &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- local plugins need to be explicitly configured with dir</span></span><br><span class="line">  &#123; dir = <span class="string">&quot;~/projects/secret.nvim&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- you can use a custom url to fetch a plugin</span></span><br><span class="line">  &#123; url = <span class="string">&quot;git@github.com:folke/noice.nvim.git&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- local plugins can also be configured with the dev option.</span></span><br><span class="line">  <span class="comment">-- This will use &#123;config.dev.path&#125;/noice.nvim/ instead of fetching it from GitHub</span></span><br><span class="line">  <span class="comment">-- With the dev option, you can easily switch between the local and installed version of a plugin</span></span><br><span class="line">  &#123; <span class="string">&quot;folke/noice.nvim&quot;</span>, dev = <span class="literal">true</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>Property</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><strong>[1]</strong></td><td><code>string?</code></td><td>Short plugin url. Will be expanded using <a href="https://lazy.folke.io/configuration"><code>config.git.url_format</code></a>. Can also be a <code>url</code> or <code>dir</code>.</td></tr><tr><td><strong>dependencies</strong></td><td><code>LazySpec[]</code></td><td>A list of plugin names or plugin specs that should be loaded when the plugin loads. Dependencies are always lazy-loaded unless specified otherwise. When specifying a name, make sure the plugin spec has been defined somewhere else.</td></tr><tr><td><strong>enabled</strong></td><td><code>boolean?</code> or <code>fun():boolean</code></td><td>When <code>false</code>, or if the <code>function</code> returns false, then this plugin will not be included in the spec</td></tr><tr><td><strong>cond</strong></td><td><code>boolean?</code> or <code>fun(LazyPlugin):boolean</code></td><td>Behaves the same as <code>enabled</code>, but wonâ€™t uninstall the plugin when the condition is <code>false</code>. Useful to disable some plugins in vscode, or firenvim for example.</td></tr><tr><td><strong>priority</strong></td><td><code>number?</code></td><td>Only useful for <strong>start</strong> plugins (<code>lazy=false</code>) to force loading certain plugins first. Default priority is <code>50</code>. Itâ€™s recommended to set this to a high number for colorschemes</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th><strong>init</strong></th><th><code>fun(LazyPlugin)</code></th><th><code>init</code> functions are always executed during. Mostly useful for setting <code>vim.g.*</code> configuration used by <strong>Vim</strong> plugins startup</th></tr></thead><tbody><tr><td><strong>opts</strong></td><td><code>table</code> or <code>fun(LazyPlugin, opts:table)</code></td><td><code>opts</code> should be a table (will be merged with parent specs), return a table (replaces parent specs) or should change a table. The table will be passed to the <code>Plugin.config()</code> function. Setting this value will imply <code>Plugin.config()</code></td></tr><tr><td><strong>config</strong></td><td><code>fun(LazyPlugin, opts:table)</code> or <code>true</code></td><td><code>config</code> is executed when the plugin loads. The default implementation will automatically run <code>require(MAIN).setup(opts)</code> if <code>opts</code> or <code>config = true</code> is set. Lazy uses several heuristics to determine the pluginâ€™s <code>MAIN</code> module automatically based on the pluginâ€™s <strong>name</strong>. <em>(<code>opts</code> is the recommended way to configure plugins)</em>.</td></tr><tr><td><strong>main</strong></td><td><code>string?</code></td><td>You can specify the <code>main</code> module to use for <code>config()</code> and <code>opts()</code>, in case it can not be determined automatically. See <code>config()</code></td></tr><tr><td><strong>build</strong></td><td><code>fun(LazyPlugin)</code> or <code>string</code> or <code>false</code> or a list of build commands</td><td><code>build</code> is executed when a plugin is installed or updated. See <a href="https://lazy.folke.io/developers#building">Building</a> for more information.</td></tr></tbody></table></div><h5 id="æ·»åŠ æ’ä»¶"><a href="#æ·»åŠ æ’ä»¶" class="headerlink" title="æ·»åŠ æ’ä»¶"></a>æ·»åŠ æ’ä»¶</h5><p>æ·»åŠ æ’ä»¶éå¸¸ç®€å•ï¼Œåªéœ€å°†æ’ä»¶è§„æ ¼æ·»åŠ åˆ° lua/plugins/*.lua ä¸‹çš„æŸä¸ªæ–‡ä»¶ä¸­å³å¯ã€‚å¯ä»¥åœ¨å…¶ä¸­åˆ›å»ºä»»æ„æ•°é‡çš„æ–‡ä»¶ã€‚å…è®¸ç¼“å­˜æ‰€æœ‰æ’ä»¶specã€‚<br>è§„æ ¼æ›´æ”¹æ›´æ–°æ—¶å°†è‡ªåŠ¨é‡æ–°åŠ è½½ï¼Œå› æ­¤ :Lazy UI å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚</p><p>å¯ä»¥åœ¨ lua/plugins æ–‡ä»¶å¤¹ä¸­ä¸ºæ¯ä¸ªæ’ä»¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶,ä¹Ÿå¯ä»¥ä¸ºæŸäº›åŠŸèƒ½åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ’ä»¶è§„æ ¼çš„ç‹¬ç«‹æ–‡ä»¶.</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="comment">-- add symbols-outline</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;simrat39/symbols-outline.nvim&quot;</span>,</span><br><span class="line">    cmd = <span class="string">&quot;SymbolsOutline&quot;</span>, # æ ¹æ®å‘½ä»¤è¿›è¡Œæ‡’æƒ°åŠ è½½</span><br><span class="line">    keys = &#123; &#123; <span class="string">&quot;&lt;leader&gt;cs&quot;</span>, <span class="string">&quot;&lt;cmd&gt;SymbolsOutline&lt;cr&gt;&quot;</span>, desc = <span class="string">&quot;Symbols Outline&quot;</span> &#125; &#125;, #Lazy-<span class="built_in">load</span> on key mapping</span><br><span class="line">    opts = &#123;</span><br><span class="line">      <span class="comment">-- add your options that should be passed to the setup() function here</span></span><br><span class="line">      position = <span class="string">&quot;right&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‡’åŠ è½½è§„åˆ™</strong></p><p>lazy.nvim å¯è‡ªåŠ¨æ‡’åŠ è½½ Lua æ¨¡å—. è¿™æ„å‘³ç€,å¦‚æœä½ æœ‰ä¸€ä¸ªæ‡’åŠ è½½çš„æ’ä»¶ A å’Œä¸€ä¸ªéœ€è¦æ’ä»¶ A çš„æ¨¡å—çš„æ’ä»¶ B,é‚£ä¹ˆæ’ä»¶ A å°†æŒ‰ç…§é¢„æœŸæŒ‰éœ€åŠ è½½ã€‚</p><p>æ­¤å¤–,è¿˜å¯ä»¥å¯¹äº‹ä»¶(events)ã€å‘½ä»¤(cmd)ã€æ–‡ä»¶ç±»å‹(filetype)å’ŒæŒ‰é”®æ˜ å°„(key mappings)è¿›è¡Œæ‡’åŠ è½½.</p><p>å½“ä»¥ä¸‹æƒ…å†µä¹‹ä¸€ä¸ºçœŸæ—¶ï¼Œæ’ä»¶å°†è¢«æ‡’åŠ è½½ï¼š</p><ul><li>è¯¥æ’ä»¶ä»…ä½œä¸ºä¾èµ–é¡¹(dependency)å­˜åœ¨äºplugin specä¸­</li><li>å®ƒæœ‰ä¸€ä¸ªäº‹ä»¶ã€cmdã€ft æˆ–keyså…³é”®å­—</li><li>config.defaults.lazy == true</li></ul><p><strong>è‡ªå®šä¹‰Plugin Specs</strong></p><p>é»˜è®¤åˆå¹¶è§„åˆ™ï¼š</p><p>cmdï¼šå°†ä½¿ç”¨è‡ªå®šä¹‰å‘½ä»¤æ‰©å±•å‘½ä»¤åˆ—è¡¨<br>eventï¼šäº‹ä»¶åˆ—è¡¨ï¼Œå°†ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶è¿›è¡Œæ‰©å±•<br>ftï¼šæ–‡ä»¶ç±»å‹åˆ—è¡¨å°†ä½¿ç”¨è‡ªå®šä¹‰æ–‡ä»¶ç±»å‹è¿›è¡Œæ‰©å±•<br>keysï¼šé”®æ˜ å°„åˆ—è¡¨ï¼Œå°†ä½¿ç”¨è‡ªå®šä¹‰é”®æ˜ å°„è¿›è¡Œæ‰©å±•<br>optsï¼šè‡ªå®šä¹‰é€‰é¡¹å°†ä¸é»˜è®¤é€‰é¡¹åˆå¹¶<br>dependenciesï¼šä¾èµ–é¡¹åˆ—è¡¨å°†ä½¿ç”¨è‡ªå®šä¹‰ä¾èµ–é¡¹è¿›è¡Œæ‰©å±•<br>ä»»ä½•å…¶ä»–å±æ€§éƒ½å°†<strong>è¦†ç›–</strong>é»˜è®¤å€¼,æ¯”å¦‚spec</p><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœlazyvimä¸­æœ‰äº†ä½ æƒ³ä¸‹è½½çš„æ’ä»¶,ä½ å¯é€šè¿‡åœ¨pluginsç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªluaæ–‡ä»¶ä¿®æ”¹,å¦‚æœä½ æƒ³æ·»åŠ ä¸€ä¸ªæ²¡æœ‰çš„æ’ä»¶,æ“ä½œæ˜¯ä¸€æ ·çš„,æ— éæ˜¯å°‘äº†ä¸€äº›é»˜è®¤çš„é…ç½®<strong>.</strong></p><blockquote><p>åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå§‹ç»ˆä½¿ç”¨ opts è€Œä¸æ˜¯ configã€‚</p></blockquote><p><strong>å¢åŠ æˆ–è€…ç¦ç”¨æ’ä»¶keymap</strong></p><p>æ·»åŠ  keys= çš„è§„åˆ™ã€‚</p><p>ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®é»˜è®¤ keymap ä¸º false æ¥ç¦ç”¨.è¦è¦†ç›–ä¸€ä¸ªå…³é”®æ˜ å°„,åªéœ€æ·»åŠ ä¸€ä¸ªå…·æœ‰ç›¸åŒ lhs å’Œæ–° rhs çš„å…³é”®æ˜ å°„(ä¹Ÿå°±æ˜¯æŒ‰é”®ç›¸åŒ,æ“ä½œä¸åŒ)</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="string">&quot;nvim-telescope/telescope.nvim&quot;</span>,</span><br><span class="line">  keys = &#123;</span><br><span class="line">    <span class="comment">-- disable the keymap to grep files</span></span><br><span class="line">    &#123;<span class="string">&quot;&lt;leader&gt;/&quot;</span>, <span class="literal">false</span>&#125;,</span><br><span class="line">    <span class="comment">-- change a keymap</span></span><br><span class="line">    &#123; <span class="string">&quot;&lt;leader&gt;ff&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Telescope find_files&lt;cr&gt;&quot;</span>, desc = <span class="string">&quot;Find Files&quot;</span> &#125;,</span><br><span class="line">    <span class="comment">-- add a keymap to browse plugin files</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;&lt;leader&gt;fp&quot;</span>,</span><br><span class="line">      <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">require</span>(<span class="string">&quot;telescope.builtin&quot;</span>).find_files(&#123; cwd = <span class="built_in">require</span>(<span class="string">&quot;lazy.core.config&quot;</span>).options.root &#125;) <span class="keyword">end</span>,</span><br><span class="line">      desc = <span class="string">&quot;Find Plugin File&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h5 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h5><ul><li>å¦‚æœæƒ³å»çš„ç¼“å†²åŒºç¦»æ‚¨æ‰€åœ¨çš„ä½ç½®å¾ˆè¿‘ï¼Œè¯·ä½¿ç”¨ H å’Œ Lã€‚</li><li>å¦åˆ™ï¼Œå¦‚æœç¼“å†²åŒºå·²æ‰“å¼€ï¼Œè¯·ä½¿ç”¨ \<leader>ï¼Œ</li><li>å¯¹äºå…¶ä»–æ–‡ä»¶ï¼Œä½¿ç”¨ <leader><space>ã€‚</li><li>ä½¿ç”¨ \<leader>bd å…³é—­ä¸å†éœ€è¦çš„ç¼“å†²åŒº</li><li>ä½¿ç”¨ \<leader>ss å¿«é€Ÿè·³è½¬åˆ°æ‰€å¤„ç¼“å†²åŒºä¸­çš„å‡½æ•°</li><li><p>ä½¿ç”¨ \<c-o>ã€\<c-i> å’Œ gd æµè§ˆä»£ç </p></li><li><p>ä½¿ç”¨ \<leader>bp å¯ä»¥å›ºå®šç¼“å†²åŒºï¼Œä½¿ç”¨ \<leader>bP å¯ä»¥åˆ é™¤æ‰€æœ‰æœªå›ºå®šçš„ç¼“å†²åŒº</p></li><li>åœ¨ä½ å°†æ¥æƒ³åšä½†ç°åœ¨ä¸éœ€è¦çš„æ–‡ä»¶ä¸­æ·»åŠ  TODO,å¹¶åˆ é™¤å®ƒä»¬çš„ç¼“å†²åŒº,git ä¼šè·Ÿè¸ªå®ƒä»¬</li><li>å¦‚æœè¦ç¦ç”¨æŸä¸ªç¼“å†²åŒºçš„è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œåˆ™ä¸ºè¯¥ç¼“å†²åŒºè®¾ç½® <code>vim.b.autoformat = false</code>ã€‚</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Disable autoformat for lua files</span></span><br><span class="line">vim.api.nvim_create_autocmd(&#123; <span class="string">&quot;FileType&quot;</span> &#125;, &#123;</span><br><span class="line">  pattern = &#123; <span class="string">&quot;lua&quot;</span> &#125;,</span><br><span class="line">  callback = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    vim.b.autoformat = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>&lt;leader&gt;uf</code>æ¥å¯ç”¨è¯¥ç¼“å†²åŒºçš„è‡ªåŠ¨æ ¼å¼åŒ–ã€‚</p><p>é™¤äº†layvimçš„é…ç½®,neotreeç­‰ä½¿ç”¨çš„æ’ä»¶çš„é…ç½®ä¹Ÿåº”è¯¥çœ‹çœ‹</p><p>å¦‚æœä½ æƒ³å­¦ä¹ vim,å¯ä»¥é€šè¿‡vim tutoræˆ–è€…åœ¨çº¿çš„vim adventureç»ƒä¹ .</p><h3 id="Alacritty"><a href="#Alacritty" class="headerlink" title="Alacritty"></a>Alacritty</h3><p>GPUåŠ é€Ÿçš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨,ä¿æŒäº†æœ€å°çš„æ ¸å¿ƒåŠŸèƒ½,æ²¡æœ‰çª—å£åˆ†å‰²ç­‰(å¦‚æœæƒ³è¦æ›´å¤šåŠŸèƒ½,è€ƒè™‘ä½¿ç”¨wezterm(åŸºæœ¬ä¸éœ€è¦ä»€ä¹ˆé…ç½®),é…ç½®ä½¿ç”¨lua).</p><p>Alacrittyçš„é…ç½®éå¸¸è½»æ¾,ä½¿ç”¨.toml<a href="https://alacritty.org/config-alacritty.html">Alacritty</a>,ç»“æ„æ¯”è¾ƒæ¸…æ™°</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­</p><p><a href="https://github.com/TwiggieSmallz/Default-Alacritty-TOML-Config/blob/main/alacritty.toml">Default-Alacritty-TOML-Config/alacritty.toml at main Â· TwiggieSmallz/Default-Alacritty-TOML-Config (github.com)</a></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[GENERAL]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ENV]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[WINDOW]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[SCROLLING]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[FONT]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[SELECTION]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[TERMINAL]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[CURSOR]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[font]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[HINTS]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">size</span> = <span class="number">12.0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[font.bold]</span></span><br><span class="line"><span class="attr">family</span> = <span class="string">&quot;monospace&quot;</span></span><br><span class="line"><span class="attr">style</span> = <span class="string">&quot;Bold&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[font.bold_italic]</span></span><br><span class="line"><span class="attr">family</span> = <span class="string">&quot;monospace&quot;</span></span><br><span class="line"><span class="attr">style</span> = <span class="string">&quot;Bold Italic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[font.italic]</span></span><br><span class="line"><span class="attr">family</span> = <span class="string">&quot;monospace&quot;</span></span><br><span class="line"><span class="attr">style</span> = <span class="string">&quot;Italic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[font.normal]</span></span><br><span class="line"><span class="attr">family</span> = <span class="string">&quot;monospace&quot;</span></span><br><span class="line"><span class="attr">style</span> = <span class="string">&quot;Regular&quot;</span></span><br></pre></td></tr></table></figure><h3 id="åè¨€"><a href="#åè¨€" class="headerlink" title="åè¨€"></a>åè¨€</h3><p>æœ‰è®¸å¤šæ“ä½œå…·ä½“æˆ‘ä¹Ÿåœ¨å­¦ä¹ ,æ¬¢è¿äº¤æµ.æ„Ÿè§‰ç›®å‰ä½¿ç”¨neovimå†™ç‚¹å°demoè¿˜æ˜¯ä¸é”™çš„,å¤§é¡¹ç›®å¯ä»¥ä½¿ç”¨jetbrainsçš„IDE.</p><p>å¦‚æœä½ æƒ³geekä¸€ç‚¹,ä½¿ç”¨archçš„æ–‡æ¡£ä»¥åŠå¸¸ç”¨çš„è½¯ä»¶<a href="https://wiki.archlinux.org/">ArchWiki (archlinux.org)</a>å’Œ<a href="https://github.com/ihchiz/Awesome-Linux-Software-zh_CN#çª—å£ç®¡ç†">ihchiz/Awesome-Linux-Software-zh_CN: ğŸ§ ä¸€ä¸ª Linux ä¸Šè¶…èµçš„åº”ç”¨ï¼Œè½¯ä»¶ï¼Œå·¥å…·ä»¥åŠå…¶å®ƒèµ„æºçš„é›†ä¸­åœ°ã€‚ (github.com)</a>,ä¸‹è½½å’Œä½¿ç”¨è¿™ç±»è½¯ä»¶éå¸¸å…¨é¢å’Œæ–¹ä¾¿. å¯ä»¥è€ƒè™‘ä½¿ç”¨<a href="https://github.com/archcraft-os">Archcraft (github.com)</a>è¯•è¯•,è‡ªå¸¦è®¸å¤šé…ç½®æ–‡ä»¶.</p><p>ä¹Ÿå¯ä»¥çœ‹çœ‹æˆ‘ä»‹ç»çš„ä¸€äº›æ—¥å¸¸å¼€å‘setup<a href="https://protool-ten.vercel.app/setup/setup.html">protools (protool-ten.vercel.app)</a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¸¸ç”¨çš„çª—å£ç®¡ç†å™¨,ç¼–è¾‘å™¨ä¸ç»ˆç«¯æ¨¡æ‹Ÿå™¨ç­‰ç­‰&lt;br&gt;</summary>
    
    
    
    
    <category term="setup" scheme="https://www.sekyoro.top/tags/setup/"/>
    
  </entry>
  
  <entry>
    <title>åä½œæ„ŸçŸ¥ç®—æ³•:ä¸‰</title>
    <link href="https://www.sekyoro.top/2024/06/30/%E5%8D%8F%E4%BD%9C%E6%84%9F%E7%9F%A5%E7%AE%97%E6%B3%95-%E4%B8%89/"/>
    <id>https://www.sekyoro.top/2024/06/30/%E5%8D%8F%E4%BD%9C%E6%84%9F%E7%9F%A5%E7%AE%97%E6%B3%95-%E4%B8%89/</id>
    <published>2024-06-30T05:46:08.000Z</published>
    <updated>2024-09-09T03:11:01.300Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¸€äº›ç¨å¾®æ–°ä¸€ç‚¹æˆ–è€…ä¹‹å‰æ²¡çœ‹åˆ°çš„æƒ³æ³•è¿˜ä¸é”™çš„ååŒæ„ŸçŸ¥è®ºæ–‡<br><span id="more"></span></p><h2 id="More-Robust"><a href="#More-Robust" class="headerlink" title="More Robust"></a>More Robust</h2><p>æå‡æ£€æµ‹ç²¾åº¦,å°¤å…¶æ˜¯åœ¨ä½ç½®å™ªå£°è¾ƒå¤§çš„æƒ…å†µä¸‹</p><h3 id="Self-Localized-Collaborative-Perception"><a href="#Self-Localized-Collaborative-Perception" class="headerlink" title="Self-Localized Collaborative Perception"></a>Self-Localized Collaborative Perception</h3><h4 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h4><p>åä½œæ„ŸçŸ¥å› å…¶èƒ½å¤Ÿè§£å†³å•æ™ºèƒ½ä½“æ„ŸçŸ¥ä¸­çš„å‡ ä¸ªå›ºæœ‰æŒ‘æˆ˜ï¼ˆåŒ…æ‹¬é®æŒ¡å’Œè¶…å‡ºèŒƒå›´é—®é¢˜ï¼‰è€Œå—åˆ°å¹¿æ³›å…³æ³¨ã€‚ç„¶è€Œï¼Œç°æœ‰çš„<strong>åä½œæ„ŸçŸ¥ç³»ç»Ÿä¸¥é‡ä¾èµ–ç²¾ç¡®çš„å®šä½ç³»ç»Ÿæ¥åœ¨æ™ºèƒ½ä½“ä¹‹é—´å»ºç«‹ä¸€è‡´çš„ç©ºé—´åæ ‡ç³»</strong>ã€‚è¿™ç§ä¾èµ–ä½¿å®ƒä»¬å®¹æ˜“å—åˆ°å¤§å‹å§¿åŠ¿é”™è¯¯æˆ–æ¶æ„æ”»å‡»çš„å½±å“ï¼Œä»è€Œå¯¼è‡´æ„ŸçŸ¥æ€§èƒ½å¤§å¹…é™ä½ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæå‡ºäº† CoBEVGlueï¼Œè¿™æ˜¯ä¸€ç§æ–°é¢–çš„è‡ªå®šä½åä½œæ„ŸçŸ¥ç³»ç»Ÿï¼Œæ— éœ€ä½¿ç”¨å¤–éƒ¨å®šä½ç³»ç»Ÿå³å¯å®ç°æ›´å…¨é¢ã€æ›´ç¨³å¥çš„åä½œã€‚CoBEVGlue çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªæ–°é¢–çš„ç©ºé—´å¯¹é½æ¨¡å—ï¼Œå®ƒé€šè¿‡æœ‰æ•ˆåŒ¹é…è·¨æ™ºèƒ½ä½“çš„å…±å¯è§å¯¹è±¡æ¥æä¾›æ™ºèƒ½ä½“ä¹‹é—´çš„ç›¸å¯¹å§¿æ€ã€‚æˆ‘ä»¬åœ¨çœŸå®æ•°æ®é›†å’Œæ¨¡æ‹Ÿæ•°æ®é›†ä¸ŠéªŒè¯äº†æˆ‘ä»¬çš„æ–¹æ³•ã€‚</p><p>ç»“æœè¡¨æ˜ï¼Œiï¼‰ CoBEVGlue åœ¨<strong>ä»»æ„å®šä½å™ªå£°å’Œæ”»å‡»ä¸‹å®ç°äº†æœ€å…ˆè¿›çš„æ£€æµ‹æ€§èƒ½</strong>;iiï¼‰ <strong>ç©ºé—´å¯¹é½æ¨¡å—å¯ä»¥ä¸å¤§å¤šæ•°ä»¥å‰çš„æ–¹æ³•æ— ç¼é›†æˆ</strong>ï¼Œå°†å®ƒä»¬çš„æ€§èƒ½å¹³å‡æé«˜ 57.7%</p><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>å‡†ç¡®çš„æ„ŸçŸ¥å¯¹äºè‡ªåŠ¨é©¾é©¶æ±½è½¦çš„å¯¼èˆªå’Œå®‰å…¨è‡³å…³é‡è¦ ã€‚å°½ç®¡å¤§è§„æ¨¡æ•°æ®é›† å’Œå¼ºå¤§çš„æ¨¡å‹ æ¨åŠ¨äº†è¿›æ­¥ï¼Œä½†å•æ™ºèƒ½ä½“æ„ŸçŸ¥æœ¬èº«å—åˆ°é®æŒ¡å’Œè¿œç¨‹é—®é¢˜ çš„é™åˆ¶ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¾éš¾æ€§çš„åæœã€‚åˆ©ç”¨ç°ä»£é€šä¿¡æŠ€æœ¯ï¼Œç›®å‰å¯¹åä½œæ„ŸçŸ¥çš„ç ”ç©¶ä½¿å¤šä¸ªæ™ºèƒ½ä½“ä¹‹é—´èƒ½å¤Ÿå…±äº«æ„ŸçŸ¥ä¿¡æ¯ï¼Œä»æ ¹æœ¬ä¸Šæé«˜äº†æ„ŸçŸ¥æ€§èƒ½ã€‚</p><p>åœ¨é«˜è´¨é‡æ•°æ®é›†å’Œåˆ›æ–°åä½œæŠ€æœ¯çš„æ¨åŠ¨ä¸‹ï¼Œåä½œæ„ŸçŸ¥ç³»ç»Ÿæœ‰å¯èƒ½æ˜¾è‘—æé«˜äº¤é€šç½‘ç»œçš„å®‰å…¨æ€§</p><p>åœ¨è¿™ä¸ªæ–°å…´çš„åä½œæ„ŸçŸ¥é¢†åŸŸï¼Œå¤§å¤šæ•°ä¸»æµå·¥ä½œéƒ½åšå‡ºäº†ä¸€ä¸ªè¿‡äºç®€åŒ–çš„å‡è®¾ï¼š<strong>æ¯ä¸ªä»£ç†ä½¿ç”¨çš„å…¨å±€å®šä½ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯ GPS æˆ– SLAMï¼‰è¶³å¤Ÿç²¾ç¡®ï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªä¸€è‡´çš„åä½œç©ºé—´åæ ‡ç³»</strong></p><p>ç„¶è€Œï¼Œæ¥è‡ªçœŸå®ä¸–ç•Œåä½œæ„ŸçŸ¥æ•°æ®é›†V2V4Realå’ŒDAIR-V2X çš„å¿«ç…§æ˜¾ç¤ºï¼Œå³ä½¿ç»è¿‡ç»†è‡´å’Œèµ„æºå¯†é›†å‹çš„ç¦»çº¿æ ¡å‡†ï¼Œåœ°é¢å®å†µå®šä½ä»ç„¶å­˜åœ¨å™ªå£°ã€‚åœ¨<strong>è®¡ç®—é™åˆ¶å’Œå®æ—¶çº¦æŸä¸‹ï¼Œè¿™äº›ä¸å‡†ç¡®ä¹‹å¤„åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šæ›´åŠ ä¸¥é‡</strong>ã€‚</p><p>æ­¤å¤–ï¼Œå®šä½ç³»ç»Ÿå®¹æ˜“å—åˆ°é•¿æœŸå­˜åœ¨ä½†ä»æœªè§£å†³çš„æ”»å‡»ã€‚è¿™äº›æ”»å‡»å…è®¸æ”»å‡»è€…éšæ„æ“çºµä½ç½®ï¼Œè¿›ä¸€æ­¥ç ´åå®šä½ç³»ç»Ÿçš„å¯é æ€§ã€‚è¿™ç§æ˜¾è‘—å™ªå£°å’Œæ¶æ„æ”»å‡»çš„æ™®éæŒ‘æˆ˜ä¸æ—©æœŸå·¥ä½œæ‰€è€ƒè™‘çš„ç†æƒ³åœºæ™¯å½¢æˆé²œæ˜å¯¹æ¯”ï¼Œè¿™äº›å·¥ä½œä¸»è¦å…³æ³¨è½»å¾®çš„å§¿æ€ä¸å‡†ç¡®ï¼Œæœªèƒ½è¶…è¶Šå¤§å™ªå£°ä¸‹æ— åä½œçš„åŸºçº¿.</p><p>ä¸ºäº†æ¶ˆé™¤å¯¹å¯èƒ½ä¸å¯é çš„å¤–éƒ¨å®šä½ç³»ç»Ÿçš„ä¾èµ–ï¼Œ<strong>ä¸€ç§ç›´æ¥çš„è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡ç‚¹äº‘é…å‡†æ¨æ–­åä½œæ™ºèƒ½ä½“çš„ç›¸å¯¹å§¿æ€ï¼Œè¿™ç§æŠ€æœ¯åœ¨å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿä¸­å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚ç‚¹äº‘é…å‡†æ–¹æ³•åº”ç”¨æœ€è¿‘é‚»ç®—æ³•æ¥è¯†åˆ«å¹¿æ³›çš„3Dç‚¹é›†ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œç„¶åæ˜¯ç¨³å¥çš„æŠ€æœ¯æ¥è®¡ç®—è¿™äº›å‡å®šå¯¹åº”å…³ç³»çš„è½¬æ¢</strong>ã€‚å°½ç®¡è¿™äº›æ–¹æ³•è¢«è¯æ˜å¯¹åä½œæ˜ å°„ç­‰å»¶è¿Ÿå®¹å¿åº”ç”¨æœ‰æ•ˆï¼Œä½†å¯¹äºå¸¦å®½å—é™çš„åä½œæ„ŸçŸ¥ç³»ç»Ÿæ¥è¯´ï¼Œå¤§é‡3Dæ•°æ®çš„å®æ—¶ä¼ è¾“æ˜¯ä¸åˆ‡å®é™…çš„ã€‚å› æ­¤ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªæ²¡æœ‰å®šä½é”™è¯¯çš„ç³»ç»Ÿï¼ŒåŒæ—¶ä¿æŒå®é™…åº”ç”¨çš„é€šä¿¡æ•ˆç‡æ–¹é¢ï¼Œå­˜åœ¨æ˜æ˜¾çš„å·®è·ã€‚</p><p>ä¸ºäº†å¡«è¡¥è¿™ä¸€ç©ºç™½ï¼Œæå‡ºäº† CoBEVGlueï¼Œè¿™æ˜¯ä¸€ç§è‡ªå®šä½çš„åä½œæ„ŸçŸ¥ç³»ç»Ÿï¼Œä¸“ä¸ºå¤šä¸ªæ™ºèƒ½ä½“è®¾è®¡ï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨å®šä½ç³»ç»Ÿå³å¯å®ç°æ›´å…¨é¢çš„æ„ŸçŸ¥ï¼Œä»è€Œåœ¨é™ä½é€šä¿¡æˆæœ¬çš„åŒæ—¶å®ç°æ•ˆç‡ã€‚CoBEVGlue éµå¾ªä»¥å‰çš„åä½œæ„ŸçŸ¥ç³»ç»Ÿ çš„ç®¡é“ï¼Œå¹¶ä½¿ç”¨å…¶å…³é”®çš„ç©ºé—´å¯¹é½æ¨¡å— BEVGlue æ¥ä¼°è®¡æ™ºèƒ½ä½“ä¸æ¯ä¸ªæ™ºèƒ½ä½“æ£€æµ‹å’Œè·Ÿè¸ªçš„ç‰©ä½“ä¹‹é—´çš„ç›¸å¯¹å§¿æ€ã€‚</p><p>BEVGlue <strong>èƒŒåçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»è·¨ä»£ç†çš„é¸Ÿç°æ„ŸçŸ¥æ•°æ®ä¸­æœç´¢å…±è§å¯¹è±¡ï¼Œå¹¶è®¡ç®—ä¸è¿™äº›å…±è§å¯¹è±¡çš„ç›¸å¯¹å˜æ¢ï¼Œç¡®ä¿ä¸€è‡´çš„åä½œç©ºé—´åæ ‡ç³»</strong>ã€‚(The core idea behind BEVGlue is to search for the co-visible objects from the birdâ€™s eye view perceptual data across agents and calculate the relative transformation with these co-visible objects, ensuring a consistent spatial coordinate system for collaboration.)ç¡®ä¿ä¸€è‡´çš„ç©ºé—´åæ ‡ç³»ä»¥è¿›è¡Œåä½œã€‚BEVGlue åŒ…æ‹¬ä¸‰ä¸ªå…³é”®ç»„ä»¶ï¼šiï¼‰ å¯¹è±¡å›¾å»ºæ¨¡(object graph modeling)ï¼Œå°†<strong>æ¯ä¸ªæ™ºèƒ½ä½“çš„è§‚å¯Ÿç»“æœè½¬æ¢ä¸ºå…·æœ‰ä¸°å¯Œä¿¡æ¯çš„å¯¹è±¡å›¾ï¼ŒåŒ…æ‹¬å¯¹è±¡å½¢çŠ¶ã€èˆªå‘ã€è·Ÿè¸ª ID å’Œå¯¹è±¡ä¹‹é—´ä¸å˜çš„ç©ºé—´å…³ç³»</strong>;iiï¼‰ æ—¶é—´ä¸€è‡´çš„æœ€å¤§å­å›¾æ£€æµ‹ï¼Œå®ƒæœ‰æ•ˆåœ°åˆ©ç”¨å¯¹è±¡å›¾ä¸­çš„ç©ºé—´å’Œæ—¶é—´æ•°æ®æ¥æ£€æµ‹æœ€å¤§çš„å…¬å…±å­å›¾ï¼Œéµå¾ªä¸¥æ ¼çš„ç©ºé—´åŒæ„çº¦æŸå’Œæ—¶é—´ä¸€è‡´æ€§;iiiï¼‰ ç›¸å¯¹å§¿æ€è®¡ç®—ï¼Œå®ƒ<strong>ä½¿ç”¨æ£€æµ‹åˆ°çš„å…¬å…±å­å›¾è®¡ç®—ä»£ç†ä¹‹é—´çš„å§¿æ€å…³ç³»</strong>ï¼Œè€Œæ— éœ€ä½¿ç”¨è€—æ—¶çš„å¼‚å¸¸å€¼æ‹’ç»ç®—æ³•ã€‚</p><p>æ‹Ÿè®®çš„ CoBEVGlue ç³»ç»Ÿå…·æœ‰ä¸‰ä¸ªæ˜¾ç€ä¼˜åŠ¿ï¼š</p><p>iï¼‰ å®ƒç‹¬ç«‹äºå¤–éƒ¨å®šä½è®¾å¤‡è¿è¡Œï¼Œå±•ç¤ºäº†å…¶å¯¹å™ªéŸ³å’Œæ¶æ„æ”»å‡»çš„å¼¹æ€§</p><p>iiï¼‰ å®ƒå¸¦æ¥çš„é€šä¿¡å¼€é”€å¾ˆå°ï¼Œå› ä¸º CoBEVGlue ä»…ä½¿ç”¨å¸¦æœ‰è·Ÿè¸ª ID çš„å¯¹è±¡è¾¹ç•Œæ¡†æ¥ä¼°è®¡ä»£ç†ä¹‹é—´çš„ç›¸å¯¹å§¿åŠ¿</p><p>;iiiï¼‰ å…¶æ ¸å¿ƒæ¨¡å— BEVGlue é€šè¿‡åœ¨<strong>æ£€æµ‹åˆ°çš„å…¬å…±å­å›¾ä¹‹é—´</strong>ä¿æŒä¸¥æ ¼çš„ç©ºé—´åŒæ„çº¦æŸå’ŒåŒ¹é…ç»“æœä¹‹é—´éšæ—¶é—´çš„æ—¶é—´ä¸€è‡´æ€§æ¥ç¡®ä¿é«˜è´¨é‡çš„åŒ¹é…ç»“æœã€‚</p><p>ä¸ºäº†è¯„ä¼°æ‰€æå‡ºçš„æ–¹æ³•çš„æœ‰æ•ˆæ€§ï¼Œè€ƒè™‘äº†ä¸‰ä¸ªæ•°æ®é›†ä¸Šçš„åä½œå¼3Dç›®æ ‡æ£€æµ‹ä»»åŠ¡ï¼šOPV2Vã€DAIR-V2Xå’ŒV2V4Realï¼Œæ¶µç›–æ¨¡æ‹Ÿå’ŒçœŸå®ä¸–ç•Œåœºæ™¯ã€‚ç»“æœè¡¨æ˜ï¼ŒCoBEVGlue èµ‹äºˆäº†å¼ºå¤§çš„åä½œæ„ŸçŸ¥ç³»ç»Ÿçš„æ€§èƒ½ä¸ä¾èµ–ç²¾ç¡®å®šä½ä¿¡æ¯çš„ç³»ç»Ÿç›¸å½“ï¼Œå¹¶åœ¨å­˜åœ¨å®šä½å™ªå£°å’Œæ”»å‡»æ—¶å®ç°äº†æœ€å…ˆè¿›çš„æ£€æµ‹æ€§èƒ½</p><p>ä¸ºäº†è·å¾—å¯¹å®šä½å™ªå£°çš„æŠµæŠ—åŠ›ï¼Œä»¥å‰çš„å·¥ä½œè€ƒè™‘äº†ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼š<strong>åŸºäºå­¦ä¹ å’ŒåŸºäºåŒ¹é…</strong>ã€‚åŸºäºå­¦ä¹ çš„æ–¹æ³•æ—¨åœ¨æ„å»ºå¥å£®çš„ç½‘ç»œæ¶æ„ï¼Œä»¥å‡å°‘å§¿æ€é”™è¯¯çš„å½±å“ã€‚ä¾‹å¦‚ï¼ŒV2VNetï¼ˆç¨³å¥æ€§ï¼‰ è®¾è®¡äº†å§¿æ€å›å½’ã€å…¨å±€ä¸€è‡´æ€§å’Œæ³¨æ„åŠ›èšåˆæ¨¡å—æ¥çº æ­£ç›¸å¯¹å§¿æ€å¹¶ä¸“æ³¨äºå§¿æ€è¯¯å·®è¾ƒå°çš„é‚»å±…;V2X-ViT ä½¿ç”¨å¤šå°ºåº¦çª—å£æ³¨æ„åŠ›æ¥æ•è·å„ç§èŒƒå›´å†…çš„ç‰¹å¾ã€‚å¦ä¸€æ–¹é¢ï¼ŒåŸºäºåŒ¹é…çš„æ–¹æ³•<strong>å¯»æ±‚å¼€å‘å¥å£®çš„æ¡†æ¶æˆ–ç½‘ç»œæ¶æ„ã€‚ç¤ºä¾‹åŒ…æ‹¬ FPV-RCNNå’Œ CoAlignï¼Œå®ƒä»¬ä½¿ç”¨åŸºäº IoU çš„åŒ¹é…ç­–ç•¥ä¼°è®¡ä»£ç†ä¹‹é—´çš„ç›¸å¯¹å§¿åŠ¿</strong>ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬åªèƒ½çº æ­£å¤–éƒ¨å®šä½ä¸­çš„å¾®å°ä¸å‡†ç¡®ä¹‹å¤„ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•ä¾èµ–äºåŸºæœ¬ç²¾ç¡®çš„åˆå§‹ç›¸å¯¹å§¿åŠ¿ã€‚å½“å™ªå£°è¾ƒå¤§æˆ–å­˜åœ¨æ”»å‡»æ—¶ï¼Œå®ƒä»¬çš„æ€§èƒ½ä¼šæ˜¾è‘—ä¸‹é™ã€‚<strong>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘ä»¬çš„å·¥ä½œè®¤ä¸ºåä½œæ„ŸçŸ¥ç‹¬ç«‹äºå¤–éƒ¨å®šä½ç³»ç»Ÿ</strong></p><p>å°½ç®¡æœ¬æ–‡çš„æœ€ç»ˆç›®æ ‡æ˜¯æé«˜æ£€æµ‹èƒ½åŠ›ï¼Œä½†<strong>ç‚¹äº‘é…å‡†æ–¹æ³•çš„è¿›æ­¥æ¿€å‘äº†æˆ‘ä»¬æå‡ºæ–°é¢–çš„è‡ªå®šä½åä½œæ„ŸçŸ¥ç³»ç»Ÿ</strong>ã€‚ä¼ ç»Ÿçš„ç‚¹äº‘é…å‡†æ–¹æ³•ä¸“æ³¨äºæ”¹è¿›è¿­ä»£æœ€è¿‘ç‚¹ ï¼ˆICPï¼‰ ç®—æ³•åŠå…¶å˜ä½“  å¯¼è‡´äº†æ”¶æ•›å’Œå™ªå£°å¼¹æ€§çš„æ”¹è¿›ã€‚æœ€è¿‘å…¸å‹çš„ç‚¹äº‘é…å‡†å·¥ä½œæµç¨‹åŒ…æ‹¬æå–<strong>æœ¬åœ° 3D ç‰¹å¾æè¿°ç¬¦å’Œè¿›è¡Œé…å‡†ã€‚ä¸ºäº†æå– 3D å±€éƒ¨æè¿°ç¬¦ï¼Œå¿«é€Ÿç‚¹ç‰¹å¾ç›´æ–¹å›¾ç­‰ä¼ ç»Ÿæ–¹æ³•åˆ©ç”¨äº†æ‰‹å·¥åˆ¶ä½œçš„ç‰¹å¾</strong>ã€‚</p><p>æœ€è¿‘çš„æŠ€æœ¯ä¸ºæ­¤ç›®çš„é‡‡ç”¨äº†åŸºäºå­¦ä¹ çš„æ–¹æ³•ã€‚åœ¨é…å‡†æ–¹é¢ï¼Œ<strong>ä¼ ç»Ÿæ–¹æ³•é€šå¸¸é‡‡ç”¨æœ€è¿‘é‚»ç®—æ³•è¿›è¡ŒåŒ¹é…ï¼Œå¹¶é‡‡ç”¨ç¨³å¥ä¼˜åŒ–æ¥å‰”é™¤å¼‚å¸¸å€¼</strong>ï¼Œè€Œ<strong>ç°ä»£æ·±åº¦é…å‡†æ–¹æ³•åˆ™åˆ©ç”¨è‡ªæ³¨æ„æœºåˆ¶æ¥ç¡®å®šå¯¹åº”å…³ç³»</strong>ã€‚SGAlignerç‡å…ˆä½¿ç”¨é¢„æ„å»ºçš„ 3D åœºæ™¯å›¾è¿›è¡Œé…å‡†ã€‚ç„¶è€Œï¼Œä¸å‰é¢çš„ç­–ç•¥ç±»ä¼¼ï¼Œå®ƒéœ€è¦ä¼ è¾“å¯†é›†çš„ç‚¹äº‘å’Œé«˜ç»´ç‰¹å¾ã€‚è¿™äº›æ–¹æ³•å¹¿æ³›åº”ç”¨äºå®¹å¿å»¶è¿Ÿçš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼Œå¦‚ååŒæ˜ å°„å’Œ 3D åœºæ™¯å›¾ç”Ÿæˆ.ä½†æ˜¯ï¼Œåä½œå¯¹è±¡æ£€æµ‹ä»»åŠ¡éœ€è¦å®æ—¶è¿›è¡Œç²¾ç¡®çš„ç›¸å¯¹å§¿æ€ä¼°è®¡ã€‚é—æ†¾çš„æ˜¯ï¼Œ<strong>V2X ç½‘ç»œéš¾ä»¥å®æ—¶ä¼ è¾“ç‚¹äº‘é…å‡†æ–¹æ³•æ‰€éœ€çš„å¯†é›†ç‚¹äº‘å’Œç‰¹å¾ã€‚ä¸ºäº†å…‹æœè¿™ä¸€é™åˆ¶</strong>ï¼Œæˆ‘ä»¬çš„æ–¹æ³•ä¼˜å…ˆè€ƒè™‘å¯¹è±¡çº§æ³¨å†Œï¼Œä»…ç”¨ 8 ä¸ª float æ•°å­—è¡¨ç¤ºæ¯ä¸ªå¯¹è±¡(To overcome this limitation, our approach prioritizes object-level registration, representing each object with just eight float numbers.)ã€‚è¿™é¡¹åˆ›æ–°æ˜¾è‘—é™ä½äº†è®¡ç®—åä½œè‡ªåŠ¨é©¾é©¶æ±½è½¦ä¹‹é—´ç›¸å¯¹å§¿æ€æ‰€éœ€çš„å¸¦å®½å’Œè®¡ç®—æˆæœ¬ï¼Œä»è€Œæœ‰æ•ˆåœ°è§£å†³äº†ä¼ è¾“å›°å¢ƒ(This innovation markedly reduces the bandwidth necessary and computation cost for calculating relative poses among collaborative autonomous vehicles, thus efficiently resolving the transmission dilemma)</p><p>æœ€å¤§å…¬å…±å­å›¾ï¼ˆMaximum Common Subgraph Detection,MCSï¼‰æ£€æµ‹é—®é¢˜è¢«å½’ç±»ä¸ºNPhardï¼Œåœ¨å„ä¸ªç§‘å­¦é¢†åŸŸä¸­éƒ½è‡³å…³é‡è¦ï¼Œéœ€è¦å¹³è¡¡ç²¾åº¦å’Œè®¡ç®—æ•ˆç‡çš„ç®—æ³•ã€‚ä¼ ç»Ÿæ–¹æ³•ä¸»è¦é‡‡ç”¨åˆ†æ”¯å®šç•Œç®—æ³•å’Œå°† MCS æ£€æµ‹è½¬åŒ–ä¸ºæœ€å¤§å›¢é—®é¢˜çš„æŠ€æœ¯. æœºå™¨å­¦ä¹ çš„æœ€æ–°è¿›å±•å·²ç»çœ‹åˆ°äº†å›¾ç¥ç»ç½‘ç»œå’Œå¼ºåŒ–å­¦ä¹ åœ¨ MCS æ£€æµ‹ä¸­çš„åº”ç”¨ï¼ŒMCS æ£€æµ‹è¯•å›¾å­¦ä¹ åˆé€‚çš„å¯å‘å¼æ–¹æ³•æ¥è¿›è¡Œå›¾åŒ¹é…ã€‚å°½ç®¡ä»–ä»¬è¿›è¡Œäº†åˆ›æ–°ï¼Œä½†å®ƒä»¬ä»ç„¶å—åˆ°æœç´¢ç©ºé—´æ¢ç´¢çš„å¯å‘å¼æ€§è´¨çš„é™åˆ¶ï¼Œå¹¶ä¸”åœ¨æœ€åçš„æƒ…å†µä¸‹ä¼šå—åˆ°æŒ‡æ•°çº§æ—¶é—´å¤æ‚åº¦çš„å½±å“ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬<strong>ä½¿ç”¨å‡ ä½•ä¸å˜å¯¹è±¡å§¿æ€å›¾å¯¹æ¯ä¸ªä»£ç†æ£€æµ‹åˆ°çš„è¾¹ç•Œæ¡†è¿›è¡Œå»ºæ¨¡ï¼Œå¹¶åˆ©ç”¨ç©ºé—´çº¦æŸå’Œæ—¶é—´ä¸€è‡´æ€§æ¥æœ‰æ•ˆåœ°è§£å†³é—®é¢˜ã€‚</strong></p><p><img data-src="https://s2.loli.net/2024/09/03/TPz1njuNZGi7Qbc.png" alt="image-20240903155532374"></p><script type="math/tex; mode=display">\begin{aligned}\mathbf{F}_i^t,\mathbf{D}_i^t& =f_{\text{detection}\&\text{tracking}}\left(\mathbf{O}_i^t\right), \\\xi_{j\to i}^t& =f_{\mathrm{BEVGlue}}\left(\mathrm{D}_i^t,\mathrm{D}_j^t\right), \\\mathbf{F}_{j\to i}^t& =f_{\text{transform}}\left(\mathbf{F}_j^t,\xi_{j\to i}^t\right), \\\mathbf{F}_{i}^{\prime}t& =f_{\mathrm{fusion}}\left(\{\mathbf{F}_{j\to i}^t\}_{j=1,2,\cdots,N}\right), \\\mathbf{B}_i^t& =f_{\mathrm{decoder}}\left(\mathbf{F}_i^{'t}\right), \end{aligned}</script><p>ç²¾ç¡®çš„å§¿æ€ä¿¡æ¯<strong>è¦æ±‚æ¯ä¸ªä»£ç†åˆ©ç”¨å¤–éƒ¨å®šä½ç³»ç»Ÿæ¥è·å–å…¶å…¨å±€ä½ç½®å¹¶è®¡ç®—åä½œè€…ä¹‹é—´çš„ç›¸å¯¹å˜æ¢</strong>ã€‚è¿™ç§å¯¹å¤–éƒ¨å®šä½çš„ä¾èµ–å……æ»¡äº†æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬å®¹æ˜“å—åˆ°å™ªå£°å¹²æ‰°å’Œæ¶æ„æ”»å‡»é€ æˆçš„æ½œåœ¨å®‰å…¨æ¼æ´ã€‚<strong>BEVGlue æ—¨åœ¨é€šè¿‡åˆ©ç”¨æ„ŸçŸ¥æ•°æ®æ¥ç¡®ä¿å‡†ç¡®çš„ç›¸å¯¹å§¿æ€ä¼°è®¡æ¥è§£å†³è¿™äº›é—®é¢˜</strong>ï¼Œä»è€Œå¢å¼ºåä½œæ„ŸçŸ¥çš„å¼¹æ€§å’Œæœ‰æ•ˆæ€§ã€‚</p><p>ä¸ºäº†ä¼°è®¡æ™ºèƒ½ä½“ä¹‹é—´çš„ç›¸å¯¹å§¿æ€ Î¾t jâ†’iï¼ŒBEVGlue çš„ä¸»è¦æ€æƒ³æ˜¯è¯†åˆ«å…±å¯è§çš„ç‰©ä½“ï¼Œç„¶åæ ¹æ®è¿™äº›å…±è§ç‰©ä½“è®¡ç®—å˜æ¢ã€‚ä¸ºäº†æŒ–æ˜æ™ºèƒ½ä½“ä¹‹é—´çš„è¿™ç§å†…éƒ¨å¯¹åº”å…³ç³»ï¼ŒBEVGlue æå‡ºäº†ä¸‰ä¸ªæ¨¡å—ï¼šï¼ˆiï¼‰ å¯¹è±¡å›¾å»ºæ¨¡ï¼Œï¼ˆiiï¼‰ æ—¶é—´ä¸€è‡´çš„æœ€å¤§å…¬å…±å­å›¾æ£€æµ‹ï¼Œä»¥åŠ ï¼ˆiiiï¼‰ ç›¸å¯¹å§¿æ€è®¡ç®—ã€‚</p><p><strong>Object Graph Modeling</strong></p><p>é‰´äºæç‚¹å’Œå‚è€ƒæ–¹å‘åœ¨ç‰©ç†ä¸–ç•Œä¸­å…·æœ‰æ¸…æ™°å’Œå•ä¸€çš„å®šä¹‰ï¼Œå› æ­¤å¯ä»¥å®ç°ä¸åŒå¯¹è±¡å›¾ä¹‹é—´è¾¹ç¼˜ç‰¹å¾è®¡ç®—çš„ä¸€è‡´æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœåœ¨åŸºäºæ™ºèƒ½ä½“ j è®¡ç®—æ™ºèƒ½ä½“å›¾ Gt j ä¸Šçš„è¾¹ç¼˜ç‰¹å¾ e^t^<em>j,mn</em> æ—¶ï¼ŒèŠ‚ç‚¹ m å’Œ n çš„æ£€æµ‹ç»“æœå¯¹äºç¬¬ i ä¸ªå’Œç¬¬ j ä¸ªæ™ºèƒ½ä½“éƒ½æ˜¯å‡†ç¡®çš„ï¼Œåˆ™å®ƒä¸ e^t^<em>i,mn</em> ç›¸åŒã€‚</p><p>å¯¹è±¡å›¾æä¾›äº†ä¸€ç§åˆ›æ–°æ–¹æ³•æ¥å¯¹æ¯ä¸ªä»£ç†çš„è§‚å¯Ÿè¿›è¡Œå»ºæ¨¡ï¼šiï¼‰ èŠ‚ç‚¹å±æ€§åŒ…å«æ—¶é—´è·Ÿè¸ªæ•°æ®ï¼Œè¿™æœ‰åŠ©äºä¿æŒéšæ—¶é—´æ¨ç§»çš„åŒ¹é…ä¸€è‡´æ€§;iiï¼‰ è¾¹ç¼˜ç‰¹å¾åœ¨ä»ä¸åŒä»£ç†çš„è§’åº¦å¾—å‡ºçš„å¯¹è±¡å›¾ä¸­æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ„å‘³ç€åº”ç”¨äº D^t^<em>i</em> çš„æ—‹è½¬å’Œå¹³ç§»ä¸ä¼šæ”¹å˜ e^t^ <em>i,mn</em> çš„å€¼ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸¤ä¸ªå¯¹è±¡åŒæ—¶è¢«ä¸åŒçš„ä»£ç†è§‚å¯Ÿæ—¶ï¼Œæ— è®ºè§†è§’å¦‚ä½•å˜åŒ–ï¼Œè¾¹ç¼˜å±æ€§éƒ½ä¿æŒä¸€è‡´ã€‚</p><p>å¯¹è±¡å›¾æä¾›äº†ä¸€ç§åˆ›æ–°æ–¹æ³•æ¥å¯¹æ¯ä¸ªä»£ç†çš„è§‚å¯Ÿè¿›è¡Œå»ºæ¨¡ï¼šiï¼‰ <strong>èŠ‚ç‚¹å±æ€§åŒ…å«æ—¶é—´è·Ÿè¸ªæ•°æ®ï¼Œè¿™æœ‰åŠ©äºä¿æŒéšæ—¶é—´æ¨ç§»çš„åŒ¹é…ä¸€è‡´æ€§</strong>;iiï¼‰ <strong>è¾¹ç¼˜ç‰¹å¾åœ¨ä»ä¸åŒä»£ç†çš„è§’åº¦å¾—å‡ºçš„å¯¹è±¡å›¾ä¸­æ˜¯ä¸€è‡´çš„</strong>ï¼Œè¿™æ„å‘³ç€åº”ç”¨äº D^t^<em>i</em> çš„æ—‹è½¬å’Œå¹³ç§»ä¸ä¼šæ”¹å˜ e^t^<em>i,mn</em> çš„å€¼ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸¤ä¸ªå¯¹è±¡åŒæ—¶è¢«ä¸åŒçš„ä»£ç†è§‚å¯Ÿæ—¶ï¼Œæ— è®ºè§†è§’å¦‚ä½•å˜åŒ–ï¼Œè¾¹ç¼˜å±æ€§éƒ½ä¿æŒä¸€è‡´</p><blockquote><p>æ¯ä¸ªä»£ç†æ ¹æ®è‡ªå·±çš„æ£€æµ‹ç»“æ„å»ºæ¨¡ä¸€ä¸ªå¯¹è±¡å›¾,å›¾ä¸­æœ‰ä¸€äº›èŠ‚ç‚¹å’Œè¾¹.</p><p>æ¯ä¸ªèŠ‚ç‚¹å±æ€§åŒ…æ‹¬bboxçš„å®½é«˜å’Œid,è¾¹èŠ‚ç‚¹å±æ€§åŒ…æ‹¬ç›¸å¯¹è·ç¦»,ç›¸å¯¹èˆªå‘è§’å’Œèˆªå‘è§’ç›¸å¯¹</p></blockquote><p><img data-src="https://s2.loli.net/2024/09/03/2oyQWEVrpMiRLhA.png" alt="image-20240903170504372"></p><script type="math/tex; mode=display">\mathcal{H}_{(i,j)}^t=f_{\mathrm{MCS}}\left(\mathcal{G}_i^t,\mathcal{G}_j^t,\mathcal{H}_{(i,j)}^{t-1}\right).</script><p>ä¸Šé¢çš„MCSå‡½æ•°å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹.å…·ä½“æˆ‘å°±ä¸è¯´äº†,è¿™ç¯‡æ–‡ç« ä¸€èˆ¬,åœ¨ä¸€äº›ä»‹ç»ä¸Šè¿˜æœ‰ç‚¹å«ç³Šä¸æ¸….</p><p><img data-src="https://s2.loli.net/2024/09/05/NxJjAighnW1tEVX.png" alt="image-20240905150424806"></p><h3 id="Multi-Agent-Collaborative-Perception-via-Motion-Aware-Robust-Communication-Network"><a href="#Multi-Agent-Collaborative-Perception-via-Motion-Aware-Robust-Communication-Network" class="headerlink" title="Multi-Agent Collaborative Perception via Motion-Aware Robust Communication Network"></a>Multi-Agent Collaborative Perception via Motion-Aware Robust Communication Network</h3><h2 id="More-domain-invariant"><a href="#More-domain-invariant" class="headerlink" title="More domain-invariant"></a>More domain-invariant</h2><p>æå‡è¿ç§»æ€§,åœ¨ä»¿çœŸæ•°æ®é›†ä¸Šè®­ç»ƒèƒ½åœ¨çœŸå®æ•°æ®é›†ä¸Šä¿è¯è‰¯å¥½çš„æ•ˆæœ.</p><h3 id="V2X-DGW-Domain-Generalization-for-Multi-agent-Perception-under-Adverse-Weather-Conditions"><a href="#V2X-DGW-Domain-Generalization-for-Multi-agent-Perception-under-Adverse-Weather-Conditions" class="headerlink" title="V2X-DGW: Domain Generalization for Multi-agent Perception under Adverse Weather Conditions"></a>V2X-DGW: Domain Generalization for Multi-agent Perception under Adverse Weather Conditions</h3><h2 id="More-Communication-efficient"><a href="#More-Communication-efficient" class="headerlink" title="More Communication-efficient"></a>More Communication-efficient</h2><p>å‡å°‘ä¼ è¾“çš„æ•°æ®å¤§å°,ä½¿å¾—é€šä¿¡æ›´é«˜æ•ˆ.</p><h3 id="ERMVP-Communication-Efficient-and-Collaboration-Robust-Multi-Vehicle-Perception-in-Challenging-Environments"><a href="#ERMVP-Communication-Efficient-and-Collaboration-Robust-Multi-Vehicle-Perception-in-Challenging-Environments" class="headerlink" title="ERMVP: Communication-Efficient and Collaboration-Robust Multi-Vehicle Perception in Challenging Environments"></a>ERMVP: Communication-Efficient and Collaboration-Robust Multi-Vehicle Perception in Challenging Environments</h3><p>â€‹    åä½œæ„ŸçŸ¥é€šè¿‡ä½¿è‡ªåŠ¨é©¾é©¶æ±½è½¦èƒ½å¤Ÿäº¤æ¢äº’è¡¥ä¿¡æ¯æ¥æé«˜æ„ŸçŸ¥æ€§èƒ½ã€‚å°½ç®¡å®ƒæœ‰å¯èƒ½å½»åº•æ”¹å˜ç§»åŠ¨è¡Œä¸šï¼Œä½†å„ç§ç¯å¢ƒä¸­çš„æŒ‘æˆ˜ï¼Œå¦‚<strong>é€šä¿¡å¸¦å®½é™åˆ¶</strong>ã€å®šä½é”™è¯¯å’Œ<strong>ä¿¡æ¯èšåˆæ•ˆç‡ä½ä¸‹</strong>ï¼Œé˜»ç¢äº†å®ƒåœ¨å®é™…åº”ç”¨ä¸­çš„å®æ–½ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æå‡ºäº† ERMVPï¼Œè¿™æ˜¯ä¸€ç§åœ¨å…·æœ‰æŒ‘æˆ˜æ€§çš„ç¯å¢ƒä¸­è¿›è¡Œé€šä¿¡é«˜æ•ˆå’Œåä½œçš„é²æ£’å¤šè½¦è¾†æ„ŸçŸ¥æ–¹æ³•ã€‚å…·ä½“æ¥è¯´ï¼ŒERMVP å…·æœ‰ä¸‰ä¸ªæ˜æ˜¾çš„ä¼˜åŠ¿iï¼‰ å®ƒåˆ©ç”¨åˆ†å±‚ç‰¹å¾é‡‡æ ·ç­–ç•¥æ¥æŠ½è±¡ä¸€ç»„å…·æœ‰ä»£è¡¨æ€§çš„ç‰¹å¾å‘é‡ï¼Œä½¿ç”¨æ›´å°‘çš„é€šä¿¡å¼€é”€å®ç°é«˜æ•ˆé€šä¿¡;iiï¼‰ å®ƒé‡‡ç”¨ç¨€ç–ä¸€è‡´æ€§ç‰¹å¾æ¥æ‰§è¡Œç²¾ç¡®çš„ç©ºé—´ä½ç½®æ ¡å‡†ï¼Œæœ‰æ•ˆå‡è½»è½¦è¾†å®šä½é”™è¯¯çš„å½±å“;iiiï¼‰ å¼•å…¥äº†ä¸€ç§å¼€åˆ›æ€§çš„ç‰¹å¾èåˆå’Œäº¤äº’èŒƒå¼ï¼Œä»¥åœ¨ä¸åŒè½¦è¾†å’Œæ•°æ®æºä¹‹é—´é›†æˆæ•´ä½“ç©ºé—´è¯­ä¹‰ã€‚</p><p>è‡ªåŠ¨é©¾é©¶æ±½è½¦è¢«å¹¿æ³›è®¤ä¸ºæ˜¯æé«˜é“è·¯å®‰å…¨å’Œäº¤é€šæ•ˆç‡çš„é‡è¦æ‰‹æ®µã€‚è¿™äº›è½¦è¾†é…å¤‡äº†æ¿€å…‰é›·è¾¾ã€æ‘„åƒå¤´å’Œå…¶ä»–ä¼ æ„Ÿå™¨ï¼Œèƒ½å¤Ÿå‡†ç¡®æ„ŸçŸ¥å‘¨å›´ç¯å¢ƒï¼Œä»¥ç¡®ä¿å®‰å…¨å¯é çš„è¿è¡Œã€‚<strong>ç„¶è€Œï¼Œå•è½¦æ„ŸçŸ¥ç³»ç»Ÿä¸å¯é¿å…åœ°å­˜åœ¨ç¼ºç‚¹ ï¼Œä¾‹å¦‚ä¼ æ„Ÿå™¨è§†é‡æœ‰é™ï¼Œå®¹æ˜“è¢«é®æŒ¡ï¼Œä»¥åŠç”±äºæ•°æ®ç¨€ç–å’Œä½åˆ†è¾¨ç‡è€Œéš¾ä»¥æ£€æµ‹è¿œå¤„ç‰©ä½“ã€‚</strong></p><p>æœ€è¿‘ï¼Œè½¦å¯¹è½¦ ï¼ˆV2Vï¼‰ é€šä¿¡æŠ€æœ¯å’Œæ·±åº¦å­¦ä¹ çš„è¿›æ­¥åˆºæ¿€äº†åä½œæ„ŸçŸ¥æŠ€æœ¯çš„åˆ›æ–°å’Œè¿›æ­¥ã€‚è¿™é¡¹æŠ€æœ¯å…è®¸äº’è”è‡ªåŠ¨é©¾é©¶æ±½è½¦ ï¼ˆCAVï¼‰ å…±äº«ä¼ æ„Ÿæ•°æ®ï¼Œä»è€Œå®ç°æ›´å…¨é¢çš„ç¯å¢ƒæ„ŸçŸ¥.</p><p>â€‹    å°½ç®¡åä½œæ„ŸçŸ¥æŠ€æœ¯åœ¨ç§»åŠ¨å‡ºè¡Œè¡Œä¸šè½¬å‹æ–¹é¢æ˜¾ç¤ºå‡ºå·¨å¤§æ½œåŠ›ï¼Œä½†å…¶å®é™…åº”ç”¨é¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬é€šä¿¡å¸¦å®½é™åˆ¶ã€<strong>å®šä½é”™è¯¯å’Œä¿¡æ¯èšåˆæ•ˆç‡ä½ä¸‹</strong></p><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæ— çº¿é€šä¿¡èµ„æºå’Œå¯é æ€§çš„çº¦æŸä¸¥é‡é˜»ç¢äº†å»¶è¿Ÿæ•æ„Ÿåä½œæ„ŸçŸ¥çš„æœ‰æ•ˆæ€§ã€‚è™½ç„¶æœ€è¿‘çš„å·¥ä½œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æœºåˆ¶å®ç°äº†æ„ŸçŸ¥æ€§èƒ½å’Œé€šä¿¡å¸¦å®½ä¹‹é—´çš„å¹³è¡¡ï¼Œä½†è¿™äº›æ–¹æ³•æœ‰å…¶å±€é™æ€§ï¼Œå› ä¸ºå®ƒä»¬ä¸»è¦è€ƒè™‘ä¿¡æ¯å‹ç¼©è€Œä¸æ˜¯ç©ºé—´å†—ä½™ã€‚è¿™ç§ç‹­çª„çš„å…³æ³¨ç‚¹ä¼šåŠ å‰§é«˜å‹ç¼©æ¯”ä¸‹çš„æ€§èƒ½ä¸‹é™.</p><p>â€‹    æ­¤å¤–,å¤æ‚çš„åŠ¨æ€ç¯å¢ƒä¼šå¯¼è‡´å®šä½é”™è¯¯ï¼Œä»è€Œå¯¼è‡´ç›¸å¯¹å˜æ¢ä¼°è®¡ä¸å‡†ç¡®å’Œç©ºé—´ç‰¹å¾é”™ä½ã€‚è¿™ç§ç›¸å¯¹å§¿åŠ¿å™ªå£°ä¼šäº§ç”Ÿè¯¯å¯¼æ€§ç‰¹å¾ï¼Œä»è€Œå¯¹åä½œæ„ŸçŸ¥çš„æœ‰æ•ˆæ€§äº§ç”Ÿä¸åˆ©å½±å“ã€‚ç°æœ‰çš„æ–¹æ³•è¯•å›¾é€šè¿‡å¯†é›†çš„è®¡ç®—æ¥ä¼˜åŒ–æ•´ä½“å§¿æ€ï¼Œä½†é«˜å»¶è¿Ÿä½¿å…¶ä¸é€‚åˆå®æ—¶åŠ¨æ€æ„ŸçŸ¥.åŒæ—¶,åä½œæ–¹æ³•åªå…³æ³¨èšåˆä¿¡æ¯ï¼Œè€Œå¿½è§†äº†è‡ªæˆ‘è½½ä½“å›ºæœ‰çš„æ„ŸçŸ¥ä¼˜åŠ¿.æ­¤èŒƒä¾‹å®¹æ˜“å—åˆ°åä½œå™ªå£°å¼•å…¥çš„æ‰°åŠ¨çš„å½±å“,åŒ…æ‹¬å¼‚æ­¥è¿åŠ¨æ¨¡ç³Šå’Œä¸å‡†ç¡®çš„æŠ•å½±.è¿™æ ·çš„ç¼ºç‚¹æˆä¸ºå®ç°æœ€ä½³æ„ŸçŸ¥æ€§èƒ½çš„ç“¶é¢ˆ.</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<strong>ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„ç‰¹å¾å¯èƒ½åŒ…å«ä¸å—åä½œå™ªå£°å½±å“çš„å±€éƒ¨å‡†ç¡®ç©ºé—´ä½ç½®ä¿¡æ¯</strong>ã€‚å› æ­¤ï¼Œå»ºç«‹åŠ¡å®çš„åä½œæ„ŸçŸ¥ç³»ç»Ÿçš„é¦–è¦ä»»åŠ¡æ˜¯æœ‰æ•ˆå…‹æœä¸Šè¿°æŒ‘æˆ˜.</p><p><img data-src="https://s2.loli.net/2024/09/05/5dxPGSYCcNgRBbn.png" alt="image-20240905153336761"></p><p>åŸºäºè¿™äº›è§‚å¯Ÿæå‡ºäº† ERMVPï¼Œè¿™æ˜¯ä¸€ç§åœ¨å…·æœ‰æŒ‘æˆ˜æ€§çš„ç¯å¢ƒä¸­é€šä¿¡é«˜æ•ˆä¸”åä½œç¨³å¥çš„å¤šè½¦è¾†æ„ŸçŸ¥æ–¹æ³•ã€‚å…·ä½“æ¥è¯´,ï¼ˆiï¼‰ é¦–å…ˆè®¾è®¡äº†ä¸€ç§é«˜çº§æ»¤æ³¢å™¨å’Œåˆå¹¶ç‰¹å¾é‡‡æ ·ç­–ç•¥æ¥è§£å†³æ— çº¿é€šä¿¡èµ„æºçš„å±€é™æ€§ã€‚æ­¤ç­–ç•¥åŒæ—¶è€ƒè™‘ç±»é—´å’Œç±»å†…å†—ä½™å…³ç³»ï¼Œä»¥ä»å†—ä½™ç‰¹å¾ä¸­æŠ½è±¡å‡ºä¸€ç»„ç²¾ç‚¼çš„ç‰¹å¾å‘é‡ï¼Œä»è€Œä½¿ç”¨æ›´å°‘çš„é€šä¿¡å¼€é”€å®ç°é«˜æ•ˆé€šä¿¡.(ii)å…¶æ¬¡ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªå³æ’å³ç”¨åŠŸèƒ½ç©ºé—´æ ¡å‡†æ¨¡å—ï¼Œä»¥å‡è½»è½¦è¾†å®šä½é”™è¯¯çš„å½±å“ã€‚è¯¥æ¨¡å—å·§å¦™åœ°åˆ©ç”¨å…±è¯†ç¨€ç–å‰æ™¯ç‰¹å¾æ¥å¯¹é½è‡ªæˆ‘è½¦è¾†å’Œåˆä½œè€…ä¹‹é—´çš„ç›¸å¯¹å§¿æ€å…³ç³»ï¼Œè€Œæ— éœ€ä»»ä½•ç²¾ç¡®çš„å§¿æ€ç›‘ç£ã€‚(iii)æ­¤å¤–æå‡ºäº†ä¸€ç§å¼€åˆ›æ€§çš„ç‰¹å¾èåˆå’Œäº¤äº’èŒƒå¼,ä»¥æ•´åˆæ•´ä½“ç©ºé—´è¯­ä¹‰ã€‚</p><p>è¯¥èŒƒå¼åŒ…æ‹¬ä¸¤ä¸ªå…³é”®ç»„ä»¶:ç¬¬ä¸€ä¸ªæ˜¯åŸºäºæ³¨æ„åŠ›çš„ç‰¹å¾èåˆæ¨¡å—ï¼Œåœ¨æœ¬åœ°å’Œå…¨å±€æ³¨æ„åŠ›ä¹‹é—´äº¤æ›¿,ä»¥èåˆæ¥è‡ªä¸åŒè½¦è¾†çš„å¼‚æ„ä¿¡æ¯.</p><p>ç¬¬äºŒç§æ˜¯å‡†ç¡®æ€§å¢å¼ºç‰¹å¾äº¤äº’ç­–ç•¥,å®ƒåˆ©ç”¨ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„ç‰¹å¾ä¸­å›ºæœ‰çš„å‡†ç¡®ä½ç½®ä¿¡æ¯æ¥å¢å¼ºèåˆç‰¹å¾æä¾›çš„ä¸°å¯Œè¯­ä¹‰ä¿¡æ¯.</p><p>â€¢ æˆ‘ä»¬æå‡ºäº† ERMVPï¼Œè¿™æ˜¯ä¸€ç§<strong>é€šä¿¡é«˜æ•ˆ</strong>ä¸”<strong>åä½œç¨³å¥</strong>çš„å¤šè½¦è¾†æ„ŸçŸ¥æ–¹æ³•ï¼Œå®ƒ<strong>è§£å†³äº†é€šä¿¡å¸¦å®½é™åˆ¶ã€å®šä½é”™è¯¯å’Œä¿¡æ¯èšåˆæ•ˆç‡æŒ‘æˆ˜</strong>ã€‚</p><p>â€¢ æˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªè¿‡æ»¤å’Œåˆå¹¶ç‰¹å¾é‡‡æ ·ç­–ç•¥æ¥æé«˜é€šä¿¡æ•ˆç‡ï¼Œä¸€ä¸ªç”¨<strong>äºç²¾ç¡®ç©ºé—´ç‰¹å¾å¯¹é½çš„ç‰¹å¾ç©ºé—´æ ¡å‡†æ¨¡å—ï¼Œä»¥åŠä¸¤ä¸ªä¿¡æ¯èšåˆç»„ä»¶æ¥ä¼˜åŒ–èåˆè¿‡ç¨‹ã€‚</strong></p><p>â€¢ æˆ‘ä»¬å¯¹çœŸå®ä¸–ç•Œå’Œæ¨¡æ‹Ÿæ•°æ®é›†è¿›è¡Œäº†å¹¿æ³›çš„å®éªŒã€‚ç»“æœè¡¨æ˜äº†æˆ‘ä»¬æ–¹æ³•çš„ä¼˜è¶Šæ€§å’Œæ‰€æå‡ºç»„ä»¶çš„å¿…è¦æ€§ã€‚</p><h5 id="Filter-and-Merge-Feature-Sampling"><a href="#Filter-and-Merge-Feature-Sampling" class="headerlink" title="Filter and Merge Feature Sampling"></a>Filter and Merge Feature Sampling</h5><p>ä»¥å‰çš„å·¥ä½œåˆ©ç”¨äº†ç²¾å¿ƒè®¾è®¡çš„æœºåˆ¶ï¼Œå¦‚ä¿¡æ¯ç†µé€šä¿¡é€‰æ‹© [37] å’Œç©ºé—´å¼‚è´¨æ€§æ˜ å°„æ¥å‡å°‘æ‰€éœ€çš„ä¼ è¾“å¸¦å®½ã€‚</p><p>ç„¶è€Œï¼Œè¿™äº›æ–¹æ³•ä¸»è¦å…³æ³¨å‰å°å’Œåå°ç‰¹å¾ä¹‹é—´çš„ç±»é—´å†—ä½™ï¼Œè€Œå¿½ç•¥äº†ç‰¹å¾ä¹‹é—´çš„ç±»å†…å†—ä½™ï¼Œä»è€Œå¯¼è‡´æ¬¡ä¼˜å‹ç¼©ã€‚ä¸ºäº†è§£å†³è¿™ä¸€å·®è·ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ç§é«˜çº§è¿‡æ»¤å’Œåˆå¹¶ç‰¹å¾é‡‡æ ·ç­–ç•¥ ï¼ˆFMSï¼‰ã€‚è¯¥ç­–ç•¥åŒæ—¶è€ƒè™‘äº†ç±»é—´å’Œç±»å†…å†—ä½™å…³ç³»ï¼Œæœ‰æ•ˆåœ°ä»åŸå§‹ç‰¹å¾å›¾ä¸­æå–äº†ä¸€ç»„ç®€æ´è€Œç‹¬ç‰¹çš„ç‰¹å¾å‘é‡ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°å‡å°‘äº†é€šä¿¡å¼€é”€ã€‚FMS ç”±ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆã€‚</p><p>Filter Sampler(æ»¤æ³¢å™¨é‡‡æ ·å™¨).åœ¨å¯¹è±¡æ£€æµ‹ä¸­ï¼ŒåŒ…å«å¯¹è±¡çš„å‰æ™¯åŒºåŸŸæ¯”èƒŒæ™¯åŒºåŸŸæ›´é‡è¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å‡å°‘ç©ºé—´å†—ä½™çš„æƒ³æ³•å®ç°åˆ°ç‰¹å¾è¿‡æ»¤å™¨é‡‡æ ·å™¨æ¨¡å—ä¸­ï¼Œæ—¨åœ¨ä¿ç•™æ„ŸçŸ¥ä¸Šé‡è¦ä½†ç¨€ç–çš„ç‰¹å¾å‘é‡é›†ã€‚ç”±äºæ˜¾å¼å­¦ä¹ äºŒè¿›åˆ¶é‡‡æ ·å™¨æ˜¯ä¸å¯è¡Œçš„ï¼Œå› æ­¤æˆ‘ä»¬å¼€å‘äº†ä¸€ç§ç½®ä¿¡åº¦è¿‡æ»¤å™¨ç­–ç•¥.æœ€åˆ,ä¸ºç‰¹å¾å›¾ç”Ÿæˆæ£€æµ‹ç½®ä¿¡åº¦å›¾ã€‚å®ƒåæ˜ äº†ä¸åŒç©ºé—´åŒºåŸŸçš„æ„ŸçŸ¥é‡è¦æ€§ï¼Œè¾ƒé«˜çš„çº§åˆ«è¡¨ç¤ºæ½œåœ¨çš„å¯¹è±¡åŒºåŸŸï¼Œè¾ƒä½çš„çº§åˆ«é€šå¸¸è¡¨ç¤ºå†—ä½™çš„èƒŒæ™¯åŒºåŸŸ.</p><script type="math/tex; mode=display">C_i=\Phi_{\mathrm{con_gen}}\left(F_i\right)\in[0,1]^{H\times W}</script><p>å…¶ä¸­ Î¦con_genï¼ˆÂ·ï¼‰ è¡¨ç¤ºå…·æœ‰æ£€æµ‹è§£ç å™¨ç»“æ„çš„ç½®ä¿¡åº¦ç”Ÿæˆç½‘ç»œã€‚ç„¶åå¯¹ç½®ä¿¡åº¦å›¾è¿›è¡Œé˜ˆå€¼å¤„ç†ï¼Œç„¶åè¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶ï¼Œä»è€Œäº§ç”ŸäºŒè¿›åˆ¶æ©ç  Bã€‚</p><script type="math/tex; mode=display">\tilde{F}_{i}=B\odot F_{i}</script><p>Merge Sampler(åˆå¹¶é‡‡æ ·å™¨):åœ¨ç”¨æ»¤æ³¢å™¨é‡‡æ ·å™¨æå–è¯¦ç»†çš„å‰æ™¯ç‰¹å¾å‘é‡é›†åï¼Œæˆ‘ä»¬<strong>ä½¿ç”¨åˆå¹¶é‡‡æ ·å™¨è¿›è¡Œé¢å¤–çš„ä¼˜åŒ–ï¼Œé€šè¿‡åŠ æƒåˆå¹¶æ¥æç‚¼ç›¸ä¼¼æˆ–é‡å¤çš„å‰æ™¯ç‰¹å¾å‘é‡</strong>ã€‚è¯¥è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šä¿¡æ¯é©±åŠ¨çš„<strong>ç‰¹å¾åˆ†ç»„</strong>ã€æ³¨æ„åŠ›å¯å‘çš„<strong>ç‰¹å¾åˆå¹¶</strong>å’ŒåŸºäºç´¢å¼•çš„<strong>ç‰¹å¾é‡å»º</strong>(information-driven feature grouping, attention-inspired feature merging, and index-based feature reconstruction.)</p><ol><li><p>åº”ç”¨æœ€è¿‘é‚»èšç±»ç®—æ³•çš„å˜ä½“å¯¹å‰æ™¯ç‰¹å¾å‘é‡é›†è¿›è¡Œåˆ†ç»„.ç»™å®šä¸€ç»„ç‰¹å¾å‘é‡ $F^{~}_{i}$ =[x1ï¼Œx2,â€¦,xL] å’Œé›†ç¾¤ä¸­å¿ƒ $X_c$ï¼Œæˆ‘ä»¬è®¡ç®—æ¯ä¸ªç‰¹å¾å‘é‡çš„æŒ‡æ ‡ Î´iã€‚</p><p>Î´i çš„è®¡ç®—æ–¹æ³•æ˜¯æœ€å°ç‰¹å¾è·ç¦»å‡å»åˆ°ä»»ä½•å…¶ä»–èšç±»ä¸­å¿ƒå‘é‡çš„å¹³å‡åƒç´ è·ç¦»</p></li></ol><script type="math/tex; mode=display">\delta_i=\min_{j:x_j\in X_c}\left(\left\|x_i-x_j\right\|_2^2-\gamma\left\|p(x_i),p(x_j)\right\|_2^2\right)</script><ol><li>åˆå¹¶ç‰¹å¾å‘é‡çš„ä¸€ç§ç®€å•ç­–ç•¥æ˜¯å¹³å‡é›†ç¾¤ä¸­çš„æ¯ä¸ªç‰¹å¾å‘é‡ã€‚ä½†æ˜¯ï¼Œæ­¤æ–¹æ¡ˆå¯èƒ½ä¼šå—åˆ°å¼‚å¸¸å€¼ç‰¹å¾å‘é‡çš„ä¸¥é‡å½±å“ã€‚ä»æ³¨æ„åŠ›æœºåˆ¶ä¸­æ±²å–çµæ„Ÿï¼Œåˆ©<strong>ç”¨ç½®ä¿¡åº¦åˆ†æ•°ä½œä¸ºæŒ‡å¯¼æ¥é‡åŒ–æ¯ä¸ªç‰¹å¾çš„é‡è¦æ€§</strong>ã€‚å› æ­¤ï¼Œç¬¬ i ä¸ªç°‡ Gi çš„åˆå¹¶ç‰¹å¾å‘é‡ Ìƒ ä¹  è®¡ç®—ä¸º</li></ol><script type="math/tex; mode=display">\widetilde{x}_i=\frac{\sum_{j\in G_i}c_jx_j}{\sum_{j\in G_i}c_j}</script><ol><li>åœ¨ç‰¹å¾åˆ†ç»„å’Œåˆå¹¶è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç‰¹å¾å‘é‡éƒ½åˆ†é…ç»™ä¸€ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤ç”±ä¸€ä¸ªåˆå¹¶çš„å‘é‡è¡¨ç¤ºã€‚<strong>ç»´æŠ¤åŸå§‹ç‰¹å¾å‘é‡å’Œåˆå¹¶ç‰¹å¾å‘é‡ä¹‹é—´çš„ç´¢å¼•å¯¹åº”å…³ç³»çš„è®°å½•</strong>ã€‚åˆ©ç”¨è¿™ä¸ªç´¢å¼•è®°å½•ï¼Œè‡ªæˆ‘è½¦è¾†ç¡®ä¿åˆå¹¶çš„ç‰¹å¾å‘é‡è¢«æ˜ å°„åˆ°å®ƒä»¬çš„ç›¸åº”ä½ç½®ï¼Œä»è€Œé‡å»ºç‰¹å¾å›¾</li></ol><p>å®šä½é”™è¯¯å¯èƒ½å¯¼è‡´è½¦è¾†ä¹‹é—´çš„ç‰¹å¾å›¾é”™ä½ã€‚è¿™ç§é”™ä½ä¼šå¯¼è‡´è‡ªæˆ‘è½¦è¾†è¯¯è§£ç‰©ä½“çš„ä½ç½®ï¼Œä»è€Œå¯¼è‡´æ„ŸçŸ¥èƒ½åŠ›ä¸‹é™ï¼Œä¸ºäº†åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œå¼•å…¥äº†ç‰¹å¾ç©ºé—´æ ¡å‡†æ¨¡å— ï¼ˆFSCï¼‰ æ¥ä¿ƒè¿›ç²¾ç¡®çš„ç‰¹å¾å¯¹é½</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240909091549936.png" alt="image-20240909091549936"></p><p>æ¶‰åŠä¸‰ä¸ªé˜¶æ®µï¼šä¸€è‡´æ€§åŒ¹é…ã€å‡ ä½•éªŒè¯å’Œè¯¯å·®è°ƒåˆ¶ã€‚</p><p>â€‹    å°†è‡ªæˆ‘è½¦è¾†çš„æ‹Ÿè®®åŒ¹é…åŒºåŸŸè¡¨ç¤ºä¸º Pï¼Œå°†åä½œè½¦è¾†åœ¨å˜ˆæ‚å§¿åŠ¿æ¡ä»¶ä¸‹è¯†åˆ«çš„åŒºåŸŸè¡¨ç¤ºä¸º Qã€‚åˆ©ç”¨ P å’Œ Qï¼Œæ„å»ºäº†ä¸€ä¸ªåŠ æƒäºŒåˆ†å›¾ï¼Œå…¶ä¸­æ¯æ¡è¾¹çš„æƒé‡ç”±èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»å†³å®šï¼Œå°è£…åœ¨æˆæœ¬çŸ©é˜µä¸­ã€‚ç„¶åå°†åŒ¹é…è¿‡ç¨‹è½¬æ¢ä¸ºçº¿æ€§åˆ†é…ä»»åŠ¡ï¼Œç›®çš„æ˜¯ç¡®å®šå…·æœ‰æœ€ä½ç´¯ç§¯è¾¹ç¼˜æƒé‡çš„åŒ¹é…ç»“æœã€‚æ­¤è¿‡ç¨‹å°†ç”ŸæˆåŒ¹é…çš„å¯¹ M</p><p>â€‹    ç”±äºå¯¹è±¡ä½äºä¸“ç”¨åŒºåŸŸå’Œæ£€æµ‹å™ªå£°ï¼Œå¯èƒ½ä¼šå‡ºç°æ— æ•ˆåŒ¹é…ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åˆ©ç”¨ RANSAC æ¥è¿‡æ»¤å’Œç­›é€‰ä¸€ç»„ä¸é¢„æœŸå‡ ä½•å˜æ¢ä¸€è‡´çš„åŒ¹é…é¡¹ã€‚é¦–å…ˆï¼Œé€‰æ‹©ä¸€ä¸ªéšæœºåŒ¹é…å­é›†Ms ï¼Œç„¶ååˆ©ç”¨å¥‡å¼‚å€¼åˆ†è§£è®¡ç®—å˜æ¢çŸ©é˜µÎ“ s .å½“Î“ såº”ç”¨äºMså†…çš„æ‰€æœ‰å¯¹æ—¶ï¼Œå¦‚æœè¿™äº›å¯¹ä¹‹é—´çš„å˜æ¢åè·ç¦»ä¿æŒåœ¨é˜ˆå€¼Î·ä»¥ä¸‹ï¼Œåˆ™è®¤ä¸ºè¯¥é›†åˆæ˜¯æ­£ç¡®å¯¹é½çš„ã€‚é˜ˆå€¼Î·åæ˜ äº†åŸå§‹åä½œæ¡†æ¶å†…å…è®¸çš„å®šä½è¯¯å·®ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯è¿­ä»£è¿›è¡Œçš„ï¼Œä»¥ç¡®å®šä¸æœ€å¤§æ­£ç¡®åŒ¹é…æ•°ç›¸å…³çš„æœ€ä½³å˜æ¢çŸ©é˜µã€‚æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæœ€ä¼˜çš„ç²¾åŒ–å˜æ¢çŸ©é˜µÎ“ rï¼Œå¹¶å°†å…¶åº”ç”¨äºåç»­çš„ç©ºé—´æ ‡å®šæ“ä½œä¸­ï¼Œå¾—åˆ°å¯¹é½åçš„ç‰¹å¾â€™ Zj = Î“ rZj</p><p>â€‹    ä¸ºäº†å¢å¼ºæ ¡å‡†æ–¹æ³•åœ¨å„ç§ç¯å¢ƒä¸‹çš„é€‚åº”æ€§ï¼Œæˆ‘ä»¬èå…¥äº†<strong>è¯¯å·®è°ƒåˆ¶ç­–ç•¥ã€‚è¯¥ç­–ç•¥æ—¨åœ¨å®ç°å®šä½è¯¯å·®ä¸æ ‡å®šè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¼°è®¡è¯¯å·®ä¹‹é—´çš„å¹³è¡¡</strong>ã€‚å®ƒæµ‹é‡äº†è‡ªæˆ‘å’Œåä½œç‰¹å¾åœ¨è°ƒæ•´çŠ¶æ€å’ŒåŸå§‹çŠ¶æ€ä¸‹çš„é‡å æ¯”ä¾‹ã€‚</p><h4 id="Attention-based-Feature-Fusion"><a href="#Attention-based-Feature-Fusion" class="headerlink" title="Attention-based Feature Fusion"></a>Attention-based Feature Fusion</h4><p>åœ¨å¤šè½¦è¾†åä½œåœºæ™¯ä¸­ï¼Œè½¦è¾†èƒ½å¤Ÿæ•è·æ¥è‡ªä¸åŒç©ºé—´åŒºåŸŸçš„å¼‚æ„ä¿¡æ¯ã€‚ä¸ºäº†é«˜æ•ˆåœ°èåˆæ¥è‡ªå¤šä¸ªè½¦è¾†çš„æ„ŸçŸ¥ç‰¹å¾ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ³¨æ„åŠ›ç‰¹å¾èåˆæ–¹æ³•( AFF )ã€‚AFFåˆ©ç”¨äº¤æ›¿çš„å±€éƒ¨å’Œå…¨å±€æ³¨æ„åŠ›ï¼Œåœ¨é®æŒ¡å˜åŒ–çš„äº¤é€šåœºæ™¯ä¸­å®ç°ä½ç½®çº§åˆ«çš„ç²¾ç¡®åŒ¹é…ï¼Œå¹¶æ•è·é“è·¯æ‹“æ‰‘å’Œäº¤é€šçŠ¶æ€çš„å…¨å±€è¯­ä¹‰æ³¨æ„åŠ›</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240909094342791.png" alt="image-20240909094342791"></p><p>è¯¥æ¨¡å—å…è®¸ç³»ç»Ÿä»å±€éƒ¨è§†å›¾åˆ†æç©ºé—´ç›¸å…³æ€§,åŒæ—¶ä¹Ÿæ•è·å…¨å±€ç‰¹å¾å“åº”,ç¡®ä¿åœ¨åŠ¨æ€ã€å¤æ‚å’Œé®æŒ¡å˜åŒ–çš„äº¤é€šåœºæ™¯ä¸­å®ç°é«˜æ•ˆå’Œç²¾ç¡®çš„æ„ŸçŸ¥.æœ€åå¾—åˆ°èåˆç‰¹å¾H~i~</p><h4 id="Accuracy-Enhanced-Feature-Interaction"><a href="#Accuracy-Enhanced-Feature-Interaction" class="headerlink" title="Accuracy Enhanced Feature Interaction"></a>Accuracy Enhanced Feature Interaction</h4><p>â€‹    å…ˆå‰çš„å·¥ä½œå·²ç»è¯æ˜äº†èåˆç‰¹å¾å¯ä»¥æä¾›æ›´ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯ï¼Œä»è€Œæé«˜æ„ŸçŸ¥æ€§èƒ½ã€‚ç„¶è€Œï¼Œå®ƒä»¬å¯èƒ½ä¼šå—åˆ°åä½œå™ªå£°çš„å½±å“ï¼Œå¦‚å¼‚æ­¥è¿åŠ¨æ¨¡ç³Šå’Œä¸å‡†ç¡®çš„æŠ•å½±,è¿™ä¼šæŸå®³å‡†ç¡®çš„ä½ç½®ä¿¡æ¯,æˆä¸ºæ„ŸçŸ¥æ€§èƒ½æœ€ä¼˜å®ç°çš„ç“¶é¢ˆ.ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„ç‰¹å¾å¯èƒ½åŒ…å«å±€éƒ¨å…³é”®çš„ç©ºé—´ä½ç½®ä¿¡æ¯,è€Œä¸å—åä½œå™ªå£°çš„å½±å“.</p><p>â€‹    ä¸ºæ­¤,æˆ‘ä»¬æå‡ºäº†ä¸€ç§å‡†ç¡®æ€§å¢å¼ºçš„ç‰¹å¾äº¤äº’( Accuracy Enhanced Feature Interactionï¼ŒAEI )ç­–ç•¥,è¯¥ç­–ç•¥åˆ©ç”¨è‡ªæˆ‘ä¸­å¿ƒç‰¹å¾å›ºæœ‰çš„å‡†ç¡®ä½ç½®ä¿¡æ¯æ¥å¢å¼ºååŒèåˆç‰¹å¾æä¾›çš„ä¸°å¯Œè¯­ä¹‰ä¿¡æ¯.</p><p><img data-src="https://proanimer-img.oss-cn-shanghai.aliyuncs.com/alimg/image-20240909105358537.png" alt="image-20240909105358537"></p><h3 id="Pragmatic-Communication-in-Multi-Agent-Collaborative-Perception"><a href="#Pragmatic-Communication-in-Multi-Agent-Collaborative-Perception" class="headerlink" title="Pragmatic Communication in Multi-Agent Collaborative Perception"></a>Pragmatic Communication in Multi-Agent Collaborative Perception</h3><p>â€‹    å¤šæ™ºèƒ½ä½“ååŒæ„ŸçŸ¥çš„ç›®æ ‡æ˜¯ä½¿æ™ºèƒ½ä½“é€šè¿‡é€šä¿¡äº¤æ¢äº’è¡¥çš„æ„ŸçŸ¥ä¿¡æ¯ï¼Œä»è€Œå®ç°æ›´å…¨é¢çš„æ„ŸçŸ¥ã€‚ååŒæ„ŸçŸ¥ä¿è¯äº†æ‰©å±•çš„å¯è§†æ€§ï¼Œé€šè¿‡éšœç¢ç‰©å’Œè¯†åˆ«å°çš„ã€è¿œè·ç¦»çš„ç›®æ ‡ï¼Œä»è€Œå®ç°å¯¹ç¯å¢ƒçš„å½»åº•ç†è§£ã€‚å®ƒä¸ºä»æ ¹æœ¬ä¸Šå…‹æœå•æ™ºèƒ½ä½“æ„ŸçŸ¥çš„ç‰©ç†å±€é™æ€§æä¾›äº†ä¸€ä¸ªå¾ˆæœ‰å‰é€”çš„æ–¹å‘ï¼Œå¦‚è§†åœºå—é™ã€é®æŒ¡ã€è¿œè·ç¦»ç­‰é—®é¢˜ã€‚ä½œä¸ºè‡ªä¸»ç³»ç»Ÿçš„æœ€å‰æ²¿ï¼Œåä½œæ„ŸçŸ¥å¯ä»¥å¢å¼ºæ„ŸçŸ¥èƒ½åŠ›ï¼Œå¹¶åœ¨å„ç§ç°å®ä¸–ç•Œçš„åº”ç”¨ä¸­è¿›ä¸€æ­¥æé«˜ç³»ç»Ÿçš„åŠŸèƒ½å’Œå®‰å…¨æ€§ï¼ŒåŒ…æ‹¬è‡ªåŠ¨é©¾é©¶æœºå™¨äººæŠ€æœ¯å’Œæ— äººé©¾é©¶.</p><p>â€‹    ä¸ºäº†åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œå…³é”®åœ¨äºåœ¨é€šä¿¡é¢„ç®—èŒƒå›´å†…ä¼˜åŒ–æ¶ˆæ¯ä»¥æ»¡è¶³æ¯ä¸ªæ™ºèƒ½ä½“çš„ç‰¹å®šæ„ŸçŸ¥ä»»åŠ¡éœ€æ±‚ã€‚ä¸€ç§ç›´æ¥çš„æ–¹æ³•æ˜¯åœ¨ä¼ ç»Ÿçš„é¦™å†œé€šä¿¡èŒƒå¼ä¸­ä½¿ç”¨ä¿¡æºç¼–ç ã€‚è¯¥æ–¹æ³•å°†åŸå§‹æ•°æ®ç¼–ç ä¸ºä¸€ç³»åˆ—ä»£ç ï¼Œå°†è¾ƒçŸ­çš„ä»£ç åˆ†é…ç»™é¢‘ç¹æ•°æ®ï¼Œå°†è¾ƒé•¿çš„ä»£ç åˆ†é…ç»™ç¨€æœ‰æ•°æ®ï¼Œåœ¨ä¸æŸå¤±ä¿¡æ¯çš„æƒ…å†µä¸‹åˆ›å»ºç´§å‡‘çš„è¡¨ç¤ºã€‚åœ¨ååŒæ„ŸçŸ¥çš„èƒŒæ™¯ä¸‹ï¼Œè¯¥æ–¹æ³•åœ¨æ”¯æŒè€…ç«¯æœ‰æ•ˆåœ°å°†æ„ŸçŸ¥æ•°æ®å‹ç¼©ä¸ºæ¶ˆæ¯ï¼Œå¹¶åœ¨æ¥æ”¶è€…ç«¯ç¡®ä¿æ— æŸå¤åˆ¶.</p><p>â€‹    è¿™ç§æ–¹æ³•æé«˜äº†é€šä¿¡æ•ˆç‡ï¼ŒåŒæ—¶ä¿ç•™äº†å¯¹åŒ…æ‹¬æ„ŸçŸ¥åœ¨å†…çš„ä¸€èˆ¬ä¸‹æ¸¸ä»»åŠ¡çš„æ•ˆç”¨ã€‚ç„¶è€Œï¼Œè¿™ç§ShannonèŒƒå¼åœ¨éœ€è¦ä¸ºç‰¹å®šä¸‹æ¸¸ä»»åŠ¡å®šåˆ¶é€šä¿¡çš„åœºæ™¯ä¸­å…·æœ‰æ ¹æœ¬çš„å±€é™æ€§ï¼Œå› ä¸ºå®ƒä¸å¯é¿å…åœ°æµªè´¹äº†æ— å…³çš„èµ„æºæ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨ç›¸æœº-ä¼ æ„Ÿå™¨-æ™ºèƒ½ä½“åä½œçš„è½¦è¾†æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œé¦™å†œèŒƒå¼å¯¹æ¯ä¸ªåƒç´ è¿›è¡Œç»Ÿä¸€ç¼–ç ï¼Œè€Œä¸åŒºåˆ†éå¿…è¦çš„èƒŒæ™¯å’Œå…³é”®çš„è½¦è¾†åƒç´ ã€‚è¿™äº›èƒŒæ™¯åƒç´ åœ¨æ— åŠ©äºæ£€æµ‹æ€§èƒ½çš„æƒ…å†µä¸‹æå¤§åœ°æµªè´¹äº†é€šä¿¡èµ„æºï¼Œä»è€Œå½±å“äº†æ„ŸçŸ¥-é€šä¿¡çš„æƒè¡¡ã€‚</p><h3 id="What-Makes-Good-Collaborative-Views-Contrastive-Mutual-Information-Maximization-for-Multi-Agent-Perception"><a href="#What-Makes-Good-Collaborative-Views-Contrastive-Mutual-Information-Maximization-for-Multi-Agent-Perception" class="headerlink" title="What Makes Good Collaborative Views? Contrastive Mutual Information Maximization for Multi-Agent Perception"></a>What Makes Good Collaborative Views? Contrastive Mutual Information Maximization for Multi-Agent Perception</h3><h2 id="Towards-Label-Efficient"><a href="#Towards-Label-Efficient" class="headerlink" title="Towards Label Efficient"></a>Towards Label Efficient</h2><h3 id="COË†3-Cooperative-Unsupervised-3D-Representation-Learning-for-Autonomous-Driving"><a href="#COË†3-Cooperative-Unsupervised-3D-Representation-Learning-for-Autonomous-Driving" class="headerlink" title="COË†3: Cooperative Unsupervised 3D Representation Learning for Autonomous Driving"></a>COË†3: Cooperative Unsupervised 3D Representation Learning for Autonomous Driving</h3><p>é’ˆå¯¹å®¤å†…åœºæ™¯ç‚¹äº‘çš„æ— ç›‘ç£å¯¹æ¯”å­¦ä¹ å·²ç»å–å¾—äº†å·¨å¤§çš„æˆåŠŸã€‚ç„¶è€Œï¼Œå®¤å¤–åœºæ™¯ç‚¹äº‘çš„æ— ç›‘ç£è¡¨ç¤ºå­¦ä¹ ä»ç„¶å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºä»¥å‰çš„æ–¹æ³•éœ€è¦é‡å»ºæ•´ä¸ªåœºæ™¯å¹¶æ•è·å¯¹æ¯”ç›®æ ‡çš„éƒ¨åˆ†è§†å›¾ã€‚è¿™åœ¨æœ‰è¿åŠ¨ç‰©ä½“ã€éšœç¢ç‰©å’Œä¼ æ„Ÿå™¨çš„å®¤å¤–åœºæ™¯ä¸­æ˜¯ä¸å¯è¡Œçš„ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†CO ( 3ï¼Œå³ååŒå¯¹æ¯”å­¦ä¹ å’Œä¸Šä¸‹æ–‡å½¢çŠ¶é¢„æµ‹ï¼Œä»¥æ— ç›‘ç£çš„æ–¹å¼å­¦ä¹ å®¤å¤–åœºæ™¯ç‚¹äº‘çš„ä¸‰ç»´è¡¨ç¤ºã€‚ä¸ç°æœ‰æ–¹æ³•ç›¸æ¯”ï¼ŒCO3æœ‰å‡ ä¸ªä¼˜ç‚¹ã€‚( 1 )åˆ©ç”¨è½¦è½½ä¾§å’ŒåŸºç¡€è®¾æ–½ä¾§çš„LiDARç‚¹äº‘<strong>æ„å»ºè¶³å¤Ÿå·®å¼‚ä½†åŒæ—¶ä¿æŒå…±åŒè¯­ä¹‰ä¿¡æ¯çš„è§†å›¾è¿›è¡Œå¯¹æ¯”å­¦ä¹ ï¼Œæ¯”ä»¥å¾€æ–¹æ³•æ„å»ºçš„è§†å›¾æ›´åˆé€‚</strong>ã€‚( 2 )åœ¨å¯¹æ¯”ç›®æ ‡çš„åŸºç¡€ä¸Šï¼Œ<strong>æå‡ºäº†ä¸Šä¸‹æ–‡å½¢çŠ¶é¢„æµ‹ä½œä¸ºé¢„è®­ç»ƒç›®æ ‡ï¼Œä¸ºæ— ç›‘ç£çš„ä¸‰ç»´ç‚¹äº‘è¡¨ç¤ºå­¦ä¹ å¸¦æ¥äº†æ›´å¤šä¸ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼Œæœ‰åˆ©äºå°†å­¦ä¹ åˆ°çš„è¡¨ç¤ºè¿ç§»åˆ°ä¸‹æ¸¸çš„æ£€æµ‹ä»»åŠ¡ä¸­</strong>ã€‚( 3 )ä¸ä»¥å¾€çš„æ–¹æ³•ç›¸æ¯”ï¼ŒCO ( 3 )å­¦ä¹ åˆ°çš„è¡¨ç¤ºå¯ä»¥è¿ç§»åˆ°ä¸åŒç±»å‹çš„LiDARä¼ æ„Ÿå™¨é‡‡é›†çš„å®¤å¤–åœºæ™¯æ•°æ®é›†ä¸Šã€‚( 4 ) CO ( 3åœ¨Onceå’ŒKITTI dä¸Šéƒ½æ”¹è¿›äº†å½“å‰æœ€å…ˆè¿›çš„æ–¹æ³•</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://github.com/CatOneTwo/Collaborative-Perception-in-Autonomous-Driving/tree/main?tab=readme-ov-file">CatOneTwo/Collaborative-Perception-in-Autonomous-Driving: (2023 ITSM) Collaborative Perception in Autonomous Driving: Methods, Datasets and Challenges (github.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€äº›ç¨å¾®æ–°ä¸€ç‚¹æˆ–è€…ä¹‹å‰æ²¡çœ‹åˆ°çš„æƒ³æ³•è¿˜ä¸é”™çš„ååŒæ„ŸçŸ¥è®ºæ–‡&lt;br&gt;</summary>
    
    
    
    
    <category term="collaborative perception" scheme="https://www.sekyoro.top/tags/collaborative-perception/"/>
    
  </entry>
  
  <entry>
    <title>Rust learning:from germ to grave</title>
    <link href="https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/"/>
    <id>https://www.sekyoro.top/2024/06/29/Rust-learning-from-germ-to-grave/</id>
    <published>2024-06-29T04:51:24.000Z</published>
    <updated>2024-08-29T12:43:40.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Rustå®˜æ–¹æ¨èçš„ä¸‰ä¸ªèµ„æ–™,åˆ†åˆ«æ˜¯The Rust programming language,Rust by examplesä»¥åŠruslings,å·²ç»ç›¸å½“å……è¶³äº†.åŒ…æ‹¬ç›¸å¯¹å…¨é¢çš„ä¹¦,ä»£ç ä¾‹å­ä»¥åŠæ–¹ä¾¿çš„äº’åŠ¨å¼exercises.ä¸ªäººè§‰å¾—,the bookç›¸å½“äºå­—å…¸,è™½ç„¶å…¶å®è¿˜æœ‰å†…å®¹æ›´å¤šçš„reference,è€Œexamplesæ›´åŠ æ˜“æ‡‚ä¸Šæ‰‹,rustlingsç›¸å½“äºåˆ·é¢˜,æŠŠå…³é”®ä¸œè¥¿äº†è§£ä¸€é.</p><p>æ‰€ä»¥ä»è¿™ä¸‰ä¸ªä¸œè¥¿å…¥æ‰‹å¼€å§‹Rustå­¦ä¹ ä¹‹æ—…,ä¸€äº›åœ°æ–¹ä¼šè·Ÿc++å¯¹æ¯”.<br><span id="more"></span></p><h3 id="å®macro"><a href="#å®macro" class="headerlink" title="å®macro"></a>å®macro</h3><p>æœ¯è¯­å®æŒ‡çš„æ˜¯Rustä¸­çš„ä¸€ç³»åˆ—ç‰¹æ€§:å¸¦æœ‰macro_rulesçš„å£°æ˜æ€§å®!è¿˜æœ‰ä¸‰ç§è¿‡ç¨‹å®:</p><ul><li>Custom <code>#[derive]</code> macros that specify code added with the <code>derive</code> attribute used on structs and enums</li><li>Attribute-like macros that define custom attributes usable on any item</li><li>Function-like macros that look like function calls but operate on the tokens specified as their argument</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> vec &#123;</span><br><span class="line">    ( $( $x:expr ),* ) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> temp_vec = <span class="built_in">Vec</span>::new();</span><br><span class="line">            $(</span><br><span class="line">                temp_vec.push($x);</span><br><span class="line">            )*</span><br><span class="line">            temp_vec</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å˜é‡binding"><a href="#å˜é‡binding" class="headerlink" title="å˜é‡binding"></a>å˜é‡binding</h3><p>çŸ¥è¯†ç‚¹:</p><ol><li>ä¸å˜æ€§ Rusté»˜è®¤ä¸å¯å˜,ä¸åƒc++åˆ°å¤„å£°æ˜const</li><li>scopeå’Œshadowing ä¸»è¦æœ‰variable shadowing,ä¹Ÿå°±æ˜¯å¯ä»¥é‡å£°æ˜,åœ¨c++ä¸­ä¸å…è®¸</li><li>å°†ä¸€ä¸ªmutçš„å€¼èµ‹å€¼ç»™non-mutçš„å€¼,åœ¨é‚£ä¸ªåŸŸå†…,non-muteçš„å€¼ä¹Ÿä¸èƒ½è¢«æ”¹å˜</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> x = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, x);</span><br><span class="line">    x = <span class="number">5</span>; </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="string">&quot;T-H-R-E-E&quot;</span>; <span class="comment">// don&#x27;t change this line</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Spell a Number : &#123;&#125;&quot;</span>, number);</span><br><span class="line">    <span class="keyword">let</span> number = <span class="number">3</span>; <span class="comment">// don&#x27;t rename this variable</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Number plus two is : &#123;&#125;&quot;</span>, number + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> _mutable_integer = <span class="number">7i32</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Shadowing by immutable `_mutable_integer`</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> _mutable_integer = _mutable_integer;</span><br><span class="line">        </span><br><span class="line">        _mutable_integer = <span class="number">50</span>;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// `_mutable_integer` goes out of scope</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ok! `_mutable_integer` is not frozen in this scope</span></span><br><span class="line">    _mutable_integer = <span class="number">3</span>;</span><br></pre></td></tr></table></figure><h3 id="Primitives"><a href="#Primitives" class="headerlink" title="Primitives"></a>Primitives</h3><h4 id="å­—é¢é‡å’Œæ“ä½œç¬¦"><a href="#å­—é¢é‡å’Œæ“ä½œç¬¦" class="headerlink" title="å­—é¢é‡å’Œæ“ä½œç¬¦"></a>å­—é¢é‡å’Œæ“ä½œç¬¦</h4><ol><li>æ¨èåœ¨ä½¿ç”¨å­—é¢é‡æ˜¯åé¢åŠ ä¸Šç±»å‹.</li><li>åŸç”Ÿç±»å‹æœ¬èº«å¯ä»¥printable</li></ol><p>å…ƒç»„ã€æ•°ç»„ä¸slices. </p><p>å…ƒç»„,é€šè¿‡()è¡¨ç¤º,é€šè¿‡.numç´¢å¼•,å¯ä»¥ä½¿ç”¨#[derive(Debug)]å®ç°æ–¹æ³•æ‰“å°.</p><p>æ•°ç»„ [T;length]å£°æ˜,ç¼–è¯‘æ—¶å·²çŸ¥.</p><p>åˆ‡ç‰‡(Slices)ä¸æ•°ç»„ç±»ä¼¼,ä½†å®ƒä»¬çš„é•¿åº¦åœ¨ç¼–è¯‘æ—¶æ˜¯æœªçŸ¥çš„ã€‚ç›¸å,åˆ‡ç‰‡æ˜¯ä¸€ä¸ªç”±ä¸¤ä¸ªå­—(word)ç»„æˆçš„å¯¹è±¡:ç¬¬ä¸€ä¸ªå­—æ˜¯æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ,ç¬¬äºŒä¸ªå­—æ˜¯åˆ‡ç‰‡çš„é•¿åº¦ã€‚å­—çš„å¤§å°ä¸ <code>usize</code> ç±»å‹ç›¸åŒ,ç”±å¤„ç†å™¨æ¶æ„å†³å®š,ä¾‹å¦‚åœ¨ x86-64 ä¸Šä¸º 64 ä½ã€‚åˆ‡ç‰‡å¯ç”¨äºå€Ÿç”¨æ•°ç»„çš„ä¸€éƒ¨åˆ†,å®ƒçš„ç±»å‹ç­¾åä¸º <code>&amp;[T]</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function borrows a slice.</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">analyze_slice</span></span>(slice: &amp;[<span class="built_in">i32</span>]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;First element of the slice: &#123;&#125;&quot;</span>, slice[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The slice has &#123;&#125; elements&quot;</span>, slice.len());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> xs: [<span class="built_in">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="comment">// All elements can be initialized to the same value.</span></span><br><span class="line"><span class="keyword">let</span> ys: [<span class="built_in">i32</span>; <span class="number">500</span>] = [<span class="number">0</span>; <span class="number">500</span>];</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;Borrow the whole array as a slice.&quot;</span>);</span><br><span class="line">analyze_slice(&amp;xs);</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰ç±»å‹"><a href="#è‡ªå®šä¹‰ç±»å‹" class="headerlink" title="è‡ªå®šä¹‰ç±»å‹"></a>è‡ªå®šä¹‰ç±»å‹</h3><h4 id="structures"><a href="#structures" class="headerlink" title="structures"></a>structures</h4><p>ä½¿ç”¨ <code>struct</code> å…³é”®å­—å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ç»“æ„ä½“(struct):</p><ol><li>å…ƒç»„ç»“æ„ä½“(Tuple structs)ï¼ŒåŸºæœ¬ä¸Šæ˜¯å‘½åå…ƒç»„ã€‚</li><li>ç»å…¸çš„ C é£æ ¼ç»“æ„ä½“ã€‚</li><li>æ— å­—æ®µçš„å•å…ƒç»“æ„ä½“(Unit structs)ï¼Œåœ¨æ³›å‹ç¼–ç¨‹ä¸­å¾ˆæœ‰ç”¨ã€‚</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    age: <span class="built_in">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A unit struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Unit</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A tuple struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pair</span></span>(<span class="built_in">i32</span>, <span class="built_in">f32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// A struct with two fields</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">f32</span>,</span><br><span class="line">    y: <span class="built_in">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// A tuple struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pair</span></span>(<span class="built_in">i32</span>, <span class="built_in">f32</span>);</span><br><span class="line"><span class="comment">// Instantiate a tuple struct</span></span><br><span class="line"><span class="keyword">let</span> pair = Pair(<span class="number">1</span>, <span class="number">0.1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Access the fields of a tuple struct</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;pair contains &#123;:?&#125; and &#123;:?&#125;&quot;</span>, pair.<span class="number">0</span>, pair.<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Destructure a tuple struct</span></span><br><span class="line"><span class="keyword">let</span> Pair(integer, decimal) = pair;</span><br></pre></td></tr></table></figure><h4 id="Enums"><a href="#Enums" class="headerlink" title="Enums"></a>Enums</h4><p><code>enum</code>å…³é”®å­—å…è®¸åˆ›å»ºä¸€ä¸ªå¯ä»¥æ˜¯å‡ ç§ä¸åŒå˜ä½“(variant)ä¹‹ä¸€çš„ç±»å‹ã€‚ä»»ä½•åœ¨ç»“æ„ä½“(struct)ä¸­æœ‰æ•ˆçš„å˜ä½“,åœ¨æšä¸¾(enum)ä¸­ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IpAddrKind</span></span> &#123;</span><br><span class="line">    V4,</span><br><span class="line">    V6,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IpAddr</span></span> &#123;</span><br><span class="line">    kind: IpAddrKind,</span><br><span class="line">    address: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = IpAddr &#123;</span><br><span class="line">    kind: IpAddrKind::V4,</span><br><span class="line">    address: <span class="built_in">String</span>::from(<span class="string">&quot;127.0.0.1&quot;</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loopback = IpAddr &#123;</span><br><span class="line">    kind: IpAddrKind::V6,</span><br><span class="line">    address: <span class="built_in">String</span>::from(<span class="string">&quot;::1&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="constants"><a href="#constants" class="headerlink" title="constants"></a>constants</h4><p>Rust æœ‰ä¸¤ç§ä¸åŒç±»å‹çš„å¸¸é‡,å¯ä»¥åœ¨ä»»ä½•ä½œç”¨åŸŸ(åŒ…æ‹¬å…¨å±€)ä¸­å£°æ˜ã€‚ä¸¤ç§å¸¸é‡éƒ½éœ€è¦æ˜¾å¼çš„ç±»å‹æ³¨è§£:</p><ol><li><code>const</code>: ä¸å¯å˜çš„å€¼(æœ€å¸¸è§çš„æƒ…å†µ)ã€‚</li><li><code>static</code>: å¯èƒ½æ˜¯å¯å˜çš„å˜é‡,æ‹¥æœ‰ <code>&#39;static</code> ç”Ÿå‘½å‘¨æœŸã€‚<code>&#39;static</code> ç”Ÿå‘½å‘¨æœŸæ˜¯è¢«æ¨æ–­å‡ºæ¥çš„,ä¸éœ€è¦æ˜¾å¼æŒ‡å®šã€‚è®¿é—®æˆ–ä¿®æ”¹å¯å˜çš„ <code>static</code> å˜é‡æ˜¯ä¸å®‰å…¨çš„</li></ol><h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><h4 id="å¼ºå¤§çš„åŒ…ç®¡ç†ç³»ç»Ÿ"><a href="#å¼ºå¤§çš„åŒ…ç®¡ç†ç³»ç»Ÿ" class="headerlink" title="å¼ºå¤§çš„åŒ…ç®¡ç†ç³»ç»Ÿ"></a>å¼ºå¤§çš„åŒ…ç®¡ç†ç³»ç»Ÿ</h4><p>ä¸€ä¸ªrusté¡¹ç›®å¯èƒ½æ˜¯libä¹Ÿå¯ä»¥æ˜¯main,åˆ†åˆ«ä»£è¡¨ç”Ÿæˆåº“å’Œå¯æ‰§è¡Œç¨‹åº. æ³¨æ„å¯ä»¥æ—¢å­˜åœ¨main.rså’Œlib.rs.</p><ul><li><strong>Packages:</strong> A Cargo feature that lets you build, test, and share crates</li><li><strong>Crates:</strong> A tree of modules that produces a library or executable</li><li><strong>Modules</strong> and <strong>use:</strong> Let you control the organization, scope, and privacy of paths</li><li><strong>Paths:</strong> A way of naming an item, such as a struct, function, or module</li></ul><p>crateæ ¹æ–‡ä»¶æ˜¯Rustç¼–è¯‘å™¨å¯åŠ¨çš„æºæ–‡ä»¶,å®ƒæ„æˆäº†crateçš„æ ¹æ¨¡å—</p><p>åŒ…(Packages)æ˜¯æä¾›ä¸€ç»„åŠŸèƒ½çš„ä¸€ä¸ªæˆ–å¤šä¸ªcrateçš„é›†åˆã€‚ä¸€ä¸ªåŒ…åŒ…å«ä¸€ä¸ªCargo.tomlã€‚æè¿°å¦‚ä½•æ„å»ºè¿™äº›crateçš„Tomlæ–‡ä»¶ã€‚Cargoå®é™…ä¸Šæ˜¯ä¸€ä¸ªåŒ…ï¼Œå…¶ä¸­åŒ…å«ç”¨äºæ„å»ºä»£ç çš„å‘½ä»¤è¡Œå·¥å…·çš„äºŒè¿›åˆ¶crateã€‚CargoåŒ…è¿˜åŒ…å«ä¸€ä¸ªäºŒè¿›åˆ¶åŒ…æ‰€ä¾èµ–çš„åº“åŒ…ã€‚å…¶ä»–é¡¹ç›®å¯ä»¥ä¾èµ–Cargoåº“crateæ¥ä½¿ç”¨Cargoå‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨çš„ç›¸åŒé€»è¾‘ã€‚</p><p>crateæœ‰ä¸¤ç§å½¢å¼:äºŒè¿›åˆ¶(binary)crateæˆ–åº“(library )crateã€‚äºŒè¿›åˆ¶crateæ˜¯å¯ä»¥ç¼–è¯‘ä¸ºå¯è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç¨‹åºï¼Œä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºæˆ–æœåŠ¡å™¨ã€‚æ¯ä¸ªç¨‹åºéƒ½å¿…é¡»æœ‰ä¸€ä¸ªåä¸ºmainçš„å‡½æ•°ï¼Œç”¨äºå®šä¹‰å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ—¶å‘ç”Ÿçš„æƒ…å†µã€‚</p><p>library crate<strong>æ²¡æœ‰mainå‡½æ•°</strong>ï¼Œä¹Ÿä¸èƒ½ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ç›¸åï¼Œå®ƒä»¬å®šä¹‰äº†æ—¨åœ¨ä¸å¤šä¸ªé¡¹ç›®å…±äº«çš„åŠŸèƒ½ã€‚</p><h5 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h5><ol><li><p>ä»crateæ ¹ç›®å½•å¼€å§‹:å½“ç¼–è¯‘ä¸€ä¸ªcrateæ—¶ï¼Œç¼–è¯‘å™¨<strong>é¦–å…ˆæŸ¥æ‰¾crateæ ¹æ–‡ä»¶</strong>(é€šå¸¸æ˜¯src/lib.rs,ä¸ºåº“crateæˆ–src/main.rsè¡¨ç¤ºäºŒè¿›åˆ¶æ–‡ä»¶)ç”¨äºç¼–è¯‘ä»£ç ã€‚</p></li><li><p>å£°æ˜æ¨¡å—:åœ¨crateæ ¹æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥å£°æ˜æ–°çš„æ¨¡å—;å‡è®¾ä½ ç”¨mod garden;å£°æ˜äº†ä¸€ä¸ªâ€œèŠ±å›­â€æ¨¡å—ã€‚ç¼–è¯‘å™¨å°†åœ¨è¿™äº›åœ°æ–¹æŸ¥æ‰¾æ¨¡å—çš„ä»£ç ï¼š</p><p> å†…è”ä¸‹è½½mod gardenä¹‹å</p><p> åœ¨src/garden.rsæ–‡ä»¶ä¸­</p><p>åœ¨src/garden/mod.rsæ–‡ä»¶ä¸­   æŸ¥æ‰¾æ¨¡å—çš„è§„å¾‹å°±æ˜¯åŒçº§ç›®å½•åŒåæ–‡ä»¶æˆ–è€…åŒåå­ç›®å½•ä¸­çš„<code>mod.rs</code>æ–‡ä»¶</p></li><li><p>å£°æ˜å­æ¨¡å—:åœ¨crateæ ¹ç›®å½•ä¹‹å¤–çš„ä»»ä½•æ–‡ä»¶ä¸­(é™¤äº†<code>src/main/lib.rs</code>çš„æ–‡ä»¶ä¸­)ï¼Œéƒ½å¯ä»¥å£°æ˜å­æ¨¡å—ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å£°æ˜mod vegetables;åœ¨<code>src/garden.rs</code>ã€‚ç¼–è¯‘å™¨å°†åœ¨ä»¥ä¸‹åœ°æ–¹ä»¥çˆ¶æ¨¡å—å‘½åçš„ç›®å½•ä¸­æŸ¥æ‰¾å­æ¨¡å—çš„ä»£ç :</p><p>å†…è”ï¼Œç›´æ¥è·Ÿåœ¨mod vegetablesåé¢</p><p>åœ¨src/garden/vegetables.rsæ–‡ä»¶ä¸­</p><p>åœ¨src/garden/vegetables/mod.rsæ–‡ä»¶ä¸­     æŸ¥æ‰¾å­æ¨¡å—çš„è§„å¾‹å°±æ˜¯ä¸æ–‡ä»¶åŒåå­ç›®å½•ä¸­çš„åŒåæ¨¡å—æ–‡ä»¶æˆ–è€…åŒåæ¨¡å—ç›®å½•ä¸­çš„<code>mod.rs</code>æ–‡ä»¶</p></li><li><p>æ¨¡å—ä¸­çš„ä»£ç è·¯å¾„:ä¸€æ—¦æ¨¡å—æˆä¸ºcrateçš„ä¸€éƒ¨åˆ†,åªè¦éšç§è§„åˆ™å…è®¸,å°±å¯ä»¥ä½¿ç”¨ä»£ç è·¯å¾„ä»åŒä¸€crateä¸­çš„ä»»ä½•å…¶ä»–åœ°æ–¹å¼•ç”¨è¯¥æ¨¡å—ä¸­çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œgarden vegetablesæ¨¡å—ä¸­çš„Asparagusç±»å‹å¯ä»¥åœ¨crate::garden::vegetables::Asparagusä¸­æ‰¾åˆ°ã€‚</p></li><li><p>ç§æœ‰vs.å…¬å…±:é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å—å†…çš„ä»£ç å¯¹å…¶çˆ¶æ¨¡å—æ˜¯ç§æœ‰çš„ã€‚è¦ä½¿ä¸€ä¸ªæ¨¡å—ä¸ºå…¬å…±ï¼Œè¯·ä½¿ç”¨pub modè€Œä¸æ˜¯modå£°æ˜å®ƒã€‚è¦ä½¿å…¬å…±æ¨¡å—ä¸­çš„é¡¹ä¹Ÿä¸ºå…¬å…±ï¼Œè¯·åœ¨å£°æ˜å®ƒä»¬ä¹‹å‰ä½¿ç”¨pubã€‚</p></li><li><p>useå…³é”®å­—:åœ¨ä½œç”¨åŸŸä¸­ï¼Œuseå…³é”®å­—åˆ›å»ºé¡¹çš„å¿«æ·æ–¹å¼ï¼Œä»¥å‡å°‘é•¿è·¯å¾„çš„é‡å¤ã€‚åœ¨ä»»ä½•å¯ä»¥å¼•ç”¨crate::garden::vegetables::Asparagusçš„ä½œç”¨åŸŸä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨crate::garden::vegetables::Asparagusåˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼;ä»é‚£æ—¶èµ·ï¼Œä½ åªéœ€è¦ç¼–å†™Asparaguså°±å¯ä»¥åœ¨ä½œç”¨åŸŸä¸­ä½¿ç”¨è¯¥ç±»å‹ã€‚</p><p>â€‹     æ³¨æ„,<code>use</code>æ˜¯ç”¨äºå‡å°‘åç§°é‡å¤çš„,<code>pub mod</code>æ‰æ˜¯ç”¨äºå¼•å…¥çš„.</p><p>ä½¿ç”¨<code>mod</code>ç»„ç»‡ä»£ç ç»“æ„,æåˆ°src/main.rså’Œsrc/lib.rsè¢«ç§°ä¸ºcrate roots.å‘½åçš„åŸå› æ˜¯è¿™ä¸¤ä¸ªæ–‡ä»¶çš„å†…å®¹åœ¨crateçš„æ¨¡å—ç»“æ„(ç§°ä¸ºæ¨¡å—æ ‘)çš„æ ¹ä½ç½®å½¢æˆäº†ä¸€ä¸ªåä¸ºcrateçš„æ¨¡å—</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> front_of_house &#123;</span><br><span class="line">    <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">add_to_waitlist</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">seat_at_table</span></span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mod</span> serving &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">take_order</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">serve_order</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">take_payment</span></span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// æ¨¡å—æ ‘,æ³¨æ„</span></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">crate</span></span><br><span class="line"><span class="string"> â””â”€â”€ front_of_house</span></span><br><span class="line"><span class="string">     â”œâ”€â”€ hosting</span></span><br><span class="line"><span class="string">     â”‚   â”œâ”€â”€ add_to_waitlist</span></span><br><span class="line"><span class="string">     â”‚   â””â”€â”€ seat_at_table</span></span><br><span class="line"><span class="string">     â””â”€â”€ serving</span></span><br><span class="line"><span class="string">         â”œâ”€â”€ take_order</span></span><br><span class="line"><span class="string">         â”œâ”€â”€ serve_order</span></span><br><span class="line"><span class="string">         â””â”€â”€ take_payment</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p><strong>Path</strong></p><p>åœ¨æ¨¡å—æ ‘ä¸­å¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªitem</p><p><strong>ç»å¯¹è·¯å¾„</strong>æ˜¯ä»crateæ ¹ç›®å½•å¼€å§‹çš„å®Œæ•´è·¯å¾„;å¯¹äºæ¥è‡ªå¤–éƒ¨crateçš„ä»£ç ï¼Œç»å¯¹è·¯å¾„ä»¥crateåç§°å¼€å¤´ï¼Œè€Œå¯¹äºæ¥è‡ªå½“å‰crateçš„ä»£ç ï¼Œå®ƒä»¥æ–‡å­—crateå¼€å¤´ã€‚</p><p>ç›¸å¯¹è·¯å¾„ä»å½“å‰æ¨¡å—å¼€å§‹ï¼Œä½¿ç”¨å½“å‰æ¨¡å—ä¸­çš„selfã€superæˆ–æ ‡è¯†ç¬¦ã€‚</p></li></ol><p>çˆ¶æ¨¡å—ä¸­çš„é¡¹ä¸èƒ½ä½¿ç”¨å­æ¨¡å—ä¸­çš„ç§æœ‰é¡¹ï¼Œä½†å­æ¨¡å—ä¸­çš„é¡¹å¯ä»¥ä½¿ç”¨å…¶ç¥–å…ˆæ¨¡å—ä¸­çš„é¡¹ã€‚è¿™æ˜¯å› ä¸ºå­æ¨¡å—å°è£…å¹¶éšè—äº†å®ƒä»¬çš„å®ç°ç»†èŠ‚ï¼Œä½†æ˜¯å­æ¨¡å—å¯ä»¥çœ‹åˆ°å®ƒä»¬è¢«å®šä¹‰çš„ä¸Šä¸‹æ–‡ã€‚</p><p>siblingä¹‹é—´å¯ä»¥è°ƒç”¨æ¨¡å—,æ¯”å¦‚åŒåœ¨crateä¸‹çš„å‡½æ•°å’Œæ¨¡å—,è¿™ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥è°ƒç”¨æ¨¡å—è€Œä¸ä½¿ç”¨pub.</p><p><strong>ç›¸å¯¹è·¯å¾„</strong></p><p>ä½¿ç”¨super,selfç­‰å¼•å…¥.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">deliver_order</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> back_of_house &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fix_incorrect_order</span></span>() &#123;</span><br><span class="line">        cook_order();</span><br><span class="line">        super::deliver_order();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">cook_order</span></span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä½¿å¾—æ¨¡å—ä¸­çš„enum,structs,å‡½æ•°ç­‰pubæ‰èƒ½è®¿é—®.</p><blockquote><p>ä¸€ä¸ªåŒ…å¯ä»¥åŒæ—¶åŒ…å«src/mainã€‚RsäºŒè¿›åˆ¶crateæ ¹ä»¥åŠsrc/libã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªcrateéƒ½æœ‰åŒ…åã€‚é€šå¸¸ï¼Œå…·æœ‰è¿™ç§æ—¢åŒ…å«åº“åˆåŒ…å«äºŒè¿›åˆ¶crateæ¨¡å¼çš„åŒ…åœ¨äºŒè¿›åˆ¶crateä¸­ä¼šæœ‰è¶³å¤Ÿçš„ä»£ç æ¥å¯åŠ¨è°ƒç”¨åº“crateä¸­çš„ä»£ç çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä½¿å¾—å…¶ä»–é¡¹ç›®å¯ä»¥ä»åŒ…æä¾›çš„å¤§éƒ¨åˆ†åŠŸèƒ½ä¸­å—ç›Šï¼Œå› ä¸ºåº“crateçš„ä»£ç å¯ä»¥å…±äº«</p></blockquote><p>ä½¿ç”¨<code>use</code>å°†pathså¼•å…¥ä½œç”¨åŸŸ,è¦ä½¿ç”¨çš„è¯å°±è¦åœ¨åŒä¸€modä½œç”¨åŸŸä¸­.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> front_of_house &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_to_waitlist</span></span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::front_of_house::hosting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    hosting::add_to_waitlist();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨useå°†å‡½æ•°çš„çˆ¶æ¨¡å—å¸¦å…¥ä½œç”¨åŸŸæ„å‘³ç€æˆ‘ä»¬å¿…é¡»åœ¨è°ƒç”¨å‡½æ•°æ—¶æŒ‡å®šçˆ¶æ¨¡å—ã€‚åœ¨è°ƒç”¨å‡½æ•°æ—¶æŒ‡å®šçˆ¶æ¨¡å—å¯ä»¥æ¸…æ¥šåœ°è¡¨æ˜è¯¥å‡½æ•°ä¸æ˜¯æœ¬åœ°å®šä¹‰çš„ï¼ŒåŒæ—¶ä»ç„¶å¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘å®Œæ•´è·¯å¾„çš„é‡å¤ã€‚æ­¤å¤–åœ¨ä½¿ç”¨structã€enumå’Œå…¶ä»–é¡¹æ—¶ï¼Œä¹ æƒ¯ä¸ŠæŒ‡å®šå®Œæ•´è·¯å¾„ã€‚</p><p>å¯¹äºå°†ä¸¤ä¸ªå…·æœ‰ç›¸åŒåç§°çš„ç±»å‹å¸¦å…¥ç›¸åŒä½œç”¨åŸŸçš„é—®é¢˜,é™¤äº†å¼•å…¥çˆ¶æ¨¡å—ï¼Œè¿˜æœ‰å¦ä¸€ç§è§£å†³æ–¹æ¡ˆ:åœ¨è·¯å¾„ä¹‹åï¼Œå¯ä»¥ä¸ºç±»å‹æŒ‡å®šaså’Œä¸€ä¸ªæ–°çš„æœ¬åœ°åç§°æˆ–åˆ«åã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::<span class="built_in">Result</span>;</span><br><span class="line"><span class="keyword">use</span> std::io::<span class="built_in">Result</span> <span class="keyword">as</span> IoResult;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">function1</span></span>() -&gt; <span class="built_in">Result</span> &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">function2</span></span>() -&gt; IoResult&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// --snip--</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨useå…³é”®å­—å°†åç§°å¼•å…¥ä½œç”¨åŸŸæ—¶ï¼Œåœ¨æ–°ä½œç”¨åŸŸä¸­å¯ç”¨çš„åç§°æ˜¯privateã€‚ä¸ºäº†ä½¿è°ƒç”¨ä»£ç çš„ä»£ç èƒ½å¤Ÿå¼•ç”¨è¯¥åç§°ï¼Œå°±å¥½åƒå®ƒæ˜¯åœ¨è¯¥ä»£ç çš„ä½œç”¨åŸŸä¸­å®šä¹‰çš„ä¸€æ ·ï¼Œå¯ä»¥ç»„åˆpubå’Œuseã€‚è¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºå†å¯¼å‡º</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// restaurant  src/lib.rs</span></span><br><span class="line"><span class="keyword">mod</span> front_of_house &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">add_to_waitlist</span></span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> crate::front_of_house::hosting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">eat_at_restaurant</span></span>() &#123;</span><br><span class="line">    hosting::add_to_waitlist();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ›´æ”¹ä¹‹å‰ï¼Œå¤–éƒ¨ä»£ç å¿…é¡»é€šè¿‡restaurant::front_of_house::hosting::add_to_waitlist()æ¥è°ƒç”¨add_to_waitlistå‡½æ•°ï¼Œè¿™ä¹Ÿéœ€è¦å°†front_of_houseæ¨¡å—æ ‡è®°ä¸ºpub.ç°åœ¨å¤–éƒ¨ä»£ç å¯ä»¥ä½¿ç”¨restaurant::hosting::add_to_waitlist()ä»£æ›¿ã€‚</p><p>æ ‡å‡†stdåº“ä¹Ÿæ˜¯ä¸€ä¸ªåŒ…å¤–éƒ¨çš„crateã€‚å› ä¸ºæ ‡å‡†åº“æ˜¯éšRustè¯­è¨€ä¸€èµ·æä¾›çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ›´æ”¹Cargo.tomlã€‚ä½†æ˜¯éœ€è¦ç”¨useæ¥å¼•ç”¨å®ƒï¼Œä»¥ä¾¿å°†å…¶ä¸­çš„é¡¹å¼•å…¥åŒ…çš„ä½œç”¨åŸŸã€‚</p><p>æ¨èæ¨¡å—å‘½åä¸è¦ä¸º<code>mod.rs</code>,ä½¿ç”¨åä¸º<code>mod.rs</code>æ–‡ä»¶çš„é£æ ¼çš„ä¸»è¦ç¼ºç‚¹æ˜¯é¡¹ç›®æœ€ç»ˆå¯èƒ½ä¼šæœ‰è®¸å¤šåä¸ºmod.rsçš„æ–‡ä»¶,å½“åŒæ—¶åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€å®ƒä»¬æ—¶,è¿™å¯èƒ½ä¼šä»¤äººå›°æƒ‘ã€‚</p><h3 id="ä½¿ç”¨Cargoæ„å»ºå¤§é¡¹ç›®"><a href="#ä½¿ç”¨Cargoæ„å»ºå¤§é¡¹ç›®" class="headerlink" title="ä½¿ç”¨Cargoæ„å»ºå¤§é¡¹ç›®"></a>ä½¿ç”¨Cargoæ„å»ºå¤§é¡¹ç›®</h3><h4 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h4><p>åœ¨debugå’Œreleaseæ„å»ºæ—¶å¯ä»¥ä½¿ç”¨ä¸åŒçš„é€‰é¡¹,åœ¨<code>Cargo.toml</code>ä¸­</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[profile.dev]</span><br><span class="line">opt-level = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[profile.release]</span><br><span class="line">opt-level = <span class="number">3</span></span><br></pre></td></tr></table></figure><p>Cargoæœ‰ä¸¤ä¸ªä¸»è¦é…ç½®profiles:è¿è¡ŒCargoæ„å»ºæ—¶ä½¿ç”¨çš„å¼€å‘é…ç½®æ–‡ä»¶å’Œè¿è¡ŒCargoæ„å»ºâ€”å‘å¸ƒæ—¶ä½¿ç”¨çš„å‘å¸ƒé…ç½®æ–‡ä»¶ã€‚è¿è¡Œ<code>cargo build --release</code>ä½¿ç”¨<code>release</code> profile.</p><p>å½“æ²¡æœ‰æ˜¾å¼åœ°æ·»åŠ ä»»ä½•profilesæ—¶ï¼ŒCargoå¯¹åº”ç”¨çš„æ¯ä¸ªprofileséƒ½æœ‰é»˜è®¤è®¾ç½®ã€‚é€šè¿‡æ·»åŠ [profile.]*]éƒ¨åˆ†ï¼Œè‡ªå®šä¹‰çš„ä»»ä½•é…ç½®æ–‡ä»¶,è¦†ç›–ä»»ä½•å­é›†çš„é»˜è®¤è®¾ç½®ã€‚</p><p>option-levelè®¾ç½®æ§åˆ¶Rustå°†åº”ç”¨äºä»£ç çš„ä¼˜åŒ–æ•°é‡ï¼ŒèŒƒå›´ä¸º0åˆ°3ã€‚åº”ç”¨æ›´å¤šçš„ä¼˜åŒ–ä¼šå»¶é•¿ç¼–è¯‘æ—¶é—´ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨æ­£åœ¨å¼€å‘å¹¶ç»å¸¸ç¼–è¯‘ä»£ç ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å¸Œæœ›é€šè¿‡æ›´å°‘çš„ä¼˜åŒ–æ¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œå³ä½¿ç»“æœä»£ç è¿è¡Œå¾—æ›´æ…¢ã€‚</p><p>å› æ­¤devçš„é»˜è®¤é€‰é¡¹çº§åˆ«ä¸º0ã€‚å‡†å¤‡å‘å¸ƒä»£ç æ—¶ï¼Œæœ€å¥½èŠ±æ›´å¤šçš„æ—¶é—´è¿›è¡Œç¼–è¯‘ã€‚å°†åªåœ¨å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘ä¸€æ¬¡ï¼Œä½†æ˜¯å°†å¤šæ¬¡è¿è¡Œç¼–è¯‘åçš„ç¨‹åºï¼Œå› æ­¤å‘å¸ƒæ¨¡å¼ä»¥è¾ƒé•¿çš„ç¼–è¯‘æ—¶é—´æ¢å–è¿è¡Œé€Ÿåº¦æ›´å¿«çš„ä»£ç </p><p>ä½¿ç”¨<code>cargo publish</code>è¿›è¡Œå‘å¸ƒ,æ³¨æ„éœ€è¦æ³¨å†Œcrates.ioè´¦å·,å¦‚æœéœ€è¦æ›´æ–°ç‰ˆæœ¬æ›´æ”¹<code>version</code>å†æ¨é€å³å¯</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;guessing_game&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;A fun game where you guess what number the computer has chosen.&quot;</span></span><br><span class="line"><span class="attr">license</span> = <span class="string">&quot;MIT OR Apache-2.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>cargo yank --vers [versionNumber]</code>å¯ä»¥é˜»æ­¢ä½¿ç”¨è¿™ä¸ªé¡¹ç›®çš„æŸä¸ªç‰ˆæœ¬çš„ä¾èµ–.</p><p>yankä¸€ä¸ªç‰ˆæœ¬å¯ä»¥é˜²æ­¢æ–°é¡¹ç›®ä¾èµ–äºè¯¥ç‰ˆæœ¬ï¼ŒåŒæ—¶å…è®¸æ‰€æœ‰ä¾èµ–äºè¯¥ç‰ˆæœ¬çš„ç°æœ‰é¡¹ç›®ç»§ç»­è¿›è¡Œã€‚</p><h4 id="workspaces"><a href="#workspaces" class="headerlink" title="workspaces"></a>workspaces</h4><p>å·¥ä½œåŒºæ˜¯ä¸€ç»„å…±äº«Cargo.lock,å’Œè¾“å‡ºç›®å½•çš„packages. å¸¸è§å·¥ä½œæµæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„packageså’Œå¤šä¸ªç”Ÿæˆåº“çš„packages.</p><p>åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º<code>Cargo.toml</code>,å…¶ä¸­æ·»åŠ packagesåå­—,å‡è®¾æ ¹ç›®å½•åå­—add</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[workspace]</span><br><span class="line"></span><br><span class="line">members = [</span><br><span class="line">    <span class="string">&quot;adder&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new adder</span><br></pre></td></tr></table></figure><p>ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ <span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>lock</span><br><span class="line">â”œâ”€â”€ <span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>toml</span><br><span class="line">â”œâ”€â”€ adder</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>toml</span><br><span class="line">â”‚   â””â”€â”€ src</span><br><span class="line">â”‚       â””â”€â”€ main.rs</span><br><span class="line">â””â”€â”€ target</span><br></pre></td></tr></table></figure><p>å·¥ä½œåŒºåœ¨é¡¶å±‚æœ‰ä¸€ä¸ªç›®æ ‡ç›®å½•ï¼Œç¼–è¯‘åçš„å·¥ä»¶å°†è¢«æ”¾ç½®åˆ°è¯¥ç›®å½•ä¸­;adderåŒ…æ²¡æœ‰è‡ªå·±çš„ç›®æ ‡ç›®å½•ã€‚å³ä½¿è¦ä»adderç›®å½•ä¸­è¿è¡Œcargoæ„å»ºï¼Œç¼–è¯‘åçš„å·¥ä»¶ä»ç„¶ä¼šåœ¨add/targetè€Œä¸æ˜¯add/adder/targetä¸­ç»“æŸã€‚Cargoåœ¨å·¥ä½œåŒºçš„ç›®æ ‡ç›®å½•ä¸­é‡‡ç”¨è¿™æ ·çš„ç»“æ„ï¼Œå› ä¸ºå·¥ä½œåŒºçš„crateæ˜¯ç›¸äº’ä¾èµ–çš„ã€‚</p><blockquote><p>å¦‚æœæ¯ä¸ªcrateéƒ½æœ‰è‡ªå·±çš„ç›®æ ‡ç›®å½•ï¼Œé‚£ä¹ˆæ¯ä¸ªcrateéƒ½å¿…é¡»é‡æ–°ç¼–è¯‘å·¥ä½œç©ºé—´ä¸­çš„å…¶ä»–crateï¼Œä»¥ä¾¿å°†å·¥ä»¶æ”¾ç½®åœ¨è‡ªå·±çš„ç›®æ ‡ç›®å½•ä¸­ã€‚é€šè¿‡å…±äº«ä¸€ä¸ªç›®æ ‡ç›®å½•ï¼Œcrateå¯ä»¥é¿å…ä¸å¿…è¦çš„é‡æ–°æ„å»ºã€‚</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new add_one --lib</span><br></pre></td></tr></table></figure><p>ç»§ç»­æ·»åŠ crate,åŠ å…¥workspaceä¸­.</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">members</span> = [</span><br><span class="line">    <span class="string">&quot;adder&quot;</span>,</span><br><span class="line">    <span class="string">&quot;add_one&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>æ·»åŠ æœ¬åœ°é¡¹ç›®ä¸­çš„ä¾èµ–</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// adder/Cargo.toml</span></span><br><span class="line">[dependencies]</span><br><span class="line">add_one = &#123; path = <span class="string">&quot;../add_one&quot;</span> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨é¡¶å±‚ç›®å½•è¿è¡Œ<code>cargo build</code>,ç„¶åæŒ‡å®š<code>-p</code>è¿è¡ŒæŒ‡å®šå¯æ‰§è¡Œç¨‹åº<code>cargo run -p adder</code></p><p>å¦‚æœè¦ä½¿workspaceä¸‹ä¸¤ä¸ªcrateä½¿ç”¨åŒä¸€ç‰ˆæœ¬åŒä¸€ä¸ªä¾èµ–,å¯ä»¥ä½¿å¾—å…¶ä¸­ä¸€ä¸ªcrateä¾èµ–å¦ä¸€ä¸ªä¾èµ–,buildä¹‹ååœ¨é¡¶å±‚cargo.lockä¸­ä¼šæœ‰ç›¸å…³ä¾èµ–ä¿¡æ¯.</p><blockquote><p>Cargoå°†ç¡®ä¿å·¥ä½œç©ºé—´ä¸­ä½¿ç”¨randåŒ…çš„æ¯ä¸ªåŒ…ä¸­çš„æ¯ä¸ªcrateéƒ½ä½¿ç”¨ç›¸åŒçš„ç‰ˆæœ¬ï¼Œåªè¦å®ƒä»¬æŒ‡å®šrandçš„å…¼å®¹ç‰ˆæœ¬ï¼Œå°±å¯ä»¥èŠ‚çœç©ºé—´å¹¶ç¡®ä¿å·¥ä½œç©ºé—´ä¸­çš„crateå½¼æ­¤å…¼å®¹</p></blockquote><p>workspaceä¸­çš„é¡¹ç›®æµ‹è¯•,åœ¨é¡¶å±‚ç›®å½•ä¸­<code>cargo test</code>è¿è¡Œæ¯ä¸ªcrateä¸­çš„æµ‹è¯•,ä½¿ç”¨<code>cargo test -p</code>æŒ‡å®š,å‘å¸ƒé¡¹ç›®åŒç†,<code>cargo publish -p</code>.</p><p><code>cargo install</code>å‘½ä»¤åœ¨æœ¬åœ°å®‰è£…å’Œä½¿ç”¨äºŒè¿›åˆ¶crate.</p><p>æ‰€æœ‰ä½¿ç”¨cargo installå®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½å­˜å‚¨åœ¨å®‰è£…æ ¹ç›®å½•çš„binæ–‡ä»¶å¤¹ä¸­ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è‡ªå®šä¹‰é…ç½®ï¼Œè¿™ä¸ªç›®å½•å°†æ˜¯<code>$HOME/.cargo/bin</code></p><p>å¦‚æœ<code>$PATH</code>ä¸­çš„äºŒè¿›åˆ¶æ–‡ä»¶åä¸º<code>cargo-something</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡è¿è¡ŒCargo somethingæ¥å°†å…¶ä½œä¸ºCargoå­å‘½ä»¤è¿è¡Œã€‚åœ¨è¿è¡Œcargoâ€”â€”listæ—¶ä¼šåˆ—å‡ºè¿™æ ·çš„è‡ªå®šä¹‰å‘½ä»¤ã€‚</p><h4 id="cargo-fmt-clippy"><a href="#cargo-fmt-clippy" class="headerlink" title="cargo fmt/clippy"></a>cargo fmt/clippy</h4><p>åˆ†åˆ«ç”¨äºæ ¼å¼åŒ–å’Œè¯­æ³•æç¤º</p><h4 id="cargo-doc"><a href="#cargo-doc" class="headerlink" title="cargo doc"></a>cargo doc</h4><p>éå¸¸æ–¹ä¾¿çš„ç”Ÿæˆæ–‡æ¡£çš„å·¥å…·</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo doc --no-deps --open</span><br></pre></td></tr></table></figure><h4 id="test"><a href="#test" class="headerlink" title="test"></a>test</h4><p>å•å…ƒæµ‹è¯• é›†æˆæµ‹è¯• benchmarks</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span></span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> test&#123;</span><br><span class="line"><span class="keyword">use</span> super::*;</span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line">    func()&#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ä¹Ÿæœ‰doc-test,ç”¨äºæµ‹è¯•æ–‡æ¡£ä¸­çš„ä»£ç .å°è¯•ä½¿ç”¨<code>criterion</code><a href="https://bheisler.github.io/criterion.rs/book/index.html">Criterion.rs - Criterion.rs Documentation (bheisler.github.io)</a>è¿›è¡Œbenchmarkæµ‹è¯•.</p><h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> log::&#123;error,warn,info,debug,trace&#125;;</span><br><span class="line">error!();</span><br><span class="line">warn!();</span><br><span class="line">info!();</span><br><span class="line">debug!();</span><br><span class="line">trace!();</span><br></pre></td></tr></table></figure><h3 id="dyn"><a href="#dyn" class="headerlink" title="dyn"></a>dyn</h3><p>Rust ç¼–è¯‘å™¨éœ€è¦çŸ¥é“æ¯ä¸ªå‡½æ•°çš„è¿”å›ç±»å‹éœ€è¦å¤šå°‘ç©ºé—´ã€‚è¿™æ„å‘³ç€æ‰€æœ‰å‡½æ•°éƒ½å¿…é¡»è¿”å›ä¸€ä¸ªå…·ä½“ç±»å‹ã€‚ä¸å…¶ä»–è¯­è¨€ä¸åŒï¼Œå¦‚æœä½ æœ‰ä¸ªåƒ <code>Animal</code> é‚£æ ·çš„çš„ traitï¼Œåˆ™ä¸èƒ½ç¼–å†™è¿”å› <code>Animal</code> çš„å‡½æ•°ï¼Œå› ä¸ºå…¶ä¸åŒçš„å®ç°å°†éœ€è¦ä¸åŒçš„å†…å­˜é‡ã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ³•ã€‚ç›¸æ¯”äºç›´æ¥è¿”å›ä¸€ä¸ª trait å¯¹è±¡ï¼Œæˆ‘ä»¬çš„å‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«ä¸€äº› <code>Animal</code> çš„ <code>Box</code></strong>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">walk</span></span> &#123;</span><br><span class="line"> <span class="function"><span class="keyword">fn</span> <span class="title">xx</span></span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">a</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> walk <span class="keyword">for</span> a &#123;</span><br><span class="line"> <span class="function"><span class="keyword">fn</span> <span class="title">xx</span></span>()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">b</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> walk <span class="keyword">for</span> b &#123;</span><br><span class="line"> <span class="function"><span class="keyword">fn</span> <span class="title">xx</span></span>()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line"><span class="keyword">let</span> t = <span class="built_in">vec!</span>[<span class="built_in">Box</span>::new(a&#123;]&#125;),<span class="built_in">Box</span>::new(b&#123;&#125;)]; <span class="comment">// Box&lt;dyn walk&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>box</code> åªæ˜¯å¯¹å †ä¸­æŸäº›å†…å­˜çš„å¼•ç”¨ã€‚å› ä¸ºå¼•ç”¨çš„å¤§å°æ˜¯é™æ€å·²çŸ¥çš„ï¼Œå¹¶ä¸”ç¼–è¯‘å™¨å¯ä»¥ä¿è¯å¼•ç”¨æŒ‡å‘å·²åˆ†é…çš„å † <code>Animal</code>ï¼Œæ‰€ä»¥å¯ä»¥ä»å‡½æ•°ä¸­è¿”å› trait.</p><p>æ¯å½“åœ¨å †ä¸Šåˆ†é…å†…å­˜æ—¶ï¼ŒRust éƒ½ä¼šå°è¯•å°½å¯èƒ½æ˜ç¡®ã€‚å› æ­¤ï¼Œå¦‚æœ<strong>å‡½æ•°ä»¥è¿™ç§æ–¹å¼è¿”å›æŒ‡å‘å †çš„ trait æŒ‡é’ˆï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>dyn</code> å…³é”®å­—ç¼–å†™è¿”å›ç±»å‹</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sheep</span></span> &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Cow</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Animal</span></span> &#123;</span><br><span class="line">    <span class="comment">// å®ä¾‹æ–¹æ³•ç­¾å</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">noise</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° `Sheep` çš„ `Animal` traitã€‚</span></span><br><span class="line"><span class="keyword">impl</span> Animal <span class="keyword">for</span> Sheep &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">noise</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">        <span class="string">&quot;baaaaah!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° `Cow` çš„ `Animal` traitã€‚</span></span><br><span class="line"><span class="keyword">impl</span> Animal <span class="keyword">for</span> Cow &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">noise</span></span>(&amp;<span class="keyword">self</span>) -&gt; &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span> &#123;</span><br><span class="line">        <span class="string">&quot;moooooo!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›ä¸€äº›å®ç° Animal çš„ç»“æ„ä½“ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘æ—¶æˆ‘ä»¬ä¸çŸ¥é“å“ªä¸ªç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">random_animal</span></span>(random_number: <span class="built_in">f64</span>) -&gt; <span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> Animal&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> random_number &lt; <span class="number">0.5</span> &#123;</span><br><span class="line">        <span class="built_in">Box</span>::new(Sheep &#123;&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Box</span>::new(Cow &#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> random_number = <span class="number">0.234</span>;</span><br><span class="line">    <span class="keyword">let</span> animal = random_animal(random_number);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;You&#x27;ve randomly chosen an animal, and it says &#123;&#125;&quot;</span>, animal.noise());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h3><p>ä¸C++ç±»ä¼¼,rustä¹Ÿä½¿ç”¨äº†ä¸€å¥—æœºåˆ¶ä¿è¯å†…å­˜å®‰å…¨. æ™ºèƒ½æŒ‡é’ˆç›¸æ¯”äºå€Ÿç”¨(å¼•ç”¨)æ¥è¯´,å…¶åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ‹¥æœ‰æ‰€æœ‰æƒ.</p><p>å¸¸ç”¨æ™ºèƒ½æŒ‡é’ˆç±»å‹å¦‚ä¸‹</p><ul><li><code>Box&lt;T&gt;</code> for allocating values on the heap</li><li><code>Rc&lt;T&gt;</code>, a reference counting type that enables multiple ownership</li><li><p><code>Ref&lt;T&gt;</code> and <code>RefMut&lt;T&gt;</code>, accessed through <code>RefCell&lt;T&gt;</code>, a type that enforces the borrowing rules at runtime instead of compile time</p></li><li><p><strong>RefCell</strong>ï¼šæ™ºèƒ½æŒ‡é’ˆï¼Œå…è®¸è¿è¡Œæ—¶åŠ¨æ€è·å–å¯å˜å¼•ç”¨ï¼Œè·Ÿè¸ªå€Ÿç”¨ä»¥ä¿è¯å®‰å…¨æ€§</p></li><li><strong>Arc</strong>:çº¿ç¨‹å®‰å…¨çš„reference counting type</li></ul><p>æ­¤å¤–,æœ‰<strong>Ref</strong>:ç”¨äºåœ¨ä¸å¯å˜å€Ÿç”¨çš„æƒ…å†µä¸‹å®‰å…¨åœ°è®¿é—®æ•°æ®å’Œ<strong>Cell</strong>åˆ†åˆ«ç”¨æ¥å®‰å…¨è®¿é—®æ•°æ®.</p><h4 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, <span class="built_in">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> list = Cons(<span class="number">1</span>, <span class="built_in">Box</span>::new(Cons(<span class="number">2</span>, <span class="built_in">Box</span>::new(Cons(<span class="number">3</span>, <span class="built_in">Box</span>::new(Nil))))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Rc"><a href="#Rc" class="headerlink" title="Rc"></a>Rc</h4><p>ä½ å¿…é¡»é€šè¿‡ä½¿ç”¨Rustç±»å‹Rc\<T>æ˜¾å¼åœ°å¯ç”¨å¤šé‡æ‰€æœ‰æƒï¼ŒRc\<T>æ˜¯å¼•ç”¨è®¡æ•°çš„ç¼©å†™ã€‚Rc\<T>ç±»å‹è·Ÿè¸ªå¯¹ä¸€ä¸ªå€¼çš„å¼•ç”¨æ¬¡æ•°ï¼Œä»¥ç¡®å®šè¯¥å€¼æ˜¯å¦ä»åœ¨ä½¿ç”¨ã€‚å¦‚æœå¯¹ä¸€ä¸ªå€¼çš„å¼•ç”¨ä¸ºé›¶ï¼Œåˆ™å¯ä»¥æ¸…é™¤è¯¥å€¼ï¼Œè€Œä¸ä¼šå¯¼è‡´ä»»ä½•å¼•ç”¨æ— æ•ˆã€‚</p><p>å½“<strong>æƒ³è¦åœ¨å †ä¸Šåˆ†é…ä¸€äº›æ•°æ®ä¾›ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†è¯»å–,å¹¶ä¸”åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå“ªä¸ªéƒ¨åˆ†å°†æœ€åä½¿ç”¨è¯¥æ•°æ®æ—¶</strong>,ä½¿ç”¨Rc\<T>ç±»å‹ã€‚<strong>å¦‚æœçŸ¥é“å“ªä¸€éƒ¨åˆ†å°†æœ€åå®Œæˆ,å°±å¯ä»¥å°†è¯¥éƒ¨åˆ†è®¾ç½®ä¸ºæ•°æ®çš„æ‰€æœ‰è€…,å¹¶ä¸”åœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡Œçš„æ­£å¸¸æ‰€æœ‰æƒè§„åˆ™å°†ç”Ÿæ•ˆã€‚</strong></p><p>æ³¨æ„ï¼Œ<strong>Rc\<T>ä»…ç”¨äºå•çº¿ç¨‹åœºæ™¯</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(<span class="built_in">i32</span>, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = Rc::new(Cons(<span class="number">5</span>, Rc::new(Cons(<span class="number">10</span>, Rc::new(Nil)))));</span><br><span class="line">    <span class="keyword">let</span> b = Cons(<span class="number">3</span>, Rc::clone(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> c = Cons(<span class="number">4</span>, Rc::clone(&amp;a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Rustä¸­ï¼Œ<code>Cell</code> æ˜¯æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªç±»å‹ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨å¯å˜å¼•ç”¨çš„é™åˆ¶ä¸‹å®‰å…¨åœ°æ›´æ–°æ•°æ®çš„æ–¹æ³•ã€‚<code>Cell</code> æ˜¯ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„ç±»å‹ï¼Œä¸»è¦ç”¨äºå•çº¿ç¨‹ç¯å¢ƒä¸‹çš„å¯å˜çŠ¶æ€ç®¡ç†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::Cell;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª Cell</span></span><br><span class="line">    <span class="keyword">let</span> count = Cell::new(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ get() è·å–å€¼</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Initial value: &#123;&#125;&quot;</span>, count.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ set() ä¿®æ”¹å€¼</span></span><br><span class="line">    count.set(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;New value: &#123;&#125;&quot;</span>, count.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Rc\<T>ä¸åŒï¼ŒRefCell\<T>ç±»å‹è¡¨ç¤ºå®ƒæ‰€æŒæœ‰çš„æ•°æ®çš„å•ä¸€æ‰€æœ‰æƒ.</p><p>é€šè¿‡å¼•ç”¨å’ŒBox\<T>ï¼Œå€Ÿç”¨è§„åˆ™çš„ä¸å˜é‡åœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡Œã€‚ä½¿ç”¨RefCell\<T>ï¼Œè¿™äº›<strong>ä¸å˜é‡åœ¨è¿è¡Œæ—¶å¼ºåˆ¶æ‰§è¡Œ</strong>ã€‚å¯¹äºå¼•ç”¨ï¼Œå¦‚æœè¿åäº†è¿™äº›è§„åˆ™ï¼Œå°±ä¼šå‡ºç°ç¼–è¯‘å™¨é”™è¯¯ã€‚å¯¹äºRefCell\<T>ï¼Œå¦‚æœä½ è¿åäº†è¿™äº›è§„åˆ™ï¼Œä½ çš„ç¨‹åºå°±ä¼španicå¹¶é€€å‡ºã€‚</p><blockquote><p>åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥æ›´å¿«åœ°æ•è·é”™è¯¯ï¼Œå¹¶ä¸”ä¸ä¼šå¯¹è¿è¡Œæ—¶æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œå› ä¸ºæ‰€æœ‰çš„åˆ†æéƒ½æ˜¯äº‹å…ˆå®Œæˆçš„ã€‚ç”±äºè¿™äº›åŸå› ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å€Ÿç”¨è§„åˆ™æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™æ˜¯Rustçš„é»˜è®¤å€¼ã€‚</p><p>åœ¨è¿è¡Œæ—¶æ£€æŸ¥å€Ÿé˜…è§„åˆ™çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ä¸å…è®¸çš„æƒ…å†µä¸‹ï¼Œå…è®¸æŸäº›å†…å­˜å®‰å…¨çš„åœºæ™¯ã€‚é™æ€åˆ†æå’ŒRustç¼–è¯‘å™¨ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¿å®ˆçš„ã€‚ä»£ç çš„ä¸€äº›å±æ€§æ˜¯ä¸å¯èƒ½é€šè¿‡åˆ†æä»£ç æ¥æ£€æµ‹çš„</p></blockquote><p>ä¸Rc\<T>ç±»ä¼¼ï¼ŒRefCell\<T>ä»…ç”¨äºå•çº¿ç¨‹åœºæ™¯ï¼Œå¦‚æœæ‚¨å°è¯•åœ¨å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨å®ƒï¼Œåˆ™ä¼šç»™æ‚¨ä¸€ä¸ªç¼–è¯‘æ—¶é”™è¯¯ã€‚(å°è¯•ä½¿ç”¨Mutexä»¥åŠArc)</p><h4 id="Arc"><a href="#Arc" class="headerlink" title="Arc"></a>Arc</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> counter = Arc::new(Mutex::new(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> handles = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> counter = Arc::clone(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> handle = thread::spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> num = counter.lock().unwrap();</span><br><span class="line"></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.push(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.join().unwrap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.lock().unwrap());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Weak"><a href="#Weak" class="headerlink" title="Weak"></a>Weak</h4><p>åŒc++ä¸­çš„weak_ptr,é¿å…å¾ªç¯å¼•ç”¨.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span> &#123;</span><br><span class="line">    value: <span class="built_in">i32</span>,</span><br><span class="line">    parent: RefCell&lt;Weak&lt;Node&gt;&gt;,</span><br><span class="line">    children: RefCell&lt;<span class="built_in">Vec</span>&lt;Rc&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> leaf = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">3</span>,</span><br><span class="line">        parent: RefCell::new(Weak::new()),</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[]),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;leaf parent = &#123;:?&#125;&quot;</span>, leaf.parent.borrow().upgrade());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> branch = Rc::new(Node &#123;</span><br><span class="line">        value: <span class="number">5</span>,</span><br><span class="line">        parent: RefCell::new(Weak::new()),</span><br><span class="line">        children: RefCell::new(<span class="built_in">vec!</span>[Rc::clone(&amp;leaf)]),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    *leaf.parent.borrow_mut() = Rc::downgrade(&amp;branch);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;leaf parent = &#123;:?&#125;&quot;</span>, leaf.parent.borrow().upgrade());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RefCell"><a href="#RefCell" class="headerlink" title="RefCell"></a>RefCell</h4><p>Rc\<T>å…è®¸åŒä¸€æ•°æ®çš„å¤šä¸ªæ‰€æœ‰è€…;Box\<T>å’ŒRefCell\<T>å…·æœ‰å•ä¸ªæ‰€æœ‰è€…ã€‚</p><p>Box\<T>å…è®¸åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ä¸å¯å˜æˆ–å¯å˜å€Ÿç”¨(æ„å‘³ç€åªæœ‰å•ä¸€è¯»å–å’Œä¿®æ”¹è€…,åŒæ—¶ä¹Ÿæ˜¯owner);Rc\<T>åªå…è®¸åœ¨ç¼–è¯‘æ—¶ä¸å¯å˜å€Ÿç”¨(ç›¸å½“äºå¯ä»¥æœ‰å¤šä¸ªå¯è¯»,ä¸èƒ½æ›´æ”¹å€¼,å¯ä»¥è€ƒè™‘æ­é…RefCellä¿®æ”¹);</p><p>RefCell\<T>å…è®¸åœ¨è¿è¡Œæ—¶æ£€æŸ¥ä¸å¯å˜æˆ–å¯å˜çš„å€Ÿç”¨ã€‚å› ä¸ºRefCell\<T>å…è®¸åœ¨è¿è¡Œæ—¶æ£€æŸ¥å¯å˜å€Ÿç”¨ï¼Œæ‰€ä»¥å³ä½¿RefCell\<T>æ˜¯ä¸å¯å˜çš„ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹å˜RefCell\<T>ä¸­çš„å€¼ã€‚</p><blockquote><p>å†…éƒ¨å¯å˜æ€§æ˜¯Rustä¸­çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸ä½ æ”¹å˜æ•°æ®ï¼Œå³ä½¿æ•°æ®æœ‰ä¸å¯å˜çš„å¼•ç”¨;</p><p>è¿™å°±æ˜¯ä½¿ç”¨RefCellçš„ç›®çš„.</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Messenger</span></span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, msg: &amp;<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">LimitTracker</span></span>&lt;<span class="symbol">&#x27;a</span>, T: Messenger&gt; &#123;</span><br><span class="line">    messenger: &amp;<span class="symbol">&#x27;a</span> T,</span><br><span class="line">    value: <span class="built_in">usize</span>,</span><br><span class="line">    max: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; LimitTracker&lt;<span class="symbol">&#x27;a</span>, T&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Messenger,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(messenger: &amp;<span class="symbol">&#x27;a</span> T, max: <span class="built_in">usize</span>) -&gt; LimitTracker&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">        LimitTracker &#123;</span><br><span class="line">            messenger,</span><br><span class="line">            value: <span class="number">0</span>,</span><br><span class="line">            max,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">set_value</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, value: <span class="built_in">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> percentage_of_max = <span class="keyword">self</span>.value <span class="keyword">as</span> <span class="built_in">f64</span> / <span class="keyword">self</span>.max <span class="keyword">as</span> <span class="built_in">f64</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">1.0</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger.send(<span class="string">&quot;Error: You are over your quota!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.9</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">&quot;Urgent warning: You&#x27;ve used up over 90% of your quota!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> percentage_of_max &gt;= <span class="number">0.75</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.messenger</span><br><span class="line">                .send(<span class="string">&quot;Warning: You&#x27;ve used up over 75% of your quota!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">MockMessenger</span></span> &#123;</span><br><span class="line">        sent_messages: RefCell&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;&gt;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; MockMessenger &#123;</span><br><span class="line">            MockMessenger &#123;</span><br><span class="line">                sent_messages: RefCell::new(<span class="built_in">vec!</span>[]),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">impl</span> Messenger <span class="keyword">for</span> MockMessenger &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fn</span> <span class="title">send</span></span>(&amp;<span class="keyword">self</span>, message: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.sent_messages.borrow_mut().push(<span class="built_in">String</span>::from(message));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">it_sends_an_over_75_percent_warning_message</span></span>() &#123;</span><br><span class="line">        <span class="comment">// --snip--</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert_eq!</span>(mock_messenger.sent_messages.borrow().len(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨RefCell\<T>çš„å¸¸è§æ–¹æ³•æ˜¯ä¸Rc\<T>ç»“åˆä½¿ç”¨ã€‚å›æƒ³ä¸€ä¸‹ï¼ŒRc\<T>å…è®¸æ‚¨æ‹¥æœ‰æŸäº›æ•°æ®çš„å¤šä¸ªæ‰€æœ‰è€…ï¼Œä½†å®ƒåªæä¾›å¯¹è¯¥æ•°æ®çš„ä¸å¯å˜è®¿é—®ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªRc\<T>æŒæœ‰ä¸€ä¸ªRefCell\<T>ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå€¼ï¼Œå¯ä»¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼Œä½ å¯ä»¥æ”¹å˜</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æœ‰å¤šä¸ªowneræƒ…å†µä¸‹ä¿®æ”¹æ•°æ® ä½¿ç”¨Rcå’ŒRefCell</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span> &#123;</span><br><span class="line">    Cons(Rc&lt;RefCell&lt;<span class="built_in">i32</span>&gt;&gt;, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> value = Rc::new(RefCell::new(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> a = Rc::new(Cons(Rc::clone(&amp;value), Rc::new(Nil)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> b = Cons(Rc::new(RefCell::new(<span class="number">3</span>)), Rc::clone(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> c = Cons(Rc::new(RefCell::new(<span class="number">4</span>)), Rc::clone(&amp;a));</span><br><span class="line"></span><br><span class="line">    *value.borrow_mut() += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a after = &#123;a:?&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b after = &#123;b:?&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;c after = &#123;c:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹,æ²¡æœ‰ç‰¹åˆ«æƒ…å†µå¯ä»¥ä½¿ç”¨Box,ç±»ä¼¼äºc++ä¸­unique_ptr,Rcç±»ä¼¼äºshared_ptr.</p><p>Arcå’ŒMutexç”¨äºå¤šçº¿ç¨‹æƒ…å†µ. RefCellæœ¬èº«æ˜¯è¿è¡Œæ—¶æ”¹å˜å€Ÿç”¨å¯å˜æ€§,åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨.</p><h4 id="Trait-å¯¹æ¯”Concept-in-C-20"><a href="#Trait-å¯¹æ¯”Concept-in-C-20" class="headerlink" title="Trait å¯¹æ¯”Concept in C++20"></a>Trait å¯¹æ¯”Concept in C++20</h4><p>Rustä¸­traitä¸æ³›å‹ç»“åˆå¾ˆå¥½,åŒæ—¶ç”±äºRustæ²¡æœ‰ç±»çš„ç»§æ‰¿,å¯ä»¥è€ƒè™‘ä½¿ç”¨æ³›å‹ç»§æ‰¿å’Œç»„åˆå®ç°ç±»ä¼¼æ•ˆæœ. å¯ä»¥<strong>ä½¿ç”¨<code>:</code>ä»¥åŠwhereå’Œ<code>+</code>æ­é…å¯ä»¥å¯¹traitçš„ç»§æ‰¿ä»¥åŠå¯¹æ³›å‹çš„é™åˆ¶è¿›è¡Œæè¿°</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> train walk &#123;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">xxx</span></span>();</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">yy</span></span>()&#123;<span class="built_in">println!</span>(<span class="string">&quot;&quot;</span>)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">zzz</span></span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">run</span></span>:walk &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">ttt</span></span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">func</span></span>(s:<span class="keyword">dyn</span> run)&#123;&#125;</span><br><span class="line"><span class="comment">// é™åˆ¶ç»“æ„çš„æ³›å‹</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Hi</span></span>&lt;T:run&gt; &#123;</span><br><span class="line">  T:value</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®ç°ç»“æ„çš„trait</span></span><br><span class="line"><span class="keyword">impl</span> walk <span class="keyword">for</span> Hi&lt;T&gt; <span class="keyword">where</span> T:walk &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤–traitä¹Ÿå¯ä»¥å†™æ³›å‹(è¿™åœ¨c++ä¸­å¾€å¾€æ˜¯å¸¸è§è¡Œä¸º). traitåœ¨ç»§æ‰¿æ—¶ä½¿ç”¨<code>:</code>å’Œ<code>+</code>,åœ¨æ³›å‹ä½¿ç”¨æ—¶ä½¿ç”¨<code>:</code>æˆ–<code>where</code>,<code>+</code>.</p><p>åœ¨c++ä¸­conceptæ›´åå‘äºé™åˆ¶æ³›å‹,è€Œrustä¸­traitè¿˜æœ‰æ¥å£çš„å«ä¹‰(é€šè¿‡å®ç°æ¥å£è€Œä¸æ˜¯ç»§æ‰¿æ»¡è¶³è¦æ±‚).</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">concept</span> integral = std::is_integral&lt;T&gt;::value;</span><br></pre></td></tr></table></figure><p>å£°æ˜conceptå¦‚ä¸Š,æ­¤å¤–å¯ä»¥ä½¿ç”¨<code>&amp;&amp;</code>æ­é…,è¿˜å¯ä»¥ä½¿ç”¨requires</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">concept</span> Addable = <span class="built_in"><span class="keyword">requires</span></span>(T a, T b) &#123; a + b; &#125;;  <span class="comment">// a + b å¯é€šè¿‡ç¼–è¯‘å³å¯</span></span><br></pre></td></tr></table></figure><ol><li><code>requires &#123; requirement-seq &#125;</code></li><li><code>requires ( parameter-list(optional) ) &#123; requirement-seq &#125;</code></li></ol><p><code>requirements-seq</code> å¯ä»¥æ˜¯ï¼šç®€å•è¦æ±‚ã€ç±»å‹è¦æ±‚ã€å¤åˆè¦æ±‚ã€åµŒå¥—è¦æ±‚.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="keyword">concept</span> Check = <span class="built_in"><span class="keyword">requires</span></span>(T a, T b) &#123;</span><br><span class="line">    &#123; a.<span class="built_in">clear</span>() &#125; <span class="keyword">noexcept</span>;  <span class="comment">// æ”¯æŒclear,ä¸”ä¸æŠ›å¼‚å¸¸</span></span><br><span class="line">    &#123; a + b &#125; <span class="keyword">noexcept</span>-&gt;std::same_as&lt;<span class="keyword">int</span>&gt;;  <span class="comment">// std::same_as&lt;decltype((a + b)), int&gt;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">concept</span> C =</span><br><span class="line">    <span class="built_in"><span class="keyword">requires</span></span>(T x) &#123;</span><br><span class="line">    &#123;*x&#125;;                                 <span class="comment">// *xæœ‰æ„ä¹‰</span></span><br><span class="line">    &#123; x + <span class="number">1</span> &#125; -&gt; std::same_as&lt;<span class="keyword">int</span>&gt;;       <span class="comment">// x + 1æœ‰æ„ä¹‰ä¸”std::same_as&lt;decltype((x + 1)), int&gt;ï¼Œå³x+1æ˜¯intç±»å‹</span></span><br><span class="line">    &#123; x * <span class="number">1</span> &#125; -&gt; std::convertible_to&lt;T&gt;;  <span class="comment">// x * 1 æœ‰æ„ä¹‰ä¸”std::convertible_to&lt; decltype((x *1),T&gt;ï¼Œå³x*1å¯è½¬å˜ä¸ºTç±»å‹</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="keyword">concept</span> Check = <span class="built_in"><span class="keyword">requires</span></span>(T a, T b) &#123;</span><br><span class="line">    <span class="keyword">requires</span> std::same_as&lt;<span class="keyword">decltype</span>((a + b)), <span class="keyword">int</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="keyword">concept</span> Check = <span class="built_in"><span class="keyword">requires</span></span>(T a, T b) &#123;</span><br><span class="line">    &#123; a + b &#125; -&gt; std::same_as&lt;<span class="keyword">int</span>&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œä½¿ç”¨conceptå¦‚ä¸‹,ä½¿ç”¨å’Œå®šä¹‰conceptæ—¶éƒ½å¯ä»¥ä½¿ç”¨requireså’Œ&amp;&amp;.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">requires</span> integral&lt;T&gt; </span></span><br><span class="line"><span class="function">T <span class="title">inc</span><span class="params">(T a)</span> </span>&#123; <span class="keyword">return</span> ++a; &#125; <span class="comment">// ä¸ªäººæ¨è</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">inc</span><span class="params">(T a)</span> <span class="keyword">requires</span> integral&lt;T&gt; </span>&#123; <span class="keyword">return</span> ++a; &#125; <span class="comment">//</span></span><br><span class="line"><span class="keyword">template</span> &lt;integral T&gt;</span><br><span class="line"><span class="function">T <span class="title">inc</span><span class="params">(T&amp; a)</span> </span>&#123; <span class="keyword">return</span> ++a; &#125; <span class="comment">//</span></span><br><span class="line"><span class="function">integral <span class="keyword">auto</span> <span class="title">inc</span><span class="params">(integral <span class="keyword">auto</span> a)</span> </span>&#123; <span class="keyword">return</span> ++a; &#125; <span class="comment">// æ³›å‹å‡½æ•° ä½¿ç”¨concepté™åˆ¶</span></span><br></pre></td></tr></table></figure><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>ä½œä¸ºååº•å±‚çš„ç¼–ç¨‹è¯­è¨€,c/c++,rust,zigç­‰ç›®å‰éƒ½è¿˜åœ¨å‘å±•,å³ä½¿c++å·²è¿‡äº”åå¹´,ä½†C++2aä¸­Concepts,Modules,Coroutines(åç¨‹)ç­‰æ–°ç‰¹æ€§éƒ½ä¸æ–­å‡ºç°(è™½ç„¶åœ¨å…¶ä»–è¯­è¨€ä¸­æ—©å°±æœ‰äº†),æ‰€ä»¥è¿˜æ˜¯åœ°ä½ä»åœ¨çš„.è€Œåä¸¤è€…åœ¨å‰ç«¯å·¥å…·æ„å»ºä¸Šå‡å¤§æ˜¾èº«æ‰‹,æœŸå¾…åç»­å‘å±•.</p><p>æˆ‘ä¹Ÿå¾ˆå–œæ¬¢ä½¿ç”¨C/C++,Go,Rustç­‰å†™ä¸€äº›å°ç¨‹åºdemo.</p><h3 id="FYI"><a href="#FYI" class="headerlink" title="FYI"></a>FYI</h3><p>ä¸€äº›è¯­è¨€é«˜çº§ç‰¹æ€§</p><ol><li><a href="https://draveness.me/metaprogramming/">è°ˆå…ƒç¼–ç¨‹ä¸è¡¨è¾¾èƒ½åŠ› - é¢å‘ä¿¡ä»°ç¼–ç¨‹ (draveness.me)</a></li><li><a href="https://mirrors.tuna.tsinghua.edu.cn/tuna/tunight/2020-04-25-generics-and-metaprogramming/slides.pdf">ä»æ³›å‹ (Generics) åˆ°å…ƒç¼–ç¨‹ (Metaprogramming) (tsinghua.edu.cn)</a></li></ol><p><img data-src="https://s2.loli.net/2024/06/29/5tfZJquDxgvKros.png" alt="image-20240629202803323"></p><p><img data-src="https://s2.loli.net/2024/06/29/gZaJPSIc5sdzM91.png" alt="image-20240629202943879"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Rustå®˜æ–¹æ¨èçš„ä¸‰ä¸ªèµ„æ–™,åˆ†åˆ«æ˜¯The Rust programming language,Rust by examplesä»¥åŠruslings,å·²ç»ç›¸å½“å……è¶³äº†.åŒ…æ‹¬ç›¸å¯¹å…¨é¢çš„ä¹¦,ä»£ç ä¾‹å­ä»¥åŠæ–¹ä¾¿çš„äº’åŠ¨å¼exercises.ä¸ªäººè§‰å¾—,the bookç›¸å½“äºå­—å…¸,è™½ç„¶å…¶å®è¿˜æœ‰å†…å®¹æ›´å¤šçš„reference,è€Œexamplesæ›´åŠ æ˜“æ‡‚ä¸Šæ‰‹,rustlingsç›¸å½“äºåˆ·é¢˜,æŠŠå…³é”®ä¸œè¥¿äº†è§£ä¸€é.&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ä»è¿™ä¸‰ä¸ªä¸œè¥¿å…¥æ‰‹å¼€å§‹Rustå­¦ä¹ ä¹‹æ—…,ä¸€äº›åœ°æ–¹ä¼šè·Ÿc++å¯¹æ¯”.&lt;br&gt;</summary>
    
    
    
    
    <category term="Rust" scheme="https://www.sekyoro.top/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ä¸åŒç¼–ç¨‹è¯­è¨€ä¹‹é—´çš„äº’æ“ä½œ</title>
    <link href="https://www.sekyoro.top/2024/06/25/%E4%B8%8D%E5%90%8C%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BA%92%E6%93%8D%E4%BD%9C/"/>
    <id>https://www.sekyoro.top/2024/06/25/%E4%B8%8D%E5%90%8C%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BA%92%E6%93%8D%E4%BD%9C/</id>
    <published>2024-06-25T02:55:48.000Z</published>
    <updated>2024-06-26T14:30:06.066Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>å½“é¡¹ç›®æ¯”è¾ƒå¤§æ¶‰åŠåˆ°å¤šé—¨ç¼–ç¨‹è¯­è¨€æ—¶ä¼šæœ‰è¿™ç§éœ€æ±‚.é€šå¸¸æ˜¯è¦æ±‚è°ƒç”¨C/C++ç­‰.<br>æŸäº›è¯­è¨€ä¹‹é—´ç›¸å¯¹æ¥è¯´è°ƒç”¨å°±æ¯”è¾ƒç®€å•,æ¯”å¦‚Goå’ŒC,Rustå’ŒCç­‰.ä½†æ˜¯å…¶ä»–è¯­è¨€ç›¸å¯¹æ¥è¯´å°±éº»çƒ¦äº†.æœ¬æ–‡ä¸»è¦æ¶‰åŠPython,JS,Javaå’ŒC/C+çš„äº’ç›¸è°ƒç”¨,ä»¥å¤‡ä¸æ—¶ä¹‹éœ€.</p><p>TL;DR:Pythonä½¿ç”¨pybind11,JSä½¿ç”¨emcc,Javaä½¿ç”¨JNI.<br><span id="more"></span></p><h2 id="Pythonå’ŒCæˆ–Cpp"><a href="#Pythonå’ŒCæˆ–Cpp" class="headerlink" title="Pythonå’ŒCæˆ–Cpp"></a>Pythonå’ŒCæˆ–Cpp</h2><h3 id="Pythonè°ƒç”¨C-Cpp"><a href="#Pythonè°ƒç”¨C-Cpp" class="headerlink" title="Pythonè°ƒç”¨C/Cpp"></a>Pythonè°ƒç”¨C/Cpp</h3><h4 id="Ctypes"><a href="#Ctypes" class="headerlink" title="Ctypes"></a>Ctypes</h4><p>ctypes æ˜¯Pythonçš„å¤–éƒ¨å‡½æ•°åº“ã€‚å®ƒæä¾›äº†ä¸ Cè¯­è¨€å…¼å®¹çš„æ•°æ®ç±»å‹ï¼Œå¹¶å…è®¸è°ƒç”¨ DLL æˆ–å…±äº«åº“ä¸­çš„å‡½æ•°ã€‚å¯ä½¿ç”¨è¯¥æ¨¡å—ä»¥çº¯ Python å½¢å¼å¯¹è¿™äº›åº“è¿›è¡Œå°è£…</p><p>å†™ä¸€ä¸ªcæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// func.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a*a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠ¨æ€åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc func.c -fPIC -shared -std=c99 -o func.so</span><br></pre></td></tr></table></figure><blockquote><p>-fPIC ä½œç”¨äºç¼–è¯‘é˜¶æ®µï¼Œå‘Šè¯‰ç¼–è¯‘å™¨äº§ç”Ÿ<strong>ä¸ä½ç½®æ— å…³ä»£ç </strong>(Position-Independent Code)ï¼Œåˆ™äº§ç”Ÿçš„ä»£ç ä¸­ï¼Œæ²¡æœ‰ç»å¯¹åœ°å€ï¼Œå…¨éƒ¨ä½¿ç”¨ç›¸å¯¹åœ°å€ï¼Œæ•…è€Œä»£ç å¯ä»¥è¢«åŠ è½½å™¨åŠ è½½åˆ°å†…å­˜çš„ä»»æ„ä½ç½®ï¼Œéƒ½å¯ä»¥æ­£ç¡®çš„æ‰§è¡Œã€‚è¿™æ­£æ˜¯å…±äº«åº“æ‰€è¦æ±‚çš„ï¼Œå…±äº«åº“è¢«åŠ è½½æ—¶ï¼Œåœ¨å†…å­˜çš„ä½ç½®ä¸æ˜¯å›ºå®šçš„ã€‚</p></blockquote><p>å¾—åˆ°åŠ¨æ€åº“åå°±èƒ½ç›´æ¥è°ƒç”¨äº†,æ³¨æ„åœ¨windowsä¸Š(å…¶å®æŒ‡çš„æ˜¯ä½¿ç”¨MSVCç”Ÿæˆdll)éœ€è¦ä½¿ç”¨<code>ctypes.WinDLL</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    f = cdll.LoadLibrary(<span class="string">&quot;./func.so&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(f.func(<span class="number">99</span>))</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•ç¼ºç‚¹æ˜¯æ˜¯èƒ½è°ƒç”¨ä¸€äº›å·²æœ‰çš„åŠ¨æ€åº“,ä¸”ä¸æ¶‰åŠå¤æ‚æ•°æ®ç»“æ„,åªèƒ½æ˜¯cè¯­è¨€.</p><h4 id="C-C-æ‰©å±•Python"><a href="#C-C-æ‰©å±•Python" class="headerlink" title="C/C++æ‰©å±•Python"></a>C/C++æ‰©å±•Python</h4><p>ä½¿ç”¨<code>Python.h</code>å¤´æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PY_MAJOR_VERSION &gt;= 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PyInt_Check PyLong_Check</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PyInt_AsLong PyLong_AsLong</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> PyObject* <span class="title">list_sum</span><span class="params">(PyObject *self, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PyObject *pList;</span><br><span class="line">    PyObject *pItem;</span><br><span class="line">    Py_ssize_t n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!PyArg_ParseTuple(args, <span class="string">&quot;O!&quot;</span>, &amp;PyList_Type, &amp;pList))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    n = PyList_Size(pList);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) &#123;</span><br><span class="line">        pItem = PyList_GetItem(pList, i);</span><br><span class="line">        <span class="keyword">if</span>(!PyInt_Check(pItem)) &#123;</span><br><span class="line">            PyErr_SetString(PyExc_TypeError, <span class="string">&quot;list items must be integers.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result += PyInt_AsLong(pItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Py_BuildValue(<span class="string">&quot;i&quot;</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> PyMethodDef methods[] = &#123;</span><br><span class="line">   &#123; <span class="string">&quot;sum&quot;</span>, (PyCFunction)list_sum, METH_VARARGS, <span class="string">&quot;sum method&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PyModuleDef</span> <span class="title">python_api_sum_module</span> =</span> &#123;</span><br><span class="line">    PyModuleDef_HEAD_INIT,</span><br><span class="line">    <span class="string">&quot;python_api_sum&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Python interface for the array sum&quot;</span>,</span><br><span class="line">    <span class="number">-1</span>,</span><br><span class="line">    methods</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">PyMODINIT_FUNC <span class="title">PyInit_python_api_sum</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> PyModule_Create(&amp;python_api_sum_module);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://docs.python.org/zh-cn/3/extending/extending.html">1. ä½¿ç”¨ C æˆ– C++ æ‰©å±• Python â€” Python 3.12.4 æ–‡æ¡£</a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -shared  -std=c99 -fPIC <span class="constructor">$(<span class="params">python3</span>-<span class="params">config</span> --<span class="params">includes</span>)</span> <span class="constructor">$(<span class="params">python3</span>-<span class="params">config</span> --<span class="params">ldflags</span>)</span> test.c -o test<span class="constructor">$(<span class="params">python3</span>-<span class="params">config</span> --<span class="params">extension</span>-<span class="params">suffix</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨windowsä¸Šæ¨èä½¿ç”¨msys2å·¥å…·ä¸‹è½½Mingwå·¥å…·é“¾,</p><h4 id="pybind11"><a href="#pybind11" class="headerlink" title="pybind11"></a>pybind11</h4><p>è¿™æ˜¯æœ€ç®€å•çš„æ–¹å¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pybind11</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i + j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PYBIND11_MODULE(example, m) &#123;</span><br><span class="line">    m.doc() = <span class="string">&quot;pybind11 example plugin&quot;</span>; <span class="comment">// optional module docstring</span></span><br><span class="line"></span><br><span class="line">    m.def(<span class="string">&quot;add&quot;</span>, &amp;add, <span class="string">&quot;A function that adds two numbers&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ç§æ–¹å¼æ³¨æ„gccä¸pythonç‰ˆæœ¬é—®é¢˜,ä¸¤è€…éƒ½éœ€è¦é€šè¿‡gcc/g++è®¿é—®å…¶ä¸‹çš„pythonçš„includeå’Œlibç›®å½•. æˆ‘åœ¨windowsä¸ŠMingwçš„pythonç‰ˆæœ¬å¤ªä½,æ¯”å¦‚<code>--extension-suffix</code>æ€»æ˜¯æŠ¥é”™,æˆ‘å»ºè®®ç›´æ¥åœ¨Linuxä¸Šå†™.</p><h3 id="C-Cppè°ƒç”¨Python"><a href="#C-Cppè°ƒç”¨Python" class="headerlink" title="C/Cppè°ƒç”¨Python"></a>C/Cppè°ƒç”¨Python</h3><h4 id="C-C-æ‰©å±•Python-1"><a href="#C-C-æ‰©å±•Python-1" class="headerlink" title="C/C++æ‰©å±•Python"></a>C/C++æ‰©å±•Python</h4><p>ç±»ä¼¼ä¸Šé¢çš„æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;Python.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(<span class="built_in">int</span> argc, char *argv[]) &#123;</span><br><span class="line">  // åˆå§‹åŒ–pythonè§£é‡Šå™¨.C/C++ä¸­è°ƒç”¨Pythonä¹‹å‰å¿…é¡»å…ˆåˆå§‹åŒ–è§£é‡Šå™¨</span><br><span class="line">  Py_Initialize();</span><br><span class="line">  // æ‰§è¡Œä¸€ä¸ªç®€å•çš„æ‰§è¡Œpythonè„šæœ¬å‘½ä»¤</span><br><span class="line">  PyRun_SimpleString(<span class="string">&quot;print(&#x27;hello world&#x27;)\n&quot;</span>);</span><br><span class="line">  PyRun_SimpleString(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">  PyRun_SimpleString(<span class="string">&quot;sys.path.append(&#x27;.&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">  PyObject* pModule = PyImport_ImportModule(<span class="string">&quot;sum&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>( pModule == NULL )&#123;</span><br><span class="line">        cout &lt;&lt;<span class="string">&quot;module not found&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    // <span class="number">4</span>ã€è°ƒç”¨å‡½æ•°</span><br><span class="line">    PyObject* pFunc = PyObject_GetAttrString(pModule, <span class="string">&quot;say&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>( !pFunc || !PyCallable_Check(pFunc))&#123;</span><br><span class="line">        cout &lt;&lt;<span class="string">&quot;not found function add_num&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    // </span><br><span class="line">    PyObject_CallObject(pFunc, NULL);</span><br><span class="line">  // æ’¤é”€Py_Initialize()å’Œéšåä½¿ç”¨Python/C APIå‡½æ•°è¿›è¡Œçš„æ‰€æœ‰åˆå§‹åŒ–</span><br><span class="line">  Py_Finalize();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Pybind"><a href="#Pybind" class="headerlink" title="Pybind"></a>Pybind</h4><p>åŒä¸Š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/embed.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  py::scoped_interpreter guard&#123;&#125;; </span><br><span class="line">  py::object sum = py::module_::<span class="built_in"><span class="keyword">import</span></span>(<span class="string">&quot;sum&quot;</span>);</span><br><span class="line">  py::object py_list_sum = sum.<span class="built_in">attr</span>(<span class="string">&quot;py_list_sum&quot;</span>);</span><br><span class="line">  <span class="keyword">int</span> result = <span class="built_in">py_list_sum</span>(std::vector&lt;<span class="keyword">int</span>&gt;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;).cast&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;py_list_sum([1,2,3,4,5]) result:&quot;</span> &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šè¿˜æœ‰æ›´å¤šæ–¹å¼,ä¸è¿‡ä¸Šé¢çš„å·²ç»è¶³å¤Ÿäº†,è¯¦ç»†çš„å¯ä»¥çœ‹çœ‹å…¶ä»–æ•™ç¨‹.</p><p><a href="https://www.hbblog.cn/python%26C%2B%2B/pythonå’ŒCçš„äº¤äº’/#32-pybind11python">ä¸€æ–‡æ€»ç»“Pythonå’ŒC/C++çš„äº¤äº’æ–¹å¼ - æµ·æ»¨çš„Blog (hbblog.cn)</a></p><p><a href="https://python3-cookbook-personal.readthedocs.io/zh-cn/latest/chapters/p15_c_extensions.html">ç¬¬åäº”ç« ï¼šCè¯­è¨€æ‰©å±• â€” python3-cookbook 2.0.0 æ–‡æ¡£ (python3-cookbook-personal.readthedocs.io)</a></p><p>è¿™é‡Œæ¨èpybindçš„æ–¹æ³•,ç›¸å¯¹åŠŸèƒ½æ›´å¼º,ä½¿ç”¨ä¹Ÿä¸å¤æ‚.</p><h2 id="JavaScriptå’ŒCæˆ–Cpp"><a href="#JavaScriptå’ŒCæˆ–Cpp" class="headerlink" title="JavaScriptå’ŒCæˆ–Cpp"></a>JavaScriptå’ŒCæˆ–Cpp</h2><h3 id="Jsè°ƒç”¨C-Cpp"><a href="#Jsè°ƒç”¨C-Cpp" class="headerlink" title="Jsè°ƒç”¨C/Cpp"></a>Jsè°ƒç”¨C/Cpp</h3><h4 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h4><p>å¯¹äºæµè§ˆå™¨ç«¯,è¿™åº”è¯¥æ˜¯æœ€é€šç”¨çš„æ–¹å¼äº†.ä½¿ç”¨Emscripten,å°†æºä»£ç è½¬ä¸ºassemblyæ ¼å¼é€šè¿‡æµè§ˆå™¨è°ƒç”¨.ä½†æ˜¯éœ€è¦æµè§ˆå™¨æ”¯æŒ. </p><p><a href="https://developer.mozilla.org/en-US/docs/WebAssembly/C_to_Wasm">Compiling a New C/C++ Module to WebAssembly - WebAssembly | MDN (mozilla.org)</a></p><p>æŒ‰ç…§å®˜ç½‘æ–¹å¼ä¸‹è½½å®‰è£…,</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc hello.c -s WASM=1 -o hello.html</span><br></pre></td></tr></table></figure><ul><li><code>-s WASM=1</code> â€” æŒ‡å®šæˆ‘ä»¬æƒ³è¦çš„ wasm è¾“å‡ºå½¢å¼ã€‚æœ€æ–°ç‰ˆemccé»˜è®¤ä¸º1,0è¡¨ç¤ºè¾“å‡ºasm.js</li><li><code>-o hello.html</code> â€” æŒ‡å®šè¿™ä¸ªé€‰é¡¹å°†ä¼šç”Ÿæˆ HTML é¡µé¢æ¥è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ wasm æ¨¡å—ï¼Œä»¥åŠç¼–è¯‘å’Œå®ä¾‹åŒ– wasm æ¨¡å—æ‰€éœ€è¦çš„â€œèƒ¶æ°´â€js ä»£ç ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ web ç¯å¢ƒä¸­ä½¿ç”¨äº†ã€‚</li></ul><p>è¿™ä¸ªæ—¶å€™åœ¨ä½ çš„æºç æ–‡ä»¶å¤¹åº”è¯¥æœ‰ä¸‹åˆ—æ–‡ä»¶ï¼š</p><ul><li><code>hello.wasm</code> äºŒè¿›åˆ¶çš„ wasm æ¨¡å—ä»£ç </li><li><code>hello.js</code> ä¸€ä¸ªåŒ…å«äº†ç”¨æ¥åœ¨åŸç”Ÿ C å‡½æ•°å’Œ JavaScript/wasm ä¹‹é—´è½¬æ¢çš„èƒ¶æ°´ä»£ç çš„ JavaScript æ–‡ä»¶</li><li><code>hello.html</code> ä¸€ä¸ªç”¨æ¥åŠ è½½ï¼Œç¼–è¯‘ï¼Œå®ä¾‹åŒ–ä½ çš„ wasm ä»£ç å¹¶ä¸”å°†å®ƒè¾“å‡ºåœ¨æµè§ˆå™¨æ˜¾ç¤ºä¸Šçš„ä¸€ä¸ª HTML æ–‡ä»¶</li></ul><p>ä½¿ç”¨ä¸€ä¸ªæ”¯æŒ WebAssembly çš„æµè§ˆå™¨ï¼ŒåŠ è½½ç”Ÿæˆçš„ <code>hello.html</code>ã€‚è‡ªä» Firefox ç‰ˆæœ¬ 52ã€Chrome ç‰ˆæœ¬ 57 å’Œ Opera ç‰ˆæœ¬ 44 å¼€å§‹ï¼Œå·²ç»é»˜è®¤å¯ç”¨äº† WebAssembly(æ³¨æ„ä¸æ˜¯é€šè¿‡æ–‡ä»¶æ–¹å¼æ‰“å¼€)</p><p>ä¸Šé¢æ˜¯åœ¨htmlåŠ è½½åä¼šè°ƒç”¨mainå‡½æ•°ä¸­çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten/emscripten.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> EMSCRIPTEN_KEEPALIVE <span class="title">myFunction</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;æˆ‘çš„å‡½æ•°å·²è¢«è°ƒç”¨\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc -o hello3.html hello3.c -O3 -s WASM=1 -s <span class="string">&quot;EXPORTED_RUNTIME_METHODS=[&#x27;ccall&#x27;]&quot;</span> --shell-file html_template/shell_minimal.html</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å¯¼å…¥å‡½æ•°,é€šè¿‡è®¾ç½®EXPORTED_RUNTIME_METHODSå¯¼å‡ºccall,è€Œccallä¼šåœ¨ JS ä»£ç ä¹‹ä¸­è°ƒç”¨ C å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&lt;button class=&quot;mybutton&quot;&gt;è¿è¡Œæˆ‘çš„å‡½æ•°&lt;/button&gt; //html</span></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">&quot;.mybutton&quot;</span>).addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">&quot;æ£€æŸ¥æ§åˆ¶å°&quot;</span>);</span><br><span class="line">  <span class="keyword">var</span> result = Module.ccall(</span><br><span class="line">    <span class="string">&quot;myFunction&quot;</span>, <span class="comment">// name of C function</span></span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// return type</span></span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// argument types</span></span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">  ); <span class="comment">// arguments</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a href="https://ruanyifeng.com/blog/2017/09/asmjs_emscripten.html">asm.js å’Œ Emscripten å…¥é—¨æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)</a></p><p>emccæ—¢æ”¯æŒasm.jsä¹Ÿæ”¯æŒWASM,ä¸¤è€…éƒ½èƒ½å®ç°ç±»ä¼¼çš„æ•ˆæœ,ä¸è¿‡ç›®å‰è¿˜æ˜¯WASMé£å¤´æ­£åŠ²</p><h4 id="c-addons"><a href="#c-addons" class="headerlink" title="c++ addons"></a>c++ addons</h4><p><a href="https://nodejs.org/docs/v20.15.0/api/addons.html#c-addons">C++ addons | Node.js v20.15.0 Documentation (nodejs.org)</a></p><p>ä½¿ç”¨<code>node.h</code>å¤´æ–‡ä»¶å¹¶ä¸‹è½½node-gypç¼–è¯‘å¾—åˆ°åŠ¨æ€åº“,å†é€šè¿‡nodeè°ƒç”¨.</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;node.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> demo &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> v8::FunctionCallbackInfo;</span><br><span class="line"><span class="keyword">using</span> v8::Isolate;</span><br><span class="line"><span class="keyword">using</span> v8::Local;</span><br><span class="line"><span class="keyword">using</span> v8::Object;</span><br><span class="line"><span class="keyword">using</span> v8::<span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">using</span> v8::Value;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Method</span><span class="params">(<span class="keyword">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</span><br><span class="line">  Isolate* isolate = args.<span class="built_in">GetIsolate</span>();</span><br><span class="line">  args.<span class="built_in">GetReturnValue</span>().<span class="built_in">Set</span>(<span class="keyword">String</span>::<span class="built_in">NewFromUtf8</span>(</span><br><span class="line">      isolate, <span class="string">&quot;world&quot;</span>).<span class="built_in">ToLocalChecked</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Initialize</span><span class="params">(Local&lt;Object&gt; exports)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">NODE_SET_METHOD</span>(exports, <span class="string">&quot;hello&quot;</span>, Method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NODE_MODULE</span>(NODE_GYP_MODULE_NAME, Initialize)</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace demo</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¹Ÿè¦æ³¨æ„ä½¿ç”¨çš„ç¼–è¯‘å™¨,æˆ‘åœ¨windowsä¸Šé»˜è®¤ä½¿ç”¨visual studio,éœ€è¦åç¼€.cpp.</p><p>åˆ›å»ºbinding.gyp,ç„¶åä½¿ç”¨node-gyp</p><figure class="highlight gyp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;targets&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;target_name&#x27;</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;sources&#x27;</span>: [ </span><br><span class="line">                <span class="string">&#x27;src/hello.cc&#x27;</span>,</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node-gyp configure</span><br><span class="line">node-gyp build</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘åå¾—åˆ°.nodeæ–‡ä»¶ä½¿ç”¨jsè°ƒç”¨å³å¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&#x27;./build/Release/addon.node&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&#x27;./build/Debug/addon.node&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Native-abstractions-for-Node-js"><a href="#Native-abstractions-for-Node-js" class="headerlink" title="Native abstractions for Node.js"></a>Native abstractions for Node.js</h4><p>Node-API æ˜¯ç”¨äºæ„å»ºnative addonsçš„ APIã€‚å®ƒ<strong>ç‹¬ç«‹äºåº•å±‚ JavaScript è¿è¡Œæ—¶</strong>ï¼ˆå¦‚ V8ï¼‰ï¼Œå¹¶ä½œä¸º Node.js è‡ªèº«çš„ä¸€éƒ¨åˆ†è¿›è¡Œç»´æŠ¤ã€‚è¯¥ API åœ¨ä¸åŒç‰ˆæœ¬çš„ Node.js ä¸­å…·æœ‰ç¨³å®šçš„åº”ç”¨äºŒè¿›åˆ¶æ¥å£ (ABI)<strong>ã€‚å…¶ç›®çš„æ˜¯ä½¿é™„åŠ ç»„ä»¶ä¸å—åº•å±‚ JavaScript å¼•æ“å˜åŒ–çš„å½±å“</strong>ï¼Œå¹¶å…è®¸ä¸ºæŸä¸€ç‰ˆæœ¬ç¼–è¯‘çš„æ¨¡å—æ— éœ€é‡æ–°ç¼–è¯‘å³å¯åœ¨ä»¥åç‰ˆæœ¬çš„ Node.js ä¸Šè¿è¡Œã€‚addonsä½¿ç”¨node-gyp ç­‰æ„å»º/æ‰“åŒ…ã€‚</p><p><a href="https://nodejs.org/docs/v20.15.0/api/addons.html#native-abstractions-for-nodejs">C++ addons | Node.js v20.15.0 Documentation (nodejs.org)</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.cc using Node-API</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;node_api.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> demo &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">napi_value <span class="title">Method</span><span class="params">(napi_env env, napi_callback_info args)</span> </span>&#123;</span><br><span class="line">  napi_value greeting;</span><br><span class="line">  napi_status status;</span><br><span class="line"></span><br><span class="line">  status = <span class="built_in">napi_create_string_utf8</span>(env, <span class="string">&quot;world&quot;</span>, NAPI_AUTO_LENGTH, &amp;greeting);</span><br><span class="line">  <span class="keyword">if</span> (status != napi_ok) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">return</span> greeting;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">napi_value <span class="title">init</span><span class="params">(napi_env env, napi_value exports)</span> </span>&#123;</span><br><span class="line">  napi_status status;</span><br><span class="line">  napi_value fn;</span><br><span class="line"></span><br><span class="line">  status = <span class="built_in">napi_create_function</span>(env, <span class="literal">nullptr</span>, <span class="number">0</span>, Method, <span class="literal">nullptr</span>, &amp;fn);</span><br><span class="line">  <span class="keyword">if</span> (status != napi_ok) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  status = <span class="built_in">napi_set_named_property</span>(env, exports, <span class="string">&quot;hello&quot;</span>, fn);</span><br><span class="line">  <span class="keyword">if</span> (status != napi_ok) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">return</span> exports;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NAPI_MODULE</span>(NODE_GYP_MODULE_NAME, init)</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace demo</span></span><br></pre></td></tr></table></figure><p>å¥½å¤„æ˜¯å…¼å®¹æ€§æ›´é«˜,apiçœ‹èµ·æ¥ä¹Ÿæ›´æ˜“æ‡‚.</p><h3 id="C-Cppè°ƒç”¨Js"><a href="#C-Cppè°ƒç”¨Js" class="headerlink" title="C/Cppè°ƒç”¨Js"></a>C/Cppè°ƒç”¨Js</h3><h4 id="C-addons"><a href="#C-addons" class="headerlink" title="C addons"></a>C addons</h4><p>åŒä¸Š,å¯ä»¥è€ƒè™‘ä½¿ç”¨å›è°ƒç­‰æ–¹æ³•åœ¨cä¸­è°ƒç”¨js.</p><p><a href="https://ruanyifeng.com/blog/2017/09/asmjs_emscripten.html">asm.js å’Œ Emscripten å…¥é—¨æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)</a></p><p>å¦‚æœæ˜¯nodeé‚£å°±æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä½¿ç”¨addons(äº‹å®ä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨Emscripteè½¬ä¸ºasm.jsè¿›è¡Œè°ƒç”¨),å¦‚æœæ˜¯æµè§ˆå™¨,é‚£æ¨èä½¿ç”¨WASM,é™¤èƒ½è½¬æ¢c/c++ä¹‹å¤–è¿˜æœ‰Rustç­‰,åœ¨å‰ç«¯ä¹Ÿæ˜¯æœ‰å‰æ™¯çš„æŠ€æœ¯ä¹‹ä¸€.<a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_Wasm#ç¼–è¯‘_emscripten">Emscripten</a></p><p>é€šè¿‡asm.jsè°ƒç”¨c++ä»£ç ,æ–¹æ³•ç±»ä¼¼,ç›®å‰emccçš„WASMé»˜è®¤ä¸º1ä¹Ÿå°±æ˜¯é»˜è®¤ç”ŸæˆWASM,ä½†ä½¿ç”¨æ—¶é€šè¿‡ä¸‹é¢å‘½ä»¤å¾—åˆ°asm.js</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emcc index.cpp -s <span class="string">&quot;EXPORTED_FUNCTIONS=[â€˜_mainâ€™,&#x27;_myFunction&#x27;]&quot;</span> -s WASM=0 -s EXPORTED_RUNTIME_METHODS=<span class="string">&quot;[&#x27;ccall&#x27;]&quot;</span> -o index.js</span><br></pre></td></tr></table></figure><p>åœ¨jsæ–‡ä»¶ä¸­è°ƒç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="built_in">module</span> = <span class="built_in">require</span>(<span class="string">&quot;./output.js&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> resulst = <span class="built_in">module</span>.onRuntimeInitialized(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="built_in">module</span>.ccall(<span class="string">&#x27;myFunction&#x27;</span>,&#123;</span><br><span class="line"><span class="literal">null</span>, <span class="comment">// return type</span></span><br><span class="line"><span class="literal">null</span>, <span class="comment">// argument type</span></span><br><span class="line"><span class="literal">null</span>, <span class="comment">// arguments</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>asm.js çš„æŠ€æœ¯èƒ½å°† C / C++ è½¬æˆ JS å¼•æ“å¯ä»¥è¿è¡Œçš„ä»£ç ã€‚é‚£ä¹ˆå®ƒä¸ WASMæœ‰ä½•åŒºåˆ«å‘¢ï¼Ÿ</p><p>å›ç­”æ˜¯ï¼Œä¸¤è€…çš„åŠŸèƒ½åŸºæœ¬ä¸€è‡´ï¼Œå°±æ˜¯è½¬å‡ºæ¥çš„ä»£ç ä¸ä¸€æ ·<strong>ï¼šasm.js æ˜¯æ–‡æœ¬ï¼ŒWebAssembly æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç </strong>ï¼Œå› æ­¤è¿è¡Œé€Ÿåº¦æ›´å¿«ã€ä½“ç§¯æ›´å°ã€‚ä»é•¿è¿œæ¥çœ‹ï¼ŒWebAssembly çš„å‰æ™¯æ›´å…‰æ˜ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ asm.js è‚¯å®šä¼šè¢«æ·˜æ±°ï¼Œå› ä¸ºå®ƒæœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼šé¦–å…ˆï¼Œå®ƒæ˜¯æ–‡æœ¬ï¼Œäººç±»å¯è¯»ï¼Œæ¯”è¾ƒç›´è§‚ï¼›å…¶æ¬¡ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ asm.jsï¼Œä¸ä¼šæœ‰å…¼å®¹æ€§é—®é¢˜ã€‚</p></blockquote><h2 id="Javaå’ŒCæˆ–Cpp"><a href="#Javaå’ŒCæˆ–Cpp" class="headerlink" title="Javaå’ŒCæˆ–Cpp"></a>Javaå’ŒCæˆ–Cpp</h2><p>Javaè°ƒç”¨C/Cppæœ‰å¤šç§æ–¹å¼,è¿™é‡Œåªä»‹ç»ä¸€ç§.</p><p>JNI,é€šè¿‡nativeå£°æ˜</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"><span class="comment">//TIP To &lt;b&gt;Run&lt;/b&gt; code, press &lt;shortcut actionId=&quot;Run&quot;/&gt; or</span></span><br><span class="line"><span class="comment">// click the &lt;icon src=&quot;AllIcons.Actions.Execute&quot;/&gt; icon in the gutter.</span></span><br><span class="line">public <span class="keyword">class</span> Main &#123;</span><br><span class="line">    public native void say<span class="constructor">Hello()</span>;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line"><span class="comment">//        System.load(&quot;./sayHello.dll&quot;);</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>load<span class="constructor">Library(<span class="string">&quot;sayHello&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="string">&quot;Hi&quot;</span>);</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>get<span class="constructor">Property(<span class="string">&quot;java.library.path&quot;</span>)</span>);</span><br><span class="line">        Main m = <span class="keyword">new</span> <span class="constructor">Main()</span>;</span><br><span class="line">        m.say<span class="constructor">Hello()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>javac -h ./ Main.java</code>è½¬ä¸ºå¤´æ–‡ä»¶,å†…å®¹å¦‚ä¸‹</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class org_example_Main */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_org_example_Main</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_org_example_Main</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     org_example_Main</span></span><br><span class="line"><span class="comment"> * Method:    sayHello</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_example_Main_sayHello</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åå†™ä¸€ä¸ªcppå»å®ç°æ–¹æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;org_example_Main.h&quot;</span></span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_example_Main_sayHello</span><span class="params">(JNIEnv *, jobject)</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;Hello im from cpp&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç”Ÿæˆdllæ–‡ä»¶,æ³¨æ„å¤´æ–‡ä»¶è¦æœ‰jdkä¸­çš„å¤´æ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -Wall -shared -fPIC -IC:/Users/proanimer/.jdks/openjdk-22.0.1/include -IC:/Users/proanimer/.jdks/openjdk-22.0.1/include/win32 sayHello.cpp -o sayHello.dll</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„dllæ–‡ä»¶å°±èƒ½è¢«<code>`System.loadLibrary</code>åŠ è½½äº†,ä½†æ³¨æ„dllæ–‡ä»¶æ”¾çš„ä½ç½®,ä¼šå»ç¯å¢ƒå˜é‡ä¸­çš„PATHå»æ‰¾,å¦‚æœç›´æ¥æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹æ²¡æœ‰é¢å¤–è®¾ç½®æ˜¯æ²¡æœ‰å¯¼å…¥çš„.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="comment">//TIP To &lt;b&gt;Run&lt;/b&gt; code, press &lt;shortcut actionId=&quot;Run&quot;/&gt; or</span></span><br><span class="line"><span class="comment">// click the &lt;icon src=&quot;AllIcons.Actions.Execute&quot;/&gt; icon in the gutter.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;sayHello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hi&quot;</span>);</span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.library.path&quot;</span>));</span><br><span class="line">        Main m = <span class="keyword">new</span> Main();</span><br><span class="line">        m.sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡classæ‰“åŒ…ä¸ºjarråŒ…,ç„¶åç›´æ¥è°ƒç”¨jaråŒ…(jaråŒ…éœ€è¦è°ƒç”¨dll)å³å¯.</p><ol><li><code>java -jar &lt;jarfile&gt;</code>: è¿è¡ŒæŒ‡å®šçš„ Java å½’æ¡£æ–‡ä»¶(JAR æ–‡ä»¶)ã€‚</li><li><code>java -cp &lt;classpath&gt; &lt;main-class&gt;</code>: æŒ‡å®šç±»è·¯å¾„å¹¶è¿è¡ŒæŒ‡å®šçš„ä¸»ç±»ã€‚</li><li><code>java -D&lt;property&gt;=&lt;value&gt;</code>: è®¾ç½® Java ç³»ç»Ÿå±æ€§ã€‚</li><li><code>java -verbose</code>: å¼€å¯è¯¦ç»†è¾“å‡ºæ¨¡å¼ã€‚</li><li><code>java -version</code>: æ˜¾ç¤º Java ç‰ˆæœ¬ä¿¡æ¯ã€‚</li><li><code>java -help</code>: æ˜¾ç¤º Java å‘½ä»¤è¡Œå¸®åŠ©ã€‚</li></ol><p>å…¶ä»–æ–¹æ³•å¯ä»¥çœ‹çœ‹<a href="https://blog.csdn.net/giveaname/article/details/106615257">JNA â€”â€” Javaè°ƒç”¨C/C++åŠ¨æ€åº“_jnaè°ƒç”¨c++ç±»-CSDNåšå®¢</a></p><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://blog.csdn.net/weixin_43552133/article/details/128377535">gccç”Ÿæˆé™æ€åº“ä¸åŠ¨æ€åº“ï¼ˆé™„å¸¦ä½¿ç”¨æ–¹æ³•ï¼‰_gcc ç”Ÿæˆé™æ€åº“-CSDNåšå®¢</a></li><li><a href="https://www.runoob.com/w3cnote/cpp-static-library-and-dynamic-library.html">C++é™æ€åº“ä¸åŠ¨æ€åº“ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å½“é¡¹ç›®æ¯”è¾ƒå¤§æ¶‰åŠåˆ°å¤šé—¨ç¼–ç¨‹è¯­è¨€æ—¶ä¼šæœ‰è¿™ç§éœ€æ±‚.é€šå¸¸æ˜¯è¦æ±‚è°ƒç”¨C/C++ç­‰.&lt;br&gt;æŸäº›è¯­è¨€ä¹‹é—´ç›¸å¯¹æ¥è¯´è°ƒç”¨å°±æ¯”è¾ƒç®€å•,æ¯”å¦‚Goå’ŒC,Rustå’ŒCç­‰.ä½†æ˜¯å…¶ä»–è¯­è¨€ç›¸å¯¹æ¥è¯´å°±éº»çƒ¦äº†.æœ¬æ–‡ä¸»è¦æ¶‰åŠPython,JS,Javaå’ŒC/C+çš„äº’ç›¸è°ƒç”¨,ä»¥å¤‡ä¸æ—¶ä¹‹éœ€.&lt;/p&gt;
&lt;p&gt;TL;DR:Pythonä½¿ç”¨pybind11,JSä½¿ç”¨emcc,Javaä½¿ç”¨JNI.&lt;br&gt;</summary>
    
    
    
    
    <category term="programming" scheme="https://www.sekyoro.top/tags/programming/"/>
    
  </entry>
  
  <entry>
    <title>å‡½æ•°å¼ç¼–ç¨‹ä»‹ç»ä¸å…¥é—¨</title>
    <link href="https://www.sekyoro.top/2024/06/23/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%85%A5%E9%97%A8/"/>
    <id>https://www.sekyoro.top/2024/06/23/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%85%A5%E9%97%A8/</id>
    <published>2024-06-23T12:21:01.000Z</published>
    <updated>2024-06-28T04:08:28.489Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä¹‹å‰åœ¨çœ‹å…¶ä»–äººäº¤æµå¸–å­çš„æ—¶å€™æåˆ°å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹æå‡æ€ç»´(è™½ç„¶æ„Ÿè§‰æœ‰ç‚¹å¤§è‚†å®£ä¼ çš„æ„Ÿè§‰),ä½†çœ‹äº†ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„ä¾‹å­,æ„Ÿè§‰åœ¨æ•°æ®å¤„ç†å’Œå¤šçº¿ç¨‹ä¸Šæœ‰ç‹¬ç‰¹çš„æ•ˆæœ,å¦‚æœä½¿ç”¨é¢å‘å¯¹è±¡,é‚£å°±ä¼šå˜å¾—æ¯”è¾ƒéº»çƒ¦,æ‰€ä»¥è¿™é‡Œä»…ä½œç®€å•ä»‹ç».<br><span id="more"></span><br>ä¸ªäººè®¤ä¸º,å‡½å¼ç¼–ç¨‹æ˜¯ä¸€ç§æ€æƒ³,è€Œä¸æ˜¯å…·ä½“æŸç§å·¥å…·. C++å¯ä»¥è¿›è¡Œå‡½æ•°å¼ç¼–ç¨‹,Javaä¹Ÿå¯ä»¥,åªä¸è¿‡çœ‹æ”¯æŒç¨‹åº¦è€Œå·².<strong>ç°ä»£çš„ç¼–ç¨‹è¯­è¨€å·²ç»æŠŠå‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³èå…¥è¿›å»äº†</strong> .</p><p>ä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹å‘¢ï¼Ÿåœ¨ç½‘ä¸Šä½ å¯ä»¥çœ‹åˆ°å¾ˆå¤šå®šä¹‰ï¼Œä½†å¤§éƒ½ç¦»ä¸å¼€è¿™äº›ç‰¹æ€§ã€‚</p><ul><li><strong>First Class</strong> å‡½æ•°ï¼šå‡½æ•°å¯ä»¥è¢«åº”ç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å½“ä½œæ•°æ®ã€‚</li><li><strong>Pure</strong> çº¯å‡½æ•°ï¼Œæ— å‰¯ä½œç”¨ï¼šä»»æ„æ—¶åˆ»ä»¥ç›¸åŒå‚æ•°è°ƒç”¨å‡½æ•°ä»»æ„æ¬¡æ•°å¾—åˆ°çš„ç»“æœéƒ½ä¸€æ ·ã€‚</li><li><strong>Referential Transparency</strong> å¼•ç”¨é€æ˜ï¼šå¯ä»¥è¢«è¡¨è¾¾å¼æ›¿ä»£ã€‚</li><li><strong>Expression</strong> åŸºäºè¡¨è¾¾å¼ï¼šè¡¨è¾¾å¼å¯ä»¥è¢«è®¡ç®—ï¼Œä¿ƒè¿›æ•°æ®æµåŠ¨ï¼ŒçŠ¶æ€å£°æ˜å°±åƒæ˜¯ä¸€ä¸ªæš‚åœï¼Œå¥½åƒæ•°æ®åˆ°è¿™é‡Œå°±ä¼šåœæ»äº†ä¸€ä¸‹ã€‚</li><li><strong>Immutable</strong> ä¸å¯å˜æ€§ï¼šå‚æ•°ä¸å¯è¢«ä¿®æ”¹ã€å˜é‡ä¸å¯è¢«ä¿®æ”¹â€”å®å¯ç‰ºç‰²æ€§èƒ½ï¼Œä¹Ÿè¦äº§ç”Ÿæ–°çš„æ•°æ®ï¼ˆRustå†…å­˜æ¨¡å‹ä¾‹å¤–ï¼‰ã€‚</li><li><strong>High Order Function</strong> å¤§é‡ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼šå˜é‡å­˜å‚¨ã€é—­åŒ…åº”ç”¨ã€å‡½æ•°é«˜åº¦å¯ç»„åˆã€‚</li><li><strong>Curry</strong> æŸ¯é‡ŒåŒ–ï¼šå¯¹å‡½æ•°è¿›è¡Œé™ç»´ï¼Œæ–¹ä¾¿è¿›è¡Œç»„åˆã€‚</li><li><strong>Composition</strong> å‡½æ•°ç»„åˆï¼šå°†å¤šä¸ªå•å‡½æ•°è¿›è¡Œç»„åˆï¼Œåƒæµæ°´çº¿ä¸€æ ·å·¥ä½œã€‚</li></ul><p>å¦å¤–è¿˜æœ‰ä¸€äº›ç‰¹æ€§ï¼Œæœ‰çš„ä¼šæåˆ°ï¼Œæœ‰çš„ä¸€ç¬”å¸¦è¿‡ï¼Œä½†å®é™…ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ€§ï¼ˆä»¥Haskellä¸ºä¾‹ï¼‰ã€‚</p><ul><li><strong>Type Inference</strong> ç±»å‹æ¨å¯¼ï¼šå¦‚æœæ— æ³•ç¡®å®šæ•°æ®çš„ç±»å‹ï¼Œé‚£å‡½æ•°æ€ä¹ˆå»ç»„åˆï¼Ÿï¼ˆå¸¸è§ï¼Œä½†éå¿…éœ€ï¼‰</li><li><strong>Lazy Evaluation</strong> æƒ°æ€§æ±‚å€¼ï¼šå‡½æ•°å¤©ç„¶å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œç¯å¢ƒï¼Œæƒ°æ€§æ±‚å€¼æ˜¯å¾ˆè‡ªç„¶çš„é€‰æ‹©ã€‚</li><li><strong>Side Effect</strong> IOï¼šä¸€ç§ç±»å‹ï¼Œç”¨äºå¤„ç†å‰¯ä½œç”¨ã€‚ä¸€ä¸ªä¸èƒ½æ‰§è¡Œæ‰“å°æ–‡å­—ã€ä¿®æ”¹æ–‡ä»¶ç­‰æ“ä½œçš„ç¨‹åºï¼Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ€»è¦æœ‰ä½ç½®å¤„ç†å‰¯ä½œç”¨ã€‚ï¼ˆè¾¹ç¼˜ï¼‰</li></ul><blockquote><p>å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€çš„ä¸€äº›æ ¸å¿ƒç‰¹ç‚¹,å¦‚ä¸å¯å˜æ•°æ®ã€é«˜é˜¶å‡½æ•°ã€æƒ°æ€§æ±‚å€¼ç­‰ã€‚å®ƒä»¬ä¸ºç°ä»£è½¯ä»¶å¼€å‘å¸¦æ¥äº†æ–°çš„ç¼–ç¨‹æ¨¡å¼å’Œæ€ç»´æ–¹å¼ã€‚<br>æœ¬è´¨ä¸Šï¼Œå‡½æ•°å¼ç¼–ç¨‹åªæ˜¯èŒƒç•´è®ºçš„è¿ç®—æ–¹æ³•ï¼Œè·Ÿæ•°ç†é€»è¾‘ã€å¾®ç§¯åˆ†ã€è¡Œåˆ—å¼æ˜¯åŒä¸€ç±»ä¸œè¥¿ï¼Œéƒ½æ˜¯æ•°å­¦æ–¹æ³•ï¼Œåªæ˜¯ç¢°å·§å®ƒèƒ½ç”¨æ¥å†™ç¨‹åºã€‚</p></blockquote><ul><li><p>æ•°æ®æ˜¯ä¸å¯å˜(immutable)çš„ï¼š å¦‚æœè¦æ›´æ”¹æ•°æ®ï¼ˆå¦‚æ•°ç»„ï¼‰ï¼Œéœ€è¦è¿”å›ä¸€ä¸ªåŒ…å«æ›´æ”¹å†…å®¹çš„æ–°æ•°ç»„ï¼Œè€Œä¸æ˜¯åŸæ¥çš„æ•°ç»„ã€‚</p></li><li><p>å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼š å‡½æ•°æ¯æ¬¡éƒ½åƒç¬¬ä¸€æ¬¡ä¸€æ ·è¿è¡Œï¼æ¢å¥è¯è¯´ï¼Œå¯¹äºç›¸åŒçš„å‚æ•°ï¼Œå‡½æ•°æ€»æ˜¯ç»™å‡ºç›¸åŒçš„è¿”å›å€¼ã€‚</p></li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ‚¨åº”è¯¥éµå¾ªä¸‰ä¸ªæœ€ä½³å®è·µï¼š</p><ol><li><strong>å‡½æ•°åº”è‡³å°‘æ¥å—ä¸€ä¸ªå‚æ•°ã€‚</strong></li><li><p><strong>å‡½æ•°åº”è¿”å›æ•°æ®æˆ–å¦ä¸€ä¸ªå‡½æ•°ã€‚</strong></p></li><li><p><strong>ä¸è¦ä½¿ç”¨å¾ªç¯</strong></p></li></ol><h3 id="å‡½æ•°ä¸€ç­‰å…¬æ°‘"><a href="#å‡½æ•°ä¸€ç­‰å…¬æ°‘" class="headerlink" title="å‡½æ•°ä¸€ç­‰å…¬æ°‘"></a>å‡½æ•°ä¸€ç­‰å…¬æ°‘</h3><ul><li>å‡½æ•°æ˜¯â€å¤´ç­‰å…¬æ°‘â€,å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’,è¿”å›å€¼,èµ‹å€¼ç»™å˜é‡ç­‰ã€‚</li><li>å…è®¸ç¼–å†™é«˜é˜¶å‡½æ•°,å¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œè¡¨è¾¾åŠ›ã€‚</li></ul><blockquote><p>å‡½æ•°æ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œä½ å¯ä»¥åƒå¯¹å¾…ä»»ä½•å…¶ä»–æ•°æ®ç±»å‹ä¸€æ ·å¯¹å¾…å®ƒä»¬â€”â€”æŠŠå®ƒä»¬å­˜åœ¨æ•°ç»„é‡Œï¼Œå½“ä½œå‚æ•°ä¼ é€’ï¼Œèµ‹å€¼ç»™å˜é‡â€¦ç­‰ç­‰ã€‚</p></blockquote><p>å…·ä½“æ¥è¯´,çœ‹çœ‹åˆ«äººçš„ä¾‹å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hi = <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Hi <span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> greeting = <span class="function"><span class="params">name</span> =&gt;</span> hi(name); <span class="comment">// æ²¡æœ‰å¿…è¦çš„æ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> greeting = hi; <span class="comment">// ç›¸åŒçš„ä½œç”¨</span></span><br><span class="line">greeting(<span class="string">&quot;times&quot;</span>); <span class="comment">// &quot;Hi times&quot;</span></span><br></pre></td></tr></table></figure><p>å†æ¥ä¸€ä¸ªä¾‹å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™è¡Œ</span></span><br><span class="line">ajaxCall(<span class="function"><span class="params">json</span> =&gt;</span> callback(json));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»·äºè¿™è¡Œ</span></span><br><span class="line">ajaxCall(callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‚£ä¹ˆï¼Œé‡æ„ä¸‹ getServerStuff</span></span><br><span class="line"><span class="keyword">const</span> getServerStuff = <span class="function"><span class="params">callback</span> =&gt;</span> ajaxCall(callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...å°±ç­‰äº</span></span><br><span class="line"><span class="keyword">const</span> getServerStuff = ajaxCall <span class="comment">// &lt;-- çœ‹ï¼Œæ²¡æœ‰æ‹¬å·å“¦</span></span><br></pre></td></tr></table></figure><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BlogController = &#123;</span><br><span class="line">  <span class="built_in">index</span>(posts) &#123; <span class="keyword">return</span> Views.<span class="built_in">index</span>(posts); &#125;,</span><br><span class="line">  show(<span class="keyword">post</span>) &#123; <span class="keyword">return</span> Views.show(<span class="keyword">post</span>); &#125;,</span><br><span class="line">  create(attrs) &#123; <span class="keyword">return</span> <span class="keyword">Db</span>.create(attrs); &#125;,</span><br><span class="line">  <span class="keyword">update</span>(<span class="keyword">post</span>, attrs) &#123; <span class="keyword">return</span> <span class="keyword">Db</span>.<span class="keyword">update</span>(<span class="keyword">post</span>, attrs); &#125;,</span><br><span class="line">  destroy(<span class="keyword">post</span>) &#123; <span class="keyword">return</span> <span class="keyword">Db</span>.destroy(<span class="keyword">post</span>); &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> BlogController = &#123;</span><br><span class="line">  index: Views.index,</span><br><span class="line">  show: Views.show,</span><br><span class="line">  create: <span class="keyword">Db</span>.create,</span><br><span class="line">  <span class="keyword">update</span>: <span class="keyword">Db</span>.<span class="keyword">update</span>,</span><br><span class="line">  destroy: <span class="keyword">Db</span>.destroy,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¿®æ”¹æœ‰ä»€ä¹ˆæ„ä¹‰?=&gt;é™¤äº†èŠ‚çœä»£ç ,å‡å°‘å†—ä½™ä¹‹å¤–,å¤–é¢çš„å‡½æ•°ä¿®æ”¹å,é‡Œé¢çš„å‡½æ•°å¯ä»¥ä¸ç”¨æ”¹äº†.è¿™ä¹Ÿå¢åŠ äº†å¯é‡ç”¨æ€§,è¯´åˆ°å¯é‡ç”¨æ€§,è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯åœ¨ä¸æ¶‰åŠåˆ°å…·ä½“ä¸šåŠ¡çš„å‡½æ•°ä¸Šå‘½ååº”è¯¥æ›´åŠ é€šç”¨.</p><p>å¦å¤–æ¶‰åŠåˆ°ç±»ä¼¼jsä¸­çš„thiså€¼æ—¶æœ€å¥½ä½¿ç”¨bind,applyç­‰ç»‘å®šé¿å…å‡ºé”™.</p><h3 id="çº¯å‡½æ•°"><a href="#çº¯å‡½æ•°" class="headerlink" title="çº¯å‡½æ•°"></a>çº¯å‡½æ•°</h3><p>çº¯å‡½æ•°(Pure Function)æ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹:</p><ol><li><strong>æ— å‰¯ä½œç”¨(No Side Effects)</strong>:<ul><li><strong>çº¯å‡½æ•°ä¸ä¼šä¿®æ”¹å‡½æ•°å¤–éƒ¨çš„ä»»ä½•çŠ¶æ€</strong>,å¦‚å…¨å±€å˜é‡ã€I/Oæ“ä½œç­‰ã€‚</li><li><strong>åªä¾èµ–äºè¾“å…¥å‚æ•°</strong>,ä¸ä¼šäº§ç”Ÿæ„å¤–çš„è¾“å‡ºã€‚</li></ul></li><li><strong>ç¡®å®šæ€§(Deterministic)</strong>:<ul><li>å¯¹äºç›¸åŒçš„è¾“å…¥,çº¯å‡½æ•°æ€»æ˜¯è¿”å›ç›¸åŒçš„è¾“å‡ºã€‚</li><li>æ²¡æœ‰â€éšè—çš„â€ä¾èµ–æˆ–çŠ¶æ€ä¼šå½±å“å‡½æ•°çš„ç»“æœã€‚</li></ul></li><li><strong>å¯æµ‹è¯•æ€§(Testable)</strong>:<ul><li>çº¯å‡½æ•°æ˜“äºå•å…ƒæµ‹è¯•,å› ä¸ºä¸éœ€è¦è€ƒè™‘å¤–éƒ¨ç¯å¢ƒçš„å½±å“ã€‚</li><li>å¯ä»¥ç‹¬ç«‹åœ°æµ‹è¯•æ¯ä¸ªå‡½æ•°,ä¸ä¼šå—åˆ°å…¶ä»–å‡½æ•°çš„å¹²æ‰°ã€‚</li></ul></li><li><strong>å¯ç»„åˆæ€§(Composable)</strong>:<ul><li>çº¯å‡½æ•°å¯ä»¥è¢«è½»æ¾åœ°ç»„åˆæˆæ›´å¤æ‚çš„åŠŸèƒ½ã€‚</li><li>å‡½æ•°çš„è¾“å‡ºå¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„è¾“å…¥,å½¢æˆç®¡é“å¼çš„æ•°æ®å¤„ç†ã€‚</li></ul></li><li><strong>å¹¶å‘æ€§(Concurrency)</strong>:<ul><li>ç”±äºæ²¡æœ‰å‰¯ä½œç”¨,çº¯å‡½æ•°å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘æ‰§è¡Œã€‚</li><li>ä¸éœ€è¦æ‹…å¿ƒç«äº‰æ¡ä»¶å’ŒåŒæ­¥é—®é¢˜ã€‚</li></ul></li></ol><p>é€šå¸¸æˆ‘ä»¬å®šä¹‰è¾“å…¥è¾“å‡ºï¼ˆIOï¼‰æ˜¯ä¸çº¯çš„ï¼Œå› ä¸º<strong>IOæ“ä½œä¸ä»…æ“ä½œäº†æ•°æ®ï¼Œè¿˜æ“ä½œäº†è¿™ä¸ªæ•°æ®èŒƒç•´å¤–éƒ¨çš„ä¸–ç•Œï¼Œæ¯”å¦‚æ‰“å°ã€æ’­æ”¾å£°éŸ³ã€ä¿®æ”¹å˜é‡çŠ¶æ€ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚è¿™äº›æ“ä½œå¹¶ä¸æ˜¯è¯´å¯¹ç¨‹åºé€ æˆäº†ç ´åï¼Œç›¸åï¼Œä¸€ä¸ªå®Œæ•´çš„ç¨‹åºä¸€å®šæ˜¯éœ€è¦å®ƒä»¬çš„ï¼Œä¸ç„¶æˆ‘ä»¬çš„æ‰€æœ‰è®¡ç®—éƒ½å°†æ¯«æ— æ„ä¹‰</strong>ã€‚</p><p>ä½†çº¯å‡½æ•°æ˜¯å¯é¢„æµ‹çš„ï¼Œå¼•ç”¨é€æ˜çš„ï¼Œæˆ‘ä»¬å¸Œæœ›ä»£ç ä¸­æ›´å¤šåœ°å‡ºç°çº¯å‡½æ•°å¼çš„ä»£ç ï¼Œ<strong>è¿™æ ·çš„ä»£ç å¯ä»¥è¢«é¢„æµ‹ï¼Œå¯ä»¥è¢«è¡¨è¾¾å¼æ›¿æ¢ï¼Œè€Œæ›´å¤šåœ°æŠŠIOæ“ä½œæ”¾åˆ°ä¸€ä¸ªç»Ÿä¸€çš„ä½ç½®åšå¤„ç†</strong></p><blockquote><p><em>å‰¯ä½œç”¨</em>æ˜¯åœ¨è®¡ç®—ç»“æœçš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»ŸçŠ¶æ€çš„ä¸€ç§å˜åŒ–ï¼Œæˆ–è€…ä¸å¤–éƒ¨ä¸–ç•Œè¿›è¡Œçš„<em>å¯è§‚å¯Ÿçš„äº¤äº’</em>ã€‚</p></blockquote><p>æ­¤å¤–ä¼šå¯¹è¾“å…¥æ•°æ®åŸåœ°æ”¹å˜çš„å‡½æ•°ä¹Ÿæ˜¯ä¸çº¯çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xs = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¯çš„</span></span><br><span class="line">xs.slice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; [1,2,3]</span></span><br><span class="line"></span><br><span class="line">xs.slice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; [1,2,3]</span></span><br><span class="line"></span><br><span class="line">xs.slice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; [1,2,3]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸çº¯çš„</span></span><br><span class="line">xs.splice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; [1,2,3]</span></span><br><span class="line"></span><br><span class="line">xs.splice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; [4,5]</span></span><br><span class="line"></span><br><span class="line">xs.splice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//=&gt; []</span></span><br></pre></td></tr></table></figure><h4 id="è¿½æ±‚â€œçº¯â€çš„ç†ç”±"><a href="#è¿½æ±‚â€œçº¯â€çš„ç†ç”±" class="headerlink" title="è¿½æ±‚â€œçº¯â€çš„ç†ç”±"></a>è¿½æ±‚â€œçº¯â€çš„ç†ç”±</h4><p>from <a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/ch3.html">ç¬¬ 3 ç« : çº¯å‡½æ•°çš„å¥½å¤„ Â· å‡½æ•°å¼ç¼–ç¨‹æŒ‡åŒ— (gitbooks.io)</a></p><p><strong>å¯ç¼“å­˜æ€§ï¼ˆCacheableï¼‰</strong></p><p>é¦–å…ˆï¼Œçº¯å‡½æ•°æ€»èƒ½å¤Ÿæ ¹æ®è¾“å…¥æ¥åšç¼“å­˜ã€‚å®ç°ç¼“å­˜çš„ä¸€ç§å…¸å‹æ–¹å¼æ˜¯ memoize æŠ€æœ¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> squareNumber  = memoize(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123; <span class="keyword">return</span> x*x; &#125;);</span><br><span class="line"></span><br><span class="line">squareNumber(<span class="number">4</span>);</span><br><span class="line"><span class="comment">//=&gt; 16</span></span><br><span class="line"></span><br><span class="line">squareNumber(<span class="number">4</span>); <span class="comment">// ä»ç¼“å­˜ä¸­è¯»å–è¾“å…¥å€¼ä¸º 4 çš„ç»“æœ</span></span><br><span class="line"><span class="comment">//=&gt; 16</span></span><br><span class="line"></span><br><span class="line">squareNumber(<span class="number">5</span>);</span><br><span class="line"><span class="comment">//=&gt; 25</span></span><br><span class="line"></span><br><span class="line">squareNumber(<span class="number">5</span>); <span class="comment">// ä»ç¼“å­˜ä¸­è¯»å–è¾“å…¥å€¼ä¸º 5 çš„ç»“æœ</span></span><br><span class="line"><span class="comment">//=&gt; 25</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œå°½ç®¡å®ƒä¸å¤ªå¥å£®ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> memoize = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cache = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arg_str = <span class="built_in">JSON</span>.stringify(<span class="built_in">arguments</span>);</span><br><span class="line">    cache[arg_str] = cache[arg_str] || f.apply(f, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">return</span> cache[arg_str];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¯ä»¥é€šè¿‡å»¶è¿Ÿæ‰§è¡Œçš„æ–¹å¼æŠŠä¸çº¯çš„å‡½æ•°è½¬æ¢ä¸ºçº¯å‡½æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pureHttpCall = memoize(<span class="function"><span class="keyword">function</span>(<span class="params">url, params</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> $.getJSON(url, params); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰è¶£çš„åœ°æ–¹åœ¨äºæˆ‘ä»¬å¹¶æ²¡æœ‰çœŸæ­£å‘é€ http è¯·æ±‚â€”â€”åªæ˜¯è¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œå½“è°ƒç”¨å®ƒçš„æ—¶å€™æ‰ä¼šå‘è¯·æ±‚ã€‚è¿™ä¸ªå‡½æ•°ä¹‹æ‰€ä»¥æœ‰èµ„æ ¼æˆä¸ºçº¯å‡½æ•°ï¼Œæ˜¯å› ä¸ºå®ƒæ€»æ˜¯ä¼šæ ¹æ®ç›¸åŒçš„è¾“å…¥è¿”å›ç›¸åŒçš„è¾“å‡ºï¼šç»™å®šäº† <code>url</code> å’Œ <code>params</code> ä¹‹åï¼Œå®ƒå°±åªä¼šè¿”å›åŒä¸€ä¸ªå‘é€ http è¯·æ±‚çš„å‡½æ•°ã€‚</p><p>æˆ‘ä»¬çš„ <code>memoize</code> å‡½æ•°å·¥ä½œèµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè™½ç„¶å®ƒç¼“å­˜çš„å¹¶ä¸æ˜¯ http è¯·æ±‚æ‰€è¿”å›çš„ç»“æœï¼Œè€Œæ˜¯ç”Ÿæˆçš„å‡½æ•°ã€‚</p><p>ç°åœ¨æ¥çœ‹è¿™ç§æ–¹å¼æ„ä¹‰ä¸å¤§ï¼Œä¸è¿‡å¾ˆå¿«æˆ‘ä»¬å°±ä¼šå­¦ä¹ ä¸€äº›æŠ€å·§æ¥å‘æ˜å®ƒçš„ç”¨å¤„ã€‚é‡ç‚¹æ˜¯<strong>å¯ä»¥ç¼“å­˜ä»»æ„ä¸€ä¸ªå‡½æ•°ï¼Œä¸ç®¡å®ƒä»¬çœ‹èµ·æ¥å¤šä¹ˆå…·æœ‰ç ´åæ€§</strong>ã€‚</p><p><strong>å¯ç§»æ¤æ€§ï¼è‡ªæ–‡æ¡£åŒ–ï¼ˆPortable / Self-Documentingï¼‰</strong></p><p>çº¯å‡½æ•°æ˜¯å®Œå…¨è‡ªç»™è‡ªè¶³çš„ï¼Œå®ƒéœ€è¦çš„æ‰€æœ‰ä¸œè¥¿éƒ½èƒ½è½»æ˜“è·å¾—ã€‚ä»”ç»†æ€è€ƒæ€è€ƒè¿™ä¸€ç‚¹â€¦è¿™ç§è‡ªç»™è‡ªè¶³çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆï¼Œçº¯å‡½æ•°çš„ä¾èµ–å¾ˆæ˜ç¡®ï¼Œå› æ­¤æ›´æ˜“äºè§‚å¯Ÿå’Œç†è§£â€”â€”æ²¡æœ‰å·å·æ‘¸æ‘¸çš„å°åŠ¨ä½œã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸çº¯çš„</span></span><br><span class="line"><span class="keyword">var</span> signUp = <span class="function"><span class="keyword">function</span>(<span class="params">attrs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> user = saveUser(attrs);</span><br><span class="line">  welcomeUser(user);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> saveUser = <span class="function"><span class="keyword">function</span>(<span class="params">attrs</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = Db.save(attrs);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> welcomeUser = <span class="function"><span class="keyword">function</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    Email(user, ...);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¯çš„</span></span><br><span class="line"><span class="keyword">var</span> signUp = <span class="function"><span class="keyword">function</span>(<span class="params">Db, Email, attrs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = saveUser(Db, attrs);</span><br><span class="line">    welcomeUser(Email, user);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> saveUser = <span class="function"><span class="keyword">function</span>(<span class="params">Db, attrs</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> welcomeUser = <span class="function"><span class="keyword">function</span>(<span class="params">Email, user</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­è¡¨æ˜ï¼Œçº¯å‡½æ•°å¯¹äºå…¶ä¾èµ–å¿…é¡»è¦è¯šå®ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½çŸ¥é“å®ƒçš„ç›®çš„ã€‚ä»…ä»çº¯å‡½æ•°ç‰ˆæœ¬çš„ <code>signUp</code> çš„ç­¾åå°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒå°†è¦ç”¨åˆ° <code>Db</code>ã€<code>Email</code> å’Œ <code>attrs</code>ï¼Œè¿™åœ¨æœ€å°ç¨‹åº¦ä¸Šç»™äº†æˆ‘ä»¬è¶³å¤Ÿå¤šçš„ä¿¡æ¯ã€‚</p><p>åé¢æˆ‘ä»¬ä¼šå­¦ä¹ å¦‚ä½•<strong>ä¸é€šè¿‡è¿™ç§ä»…ä»…æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„æ–¹å¼æ¥è®©ä¸€ä¸ªå‡½æ•°å˜çº¯ï¼Œä¸è¿‡è¿™é‡Œçš„é‡ç‚¹åº”è¯¥å¾ˆæ¸…æ¥šï¼Œé‚£å°±æ˜¯ç›¸æ¯”ä¸çº¯çš„å‡½æ•°ï¼Œçº¯å‡½æ•°èƒ½å¤Ÿæä¾›å¤šå¾—å¤šçš„ä¿¡æ¯</strong></p><p>å…¶æ¬¡ï¼Œé€šè¿‡å¼ºè¿«â€œæ³¨å…¥â€ä¾èµ–ï¼Œæˆ–è€…æŠŠå®ƒä»¬å½“ä½œå‚æ•°ä¼ é€’ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¹Ÿæ›´åŠ çµæ´»ï¼›å› ä¸ºæ•°æ®åº“æˆ–è€…é‚®ä»¶å®¢æˆ·ç«¯ç­‰ç­‰éƒ½å‚æ•°åŒ–äº†ï¼ˆåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬æœ‰åŠæ³•è®©è¿™ç§æ–¹å¼ä¸é‚£ä¹ˆå•è°ƒä¹å‘³ï¼‰ã€‚å¦‚æœè¦ä½¿ç”¨å¦ä¸€ä¸ª <code>Db</code>ï¼Œåªéœ€æŠŠå®ƒä¼ ç»™å‡½æ•°å°±è¡Œäº†ã€‚å¦‚æœæƒ³åœ¨ä¸€ä¸ªæ–°åº”ç”¨ä¸­ä½¿ç”¨è¿™ä¸ªå¯é çš„å‡½æ•°ï¼Œå°½ç®¡æŠŠæ–°çš„ <code>Db</code> å’Œ <code>Email</code> ä¼ é€’è¿‡å»å°±å¥½äº†ï¼Œéå¸¸ç®€å•ã€‚</p><p>åœ¨ JavaScript çš„è®¾å®šä¸­ï¼Œå¯ç§»æ¤æ€§å¯ä»¥æ„å‘³ç€æŠŠå‡½æ•°åºåˆ—åŒ–ï¼ˆserializingï¼‰å¹¶é€šè¿‡ socket å‘é€ã€‚ä¹Ÿå¯ä»¥æ„å‘³ç€ä»£ç èƒ½å¤Ÿåœ¨ web workers ä¸­è¿è¡Œã€‚æ€»ä¹‹ï¼Œå¯ç§»æ¤æ€§æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„ç‰¹æ€§ã€‚</p><p>å‘½ä»¤å¼ç¼–ç¨‹ä¸­â€œå…¸å‹â€çš„æ–¹æ³•å’Œè¿‡ç¨‹éƒ½æ·±æ·±åœ°æ ¹æ¤äºå®ƒä»¬æ‰€åœ¨çš„ç¯å¢ƒä¸­ï¼Œé€šè¿‡çŠ¶æ€ã€ä¾èµ–å’Œæœ‰æ•ˆä½œç”¨ï¼ˆavailable effectsï¼‰è¾¾æˆï¼›çº¯å‡½æ•°ä¸æ­¤ç›¸åï¼Œå®ƒä¸ç¯å¢ƒæ— å…³ï¼Œåªè¦æˆ‘ä»¬æ„¿æ„ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œå®ƒã€‚</p><p>ä½ ä¸Šä¸€æ¬¡æŠŠæŸä¸ªç±»æ–¹æ³•æ‹·è´åˆ°æ–°çš„åº”ç”¨ä¸­æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿæˆ‘æœ€å–œæ¬¢çš„åè¨€ä¹‹ä¸€æ˜¯ Erlang è¯­è¨€çš„ä½œè€… Joe Armstrong è¯´çš„è¿™å¥è¯ï¼šâ€œé¢å‘å¯¹è±¡è¯­è¨€çš„é—®é¢˜æ˜¯ï¼Œå®ƒä»¬æ°¸è¿œéƒ½è¦éšèº«æºå¸¦é‚£äº›éšå¼çš„ç¯å¢ƒã€‚ä½ åªéœ€è¦ä¸€ä¸ªé¦™è•‰ï¼Œä½†å´å¾—åˆ°ä¸€ä¸ªæ‹¿ç€é¦™è•‰çš„å¤§çŒ©çŒ©â€¦ä»¥åŠæ•´ä¸ªä¸›æ—â€ã€‚</p><p><strong>å¯æµ‹è¯•æ€§ï¼ˆTestableï¼‰</strong></p><p>ç¬¬ä¸‰ç‚¹ï¼Œçº¯å‡½æ•°è®©æµ‹è¯•æ›´åŠ å®¹æ˜“ã€‚æˆ‘ä»¬ä¸éœ€è¦ä¼ªé€ ä¸€ä¸ªâ€œçœŸå®çš„â€æ”¯ä»˜ç½‘å…³ï¼Œæˆ–è€…æ¯ä¸€æ¬¡æµ‹è¯•ä¹‹å‰éƒ½è¦é…ç½®ã€ä¹‹åéƒ½è¦æ–­è¨€çŠ¶æ€ï¼ˆassert the stateï¼‰ã€‚åªéœ€ç®€å•åœ°ç»™å‡½æ•°ä¸€ä¸ªè¾“å…¥ï¼Œç„¶åæ–­è¨€è¾“å‡ºå°±å¥½äº†ã€‚</p><p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬å‘ç°å‡½æ•°å¼ç¼–ç¨‹çš„ç¤¾åŒºæ­£åœ¨å¼€åˆ›ä¸€äº›æ–°çš„æµ‹è¯•å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆè¾“å…¥å¹¶æ–­è¨€è¾“å‡ºã€‚è¿™è¶…å‡ºäº†æœ¬ä¹¦èŒƒå›´ï¼Œä½†æ˜¯æˆ‘å¼ºçƒˆæ¨èä½ å»è¯•è¯• <em>Quickcheck</em>â€”â€”ä¸€ä¸ªä¸ºå‡½æ•°å¼ç¯å¢ƒé‡èº«å®šåˆ¶çš„æµ‹è¯•å·¥å…·ã€‚</p><p><strong>åˆç†æ€§ï¼ˆReasonableï¼‰</strong></p><p>å¾ˆå¤šäººç›¸ä¿¡ä½¿ç”¨çº¯å‡½æ•°æœ€å¤§çš„å¥½å¤„æ˜¯<em>å¼•ç”¨é€æ˜æ€§</em>ï¼ˆreferential transparencyï¼‰ã€‚å¦‚æœä¸€æ®µä»£ç å¯ä»¥æ›¿æ¢æˆå®ƒæ‰§è¡Œæ‰€å¾—çš„ç»“æœï¼Œè€Œä¸”æ˜¯åœ¨ä¸æ”¹å˜æ•´ä¸ªç¨‹åºè¡Œä¸ºçš„å‰æä¸‹æ›¿æ¢çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´è¿™æ®µä»£ç æ˜¯å¼•ç”¨é€æ˜çš„ã€‚</p><p>ç”±äºçº¯å‡½æ•°æ€»æ˜¯èƒ½å¤Ÿæ ¹æ®ç›¸åŒçš„è¾“å…¥è¿”å›ç›¸åŒçš„è¾“å‡ºï¼Œæ‰€ä»¥å®ƒä»¬å°±èƒ½å¤Ÿä¿è¯æ€»æ˜¯è¿”å›åŒä¸€ä¸ªç»“æœï¼Œè¿™ä¹Ÿå°±ä¿è¯äº†å¼•ç”¨é€æ˜æ€§ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Immutable = <span class="built_in">require</span>(<span class="string">&#x27;immutable&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> decrementHP = <span class="function"><span class="keyword">function</span>(<span class="params">player</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> player.set(<span class="string">&quot;hp&quot;</span>, player.hp-<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isSameTeam = <span class="function"><span class="keyword">function</span>(<span class="params">player1, player2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> player1.team === player2.team;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> punch = <span class="function"><span class="keyword">function</span>(<span class="params">player, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(isSameTeam(player, target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> decrementHP(target);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jobe = Immutable.Map(&#123;<span class="attr">name</span>:<span class="string">&quot;Jobe&quot;</span>, <span class="attr">hp</span>:<span class="number">20</span>, <span class="attr">team</span>: <span class="string">&quot;red&quot;</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> michael = Immutable.Map(&#123;<span class="attr">name</span>:<span class="string">&quot;Michael&quot;</span>, <span class="attr">hp</span>:<span class="number">20</span>, <span class="attr">team</span>: <span class="string">&quot;green&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">punch(jobe, michael);</span><br><span class="line"><span class="comment">//=&gt; Immutable.Map(&#123;name:&quot;Michael&quot;, hp:19, team: &quot;green&quot;&#125;)</span></span><br></pre></td></tr></table></figure><p><code>decrementHP</code>ã€<code>isSameTeam</code> å’Œ <code>punch</code> éƒ½æ˜¯çº¯å‡½æ•°ï¼Œæ‰€ä»¥æ˜¯å¼•ç”¨é€æ˜çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§å«åšâ€œç­‰å¼æ¨å¯¼â€ï¼ˆequational reasoningï¼‰çš„æŠ€æœ¯æ¥åˆ†æä»£ç ã€‚æ‰€è°“â€œç­‰å¼æ¨å¯¼â€å°±æ˜¯â€œä¸€å¯¹ä¸€â€æ›¿æ¢ï¼Œæœ‰ç‚¹åƒåœ¨ä¸è€ƒè™‘ç¨‹åºæ€§æ‰§è¡Œçš„æ€ªå¼‚è¡Œä¸ºï¼ˆquirks of programmatic evaluationï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨æ‰§è¡Œç›¸å…³ä»£ç ã€‚æˆ‘ä»¬å€ŸåŠ©å¼•ç”¨é€æ˜æ€§æ¥å‰–æä¸€ä¸‹è¿™æ®µä»£ç ã€‚</p><p>é¦–å…ˆå†…è” <code>isSameTeam</code> å‡½æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punch = <span class="function"><span class="keyword">function</span>(<span class="params">player, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(player.team === target.team) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> decrementHP(target);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯ä¸å¯å˜æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠ <code>team</code> æ›¿æ¢ä¸ºå®é™…å€¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punch = <span class="function"><span class="keyword">function</span>(<span class="params">player, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="string">&quot;red&quot;</span> === <span class="string">&quot;green&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> decrementHP(target);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>if</code> è¯­å¥æ‰§è¡Œç»“æœä¸º <code>false</code>ï¼Œæ‰€ä»¥å¯ä»¥æŠŠæ•´ä¸ª <code>if</code> è¯­å¥éƒ½åˆ æ‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punch = <span class="function"><span class="keyword">function</span>(<span class="params">player, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> decrementHP(target);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœå†å†…è” <code>decrementHP</code>ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>punch</code> å˜æˆäº†ä¸€ä¸ªè®© <code>hp</code> çš„å€¼å‡ 1 çš„è°ƒç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punch = <span class="function"><span class="keyword">function</span>(<span class="params">player, target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> target.set(<span class="string">&quot;hp&quot;</span>, target.hp-<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ€»ä¹‹ï¼Œç­‰å¼æ¨å¯¼å¸¦æ¥çš„åˆ†æä»£ç çš„èƒ½åŠ›å¯¹é‡æ„å’Œç†è§£ä»£ç éå¸¸é‡è¦ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬é‡æ„æµ·é¸¥ç¨‹åºä½¿ç”¨çš„æ­£æ˜¯è¿™é¡¹æŠ€æœ¯ï¼šåˆ©ç”¨åŠ å’Œä¹˜çš„ç‰¹æ€§ã€‚å¯¹è¿™äº›æŠ€æœ¯çš„ä½¿ç”¨å°†ä¼šè´¯ç©¿æœ¬ä¹¦ï¼ŒçœŸçš„ã€‚</p><p><strong>å¹¶è¡Œä»£ç </strong></p><p>å› ä¸ºå¯ä»¥å¹¶è¡Œè¿è¡Œä»»æ„çº¯å‡½æ•°ã€‚å› ä¸ºçº¯å‡½æ•°æ ¹æœ¬ä¸éœ€è¦è®¿é—®å…±äº«çš„å†…å­˜ï¼Œè€Œä¸”æ ¹æ®å…¶å®šä¹‰ï¼Œçº¯å‡½æ•°ä¹Ÿä¸ä¼šå› å‰¯ä½œç”¨è€Œè¿›å…¥ç«äº‰æ€ï¼ˆrace conditionï¼‰ã€‚</p><p>å¹¶è¡Œä»£ç åœ¨æœåŠ¡ç«¯ js ç¯å¢ƒä»¥åŠä½¿ç”¨äº† web worker çš„æµè§ˆå™¨é‚£é‡Œæ˜¯éå¸¸å®¹æ˜“å®ç°çš„ï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨äº†çº¿ç¨‹ï¼ˆthreadï¼‰ã€‚ä¸è¿‡å‡ºäºå¯¹éçº¯å‡½æ•°å¤æ‚åº¦çš„è€ƒè™‘ï¼Œå½“å‰ä¸»æµè§‚ç‚¹è¿˜æ˜¯é¿å…ä½¿ç”¨è¿™ç§å¹¶è¡Œã€‚</p><h3 id="ç»„åˆ"><a href="#ç»„åˆ" class="headerlink" title="ç»„åˆ"></a>ç»„åˆ</h3><p>å¦‚æœä¸€ä¸ªå€¼è¦ç»è¿‡å¤šä¸ªå‡½æ•°ï¼Œæ‰èƒ½å˜æˆå¦å¤–ä¸€ä¸ªå€¼ï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰ä¸­é—´æ­¥éª¤åˆå¹¶æˆä¸€ä¸ªå‡½æ•°ï¼Œè¿™å«åšâ€å‡½æ•°çš„åˆæˆâ€ï¼ˆcomposeï¼‰</p><p>å°†è®¡ç®—è¿‡ç¨‹åˆ†è§£æˆå¯å¤ç”¨çš„å‡½æ•°ï¼Œå…¸å‹ä¾‹å­å°±æ˜¯<code>map</code>æ–¹æ³•å’Œ<code>reduce</code>æ–¹æ³•ç»„åˆè€ŒæˆMapReduceç®—æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compose(f, compose(g, h))</span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line">compose(compose(f, g), h)</span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line">compose(f, g, h)</span><br></pre></td></tr></table></figure><h3 id="æŸ¯é‡ŒåŒ–"><a href="#æŸ¯é‡ŒåŒ–" class="headerlink" title="æŸ¯é‡ŒåŒ–"></a>æŸ¯é‡ŒåŒ–</h3><p>åœ¨å­¦ä¹ JSçš„æ—¶å€™,ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°è¿™ä¸ªæ¦‚å¿µäº†</p><p><code>f(x)</code>å’Œ<code>g(x)</code>åˆæˆä¸º<code>f(g(x))</code>ï¼Œæœ‰ä¸€ä¸ªéšè—çš„å‰æï¼Œå°±æ˜¯<code>f</code>å’Œ<code>g</code>éƒ½åªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°ã€‚å¦‚æœå¯ä»¥æ¥å—å¤šä¸ªå‚æ•°ï¼Œæ¯”å¦‚<code>f(x, y)</code>å’Œ<code>g(a, b, c)</code>ï¼Œå‡½æ•°åˆæˆå°±éå¸¸éº»çƒ¦ã€‚</p><p>è¿™æ—¶å°±éœ€è¦å‡½æ•°æŸ¯é‡ŒåŒ–äº†ã€‚æ‰€è°“â€æŸ¯é‡ŒåŒ–â€ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªå¤šå‚æ•°çš„å‡½æ•°ï¼Œè½¬åŒ–ä¸ºå•å‚æ•°å‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¯é‡ŒåŒ–ä¹‹å‰</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>) <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¯é‡ŒåŒ–ä¹‹å</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addX</span>(<span class="params">y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addX(<span class="number">2</span>)(<span class="number">1</span>) <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†æŸ¯é‡ŒåŒ–ä»¥åï¼Œæˆ‘ä»¬å°±èƒ½åšåˆ°ï¼Œæ‰€æœ‰å‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ã€‚åæ–‡çš„å†…å®¹é™¤éå¦æœ‰è¯´æ˜ï¼Œéƒ½é»˜è®¤å‡½æ•°åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ‰€è¦å¤„ç†çš„é‚£ä¸ªå€¼ã€‚</p><p>é™¤äº†ä¸Šé¢æåˆ°çš„ä¹‹å¤–,è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç‰¹æ€§,å°±éœ€è¦è‡ªå·±å­¦ä¹ äº†.</p><h3 id="Functor"><a href="#Functor" class="headerlink" title="Functor"></a>Functor</h3><blockquote><p>Functorå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºä¸€ä¸ªèƒ½å¤Ÿä¿å­˜å€¼,å¹¶ä¸”èƒ½å¤Ÿå¯¹è¿™äº›å€¼æ‰§è¡ŒæŸäº›æ“ä½œçš„å®¹å™¨ã€‚æ›´å…·ä½“åœ°è¯´,Functoræ˜¯ä¸€ä¸ªå®ç°äº†<code>fmap</code>å‡½æ•°çš„ç±»å‹ç±»ã€‚<code>fmap</code>å‡½æ•°å…è®¸æˆ‘ä»¬å¯¹Functorä¸­åŒ…å«çš„å€¼æ‰§è¡ŒæŸç§å˜æ¢æ“ä½œ,å¹¶å°†ç»“æœåŒ…è£…åˆ°æ–°çš„Functorä¸­è¿”å›ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåˆ—è¡¨</span></span><br><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨fmapå¯¹åˆ—è¡¨ä¸­çš„å…ƒç´ è¿›è¡Œå¹³æ–¹å˜æ¢</span></span><br><span class="line">squared_numbers = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x**<span class="number">2</span>, numbers))</span><br><span class="line"><span class="built_in">print</span>(squared_numbers) <span class="comment"># Output: [1, 4, 9, 16, 25]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="comment"># Optionç±»å‹ä½œä¸ºFunctor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_divide</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> a / b</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨fmapå¯¹Optionalç±»å‹æ‰§è¡Œå˜æ¢</span></span><br><span class="line">result1 = safe_divide(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(result1)  <span class="comment"># Output: 5.0</span></span><br><span class="line"></span><br><span class="line">result2 = safe_divide(<span class="number">10</span>, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(result2)  <span class="comment"># Output: None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨fmapå¯¹Maybeç±»å‹æ‰§è¡Œå˜æ¢</span></span><br><span class="line">doubled_result1 = <span class="keyword">lambda</span> x: x * <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(doubled_result1, [result1, result2]))) <span class="comment"># Output: [10.0, None]</span></span><br></pre></td></tr></table></figure><h3 id="Monoid"><a href="#Monoid" class="headerlink" title="Monoid"></a>Monoid</h3><blockquote><p>Monoidæ˜¯ä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§çš„ä»£æ•°ç»“æ„:</p><ol><li>äºŒå…ƒæ“ä½œ(ç§°ä¸ºâ€åˆå¹¶â€æ“ä½œ)</li><li>ä¸€ä¸ªç‰¹æ®Šçš„å•ä½å…ƒ</li></ol><p>æ›´å…·ä½“åœ°è¯´,ä¸€ä¸ªç±»å‹<code>T</code>æ˜¯ä¸€ä¸ªMonoid,å¦‚æœå®ƒæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶:</p><ol><li>å­˜åœ¨ä¸€ä¸ªäºŒå…ƒæ“ä½œ<code>combine(a: T, b: T) -&gt; T</code>ï¼Œè¯¥æ“ä½œæ˜¯<strong>associative</strong>çš„,å³<code>combine(a, combine(b, c)) = combine(combine(a, b), c)</code>ã€‚</li><li>å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„å€¼<code>empty: T</code>ï¼Œè¢«ç§°ä¸ºå•ä½å…ƒ,å¯¹äºä»»æ„<code>x: T</code>éƒ½æœ‰<code>combine(x, empty) = x</code>å’Œ<code>combine(empty, x) = x</code></li></ol></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ•´æ•°æ±‚å’Œæ“ä½œ</span></span><br><span class="line">numbers1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">numbers2 = [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">total = <span class="built_in">sum</span>(numbers1) + <span class="built_in">sum</span>(numbers2)</span><br><span class="line"><span class="built_in">print</span>(total)  <span class="comment"># Output: 21</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0ä½œä¸ºå•ä½å…ƒ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>([]) + <span class="built_in">sum</span>(numbers1))  <span class="comment"># Output: 6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(numbers1) + <span class="built_in">sum</span>([]))  <span class="comment"># Output: 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ</span></span><br><span class="line">greeting1 = <span class="string">&quot;Hello, &quot;</span></span><br><span class="line">greeting2 = <span class="string">&quot;world!&quot;</span></span><br><span class="line">combined_greeting = greeting1 + greeting2</span><br><span class="line"><span class="built_in">print</span>(combined_greeting)  <span class="comment"># Output: &quot;Hello, world!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç©ºå­—ç¬¦ä¸²ä½œä¸ºå•ä½å…ƒ</span></span><br><span class="line">empty_string = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(empty_string + greeting1)  <span class="comment"># Output: &quot;Hello, &quot;</span></span><br><span class="line"><span class="built_in">print</span>(greeting1 + empty_string)  <span class="comment"># Output: &quot;Hello, &quot;</span></span><br></pre></td></tr></table></figure><h3 id="Monad"><a href="#Monad" class="headerlink" title="Monad"></a>Monad</h3><blockquote><p>å¯ä»¥è¢«è§†ä¸ºFunctorçš„ä¸€ç§ç‰¹æ®Šå½¢å¼,å…·æœ‰é¢å¤–çš„æ€§è´¨å’Œæ“ä½œã€‚</p><p>ç®€å•æ¥è¯´,Monadæ˜¯ä¸€ä¸ªæ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ç±»å‹<code>M[_]</code>:</p><ol><li>å®ƒæ˜¯ä¸€ä¸ªFunctor,å³å­˜åœ¨<code>fmap</code>æ“ä½œ,å¯ä»¥å¯¹Monadå†…éƒ¨çš„å€¼è¿›è¡Œå˜æ¢ã€‚</li><li>å®ƒå…·æœ‰ä¸€ä¸ª<code>return</code>æ“ä½œ,å¯ä»¥å°†ä¸€ä¸ªå€¼åŒ…è£…è¿›Monadã€‚</li><li>å®ƒå…·æœ‰ä¸€ä¸ª<code>flatMap</code>(æˆ–<code>bind</code>)æ“ä½œ,å¯ä»¥å¯¹Monadå†…éƒ¨çš„å€¼è¿›è¡Œå˜æ¢å¹¶â€æ‰å¹³åŒ–â€ç»“æœã€‚</li></ol></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiply</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">    <span class="keyword">return</span> [x, x * <span class="number">2</span>, x * <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨flatMapæ“ä½œ</span></span><br><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">results = [y <span class="keyword">for</span> x <span class="keyword">in</span> numbers <span class="keyword">for</span> y <span class="keyword">in</span> multiply(x)]</span><br><span class="line"><span class="built_in">print</span>(results)  <span class="comment"># Output: [1, 2, 3, 2, 4, 6, 3, 6, 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼å®ç°flatMap</span></span><br><span class="line">results = [multiply(x) <span class="keyword">for</span> x <span class="keyword">in</span> numbers]</span><br><span class="line"><span class="built_in">print</span>(results)  <span class="comment"># Output: [[1, 2, 3], [2, 4, 6], [3, 6, 9]]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://ruanyifeng.com/blog/2015/07/monad.html">å›¾è§£ Monad - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IOç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IO</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">effect</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._effect = effect;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// pureæ“ä½œ</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function">() =&gt;</span> value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bindæ“ä½œ</span></span><br><span class="line">  <span class="function"><span class="title">bind</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function">() =&gt;</span> fn(<span class="built_in">this</span>._effect()).run());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._effect();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> greet = <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>!`</span>;</span><br><span class="line"><span class="keyword">const</span> getInput = <span class="function">() =&gt;</span> prompt(<span class="string">&#x27;What is your name?&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sayHello = <span class="keyword">new</span> IO(getInput)</span><br><span class="line">  .bind(<span class="function"><span class="params">name</span> =&gt;</span> <span class="keyword">new</span> IO(<span class="function">() =&gt;</span> greet(name)))</span><br><span class="line">  .bind(<span class="function"><span class="params">message</span> =&gt;</span> <span class="keyword">new</span> IO(<span class="function">() =&gt;</span> alert(message)));</span><br><span class="line"></span><br><span class="line">sayHello.run(); <span class="comment">// å¼¹å‡ºå¯¹è¯æ¡†å¹¶æ˜¾ç¤º&#x27;Hello, &#123;è¾“å…¥çš„åå­—&#125;!&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Applicative"><a href="#Applicative" class="headerlink" title="Applicative"></a>Applicative</h3><blockquote><p>Applicativeå¯ä»¥è¢«è§†ä¸ºFunctorçš„ä¸€ç§ç‰¹æ®Šå½¢å¼,å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</p><ol><li>å®ƒæ˜¯ä¸€ä¸ªFunctor,å³å­˜åœ¨<code>fmap</code>æ“ä½œ,å¯ä»¥å¯¹Applicativeå†…éƒ¨çš„å€¼è¿›è¡Œå˜æ¢ã€‚</li><li>å®ƒå…·æœ‰ä¸€ä¸ª<code>pure</code>æ“ä½œ,å¯ä»¥å°†ä¸€ä¸ªå€¼åŒ…è£…è¿›Applicativeã€‚</li><li>å®ƒå…·æœ‰ä¸€ä¸ª<code>ap</code>(apply)æ“ä½œ,å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°åŒ…è£…è¿›Applicativeåº”ç”¨åˆ°å¦ä¸€ä¸ªApplicativeä¸Š</li></ol></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Eitherç±»å‹</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Either</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._value = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Right(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">left</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Left(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apæ“ä½œ</span></span><br><span class="line">  <span class="function"><span class="title">ap</span>(<span class="params">other</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> <span class="keyword">instanceof</span> Left) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (other <span class="keyword">instanceof</span> Left) &#123;</span><br><span class="line">      <span class="keyword">return</span> other;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Right(<span class="built_in">this</span>._value(other._value));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Right</span> <span class="keyword">extends</span> <span class="title">Either</span> </span>&#123;</span><br><span class="line">  <span class="comment">// pureæ“ä½œ</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Right(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Left</span> <span class="keyword">extends</span> <span class="title">Either</span> </span>&#123;</span><br><span class="line">  <span class="comment">// pureæ“ä½œ</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Left(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y;</span><br><span class="line"><span class="keyword">const</span> result1 = Either.of(add).ap(Either.of(<span class="number">3</span>)).ap(Either.of(<span class="number">4</span>)); <span class="comment">// Right(7)</span></span><br><span class="line"><span class="keyword">const</span> result2 = Either.of(add).ap(Either.of(<span class="number">3</span>)).ap(Either.left(<span class="string">&#x27;error&#x27;</span>)); <span class="comment">// Left(&#x27;error&#x27;)</span></span><br></pre></td></tr></table></figure><p><a href="https://sxyz.blog/functors-applicatives-and-monads-in-pictures/">å›¾è§£ Functorã€Applicativeã€Monad (sxyz.blog)</a></p><p><a href="https://blog.forec.cn/2017/03/02/translation-adit-faamip/">å›¾è§£ Functor, Applicative å’Œ Monad | Forecâ€™s Notes</a></p><p><img data-src="https://p0.meituan.net/travelcube/652d533cc899998d4822ac6ed58cce89128094.png" alt="å›¾ 30" style="zoom:50%;" /></p><p><strong>ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€äº›åŸå› </strong></p><ul><li>æ–¹ä¾¿debug</li></ul><p>å› ä¸ºå†™æˆäº†å‡½æ•°,æ–¹ä¾¿å†™å•å…ƒæµ‹è¯•è€Œä¸”ç”±äºæ˜¯çº¯å‡½æ•°ï¼Œè¾“å…¥å›ºå®šé‚£è¾“å‡ºå°±æ˜¯å›ºå®šçš„</p><ul><li>ä»£ç é‡ç”¨</li></ul><p>çº¯å‡½æ•°æ–¹ä¾¿ç»„åˆä¹Ÿæ–¹ä¾¿ä½¿ç”¨</p><ul><li>å¦ä¸€ç§æ€ç»´æ–¹å¼</li></ul><p>æ˜¯çš„ï¼Œé™¤äº†OOPä¹‹å¤–ï¼Œä½ å¯ä»¥ç«™åœ¨è¿™æ ·çš„è§’åº¦å†™ç‰¹åˆ«çš„ä»£ç </p><p>å¦‚æœä½ è¦å­¦ä¹ å…·ä½“æŸä¸ªå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€,å¯ä»¥è€ƒè™‘Clojure,Elixir,Haskellæˆ–è€…æ›´åŠ æ–°çš„Ocaml.(æˆ‘ä¸ªäººæ¨è)</p><p>ä¸‹é¢ç»™ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€åˆ†ä¸ªç±».</p><p>Lisp å®¶æ—</p><ul><li>Common Lisp</li><li>Scheme</li><li>Racket</li><li>Clojure</li></ul><p>è¿™äº›è¯­è¨€éƒ½å±äº Lisp è¯­è¨€å®¶æ—,å…·æœ‰å¼ºå¤§çš„å®ç³»ç»Ÿå’Œå…ƒç¼–ç¨‹èƒ½åŠ›,éå¸¸é€‚åˆè¿›è¡Œå‡½æ•°å¼å’Œå£°æ˜å¼ç¼–ç¨‹ã€‚</p><p>æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„å¤šèŒƒå¼è¯­è¨€</p><ul><li>Scala</li><li>F#</li><li>Clojure</li><li>Kotlin</li><li>Swift</li></ul><p>è¿™ç±»è¯­è¨€èåˆäº†å‡½æ•°å¼å’Œé¢å‘å¯¹è±¡ç­‰å¤šç§ç¼–ç¨‹èŒƒå¼,å…¼å…·å‡½æ•°å¼å’Œå‘½ä»¤å¼ç¼–ç¨‹çš„ç‰¹ç‚¹ã€‚å®ƒä»¬åœ¨å·¥ä¸šç•Œåº”ç”¨è¾ƒä¸ºå¹¿æ³›ã€‚</p><p>çº¯å‡½æ•°å¼è¯­è¨€</p><ul><li>Haskell</li><li>PureScript</li></ul><p>è¿™ç±»è¯­è¨€ä¸¥æ ¼éµå¾ªå‡½æ•°å¼ç¼–ç¨‹çš„åŸåˆ™,æ²¡æœ‰å¯å˜çŠ¶æ€,å¼ºè°ƒä»£æ•°ç±»å‹ç³»ç»Ÿå’Œæƒ°æ€§æ±‚å€¼ã€‚å®ƒä»¬æ›´åå‘äºå­¦æœ¯å’Œç ”ç©¶é¢†åŸŸã€‚</p><p>å¹¶å‘/åˆ†å¸ƒå¼å‡½æ•°å¼è¯­è¨€:</p><ul><li>Erlang</li><li>Elixir</li><li>OCaml</li></ul><p>è¿™äº›è¯­è¨€æ“…é•¿æ„å»ºé«˜å¹¶å‘ã€åˆ†å¸ƒå¼å’Œå®¹é”™çš„åº”ç”¨ç¨‹åº,åˆ©ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„ä¼˜åŠ¿æ¥åº”å¯¹å¤æ‚çš„å¹¶å‘é—®é¢˜ã€‚</p><p>JavaScript è¡ç”Ÿè¯­è¨€</p><ul><li>PureScript</li><li>Elm</li><li>ReasonML</li><li>TypeScript</li></ul><p>è¿™ç±»è¯­è¨€åœ¨ JavaScript çš„åŸºç¡€ä¸Šå¢åŠ äº†é™æ€ç±»å‹ç³»ç»Ÿå’Œå…¶ä»–å‡½æ•°å¼ç‰¹æ€§,æ—¨åœ¨æé«˜ JavaScript çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://github.com/readme/guides/functional-programming-basics">Functional Programming 101 (github.com)</a></li><li><a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/">Introduction Â· å‡½æ•°å¼ç¼–ç¨‹æŒ‡åŒ— (gitbooks.io)</a></li><li><a href="https://ruanyifeng.com/blog/2017/02/fp-tutorial.html">å‡½æ•°å¼ç¼–ç¨‹å…¥é—¨æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— (ruanyifeng.com)</a></li><li><a href="https://tech.meituan.com/2022/10/13/dive-into-functional-programming-01.html">æ·±å…¥ç†è§£å‡½æ•°å¼ç¼–ç¨‹ï¼ˆä¸Šï¼‰ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰åœ¨çœ‹å…¶ä»–äººäº¤æµå¸–å­çš„æ—¶å€™æåˆ°å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹æå‡æ€ç»´(è™½ç„¶æ„Ÿè§‰æœ‰ç‚¹å¤§è‚†å®£ä¼ çš„æ„Ÿè§‰),ä½†çœ‹äº†ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„ä¾‹å­,æ„Ÿè§‰åœ¨æ•°æ®å¤„ç†å’Œå¤šçº¿ç¨‹ä¸Šæœ‰ç‹¬ç‰¹çš„æ•ˆæœ,å¦‚æœä½¿ç”¨é¢å‘å¯¹è±¡,é‚£å°±ä¼šå˜å¾—æ¯”è¾ƒéº»çƒ¦,æ‰€ä»¥è¿™é‡Œä»…ä½œç®€å•ä»‹ç».&lt;br&gt;</summary>
    
    
    
    
    <category term="functional programming" scheme="https://www.sekyoro.top/tags/functional-programming/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨pytorchæ—¶ä½ å¯èƒ½éœ€è¦æ³¨æ„çš„åœ°æ–¹</title>
    <link href="https://www.sekyoro.top/2024/06/23/effective_pytorch/"/>
    <id>https://www.sekyoro.top/2024/06/23/effective_pytorch/</id>
    <published>2024-06-23T08:16:46.000Z</published>
    <updated>2024-07-11T12:44:39.617Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Pytorchæ˜¯å¾ˆå¥½çš„æ·±åº¦å­¦ä¹ æ¡†æ¶,ä½†åœ¨ä½¿ç”¨æ—¶ä½ å¯èƒ½ä»ç„¶ä¸æ¸…æ¥šå…¶ä¸­ä¸€äº›æ¦‚å¿µ.è¿™é‡Œæˆ‘åªä»¥å®˜æ–¹æ–‡æ¡£ä¸ºä¾æ®å°è¯•è§£é‡Šå…¶ä¸­ä¸€äº›æ¦‚å¿µå’Œæ–¹æ³•. æˆ‘è¿™é‡Œå¯ä»¥ç§°ä½œEffective Pytorch.<br><span id="more"></span></p><blockquote><p>update:ä¸ºäº†æ›´å¥½çš„ç†è§£pytorch,ä¹Ÿè®¸å¯ä»¥ä»é›¶å†™ç‚¹ä»£ç <a href="https://github.com/karpathy/micrograd">karpathy/micrograd: A tiny scalar-valued autograd engine and a neural net library on top of it with PyTorch-like API (github.com)</a></p><p><a href="https://nrehiew.github.io/blog/pytorch/">Taking PyTorch for Granted | wh (nrehiew.github.io)</a></p></blockquote><h2 id="tensor"><a href="#tensor" class="headerlink" title="tensor"></a>tensor</h2><h3 id="Tensor"><a href="#Tensor" class="headerlink" title="Tensor"></a>Tensor</h3><p>pytorché»˜è®¤æµ®ç‚¹ç±»å‹æ˜¯torch.float32,å¯ä»¥ä½¿ç”¨<code>torch.set_default_dtype</code>ä¿®æ”¹</p><p>torch.zerosç­‰é»˜è®¤ç±»å‹å°±æ˜¯å°±æ˜¯torch.float32,ä½¿ç”¨<code>torch.set_default_dtype</code>ä¿®æ”¹é»˜è®¤ç±»å‹.</p><p>torch.tensor() æ€»æ˜¯å¤åˆ¶<code>data</code>(æ·±æ‹·è´,è¡¨ç¤ºåœ°å€ä¸ç›¸åŒ).å¦‚æœä½ æœ‰ä¸€ä¸ªå¼ é‡æ•°æ®,<strong>åªæ˜¯æƒ³æ›´æ”¹å®ƒçš„ requires<em>grad æ ‡å¿—,è¯·ä½¿ç”¨ requires_grad</em>() æˆ– detach() æ¥é¿å…å¤åˆ¶</strong>.</p><p>å¦‚æœä½ æœ‰ä¸€ä¸ª numpy æ•°ç»„,å¹¶<strong>å¸Œæœ›é¿å…å¤åˆ¶,è¯·ä½¿ç”¨ torch.as_tensor()</strong>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">torch.device(<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">torch.device(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">torch.device(<span class="string">&#x27;mps&#x27;</span>)</span><br><span class="line"></span><br><span class="line">torch.device(<span class="string">&#x27;cuda&#x27;</span>)  <span class="comment"># current cuda device</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]])</span><br><span class="line">x.stride() <span class="comment">#(5,1)</span></span><br><span class="line"></span><br><span class="line">x.t().stride() <span class="comment">#(1,5)</span></span><br></pre></td></tr></table></figure><h3 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h3><p>PyTorch å…è®¸å¼ é‡æˆä¸ºç°æœ‰å¼ é‡çš„ â€œviewsâ€.<strong>è§†å›¾å¼ é‡ä¸å…¶åŸºç¡€å¼ é‡å…±äº«ç›¸åŒçš„åº•å±‚æ•°æ®</strong>.æ”¯æŒ â€œviews â€œå¯ä»¥é¿å…æ˜¾å¼æ•°æ®å¤åˆ¶,ä»è€Œä½¿æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œå¿«é€Ÿã€é«˜æ•ˆçš„å†…å­˜é‡å¡‘ã€åˆ‡ç‰‡å’Œå…ƒç´ æ“ä½œ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t = torch.rand(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">b = t.view(<span class="number">2</span>, <span class="number">8</span>)</span><br><span class="line">t.storage().data_ptr() == b.storage().data_ptr()  <span class="comment"># `t` and `b` share the same underlying data.</span></span><br><span class="line">b[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">3.14</span></span><br><span class="line">t[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>ç”±äºviewsä¸å…¶åŸºç¡€å¼ é‡å…±äº«åº•å±‚æ•°æ®,å› æ­¤å¦‚æœä¿®æ”¹viewsä¸­çš„æ•°æ®,ä¹Ÿä¼šåæ˜ åœ¨åŸºç¡€å¼ é‡ä¸­.</p><p>é€šå¸¸,PyTorch æ“ä½œä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¼ é‡ä½œä¸ºè¾“å‡º,ä¾‹å¦‚ add().ä½†åœ¨è§†å›¾æ“ä½œä¸­,è¾“å‡ºæ˜¯è¾“å…¥å¼ é‡çš„è§†å›¾,ä»¥é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶.åˆ›å»ºè§†å›¾æ—¶ä¸ä¼šå‘ç”Ÿæ•°æ®ç§»åŠ¨,è§†å›¾å¼ é‡åªæ˜¯æ”¹å˜äº†è§£é‡Šç›¸åŒæ•°æ®çš„æ–¹å¼.</p><p><strong>å¯¹è¿ç»­å¼ é‡è¿›è¡Œè§†å›¾å¤„ç†å¯èƒ½ä¼šäº§ç”Ÿéè¿ç»­å¼ é‡</strong>.transpose() å°±æ˜¯ä¸€ä¸ªå¸¸è§çš„ä¾‹å­.(åŒ…æ‹¬view,transposeç­‰æ“ä½œéƒ½ä¼šè¿”å›view,ä¹Ÿå°±æ˜¯æ•°æ®å­˜å‚¨ä¸è¾“å…¥ç›¸åŒ)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">base = torch.tensor([[<span class="number">0</span>, <span class="number">1</span>],[<span class="number">2</span>, <span class="number">3</span>]])</span><br><span class="line">base.is_contiguous()</span><br><span class="line">t = base.transpose(<span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># `t` is a view of `base`. No data movement happened here.</span></span><br><span class="line">t.is_contiguous()</span><br><span class="line">c = t.contiguous()</span><br></pre></td></tr></table></figure><p><img data-src="https://s2.loli.net/2024/06/25/vKDYZ7A1jb3g9kO.png" alt="image-20240625212647753"></p><p><a href="https://zhuanlan.zhihu.com/p/342856639">é€šè¿‡å…¬å¼åˆ¤æ–­å¼ é‡æ˜¯å¦è¿ç»­ - çŸ¥ä¹ (zhihu.com)</a></p><h2 id="Extending-PyTorch"><a href="#Extending-PyTorch" class="headerlink" title="Extending PyTorch"></a>Extending PyTorch</h2><p>åŸæ–‡<a href="https://pytorch.org/docs/stable/notes/extending.html">Extending PyTorch â€” PyTorch 2.3 documentation</a></p><h3 id="extending-torch-autograd"><a href="#extending-torch-autograd" class="headerlink" title="extending torch.autograd"></a>extending torch.autograd</h3><p>ä¸º autograd æ·»åŠ æ“ä½œéœ€è¦ä¸ºæ¯ä¸ªæ“ä½œå®ç°ä¸€ä¸ªæ–°çš„ Function å­ç±».</p><h5 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h5><p>ä¸€èˆ¬æ¥è¯´,å¦‚æœæƒ³åœ¨æ¨¡å‹ä¸­<strong>æ‰§è¡Œä¸å¯å¾®åˆ†çš„è®¡ç®—æˆ–ä¾èµ–é PyTorch åº“</strong>ï¼ˆå¦‚ NumPyï¼‰,ä½†ä»å¸Œæœ›æ‚¨çš„æ“ä½œèƒ½ä¸å…¶ä»–æ“ä½œè¿é”å¹¶ä¸ autograd å¼•æ“ä¸€èµ·å·¥ä½œ,é‚£ä¹ˆè¯·ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°.</p><p>åœ¨æŸäº›æƒ…å†µä¸‹,ä¹Ÿå¯ä»¥<strong>ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°æ¥æé«˜æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨ç‡</strong>: å¦‚æœæ‚¨ä½¿ç”¨ C++ æ‰©å±•å®ç°äº†å‰å‘å’Œåå‘ä¼ é€’,æ‚¨å¯ä»¥å°†å®ƒä»¬å°è£…åœ¨ Function ä¸­,ä»¥ä¾¿ä¸ autograd å¼•æ“å¯¹æ¥.å¦‚æœæ‚¨æƒ³å‡å°‘ä¸ºåå‘ä¼ é€’ä¿å­˜çš„ç¼“å†²åŒºæ•°é‡,å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°å°†æ“ä½œç»„åˆåœ¨ä¸€èµ·.</p><p>å¦‚æœæƒ³åœ¨åå‘ä¼ é€’è¿‡ç¨‹ä¸­æ”¹å˜æ¢¯åº¦æˆ–æ‰§è¡Œå‰¯ä½œç”¨ï¼Œå¯ä»¥è€ƒè™‘registerä¸€ä¸ªå¼ é‡æˆ–æ¨¡å—hook</p><h5 id="ä»€ä¹ˆæ—¶å€™ä¸ç”¨"><a href="#ä»€ä¹ˆæ—¶å€™ä¸ç”¨" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä¸ç”¨"></a>ä»€ä¹ˆæ—¶å€™ä¸ç”¨</h5><p>å¦‚æœå·²ç»å¯ä»¥ç”¨ PyTorch çš„å†…ç½®æ“ä½œæ¥ç¼–å†™å‡½æ•°,é‚£ä¹ˆå®ƒçš„åå‘å›¾ï¼ˆå¾ˆå¯èƒ½ï¼‰å·²ç»å¯ä»¥è¢« autograd è®°å½•ä¸‹æ¥.åœ¨è¿™ç§æƒ…å†µä¸‹,ä¸éœ€è¦è‡ªå·±å®ç°åå‘å‡½æ•°.å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„ Python å‡½æ•°ã€‚</p><p>å¦‚æœéœ€è¦ç»´æŠ¤çŠ¶æ€,å³å¯è®­ç»ƒå‚æ•°,åˆ™åº”ï¼ˆä¹Ÿå¯ä»¥ï¼‰ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—torch.nn. </p><p>å¦‚æœæƒ³åœ¨åå‘ä¼ é€’è¿‡ç¨‹ä¸­æ”¹å˜æ¢¯åº¦æˆ–æ‰§è¡Œå‰¯ä½œç”¨,å¯ä»¥è€ƒè™‘æ³¨å†Œä¸€ä¸ªå¼ é‡æˆ–æ¨¡å—é’©å­ã€‚</p><blockquote><p>æ³¨æ„,æˆ‘åœ¨çœ‹pytorch2.3æ—¶ register_backward_hookå·²ç»deprecatedäº†,ä½¿ç”¨register_full_backward_hook</p></blockquote><p>ä½¿ç”¨ä¸€ä¸ª<code>register_full_backward_hook</code>å°†æ¢¯åº¦å˜ä¸ºç›¸åæ•°.</p><p><code>hook(module, grad_input, grad_output) -&gt; tuple(Tensor) æˆ– None</code><br>grad_input å’Œ grad_output æ˜¯å…ƒç»„ï¼Œåˆ†åˆ«åŒ…å«<strong>ç›¸å¯¹äºè¾“å…¥å’Œè¾“å‡ºçš„æ¢¯åº¦</strong>ã€‚<strong>é’©å­ä¸åº”ä¿®æ”¹å…¶å‚æ•°</strong>,ä½†<strong>å¯ä»¥é€‰æ‹©è¿”å›ä¸€ä¸ªæ–°çš„ç›¸å¯¹äºè¾“å…¥çš„æ¢¯åº¦ï¼Œè¯¥æ¢¯åº¦å°†åœ¨åç»­è®¡ç®—ä¸­ä»£æ›¿ grad_input</strong>.å¯¹äºæ‰€æœ‰éå¼ é‡å‚æ•°ï¼Œgrad_input å’Œ grad_output ä¸­çš„æ¡ç›®å‡ä¸º â€œNoneâ€.</p><p>å¦‚æœæƒ³åœ¨åå‘ä¼ é€’è¿‡ç¨‹ä¸­æ”¹å˜æ¢¯åº¦æˆ–æ‰§è¡Œå‰¯ä½œç”¨ï¼Œå¯ä»¥è€ƒè™‘æ³¨å†Œä¸€ä¸ªå¼ é‡æˆ–æ¨¡å—é’©å­.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backward_hook</span>(<span class="params">module, grad_input, grad_output</span>):</span></span><br><span class="line">    output_grad_input = - grad_input[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> (output_grad_input,)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">negGradient</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(negGradient, self).__init__()</span><br><span class="line">        self.register_full_backward_hook(backward_hook)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p>åœ¨domain adaptationçš„æ—©æœŸè®ºæ–‡æ¯”å¦‚DANNä¸­,ä¸€èˆ¬ä¼šä½¿ç”¨<code>Function</code>è¿›è¡Œæ¢¯åº¦å˜ä¸ºè´Ÿæ•°,å…¶å®ä¹Ÿå¯ä»¥æ³¨å†Œbackwardçš„hookå®ç°.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_GradReverseLayer</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">ctx, x, constant</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(constant, <span class="built_in">int</span>) <span class="keyword">and</span> constant &gt; <span class="number">0</span></span><br><span class="line">        ctx.constant = constant</span><br><span class="line">        <span class="keyword">return</span> x.view_as(x)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        <span class="keyword">return</span> grad_output.neg() * ctx.constant, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GradReverseLayer</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, weight</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(GradReverseLayer, self).__init__()</span><br><span class="line">        self.weight = weight</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> _GradReverseLayer.apply(x, self.weight)</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶ä»‹ç»äº†<code>register_full_backward_hook</code>,å†è¯´è¯´<code>register_forward_hook</code>,æ¯æ¬¡ forward() è®¡ç®—å®Œè¾“å‡ºåï¼Œéƒ½ä¼šè°ƒç”¨è¯¥é’©å­ã€‚å¦‚æœ with_kwargs ä¸º False æˆ–æœªæŒ‡å®šï¼Œè¾“å…¥å°†åªåŒ…å«ç»™æ¨¡å—çš„ä½ç½®å‚æ•°ã€‚å…³é”®å­—å‚æ•°ä¸ä¼šä¼ é€’ç»™é’©å­ï¼Œåªä¼šä¼ é€’ç»™ forwardã€‚<strong>é’©å­å¯ä»¥ä¿®æ”¹è¾“å‡º.é’©å­å¯ä»¥å°±åœ°ä¿®æ”¹è¾“å…¥,ä½†ä¸ä¼šå¯¹ forward äº§ç”Ÿå½±å“</strong>,å› ä¸ºé’©å­æ˜¯åœ¨è°ƒç”¨ forward() ä¹‹åæ‰è°ƒç”¨çš„.</p><p>å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« <a href="https://blog.csdn.net/m0_51661400/article/details/135091359">æ·±å…¥ç†è§£PyTorchä¸­çš„Hookæœºåˆ¶ï¼šç‰¹å¾å¯è§†åŒ–çš„é‡è¦å·¥å…·ä¸å®è·µ-CSDNåšå®¢</a></p><h5 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h5><p>é‡‡å–ä»¥ä¸‹æ­¥éª¤ 1. ç»§æ‰¿ç±» Function å¹¶å®ç° forward()ã€ï¼ˆå¯é€‰ï¼‰setup_context() å’Œ backward() æ–¹æ³•ã€‚2. åœ¨ ctx å‚æ•°ä¸Šè°ƒç”¨é€‚å½“çš„æ–¹æ³•ã€‚3. å£°æ˜æ‚¨çš„å‡½æ•°æ˜¯å¦æ”¯æŒ double backwardã€‚4. ä½¿ç”¨ gradcheck éªŒè¯æ¢¯åº¦æ˜¯å¦æ­£ç¡®ã€‚</p><p>step1:</p><ol><li>forward() æ˜¯æ‰§è¡Œæ“ä½œçš„ä»£ç ã€‚å®ƒå¯ä»¥æ¥å—ä»»æ„å¤šä¸ªå‚æ•°,å¦‚æœæŒ‡å®šé»˜è®¤å€¼,å…¶ä¸­ä¸€äº›å‚æ•°æ˜¯å¯é€‰çš„.åœ¨è°ƒç”¨ä¹‹å‰,è·Ÿè¸ªå†å²çš„å¼ é‡å‚æ•°ï¼ˆå³ requires_grad=Trueï¼‰å°†è¢«è½¬æ¢ä¸ºä¸è·Ÿè¸ªå†å²çš„å‚æ•°,å®ƒä»¬çš„ä½¿ç”¨å°†è¢«è®°å½•åœ¨å›¾ä¸­ã€‚è¯·æ³¨æ„,æ­¤é€»è¾‘ä¸ä¼šéå†åˆ—è¡¨/æ•°æ®é›†/ä»»ä½•å…¶ä»–æ•°æ®ç»“æ„,åªä¼šè€ƒè™‘ä½œä¸ºè°ƒç”¨ç›´æ¥å‚æ•°çš„å¼ é‡.æ‚¨å¯ä»¥è¿”å›ä¸€ä¸ªå¼ é‡è¾“å‡ºï¼Œå¦‚æœæœ‰å¤šä¸ªè¾“å‡ºï¼Œä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå¼ é‡å…ƒç»„ã€‚</li><li>setup_context()ï¼ˆå¯é€‰ï¼‰ã€‚å¯ä»¥ç¼–å†™ä¸€ä¸ªæ¥å— ctx å¯¹è±¡çš„ â€œç»„åˆ â€œforward()ï¼Œæˆ–è€…ï¼ˆä» PyTorch 2.0 å¼€å§‹ï¼‰ç¼–å†™ä¸€ä¸ªä¸æ¥å— ctx çš„å•ç‹¬ forward()ï¼Œä»¥åŠä¸€ä¸ªç”¨äºä¿®æ”¹ ctx çš„ setup_context()æ–¹æ³•ã€‚forward() åº”è¯¥å…·æœ‰è®¡ç®—åŠŸèƒ½ï¼Œè€Œ <strong>setup_context() åº”è¯¥åªè´Ÿè´£ä¿®æ”¹ ctxï¼ˆè€Œä¸å…·æœ‰ä»»ä½•è®¡ç®—åŠŸèƒ½</strong>ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç‹¬ç«‹çš„ forward() å’Œ setup_context()æ›´æ¥è¿‘ PyTorch æœ¬æœºæ“ä½œçš„å·¥ä½œæ–¹å¼ï¼Œå› æ­¤æ›´å®¹æ˜“ä¸å„ç§ PyTorch å­ç³»ç»Ÿå…¼å®¹ã€‚</li><li>backward()ï¼ˆæˆ– vjp()ï¼‰å®šä¹‰æ¢¯åº¦å…¬å¼ã€‚<strong>è¾“å‡ºæœ‰å¤šå°‘ä¸ªå¼ é‡å‚æ•°ï¼Œå®ƒå°±æœ‰å¤šå°‘ä¸ªå¼ é‡å‚æ•°ï¼Œæ¯ä¸ªå¼ é‡å‚æ•°éƒ½ä»£è¡¨è¯¥è¾“å‡ºçš„æ¢¯åº¦</strong>ã€‚<strong>åˆ‡å‹¿å°±åœ°ä¿®æ”¹è¿™äº›å‚æ•°ã€‚å®ƒåº”è¯¥è¿”å›ä¸è¾“å…¥ç›¸åŒæ•°é‡çš„å¼ é‡ï¼Œå…¶ä¸­æ¯ä¸ªå¼ é‡éƒ½åŒ…å«å¯¹åº”è¾“å…¥çš„æ¢¯åº¦ã€‚</strong>å¦‚æœè¾“å…¥ä¸éœ€è¦æ¢¯åº¦ï¼ˆneeds_input_grad æ˜¯ä¸€ä¸ªå¸ƒå°”å…ƒç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªè¾“å…¥æ˜¯å¦éœ€è¦æ¢¯åº¦è®¡ç®—ï¼‰,æˆ–è€…æ˜¯éå¼ é‡å¯¹è±¡ï¼Œåˆ™å¯ä»¥è¿”å› python:Noneã€‚æ­¤å¤–,å¦‚æœ forward() çš„å‚æ•°æ˜¯å¯é€‰çš„,åªè¦å®ƒä»¬éƒ½æ˜¯ None,è¿”å›çš„æ¢¯åº¦å€¼å°±ä¼šå¤šäºè¾“å…¥å€¼ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exp</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">ctx, i</span>):</span></span><br><span class="line">        result = i.exp()</span><br><span class="line">        ctx.save_for_backward(result)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        result, = ctx.saved_tensors</span><br><span class="line">        <span class="keyword">return</span> grad_output * result</span><br><span class="line"><span class="comment"># Use it by calling the apply method:</span></span><br><span class="line">output = Exp.apply(<span class="built_in">input</span>)</span><br></pre></td></tr></table></figure><p>step 2ï¼šæ­£ç¡®ä½¿ç”¨ ctx ä¸­çš„å‡½æ•°ï¼Œä»¥ç¡®ä¿æ–°å‡½æ•°åœ¨ autograd å¼•æ“ä¸­æ­£å¸¸å·¥ä½œã€‚</p><p>ctxä¸Šæœ‰è®¸å¤šæ–¹æ³•å¯ç”¨äºè°ƒç”¨,æ¯”è¾ƒå¤šçš„å°±æ˜¯<code>save_for_backward</code></p><blockquote><p>å¿…é¡»<strong>ä½¿ç”¨ save_for_backward()æ¥ä¿å­˜è¦åœ¨åå‘ä¼ é€’ä¸­ä½¿ç”¨çš„å¼ é‡</strong>ã€‚<strong>éå¼ é‡åº”ç›´æ¥ä¿å­˜åœ¨ ctx ä¸Š</strong>ã€‚å¦‚æœæ—¢ä¸æ˜¯è¾“å…¥ä¹Ÿä¸æ˜¯è¾“å‡ºçš„å¼ é‡è¢«ä¿å­˜,é‚£å‡½æ•°å‡½æ•°å¯èƒ½ä¸æ”¯æŒdouble backward ã€‚</p></blockquote><p>æ­¤å¤–è¿˜æœ‰<code>set_materialize_grads</code></p><blockquote><p>set_materialize_grads()å¯ä»¥ç”¨æ¥å‘Šè¯‰ autograd å¼•æ“ï¼Œåœ¨è¾“å‡ºä¸ä¾èµ–äºè¾“å…¥çš„æƒ…å†µä¸‹ï¼Œ<strong>é€šè¿‡ä¸å¯¹åå‘å‡½æ•°ä¸­çš„æ¢¯åº¦å¼ é‡è¿›è¡Œå®ä½“åŒ–æ¥ä¼˜åŒ–æ¢¯åº¦è®¡ç®—</strong>ã€‚</p></blockquote><p>step3:å¦‚æœå‡½æ•°ä¸æ”¯æŒdouble backward ï¼Œåˆ™åº”é€šè¿‡ä½¿ç”¨ once_differentiable() å¯¹é€†è¿ç®—è¿›è¡Œè£…é¥°æ¥æ˜ç¡®å£°æ˜è¿™ä¸€ç‚¹ã€‚ä½¿ç”¨æ­¤è£…é¥°å™¨åï¼Œé€šè¿‡å‡½æ•°æ‰§è¡Œdouble backward çš„å°è¯•å°†äº§ç”Ÿé”™è¯¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.autograd.gradcheck(Exp.apply, x)</span><br></pre></td></tr></table></figure><p>step4:å»ºè®®ä½¿ç”¨ torch.autograd.gradcheck() æ£€æŸ¥åå‘å‡½æ•°æ˜¯å¦èƒ½æ­£ç¡®è®¡ç®—å‰å‘æ¢¯åº¦,æ–¹æ³•æ˜¯ä½¿ç”¨åå‘å‡½æ•°è®¡ç®—é›…å„å¸ƒçŸ©é˜µ,å¹¶å°†è¯¥å€¼ä¸ä½¿ç”¨æœ‰é™å·®åˆ†æ³•æ•°å€¼è®¡ç®—çš„é›…å„å¸ƒå€¼è¿›è¡Œé€å…ƒç´ æ¯”è¾ƒã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inherit from Function</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearFunction</span>(<span class="params">Function</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Note that forward, setup_context, and backward are @staticmethods</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params"><span class="built_in">input</span>, weight, bias</span>):</span></span><br><span class="line">        output = <span class="built_in">input</span>.mm(weight.t())</span><br><span class="line">        <span class="keyword">if</span> bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            output += bias.unsqueeze(<span class="number">0</span>).expand_as(output)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="comment"># inputs is a Tuple of all of the inputs passed to forward.</span></span><br><span class="line">    <span class="comment"># output is the output of the forward().</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_context</span>(<span class="params">ctx, inputs, output</span>):</span></span><br><span class="line">        <span class="built_in">input</span>, weight, bias = inputs</span><br><span class="line">        ctx.save_for_backward(<span class="built_in">input</span>, weight, bias)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This function has only a single output, so it gets only one gradient</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        <span class="comment"># This is a pattern that is very convenient - at the top of backward</span></span><br><span class="line">        <span class="comment"># unpack saved_tensors and initialize all gradients w.r.t. inputs to</span></span><br><span class="line">        <span class="comment"># None. Thanks to the fact that additional trailing Nones are</span></span><br><span class="line">        <span class="comment"># ignored, the return statement is simple even when the function has</span></span><br><span class="line">        <span class="comment"># optional inputs.</span></span><br><span class="line">        <span class="built_in">input</span>, weight, bias = ctx.saved_tensors</span><br><span class="line">        grad_input = grad_weight = grad_bias = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># These needs_input_grad checks are optional and there only to</span></span><br><span class="line">        <span class="comment"># improve efficiency. If you want to make your code simpler, you can</span></span><br><span class="line">        <span class="comment"># skip them. Returning gradients for inputs that don&#x27;t require it is</span></span><br><span class="line">        <span class="comment"># not an error.</span></span><br><span class="line">        <span class="keyword">if</span> ctx.needs_input_grad[<span class="number">0</span>]:</span><br><span class="line">            grad_input = grad_output.mm(weight)</span><br><span class="line">        <span class="keyword">if</span> ctx.needs_input_grad[<span class="number">1</span>]:</span><br><span class="line">            grad_weight = grad_output.t().mm(<span class="built_in">input</span>)</span><br><span class="line">        <span class="keyword">if</span> bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> ctx.needs_input_grad[<span class="number">2</span>]:</span><br><span class="line">            grad_bias = grad_output.<span class="built_in">sum</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> grad_input, grad_weight, grad_bias</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­å·²ç»å†™å¾—å¾ˆå¥½äº†.ä¸ºäº†æ›´æ–¹ä¾¿åœ°ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰æ“ä½œï¼Œ<strong>å»ºè®®å°†å®ƒä»¬åˆ«åæˆ–å°è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ã€‚</strong>ä½¿ç”¨å‡½æ•°å°è£…å¯ä»¥è®©æˆ‘ä»¬æ”¯æŒé»˜è®¤å‚æ•°å’Œå…³é”®å­—å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Option 1: alias</span></span><br><span class="line">linear = LinearFunction.apply</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option 2: wrap in a function, to support default args and keyword args.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear</span>(<span class="params"><span class="built_in">input</span>, weight, bias=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> LinearFunction.apply(<span class="built_in">input</span>, weight, bias)</span><br></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜æœ‰è¾“å…¥æ²¡æœ‰tensorçš„æƒ…å†µ,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MulConstant</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">tensor, constant</span>):</span></span><br><span class="line">        <span class="keyword">return</span> tensor * constant</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_context</span>(<span class="params">ctx, inputs, output</span>):</span></span><br><span class="line">        <span class="comment"># ctx is a context object that can be used to stash information</span></span><br><span class="line">        <span class="comment"># for backward computation</span></span><br><span class="line">        tensor, constant = inputs</span><br><span class="line">        ctx.constant = constant <span class="comment"># æ³¨æ„è¿™é‡Œç›´æ¥ä½¿ç”¨ctx.xx = xx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        <span class="comment"># We return as many input gradients as there were arguments.</span></span><br><span class="line">        <span class="comment"># Gradients of non-Tensor arguments to forward must be None.</span></span><br><span class="line">        <span class="keyword">return</span> grad_output * ctx.constant, <span class="literal">None</span></span><br><span class="line">  <span class="comment"># ä¸Šé¢ä»£ç å¯ä»¥æ”¹ä¸º ä½¿ç”¨set_materialize_grads,å› ä¸ºè®¡ç®—æ¢¯åº¦ä¸éœ€è¦tensor.</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MulConstant</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">tensor, constant</span>):</span></span><br><span class="line">        <span class="keyword">return</span> tensor * constant</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_context</span>(<span class="params">ctx, inputs, output</span>):</span></span><br><span class="line">        tensor, constant = inputs</span><br><span class="line">        ctx.set_materialize_grads(<span class="literal">False</span>)</span><br><span class="line">        ctx.constant = constant</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        <span class="comment"># Here we must handle None grad_output tensor. In this case we</span></span><br><span class="line">        <span class="comment"># can skip unnecessary computations and just return None.</span></span><br><span class="line">        <span class="keyword">if</span> grad_output <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># We return as many input gradients as there were arguments.</span></span><br><span class="line">        <span class="comment"># Gradients of non-Tensor arguments to forward must be None.</span></span><br><span class="line">        <span class="keyword">return</span> grad_output * ctx.constant, <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ä¿å­˜åœ¨ forward() ä¸­è®¡ç®—çš„ä»»ä½• â€œä¸­é—´ â€œå¼ é‡ï¼Œå¿…é¡»å°†å®ƒä»¬ä½œä¸ºè¾“å‡ºè¿”å›ï¼Œæˆ–è€…å°† forward å’Œ setup_context()åˆå¹¶.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCube</span>(<span class="params">torch.autograd.Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="comment"># We wish to save dx for backward. In order to do so, it must</span></span><br><span class="line">        <span class="comment"># be returned as an output.</span></span><br><span class="line">        dx = <span class="number">3</span> * x ** <span class="number">2</span></span><br><span class="line">        result = x ** <span class="number">3</span></span><br><span class="line">        <span class="keyword">return</span> result, dx</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_context</span>(<span class="params">ctx, inputs, output</span>):</span></span><br><span class="line">        x, = inputs</span><br><span class="line">        result, dx = output</span><br><span class="line">        ctx.save_for_backward(x, dx)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output, grad_dx</span>):</span></span><br><span class="line">        x, dx = ctx.saved_tensors</span><br><span class="line">        <span class="comment"># In order for the autograd.Function to work with higher-order</span></span><br><span class="line">        <span class="comment"># gradients, we must add the gradient contribution of `dx`,</span></span><br><span class="line">        <span class="comment"># which is grad_dx * 6 * x.</span></span><br><span class="line">        result = grad_output * dx + grad_dx * <span class="number">6</span> * x</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrap MyCube in a function so that it is clearer what the output is</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_cube</span>(<span class="params">x</span>):</span></span><br><span class="line">    result, dx = MyCube.apply(x)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>å°†forwardå’Œsetup_contextåˆåœ¨ä¸€èµ·</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearFunction</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="comment"># ctx is the first argument to forward</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">ctx, <span class="built_in">input</span>, weight, bias=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># The forward pass can use ctx.</span></span><br><span class="line">        ctx.save_for_backward(<span class="built_in">input</span>, weight, bias)</span><br><span class="line">        output = <span class="built_in">input</span>.mm(weight.t())</span><br><span class="line">        <span class="keyword">if</span> bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            output += bias.unsqueeze(<span class="number">0</span>).expand_as(output)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        <span class="built_in">input</span>, weight, bias = ctx.saved_tensors</span><br><span class="line">        grad_input = grad_weight = grad_bias = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ctx.needs_input_grad[<span class="number">0</span>]:</span><br><span class="line">            grad_input = grad_output.mm(weight)</span><br><span class="line">        <span class="keyword">if</span> ctx.needs_input_grad[<span class="number">1</span>]:</span><br><span class="line">            grad_weight = grad_output.t().mm(<span class="built_in">input</span>)</span><br><span class="line">        <span class="keyword">if</span> bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> ctx.needs_input_grad[<span class="number">2</span>]:</span><br><span class="line">            grad_bias = grad_output.<span class="built_in">sum</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> grad_input, grad_weight, grad_bias</span><br></pre></td></tr></table></figure><h3 id="extending-torch-nn"><a href="#extending-torch-nn" class="headerlink" title="extending torch.nn"></a>extending torch.nn</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Linear</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, input_features, output_features, bias=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.input_features = input_features</span><br><span class="line">        self.output_features = output_features</span><br><span class="line"></span><br><span class="line">        <span class="comment"># nn.Parameter is a special kind of Tensor, that will get</span></span><br><span class="line">        <span class="comment"># automatically registered as Module&#x27;s parameter once it&#x27;s assigned</span></span><br><span class="line">        <span class="comment"># as an attribute. Parameters and buffers need to be registered, or</span></span><br><span class="line">        <span class="comment"># they won&#x27;t appear in .parameters() (doesn&#x27;t apply to buffers), and</span></span><br><span class="line">        <span class="comment"># won&#x27;t be converted when e.g. .cuda() is called. You can use</span></span><br><span class="line">        <span class="comment"># .register_buffer() to register buffers.</span></span><br><span class="line">        <span class="comment"># nn.Parameters require gradients by default.</span></span><br><span class="line">        self.weight = nn.Parameter(torch.empty(output_features, input_features))</span><br><span class="line">        <span class="keyword">if</span> bias:</span><br><span class="line">            self.bias = nn.Parameter(torch.empty(output_features))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># You should always register all possible parameters, but the</span></span><br><span class="line">            <span class="comment"># optional ones can be None if you want.</span></span><br><span class="line">            self.register_parameter(<span class="string">&#x27;bias&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Not a very smart way to initialize weights</span></span><br><span class="line">        nn.init.uniform_(self.weight, -<span class="number">0.1</span>, <span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> self.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            nn.init.uniform_(self.bias, -<span class="number">0.1</span>, <span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, <span class="built_in">input</span></span>):</span></span><br><span class="line">        <span class="comment"># See the autograd section for explanation of what happens here.</span></span><br><span class="line">        <span class="keyword">return</span> LinearFunction.apply(<span class="built_in">input</span>, self.weight, self.bias)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extra_repr</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># (Optional)Set the extra information about this module. You can test</span></span><br><span class="line">        <span class="comment"># it by printing an object of this class.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;input_features=&#123;&#125;, output_features=&#123;&#125;, bias=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self.input_features, self.output_features, self.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡å®šä¹‰å…·æœ‰ä¸ Tensor åŒ¹é…çš„æ–¹æ³•çš„è‡ªå®šä¹‰ç±»æ¥åˆ›å»ºæ¨¡æ‹Ÿ Tensor çš„è‡ªå®šä¹‰ç±»å‹ã€‚å¦‚æœè‡ªå®šä¹‰ Python ç±»å‹å®šä¹‰äº†åä¸º<code>__torch_function__</code>çš„æ–¹æ³•ï¼Œå½“æ‚¨çš„è‡ªå®šä¹‰ç±»çš„å®ä¾‹<strong>è¢«ä¼ é€’ç»™ torch å‘½åç©ºé—´ä¸­çš„å‡½æ•°æ—¶</strong>ï¼ŒPyTorch å°†è°ƒç”¨æ‚¨çš„ <code>__torch_function__</code>å®ç°ã€‚è¿™ä½¿å¾—ä¸º torch å‘½åç©ºé—´ä¸­çš„ä»»ä½•å‡½æ•°å®šä¹‰è‡ªå®šä¹‰å®ç°æˆä¸ºå¯èƒ½ï¼Œ<code>__torch_function__</code>å®ç°å¯ä»¥è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œä»è€Œå…è®¸æ‚¨çš„ç”¨æˆ·åœ¨ä»–ä»¬å·²ç»ä¸º Tensor ç¼–å†™çš„ç°æœ‰ PyTorch å·¥ä½œæµä¸­ä½¿ç”¨æ‚¨çš„è‡ªå®šä¹‰ç±»å‹ã€‚</p><p>è¿™é€‚ç”¨äº<strong>ä¸ Tensor æ— å…³çš„ â€œduck â€œç±»å‹</strong>ä»¥åŠ <strong>Tensor å­ç±»</strong>ã€‚</p><h5 id="Extending-torch-Tensor-like-type"><a href="#Extending-torch-Tensor-like-type" class="headerlink" title="Extending torch Tensor-like type"></a>Extending torch Tensor-like type</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">HANDLED_FUNCTIONS = &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalarTensor</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, N, value</span>):</span></span><br><span class="line">        self._N = N</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ScalarTensor(N=&#123;&#125;, value=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(self._N, self._value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tensor</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._value * torch.eye(self._N)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__torch_function__</span>(<span class="params">cls, func, types, args=(<span class="params"></span>), kwargs=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> kwargs <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">not</span> <span class="keyword">in</span> HANDLED_FUNCTIONS <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">all</span>(</span><br><span class="line">            <span class="built_in">issubclass</span>(t, (torch.Tensor, ScalarTensor))</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> types</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line">        <span class="keyword">return</span> HANDLED_FUNCTIONS[func](*args, **kwargs)</span><br></pre></td></tr></table></figure><p>ä¸º ScalarTensor æ·»åŠ  <code>__torch_function__</code> å®ç°å,ä¸Šè¿°æ“ä½œå°±æœ‰å¯èƒ½æˆåŠŸ.è¿™æ¬¡æ·»åŠ ä¸€ä¸ª<code>__torch_function__</code> å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">HANDLED_FUNCTIONS = &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalarTensor</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, N, value</span>):</span></span><br><span class="line">        self._N = N</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ScalarTensor(N=&#123;&#125;, value=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(self._N, self._value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tensor</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._value * torch.eye(self._N)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__torch_function__</span>(<span class="params">cls, func, types, args=(<span class="params"></span>), kwargs=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> kwargs <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">not</span> <span class="keyword">in</span> HANDLED_FUNCTIONS <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">all</span>(</span><br><span class="line">            <span class="built_in">issubclass</span>(t, (torch.Tensor, ScalarTensor))</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> types</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line">        <span class="keyword">return</span> HANDLED_FUNCTIONS[func](*args, **kwargs)</span><br></pre></td></tr></table></figure><p><code>__torch_function__</code>æ–¹æ³•éœ€è¦å››ä¸ªå‚æ•°:func,å¯¹è¦é‡è½½çš„ torch API å‡½æ•°çš„å¼•ç”¨ï¼›typesï¼Œå®ç° <code>__torch_function__</code>çš„ Tensor-likes ç±»å‹åˆ—è¡¨ï¼›args,ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°å…ƒç»„ï¼›kwargs,ä¼ é€’ç»™å‡½æ•°çš„å…³é”®å­—å‚æ•° dict,å®ƒä½¿ç”¨åä¸º HANDLED_FUNCTIONS çš„å…¨å±€è°ƒåº¦è¡¨æ¥å­˜å‚¨è‡ªå®šä¹‰å®ç°.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">implements</span>(<span class="params">torch_function</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Register a torch function override for ScalarTensor&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line">        functools.update_wrapper(func, torch_function)</span><br><span class="line">        HANDLED_FUNCTIONS[torch_function] = func</span><br><span class="line">        <span class="keyword">return</span> func</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="meta">@implements(<span class="params">torch.mean</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mean</span>(<span class="params"><span class="built_in">input</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">float</span>(<span class="built_in">input</span>._value) / <span class="built_in">input</span>._N</span><br><span class="line"></span><br><span class="line">d = ScalarTensor(<span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">torch.mean(d)</span><br></pre></td></tr></table></figure><p>ä» 1.7.0 ç‰ˆå¼€å§‹ï¼Œåº”ç”¨äº torch.Tensor å­ç±»çš„ <strong>torch.Tensor æ–¹æ³•</strong>å’Œ<strong>å…¬å…± torch.* å‘½åç©ºé—´ä¸­çš„å‡½æ•°</strong>å°†è¿”å›å­ç±»å®ä¾‹ï¼Œè€Œä¸æ˜¯ torch.Tensor å®ä¾‹.</p><p>å¦‚æœå¸Œæœ›å¯¹æ‰€æœ‰å¼ é‡æ–¹æ³•è¿›è¡Œå…¨å±€è¦†ç›–,å¯ä»¥ä½¿ç”¨<code>__torch_function__</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggingTensor</span>(<span class="params">torch.Tensor</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__torch_function__</span>(<span class="params">cls, func, types, args=(<span class="params"></span>), kwargs=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> Logging calls Tensor.__repr__, so we can&#x27;t log __repr__ without infinite recursion</span></span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">is</span> <span class="keyword">not</span> torch.Tensor.__repr__:</span><br><span class="line">            logging.info(<span class="string">f&quot;func: <span class="subst">&#123;func.__name__&#125;</span>, args: <span class="subst">&#123;args!r&#125;</span>, kwargs: <span class="subst">&#123;kwargs!r&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> kwargs <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            kwargs = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__torch_function__(func, types, args, kwargs)</span><br></pre></td></tr></table></figure><p>åœ¨å­ç±»çš„<code>__torch_function__</code> ä¸­åº”æ³¨æ„å§‹ç»ˆè°ƒç”¨ super().<strong>torch_function</strong>(func,â€¦)ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ funcã€‚å¦‚æœä¸è¿™æ ·åšï¼Œå¯èƒ½ä¼šå¯¼è‡´ func è¿”å›åˆ° <code>__torch_function__</code>ä¸­ï¼Œä»è€Œå¼•èµ·æ— é™é€’å½’ã€‚</p><h2 id="torch-autograd"><a href="#torch-autograd" class="headerlink" title="torch.autograd"></a>torch.autograd</h2><p>torch.autograd æä¾›äº†å®ç°ä»»æ„æ ‡é‡å€¼å‡½æ•°è‡ªåŠ¨å¾®åˆ†çš„ç±»å’Œå‡½æ•°.</p><p>å®ƒåªéœ€å¯¹ç°æœ‰ä»£ç åšæå°‘çš„æ”¹åŠ¨â€”ä½ åªéœ€ç”¨ requires_grad=True å…³é”®å­—å£°æ˜éœ€è¦è®¡ç®—æ¢¯åº¦çš„å¼ é‡.</p><p>ç›®å‰åªæŒæµ®ç‚¹å¼ é‡ç±»å‹ï¼ˆåŠæµ®ç‚¹ã€æµ®ç‚¹ã€åŒæµ®ç‚¹å’Œ bfloat16ï¼‰å’Œå¤åˆå¼ é‡ç±»å‹ï¼ˆcfloatã€cdoubleï¼‰çš„ autograd.</p><h3 id="detach-è®¡ç®—å›¾ä¸leaf-tensor"><a href="#detach-è®¡ç®—å›¾ä¸leaf-tensor" class="headerlink" title="detach è®¡ç®—å›¾ä¸leaf tensor"></a>detach è®¡ç®—å›¾ä¸leaf tensor</h3><p><code>Tensor.detach()</code>è¿”å›ä¸€ä¸ªä»å½“å‰è®¡ç®—å›¾ä¸­åˆ†ç¦»å‡ºæ¥çš„æ–°å¼ é‡,ç”Ÿæˆçš„å¼ é‡æ°¸è¿œä¸éœ€è¦æ¢¯åº¦,ç›®å‰æ›¿ä»£äº†<code>.data</code>æ–¹æ³•.</p><p> PyTorch ä¸­,è®¡ç®—å›¾(Computation Graph)æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µ.å®ƒæ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºå’Œæ‰§è¡Œæœºå™¨å­¦ä¹ æ¨¡å‹çš„æ•°æ®ç»“æ„.</p><p>å…·ä½“æ¥è¯´,PyTorch ä¸­çš„è®¡ç®—å›¾ç”±ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ç»„æˆ:</p><ol><li><strong>å¼ é‡(Tensor)</strong>:è®¡ç®—å›¾çš„åŸºæœ¬å•å…ƒ,è¡¨ç¤ºè¾“å…¥æ•°æ®ã€ä¸­é—´ç»“æœå’Œæœ€ç»ˆè¾“å‡º.</li><li><strong>æ“ä½œ(Operation)</strong>:åœ¨å¼ é‡ä¸Šæ‰§è¡Œçš„å„ç§æ•°å­¦è¿ç®—,å¦‚åŠ æ³•ã€ä¹˜æ³•ã€å·ç§¯ç­‰.</li><li><strong>èŠ‚ç‚¹(Node)</strong>:è¡¨ç¤ºå¼ é‡å’Œæ“ä½œ,è®¡ç®—å›¾ç”±è¿™äº›èŠ‚ç‚¹ç»„æˆ.</li><li><strong>è¾¹(Edge)</strong>:è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»,æ•°æ®æ²¿ç€è¾¹æµåŠ¨.</li></ol><p>å½“åœ¨ PyTorch ä¸­å®šä¹‰å’Œæ‰§è¡Œæœºå™¨å­¦ä¹ æ¨¡å‹æ—¶,PyTorch ä¼šè‡ªåŠ¨æ„å»ºä¸€ä¸ªè®¡ç®—å›¾æ¥è¡¨ç¤ºæ¨¡å‹çš„ç»“æ„å’Œæ•°æ®æµ.è¿™ä¸ªè®¡ç®—å›¾å¯ä»¥ç”¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢:</p><ol><li><strong>å‰å‘ä¼ æ’­</strong>:é€šè¿‡è®¡ç®—å›¾,PyTorch å¯ä»¥è‡ªåŠ¨è®¡ç®—æ¨¡å‹çš„è¾“å‡º.</li><li><strong>åå‘ä¼ æ’­</strong>:å½“æ‚¨è°ƒç”¨ <code>loss.backward()</code> æ—¶,PyTorch ä¼šæ²¿ç€è®¡ç®—å›¾åå‘ä¼ æ’­æ¢¯åº¦,ä»è€Œæ›´æ–°æ¨¡å‹å‚æ•°.</li><li><strong>å¯è§†åŒ–</strong>:æ‚¨å¯ä»¥ä½¿ç”¨ PyTorch æä¾›çš„å·¥å…·(å¦‚ TensorBoard)æ¥å¯è§†åŒ–è®¡ç®—å›¾,æ›´å¥½åœ°ç†è§£æ¨¡å‹çš„ç»“æ„.</li><li><strong>ä¼˜åŒ–</strong>:PyTorch çš„ä¼˜åŒ–å™¨ä¼šåˆ©ç”¨è®¡ç®—å›¾çš„ç»“æ„æ¥æé«˜ä¼˜åŒ–æ•ˆç‡.</li></ol><p>detachä½¿å¾—tensorä»è®¡ç®—å›¾ä¸­åˆ†ç¦»å…·ä½“æ˜¯ä»€ä¹ˆå«ä¹‰?ç®€å•æ¥è¯´,ä½¿å¾—å®ƒæœ¬èº«requires_grad=False,å®ƒä¹‹å‰çš„è®¡ç®—ä¹Ÿè¢«é˜»æ–­äº†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span> = torch.randn(<span class="number">1</span>, <span class="number">20</span>, <span class="number">10</span>)</span><br><span class="line">model = nn.Linear(<span class="number">10</span>, <span class="number">3</span>)</span><br><span class="line">inter = model(<span class="built_in">input</span>)</span><br><span class="line">model2 = nn.Linear(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">output = model2(inter.detach())</span><br><span class="line">loss = torch.mean(output - <span class="number">1</span>)</span><br><span class="line">loss.backward()</span><br><span class="line"><span class="built_in">print</span>(model.weight.grad) <span class="comment"># None</span></span><br></pre></td></tr></table></figure><p>æŒ‰ç…§æƒ¯ä¾‹,æ‰€æœ‰<strong>requires_grad ä¸ºFalseçš„å¼ é‡éƒ½æ˜¯leaf tensor</strong>.</p><p>å¯¹äº<strong>requires_grad ä¸º True çš„å¼ é‡,å¦‚æœå®ƒä»¬æ˜¯ç”±ç”¨æˆ·åˆ›å»º(æ²¡æœ‰ç»è¿‡è®¡ç®—,åŒ…æ‹¬ç§»åŠ¨åˆ°GPUçš„æ“ä½œ)çš„,é‚£ä¹ˆå®ƒä»¬å°†æ˜¯å¶å­å¼ é‡</strong>.è¿™æ„å‘³ç€å®ƒä»¬ä¸æ˜¯æ“ä½œçš„ç»“æœ,å› æ­¤ grad_fn ä¸º None.</p><p>åªæœ‰å¶å­å¼ é‡æ‰ä¼šåœ¨è°ƒç”¨ backward() æ—¶è¢«å¡«å……æ¢¯åº¦.è¦ä¸ºéå¶å­å¼ é‡å¡«å……é˜¶å€¼,å¯ä»¥ä½¿ç”¨ retain_grad().</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xx = torch.randn(<span class="number">1</span>, <span class="number">3</span>).requires_grad_(<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(xx.grad_fn, xx.is_leaf) <span class="comment"># None,True</span></span><br><span class="line">model = nn.Linear(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">output = model(xx)</span><br><span class="line">loss = torch.mean(output - <span class="number">1</span>)</span><br><span class="line">loss.backward()</span><br><span class="line"><span class="built_in">print</span>(xx.grad_fn, xx.grad) <span class="comment"># None,tensor([[.., ..,  ..]])</span></span><br><span class="line"><span class="built_in">print</span>(model.weight.grad_fn, model.weight.grad) <span class="comment"># None,,tensor([[.., ..,  ..]])</span></span><br><span class="line"><span class="built_in">print</span>(model.bias.grad_fn, model.bias.grad) <span class="comment"># None,tensor([1])</span></span><br><span class="line"><span class="built_in">print</span>(model.weight.is_leaf, model.bias.is_leaf) <span class="comment"># True,True</span></span><br></pre></td></tr></table></figure><p>åªèƒ½è·å–è®¡ç®—å›¾ä¸­å¶å­èŠ‚ç‚¹çš„æ¢¯åº¦å±æ€§,è¿™äº›èŠ‚ç‚¹çš„ requires_grad å±æ€§è®¾ç½®ä¸º True.å¯¹äºå›¾ä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹,æ¢¯åº¦å±æ€§å°†ä¸å¯ç”¨.</p><p>å‡ºäºæ€§èƒ½è€ƒè™‘,æˆ‘ä»¬åªèƒ½åœ¨ç»™å®šå›¾å½¢ä¸Šä½¿ç”¨ä¸€æ¬¡åå‘æ“ä½œæ‰§è¡Œæ¢¯åº¦è®¡ç®—.å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨åŒä¸€å›¾å½¢ä¸Šæ‰§è¡Œå¤šæ¬¡ backward è°ƒç”¨,åˆ™éœ€è¦å‘ backward è°ƒç”¨ä¼ é€’ retain_graph=True å±æ€§.</p><p>å‡ ä¸ªé—®é¢˜:</p><p>leaf tensorçš„grad_fnä¸€å®šä¸ºç©ºå—? ä¸ä¸€å®š,ç”¨æˆ·åˆ›å»ºçš„requires_gradä¸ºTrueçš„tensorçš„grad_fnä¸ä¸ºç©º</p><p>leaf tensorä¸€å®šæ˜¯æ¨¡å‹è¾“å…¥å—?ä¸ä¸€å®š,äº‹å®ä¸Šç›´æ¥åˆ›å»ºä¸€ä¸ªæ¨¡å‹,å®ƒçš„weightå’Œbiasä¹Ÿæ˜¯leaf tensor</p><h3 id="å±äºæ—§æ—¶ä»£çš„Variableå’Œdata"><a href="#å±äºæ—§æ—¶ä»£çš„Variableå’Œdata" class="headerlink" title="å±äºæ—§æ—¶ä»£çš„Variableå’Œdata"></a>å±äºæ—§æ—¶ä»£çš„Variableå’Œdata</h3><p>Variable API å·²è¢«å¼ƒç”¨:ä½¿ç”¨å¼ é‡æ—¶,ä¸å†éœ€è¦Variable.å¦‚æœ requires_grad è®¾ç½®ä¸º True,Autograd å°†è‡ªåŠ¨æ”¯æŒå¼ é‡.</p><p>Variable(tensor) å’Œ Variable(tensor, requires_grad) ä»æŒ‰é¢„æœŸå·¥ä½œ,ä½†å®ƒä»¬è¿”å›çš„æ˜¯å¼ é‡è€Œä¸æ˜¯å˜é‡.</p><p>var.data ä¸ tensor.data ç›¸åŒ.</p><p>var.backward()ã€var.detach()ã€var.register_hook() ç­‰æ–¹æ³•ç°åœ¨å¯ä»¥åœ¨å…·æœ‰ç›¸åŒæ–¹æ³•åçš„å¼ é‡ä¸Šè¿è¡Œ.</p><p>æ­¤å¤–,ç°åœ¨è¿˜å¯ä»¥ä½¿ç”¨ torch.randn()ã€torch.zeros()ã€torch.none() ç­‰å·¥å‚æ–¹æ³•åˆ›å»º requires_grad=True çš„å¼ é‡:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autograd_tensor = torch.randn((<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>), requires_grad=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>api</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td><code>torch.Tensor.grad</code></td><td>This attribute is <code>None</code> by default and becomes a Tensor the first time a call to <a href="https://pytorch.org/docs/stable/generated/torch.autograd.backward.html#torch.autograd.backward"><code>backward()</code></a> computes gradients for <code>self</code></td></tr><tr><td><code>torch.Tensor.requires_grad</code></td><td>Is <code>True</code> if gradients need to be computed for this Tensor, <code>False</code> otherwise.</td></tr><tr><td><code>torch.Tensor.is_leaf</code></td><td>All Tensors that have <code>requires_grad</code> which is <code>False</code> will be leaf Tensors by convention.</td></tr><tr><td><code>torch.Tensor.backward</code>([gradient, â€¦])</td><td>Computes the gradient of current tensor wrt graph leaves.</td></tr><tr><td><code>torch.Tensor.detach</code></td><td>Returns a new Tensor, detached from the current graph.</td></tr><tr><td><code>torch.Tensor.detach_</code></td><td>Detaches the Tensor from the graph that created it, making it a leaf.</td></tr><tr><td><code>torch.Tensor.register_hook</code>(hook)</td><td>Registers a backward hook.</td></tr><tr><td><code>torch.Tensor.register_post_accumulate_grad_hook</code>(hook)</td><td>Registers a backward hook that runs after grad accumulation.</td></tr><tr><td><code>torch.Tensor.retain_grad</code>()</td><td>Enables this Tensor to have their <a href="https://pytorch.org/docs/stable/generated/torch.autograd.grad.html#torch.autograd.grad"><code>grad</code></a> populated during <a href="https://pytorch.org/docs/stable/generated/torch.autograd.backward.html#torch.autograd.backward"><code>backward()</code></a>.</td></tr></tbody></table></div><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>è¦åˆ›å»ºè‡ªå®šä¹‰ autograd.Function,è¯·ç»§æ‰¿è¯¥ç±»å¹¶å®ç° forward() å’Œ backward() é™æ€æ–¹æ³•.ç„¶å,è¦åœ¨å‰å‘ä¼ é€’ä¸­ä½¿ç”¨è‡ªå®šä¹‰ op,è°ƒç”¨ç±»æ–¹æ³• apply.ä¸è¦ç›´æ¥è°ƒç”¨ forward().</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exp</span>(<span class="params">Function</span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">ctx, i</span>):</span></span><br><span class="line">        result = i.exp()</span><br><span class="line">        ctx.save_for_backward(result)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span>(<span class="params">ctx, grad_output</span>):</span></span><br><span class="line">        result, = ctx.saved_tensors</span><br><span class="line">        <span class="keyword">return</span> grad_output * result</span><br><span class="line"></span><br><span class="line">Use it by calling the apply method:</span><br><span class="line">output = Exp.apply(<span class="built_in">input</span>)</span><br></pre></td></tr></table></figure><h2 id="ONNXæ ¼å¼"><a href="#ONNXæ ¼å¼" class="headerlink" title="ONNXæ ¼å¼"></a>ONNXæ ¼å¼</h2><p>åœ¨å®é™…éƒ¨ç½²æ—¶éå¸¸å¸¸ç”¨çš„æ¨¡å‹æ ¼å¼,æ˜¯å±è”½äº†æ¡†æ¶çš„.</p><p><a href="https://pytorch.org/tutorials/advanced/super_resolution_with_onnxruntime.html">(optional) Exporting a Model from PyTorch to ONNX and Running it using ONNX Runtime â€” PyTorch Tutorials 2.3.0+cu121 documentation</a></p><h3 id="ä¿å­˜æ¨¡å‹"><a href="#ä¿å­˜æ¨¡å‹" class="headerlink" title="ä¿å­˜æ¨¡å‹"></a>ä¿å­˜æ¨¡å‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"></span><br><span class="line">dummy_input = torch.randn(<span class="number">10</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>, device=<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line">model = torchvision.models.alexnet(pretrained=<span class="literal">True</span>).cuda()</span><br><span class="line"></span><br><span class="line">input_names = [ <span class="string">&quot;actual_input_1&quot;</span> ] + [ <span class="string">&quot;learned_%d&quot;</span> % i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>) ]</span><br><span class="line">output_names = [ <span class="string">&quot;output1&quot;</span> ]</span><br><span class="line"></span><br><span class="line">torch.onnx.export(model, dummy_input, <span class="string">&quot;alexnet.onnx&quot;</span>, verbose=<span class="literal">True</span>, input_names=input_names, output_names=output_names)</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ <code>alexnet.onnx</code> æ–‡ä»¶åŒ…å«ä¸€ä¸ª <a href="https://developers.google.com/protocol-buffers/">protocol buffer</a>,å…¶ä¸­åŒ…å«äº†å¯¼å‡ºçš„æ¨¡å‹(åœ¨æœ¬ä¾‹ä¸­ä¸º AlexNet)çš„ç½‘ç»œç»“æ„å’Œå‚æ•°.<code>verbose=True</code> å‚æ•°ä¼šå¯¼è‡´å¯¼å‡ºå™¨æ‰“å°å‡ºæ¨¡å‹çš„äººç±»å¯è¯»è¡¨ç¤º.</p><h4 id="åŠ è½½æ¨¡å‹"><a href="#åŠ è½½æ¨¡å‹" class="headerlink" title="åŠ è½½æ¨¡å‹"></a>åŠ è½½æ¨¡å‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install onnx</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> onnx</span><br><span class="line"><span class="comment"># Load the ONNX model</span></span><br><span class="line">model = onnx.load(<span class="string">&quot;alexnet.onnx&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check that the model is well formed</span></span><br><span class="line">onnx.checker.check_model(model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print a human readable representation of the graph</span></span><br><span class="line"><span class="built_in">print</span>(onnx.helper.printable_graph(model.graph))</span><br><span class="line">You can also run the exported model <span class="keyword">with</span> one of the many runtimes that support ONNX. For example after installing ONNX Runtime, you can load <span class="keyword">and</span> run the model:</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> onnxruntime <span class="keyword">as</span> ort</span><br><span class="line"></span><br><span class="line">ort_session = ort.InferenceSession(<span class="string">&quot;alexnet.onnx&quot;</span>)</span><br><span class="line"></span><br><span class="line">outputs = ort_session.run(</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    &#123;<span class="string">&quot;actual_input_1&quot;</span>: np.random.randn(<span class="number">10</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>).astype(np.float32)&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(outputs[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># Print a human readable representation of the graph</span></span><br><span class="line"><span class="built_in">print</span>(onnx.helper.printable_graph(model.graph))</span><br></pre></td></tr></table></figure><h3 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Input to the model</span></span><br><span class="line">x = torch.randn(batch_size, <span class="number">1</span>, <span class="number">224</span>, <span class="number">224</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line">torch_out = torch_model(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Export the model</span></span><br><span class="line">torch.onnx.export(torch_model,               <span class="comment"># model being run</span></span><br><span class="line">                  x,                         <span class="comment"># model input (or a tuple for multiple inputs)</span></span><br><span class="line">                  <span class="string">&quot;super_resolution.onnx&quot;</span>,   <span class="comment"># where to save the model (can be a file or file-like object)</span></span><br><span class="line">                  export_params=<span class="literal">True</span>,        <span class="comment"># store the trained parameter weights inside the model file</span></span><br><span class="line">                  opset_version=<span class="number">10</span>,          <span class="comment"># the ONNX version to export the model to</span></span><br><span class="line">                  do_constant_folding=<span class="literal">True</span>,  <span class="comment"># whether to execute constant folding for optimization</span></span><br><span class="line">                  input_names = [<span class="string">&#x27;input&#x27;</span>],   <span class="comment"># the model&#x27;s input names</span></span><br><span class="line">                  output_names = [<span class="string">&#x27;output&#x27;</span>], <span class="comment"># the model&#x27;s output names</span></span><br><span class="line">                  dynamic_axes=&#123;<span class="string">&#x27;input&#x27;</span> : &#123;<span class="number">0</span> : <span class="string">&#x27;batch_size&#x27;</span>&#125;,    <span class="comment"># variable length axes</span></span><br><span class="line">                                <span class="string">&#x27;output&#x27;</span> : &#123;<span class="number">0</span> : <span class="string">&#x27;batch_size&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨pytorchä¸­ç›´æ¥ä½¿ç”¨<code>torch.onnx.export</code>å³å¯.</p><p>å› ä¸ºå¯¼å‡ºè¿è¡Œäº†æ¨¡å‹,æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªè¾“å…¥å¼ é‡ <code>x</code>.è¿™ä¸ªè¾“å…¥çš„å€¼å¯ä»¥æ˜¯éšæœºçš„,åªè¦å®ƒçš„ç±»å‹å’Œå¤§å°æ˜¯æ­£ç¡®çš„.è¯·æ³¨æ„,é™¤éæŒ‡å®šä¸ºdynamic_axes,å¦åˆ™å¯¼å‡ºçš„ ONNX å›¾ä¸­è¾“å…¥çš„æ‰€æœ‰ç»´åº¦å¤§å°éƒ½ä¼šè¢«å›ºå®šä¸‹æ¥.åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­,ä½¿ç”¨æ‰¹é‡å¤§å°ä¸º 1 çš„è¾“å…¥å¯¼å‡ºæ¨¡å‹,ä½†åœ¨ <code>torch.onnx.export()</code> çš„ <code>dynamic_axes</code> å‚æ•°ä¸­æŒ‡å®šäº†ç¬¬ä¸€ä¸ªç»´åº¦ä¸ºåŠ¨æ€çš„.å› æ­¤,å¯¼å‡ºçš„æ¨¡å‹å°†æ¥å—å¤§å°ä¸º <code>[batch_size, 1, 224, 224]</code> çš„è¾“å…¥,å…¶ä¸­ <code>batch_size</code> å¯ä»¥æ˜¯å¯å˜çš„.</p><p>åŒæ—¶è¿˜è®¡ç®—äº†æ¨¡å‹è¾“å‡º <code>torch_out</code>,æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥éªŒè¯åœ¨ ONNX Runtime ä¸­è¿è¡Œæ—¶å¯¼å‡ºçš„æ¨¡å‹æ˜¯å¦è®¡ç®—å‡ºç›¸åŒçš„å€¼.</p><p>ä½†åœ¨ä½¿ç”¨ ONNX Runtime éªŒè¯æ¨¡å‹è¾“å‡ºä¹‹å‰,æˆ‘ä»¬ä¼šå…ˆä½¿ç”¨ ONNX API æ£€æŸ¥ ONNX æ¨¡å‹.é¦–å…ˆ,<code>onnx.load(&quot;super_resolution.onnx&quot;)</code> ä¼šåŠ è½½ä¿å­˜çš„æ¨¡å‹,å¹¶è¾“å‡ºä¸€ä¸ª <code>onnx.ModelProto</code> ç»“æ„.ç„¶å,<code>onnx.checker.check_model(onnx_model)</code> ä¼šéªŒè¯æ¨¡å‹çš„ç»“æ„,å¹¶ç¡®è®¤æ¨¡å‹å…·æœ‰æœ‰æ•ˆçš„æ¶æ„.é€šè¿‡æ£€æŸ¥æ¨¡å‹çš„ç‰ˆæœ¬ã€å›¾ç»“æ„ä»¥åŠèŠ‚ç‚¹åŠå…¶è¾“å…¥å’Œè¾“å‡º,æ¥éªŒè¯ ONNX å›¾çš„æœ‰æ•ˆæ€§.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> onnx</span><br><span class="line">onnx_model = onnx.load(<span class="string">&quot;super_resolution.onnx&quot;</span>)</span><br><span class="line">onnx.checker.check_model(onnx_model)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ ONNX Runtime çš„ Python API è®¡ç®—è¾“å‡º,é€šå¸¸æƒ…å†µä¸‹,è¿™ä¸€éƒ¨åˆ†å¯ä»¥åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­æˆ–å…¶ä»–æœºå™¨ä¸Šå®Œæˆ,ä½†æˆ‘ä»¬å°†ç»§ç»­åœ¨åŒä¸€è¿›ç¨‹ä¸­è¿›è¡Œ,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éªŒè¯ ONNX Runtime å’Œ PyTorch ä¸ºè¯¥ç½‘ç»œè®¡ç®—å‡ºçš„å€¼æ˜¯å¦ç›¸åŒ.</p><p>ä¸ºäº†ä½¿ç”¨ ONNX Runtime è¿è¡Œæ¨¡å‹,æˆ‘ä»¬éœ€è¦ä¸ºæ¨¡å‹åˆ›å»ºä¸€ä¸ªInferenceSession,å¹¶è®¾ç½®æ‰€éœ€çš„é…ç½®å‚æ•°(è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤é…ç½®).åˆ›å»ºä¼šè¯å,æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>run()</code> API æ¥è¯„ä¼°æ¨¡å‹äº†.è¯¥è°ƒç”¨çš„è¾“å‡ºæ˜¯ä¸€ä¸ªåˆ—è¡¨,åŒ…å« ONNX Runtime è®¡ç®—å¾—å‡ºçš„æ¨¡å‹è¾“å‡º.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> onnxruntime</span><br><span class="line"></span><br><span class="line">ort_session = onnxruntime.InferenceSession(<span class="string">&quot;super_resolution.onnx&quot;</span>, providers=[<span class="string">&quot;CPUExecutionProvider&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_numpy</span>(<span class="params">tensor</span>):</span></span><br><span class="line">    <span class="keyword">return</span> tensor.detach().cpu().numpy() <span class="keyword">if</span> tensor.requires_grad <span class="keyword">else</span> tensor.cpu().numpy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute ONNX Runtime output prediction</span></span><br><span class="line">ort_inputs = &#123;ort_session.get_inputs()[<span class="number">0</span>].name: to_numpy(x)&#125;</span><br><span class="line">ort_outs = ort_session.run(<span class="literal">None</span>, ort_inputs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># compare ONNX Runtime and PyTorch results</span></span><br><span class="line">np.testing.assert_allclose(to_numpy(torch_out), ort_outs[<span class="number">0</span>], rtol=<span class="number">1e-03</span>, atol=<span class="number">1e-05</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Exported model has been tested with ONNXRuntime, and the result looks good!&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h4><p>åœ¨æ¨¡å‹ä¸­é¿å…ä½¿ç”¨numpy,tensor.data,tensor.shapeä¸èƒ½ä½¿ç”¨in_placeæ“ä½œ</p><h2 id="è‡ªåŠ¨æ··åˆç²¾åº¦"><a href="#è‡ªåŠ¨æ··åˆç²¾åº¦" class="headerlink" title="è‡ªåŠ¨æ··åˆç²¾åº¦"></a>è‡ªåŠ¨æ··åˆç²¾åº¦</h2><p>torch.amp ä¸ºæ··åˆç²¾åº¦æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•,å…¶ä¸­ä¸€äº›æ“ä½œä½¿ç”¨ torch.float32 ï¼ˆæµ®ç‚¹ï¼‰æ•°æ®ç±»å‹,å¦ä¸€äº›æ“ä½œä½¿ç”¨è¾ƒä½ç²¾åº¦çš„æµ®ç‚¹æ•°æ®ç±»å‹ (lower_precision_fp):torch.float16ï¼ˆåŠç²¾åº¦ï¼‰æˆ– torch.bfloat16.ä¸€äº›æ“ä½œ,å¦‚çº¿æ€§å±‚å’Œå·ç§¯,åœ¨ lower_precision_fp ä¸‹é€Ÿåº¦æ›´å¿«.å…¶ä»–æ“ä½œ,å¦‚è¿˜åŸ,é€šå¸¸éœ€è¦ float32 çš„åŠ¨æ€èŒƒå›´.æ··åˆç²¾åº¦è¯•å›¾å°†æ¯ä¸ªæ“ä½œä¸ç›¸åº”çš„æ•°æ®ç±»å‹ç›¸åŒ¹é….</p><p>é€šå¸¸,æ•°æ®ç±»å‹ä¸º torch.float16 çš„ â€œè‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ â€œä½¿ç”¨ torch.autocast å’Œ torch.cpu.amp.GradScaler æˆ– torch.cuda.amp.GradScaler.</p><p>torch.autocast å®ä¾‹å¯å¯¹æ‰€é€‰ä¸Šä¸‹æ–‡è¿›è¡Œè‡ªåŠ¨casting.è‡ªåŠ¨castä¼šè‡ªåŠ¨é€‰æ‹© GPU è¿ç®—çš„ç²¾åº¦,ä»è€Œåœ¨ä¿æŒç²¾åº¦çš„åŒæ—¶æé«˜æ€§èƒ½.</p><p>torch.cuda.amp.GradScaler çš„å®ä¾‹æœ‰åŠ©äºæ–¹ä¾¿åœ°æ‰§è¡Œæ¢¯åº¦ç¼©æ”¾æ­¥éª¤.<strong>æ¢¯åº¦ç¼©æ”¾å¯æœ€å¤§é™åº¦åœ°å‡å°‘æ¢¯åº¦ä¸‹æº¢</strong>,ä»è€Œæ”¹å–„å…·æœ‰ float16 æ¢¯åº¦çš„ç½‘ç»œçš„æ”¶æ•›æ€§.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Creates model and optimizer in default precision</span></span><br><span class="line">model = Net().cuda()</span><br><span class="line">optimizer = optim.SGD(model.parameters(), ...)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creates a GradScaler once at the beginning of training.</span></span><br><span class="line">scaler = GradScaler()  <span class="comment"># 1. åˆ›å»ºgradscaler</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> epochs:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">input</span>, target <span class="keyword">in</span> data:</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Runs the forward pass with autocasting.</span></span><br><span class="line">        <span class="comment"># 2.ä½¿å¾—æ¨¡å‹è®­ç»ƒæ—¶ç›¸å…³å‚æ•°ç±»å‹è‡ªåŠ¨è½¬æ¢</span></span><br><span class="line">        <span class="keyword">with</span> autocast(device_type=<span class="string">&#x27;cuda&#x27;</span>, dtype=torch.float16):</span><br><span class="line">            output = model(<span class="built_in">input</span>)</span><br><span class="line">            loss = loss_fn(output, target)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Scales loss.  Calls backward() on scaled loss to create scaled gradients.</span></span><br><span class="line">        <span class="comment"># Backward passes under autocast are not recommended.</span></span><br><span class="line">        <span class="comment"># Backward ops run in the same dtype autocast chose for corresponding forward ops.</span></span><br><span class="line">        scaler.scale(loss).backward()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># scaler.step() first unscales the gradients of the optimizer&#x27;s assigned params.</span></span><br><span class="line">        <span class="comment"># If these gradients do not contain infs or NaNs, optimizer.step() is then called,</span></span><br><span class="line">        <span class="comment"># otherwise, optimizer.step() is skipped.</span></span><br><span class="line">        scaler.step(optimizer)   </span><br><span class="line">        <span class="comment"># Updates the scale for next iteration.</span></span><br><span class="line">        scaler.update()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Creates model and optimizer in default precision</span></span><br><span class="line">model = Net().cuda()</span><br><span class="line">optimizer = optim.SGD(model.parameters(), ...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">input</span>, target <span class="keyword">in</span> data:</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Enables autocasting for the forward pass (model + loss)</span></span><br><span class="line">    <span class="keyword">with</span> torch.autocast(device_type=<span class="string">&quot;cuda&quot;</span>):</span><br><span class="line">        output = model(<span class="built_in">input</span>)</span><br><span class="line">        loss = loss_fn(output, target)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Exits the context manager before backward()</span></span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰ç”± scaler.scale(loss).backward() ç”Ÿæˆçš„æ¢¯åº¦éƒ½æ˜¯æŒ‰æ¯”ä¾‹ç¼©æ”¾çš„.å¦‚æœè¦åœ¨ backward() å’Œ scaler.step(optimizer) ä¹‹é—´ä¿®æ”¹æˆ–æ£€æŸ¥å‚æ•°çš„ .grad å±æ€§,åº”é¦–å…ˆå–æ¶ˆç¼©æ”¾.</p><p><strong>æ¢¯åº¦æƒ©ç½š</strong></p><p>æ¢¯åº¦æƒ©ç½šçš„å®ç°é€šå¸¸ä½¿ç”¨ torch.autograd.grad() åˆ›å»ºæ¢¯åº¦,å°†å®ƒä»¬ç»„åˆèµ·æ¥åˆ›å»ºæƒ©ç½šå€¼,å¹¶å°†æƒ©ç½šå€¼æ·»åŠ åˆ°æŸå¤±ä¸­.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> epochs:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">input</span>, target <span class="keyword">in</span> data:</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        output = model(<span class="built_in">input</span>)</span><br><span class="line">        loss = loss_fn(output, target)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Creates gradients</span></span><br><span class="line">        grad_params = torch.autograd.grad(outputs=loss,</span><br><span class="line">                                          inputs=model.parameters(),</span><br><span class="line">                                          create_graph=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Computes the penalty term and adds it to the loss</span></span><br><span class="line">        grad_norm = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> grad <span class="keyword">in</span> grad_params:</span><br><span class="line">            grad_norm += grad.<span class="built_in">pow</span>(<span class="number">2</span>).<span class="built_in">sum</span>()</span><br><span class="line">        grad_norm = grad_norm.sqrt()</span><br><span class="line">        loss = loss + grad_norm</span><br><span class="line"></span><br><span class="line">        loss.backward()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># clip gradients here, if desired</span></span><br><span class="line"></span><br><span class="line">        optimizer.step()</span><br></pre></td></tr></table></figure><p>è¦é€šè¿‡æ¢¯åº¦ç¼©æ”¾å®ç°æ¢¯åº¦æƒ©ç½š,åº”ç¼©æ”¾ä¼ é€’ç»™ torch.autograd.grad() çš„è¾“å‡ºå¼ é‡.å› æ­¤,ç”Ÿæˆçš„æ¢¯åº¦ä¹Ÿå°†è¢«ç¼©æ”¾,åœ¨åˆå¹¶ç”Ÿæˆæƒ©ç½šå€¼ä¹‹å‰åº”å–æ¶ˆç¼©æ”¾.</p><p>æ­¤å¤–,æƒ©ç½šé¡¹çš„è®¡ç®—æ˜¯å‰å‘ä¼ é€’çš„ä¸€éƒ¨åˆ†,å› æ­¤åº”åœ¨è‡ªåŠ¨ä¼ é€’ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scaler = torch.cuda.amp.GradScaler()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> epochs:</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">input</span>, target <span class="keyword">in</span> data:</span><br><span class="line">        optimizer0.zero_grad()</span><br><span class="line">        optimizer1.zero_grad()</span><br><span class="line">        <span class="keyword">with</span> autocast(device_type=<span class="string">&#x27;cuda&#x27;</span>, dtype=torch.float16):</span><br><span class="line">            output0 = model0(<span class="built_in">input</span>)</span><br><span class="line">            output1 = model1(<span class="built_in">input</span>)</span><br><span class="line">            loss0 = loss_fn(<span class="number">2</span> * output0 + <span class="number">3</span> * output1, target)</span><br><span class="line">            loss1 = loss_fn(<span class="number">3</span> * output0 - <span class="number">5</span> * output1, target)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># (retain_graph here is unrelated to amp, it&#x27;s present because in this</span></span><br><span class="line">        <span class="comment"># example, both backward() calls share some sections of graph.)</span></span><br><span class="line">        scaler.scale(loss0).backward(retain_graph=<span class="literal">True</span>)</span><br><span class="line">        scaler.scale(loss1).backward()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># You can choose which optimizers receive explicit unscaling, if you</span></span><br><span class="line">        <span class="comment"># want to inspect or modify the gradients of the params they own.</span></span><br><span class="line">        scaler.unscale_(optimizer0)</span><br><span class="line"></span><br><span class="line">        scaler.step(optimizer0)</span><br><span class="line">        scaler.step(optimizer1)</span><br><span class="line"></span><br><span class="line">        scaler.update()</span><br></pre></td></tr></table></figure><p>å¦‚æœç½‘ç»œæœ‰å¤šä¸ªæŸå¤±,åˆ™å¿…é¡»å¯¹æ¯ä¸ªæŸè€—å•ç‹¬è°ƒç”¨ scaler.scale.å¦‚æœçš„ç½‘ç»œæœ‰å¤šä¸ªä¼˜åŒ–å™¨,æ‚¨å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªä¼˜åŒ–å™¨ä¸Šå•ç‹¬è°ƒç”¨ scaler.unscale_,å¹¶ä¸”å¿…é¡»åœ¨æ¯ä¸ªä¼˜åŒ–å™¨ä¸Šå•ç‹¬è°ƒç”¨ scaler.step.</p><p>autocastä¸åœ¨åœ¨ float64 æˆ–éæµ®ç‚¹ç±»å‹ä¸Šè¿›è¡Œè½¬æ¢.ã€‚ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½å’Œç¨³å®šæ€§,åœ¨autocaståŒºåŸŸä¸­ä½¿ç”¨out-of-placeè¿ç®—,ä¹Ÿå°±æ˜¯ä½¿ç”¨ç±»ä¼¼a.addmm(b, c)è¿™ç§æ“ä½œ.</p><p>autocastä¼šå°†withä¸‹çš„åŒºåŸŸä¸­çš„è¿ç®—è‡ªåŠ¨è½¬æ¢,è‡ªåŠ¨è½¬å‘åº”åªåŒ…å«ç½‘ç»œçš„å‰å‘ä¼ é€’ï¼ŒåŒ…æ‹¬æŸå¤±è®¡ç®—ã€‚ </p><p>ä¸å»ºè®®ä½¿ç”¨è‡ªåŠ¨è½¬å‘çš„åå‘ä¼ é€’. åå‘æ“ä½œçš„è¿ç®—ç±»å‹æ˜¯autocastä¹‹å‰çš„ç±»å‹.</p><h4 id="cudaä¸Šä¼šè½¬ä¸ºfloat16çš„è¿ç®—"><a href="#cudaä¸Šä¼šè½¬ä¸ºfloat16çš„è¿ç®—" class="headerlink" title="cudaä¸Šä¼šè½¬ä¸ºfloat16çš„è¿ç®—"></a>cudaä¸Šä¼šè½¬ä¸ºfloat16çš„è¿ç®—</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__matmul__`, `addbmm`, `addmm`, `addmv`, `addr`, `baddbmm`, `bmm`, `chain_matmul`, `multi_dot`, `conv1d`, `conv2d`, `conv3d`, `conv_transpose1d`, `conv_transpose2d`, `conv_transpose3d`, `GRUCell`, `linear`, `LSTMCell`, `matmul`, `mm`, `mv`, `prelu`, `RNNCell</span><br></pre></td></tr></table></figure><h4 id="cudaä¸Šä¼šè½¬ä¸ºfloat32çš„è¿ç®—"><a href="#cudaä¸Šä¼šè½¬ä¸ºfloat32çš„è¿ç®—" class="headerlink" title="cudaä¸Šä¼šè½¬ä¸ºfloat32çš„è¿ç®—"></a>cudaä¸Šä¼šè½¬ä¸ºfloat32çš„è¿ç®—</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__pow__`, `__rdiv__`, `__rpow__`, `__rtruediv__`, `acos`, `asin`, `binary_cross_entropy_with_logits`, `cosh`, `cosine_embedding_loss`, `cdist`, `cosine_similarity`, `cross_entropy`, `cumprod`, `cumsum`, `dist`, `erfinv`, `exp`, `expm1`, `group_norm`, `hinge_embedding_loss`, `kl_div`, `l1_loss`, `layer_norm`, `log`, `log_softmax`, `log10`, `log1p`, `log2`, `margin_ranking_loss`, `mse_loss`, `multilabel_margin_loss`, `multi_margin_loss`, `nll_loss`, `norm`, `normalize`, `pdist`, `poisson_nll_loss`, `<span class="built_in">pow</span>`, `prod`, `reciprocal`, `rsqrt`, `sinh`, `smooth_l1_loss`, `soft_margin_loss`, `softmax`, `softmin`, `softplus`, `<span class="built_in">sum</span>`, `renorm`, `tan`, `triplet_margin_loss</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€äº›è¿ç®—éœ€è¦å¤šä¸ªè¾“å…¥,å¦‚æœè¾“å…¥å…¨æ˜¯float32é‚£è¾“å‡ºå°±æ˜¯float32.ä¹Ÿå°±æ˜¯promote to the widest input type</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addcdiv`, `addcmul`, `atan2`, `bilinear`, `cross`, `dot`, `grid_sample`, `index_put`, `scatter_add`, `tensordot</span><br></pre></td></tr></table></figure><h4 id="CPUä¸Šä¼šè½¬ä¸ºbfloat16çš„è¿ç®—"><a href="#CPUä¸Šä¼šè½¬ä¸ºbfloat16çš„è¿ç®—" class="headerlink" title="CPUä¸Šä¼šè½¬ä¸ºbfloat16çš„è¿ç®—"></a>CPUä¸Šä¼šè½¬ä¸ºbfloat16çš„è¿ç®—</h4><p>bfloatæ˜¯æ¯”è¾ƒç‰¹æ®Šçš„æ•°æ®ç±»å‹,æ˜¯é’ˆå¯¹æ·±åº¦å­¦ä¹ è¿ç®—ç‰¹åˆ«è°ƒæ•´æŒ‡æ•°ä½å’Œå°æ•°ä½,ä½¿å¾—ç›¸å¯¹äºåŒç­‰ä½æ•°çš„float,å…¶ç²¾åº¦æ›´å°,ä½†èƒ½è¡¨ç¤ºçš„å€¼èŒƒå›´æ›´å¤§,è€Œä¸”é’ˆå¯¹æ˜¾å¡è¿ç®—æ›´å¿«(æ˜¾å¡å‚å•†è°ƒæ•´äº†)</p><div class="table-container"><table><thead><tr><th>Format</th><th>Bits</th><th>Exponent</th><th>Fraction</th><th>sign(ç¬¦å·)</th></tr></thead><tbody><tr><td>FP32</td><td>32</td><td>8</td><td>23</td><td>1</td></tr><tr><td>FP16</td><td>16</td><td>5</td><td>10</td><td>1</td></tr><tr><td>BF16</td><td>16</td><td>8</td><td>7</td><td>1</td></tr></tbody></table></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conv1d`, `conv2d`, `conv3d`, `bmm`, `mm`, `baddbmm`, `addmm`, `addbmm`, `linear`, `matmul`, `_convolution</span><br></pre></td></tr></table></figure><h4 id="CPUä¸Šä¼šè½¬ä¸ºbfloat32çš„è¿ç®—"><a href="#CPUä¸Šä¼šè½¬ä¸ºbfloat32çš„è¿ç®—" class="headerlink" title="CPUä¸Šä¼šè½¬ä¸ºbfloat32çš„è¿ç®—"></a>CPUä¸Šä¼šè½¬ä¸ºbfloat32çš„è¿ç®—</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conv_transpose1d, conv_transpose2d, conv_transpose3d, avg_pool3d, binary_cross_entropy, grid_sampler, grid_sampler_2d, _grid_sampler_2d_cpu_fallback, grid_sampler_3d, polar, prod, quantile, nanquantile, stft, cdist, trace, view_as_complex, cholesky, cholesky_inverse, cholesky_solve, inverse, lu_solve, orgqr, inverse, ormqr, pinverse, max_pool3d, max_unpool2d, max_unpool3d, adaptive_avg_pool3d, reflection_pad1d, reflection_pad2d, replication_pad1d, replication_pad2d, replication_pad3d, mse_loss, ctc_loss, kl_div, multilabel_margin_loss, fft_fft, fft_ifft, fft_fft2, fft_ifft2, fft_fftn, fft_ifftn, fft_rfft, fft_irfft, fft_rfft2, fft_irfft2, fft_rfftn, fft_irfftn, fft_hfft, fft_ihfft, linalg_matrix_norm, linalg_cond, linalg_matrix_rank, linalg_solve, linalg_cholesky, linalg_svdvals, linalg_eigvals, linalg_eigvalsh, linalg_inv, linalg_householder_product, linalg_tensorinv, linalg_tensorsolve, fake_quantize_per_tensor_affine, eig, geqrf, lstsq, _lu_with_info, qr, solve, svd, symeig, triangular_solve, fractional_max_pool2d, fractional_max_pool3d, adaptive_max_pool3d, multilabel_margin_loss_forward, linalg_qr, linalg_cholesky_ex, linalg_svd, linalg_eig, linalg_eigh, linalg_lstsq, linalg_inv_ex</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„,cpuä¸Šä¹Ÿæœ‰promote to the widest input typeçš„è¿ç®—.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat, stack, index_copy</span><br></pre></td></tr></table></figure><h2 id="å•æœºå™¨-å¤šGPU-è®­ç»ƒæœ€ä½³å®è·µ"><a href="#å•æœºå™¨-å¤šGPU-è®­ç»ƒæœ€ä½³å®è·µ" class="headerlink" title="å•æœºå™¨(å¤šGPU)è®­ç»ƒæœ€ä½³å®è·µ"></a>å•æœºå™¨(å¤šGPU)è®­ç»ƒæœ€ä½³å®è·µ</h2><p>å¦‚æœæœ‰å¤šä¸ªGPU,æ¯ä¸ªGPUä¸Šè¿è¡Œå¤åˆ¶çš„æƒé‡ç›¸åŒçš„æ¨¡å‹,æ•°æ®åˆ†å‘åˆ°å¤šä¸ªGPUä¸Š,è¿™æ ·å°±èƒ½åŠ å¿«è®­ç»ƒ.ä½†æ˜¯æœ‰äº›ä½¿ç”¨ä¸€ä¸ªGPUä¸Šå®¹ä¸ä¸‹ä¸€ä¸ªå®Œæ•´çš„æ¨¡å‹,è¿™ä¸ªæ—¶å€™,å°†ä¸€ä¸ªæ¨¡å‹æ‹†åˆ°ä¸åŒçš„GPUä¸Šå°±æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆ.</p><p>è¿™é‡Œå°±è¦æåˆ°model parallel(æ¨¡å‹å¹¶è¡Œ),æ¨¡å‹å¹¶è¡Œæ˜¯å°†ä¸€ä¸ªæ¨¡å‹çš„ä¸åŒå­ç½‘ç»œæ”¾åˆ°ä¸åŒçš„è®¾å¤‡ä¸Š,å¹¶ç›¸åº”åœ°forward,ä»¥ä¾¿åœ¨è®¾å¤‡é—´ç§»åŠ¨ä¸­é—´è¾“å‡º.</p><blockquote><p>å¦‚æœæ˜¯è·¨æœºå™¨,å¯ä»¥é€šè¿‡RPC<a href="https://pytorch.org/tutorials/intermediate/rpc_tutorial.html">Getting Started with Distributed RPC Framework â€” PyTorch Tutorials 2.3.0+cu121 documentation</a></p></blockquote><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToyModel</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ToyModel, self).__init__()</span><br><span class="line">        self.net1 = torch.nn.Linear(<span class="number">10</span>, <span class="number">10</span>).to(<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line">        self.relu = torch.nn.ReLU()</span><br><span class="line">        self.net2 = torch.nn.Linear(<span class="number">10</span>, <span class="number">5</span>).to(<span class="string">&#x27;cuda:1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.relu(self.net1(x.to(<span class="string">&#x27;cuda:0&#x27;</span>)))</span><br><span class="line">        <span class="keyword">return</span> self.net2(x.to(<span class="string">&#x27;cuda:1&#x27;</span>))</span><br><span class="line">model = ToyModel()</span><br><span class="line">loss_fn = nn.MSELoss()</span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">optimizer.zero_grad()</span><br><span class="line">outputs = model(torch.randn(<span class="number">20</span>, <span class="number">10</span>))</span><br><span class="line">labels = torch.randn(<span class="number">20</span>, <span class="number">5</span>).to(<span class="string">&#x27;cuda:1&#x27;</span>)</span><br><span class="line">loss_fn(outputs, labels).backward()</span><br><span class="line">optimizer.step()</span><br></pre></td></tr></table></figure><p>æŠŠæ¨¡å‹ä¸åŒéƒ¨åˆ†æ”¾åœ¨äº†ä¸åŒGPUä¸Š,å¹¶ä¸”forwardæ—¶æŠŠæ•°æ®ä¹Ÿæ”¾åœ¨å¯¹åº”ä½ç½®.æ³¨æ„è®¡ç®—æŸå¤±æ—¶,labelä¹Ÿè¦æ”¾å¯¹åº”ä½ç½®.</p><p>åªéœ€ä¿®æ”¹å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥åœ¨å¤šä¸ª GPU ä¸Šè¿è¡Œç°æœ‰çš„å• GPU æ¨¡å—.ç»§æ‰¿ç°æœ‰çš„ ResNet æ¨¡å—,å¹¶åœ¨æ„å»ºè¿‡ç¨‹ä¸­å°†å„å±‚æ‹†åˆ†åˆ°ä¸¤ä¸ª GPU.ç„¶å,è¦†ç›–forwardæ–¹æ³•,é€šè¿‡ç›¸åº”ç§»åŠ¨ä¸­é—´è¾“å‡ºæ¥ç¼åˆä¸¤ä¸ªå­ç½‘ç»œ.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torchvision.models.resnet <span class="keyword">import</span> ResNet, Bottleneck</span><br><span class="line"></span><br><span class="line">num_classes = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelParallelResNet50</span>(<span class="params">ResNet</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ModelParallelResNet50, self).__init__(</span><br><span class="line">            Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], num_classes=num_classes, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        self.seq1 = nn.Sequential(</span><br><span class="line">            self.conv1,</span><br><span class="line">            self.bn1,</span><br><span class="line">            self.relu,</span><br><span class="line">            self.maxpool,</span><br><span class="line"></span><br><span class="line">            self.layer1,</span><br><span class="line">            self.layer2</span><br><span class="line">        ).to(<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.seq2 = nn.Sequential(</span><br><span class="line">            self.layer3,</span><br><span class="line">            self.layer4,</span><br><span class="line">            self.avgpool,</span><br><span class="line">        ).to(<span class="string">&#x27;cuda:1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.fc.to(<span class="string">&#x27;cuda:1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.seq2(self.seq1(x).to(<span class="string">&#x27;cuda:1&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> self.fc(x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>æœ€ååšäº†ç›¸å…³å®éªŒ,å‘ç°åœ¨å¤šä¸ªGPUä¸Šæ¨¡å‹å¹¶è¡Œæ‰§è¡Œæ—¶é—´æ›´é•¿,å› ä¸ºå¤šä¸ª GPU ä¸­åªæœ‰ä¸€ä¸ªåœ¨å·¥ä½œï¼Œè€Œå…¶ä»–çš„ä¹Ÿä¸åš,åŒæ—¶æ•°æ®ä»ä¸åŒGPUä¸­å¤åˆ¶æ—¶ä¹Ÿéœ€è¦æ—¶é—´.</p><p><img data-src="https://pytorch.org/tutorials/_images/mp_vs_rn.png" alt="img"></p><h2 id="å¤šGPUè®­ç»ƒ"><a href="#å¤šGPUè®­ç»ƒ" class="headerlink" title="å¤šGPUè®­ç»ƒ"></a>å¤šGPUè®­ç»ƒ</h2><h4 id="å¹¶è¡Œæ–¹æ¡ˆ"><a href="#å¹¶è¡Œæ–¹æ¡ˆ" class="headerlink" title="å¹¶è¡Œæ–¹æ¡ˆ"></a>å¹¶è¡Œæ–¹æ¡ˆ</h4><p><code>DataParallel</code>æ˜¯å•è¿›ç¨‹ã€å¤šçº¿ç¨‹çš„,åªèƒ½åœ¨å•å°æœºå™¨ä¸Š(å¯ä»¥å¤šGPU)è¿è¡Œ,è€Œ <code>DistributedDataParallel</code> æ˜¯å¤šè¿›ç¨‹çš„,å¯ä»¥åœ¨å•å°å’Œå¤šå°æœºå™¨ä¸Šè¿è¡Œ.</p><p>å³ä½¿åœ¨å•å°æœºå™¨ä¸Š,DataParallel é€šå¸¸ä¹Ÿæ¯” DistributedDataParallel æ…¢,è¿™æ˜¯å› ä¸ºçº¿ç¨‹é—´çš„ GIL ç«äº‰ã€æ¯æ¬¡è¿­ä»£çš„å¤åˆ¶æ¨¡å‹ï¼Œä»¥åŠåˆ†æ•£è¾“å…¥å’Œæ”¶é›†è¾“å‡ºæ‰€å¸¦æ¥çš„é¢å¤–å¼€é”€.</p><blockquote><p>å®é™…ä¸ºäº†æ–¹ä¾¿,å®Œå…¨å¯ä»¥ä»…ä½¿ç”¨DataParalleråœ¨å¤šGPUä¸Šè¿è¡Œ.</p></blockquote><div class="table-container"><table><thead><tr><th>DataParallel</th><th>disc</th></tr></thead><tbody><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.DataParallel.html#torch.nn.DataParallel"><code>nn.DataParallel</code></a></td><td>Implements data parallelism at the module level.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.parallel.DistributedDataParallel.html#torch.nn.parallel.DistributedDataParallel"><code>nn.parallel.DistributedDataParallel</code></a></td><td>Implement distributed data parallelism based on <code>torch.distributed</code> at module level.</td></tr></tbody></table></div><p>æ¨¡å‹å¹¶è¡Œ:å¦‚æœæ¨¡å‹å¤ªå¤§,æ— æ³•åœ¨å•ä¸ª GPU ä¸Šè¿è¡Œ,å°±å¿…é¡»ä½¿ç”¨æ¨¡å‹å¹¶è¡ŒåŠŸèƒ½å°†å…¶åˆ†å‰²åˆ°å¤šä¸ª GPU ä¸Š.</p><p>åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œï¼ˆDistributedDataParallel,DDPï¼‰å¯ä¸æ¨¡å‹å¹¶è¡Œä¸€èµ·ä½¿ç”¨ï¼Œè€Œæ•°æ®å¹¶è¡Œï¼ˆDataParallelï¼‰ç›®å‰è¿˜ä¸èƒ½ã€‚å½“ DDP ä¸æ¨¡å‹å¹¶è¡Œç›¸ç»“åˆæ—¶,æ¯ä¸ª DDP è¿›ç¨‹éƒ½å°†ä½¿ç”¨æ¨¡å‹å¹¶è¡Œ,è€Œæ‰€æœ‰è¿›ç¨‹éƒ½å°†ä½¿ç”¨æ•°æ®å¹¶è¡Œã€‚</p><p>å¤šGPUè®­ç»ƒæœ‰æ¯ä¸ªGPUä¸€ä¸ªçº¿ç¨‹</p><p><code>torch.nn.DataParallel</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">model = MyModel()</span><br><span class="line">dp_model = nn.DataParallel(model)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets autocast in the main thread</span></span><br><span class="line"><span class="keyword">with</span> autocast(device_type=<span class="string">&#x27;cuda&#x27;</span>, dtype=torch.float16):</span><br><span class="line">    <span class="comment"># dp_model&#x27;s internal threads will autocast.</span></span><br><span class="line">    output = dp_model(<span class="built_in">input</span>)</span><br><span class="line">    <span class="comment"># loss_fn also autocast</span></span><br><span class="line">    loss = loss_fn(output)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ–¹æ³•æ˜¯æœ€ç®€å•çš„å¼Šç«¯æ˜¯åç»­çš„lossè®¡ç®—åªä¼šåœ¨<code>cuda:0</code>ä¸Šè¿›è¡Œ,æ²¡æ³•å¹¶è¡Œ,å› æ­¤ä¼šå¯¼è‡´è´Ÿè½½ä¸å‡è¡¡çš„é—®é¢˜</p><p>æ–‡æ¡£æ¨èä½¿ç”¨<code>DistributedDataParallel</code></p><blockquote><p>ä¸ºä»€ä¹ˆå°½ç®¡å¢åŠ äº†å¤æ‚æ€§,è¿˜æ˜¯ä¼šè€ƒè™‘ä½¿ç”¨ DistributedDataParallel è€Œä¸æ˜¯ DataParallel:</p><p>é¦–å…ˆ,DataParallel æ˜¯å•è¿›ç¨‹ã€å¤šçº¿ç¨‹çš„,åªèƒ½åœ¨å•æœºä¸Šè¿è¡Œ,è€Œ <strong>DistributedDataParallel æ˜¯å¤šè¿›ç¨‹çš„,å¯ä»¥åœ¨å•æœºå’Œå¤šæœºè®­ç»ƒä¸­è¿è¡Œ.å³ä½¿åœ¨å•å°æœºå™¨ä¸Š,DataParallel é€šå¸¸ä¹Ÿæ¯” DistributedDataParallel æ…¢,è¿™æ˜¯ç”±äºçº¿ç¨‹é—´çš„ GIL ç«äº‰ã€æ¯æ¬¡è¿­ä»£çš„å¤åˆ¶æ¨¡å‹,ä»¥åŠåˆ†æ•£è¾“å…¥å’Œæ”¶é›†è¾“å‡ºæ‰€å¸¦æ¥çš„é¢å¤–å¼€é”€.</strong></p><p>åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œï¼ˆDistributedDataParallelï¼‰å¯ä¸æ¨¡å‹å¹¶è¡Œä¸€èµ·ä½¿ç”¨,è€Œæ•°æ®å¹¶è¡Œï¼ˆDataParallelï¼‰ç›®å‰è¿˜ä¸èƒ½.å½“ DDP ä¸æ¨¡å‹å¹¶è¡Œç›¸ç»“åˆæ—¶,æ¯ä¸ª DDP è¿›ç¨‹éƒ½å°†ä½¿ç”¨æ¨¡å‹å¹¶è¡Œ,è€Œæ‰€æœ‰è¿›ç¨‹éƒ½å°†ä½¿ç”¨æ•°æ®å¹¶è¡Œ.</p><p>å¦‚æœæ¨¡å‹éœ€è¦è·¨è¶Šå¤šå°æœºå™¨,æˆ–è€…æ‚¨çš„ç”¨ä¾‹ä¸ç¬¦åˆæ•°æ®å¹¶è¡Œæ¨¡å¼,è¯·ä½¿ç”¨RPC API,ä»¥é€šç”¨çš„åˆ†å¸ƒå¼è®­ç»ƒ.</p></blockquote><p>åœ¨æ¨¡å—çº§åŸºäº torch.distributed å®ç°åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œ.<br>è¯¥å®¹å™¨é€šè¿‡åœ¨æ¯ä¸ªæ¨¡å‹å‰¯æœ¬ä¹‹é—´åŒæ­¥æ¢¯åº¦æ¥æä¾›æ•°æ®å¹¶è¡Œæ€§.è¦åŒæ­¥çš„è®¾å¤‡ç”±è¾“å…¥ process_group æŒ‡å®š,é»˜è®¤æƒ…å†µä¸‹æ˜¯æ•´ä¸ªä¸–ç•Œ.è¯·æ³¨æ„,DistributedDataParallel ä¸ä¼šåœ¨å‚ä¸çš„ GPU ä¹‹é—´å¯¹è¾“å…¥è¿›è¡Œåˆ†å—æˆ–åˆ†ç‰‡ï¼›ç”¨æˆ·è´Ÿè´£å®šä¹‰å¦‚ä½•è¿›è¡Œåˆ†å—æˆ–åˆ†ç‰‡,ä¾‹å¦‚é€šè¿‡ä½¿ç”¨ DistributedSampler.</p><p>æ­¤å¤–éœ€è¦è¿›è¡Œåˆå§‹åŒ– torch.distributed.init_process_group()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.distributed <span class="keyword">as</span> dist</span><br><span class="line"><span class="keyword">import</span> torch.multiprocessing <span class="keyword">as</span> mp</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> torch.nn.parallel <span class="keyword">import</span> DistributedDataParallel <span class="keyword">as</span> DDP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example</span>(<span class="params">rank, world_size</span>):</span></span><br><span class="line">    <span class="comment"># create default process group</span></span><br><span class="line">    dist.init_process_group(<span class="string">&quot;gloo&quot;</span>, rank=rank, world_size=world_size)</span><br><span class="line">    <span class="comment"># create local model</span></span><br><span class="line">    model = nn.Linear(<span class="number">10</span>, <span class="number">10</span>).to(rank)</span><br><span class="line">    <span class="comment"># construct DDP model</span></span><br><span class="line">    ddp_model = DDP(model, device_ids=[rank])</span><br><span class="line">    <span class="comment"># define loss function and optimizer</span></span><br><span class="line">    loss_fn = nn.MSELoss()</span><br><span class="line">    optimizer = optim.SGD(ddp_model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward pass</span></span><br><span class="line">    outputs = ddp_model(torch.randn(<span class="number">20</span>, <span class="number">10</span>).to(rank))</span><br><span class="line">    labels = torch.randn(<span class="number">20</span>, <span class="number">10</span>).to(rank)</span><br><span class="line">    <span class="comment"># backward pass</span></span><br><span class="line">    loss_fn(outputs, labels).backward()</span><br><span class="line">    <span class="comment"># update parameters</span></span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    world_size = <span class="number">2</span></span><br><span class="line">    mp.spawn(example,</span><br><span class="line">        args=(world_size,),</span><br><span class="line">        nprocs=world_size,</span><br><span class="line">        join=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Environment variables which need to be</span></span><br><span class="line">    <span class="comment"># set when using c10d&#x27;s default &quot;env&quot;</span></span><br><span class="line">    <span class="comment"># initialization mode.</span></span><br><span class="line">    os.environ[<span class="string">&quot;MASTER_ADDR&quot;</span>] = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;MASTER_PORT&quot;</span>] = <span class="string">&quot;29500&quot;</span></span><br><span class="line">    main()                                  </span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo_model_parallel</span>(<span class="params">rank, world_size</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Running DDP with model parallel example on rank <span class="subst">&#123;rank&#125;</span>.&quot;</span>)</span><br><span class="line">    setup(rank, world_size)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># setup mp_model and devices for this process</span></span><br><span class="line">    dev0 = rank * <span class="number">2</span></span><br><span class="line">    dev1 = rank * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    mp_model = ToyMpModel(dev0, dev1)</span><br><span class="line">    ddp_mp_model = DDP(mp_model)</span><br><span class="line"></span><br><span class="line">    loss_fn = nn.MSELoss()</span><br><span class="line">    optimizer = optim.SGD(ddp_mp_model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    <span class="comment"># outputs will be on dev1</span></span><br><span class="line">    outputs = ddp_mp_model(torch.randn(<span class="number">20</span>, <span class="number">10</span>))</span><br><span class="line">    labels = torch.randn(<span class="number">20</span>, <span class="number">5</span>).to(dev1)</span><br><span class="line">    loss_fn(outputs, labels).backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line">    cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    n_gpus = torch.cuda.device_count()</span><br><span class="line">    <span class="keyword">assert</span> n_gpus &gt;= <span class="number">2</span>, <span class="string">f&quot;Requires at least 2 GPUs to run, but got <span class="subst">&#123;n_gpus&#125;</span>&quot;</span></span><br><span class="line">    world_size = n_gpus</span><br><span class="line">    run_demo(demo_basic, world_size)</span><br><span class="line">    run_demo(demo_checkpoint, world_size)</span><br><span class="line">    world_size = n_gpus//<span class="number">2</span></span><br><span class="line">    run_demo(demo_model_parallel, world_size)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sampler = DistributedSampler(dataset) <span class="keyword">if</span> is_distributed <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">loader = DataLoader(dataset, shuffle=(sampler <span class="keyword">is</span> <span class="literal">None</span>),</span><br><span class="line">                    sampler=sampler)</span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(start_epoch, n_epochs):</span><br><span class="line">     <span class="keyword">if</span> is_distributed:</span><br><span class="line">         sampler.set_epoch(epoch)</span><br><span class="line">     train(loader)</span><br></pre></td></tr></table></figure><p>å®ƒä¸ torch.nn.parallel.DistributedDataParallel ç»“åˆä½¿ç”¨å°¤å…¶æœ‰ç”¨.åœ¨è¿™ç§æƒ…å†µä¸‹,<strong>æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥ä¼ é€’ä¸€ä¸ª DistributedSampler å®ä¾‹ä½œä¸º DataLoader é‡‡æ ·å™¨</strong>,å¹¶åŠ è½½å…¶ç‹¬æœ‰çš„åŸå§‹æ•°æ®é›†å­é›†.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch  </span><br><span class="line"><span class="keyword">import</span> torch.distributed <span class="keyword">as</span> dist  </span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn  </span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim  </span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, Dataset, DistributedSampler  </span><br><span class="line"><span class="keyword">from</span> torch.nn.parallel <span class="keyword">import</span> DistributedDataParallel <span class="keyword">as</span> DDP  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### è‡ªå®šä¹‰æ•°æ®é›†å’Œæ¨¡å‹  </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDataset</span>(<span class="params">Dataset</span>):</span>  </span><br><span class="line">    <span class="comment"># å®ç°__len__å’Œ__getitem__æ–¹æ³•  </span></span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModel</span>(<span class="params">nn.Module</span>):</span>  </span><br><span class="line">    <span class="comment"># å®šä¹‰æ¨¡å‹ç»“æ„,å¯èƒ½éœ€è¦è€ƒè™‘å¦‚ä½•æ‹†åˆ†æ¨¡å‹  </span></span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ  </span></span><br><span class="line">dist.init_process_group(backend=<span class="string">&#x27;nccl&#x27;</span>, init_method=<span class="string">&#x27;tcp://localhost:23456&#x27;</span>, rank=<span class="number">0</span>, world_size=torch.cuda.device_count())  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### åˆå§‹åŒ–æ•°æ®é›†å’Œæ¨¡å‹  </span></span><br><span class="line">dataset = MyDataset()  </span><br><span class="line">sampler = DistributedSampler(dataset)  </span><br><span class="line">dataloader = DataLoader(dataset, batch_size=<span class="number">32</span>, shuffle=<span class="literal">False</span>, sampler=sampler)  </span><br><span class="line">model = MyModel()  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### æ‹†åˆ†æ¨¡å‹ï¼ˆè¿™é€šå¸¸éœ€è¦æ ¹æ®æ¨¡å‹çš„å…·ä½“ç»“æ„æ¥æ‰‹åŠ¨å®Œæˆï¼‰  </span></span><br><span class="line"><span class="comment">#### ä¾‹å¦‚,å¦‚æœæ¨¡å‹æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†,å¯ä»¥å°†å®ƒä»¬åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„è®¾å¤‡ä¸Š  </span></span><br><span class="line">model_part1 = model.part1.to(<span class="string">&#x27;cuda:0&#x27;</span>)  </span><br><span class="line">model_part2 = model.part2.to(<span class="string">&#x27;cuda:1&#x27;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### ä½¿ç”¨DistributedDataParallelåŒ…è£…æ¨¡å‹  </span></span><br><span class="line">model = DDP(model, device_ids=[torch.cuda.current_device()])  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨  </span></span><br><span class="line">criterion = nn.CrossEntropyLoss()  </span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### è®­ç»ƒå¾ªç¯  </span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):  </span><br><span class="line">    <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> dataloader:  </span><br><span class="line">        inputs, labels = inputs.to(model.device), labels.to(model.device)  </span><br><span class="line">        optimizer.zero_grad()  </span><br><span class="line">        outputs = model(inputs)  </span><br><span class="line">        loss = criterion(outputs, labels)  </span><br><span class="line">        loss.backward()  </span><br><span class="line">        optimizer.step()  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#### é”€æ¯åˆ†å¸ƒå¼è¿›ç¨‹ç»„  </span></span><br><span class="line">dist.destroy_process_group()</span><br></pre></td></tr></table></figure><p><a href="https://github.com/jia-zhuang/pytorch-multi-gpu-training">jia-zhuang/pytorch-multi-gpu-training: æ•´ç† pytorch å•æœºå¤š GPU è®­ç»ƒæ–¹æ³•ä¸åŸç† (github.com)</a></p><h2 id="å¸¸ç”¨Container"><a href="#å¸¸ç”¨Container" class="headerlink" title="å¸¸ç”¨Container"></a>å¸¸ç”¨Container</h2><div class="table-container"><table><thead><tr><th>Containers</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module"><code>Module</code></a></td><td>Base class for all neural network modules.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.Sequential.html#torch.nn.Sequential"><code>Sequential</code></a></td><td>A sequential container.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.ModuleList.html#torch.nn.ModuleList"><code>ModuleList</code></a></td><td>Holds submodules in a list.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.ModuleDict.html#torch.nn.ModuleDict"><code>ModuleDict</code></a></td><td>Holds submodules in a dictionary.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.ParameterList.html#torch.nn.ParameterList"><code>ParameterList</code></a></td><td>Holds parameters in a list.</td></tr><tr><td><a href="https://pytorch.org/docs/stable/generated/torch.nn.ParameterDict.html#torch.nn.ParameterDict"><code>ParameterDict</code></a></td><td>Holds parameters in a dictionary.</td></tr></tbody></table></div><p><code>Module</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">20</span>, <span class="number">5</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(<span class="number">20</span>, <span class="number">20</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = F.relu(self.conv1(x))</span><br><span class="line">        <span class="keyword">return</span> F.relu(self.conv2(x))</span><br></pre></td></tr></table></figure><p><code>Sequential</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">model = nn.Sequential(</span><br><span class="line">          nn.Conv2d(<span class="number">1</span>,<span class="number">20</span>,<span class="number">5</span>),</span><br><span class="line">          nn.ReLU(),</span><br><span class="line">          nn.Conv2d(<span class="number">20</span>,<span class="number">64</span>,<span class="number">5</span>),</span><br><span class="line">          nn.ReLU()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using Sequential with OrderedDict. This is functionally the</span></span><br><span class="line"><span class="comment"># same as the above code</span></span><br><span class="line">model = nn.Sequential(OrderedDict([</span><br><span class="line">          (<span class="string">&#x27;conv1&#x27;</span>, nn.Conv2d(<span class="number">1</span>,<span class="number">20</span>,<span class="number">5</span>)),</span><br><span class="line">          (<span class="string">&#x27;relu1&#x27;</span>, nn.ReLU()),</span><br><span class="line">          (<span class="string">&#x27;conv2&#x27;</span>, nn.Conv2d(<span class="number">20</span>,<span class="number">64</span>,<span class="number">5</span>)),</span><br><span class="line">          (<span class="string">&#x27;relu2&#x27;</span>, nn.ReLU())</span><br><span class="line">        ]))</span><br></pre></td></tr></table></figure><p><code>ModuleList</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.linears = nn.ModuleList([nn.Linear(<span class="number">10</span>, <span class="number">10</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="comment"># ModuleList can act as an iterable, or be indexed using ints</span></span><br><span class="line">        <span class="keyword">for</span> i, l <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.linears):</span><br><span class="line">            x = self.linears[i // <span class="number">2</span>](x) + l(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p><code>ModuleDict</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.choices = nn.ModuleDict(&#123;</span><br><span class="line">                <span class="string">&#x27;conv&#x27;</span>: nn.Conv2d(<span class="number">10</span>, <span class="number">10</span>, <span class="number">3</span>),</span><br><span class="line">                <span class="string">&#x27;pool&#x27;</span>: nn.MaxPool2d(<span class="number">3</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        self.activations = nn.ModuleDict([</span><br><span class="line">                [<span class="string">&#x27;lrelu&#x27;</span>, nn.LeakyReLU()],</span><br><span class="line">                [<span class="string">&#x27;prelu&#x27;</span>, nn.PReLU()]</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, choice, act</span>):</span></span><br><span class="line">        x = self.choices[choice](x)</span><br><span class="line">        x = self.activations[act](x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p><code>ParameterList</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.params = nn.ParameterList([nn.Parameter(torch.randn(<span class="number">10</span>, <span class="number">10</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="comment"># ParameterList can act as an iterable, or be indexed using ints</span></span><br><span class="line">        <span class="keyword">for</span> i, p <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.params):</span><br><span class="line">            x = self.params[i // <span class="number">2</span>].mm(x) + p.mm(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p><code>ParameterDict</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.params = nn.ParameterDict(&#123;</span><br><span class="line">                <span class="string">&#x27;left&#x27;</span>: nn.Parameter(torch.randn(<span class="number">5</span>, <span class="number">10</span>)),</span><br><span class="line">                <span class="string">&#x27;right&#x27;</span>: nn.Parameter(torch.randn(<span class="number">5</span>, <span class="number">10</span>))</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x, choice</span>):</span></span><br><span class="line">        x = self.params[choice].mm(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><h2 id="å®¹æ˜“æ··æ·†å’Œé—å¿˜çš„æ–¹æ³•"><a href="#å®¹æ˜“æ··æ·†å’Œé—å¿˜çš„æ–¹æ³•" class="headerlink" title="å®¹æ˜“æ··æ·†å’Œé—å¿˜çš„æ–¹æ³•"></a>å®¹æ˜“æ··æ·†å’Œé—å¿˜çš„æ–¹æ³•</h2><h3 id="torch-Tensor-scatter"><a href="#torch-Tensor-scatter" class="headerlink" title="torch.Tensor.scatter_"></a>torch.Tensor.scatter_</h3><p>torch.scatterçš„in-placeæ“ä½œ</p><p><code>Tensor.scatter_(dim, index, src, *, reduce=None) â†’ [Tensor</code>]</p><p><strong>æŒ‰ç…§ <code>index</code> å¼ é‡ä¸­æŒ‡å®šçš„ç´¢å¼•,å°†å¼ é‡ <code>src</code> ä¸­çš„æ‰€æœ‰å€¼å†™å…¥ <code>self</code> ä¸­</strong>.</p><p>å¯¹äº <code>src</code> ä¸­çš„æ¯ä¸ªå€¼,å…¶è¾“å‡ºç´¢å¼•åœ¨ <code>dimension != dim</code> æ—¶ç”± <code>src</code> ä¸­çš„ç´¢å¼•æŒ‡å®š,åœ¨ <code>dimension = dim</code> æ—¶ç”± <code>index</code> ä¸­çš„ç›¸åº”å€¼æŒ‡å®š.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self[index[i][j][k]][j][k] = src[i][j][k]  <span class="comment"># if dim == 0</span></span><br><span class="line">self[i][index[i][j][k]][k] = src[i][j][k]  <span class="comment"># if dim == 1</span></span><br><span class="line">self[i][j][index[i][j][k]] = src[i][j][k]  <span class="comment"># if dim == 2</span></span><br></pre></td></tr></table></figure><p>selfã€index å’Œ srcï¼ˆå¦‚æœæ˜¯å¼ é‡ï¼‰çš„<strong>ç»´æ•°åº”è¯¥ç›¸åŒ</strong>.å¯¹äº<strong>æ‰€æœ‰ç»´åº¦d,index.size(d) &lt;= src.size(d)</strong>ï¼›å¯¹äºæ‰€æœ‰<strong>ç»´åº¦ d != dim,index.size(d) &lt;= self.size(d)</strong>,index å’Œ src ä¸ä¼šå¹¿æ’­.</p><p>ä¸gatheré€†æ“ä½œ,å¸¸ç”¨ä½œå†™one-hoté‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">index = torch.tensor([[<span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line">value = <span class="number">2</span></span><br><span class="line">torch.zeros(<span class="number">3</span>, <span class="number">5</span>).scatter_(<span class="number">0</span>, index, value)</span><br><span class="line"></span><br><span class="line">src = torch.arange(<span class="number">1</span>, <span class="number">11</span>).reshape((<span class="number">2</span>, <span class="number">5</span>))</span><br><span class="line">src</span><br><span class="line">index = torch.tensor([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>]])</span><br><span class="line">torch.zeros(<span class="number">3</span>, <span class="number">5</span>, dtype=src.dtype).scatter_(<span class="number">0</span>, index, src)</span><br><span class="line">index = torch.tensor([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>]])</span><br><span class="line">torch.zeros(<span class="number">3</span>, <span class="number">5</span>, dtype=src.dtype).scatter_(<span class="number">1</span>, index, src)</span><br><span class="line"></span><br><span class="line">torch.full((<span class="number">2</span>, <span class="number">4</span>), <span class="number">2.</span>).scatter_(<span class="number">1</span>, torch.tensor([[<span class="number">2</span>], [<span class="number">3</span>]]),</span><br><span class="line">           <span class="number">1.23</span>, reduce=<span class="string">&#x27;multiply&#x27;</span>)</span><br><span class="line">torch.full((<span class="number">2</span>, <span class="number">4</span>), <span class="number">2.</span>).scatter_(<span class="number">1</span>, torch.tensor([[<span class="number">2</span>], [<span class="number">3</span>]]),</span><br><span class="line">           <span class="number">1.23</span>, reduce=<span class="string">&#x27;add&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="torch-gather"><a href="#torch-gather" class="headerlink" title="torch.gather"></a>torch.gather</h3><p><code>torch.gather(input, dim, index, *, sparse_grad=False, out=None) â†’ [Tensor](https://pytorch.org/docs/stable/tensors.html#torch.Tensor)</code></p><p>è¾“å…¥å’Œç´¢å¼•çš„ç»´æ•°å¿…é¡»ç›¸åŒ. <strong>åœ¨ d != dimçš„ç»´åº¦ ä¸­ï¼Œindex.size(d) &lt;= input.size(d)</strong>ã€‚è¾“å…¥å’Œindexä¸ä¼šç›¸äº’å¹¿æ’­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">out[i][j][k] = <span class="built_in">input</span>[index[i][j][k]][j][k]  <span class="comment"># if dim == 0</span></span><br><span class="line">out[i][j][k] = <span class="built_in">input</span>[i][index[i][j][k]][k]  <span class="comment"># if dim == 1</span></span><br><span class="line">out[i][j][k] = <span class="built_in">input</span>[i][j][index[i][j][k]]  <span class="comment"># if dim == 2</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">torch.gather(t, <span class="number">1</span>, torch.tensor([[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">0</span>]]))</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°±æ˜¯æŠŠtæ ¹æ®index torch.tensor([[0, 0], [1, 0]])é‡æ–°å¾—åˆ°ä¸€ä¸ªtensor.</p><blockquote><p>scatteræ˜¯é€šè¿‡indexå°†srcçš„æ•°æ®æ”¾åœ¨inputä¸­</p><p>gatheræ˜¯é€šè¿‡indexå°†inputçš„æ•°æ®å–å‡ºæ¥</p></blockquote><h3 id="torch-split"><a href="#torch-split" class="headerlink" title="torch.split"></a>torch.split</h3><p><code>torch.split(tensor, split_size_or_sections, dim=0</code></p><p>å°†å¼ é‡åˆ†å‰²æˆå—.æ¯ä¸ªå—éƒ½æ˜¯åŸå§‹å¼ é‡çš„ä¸€ä¸ªview.</p><p>å¦‚æœ split_size_or_sections æ˜¯æ•´æ•°ç±»å‹,é‚£ä¹ˆå¼ é‡å°†è¢«åˆ†å‰²æˆå¤§å°ç›¸ç­‰çš„å—ï¼ˆå¦‚æœå¯èƒ½ï¼‰.å¦‚æœå¼ é‡åœ¨ç»™å®šç»´åº¦ dim ä¸Šçš„å¤§å°ä¸èƒ½è¢« split_size æ•´é™¤,åˆ™æœ€åä¸€ä¸ªå—çš„å¤§å°ä¼šå˜å°.</p><p>å¦‚æœ split_size_or_sections æ˜¯ä¸€ä¸ªåˆ—è¡¨,é‚£ä¹ˆå¼ é‡å°†è¢«åˆ†å‰²æˆ len(split_size_or_sections)å°å—,å…¶å¤§å°ä¸ split_size_or_sections ä¸€è‡´.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = torch.arange(<span class="number">10</span>).reshape(<span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">torch.split(a, <span class="number">2</span>)</span><br><span class="line">(tensor([[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">         [<span class="number">2</span>, <span class="number">3</span>]]),</span><br><span class="line"> tensor([[<span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">         [<span class="number">6</span>, <span class="number">7</span>]]),</span><br><span class="line"> tensor([[<span class="number">8</span>, <span class="number">9</span>]]))</span><br><span class="line">torch.split(a, [<span class="number">1</span>, <span class="number">4</span>])</span><br><span class="line">(tensor([[<span class="number">0</span>, <span class="number">1</span>]]),</span><br><span class="line"> tensor([[<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">         [<span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">         [<span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">         [<span class="number">8</span>, <span class="number">9</span>]]))</span><br></pre></td></tr></table></figure><h3 id="torch-tensor-split"><a href="#torch-tensor-split" class="headerlink" title="torch.tensor_split"></a>torch.tensor_split</h3><p><code>torch.tensor_split(input, indices_or_sections, dim=0) â†’ List of Tensors</code></p><p>æ ¹æ® indices_or_sections æŒ‡å®šçš„ç´¢å¼•æˆ–éƒ¨åˆ†æ•°,å°†å¼ é‡æ²¿ç»´åº¦ dim åˆ†å‰²æˆå¤šä¸ªå­å¼ é‡,æ‰€æœ‰å­å¼ é‡éƒ½æ˜¯è¾“å…¥çš„è§†å›¾.</p><ul><li><p>å¦‚æœ indices_or_sections æ˜¯ä¸€ä¸ªæ•´æ•° n æˆ–ä¸€ä¸ªæ•°å€¼ä¸º n çš„é›¶ç»´é•¿å¼ é‡ï¼Œåˆ™è¾“å…¥ä¼šæ²¿ç€ç»´åº¦ dim è¢«åˆ†å‰²æˆ n ä¸ªéƒ¨åˆ†ã€‚å¦‚æœè¾“å…¥æ²¿ç€ç»´æ•° dim è¢« n æ•´é™¤ï¼Œåˆ™æ¯ä¸ªéƒ¨åˆ†çš„å¤§å°ç›¸ç­‰ï¼Œå³ input.size(dim) / nã€‚å¦‚æœè¾“å…¥ä¸èƒ½è¢« n æ•´é™¤ï¼Œåˆ™ç¬¬ä¸€ä¸ª int(input.size(dim) % n) éƒ¨åˆ†çš„å¤§å°ä¸º int(input.size(dim) / n) + 1ï¼Œå…¶ä½™éƒ¨åˆ†çš„å¤§å°ä¸º int(input.size(dim)/n)ã€‚</p></li><li><p>å¦‚æœ indices_or_sections æ˜¯ä¸€ä¸ª ints åˆ—è¡¨æˆ–å…ƒç»„ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªä¸€ç»´é•¿å¼ é‡ï¼Œé‚£ä¹ˆè¾“å…¥å°†åœ¨åˆ—è¡¨ã€å…ƒç»„æˆ–å¼ é‡ä¸­çš„æ¯ä¸ªç´¢å¼•å¤„æ²¿ç€ç»´åº¦ dim åˆ†å‰²ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ indices_or_sections=[2,3]ï¼Œdim=0ï¼Œåˆ™ä¼šäº§ç”Ÿå¼ é‡ input[:2]ã€input[2:3] å’Œ input[3:]ã€‚</p></li><li><p>å¦‚æœ indices_or_sections æ˜¯å¼ é‡ï¼Œåœ¨ CPU ä¸Šå¿…é¡»æ˜¯é›¶ç»´æˆ–ä¸€ç»´é•¿å¼ é‡ã€‚</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x = torch.arange(<span class="number">8</span>)</span><br><span class="line">torch.tensor_split(x, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">x = torch.arange(<span class="number">7</span>)</span><br><span class="line">torch.tensor_split(x, <span class="number">3</span>)</span><br><span class="line">torch.tensor_split(x, (<span class="number">1</span>, <span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">x = torch.arange(<span class="number">14</span>).reshape(<span class="number">2</span>, <span class="number">7</span>)</span><br><span class="line">x</span><br><span class="line">torch.tensor_split(x, <span class="number">3</span>, dim=<span class="number">1</span>)</span><br><span class="line">torch.tensor_split(x, (<span class="number">1</span>, <span class="number">6</span>), dim=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><blockquote><p>splitå¦‚æœè¾“å…¥æ˜¯æ•´æ•°,æŒ‰ç…§dimåˆ†æˆå¤šæ®µ,æ¯æ®µdimä¸Šçš„å¤§å°ç­‰äºè¿™ä¸ªæ•´æ•°(å¦‚æœèƒ½é™¤å°½)</p><p>å¦‚æœè¾“å…¥æ˜¯list,æ¯æ®µå¤§å°å°±å¯¹åº”listä¸­çš„å€¼(listçš„é•¿åº¦ä¹Ÿè·Ÿdimå¯¹åº”çš„å¤§å°ç›¸åŒ).è¿”å›tuple[Tensor,â€¦]</p><p>tensor_splitå¦‚æœè¾“å…¥æ˜¯æ•´æ•°,èƒ½é™¤å°½çš„è¯ç»“æœå°±è·Ÿsplitç±»ä¼¼,å¦åˆ™å‰<code>int(input.size(dim) % n)</code> æ®µ å¤§å°<code>int(input.size(dim) / n) + 1</code>, åé¢çš„å¤§å° ä¸º<code>int(input.size(dim) / n)</code></p><p>å¦‚æœæ˜¯list,æ¯ä¸€æ®µæ•°æ®æ˜¯listä¸­çš„ä¸¤ä¸ªindices,ä¹Ÿå°±æ˜¯</p><p>For instance, <code>indices_or_sections=[2, 3]</code> and <code>dim=0</code> would result in the tensors <code>input[:2]</code>, <code>input[2:3]</code>, and <code>input[3:]</code></p><p>ä¸¤è€…é»˜è®¤diméƒ½æ˜¯0</p></blockquote><h3 id="torch-Tensor-repeat"><a href="#torch-Tensor-repeat" class="headerlink" title="torch.Tensor.repeat"></a>torch.Tensor.repeat</h3><p><code>Tensor.repeat(*sizes)</code></p><p>è¿›è¡Œæ‹·è´æ•°æ®,æ²¿æŒ‡å®šç»´åº¦é‡å¤æ­¤å¼ é‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">x.repeat(<span class="number">4</span>, <span class="number">2</span>)</span><br><span class="line">x.repeat(<span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>).size()</span><br></pre></td></tr></table></figure><h3 id="torch-repeat-interleave"><a href="#torch-repeat-interleave" class="headerlink" title="torch.repeat_interleave"></a>torch.repeat_interleave</h3><p><code>torch.repeat_interleave(input, repeats, dim=None, *, output_size=None)</code></p><ul><li><strong>input</strong> (<a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor"><em>Tensor</em></a>) â€“ the input tensor.</li><li><strong>repeats</strong> (<a href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor"><em>Tensor</em></a> <em>or</em> <a href="https://docs.python.org/3/library/functions.html#int"><em>int</em></a>) â€“ The number of repetitions for each element. repeats is broadcasted to fit the shape of the given axis.</li><li><strong>dim</strong> (<a href="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>,</em> <em>optional</em>) â€“ The dimension along which to repeat values. <strong>By default, use the flattened input array, and return a flat output array</strong>.</li></ul><p><strong>output_size</strong> (<a href="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>,</em> <em>optional</em>) â€“ Total output size for the given axis ( e.g. sum of repeats). If given, it will avoid stream synchronization needed to calculate output shape of the tensor.</p><p>é‡å¤çš„æ–¹å¼æ˜¯æ¯ä¸ªå€¼åé‡å¤ä¸€æ¬¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">x.repeat_interleave(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># tensor([1, 1, 2, 2, 3, 3])</span></span><br><span class="line">y = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">torch.repeat_interleave(y, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># tensor([1, 1, 2, 2, 3, 3, 4, 4])</span></span><br><span class="line">torch.repeat_interleave(y, <span class="number">3</span>, dim=<span class="number">1</span>)</span><br><span class="line">torch.repeat_interleave(y, torch.tensor([<span class="number">1</span>, <span class="number">2</span>]), dim=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># tensor([[1, 2],</span></span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">torch.repeat_interleave(y, torch.tensor([<span class="number">1</span>, <span class="number">2</span>]), dim=<span class="number">0</span>, output_size=<span class="number">3</span>)</span><br><span class="line"><span class="comment"># tensor([[1, 2],</span></span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [<span class="number">3</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure><h3 id="torch-Tensor-expand"><a href="#torch-Tensor-expand" class="headerlink" title="torch.Tensor.expand"></a>torch.Tensor.expand</h3><p><code>Tensor.expand(*sizes)</code></p><p>è¿”å›è¾“å…¥å¼ é‡çš„æ–°è§†å›¾,å¹¶å°†å•ç»´åº¦æ‰©å±•åˆ°æ›´å¤§å°ºå¯¸.</p><p>å°† -1 ä½œä¸ºç»´åº¦çš„å¤§å°æ„å‘³ç€ä¸æ”¹å˜è¯¥ç»´åº¦çš„å¤§å°.</p><p>å¼ é‡ä¹Ÿå¯ä»¥æ‰©å±•åˆ°æ›´å¤šç»´æ•°,æ–°çš„ç»´æ•°å°†è¢«æ·»åŠ åˆ°å‰é¢ã€‚å¯¹äºæ–°ç»´åº¦,å¤§å°ä¸èƒ½è®¾ç½®ä¸º-1.</p><p>æ‰©å±•å¼ é‡ä¸ä¼šåˆ†é…æ–°çš„å†…å­˜,åªä¼šåœ¨ç°æœ‰å¼ é‡ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„è§†å›¾,å…¶ä¸­å¤§å°ä¸º 1 çš„ç»´åº¦ä¼šé€šè¿‡è®¾ç½®è·¨è·ä¸º 0 æ¥æ‰©å±•ä¸ºæ›´å¤§çš„ç»´åº¦.</p><blockquote><p>æ‰©å±•å¼ é‡çš„ä¸€ä¸ªä»¥ä¸Šå…ƒç´ å¯èƒ½æŒ‡å‘ä¸€ä¸ªå†…å­˜ä½ç½®ã€‚ å› æ­¤ï¼Œin-placeæ“ä½œï¼ˆå°¤å…¶æ˜¯çŸ¢é‡åŒ–æ“ä½œï¼‰å¯èƒ½ä¼šå¯¼è‡´ä¸æ­£ç¡®çš„è¡Œä¸ºã€‚ å¦‚æœéœ€è¦å†™å…¥å¼ é‡ï¼Œè¯·å…ˆå…‹éš†å®ƒä»¬ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([[<span class="number">1</span>], [<span class="number">2</span>], [<span class="number">3</span>]])</span><br><span class="line">x.size() <span class="comment"># torch.Size([3, 1])</span></span><br><span class="line">x.expand(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">x.expand(-<span class="number">1</span>, <span class="number">4</span>)   <span class="comment"># -1 means not changing the size of that dimension</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([[<span class="number">1</span>], [<span class="number">2</span>], [<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(x.expand(<span class="number">3</span>, <span class="number">4</span>).stride()) <span class="comment"># (1, 0)</span></span><br><span class="line"><span class="built_in">print</span>(x.expand(-<span class="number">1</span>, <span class="number">4</span>).stride()) <span class="comment"># (1, 0)</span></span><br></pre></td></tr></table></figure><h3 id="torch-Tensor-expand-as"><a href="#torch-Tensor-expand-as" class="headerlink" title="torch.Tensor.expand_as"></a>torch.Tensor.expand_as</h3><p><code>Tensor.expand_as(other)</code></p><p>å°†æ­¤å¼ é‡å±•å¼€ä¸ºä¸å…¶ä»–å¼ é‡ç›¸åŒçš„å¤§å°ã€‚self.expand_as(other) ç›¸å½“äº self.expand(other.size())ã€‚</p><p>expandå’Œrepeat,å‰è€…è¿”å›view,åè€…è¿”å›æ•°æ®.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(x.repeat(<span class="number">6</span>, <span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(x.expand(<span class="number">6</span>, <span class="number">3</span>)) <span class="comment"># same</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Pytorchæ˜¯å¾ˆå¥½çš„æ·±åº¦å­¦ä¹ æ¡†æ¶,ä½†åœ¨ä½¿ç”¨æ—¶ä½ å¯èƒ½ä»ç„¶ä¸æ¸…æ¥šå…¶ä¸­ä¸€äº›æ¦‚å¿µ.è¿™é‡Œæˆ‘åªä»¥å®˜æ–¹æ–‡æ¡£ä¸ºä¾æ®å°è¯•è§£é‡Šå…¶ä¸­ä¸€äº›æ¦‚å¿µå’Œæ–¹æ³•. æˆ‘è¿™é‡Œå¯ä»¥ç§°ä½œEffective Pytorch.&lt;br&gt;</summary>
    
    
    
    
    <category term="pytorch" scheme="https://www.sekyoro.top/tags/pytorch/"/>
    
  </entry>
  
  <entry>
    <title>A better C:from C++, Go,Rust to Zig</title>
    <link href="https://www.sekyoro.top/2024/06/23/A-better-C-from-C-Go-Rust-to-Zig/"/>
    <id>https://www.sekyoro.top/2024/06/23/A-better-C-from-C-Go-Rust-to-Zig/</id>
    <published>2024-06-23T03:28:16.000Z</published>
    <updated>2024-06-25T03:09:37.398Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>ä»Cè¯­è¨€è¯ç”Ÿå·²ç»äº”åå¤šå¹´äº†,ç°åœ¨å·²ç»æœ‰äº†è®¸å¤šé«˜çº§è¯­è¨€,å…¶ä¸­å¾ˆå¤šèƒŒé å¤§å‚,æ¯”å¦‚Java,Go,C#,Dart,Swiftç­‰ç­‰(ç”²éª¨æ–‡,è°·æ­Œå¾®è½¯å’Œè‹¹æœ,è¿™ç±»è¯­è¨€é€šè¿‡å…¬å¸æ›´æ–°).ä¹Ÿæœ‰å¾ˆå¤šç¤¾åŒºçš„è¯­è¨€,æ¯”å¦‚Python,Rust,PHP,Rubyç­‰(è¿™ç±»è¯­è¨€å¾€å¾€é€šè¿‡æ—©æœŸåˆ›å»ºè€…å’Œä¸€äº›æ ¸å¿ƒæˆå‘˜æ›´æ–°å’Œç»´æŠ¤,è¿™é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šå¼€æºçš„è¯­è¨€,å…è®¸å…¶ä»–äººä¿®æ”¹).<br>ç›¸è¾ƒäºå…¬å¸æ——ä¸‹çš„è¯­è¨€,ç¤¾åŒºç±»å‹çš„è¯­è¨€å¾€å¾€æ›´åŠ ç®€æ´,åœ¨ä½¿ç”¨æˆ–è€…ç”Ÿäº§ä¸‹æ•ˆç‡é«˜,ä½†ä¹Ÿå­˜åœ¨ç”Ÿæ€ç›¸å¯¹è¾ƒå·®ã€å·¥å…·é“¾ä¸å¤Ÿã€æ›´æ–°å‘åŠ›ä¸å¤ŸæŒä¹…ã€æ–‡æ¡£ä¸å¤Ÿä¸°å¯Œçš„é—®é¢˜.</p><p>è€Œ A better Cçš„æ„æ€å°±æ˜¯åœ¨åé¢çš„è¯­è¨€ä¸­æ‰¾åˆ°æ€§èƒ½è¾ƒå¼º,ä½¿ç”¨å‹å¥½å¹¶ä¸”ç”Ÿæ€æŒç»­å‘å±•çš„è¯­è¨€.TLDR:åœ¨å¤§å‹é¡¹ç›®ä¸Šè¿˜æ˜¯ä½¿ç”¨C++,åœ¨ä¸€äº›å·¥å…·é“¾æˆ–è€…ä»£ç é‡æ„ä¸Šå¯ä»¥è€ƒè™‘Rust. </p><span id="more"></span><blockquote><p>â€œä¸–ä¸Šå…¶å®åªæœ‰ä¸¤ç§ç¼–ç¨‹è¯­è¨€ï¼Œä¸€ç§æ˜¯å¤§å®¶ä¸€ç›´å–·å®ƒéš¾ç”¨çš„ï¼Œä¸€ç§æ˜¯æ ¹æœ¬æ²¡äººç”¨çš„ã€‚â€ â€”â€” C++ çš„ä½œè€… Bjarne Stroustrup </p></blockquote><p>ç›¸å¯¹äºJava,C#è¿™ç§è¯­è¨€,æˆ‘ä»¬å°è¯•æ‰¾åˆ°ä½¿ç”¨ä¸Šæ›´åŠ è½»å‹(æŒ‡çš„æ˜¯ä¸ä¾èµ–æŸç§é¢†åŸŸ),æ€§èƒ½æ›´å¼ºå ç”¨æ›´å°çš„è¯­è¨€.</p><h2 id="Better-C"><a href="#Better-C" class="headerlink" title="Better C"></a>Better C</h2><h3 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h3><p>C++20ç›®å‰å·²ç»æœ‰äº†å¾ˆå¤šModernçš„ç‰¹æ€§,ä½†æ˜¯ç›®å‰ä»ç„¶ç¼ºä¹çš„ä¾ç„¶è¿˜æ˜¯<code>build system,test harness, linter</code>,C++ç¤¾åŒºæ•´ä½“æ¯”è¾ƒç¦»æ•£,ä¹Ÿæ²¡æœ‰å¤§å…¬å¸æ‹¿å‡ºç±»ä¼¼jsçš„all in oneçš„å·¥å…·é“¾,ç›®å‰ç”¨å¾—å¤šçš„æ˜¯vcpkg+cmake. ä¹Ÿæœ‰conanå’Œxmakeç­‰ç­‰,ä½†ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æœ‰æ¬ ç¼º,ä¸»è¦åŸå› æ˜¯C++æ²¡æœ‰æ‰€è°“çš„å®˜æ–¹,åªæœ‰c++æ ‡å‡†å§”å‘˜ä¼š,ä¹Ÿä¸åƒå…¶ä»–å…¬å¸å¸¸ç”¨çš„ç¼–ç¨‹è¯­è¨€ä¼šæœ‰å…¬å¸æ¨å‡ºå·¥å…·é“¾.</p><p>ä½†C++è¯­è¨€æœ¬èº«è¿˜æ˜¯ä¸é”™çš„,è¶³å¤Ÿåº•å±‚,è¶³å¤Ÿå€¼å¾—å­¦ä¹ .</p><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><p>GoèƒŒé è°·æ­Œ,ç”Ÿæ€ç›®å‰æ„Ÿè§‰è¿˜æ˜¯ä¸å¤Ÿæ˜æœ—,ä¸ªäººæ„Ÿè§‰å¯èƒ½æ˜¯äº‘åŸç”ŸåŸºç¡€è®¾æ–½ä¸Š,å¦‚æœä½ å†™è¿‡Go,å°±çŸ¥é“å¤§å‹Webé¡¹ç›®å†™Goè¿˜æ˜¯æœ‰æ‰€æ¬ ç¼º,æ‹¿æ¥å†™äº‹åŠ¡è¿˜æ˜¯éº»çƒ¦.</p><p>å¹¶ä¸”goçš„nilé”™è¯¯å¤„ç†,moduleç­‰ä¾ç„¶é­å—è¯Ÿç—….ä½†æ˜¯Goæœ¬èº«ä»£ç è¿˜æ˜¯å¾ˆå®¹æ˜“è¯»çš„,è€Œä¸”å·¥å…·é“¾ä¹Ÿç›¸å¯¹å®Œå–„,æœ‰åŒ…ç®¡ç†å·¥å…·,é¡¹ç›®æ„å»ºä¹Ÿå¯ä»¥ä½¿ç”¨cmake.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;html/template&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        p := Person&#123;</span><br><span class="line">            Name: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">            Age:  <span class="number">30</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        t, err := template.ParseFiles(<span class="string">&quot;templates/index.html&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        t.Execute(w, p)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Starting server on :8080&quot;</span>)</span><br><span class="line">    http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(wrkID <span class="keyword">int</span>, jobs &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, results <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> job := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker %d started job %d\n&quot;</span>, wrkID, job)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker %d finished job %d\n&quot;</span>, wrkID, job)</span><br><span class="line">        results &lt;- job * <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    jobs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start workers</span></span><br><span class="line">    <span class="keyword">for</span> w := <span class="number">1</span>; w &lt;= <span class="number">3</span>; w++ &#123;</span><br><span class="line">        <span class="keyword">go</span> worker(w, jobs, results)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send jobs</span></span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">1</span>; j &lt;= <span class="number">9</span>; j++ &#123;</span><br><span class="line">        jobs &lt;- j</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(jobs)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Collect results</span></span><br><span class="line">    <span class="keyword">for</span> a := <span class="number">1</span>; a &lt;= <span class="number">9</span>; a++ &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Result: %d\n&quot;</span>, &lt;-results)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h3><p>Rust,æœ€è¿‘å‡ å¹´çƒ­åº¦å¾ˆé«˜,ä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸å°‘é—®é¢˜,ä¸Šæ‰‹é—¨æ§›é«˜,éœ€è¦é¢å¤–ç†è§£çš„æ¦‚å¿µä¸å°‘.</p><p>Rustçš„ä¸€äº›ä¼˜åŠ¿åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>å¹¶å‘å’Œå¹¶è¡Œï¼šRustå†…ç½®å¯¹å¹¶è¡Œç¼–ç¨‹çš„æ”¯æŒï¼Œä»¥åŠå®‰å…¨é«˜æ•ˆçš„å¤šçº¿ç¨‹ç‰¹æ€§</li><li>æ€§èƒ½ï¼šç”±äºRustä»£ç ä¸éœ€è¦è¿è¡Œæ—¶ï¼ŒåŒæ—¶å®ƒä¸éœ€è¦é¢å¤–çš„åƒåœ¾å›æ”¶å™¨åŠŸè€—ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨æ›´å°‘çš„èµ„æºå¹¶æé«˜æ€§èƒ½ï¼Œ</li><li>å†…å­˜å®‰å…¨ä¸”æ— åƒåœ¾å›æ”¶ï¼šç”±äºæ‰€æœ‰æƒå’Œå€Ÿç”¨ç­‰è§„åˆ™ï¼ŒRuståœ¨æ²¡æœ‰åƒåœ¾å›æ”¶å™¨çš„æƒ…å†µä¸‹ç®¡ç†å†…å­˜ï¼Œä»è€Œå®ç°æ›´é«˜æ•ˆå’Œå¯é¢„æµ‹çš„æ€§èƒ½</li><li>è·¨å¹³å°å…¼å®¹æ€§ï¼šRustæ”¯æŒè·¨å¹³å°å¼€å‘ï¼Œæ„å‘³ç€å¯ä»¥åœ¨å¤šä¸ªç³»ç»Ÿä¸Šç¼–è¯‘ä»£ç è€Œä¸éœ€è¦å¤ªå¤šçš„ä¿®æ”¹ä»£ç </li><li>å¼ºå¤§çš„ç”Ÿæ€ç³»ç»Ÿï¼šRustæ‹¥æœ‰å¼ºå¤§çš„å·¥å…·å’Œåº“ç”Ÿæ€ç³»ç»Ÿã€‚å®ƒçš„åŒ…ç®¡ç†å™¨Cargoæ˜¾è‘—ç®€åŒ–äº†ä¾èµ–ç®¡ç†å’Œä¸å¤–éƒ¨åº“é›†æˆçš„éš¾åº¦</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span></span> &#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    age: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Person &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(name: &amp;<span class="built_in">str</span>, age: <span class="built_in">u32</span>) -&gt; Person &#123;</span><br><span class="line">        Person &#123;</span><br><span class="line">            name: <span class="built_in">String</span>::from(name),</span><br><span class="line">            age,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">greet</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello, my name is &#123;&#125; and I&#x27;m &#123;&#125; years old.&quot;</span>, <span class="keyword">self</span>.name, <span class="keyword">self</span>.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> alice = Person::new(<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>);</span><br><span class="line">    alice.greet();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Direction</span></span> &#123;</span><br><span class="line">    Up,</span><br><span class="line">    Down,</span><br><span class="line">    Left,</span><br><span class="line">    Right,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">move_player</span></span>(direction: Direction) &#123;</span><br><span class="line">    <span class="keyword">match</span> direction &#123;</span><br><span class="line">        Direction::Up =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Moving up&quot;</span>),</span><br><span class="line">        Direction::Down =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Moving down&quot;</span>),</span><br><span class="line">        Direction::Left =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Moving left&quot;</span>),</span><br><span class="line">        Direction::Right =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Moving right&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    move_player(Direction::Up);</span><br><span class="line">    move_player(Direction::Left);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Zig"><a href="#Zig" class="headerlink" title="Zig"></a>Zig</h3><p>Zigå®˜æ–¹æ˜¯è¿™ä¹ˆè¯´çš„:Zig æ˜¯ä¸€ç§é€šç”¨çš„ç¼–ç¨‹è¯­è¨€å’Œå·¥å…·é“¾ï¼Œç”¨äºç»´æŠ¤<strong>å¥å£®</strong>ã€<strong>æœ€ä¼˜</strong>å’Œ<strong>å¯é‡ç”¨</strong>çš„è½¯ä»¶.</p><p>æ—¢ç„¶æœ‰äº†C++å’ŒRust,ä¸ºä»€ä¹ˆåˆè¦æè¿™ä¹ˆå¤šä¸œè¥¿?<a href="https://ziglang.org/zh/learn/why_zig_rust_d_cpp/">æœ‰äº† C++ã€D å’Œ Rustï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ Zigï¼Ÿ âš¡ Zig Programming Language (ziglang.org)</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const std = @import(&quot;std&quot;);</span><br><span class="line">const parseInt = std.fmt.parseInt;</span><br><span class="line"></span><br><span class="line">test &quot;parse integers&quot; &#123;</span><br><span class="line">    const input = &quot;123 67 89,99&quot;;</span><br><span class="line">    const ally = std.testing.allocator;</span><br><span class="line"></span><br><span class="line">    var list = std.ArrayList(u32).init(ally);</span><br><span class="line">    // Ensure the list is freed at scope exit.</span><br><span class="line">    // Try commenting out this line!</span><br><span class="line">    defer list.deinit();</span><br><span class="line"></span><br><span class="line">    var it = std.mem.tokenizeAny(u8, input, &quot; ,&quot;);</span><br><span class="line">    while (it.next()) |num| &#123;</span><br><span class="line">        const n = try parseInt(u32, num, 10);</span><br><span class="line">        try list.append(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const expected = [_]u32&#123; 123, 67, 89, 99 &#125;;</span><br><span class="line"></span><br><span class="line">    for (expected, list.items) |exp, actual| &#123;</span><br><span class="line">        try std.testing.expectEqual(exp, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const std = @import(&quot;std&quot;);</span><br><span class="line"></span><br><span class="line">pub fn main() !void &#123;</span><br><span class="line">    const x: i32 = 5;</span><br><span class="line">    const y: i32 = 10;</span><br><span class="line">    const sum = x + y;</span><br><span class="line">    std.log.info(&quot;The sum of &#123;&#125; and &#123;&#125; is &#123;&#125;&quot;, .&#123; x, y, sum &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const std = @import(&quot;std&quot;);</span><br><span class="line"></span><br><span class="line">fn greet(name: []const u8) void &#123;</span><br><span class="line">    std.log.info(&quot;Hello, &#123;&#125;!&quot;, .&#123;name&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub fn main() !void &#123;</span><br><span class="line">    greet(&quot;Alice&quot;);</span><br><span class="line">    greet(&quot;Bob&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®˜æ–¹æ–‡æ¡£é˜è¿°äº†éå¸¸å¤šZigçš„ä¼˜åŠ¿,çœ‹èµ·æ¥ç‰¹åˆ«å¸å¼•äºº,ä½†æ˜¯ç›®å‰ä½¿ç”¨çš„äººè¿˜æ˜¯ä¸å¤š.</p><p>Zigçš„ä¸€äº›<strong>åŠ£åŠ¿</strong>åŒ…æ‹¬ï¼š</p><ul><li>æœ‰é™çš„ç”Ÿæ€ç³»ç»Ÿï¼šå› ä¸ºå®ƒä»å¤„äºæ—©æœŸé˜¶æ®µï¼ŒZigè¯­è¨€çš„ç”Ÿæ€ç³»ç»Ÿæ¯”æˆç†Ÿè¯­è¨€æ›´å°</li><li>æˆç†Ÿåº¦å’Œå·¥å…·ï¼šZigæ˜¯ä¸€ç§æ–°è¯­è¨€ï¼Œè¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ã€‚ä½†è¯·æ³¨æ„ï¼Œä»ç„¶æœ‰ä¸€ä¸ªå¼ºå¤§è€Œæ´»è·ƒçš„ç¤¾åŒºæ”¯æŒå®ƒ</li><li>æ–‡æ¡£å¯ç”¨æ€§ï¼šZigæ˜¯ä¸€ç§ç›¸å¯¹è¾ƒæ–°çš„è¯­è¨€ï¼Œå› æ­¤æ–‡æ¡£æœ‰é™ï¼Œç¤¾åŒºæ­£åœ¨åŠªåŠ›æé«˜æ–‡æ¡£çš„å¯ç”¨æ€§</li></ul><p>å¼€å‘è€…å¯ä»¥åœ¨ç³»ç»Ÿç¼–ç¨‹ä¸­ä½¿ç”¨Zigæ¥æ„å»ºæ“ä½œç³»ç»Ÿã€è®¾å¤‡é©±åŠ¨ç¨‹åºå’ŒåµŒå…¥å¼ç³»ç»Ÿã€‚å…¶è¿˜åœ¨<a href="https://cloud.tencent.com/product/cli?from_column=20065&amp;from=20065">å‘½ä»¤è¡Œå·¥å…·</a>ä¸­ä¹Ÿæœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ï¼Œå¯ç”¨äºåˆ›å»ºé«˜æ•ˆå’Œå¿«é€Ÿçš„å‘½ä»¤è¡Œç•Œé¢ï¼Œæ„å»ºç³»ç»Ÿè„šæœ¬ï¼Œæˆ–ä¼˜åŒ–ç°æœ‰å·¥å…·çš„æ€§èƒ½ã€‚</p><p>åœ¨ç¼–è¯‘å™¨å’Œè¯­è¨€å¼€å‘ä¸­ï¼ŒZigä»¥å…¶å…ƒç¼–ç¨‹èƒ½åŠ›å’Œå¯¹ç®€æ˜“æ€§çš„è¿½æ±‚è€Œé—»åã€‚æ¯”è¾ƒè‘—åçš„å¼€æºé¡¹ç›®æ˜¯Bunï¼Œå…¶æ˜¯ä¸€ä¸ªä½¿ç”¨Zigå¼€å‘çš„JavaScriptè¿è¡Œæ—¶ã€‚</p><p>ä¸Rustä¸€æ ·ï¼ŒZigä¹Ÿæœ‰ä¸€äº›æ›´ä¸ºä¸“ä¸šçš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>æ¸¸æˆå¼€å‘ï¼Œå› æ”¯æŒé«˜æ€§èƒ½æ¸¸æˆå¼•æ“ã€èƒ½å¤Ÿå®æ—¶æ¨¡æ‹Ÿ</li><li>åœ¨åµŒå…¥å¼ç³»ç»Ÿå’Œç‰©è”ç½‘ä¸­ï¼Œç”¨äºç¼–ç¨‹å¾®æ§åˆ¶å™¨ã€ä¼ æ„Ÿå™¨å’Œå…¶ä»–èµ„æºå—é™è®¾å¤‡</li><li>åœ¨å¯†ç åº”ç”¨ä¸­ï¼Œç”¨äºå®ç°åŠ å¯†ç®—æ³•ã€æ•°å­—ç­¾åã€å®‰å…¨é€šä¿¡åè®®å’Œå…¶ä»–å®‰å…¨æ•æ„Ÿç»„</li></ul><p>å°å°çš„Benchmark<a href="https://zserge.com/posts/better-c-benchmark/">A â€œBetter Câ€ Benchmark (zserge.com)</a></p><p>æˆ‘ä¸ºä»€ä¹ˆä¼šçœ‹ä¸Šé¢è¿™äº›è¯­è¨€çš„æ¯”è¾ƒ,ä¸»è¦åŸå› è¿˜æ˜¯:C++å¾ˆå¥½,ä½†æ²¡æœ‰å®Œå–„çš„å·¥å…·é“¾,å®ƒçš„æ ‡å‡†å§”å‘˜ä¼šä¹Ÿä¸ä¼šç®¡è¿™äº›,è€Œä¸€äº›å¤§å‚ä¹Ÿæ²¡æœ‰å¼€æºä¸€äº›å·¥å…·ä½¿ç”¨ï¼›</p><p>Goçš„ç”Ÿæ€ä½è·ŸC/C++å’ŒRustè¿™ç±»è¯­è¨€è¿˜ä¸ä¸€æ ·åè€…çš„ä¸€äº›ä¸œè¥¿ä¸ä¼šæ‹¿Goæ¥é‡æ„;Rustçš„ä¸Šæ‰‹é—¨æ§›é«˜,ä½†ç›®å‰çœ‹æ¥æ˜¯æœ€å¯è¡Œçš„C/C++åœ¨ç³»ç»Ÿç¼–ç¨‹ã€å·¥å…·é“¾é‡æ„ç”šè‡³äºä¸€äº›ä¸šåŠ¡å¤„ç†ä¸Šçš„å¯è¡Œå·¥å…·.</p><p>è€ŒZigè¿˜è¿œè¿œæ²¡æœ‰å®Œå–„,ä½†ä¸Šæ‰‹é—¨æ§›ç›¸å¯¹æ›´ä½,ä½†åº”è¯¥è¿˜æ˜¯éœ€è¦æ²‰æ·€,æ›´ä½•å†µcè¯­è¨€å³ä½¿åˆ°ä»Šå¤©ä¹Ÿåœ¨æ›´æ–°,ç”Ÿæ€è¿˜æ˜¯åœ¨çš„.</p><h2 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h2><p>ä¹‹å‰ä¸€æ®µæ—¶é—´æœ‰ä¸ªå«Mojoçš„ç¼–ç¨‹è¯­è¨€ä¸æ–­åœ¨å®£ä¼ è‡ªå·±çš„åœ¨AIé¢†åŸŸç¼–ç¨‹çš„åœ°ä½:æ¯”Cå’ŒPythonæ€§èƒ½æ›´å¥½.<a href="https://www.modular.com/max/mojo">Mojo ğŸ”¥: Programming language for all of AI (modular.com)</a></p><p>ç›®å‰è¿˜åœ¨å¹æ°´å»ºè®¾é˜¶æ®µ,çœ‹åç»­è¡¨ç°(å…¶å®å¤§ä¼—çœ‹çš„æ˜¯æœ‰æ²¡æœ‰ç›¸å…³å¤§å‚è¿›å±€).</p><p>æˆ‘å¸¸å¸¸ä¼šå…³æ³¨ä¸€äº›æœ¬èº«æ¯”è¾ƒè€ä½†ä½¿ç”¨å¹¶ä¸å°‘çš„ç¼–ç¨‹è¯­è¨€,å› ä¸ºè¿™ç±»ç¼–ç¨‹è¯­è¨€æœ‰è‡ªå·±çš„ç”Ÿæ€ä½,æ–‡æ¡£å¯èƒ½ä¸ç®—æ–°,å®˜æ–¹ç½‘ç«™ä¹Ÿå¾€å¾€çœ‹èµ·æ¥å¾ˆè€,ç”Ÿæ€ä¸Šä¹Ÿæ²¡æœ‰å¾ˆå¤§çš„æŒç»­å‘åŠ›ç‚¹,ä½†æ˜¯æˆ‘è¿˜æ˜¯ä¼šæ—¶ä¸æ—¶çœ‹çœ‹,æ¯•ç«Ÿå…¶ä¸­å¾ˆå¤šå¯èƒ½ä¹Ÿä¼šç”¨ä¸Š.</p><h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><p>ä¹‹å‰çš„æ–‡ç« æˆ‘ä¹Ÿæåˆ°è¿‡,phpç”Ÿæ€ä½å°±æ˜¯web,ä¹Ÿæ˜¯ä¸ºwebè€Œç”Ÿ.ä½ ç”šè‡³ä¸éœ€è¦ç‰¹æ„ä½¿ç”¨æŸäº›webæ¡†æ¶æ¥åˆ›å»ºåº”ç”¨,å®ƒæœ¬èº«å°±æ”¯æŒå¾ˆå¤šæ“ä½œ.ä½†æ˜¯phpæœ¬èº«æœ‰äº›è¯­æ³•è¿˜éœ€è¦é€‚åº”(å¾ˆå¤šäººè¯´è¯­æ³•ä¸‘é™‹).è€Œå®ƒçš„webæ¡†æ¶ä¹Ÿç‰¹åˆ«å¤š,ä»ç›¸å¯¹è½»é‡ThinkPHPã€Symfonyåˆ°é‡å‹çš„Laravel,éƒ½å¯ä»¥è¯•è¯•.Swooleæ¡†æ¶ä¹Ÿä½¿å¾—ä»Webåˆ° TCPã€UDPã€Socketä¸Š</p><p>è¿˜æœ‰ç›¸æ¯”swooleæ›´æ˜“å­¦ä¹ çš„workerman,workerman æ˜¯çº¯phpå†™çš„ç½‘ç»œæ¡†æ¶.æ”¯æŒTCPé•¿è¿æ¥ï¼Œæ”¯æŒWebsocketã€HTTPç­‰åè®®.ä»¥åŠåŸºäºworkermançš„webman,webmanç”¨äºæ›¿ä»£ä¼ ç»Ÿçš„php-fpmæ¶æ„ï¼Œæä¾›è¶…é«˜æ€§èƒ½å¯æ‰©å±•çš„HTTPæœåŠ¡ã€‚ä½ å¯ä»¥ç”¨webmanå¼€å‘ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥å¼€å‘HTTPæ¥å£æˆ–è€…å¾®æœåŠ¡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$numbers</span> = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The first number is: &quot;</span> . <span class="variable">$numbers</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The length of the array is: &quot;</span> . count(<span class="variable">$numbers</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$person</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span> =&gt; <span class="number">30</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Name: &quot;</span> . <span class="variable">$person</span>[<span class="string">&quot;name&quot;</span>] . <span class="string">&quot;, Age: &quot;</span> . <span class="variable">$person</span>[<span class="string">&quot;age&quot;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">greet</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hello, my name is &quot;</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">&quot; and I&#x27;m &quot;</span> . <span class="keyword">$this</span>-&gt;age . <span class="string">&quot; years old.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$alice</span> = <span class="keyword">new</span> Person(<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>);</span><br><span class="line"><span class="variable">$alice</span>-&gt;greet(); <span class="comment">// è¾“å‡º &quot;Hello, my name is Alice and I&#x27;m 30 years old.&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">divide</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$b</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="string">&quot;Division by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$a</span> / <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$result</span> = divide(<span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$greet</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Hello, <span class="subst">$name</span>!&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$greet</span>(<span class="string">&quot;Alice&quot;</span>); <span class="comment">// è¾“å‡º &quot;Hello, Alice!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$numbers</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable">$doubledNumbers</span> = array_map(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$x</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$x</span> * <span class="number">2</span>;</span><br><span class="line">&#125;, <span class="variable">$numbers</span>);</span><br><span class="line"></span><br><span class="line">print_r(<span class="variable">$doubledNumbers</span>); <span class="comment">// è¾“å‡º [2, 4, 6, 8, 10]</span></span><br></pre></td></tr></table></figure><p><strong>æ¨èå­¦ä¹ </strong>:</p><ul><li><a href="https://docs.golaravel.com/">Laravel - ä¸º WEB è‰ºæœ¯å®¶åˆ›é€ çš„ PHP æ¡†æ¶ã€‚ (golaravel.com)</a></li><li><a href="https://symfony.com/">Symfony, High Performance PHP Framework for Web Development</a></li><li><a href="https://www.workerman.net/">é«˜æ€§èƒ½PHPåº”ç”¨å®¹å™¨ workerman</a></li><li><a href="https://www.workerman.net/doc/webman/README.html">webman æ‰‹å†Œ (workerman.net)</a></li></ul><h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>ä¹Ÿæ˜¯webç”Ÿæ€,æˆ–è€…è¯´åº”ä¸ºrailsè€ŒçŸ¥å.å›½å†…ç›¸å¯¹æ¥è¯´æ²¡é‚£ä¹ˆå¤šä½¿ç”¨rubyçš„.</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">puts <span class="string">&quot;The first number is: <span class="subst">#&#123;numbers[<span class="number">0</span>]&#125;</span>&quot;</span></span><br><span class="line">puts <span class="string">&quot;The length of the array is: <span class="subst">#&#123;numbers.length&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">person = &#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span> =&gt; <span class="number">30</span></span><br><span class="line">&#125;</span><br><span class="line">puts <span class="string">&quot;Name: <span class="subst">#&#123;person[<span class="string">&quot;name&quot;</span>]&#125;</span>, Age: <span class="subst">#&#123;person[<span class="string">&quot;age&quot;</span>]&#125;</span>&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:name</span>, <span class="symbol">:age</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(name, age)</span></span></span><br><span class="line">    <span class="variable">@name</span> = name</span><br><span class="line">    <span class="variable">@age</span> = age</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    puts <span class="string">&quot;Hello, my name is <span class="subst">#&#123;<span class="variable">@name</span>&#125;</span> and I&#x27;m <span class="subst">#&#123;<span class="variable">@age</span>&#125;</span> years old.&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Person å¯¹è±¡å¹¶è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">alice = Person.new(<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>)</span><br><span class="line">alice.greet <span class="comment"># è¾“å‡º &quot;Hello, my name is Alice and I&#x27;m 30 years old.&quot;</span></span><br></pre></td></tr></table></figure><p><strong>æ¨èå­¦ä¹ </strong>:</p><ul><li><a href="https://rubyonrails.org/">Ruby on Rails â€” A web-app framework that includes everything needed to create database-backed web applications according to the Model-View-Controller (MVC) pattern.</a></li></ul><h3 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h3><p>luaç”Ÿæ€ä½æ˜¯å†™ä¸€äº›æ¸¸æˆè„šæœ¬æˆ–è€…ä¸€äº›å·¥å…·çš„åŠŸèƒ½,æ¯”å¦‚neovimä¸­çš„ä¸€äº›æ’ä»¶å°±ä¼šä½¿ç”¨lua.å¦å¤–ä¸€äº›åµŒå…¥å¼è®¾å¤‡ä¹Ÿä¼šä½¿ç”¨,ä¸»è¦æ˜¯ä¸å…¶ä»–è¯­è¨€æ­é….è¿™é—¨è¯­è¨€æœ¬èº«éå¸¸å°,</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x = <span class="number">5</span></span><br><span class="line"><span class="keyword">local</span> y = <span class="number">10</span></span><br><span class="line"><span class="keyword">local</span> sum = x + y</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The sum of &quot;</span> .. x .. <span class="string">&quot; and &quot;</span> .. y .. <span class="string">&quot; is &quot;</span> .. sum)</span><br><span class="line"><span class="keyword">local</span> fruits = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;orange&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä½¿ç”¨forå¾ªç¯éå†</span></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>, #fruits <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(fruits[i])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä½¿ç”¨for-inå¾ªç¯éå†</span></span><br><span class="line"><span class="keyword">for</span> _, fruit <span class="keyword">in</span> <span class="built_in">ipairs</span>(fruits) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(fruit)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- å®šä¹‰ä¸€ä¸ªPersonç±»</span></span><br><span class="line"><span class="keyword">local</span> Person = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person:new</span><span class="params">(name, age)</span></span></span><br><span class="line">    <span class="keyword">local</span> obj = &#123;</span><br><span class="line">        name = name,</span><br><span class="line">        age = age</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(obj, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person:greet</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello, my name is &quot;</span> .. <span class="built_in">self</span>.name .. <span class="string">&quot; and I&#x27;m &quot;</span> .. <span class="built_in">self</span>.age .. <span class="string">&quot; years old.&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºPersonå¯¹è±¡å¹¶è°ƒç”¨æ–¹æ³•</span></span><br><span class="line"><span class="keyword">local</span> alice = Person:new(<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>)</span><br><span class="line">alice:greet()</span><br><span class="line"><span class="comment">-- å®šä¹‰ä¸€ä¸ªåç¨‹å‡½æ•°</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(i)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå¹¶æ§åˆ¶åç¨‹</span></span><br><span class="line"><span class="keyword">local</span> co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(count)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">5</span>)) <span class="comment">-- è¾“å‡º 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">-- è¾“å‡º 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">-- è¾“å‡º 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">-- è¾“å‡º 4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">-- è¾“å‡º 5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">-- è¾“å‡º nil</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å®šä¹‰ä¸€ä¸ªVector2Dç±»</span></span><br><span class="line"><span class="keyword">local</span> Vector2D = &#123;&#125;</span><br><span class="line">Vector2D.<span class="built_in">__index</span> = Vector2D</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vector2D:new</span><span class="params">(x, y)</span></span></span><br><span class="line">    <span class="keyword">local</span> obj = <span class="built_in">setmetatable</span>(&#123;x=x, y=y&#125;, Vector2D)</span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vector2D:add</span><span class="params">(other)</span></span></span><br><span class="line">    <span class="keyword">return</span> Vector2D:new(<span class="built_in">self</span>.x + other.x, <span class="built_in">self</span>.y + other.y)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vector2D:__tostring</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;(&quot;</span> .. <span class="built_in">self</span>.x .. <span class="string">&quot;, &quot;</span> .. <span class="built_in">self</span>.y .. <span class="string">&quot;)&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå’Œæ“ä½œVector2Då¯¹è±¡</span></span><br><span class="line"><span class="keyword">local</span> v1 = Vector2D:new(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">local</span> v2 = Vector2D:new(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">local</span> v3 = v1:add(v2)</span><br><span class="line"><span class="built_in">print</span>(v3) <span class="comment">-- è¾“å‡º (4, 6)</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://www.lua.org/">The Programming Language Lua</a></li></ul><h3 id="ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿"><a href="#ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿" class="headerlink" title="ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿"></a>ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿</h3><p>[<a href="https://www.codementor.io/blog/worst-languages-to-learn-3phycr98zk">Worst Programming Languages to Learn in 2018 (codementor.io)</a>è¿™ç¯‡æ–‡ç« åœ¨2018å¹´ç»™å‡ºäº†åœ¨å·¥ä½œä¸Šä¸æ¨èç¢°çš„è¯­è¨€,å…¶ä¸­åŒ…æ‹¬Dart,Rust,Ruby,Goç­‰,äº‹å®ä¸Šä»å·¥ä½œçš„è§’åº¦æ¥çœ‹,ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€å’Œé—¨æ§›è¾ƒé«˜çš„è¯­è¨€ä¸Šæ¦œå¾ˆæ­£å¸¸,ä½†æ˜¯å¦å¤–æœ‰äº›æ›´å¯èƒ½æ˜¯å› ä¸ºç”Ÿæ€è¿˜ä¸å¤Ÿå¤§,ä½†æœ¬èº«æ˜¯åšåº”ç”¨çš„,æ¯”å¦‚Dartå’ŒGo,æ‰€ä»¥è¿˜éœ€è¦å®˜ç½‘.</p><p>è¿™ä»½æ¦œå•æ¯”è¾ƒæ¿€è¿›,ä½†æ€»ä½“è¿˜æ˜¯å¾ˆæœ‰è¶£çš„.åƒå‡½æ•°æ—¶è¯­è¨€Clojureå’ŒElixirå°±ç›¸æ¯”æ›´è€çš„Haskellå’ŒErlangå°±æ›´å¥½.</p><p>åœ¨2019å¹´<a href="https://www.codementor.io/blog/worst-languages-2019-6mvbfg3w9x">Study of Programming Languages Not to Learn in 2019 (codementor.io)</a></p><p>è¿™ä»½æ¦œå•å˜å¾—æ›´ç¬¦åˆæˆ‘çš„çŸ¥è§‰äº†,å½“ç„¶è¿™äº›ä¸œè¥¿åªæ˜¯çœ‹çœ‹è€Œå·²,æ¯”å¦‚ä¸‹é¢çš„äººå°±è¯´è‡ªå·±æ‹¿CoffeeScriptå†™åº”ç”¨åˆ°AppStoreä¸Šèµšäº†å¾ˆå¤šé’±,æ‰€ä»¥,è¿˜æ˜¯è¦çœ‹ç”Ÿæ€ä½.</p><p><img data-src="https://s2.loli.net/2024/06/23/OM87TjbGsdWXl4E.png" alt="image-20240623122150477"></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Cè¯­è¨€è¯ç”Ÿå·²ç»äº”åå¤šå¹´äº†,ç°åœ¨å·²ç»æœ‰äº†è®¸å¤šé«˜çº§è¯­è¨€,å…¶ä¸­å¾ˆå¤šèƒŒé å¤§å‚,æ¯”å¦‚Java,Go,C#,Dart,Swiftç­‰ç­‰(ç”²éª¨æ–‡,è°·æ­Œå¾®è½¯å’Œè‹¹æœ,è¿™ç±»è¯­è¨€é€šè¿‡å…¬å¸æ›´æ–°).ä¹Ÿæœ‰å¾ˆå¤šç¤¾åŒºçš„è¯­è¨€,æ¯”å¦‚Python,Rust,PHP,Rubyç­‰(è¿™ç±»è¯­è¨€å¾€å¾€é€šè¿‡æ—©æœŸåˆ›å»ºè€…å’Œä¸€äº›æ ¸å¿ƒæˆå‘˜æ›´æ–°å’Œç»´æŠ¤,è¿™é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šå¼€æºçš„è¯­è¨€,å…è®¸å…¶ä»–äººä¿®æ”¹).&lt;br&gt;ç›¸è¾ƒäºå…¬å¸æ——ä¸‹çš„è¯­è¨€,ç¤¾åŒºç±»å‹çš„è¯­è¨€å¾€å¾€æ›´åŠ ç®€æ´,åœ¨ä½¿ç”¨æˆ–è€…ç”Ÿäº§ä¸‹æ•ˆç‡é«˜,ä½†ä¹Ÿå­˜åœ¨ç”Ÿæ€ç›¸å¯¹è¾ƒå·®ã€å·¥å…·é“¾ä¸å¤Ÿã€æ›´æ–°å‘åŠ›ä¸å¤ŸæŒä¹…ã€æ–‡æ¡£ä¸å¤Ÿä¸°å¯Œçš„é—®é¢˜.&lt;/p&gt;
&lt;p&gt;è€Œ A better Cçš„æ„æ€å°±æ˜¯åœ¨åé¢çš„è¯­è¨€ä¸­æ‰¾åˆ°æ€§èƒ½è¾ƒå¼º,ä½¿ç”¨å‹å¥½å¹¶ä¸”ç”Ÿæ€æŒç»­å‘å±•çš„è¯­è¨€.TLDR:åœ¨å¤§å‹é¡¹ç›®ä¸Šè¿˜æ˜¯ä½¿ç”¨C++,åœ¨ä¸€äº›å·¥å…·é“¾æˆ–è€…ä»£ç é‡æ„ä¸Šå¯ä»¥è€ƒè™‘Rust. &lt;/p&gt;</summary>
    
    
    
    
    <category term="programming language" scheme="https://www.sekyoro.top/tags/programming-language/"/>
    
  </entry>
  
  <entry>
    <title>ä»è®ºæ–‡ä¸­çœ‹AIç»˜ç”»(äºŒ)</title>
    <link href="https://www.sekyoro.top/2024/06/18/%E4%BB%8E%E8%AE%BA%E6%96%87%E4%B8%AD%E7%9C%8BAI%E7%BB%98%E7%94%BB-%E4%BA%8C/"/>
    <id>https://www.sekyoro.top/2024/06/18/%E4%BB%8E%E8%AE%BA%E6%96%87%E4%B8%AD%E7%9C%8BAI%E7%BB%98%E7%94%BB-%E4%BA%8C/</id>
    <published>2024-06-18T08:33:38.000Z</published>
    <updated>2024-06-18T08:36:29.095Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æ¥ç€ä¸Šä¸€ç¯‡ ä»è®ºæ–‡ä¸­çœ‹AIç»˜ç”»(ä¸€)å†™,ä¸»è¦å…³æ³¨animationç”šè‡³videoçº§åˆ«çš„ç”Ÿæˆäº†.</p><span id="more"></span><h2 id="Animate-Anyone-Consistent-and-Controllable-Image-to-Video-Synthesis-for-Character-Animation"><a href="#Animate-Anyone-Consistent-and-Controllable-Image-to-Video-Synthesis-for-Character-Animation" class="headerlink" title="Animate Anyone: Consistent and Controllable Image-to-Video Synthesis for Character Animation"></a>Animate Anyone: Consistent and Controllable Image-to-Video Synthesis for Character Animation</h2><p>TODO:</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¥ç€ä¸Šä¸€ç¯‡ ä»è®ºæ–‡ä¸­çœ‹AIç»˜ç”»(ä¸€)å†™,ä¸»è¦å…³æ³¨animationç”šè‡³videoçº§åˆ«çš„ç”Ÿæˆäº†.&lt;/p&gt;</summary>
    
    
    
    
    <category term="deep learning" scheme="https://www.sekyoro.top/tags/deep-learning/"/>
    
    <category term="generative ai" scheme="https://www.sekyoro.top/tags/generative-ai/"/>
    
  </entry>
  
  <entry>
    <title>myJourneyToAI:æ·±åº¦å­¦ä¹ ä¹‹æ—…</title>
    <link href="https://www.sekyoro.top/2024/06/12/myJourneyToAI-%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%85/"/>
    <id>https://www.sekyoro.top/2024/06/12/myJourneyToAI-%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%85/</id>
    <published>2024-06-12T11:32:09.000Z</published>
    <updated>2024-06-25T03:12:11.169Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>æ€»ç»“ä¸€ä¸‹å­¦ä¹ äººå·¥æ™ºèƒ½/æ·±åº¦å­¦ä¹ è¿‡ç¨‹ä¸­ä¸ªäººè§‰å¾—é‡è¦çš„æ–¹æ³•å’Œç»éªŒ. </p><p>ä¸»è¦å…³äºæ¨¡å‹.<br><span id="more"></span></p><h1 id="è›®è’æ—¶ä»£"><a href="#è›®è’æ—¶ä»£" class="headerlink" title="è›®è’æ—¶ä»£"></a>è›®è’æ—¶ä»£</h1><blockquote><p>å¤§çº¦2010å¹´å¼€å§‹ï¼Œé‚£äº›åœ¨è®¡ç®—ä¸Šçœ‹èµ·æ¥ä¸å¯è¡Œçš„ç¥ç»ç½‘ç»œç®—æ³•å˜å¾—çƒ­é—¨èµ·æ¥ï¼Œå®é™…ä¸Šæ˜¯ä»¥ä¸‹ä¸¤ç‚¹å¯¼è‡´çš„ï¼š å…¶ä¸€ï¼Œéšç€äº’è”ç½‘çš„å…¬å¸çš„å‡ºç°ï¼Œä¸ºæ•°äº¿åœ¨çº¿ç”¨æˆ·æä¾›æœåŠ¡ï¼Œå¤§è§„æ¨¡æ•°æ®é›†å˜å¾—è§¦æ‰‹å¯åŠï¼› å¦å¤–ï¼Œå»‰ä»·åˆé«˜è´¨é‡çš„ä¼ æ„Ÿå™¨ã€å»‰ä»·çš„æ•°æ®å­˜å‚¨ï¼ˆå…‹è±å¾·å®šå¾‹ï¼‰ä»¥åŠå»‰ä»·è®¡ç®—ï¼ˆæ‘©å°”å®šå¾‹ï¼‰çš„æ™®åŠï¼Œç‰¹åˆ«æ˜¯GPUçš„æ™®åŠï¼Œä½¿å¤§è§„æ¨¡ç®—åŠ›å”¾æ‰‹å¯å¾—ã€‚</p></blockquote><h2 id="ç»å…¸CNNæ¨¡å‹"><a href="#ç»å…¸CNNæ¨¡å‹" class="headerlink" title="ç»å…¸CNNæ¨¡å‹"></a>ç»å…¸CNNæ¨¡å‹</h2><h3 id="LeNet"><a href="#LeNet" class="headerlink" title="LeNet"></a>LeNet</h3><p><img data-src="https://zh.d2l.ai/_images/lenet.svg" alt="../_images/lenet.svg">æ¯ä¸ªå·ç§¯å—ä¸­çš„åŸºæœ¬å•å…ƒæ˜¯ä¸€ä¸ªå·ç§¯å±‚ã€ä¸€ä¸ªsigmoidæ¿€æ´»å‡½æ•°å’Œå¹³å‡æ±‡èšå±‚ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶ReLUå’Œæœ€å¤§æ±‡èšå±‚æ›´æœ‰æ•ˆï¼Œä½†å®ƒä»¬åœ¨20ä¸–çºª90å¹´ä»£è¿˜æ²¡æœ‰å‡ºç°ã€‚æ¯ä¸ªå·ç§¯å±‚ä½¿ç”¨5Ã—5å·ç§¯æ ¸å’Œä¸€ä¸ªsigmoidæ¿€æ´»å‡½æ•°ã€‚è¿™äº›å±‚å°†è¾“å…¥æ˜ å°„åˆ°å¤šä¸ªäºŒç»´ç‰¹å¾è¾“å‡ºï¼Œé€šå¸¸åŒæ—¶å¢åŠ é€šé“çš„æ•°é‡ã€‚ç¬¬ä¸€å·ç§¯å±‚æœ‰6ä¸ªè¾“å‡ºé€šé“ï¼Œè€Œç¬¬äºŒä¸ªå·ç§¯å±‚æœ‰16ä¸ªè¾“å‡ºé€šé“ã€‚æ¯ä¸ª2Ã—2æ± æ“ä½œï¼ˆæ­¥å¹…2ï¼‰é€šè¿‡ç©ºé—´ä¸‹é‡‡æ ·å°†ç»´æ•°å‡å°‘4å€ã€‚å·ç§¯çš„è¾“å‡ºå½¢çŠ¶ç”±æ‰¹é‡å¤§å°ã€é€šé“æ•°ã€é«˜åº¦ã€å®½åº¦å†³å®šã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"></span><br><span class="line">net = nn.Sequential(</span><br><span class="line">    nn.Conv2d(<span class="number">1</span>, <span class="number">6</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>), nn.Sigmoid(),</span><br><span class="line">    nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, kernel_size=<span class="number">5</span>), nn.Sigmoid(),</span><br><span class="line">    nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nn.Flatten(),</span><br><span class="line">    nn.Linear(<span class="number">16</span> * <span class="number">5</span> * <span class="number">5</span>, <span class="number">120</span>), nn.Sigmoid(),</span><br><span class="line">    nn.Linear(<span class="number">120</span>, <span class="number">84</span>), nn.Sigmoid(),</span><br><span class="line">    nn.Linear(<span class="number">84</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure><p><img data-src="https://zh.d2l.ai/_images/lenet-vert.svg" alt="../_images/lenet-vert.svg"></p><h3 id="AlexNet"><a href="#AlexNet" class="headerlink" title="AlexNet"></a>AlexNet</h3><p><img data-src="https://zh.d2l.ai/_images/alexnet.svg" alt="../_images/alexnet.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"></span><br><span class="line">net = nn.Sequential(</span><br><span class="line">    <span class="comment"># è¿™é‡Œä½¿ç”¨ä¸€ä¸ª11*11çš„æ›´å¤§çª—å£æ¥æ•æ‰å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment"># åŒæ—¶ï¼Œæ­¥å¹…ä¸º4ï¼Œä»¥å‡å°‘è¾“å‡ºçš„é«˜åº¦å’Œå®½åº¦ã€‚</span></span><br><span class="line">    <span class="comment"># å¦å¤–ï¼Œè¾“å‡ºé€šé“çš„æ•°ç›®è¿œå¤§äºLeNet</span></span><br><span class="line">    nn.Conv2d(<span class="number">1</span>, <span class="number">96</span>, kernel_size=<span class="number">11</span>, stride=<span class="number">4</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">    nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    <span class="comment"># å‡å°å·ç§¯çª—å£ï¼Œä½¿ç”¨å¡«å……ä¸º2æ¥ä½¿å¾—è¾“å…¥ä¸è¾“å‡ºçš„é«˜å’Œå®½ä¸€è‡´ï¼Œä¸”å¢å¤§è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">    nn.Conv2d(<span class="number">96</span>, <span class="number">256</span>, kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>), nn.ReLU(),</span><br><span class="line">    nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ä¸‰ä¸ªè¿ç»­çš„å·ç§¯å±‚å’Œè¾ƒå°çš„å·ç§¯çª—å£ã€‚</span></span><br><span class="line">    <span class="comment"># é™¤äº†æœ€åçš„å·ç§¯å±‚ï¼Œè¾“å‡ºé€šé“çš„æ•°é‡è¿›ä¸€æ­¥å¢åŠ ã€‚</span></span><br><span class="line">    <span class="comment"># åœ¨å‰ä¸¤ä¸ªå·ç§¯å±‚ä¹‹åï¼Œæ±‡èšå±‚ä¸ç”¨äºå‡å°‘è¾“å…¥çš„é«˜åº¦å’Œå®½åº¦</span></span><br><span class="line">    nn.Conv2d(<span class="number">256</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">    nn.Conv2d(<span class="number">384</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">    nn.Conv2d(<span class="number">384</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">    nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nn.Flatten(),</span><br><span class="line">    <span class="comment"># è¿™é‡Œï¼Œå…¨è¿æ¥å±‚çš„è¾“å‡ºæ•°é‡æ˜¯LeNetä¸­çš„å¥½å‡ å€ã€‚ä½¿ç”¨dropoutå±‚æ¥å‡è½»è¿‡æ‹Ÿåˆ</span></span><br><span class="line">    nn.Linear(<span class="number">6400</span>, <span class="number">4096</span>), nn.ReLU(),</span><br><span class="line">    nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">    nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>), nn.ReLU(),</span><br><span class="line">    nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">    <span class="comment"># æœ€åæ˜¯è¾“å‡ºå±‚ã€‚ç”±äºè¿™é‡Œä½¿ç”¨Fashion-MNISTï¼Œæ‰€ä»¥ç”¨ç±»åˆ«æ•°ä¸º10ï¼Œè€Œéè®ºæ–‡ä¸­çš„1000</span></span><br><span class="line">    nn.Linear(<span class="number">4096</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure><h3 id="VGG"><a href="#VGG" class="headerlink" title="VGG"></a>VGG</h3><p><img data-src="https://guandi1995.github.io/images/classical_cnn/vgg-16-simplified.PNG" alt="img"></p><p><img data-src="https://zh.d2l.ai/_images/vgg.svg" alt="../_images/vgg.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vgg</span>(<span class="params">conv_arch</span>):</span></span><br><span class="line">    conv_blks = []</span><br><span class="line">    in_channels = <span class="number">1</span></span><br><span class="line">    <span class="comment"># å·ç§¯å±‚éƒ¨åˆ†</span></span><br><span class="line">    <span class="keyword">for</span> (num_convs, out_channels) <span class="keyword">in</span> conv_arch:</span><br><span class="line">        conv_blks.append(vgg_block(num_convs, in_channels, out_channels))</span><br><span class="line">        in_channels = out_channels</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        *conv_blks, nn.Flatten(),</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚éƒ¨åˆ†</span></span><br><span class="line">        nn.Linear(out_channels * <span class="number">7</span> * <span class="number">7</span>, <span class="number">4096</span>), nn.ReLU(), nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line">        nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>), nn.ReLU(), nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line">        nn.Linear(<span class="number">4096</span>, <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">net = vgg(conv_arch)</span><br></pre></td></tr></table></figure><h3 id="NiN"><a href="#NiN" class="headerlink" title="NiN"></a>NiN</h3><p><img data-src="https://zh.d2l.ai/_images/nin.svg" alt="../_images/nin.svg" style="zoom:50%;" /></p><p>NiNå’ŒAlexNetä¹‹é—´çš„ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«æ˜¯NiNå®Œå…¨å–æ¶ˆäº†å…¨è¿æ¥å±‚ã€‚ ç›¸åï¼ŒNiNä½¿ç”¨ä¸€ä¸ªNiNå—ï¼Œå…¶è¾“å‡ºé€šé“æ•°ç­‰äºæ ‡ç­¾ç±»åˆ«çš„æ•°é‡ã€‚æœ€åæ”¾ä¸€ä¸ª<em>å…¨å±€å¹³å‡æ±‡èšå±‚</em>ï¼ˆglobal average pooling layerï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹æ•°å‡ ç‡ ï¼ˆlogitsï¼‰ã€‚NiNè®¾è®¡çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œå®ƒæ˜¾è‘—å‡å°‘äº†æ¨¡å‹æ‰€éœ€å‚æ•°çš„æ•°é‡ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œè¿™ç§è®¾è®¡æœ‰æ—¶ä¼šå¢åŠ è®­ç»ƒæ¨¡å‹çš„æ—¶é—´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nin_block</span>(<span class="params">in_channels, out_channels, kernel_size, strides, padding</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_channels, out_channels, kernel_size, strides, padding),</span><br><span class="line">        nn.ReLU(),</span><br><span class="line">        nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">        nn.Conv2d(out_channels, out_channels, kernel_size=<span class="number">1</span>), nn.ReLU())</span><br><span class="line">net = nn.Sequential(</span><br><span class="line">    nin_block(<span class="number">1</span>, <span class="number">96</span>, kernel_size=<span class="number">11</span>, strides=<span class="number">4</span>, padding=<span class="number">0</span>),</span><br><span class="line">    nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nin_block(<span class="number">96</span>, <span class="number">256</span>, kernel_size=<span class="number">5</span>, strides=<span class="number">1</span>, padding=<span class="number">2</span>),</span><br><span class="line">    nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nin_block(<span class="number">256</span>, <span class="number">384</span>, kernel_size=<span class="number">3</span>, strides=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">    nn.MaxPool2d(<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">    nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line">    <span class="comment"># æ ‡ç­¾ç±»åˆ«æ•°æ˜¯10</span></span><br><span class="line">    nin_block(<span class="number">384</span>, <span class="number">10</span>, kernel_size=<span class="number">3</span>, strides=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">    nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>)),</span><br><span class="line">    <span class="comment"># å°†å››ç»´çš„è¾“å‡ºè½¬æˆäºŒç»´çš„è¾“å‡ºï¼Œå…¶å½¢çŠ¶ä¸º(æ‰¹é‡å¤§å°,10)</span></span><br><span class="line">    nn.Flatten())</span><br></pre></td></tr></table></figure><h3 id="GoogleNet"><a href="#GoogleNet" class="headerlink" title="GoogleNet"></a>GoogleNet</h3><p><img data-src="https://zh.d2l.ai/_images/inception.svg" alt="../_images/inception.svg"></p><p>åœ¨GoogLeNetä¸­ï¼ŒåŸºæœ¬çš„å·ç§¯å—è¢«ç§°ä¸º<em>Inceptionå—</em>ï¼ˆInception blockï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Inception</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="comment"># c1--c4æ˜¯æ¯æ¡è·¯å¾„çš„è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, c1, c2, c3, c4, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Inception, self).__init__(**kwargs)</span><br><span class="line">        <span class="comment"># çº¿è·¯1ï¼Œå•1x1å·ç§¯å±‚</span></span><br><span class="line">        self.p1_1 = nn.Conv2d(in_channels, c1, kernel_size=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># çº¿è·¯2ï¼Œ1x1å·ç§¯å±‚åæ¥3x3å·ç§¯å±‚</span></span><br><span class="line">        self.p2_1 = nn.Conv2d(in_channels, c2[<span class="number">0</span>], kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.p2_2 = nn.Conv2d(c2[<span class="number">0</span>], c2[<span class="number">1</span>], kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># çº¿è·¯3ï¼Œ1x1å·ç§¯å±‚åæ¥5x5å·ç§¯å±‚</span></span><br><span class="line">        self.p3_1 = nn.Conv2d(in_channels, c3[<span class="number">0</span>], kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.p3_2 = nn.Conv2d(c3[<span class="number">0</span>], c3[<span class="number">1</span>], kernel_size=<span class="number">5</span>, padding=<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># çº¿è·¯4ï¼Œ3x3æœ€å¤§æ±‡èšå±‚åæ¥1x1å·ç§¯å±‚</span></span><br><span class="line">        self.p4_1 = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.p4_2 = nn.Conv2d(in_channels, c4, kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        p1 = F.relu(self.p1_1(x))</span><br><span class="line">        p2 = F.relu(self.p2_2(F.relu(self.p2_1(x))))</span><br><span class="line">        p3 = F.relu(self.p3_2(F.relu(self.p3_1(x))))</span><br><span class="line">        p4 = F.relu(self.p4_2(self.p4_1(x)))</span><br><span class="line">        <span class="comment"># åœ¨é€šé“ç»´åº¦ä¸Šè¿ç»“è¾“å‡º</span></span><br><span class="line">        <span class="keyword">return</span> torch.cat((p1, p2, p3, p4), dim=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img data-src="https://zh.d2l.ai/_images/inception-full.svg" alt="../_images/inception-full.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">b1 = nn.Sequential(nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>),</span><br><span class="line">                   nn.ReLU(),</span><br><span class="line">                   nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))</span><br><span class="line">b2 = nn.Sequential(nn.Conv2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">1</span>),</span><br><span class="line">                   nn.ReLU(),</span><br><span class="line">                   nn.Conv2d(<span class="number">64</span>, <span class="number">192</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">                   nn.ReLU(),</span><br><span class="line">                   nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))    </span><br><span class="line">b3 = nn.Sequential(Inception(<span class="number">192</span>, <span class="number">64</span>, (<span class="number">96</span>, <span class="number">128</span>), (<span class="number">16</span>, <span class="number">32</span>), <span class="number">32</span>),</span><br><span class="line">                   Inception(<span class="number">256</span>, <span class="number">128</span>, (<span class="number">128</span>, <span class="number">192</span>), (<span class="number">32</span>, <span class="number">96</span>), <span class="number">64</span>),</span><br><span class="line">                   nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))                </span><br><span class="line">b4 = nn.Sequential(Inception(<span class="number">480</span>, <span class="number">192</span>, (<span class="number">96</span>, <span class="number">208</span>), (<span class="number">16</span>, <span class="number">48</span>), <span class="number">64</span>),</span><br><span class="line">                   Inception(<span class="number">512</span>, <span class="number">160</span>, (<span class="number">112</span>, <span class="number">224</span>), (<span class="number">24</span>, <span class="number">64</span>), <span class="number">64</span>),</span><br><span class="line">                   Inception(<span class="number">512</span>, <span class="number">128</span>, (<span class="number">128</span>, <span class="number">256</span>), (<span class="number">24</span>, <span class="number">64</span>), <span class="number">64</span>),</span><br><span class="line">                   Inception(<span class="number">512</span>, <span class="number">112</span>, (<span class="number">144</span>, <span class="number">288</span>), (<span class="number">32</span>, <span class="number">64</span>), <span class="number">64</span>),</span><br><span class="line">                   Inception(<span class="number">528</span>, <span class="number">256</span>, (<span class="number">160</span>, <span class="number">320</span>), (<span class="number">32</span>, <span class="number">128</span>), <span class="number">128</span>),</span><br><span class="line">                   nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))           </span><br><span class="line">b5 = nn.Sequential(Inception(<span class="number">832</span>, <span class="number">256</span>, (<span class="number">160</span>, <span class="number">320</span>), (<span class="number">32</span>, <span class="number">128</span>), <span class="number">128</span>),</span><br><span class="line">                   Inception(<span class="number">832</span>, <span class="number">384</span>, (<span class="number">192</span>, <span class="number">384</span>), (<span class="number">48</span>, <span class="number">128</span>), <span class="number">128</span>),</span><br><span class="line">                   nn.AdaptiveAvgPool2d((<span class="number">1</span>,<span class="number">1</span>)),</span><br><span class="line">                   nn.Flatten())</span><br><span class="line"></span><br><span class="line">net = nn.Sequential(b1, b2, b3, b4, b5, nn.Linear(<span class="number">1024</span>, <span class="number">10</span>))            X = torch.rand(size=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">96</span>))</span><br><span class="line"><span class="keyword">for</span> layer <span class="keyword">in</span> net:</span><br><span class="line">    X = layer(X)</span><br><span class="line">    <span class="built_in">print</span>(layer.__class__.__name__,<span class="string">&#x27;output shape:\t&#x27;</span>, X.shape)</span><br></pre></td></tr></table></figure><h3 id="ResNet"><a href="#ResNet" class="headerlink" title="ResNet"></a>ResNet</h3><p><img data-src="https://zh.d2l.ai/_images/residual-block.svg" alt="../_images/residual-block.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Residual</span>(<span class="params">nn.Module</span>):</span>  <span class="comment">#@save</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, input_channels, num_channels,</span></span></span><br><span class="line"><span class="params"><span class="function">                 use_1x1conv=<span class="literal">False</span>, strides=<span class="number">1</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(input_channels, num_channels,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, stride=strides)</span><br><span class="line">        self.conv2 = nn.Conv2d(num_channels, num_channels,</span><br><span class="line">                               kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> use_1x1conv:</span><br><span class="line">            self.conv3 = nn.Conv2d(input_channels, num_channels,</span><br><span class="line">                                   kernel_size=<span class="number">1</span>, stride=strides)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.conv3 = <span class="literal">None</span></span><br><span class="line">        self.bn1 = nn.BatchNorm2d(num_channels)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(num_channels)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, X</span>):</span></span><br><span class="line">        Y = F.relu(self.bn1(self.conv1(X)))</span><br><span class="line">        Y = self.bn2(self.conv2(Y))</span><br><span class="line">        <span class="keyword">if</span> self.conv3:</span><br><span class="line">            X = self.conv3(X)</span><br><span class="line">        Y += X</span><br><span class="line">        <span class="keyword">return</span> F.relu(Y)</span><br></pre></td></tr></table></figure><p><img data-src="https://zh.d2l.ai/_images/resnet-block.svg" alt="../_images/resnet-block.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">b1 = nn.Sequential(nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>),</span><br><span class="line">                   nn.BatchNorm2d(<span class="number">64</span>), nn.ReLU(),</span><br><span class="line">                   nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet_block</span>(<span class="params">input_channels, num_channels, num_residuals,</span></span></span><br><span class="line"><span class="params"><span class="function">                 first_block=<span class="literal">False</span></span>):</span></span><br><span class="line">    blk = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_residuals):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> first_block:</span><br><span class="line">            blk.append(Residual(input_channels, num_channels,</span><br><span class="line">                                use_1x1conv=<span class="literal">True</span>, strides=<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            blk.append(Residual(num_channels, num_channels))</span><br><span class="line">    <span class="keyword">return</span> blk</span><br><span class="line">b2 = nn.Sequential(*resnet_block(<span class="number">64</span>, <span class="number">64</span>, <span class="number">2</span>, first_block=<span class="literal">True</span>))</span><br><span class="line">b3 = nn.Sequential(*resnet_block(<span class="number">64</span>, <span class="number">128</span>, <span class="number">2</span>))</span><br><span class="line">b4 = nn.Sequential(*resnet_block(<span class="number">128</span>, <span class="number">256</span>, <span class="number">2</span>))</span><br><span class="line">b5 = nn.Sequential(*resnet_block(<span class="number">256</span>, <span class="number">512</span>, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">net = nn.Sequential(b1, b2, b3, b4, b5,</span><br><span class="line">                    nn.AdaptiveAvgPool2d((<span class="number">1</span>,<span class="number">1</span>)),</span><br><span class="line">                    nn.Flatten(), nn.Linear(<span class="number">512</span>, <span class="number">10</span>))</span><br><span class="line">X = torch.rand(size=(<span class="number">1</span>, <span class="number">1</span>, <span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line"><span class="keyword">for</span> layer <span class="keyword">in</span> net:</span><br><span class="line">    X = layer(X)</span><br><span class="line">    <span class="built_in">print</span>(layer.__class__.__name__,<span class="string">&#x27;output shape:\t&#x27;</span>, X.shape)</span><br></pre></td></tr></table></figure><h3 id="DenseNet"><a href="#DenseNet" class="headerlink" title="DenseNet"></a>DenseNet</h3><p><img data-src="https://zh.d2l.ai/_images/densenet-block.svg" alt="../_images/densenet-block.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv_block</span>(<span class="params">input_channels, num_channels</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        nn.BatchNorm2d(input_channels), nn.ReLU(),</span><br><span class="line">        nn.Conv2d(input_channels, num_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DenseBlock</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, num_convs, input_channels, num_channels</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DenseBlock, self).__init__()</span><br><span class="line">        layer = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_convs):</span><br><span class="line">            layer.append(conv_block(</span><br><span class="line">                num_channels * i + input_channels, num_channels))</span><br><span class="line">        self.net = nn.Sequential(*layer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, X</span>):</span></span><br><span class="line">        <span class="keyword">for</span> blk <span class="keyword">in</span> self.net:</span><br><span class="line">            Y = blk(X)</span><br><span class="line">            <span class="comment"># è¿æ¥é€šé“ç»´åº¦ä¸Šæ¯ä¸ªå—çš„è¾“å…¥å’Œè¾“å‡º</span></span><br><span class="line">            X = torch.cat((X, Y), dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> X</span><br></pre></td></tr></table></figure><p>ç¨ å¯†ç½‘ç»œä¸»è¦ç”±2éƒ¨åˆ†æ„æˆï¼š<em>ç¨ å¯†å—</em>ï¼ˆdense blockï¼‰å’Œ<em>è¿‡æ¸¡å±‚</em>ï¼ˆtransition layerï¼‰</p><p><img data-src="https://zh.d2l.ai/_images/densenet.svg" alt="../_images/densenet.svg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">blk = DenseBlock(<span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>)</span><br><span class="line">X = torch.randn(<span class="number">4</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">8</span>)</span><br><span class="line">Y = blk(X)</span><br><span class="line">Y.shape</span><br></pre></td></tr></table></figure><p>ç”±äºæ¯ä¸ªç¨ å¯†å—éƒ½ä¼šå¸¦æ¥é€šé“æ•°çš„å¢åŠ ï¼Œä½¿ç”¨è¿‡å¤šåˆ™ä¼šè¿‡äºå¤æ‚åŒ–æ¨¡å‹ã€‚ è€Œè¿‡æ¸¡å±‚å¯ä»¥ç”¨æ¥æ§åˆ¶æ¨¡å‹å¤æ‚åº¦ã€‚ å®ƒé€šè¿‡1Ã—1å·ç§¯å±‚æ¥å‡å°é€šé“æ•°ï¼Œå¹¶ä½¿ç”¨æ­¥å¹…ä¸º2çš„å¹³å‡æ±‡èšå±‚å‡åŠé«˜å’Œå®½ï¼Œä»è€Œè¿›ä¸€æ­¥é™ä½æ¨¡å‹å¤æ‚åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transition_block</span>(<span class="params">input_channels, num_channels</span>):</span></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        nn.BatchNorm2d(input_channels), nn.ReLU(),</span><br><span class="line">        nn.Conv2d(input_channels, num_channels, kernel_size=<span class="number">1</span>),</span><br><span class="line">        nn.AvgPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>))</span><br><span class="line">blk = transition_block(<span class="number">23</span>, <span class="number">10</span>)</span><br><span class="line">b1 = nn.Sequential(</span><br><span class="line">    nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>),</span><br><span class="line">    nn.BatchNorm2d(<span class="number">64</span>), nn.ReLU(),</span><br><span class="line">    nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>))</span><br><span class="line"><span class="comment"># num_channelsä¸ºå½“å‰çš„é€šé“æ•°</span></span><br><span class="line">num_channels, growth_rate = <span class="number">64</span>, <span class="number">32</span></span><br><span class="line">num_convs_in_dense_blocks = [<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>]</span><br><span class="line">blks = []</span><br><span class="line"><span class="keyword">for</span> i, num_convs <span class="keyword">in</span> <span class="built_in">enumerate</span>(num_convs_in_dense_blocks):</span><br><span class="line">    blks.append(DenseBlock(num_convs, num_channels, growth_rate))</span><br><span class="line">    <span class="comment"># ä¸Šä¸€ä¸ªç¨ å¯†å—çš„è¾“å‡ºé€šé“æ•°</span></span><br><span class="line">    num_channels += num_convs * growth_rate</span><br><span class="line">    <span class="comment"># åœ¨ç¨ å¯†å—ä¹‹é—´æ·»åŠ ä¸€ä¸ªè½¬æ¢å±‚ï¼Œä½¿é€šé“æ•°é‡å‡åŠ</span></span><br><span class="line">    <span class="keyword">if</span> i != <span class="built_in">len</span>(num_convs_in_dense_blocks) - <span class="number">1</span>:</span><br><span class="line">        blks.append(transition_block(num_channels, num_channels // <span class="number">2</span>))</span><br><span class="line">        num_channels = num_channels // <span class="number">2</span></span><br><span class="line">net = nn.Sequential(</span><br><span class="line">    b1, *blks,</span><br><span class="line">    nn.BatchNorm2d(num_channels), nn.ReLU(),</span><br><span class="line">    nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>)),</span><br><span class="line">    nn.Flatten(),</span><br><span class="line">    nn.Linear(num_channels, <span class="number">10</span>))</span><br></pre></td></tr></table></figure><h3 id="U-Net"><a href="#U-Net" class="headerlink" title="U-Net"></a>U-Net</h3><p><img data-src="https://s2.loli.net/2024/06/12/PIiVxGL71WYtqCy.png" alt="image-20240612201025297"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot; Parts of the U-Net model &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubleConv</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;(convolution =&gt; [BN] =&gt; ReLU) * 2&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels, mid_channels=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mid_channels:</span><br><span class="line">            mid_channels = out_channels</span><br><span class="line">        self.double_conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, mid_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(mid_channels),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(mid_channels, out_channels, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(out_channels),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.double_conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Down</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Downscaling with maxpool then double conv&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.maxpool_conv = nn.Sequential(</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">            DoubleConv(in_channels, out_channels)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.maxpool_conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Up</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Upscaling then double conv&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels, bilinear=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if bilinear, use the normal convolutions to reduce the number of channels</span></span><br><span class="line">        <span class="keyword">if</span> bilinear:</span><br><span class="line">            self.up = nn.Upsample(scale_factor=<span class="number">2</span>, mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">            self.conv = DoubleConv(in_channels, out_channels, in_channels // <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.up = nn.ConvTranspose2d(in_channels, in_channels // <span class="number">2</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">            self.conv = DoubleConv(in_channels, out_channels)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x1, x2</span>):</span></span><br><span class="line">        x1 = self.up(x1)</span><br><span class="line">        <span class="comment"># input is CHW</span></span><br><span class="line">        diffY = x2.size()[<span class="number">2</span>] - x1.size()[<span class="number">2</span>]</span><br><span class="line">        diffX = x2.size()[<span class="number">3</span>] - x1.size()[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        x1 = F.pad(x1, [diffX // <span class="number">2</span>, diffX - diffX // <span class="number">2</span>,</span><br><span class="line">                        diffY // <span class="number">2</span>, diffY - diffY // <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        x = torch.cat([x2, x1], dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutConv</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(OutConv, self).__init__()</span><br><span class="line">        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UNet</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_channels, n_classes, bilinear=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(UNet, self).__init__()</span><br><span class="line">        self.n_channels = n_channels</span><br><span class="line">        self.n_classes = n_classes</span><br><span class="line">        self.bilinear = bilinear</span><br><span class="line"></span><br><span class="line">        self.inc = (DoubleConv(n_channels, <span class="number">64</span>))</span><br><span class="line">        self.down1 = (Down(<span class="number">64</span>, <span class="number">128</span>))</span><br><span class="line">        self.down2 = (Down(<span class="number">128</span>, <span class="number">256</span>))</span><br><span class="line">        self.down3 = (Down(<span class="number">256</span>, <span class="number">512</span>))</span><br><span class="line">        factor = <span class="number">2</span> <span class="keyword">if</span> bilinear <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        self.down4 = (Down(<span class="number">512</span>, <span class="number">1024</span> // factor))</span><br><span class="line">        self.up1 = (Up(<span class="number">1024</span>, <span class="number">512</span> // factor, bilinear))</span><br><span class="line">        self.up2 = (Up(<span class="number">512</span>, <span class="number">256</span> // factor, bilinear))</span><br><span class="line">        self.up3 = (Up(<span class="number">256</span>, <span class="number">128</span> // factor, bilinear))</span><br><span class="line">        self.up4 = (Up(<span class="number">128</span>, <span class="number">64</span>, bilinear))</span><br><span class="line">        self.outc = (OutConv(<span class="number">64</span>, n_classes))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x1 = self.inc(x)</span><br><span class="line">        x2 = self.down1(x1)</span><br><span class="line">        x3 = self.down2(x2)</span><br><span class="line">        x4 = self.down3(x3)</span><br><span class="line">        x5 = self.down4(x4)</span><br><span class="line">        x = self.up1(x5, x4)</span><br><span class="line">        x = self.up2(x, x3)</span><br><span class="line">        x = self.up3(x, x2)</span><br><span class="line">        x = self.up4(x, x1)</span><br><span class="line">        logits = self.outc(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure><h3 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h3><p><img data-src="https://s2.loli.net/2024/06/12/XNfnA8pBt7cSZrw.png" alt="image-20240612223108822"  /></p><p><a href="https://zh.d2l.ai/chapter_computer-vision/ssd.html#id9">13.7. å•å‘å¤šæ¡†æ£€æµ‹ï¼ˆSSDï¼‰ â€” åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹  2.0.0 documentation (d2l.ai)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  #!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#  -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#  Copyleft (C) 2024 proanimer, Inc. All Rights Reserved</span></span><br><span class="line"><span class="comment">#   author:proanimer</span></span><br><span class="line"><span class="comment">#   createTime:2024/6/12 ä¸‹åˆ10:42</span></span><br><span class="line"><span class="comment">#   lastModifiedTime:2024/6/12 ä¸‹åˆ10:42</span></span><br><span class="line"><span class="comment">#   file:SSD.py</span></span><br><span class="line"><span class="comment">#   software: classicNets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> vgg19</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SSD</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        vgg = vgg19(pretrained=<span class="literal">True</span>)</span><br><span class="line">        vgg.<span class="built_in">eval</span>()</span><br><span class="line">        self.conv = vgg.features</span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">512</span>, <span class="number">1024</span>, <span class="number">3</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(<span class="number">1024</span>, <span class="number">1024</span>, <span class="number">1</span>)</span><br><span class="line">        self.conv3 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">1024</span>, <span class="number">256</span>, <span class="number">1</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">256</span>, <span class="number">512</span>, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line">        self.conv4 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">512</span>, <span class="number">128</span>, <span class="number">1</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">128</span>, <span class="number">256</span>, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line">        self.conv5 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">256</span>, <span class="number">128</span>, <span class="number">1</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">128</span>, <span class="number">256</span>, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line">        self.conv6 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">256</span>, <span class="number">128</span>, <span class="number">1</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">128</span>, <span class="number">256</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        feat_1 = self.conv(x)</span><br><span class="line">        feat = self.conv1(feat_1)</span><br><span class="line">        feat_2 = self.conv2(feat)</span><br><span class="line">        feat_3 = self.conv3(feat_2)</span><br><span class="line">        feat_4 = self.conv4(feat_3)</span><br><span class="line">        feat_5 = self.conv5(feat_4)</span><br><span class="line">        feat_6 = self.conv6(feat_5)</span><br><span class="line">        <span class="keyword">return</span> feat_1, feat_2, feat_3, feat_4, feat_5, feat_6</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Feature-Pyramid-Networks-for-Object-Detection"><a href="#Feature-Pyramid-Networks-for-Object-Detection" class="headerlink" title="Feature Pyramid Networks for Object Detection"></a>Feature Pyramid Networks for Object Detection</h3><p><img data-src="https://s2.loli.net/2024/06/12/vBQ5meLa21hNuTW.png" alt="image-20240612201222802"></p><p><img data-src="https://upload-images.jianshu.io/upload_images/14932861-4a872d74db7a93ec.png?imageMogr2/auto-orient/strip|imageView2/2/w/760/format/webp" alt="img" style="zoom:33%;" /></p><p>æœ€åä¼šå°†ä¸åŒå°ºåº¦å¾—åˆ°çš„ç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  #!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#  -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#  Copyleft (C) 2024 proanimer, Inc. All Rights Reserved</span></span><br><span class="line"><span class="comment">#   author:proanimer</span></span><br><span class="line"><span class="comment">#   createTime:2024/6/12 ä¸‹åˆ9:13</span></span><br><span class="line"><span class="comment">#   lastModifiedTime:2024/6/12 ä¸‹åˆ9:13</span></span><br><span class="line"><span class="comment">#   file:fpn.py</span></span><br><span class="line"><span class="comment">#   software: classicNets</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##å…ˆå®šä¹‰ResNetåŸºæœ¬ç±»ï¼Œæˆ–è€…å¯ä»¥è¯´ResNetçš„åŸºæœ¬ç –å—</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    expansion = <span class="number">4</span>  <span class="comment">##é€šé“å€å¢æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_planes, planes, stride=<span class="number">1</span>, downsample=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Bottleneck, self).__init__()</span><br><span class="line">        self.bottleneck = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_planes, planes, <span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(planes),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(planes, planes, <span class="number">3</span>, stride, <span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(planes),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(planes, self.expansion * planes, <span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(self.expansion * planes),</span><br><span class="line">        )</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        identity = x</span><br><span class="line">        out = self.bottleneck(x)</span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            identity = self.downsample(x)</span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##FPNç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FPN</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, layers</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(FPN, self).__init__()</span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        <span class="comment">###ä¸‹é¢å››å¥ä»£ç ä»£è¡¨å¤„ç†è¾“å…¥çš„C1æ¨¡å—--å¯¹åº”åšå®¢ä¸­çš„å›¾</span></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">3</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">###æ­å»ºè‡ªä¸‹è€Œä¸Šçš„C2,C3,C4,C5</span></span><br><span class="line">        self.layer1 = self._make_layer(<span class="number">64</span>, layers[<span class="number">0</span>])</span><br><span class="line">        self.layer2 = self._make_layer(<span class="number">128</span>, layers[<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line">        self.layer3 = self._make_layer(<span class="number">256</span>, layers[<span class="number">2</span>], <span class="number">2</span>)</span><br><span class="line">        self.layer4 = self._make_layer(<span class="number">512</span>, layers[<span class="number">3</span>], <span class="number">2</span>)</span><br><span class="line">        <span class="comment">###å®šä¹‰toplayerå±‚ï¼Œå¯¹C5å‡å°‘é€šé“æ•°ï¼Œå¾—åˆ°P5</span></span><br><span class="line">        self.toplayer = nn.Conv2d(<span class="number">2048</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="comment">###ä»£è¡¨3*3çš„å·ç§¯èåˆï¼Œç›®çš„æ˜¯æ¶ˆé™¤ä¸Šé‡‡æ ·è¿‡ç¨‹å¸¦æ¥çš„é‡å æ•ˆåº”ï¼Œä»¥ç”Ÿæˆæœ€ç»ˆçš„ç‰¹å¾å›¾ã€‚</span></span><br><span class="line">        self.smooth1 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        self.smooth2 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        self.smooth3 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">###æ¨ªå‘è¿æ¥ï¼Œä¿è¯é€šé“æ•°ç›®ç›¸åŒ</span></span><br><span class="line">        self.latlayer1 = nn.Conv2d(<span class="number">1024</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        self.latlayer2 = nn.Conv2d(<span class="number">512</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">        self.latlayer3 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">##ä½œç”¨ï¼šæ„å»ºC2-C5ç –å—ï¼Œæ³¨æ„strideä¸º1å’Œ2çš„åŒºåˆ«ï¼šå¾—åˆ°C2æ²¡æœ‰ç»å†ä¸‹é‡‡æ ·</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span>(<span class="params">self, planes, blocks, stride=<span class="number">1</span></span>):</span></span><br><span class="line">        downsample = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != Bottleneck.expansion * planes:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.inplanes, Bottleneck.expansion * planes, <span class="number">1</span>, stride, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(Bottleneck.expansion * planes)</span><br><span class="line">            )</span><br><span class="line">        <span class="comment">###åˆå§‹åŒ–éœ€è¦ä¸€ä¸ªlistï¼Œä»£è¡¨å·¦ä¾§ç½‘ç»œResNetæ¯ä¸€ä¸ªé˜¶æ®µçš„Bottleneckçš„æ•°é‡</span></span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(Bottleneck(self.inplanes, planes, stride, downsample))</span><br><span class="line">        self.inplanes = planes * Bottleneck.expansion</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(Bottleneck(self.inplanes, planes))</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">###è‡ªä¸Šè€Œä¸‹çš„ä¸Šé‡‡æ ·æ¨¡å—</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_upsample_add</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        _, _, H, W = y.shape</span><br><span class="line">        <span class="keyword">return</span> F.upsample(x, size=(H, W), mode=<span class="string">&#x27;bilinear&#x27;</span>) + y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        <span class="comment">###è‡ªä¸‹è€Œä¸Š</span></span><br><span class="line">        c1 = self.maxpool(self.relu(self.bn1(self.conv1(x))))</span><br><span class="line">        c2 = self.layer1(c1)</span><br><span class="line">        c3 = self.layer2(c2)</span><br><span class="line">        c4 = self.layer3(c3)</span><br><span class="line">        c5 = self.layer4(c4)</span><br><span class="line">        <span class="comment">###è‡ªä¸Šè€Œä¸‹</span></span><br><span class="line">        p5 = self.toplayer(c5)</span><br><span class="line">        p4 = self._upsample_add(p5, self.latlayer1(c4))</span><br><span class="line">        p3 = self._upsample_add(p4, self.latlayer2(c3))</span><br><span class="line">        p2 = self._upsample_add(p3, self.latlayer3(c2))</span><br><span class="line">        <span class="comment">###å·ç§¯èåˆï¼Œå¹³æ»‘å¤„ç†</span></span><br><span class="line">        p4 = self.smooth1(p4)</span><br><span class="line">        p3 = self.smooth2(p3)</span><br><span class="line">        p2 = self.smooth3(p2)</span><br><span class="line">        <span class="keyword">return</span> p2, p3, p4, p5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img data-src="https://img-blog.csdnimg.cn/img_convert/91f15dc3b7067e6ec693302399e05b0b.png" alt="img"></p><h3 id="Deformable-Conv"><a href="#Deformable-Conv" class="headerlink" title="Deformable Conv"></a>Deformable Conv</h3><p>å¯å˜å½¢çš„å·ç§¯,è¿˜æœ‰å¯å˜å½¢çš„attention. å³æ’å³ç”¨ç±»å‹.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeformConv2d</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, inc, outc, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, stride=<span class="number">1</span>, bias=<span class="literal">None</span>, modulation=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            modulation (bool, optional): If True, Modulated Defomable Convolution (Deformable ConvNets v2).</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(DeformConv2d, self).__init__()</span><br><span class="line">        self.kernel_size = kernel_size</span><br><span class="line">        self.padding = padding</span><br><span class="line">        self.stride = stride</span><br><span class="line">        self.zero_padding = nn.ZeroPad2d(padding)</span><br><span class="line">        <span class="comment"># convåˆ™æ˜¯å®é™…è¿›è¡Œçš„å·ç§¯æ“ä½œï¼Œæ³¨æ„è¿™é‡Œæ­¥é•¿è®¾ç½®ä¸ºå·ç§¯æ ¸å¤§å°ï¼Œå› ä¸ºä¸è¯¥å·ç§¯æ ¸è¿›è¡Œå·ç§¯æ“ä½œçš„ç‰¹å¾å›¾æ˜¯ç”±è¾“å‡ºç‰¹å¾å›¾ä¸­æ¯ä¸ªç‚¹æ‰©å±•ä¸ºå…¶å¯¹åº”å·ç§¯æ ¸é‚£ä¹ˆå¤šä¸ªç‚¹åç”Ÿæˆçš„ã€‚</span></span><br><span class="line">        self.conv = nn.Conv2d(inc, outc, kernel_size=kernel_size, stride=kernel_size, bias=bias)</span><br><span class="line">        <span class="comment"># p_convæ˜¯ç”Ÿæˆoffsetsæ‰€ä½¿ç”¨çš„å·ç§¯ï¼Œè¾“å‡ºé€šé“æ•°ä¸ºå·ç§¯æ ¸å°ºå¯¸çš„å¹³æ–¹çš„2å€ï¼Œä»£è¡¨å¯¹åº”å·ç§¯æ ¸æ¯ä¸ªä½ç½®æ¨ªçºµåæ ‡éƒ½æœ‰åç§»é‡ã€‚</span></span><br><span class="line">        self.p_conv = nn.Conv2d(inc, <span class="number">2</span>*kernel_size*kernel_size, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, stride=stride)</span><br><span class="line">        nn.init.constant_(self.p_conv.weight, <span class="number">0</span>)</span><br><span class="line">        self.p_conv.register_backward_hook(self._set_lr)</span><br><span class="line"> </span><br><span class="line">        self.modulation = modulation <span class="comment"># modulationæ˜¯å¯é€‰å‚æ•°,è‹¥è®¾ç½®ä¸ºTrue,é‚£ä¹ˆåœ¨è¿›è¡Œå·ç§¯æ“ä½œæ—¶,å¯¹åº”å·ç§¯æ ¸çš„æ¯ä¸ªä½ç½®éƒ½ä¼šåˆ†é…ä¸€ä¸ªæƒé‡ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> modulation:</span><br><span class="line">            self.m_conv = nn.Conv2d(inc, kernel_size*kernel_size, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, stride=stride)</span><br><span class="line">            nn.init.constant_(self.m_conv.weight, <span class="number">0</span>)</span><br><span class="line">            self.m_conv.register_backward_hook(self._set_lr)</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_lr</span>(<span class="params">module, grad_input, grad_output</span>):</span></span><br><span class="line">        grad_input = (grad_input[i] * <span class="number">0.1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grad_input)))</span><br><span class="line">        grad_output = (grad_output[i] * <span class="number">0.1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grad_output)))</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        offset = self.p_conv(x)</span><br><span class="line">        <span class="keyword">if</span> self.modulation:</span><br><span class="line">            m = torch.sigmoid(self.m_conv(x))</span><br><span class="line"> </span><br><span class="line">        dtype = offset.data.<span class="built_in">type</span>()</span><br><span class="line">        ks = self.kernel_size</span><br><span class="line">        N = offset.size(<span class="number">1</span>) // <span class="number">2</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> self.padding:</span><br><span class="line">            x = self.zero_padding(x)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (b, 2N, h, w)</span></span><br><span class="line">        p = self._get_p(offset, dtype)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (b, h, w, 2N)</span></span><br><span class="line">        p = p.contiguous().permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">        q_lt = p.detach().floor()</span><br><span class="line">        q_rb = q_lt + <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">        q_lt = torch.cat([torch.clamp(q_lt[..., :N], <span class="number">0</span>, x.size(<span class="number">2</span>)-<span class="number">1</span>), torch.clamp(q_lt[..., N:], <span class="number">0</span>, x.size(<span class="number">3</span>)-<span class="number">1</span>)], dim=-<span class="number">1</span>).long()</span><br><span class="line">        q_rb = torch.cat([torch.clamp(q_rb[..., :N], <span class="number">0</span>, x.size(<span class="number">2</span>)-<span class="number">1</span>), torch.clamp(q_rb[..., N:], <span class="number">0</span>, x.size(<span class="number">3</span>)-<span class="number">1</span>)], dim=-<span class="number">1</span>).long()</span><br><span class="line">        q_lb = torch.cat([q_lt[..., :N], q_rb[..., N:]], dim=-<span class="number">1</span>)</span><br><span class="line">        q_rt = torch.cat([q_rb[..., :N], q_lt[..., N:]], dim=-<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># clip p</span></span><br><span class="line">        p = torch.cat([torch.clamp(p[..., :N], <span class="number">0</span>, x.size(<span class="number">2</span>)-<span class="number">1</span>), torch.clamp(p[..., N:], <span class="number">0</span>, x.size(<span class="number">3</span>)-<span class="number">1</span>)], dim=-<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># bilinear kernel (b, h, w, N)</span></span><br><span class="line">        g_lt = (<span class="number">1</span> + (q_lt[..., :N].type_as(p) - p[..., :N])) * (<span class="number">1</span> + (q_lt[..., N:].type_as(p) - p[..., N:]))</span><br><span class="line">        g_rb = (<span class="number">1</span> - (q_rb[..., :N].type_as(p) - p[..., :N])) * (<span class="number">1</span> - (q_rb[..., N:].type_as(p) - p[..., N:]))</span><br><span class="line">        g_lb = (<span class="number">1</span> + (q_lb[..., :N].type_as(p) - p[..., :N])) * (<span class="number">1</span> - (q_lb[..., N:].type_as(p) - p[..., N:]))</span><br><span class="line">        g_rt = (<span class="number">1</span> - (q_rt[..., :N].type_as(p) - p[..., :N])) * (<span class="number">1</span> + (q_rt[..., N:].type_as(p) - p[..., N:]))</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (b, c, h, w, N)</span></span><br><span class="line">        x_q_lt = self._get_x_q(x, q_lt, N)</span><br><span class="line">        x_q_rb = self._get_x_q(x, q_rb, N)</span><br><span class="line">        x_q_lb = self._get_x_q(x, q_lb, N)</span><br><span class="line">        x_q_rt = self._get_x_q(x, q_rt, N)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (b, c, h, w, N)</span></span><br><span class="line">        x_offset = g_lt.unsqueeze(dim=<span class="number">1</span>) * x_q_lt + \</span><br><span class="line">                   g_rb.unsqueeze(dim=<span class="number">1</span>) * x_q_rb + \</span><br><span class="line">                   g_lb.unsqueeze(dim=<span class="number">1</span>) * x_q_lb + \</span><br><span class="line">                   g_rt.unsqueeze(dim=<span class="number">1</span>) * x_q_rt</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># modulation</span></span><br><span class="line">        <span class="keyword">if</span> self.modulation:</span><br><span class="line">            m = m.contiguous().permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">            m = m.unsqueeze(dim=<span class="number">1</span>)</span><br><span class="line">            m = torch.cat([m <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(x_offset.size(<span class="number">1</span>))], dim=<span class="number">1</span>)</span><br><span class="line">            x_offset *= m</span><br><span class="line"> </span><br><span class="line">        x_offset = self._reshape_x_offset(x_offset, ks)</span><br><span class="line">        out = self.conv(x_offset)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_p_n</span>(<span class="params">self, N, dtype</span>):</span></span><br><span class="line">        <span class="comment"># ç”±äºå·ç§¯æ ¸ä¸­å¿ƒç‚¹ä½ç½®æ˜¯å…¶å°ºå¯¸çš„ä¸€åŠï¼Œäºæ˜¯ä¸­å¿ƒç‚¹å‘å·¦ï¼ˆä¸Šï¼‰æ–¹å‘ç§»åŠ¨å°ºå¯¸çš„ä¸€åŠå°±å¾—åˆ°èµ·å§‹ç‚¹ï¼Œå‘å³ï¼ˆä¸‹ï¼‰æ–¹å‘ç§»åŠ¨å¦ä¸€åŠå°±å¾—åˆ°ç»ˆæ­¢ç‚¹</span></span><br><span class="line">        p_n_x, p_n_y = torch.meshgrid(</span><br><span class="line">            torch.arange(-(self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>, (self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>+<span class="number">1</span>),</span><br><span class="line">            torch.arange(-(self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>, (self.kernel_size-<span class="number">1</span>)//<span class="number">2</span>+<span class="number">1</span>))</span><br><span class="line">        <span class="comment"># (2N, 1)</span></span><br><span class="line">        p_n = torch.cat([torch.flatten(p_n_x), torch.flatten(p_n_y)], <span class="number">0</span>)</span><br><span class="line">        p_n = p_n.view(<span class="number">1</span>, <span class="number">2</span>*N, <span class="number">1</span>, <span class="number">1</span>).<span class="built_in">type</span>(dtype)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> p_n</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_p_0</span>(<span class="params">self, h, w, N, dtype</span>):</span></span><br><span class="line">        <span class="comment"># p0_yã€p0_xå°±æ˜¯è¾“å‡ºç‰¹å¾å›¾æ¯ç‚¹æ˜ å°„åˆ°è¾“å…¥ç‰¹å¾å›¾ä¸Šçš„çºµã€æ¨ªåæ ‡å€¼ã€‚</span></span><br><span class="line">        p_0_x, p_0_y = torch.meshgrid(</span><br><span class="line">            torch.arange(<span class="number">1</span>, h*self.stride+<span class="number">1</span>, self.stride),</span><br><span class="line">            torch.arange(<span class="number">1</span>, w*self.stride+<span class="number">1</span>, self.stride))</span><br><span class="line">        </span><br><span class="line">        p_0_x = torch.flatten(p_0_x).view(<span class="number">1</span>, <span class="number">1</span>, h, w).repeat(<span class="number">1</span>, N, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        p_0_y = torch.flatten(p_0_y).view(<span class="number">1</span>, <span class="number">1</span>, h, w).repeat(<span class="number">1</span>, N, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        p_0 = torch.cat([p_0_x, p_0_y], <span class="number">1</span>).<span class="built_in">type</span>(dtype)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> p_0</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¾“å‡ºç‰¹å¾å›¾ä¸Šæ¯ç‚¹ï¼ˆå¯¹åº”å·ç§¯æ ¸ä¸­å¿ƒï¼‰åŠ ä¸Šå…¶å¯¹åº”å·ç§¯æ ¸æ¯ä¸ªä½ç½®çš„ç›¸å¯¹ï¼ˆæ¨ªã€çºµï¼‰åæ ‡åå†åŠ ä¸Šè‡ªå­¦ä¹ çš„ï¼ˆæ¨ªã€çºµåæ ‡ï¼‰åç§»é‡ã€‚</span></span><br><span class="line">    <span class="comment"># p0å°±æ˜¯å°†è¾“å‡ºç‰¹å¾å›¾æ¯ç‚¹å¯¹åº”åˆ°å·ç§¯æ ¸ä¸­å¿ƒï¼Œç„¶åæ˜ å°„åˆ°è¾“å…¥ç‰¹å¾å›¾ä¸­çš„ä½ç½®ï¼›</span></span><br><span class="line">    <span class="comment"># pnåˆ™æ˜¯p0å¯¹åº”å·ç§¯æ ¸æ¯ä¸ªä½ç½®çš„ç›¸å¯¹åæ ‡ï¼›</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_p</span>(<span class="params">self, offset, dtype</span>):</span></span><br><span class="line">        N, h, w = offset.size(<span class="number">1</span>)//<span class="number">2</span>, offset.size(<span class="number">2</span>), offset.size(<span class="number">3</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (1, 2N, 1, 1)</span></span><br><span class="line">        p_n = self._get_p_n(N, dtype)</span><br><span class="line">        <span class="comment"># (1, 2N, h, w)</span></span><br><span class="line">        p_0 = self._get_p_0(h, w, N, dtype)</span><br><span class="line">        p = p_0 + p_n + offset</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_x_q</span>(<span class="params">self, x, q, N</span>):</span></span><br><span class="line">        <span class="comment"># è®¡ç®—åŒçº¿æ€§æ’å€¼ç‚¹çš„4é‚»åŸŸç‚¹å¯¹åº”çš„æƒé‡</span></span><br><span class="line">        b, h, w, _ = q.size()</span><br><span class="line">        padded_w = x.size(<span class="number">3</span>)</span><br><span class="line">        c = x.size(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># (b, c, h*w)</span></span><br><span class="line">        x = x.contiguous().view(b, c, -<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># (b, h, w, N)</span></span><br><span class="line">        index = q[..., :N]*padded_w + q[..., N:]  <span class="comment"># offset_x*w + offset_y</span></span><br><span class="line">        <span class="comment"># (b, c, h*w*N)</span></span><br><span class="line">        index = index.contiguous().unsqueeze(dim=<span class="number">1</span>).expand(-<span class="number">1</span>, c, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>).contiguous().view(b, c, -<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">        x_offset = x.gather(dim=-<span class="number">1</span>, index=index).contiguous().view(b, c, h, w, N)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> x_offset</span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_reshape_x_offset</span>(<span class="params">x_offset, ks</span>):</span></span><br><span class="line">        b, c, h, w, N = x_offset.size()</span><br><span class="line">        x_offset = torch.cat([x_offset[..., s:s+ks].contiguous().view(b, c, h, w*ks) <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, N, ks)], dim=-<span class="number">1</span>)</span><br><span class="line">        x_offset = x_offset.contiguous().view(b, c, h*ks, w*ks)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> x_offset</span><br></pre></td></tr></table></figure><p>è¿™äº›æ¨¡å‹ä¸­NiNçš„1x1convä»¥åŠResetNetçš„æ®‹å·®ä½œä¸ºåé¢æ›´å¤æ‚æ¨¡å‹å¸¸ç”¨çš„æ–¹æ³•,æ¯”å¦‚U-Net.è€ŒUNet,FPNè¿™æ ·çš„å¤šå°ºåº¦å’Œæ®‹å·®è¿æ¥åˆåœ¨è®¸å¤šç›®æ ‡æ£€æµ‹ç­‰ä»»åŠ¡ä¸­ä½¿ç”¨.</p><h2 id="RNN-GRU-LSTM"><a href="#RNN-GRU-LSTM" class="headerlink" title="RNN GRU LSTM"></a>RNN GRU LSTM</h2><p><img data-src="https://zh.d2l.ai/_images/rnn.svg" alt="../_images/rnn.svg"></p><p><img data-src="https://zh.d2l.ai/_images/gru-3.svg" alt="../_images/gru-3.svg"></p><p><img data-src="https://zh.d2l.ai/_images/lstm-3.svg" alt="../_images/lstm-3.svg"></p><h1 id="é»‘å¤œå‰çš„å…‰æ˜"><a href="#é»‘å¤œå‰çš„å…‰æ˜" class="headerlink" title="é»‘å¤œå‰çš„å…‰æ˜"></a>é»‘å¤œå‰çš„å…‰æ˜</h1><blockquote><p>åœ¨transformerä¹‹å‰,æˆ‘ä»¬è®¤ä¸ºæ³¡æ²«å³å°†å¹ç ´</p><p><a href="https://www.open-open.com/news/view/448d1219">æå¼€å¤è¯´2018å¹´æ˜¯AIæ³¡æ²«ç ´è£‚ä¹‹å¹´ LeCunç‚¹èµ - æå¼€å¤ - ITä¸šç•Œ - æ·±åº¦å¼€æº (open-open.com)</a></p><p><a href="https://www.thepaper.cn/newsDetail_forward_4103098">åˆ«å¹äº†ï¼ŒAIçš„æ³¡æ²«å¿«è¢«å¹ç ´äº†<em>æ¾æ¹ƒå·Â·æ¹ƒå®¢</em>æ¾æ¹ƒæ–°é—»-The Paper</a></p></blockquote><h2 id="Attention"><a href="#Attention" class="headerlink" title="Attention"></a>Attention</h2><p><img data-src="https://zh.d2l.ai/_images/seq2seq-attention-details.svg" alt="../_images/seq2seq-attention-details.svg"></p><p><img data-src="https://zh.d2l.ai/_images/multi-head-attention.svg" alt="../_images/multi-head-attention.svg"></p><h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p><img data-src="https://zh.d2l.ai/_images/transformer.svg" alt="../_images/transformer.svg"></p><p><a href="https://nlp.seas.harvard.edu/annotated-transformer/#prelims">The Annotated Transformer (harvard.edu)</a></p><p>ä»å®è§‚è§’åº¦æ¥çœ‹ï¼ŒTransformerçš„ç¼–ç å™¨æ˜¯ç”±å¤šä¸ªç›¸åŒçš„å±‚å åŠ è€Œæˆçš„ï¼Œæ¯ä¸ªå±‚éƒ½æœ‰ä¸¤ä¸ªå­å±‚ï¼ˆå­å±‚è¡¨ç¤ºä¸ºsublayerï¼‰ã€‚ç¬¬ä¸€ä¸ªå­å±‚æ˜¯<em>å¤šå¤´è‡ªæ³¨æ„åŠ›</em>ï¼ˆmulti-head self-attentionï¼‰æ±‡èšï¼›ç¬¬äºŒä¸ªå­å±‚æ˜¯<em>åŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œ</em>ï¼ˆpositionwise feed-forward networkï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨è®¡ç®—ç¼–ç å™¨çš„è‡ªæ³¨æ„åŠ›æ—¶ï¼ŒæŸ¥è¯¢ã€é”®å’Œå€¼éƒ½æ¥è‡ªå‰ä¸€ä¸ªç¼–ç å™¨å±‚çš„è¾“å‡ºã€‚å—ä¸­æ®‹å·®ç½‘ç»œçš„å¯å‘ï¼Œæ¯ä¸ªå­å±‚éƒ½é‡‡ç”¨äº†<em>æ®‹å·®è¿æ¥</em>ï¼ˆresidual connectionï¼‰ã€‚åœ¨Transformerä¸­ï¼Œå¯¹äºåºåˆ—ä¸­ä»»ä½•ä½ç½®çš„ä»»ä½•è¾“å…¥ğ‘¥âˆˆğ‘…ğ‘‘ï¼Œéƒ½è¦æ±‚æ»¡è¶³sublayer(ğ‘¥)âˆˆğ‘…ğ‘‘ï¼Œä»¥ä¾¿æ®‹å·®è¿æ¥æ»¡è¶³ğ‘¥+sublayer(ğ‘¥)âˆˆğ‘…ğ‘‘ã€‚åœ¨æ®‹å·®è¿æ¥çš„åŠ æ³•è®¡ç®—ä¹‹åï¼Œç´§æ¥ç€åº”ç”¨<em>å±‚è§„èŒƒåŒ–</em>ï¼ˆlayer normalizationï¼‰</p><p>å› æ­¤ï¼Œè¾“å…¥åºåˆ—å¯¹åº”çš„æ¯ä¸ªä½ç½®ï¼ŒTransformerç¼–ç å™¨éƒ½å°†è¾“å‡ºä¸€ä¸ªğ‘‘ç»´è¡¨ç¤ºå‘é‡ã€‚</p><p>Transformerè§£ç å™¨ä¹Ÿæ˜¯ç”±å¤šä¸ªç›¸åŒçš„å±‚å åŠ è€Œæˆçš„ï¼Œå¹¶ä¸”å±‚ä¸­ä½¿ç”¨äº†æ®‹å·®è¿æ¥å’Œå±‚è§„èŒƒåŒ–ã€‚é™¤äº†ç¼–ç å™¨ä¸­æè¿°çš„ä¸¤ä¸ªå­å±‚ä¹‹å¤–ï¼Œè§£ç å™¨è¿˜åœ¨è¿™ä¸¤ä¸ªå­å±‚ä¹‹é—´æ’å…¥äº†ç¬¬ä¸‰ä¸ªå­å±‚ï¼Œç§°ä¸º<em>ç¼–ç å™¨ï¼è§£ç å™¨æ³¨æ„åŠ›</em>ï¼ˆencoder-decoder attentionï¼‰å±‚ã€‚åœ¨ç¼–ç å™¨ï¼è§£ç å™¨æ³¨æ„åŠ›ä¸­ï¼ŒæŸ¥è¯¢æ¥è‡ªå‰ä¸€ä¸ªè§£ç å™¨å±‚çš„è¾“å‡ºï¼Œè€Œé”®å’Œå€¼æ¥è‡ªæ•´ä¸ªç¼–ç å™¨çš„è¾“å‡ºã€‚åœ¨è§£ç å™¨è‡ªæ³¨æ„åŠ›ä¸­ï¼ŒæŸ¥è¯¢ã€é”®å’Œå€¼éƒ½æ¥è‡ªä¸Šä¸€ä¸ªè§£ç å™¨å±‚çš„è¾“å‡ºã€‚ä½†æ˜¯ï¼Œè§£ç å™¨ä¸­çš„æ¯ä¸ªä½ç½®åªèƒ½è€ƒè™‘è¯¥ä½ç½®ä¹‹å‰çš„æ‰€æœ‰ä½ç½®ã€‚è¿™ç§<em>æ©è”½</em>ï¼ˆmaskedï¼‰æ³¨æ„åŠ›ä¿ç•™äº†<em>è‡ªå›å½’</em>ï¼ˆauto-regressiveï¼‰å±æ€§ï¼Œç¡®ä¿é¢„æµ‹ä»…ä¾èµ–äºå·²ç”Ÿæˆçš„è¾“å‡ºè¯å…ƒã€‚</p><blockquote><p>transformerç›®å‰æ˜¯é€šåƒçš„,åœ¨cv,nlp,speechç­‰é¢†åŸŸçš„å„ç§ä»»åŠ¡ä¸Šéƒ½æœ‰å®è·µ</p><p>ä¸‹é¢æ˜¯ä½¿ç”¨transformerçš„é€šç”¨ç›®æ ‡æ£€æµ‹æ–¹æ³•</p></blockquote><h3 id="DETR"><a href="#DETR" class="headerlink" title="DETR"></a>DETR</h3><p><img data-src="https://github.com/facebookresearch/detr/raw/main/.github/DETR.png" alt="DETR"></p><p>ä¸ä¼ ç»Ÿçš„è®¡ç®—æœºè§†è§‰æŠ€æœ¯ä¸åŒï¼ŒDETR å°†ç‰©ä½“æ£€æµ‹ä½œä¸ºä¸€ä¸ªç›´æ¥çš„é›†åˆé¢„æµ‹é—®é¢˜(a direct set prediction problem)æ¥å¤„ç†ã€‚å®ƒç”±ä¸€ä¸ªåŸºäºé›†åˆçš„å…¨å±€æŸå¤±å’Œä¸€ä¸ªå˜æ¢å™¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„ç»„æˆï¼Œå‰è€…é€šè¿‡ä¸¤ç«¯åŒ¹é…å¼ºåˆ¶è¿›è¡Œå”¯ä¸€é¢„æµ‹ã€‚</p><p>ç»™å®šä¸€ä¸ªå›ºå®šçš„å°èŒƒå›´å·²å­¦å¯¹è±¡æŸ¥è¯¢é›†ï¼ŒDETR ä¼šå¯¹å¯¹è±¡å…³ç³»å’Œå…¨å±€å›¾åƒä¸Šä¸‹æ–‡è¿›è¡Œæ¨ç†ï¼Œä»è€Œç›´æ¥å¹¶è¡Œè¾“å‡ºæœ€ç»ˆçš„é¢„æµ‹é›†ã€‚ç”±äºè¿™ç§å¹¶è¡Œæ€§ï¼ŒDETR éå¸¸å¿«é€Ÿé«˜æ•ˆã€‚</p><p><a href="https://colab.research.google.com/github/facebookresearch/detr/blob/colab/notebooks/detr_demo.ipynb#scrollTo=h91rsIPl7tVl">detr_demo.ipynb - Colab (google.com)</a></p><h3 id="Deformable-DETR"><a href="#Deformable-DETR" class="headerlink" title="Deformable DETR"></a>Deformable DETR</h3><p><img data-src="https://s2.loli.net/2024/06/12/UdvnyZqNjWB51SH.png" alt="image-20240612220634309"></p><p><img data-src="https://s2.loli.net/2024/06/12/BpS6JWYKnGA5Rty.png" alt="image-20240612220643631"></p><h2 id="Diffusion-Models"><a href="#Diffusion-Models" class="headerlink" title="Diffusion Models"></a>Diffusion Models</h2><blockquote><p>åœ¨VAE,GANä¹‹åçš„ç”Ÿæˆå¼ä¹‹å…‰.</p></blockquote><p><img data-src="https://s2.loli.net/2024/06/12/XmtBQZG31L4Wi89.png" alt="image-20240612212239385"></p><p>å…·ä½“ä»£ç å‚çœ‹<a href="https://huggingface.co/blog/annotated-diffusion">The Annotated Diffusion Model (huggingface.co)</a></p><ul><li><a href="https://angusturner.github.io/generative_models/2021/06/29/diffusion-probabilistic-models-I.html">Diffusion Models as a kind of VAE | Angus Turner</a></li><li><a href="https://github.com/yangqy1110/Diffusion-Models?tab=readme-ov-file">yangqy1110/Diffusion-Models: æ‰©æ•£æ¨¡å‹åŸç†å’Œpytorchä»£ç å®ç°åˆå­¦èµ„æ–™æ±‡æ€» (github.com)</a></li><li><a href="https://github.com/mikonvergence/DiffusionFastForward/tree/master">mikonvergence/DiffusionFastForward: DiffusionFastForward: a free course and experimental framework for diffusion-based generative models (github.com)</a></li><li><a href="https://github.com/diff-usion/Awesome-Diffusion-Models?tab=readme-ov-file">diff-usion/Awesome-Diffusion-Models: A collection of resources and papers on Diffusion Models (github.com)</a></li></ul><h1 id="ç°ä»£å¤§æ¨¡å‹"><a href="#ç°ä»£å¤§æ¨¡å‹" class="headerlink" title="ç°ä»£å¤§æ¨¡å‹"></a>ç°ä»£å¤§æ¨¡å‹</h1><blockquote><p>ç›®å‰,å®ƒæ˜¯æ­£å¤„äºç»Ÿæ²»åœ°ä½. å½“ç„¶,äººä»¬ä¹Ÿå¸Œæœ›æœ‰å…¶ä»–æ–¹æ³•.</p></blockquote><h2 id="LLM"><a href="#LLM" class="headerlink" title="LLM"></a>LLM</h2><p><img data-src="https://s2.loli.net/2024/06/12/RHxAKYM4NFjnTpu.png" alt="image-20240612203226976"></p><p><img data-src="https://s2.loli.net/2024/06/12/pK6PTi7awbfCEBG.png" alt="image-20240612203251260"></p><p>å¯ä»¥è€ƒè™‘å‚è€ƒAndrej Karpathyçš„nanoGPTä»¥åŠGPT2å¤ç°.</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>å­¦ä¹ Pytorch<a href="https://www.learnpytorch.io/">Zero to Mastery Learn PyTorch for Deep Learning</a></p><p>å­¦ä¹ ç»å…¸<a href="https://zh.d2l.ai/">ã€ŠåŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ã€‹ â€” åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹  2.0.0 documentation (d2l.ai)</a></p><p>å­¦ä¹ attentionä¸transformer</p><ul><li><a href="https://nlp.seas.harvard.edu/annotated-transformer/#prelims">The Annotated Transformer (harvard.edu)</a></li><li><p><a href="https://jalammar.github.io/illustrated-transformer/">The Illustrated Transformer â€“ Jay Alammar â€“ Visualizing machine learning one concept at a time. (jalammar.github.io)</a></p></li><li><p><a href="https://github.com/lucidrains/vit-pytorch">lucidrains/vit-pytorch: Implementation of Vision Transformer, a simple way to achieve SOTA in vision classification with only a single transformer encoder, in Pytorch (github.com)</a></p></li><li><p><a href="https://github.com/changzy00/pytorch-attention">changzy00/pytorch-attention: ğŸ¦–Pytorch implementation of popular Attention Mechanisms, Vision Transformers, MLP-Like models and CNNs.ğŸ”¥ğŸ”¥ğŸ”¥ (github.com)</a></p></li><li><a href="https://github.com/xmu-xiaoma666/External-Attention-pytorch">xmu-xiaoma666/External-Attention-pytorch: ğŸ€ Pytorch implementation of various Attention Mechanisms, MLP, Re-parameter, Convolution, which is helpful to further understand papers.â­â­â­ (github.com)</a></li></ul><p>å­¦ä¹ llm</p><ul><li><p><a href="https://github.com/rasbt/LLMs-from-scratch">https://github.com/rasbt/LLMs-from-scratch</a></p></li><li><p><a href="https://www.youtube.com/watch?v=kCc8FmEb1nY&amp;ab_channel=AndrejKarpathy">Letâ€™s build GPT: from scratch, in code, spelled out. (youtube.com)</a></p></li><li><p><a href="https://github.com/naklecha/llama3-from-scratch">naklecha/llama3-from-scratch: llama3 implementation one matrix multiplication at a time (github.com)</a></p></li><li><a href="https://cyrilzakka.github.io/llm-playbook/index.html">Introduction - The Large Language Model Playbook (cyrilzakka.github.io)</a></li></ul><p>å­¦ä¹ æ‰©æ•£æ¨¡å‹å’Œå¤§æ¨¡å‹çš„ä¸ªäººåšå®¢</p><ul><li><a href="https://spaces.ac.cn/">ç§‘å­¦ç©ºé—´|Scientific Spaces</a></li><li><a href="https://karpathy.github.io/">Andrej Karpathy blog</a></li><li><a href="https://lilianweng.github.io/">Lilâ€™Log (lilianweng.github.io)</a></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ€»ç»“ä¸€ä¸‹å­¦ä¹ äººå·¥æ™ºèƒ½/æ·±åº¦å­¦ä¹ è¿‡ç¨‹ä¸­ä¸ªäººè§‰å¾—é‡è¦çš„æ–¹æ³•å’Œç»éªŒ. &lt;/p&gt;
&lt;p&gt;ä¸»è¦å…³äºæ¨¡å‹.&lt;br&gt;</summary>
    
    
    
    
    <category term="deep learning" scheme="https://www.sekyoro.top/tags/deep-learning/"/>
    
  </entry>
  
</feed>
