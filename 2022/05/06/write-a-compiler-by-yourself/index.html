<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script src="/live2d-widget/autoload.js"></script>

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/blog_32px.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog_32px.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog_16px.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="EPrJAp11bJwHULpQUaSNSZ8_3RcvTsPDAEGOME4pl1w">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB21D8MKKW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VB21D8MKKW');
</script>

<!-- google adsense in head.swig -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123"
     crossorigin="anonymous"></script>
  <meta name="msvalidate.01" content="7226864CE87CE9DE8C008385273846FF">
  <meta name="baidu-site-verification" content="code-fjFXVtiL7j" />

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-corner-indicator.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.sekyoro.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":240,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"apiKey":"8eb71f5ca3167e9ef3487882f10cfaad","indexName":"SekyoroSearch","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>
<link href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" rel="stylesheet">
  <meta name="description" content="这是一个tough part">
<meta property="og:type" content="article">
<meta property="og:title" content="write_a_compiler_by_yourself">
<meta property="og:url" content="https://www.sekyoro.top/2022/05/06/write-a-compiler-by-yourself/index.html">
<meta property="og:site_name" content="Sekyoro的博客小屋">
<meta property="og:description" content="这是一个tough part">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/05/08/EcgFvkbuN63iV75.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/30/kIOan4cNbL839Kf.png">
<meta property="article:published_time" content="2022-05-06T08:05:45.000Z">
<meta property="article:modified_time" content="2022-05-30T11:19:38.931Z">
<meta property="article:author" content="Sekyoro">
<meta property="article:tag" content="c">
<meta property="article:tag" content="compiler">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/05/08/EcgFvkbuN63iV75.png">

<link rel="canonical" href="https://www.sekyoro.top/2022/05/06/write-a-compiler-by-yourself/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
 

<script>
  var OriginTitile = document.title;
  var titleTime;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      document.title = "(つェ⊂)我藏好了哦~" + OriginTitile;
      clearTimeout(titleTime);
    } else {
      document.title = "(*´∇｀*) 被你发现啦~" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });
</script>



  <script src="/js/src/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>


  <title>write_a_compiler_by_yourself | Sekyoro的博客小屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Sekyoro的博客小屋" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
<!-- require JQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<!-- require pjax -->
<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/index.min.js"></script>


   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>


  <div class="container use-motion">
    <div class="headband"></div>
	
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sekyoro的博客小屋</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resume">

    <a href="/resume/" rel="section"><i class="fa fa-file-pdf fa-fw"></i>简历</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.sekyoro.top/2022/05/06/write-a-compiler-by-yourself/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg">
      <meta itemprop="name" content="Sekyoro">
      <meta itemprop="description" content="什么也无法舍弃的人，什么也做不了.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sekyoro的博客小屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          write_a_compiler_by_yourself
        </h1>

        <div class="post-meta">
		
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-06 16:05:45" itemprop="dateCreated datePublished" datetime="2022-05-06T16:05:45+08:00">2022-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-30 19:19:38" itemprop="dateModified" datetime="2022-05-30T19:19:38+08:00">2022-05-30</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>32 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这是一个tough part<br><span id="more"></span><br>本人学艺不精,这里先列举一下用到的资料.<br><a target="_blank" rel="noopener" href="https://compilers.iecc.com/">自己写一个编译器</a></p>
<p><a target="_blank" rel="noopener" href="https://lotabout.me/2015/write-a-C-interpreter-1/">手把手教你构建 C 语言编译器</a></p>
<p>一个英文一个中文,可以说是比较详细了.</p>
<p>还有国内清华的<a target="_blank" rel="noopener" href="https://decaf-lang.github.io/minidecaf-tutorial">minidecaf</a>,最后我还是用了北大的.</p>
<p>需要装docker.输入docker version报错.应该是Hyper-V或是WSL2未开启,开了之后</p>
<p><img data-src="https://s2.loli.net/2022/05/08/EcgFvkbuN63iV75.png" alt="image-20220508192521986"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;C:\Program Files\Docker\Docker&quot;</span><br><span class="line"></span><br><span class="line">DockerCli.exe -SwitchDaemon</span><br></pre></td></tr></table></figure>
<p>一顿操作,基本就行了.如果遇到这种错误<a target="_blank" rel="noopener" href="https://blog.csdn.net/sunshineGGB/article/details/122838156">Containers feature is disabled. Enable it using the PowerShell script in an administrative</a></p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="编译器结构"><a href="#编译器结构" class="headerlink" title="编译器结构"></a>编译器结构</h3><p>一般而言，编译器的编写分为 3 个步骤：</p>
<ol>
<li>词法分析器，用于将字符串转化成内部的表示结构。</li>
<li>语法分析器，将词法分析得到的标记流（token）生成一棵语法树。</li>
<li>目标代码的生成，将语法树转化成目标代码。</li>
</ol>
<p>在这里我们只需要设计一个程序, 将输入的 SysY 源代码, 编译到 RISC-V 汇编即可. 在这种意义之下, 编译器通常由以下几个部分组成:</p>
<ul>
<li><strong>前端:</strong> 通过词法分析和语法分析, 将源代码解析成抽象语法树 (abstract syntax tree, AST). 通过语义分析, 扫描抽象语法树, 检查其是否存在语义错误.</li>
<li><strong>中端:</strong> 将抽象语法树转换为中间表示 (intermediate representation, IR), 并在此基础上完成一些机器无关优化.</li>
<li><strong>后端:</strong> 将中间表示转换为目标平台的汇编代码, 并在此基础上完成一些机器相关优化.</li>
</ul>
<p>在前端中, 我们的目的是把文本形式的源代码, 转换为内存中的一种树形的数据结构. 因为相比于处理字符串, 在树形结构上进行处理显然要更方便, 且效率更高. 把文本形式的源代码变成数据结构形式的 AST 有很多种方法, 但相对科学的方法是对源代码进行词法分析和语法分析.</p>
<p>而语法分析的目的, 按照程序的语法规则, 将输入的 token 流变成程序的 AST. 例如, 对于 SysY 程序, 关键字 <code>int</code> 后跟的一定是一个标识符, 而不可能是一个整数字面量, 这便是语法规则. Parser 会通过某些语法分析算法, 例如 LL 分析法或 LR 分析法, 对 token 流做一系列的分析, 并最终得到 AST.</p>
<p>语义分析阶段, 编译器通常会:</p>
<ul>
<li><strong>建立符号表</strong>, 跟踪程序里变量的声明和使用, 确定程序在某处用到了哪一个变量, 同时也可发现变量重复定义/引用未定义变量之类的错误.</li>
<li><strong>进行类型检查</strong>, 确定程序中是否存在诸如 “对整数变量进行数组访问” 这种类型问题. 同时标注程序中表达式的类型, 以便进行后续的生成工作. 对于某些编程语言 (例如 C++11 之后的 C++, Rust 等等), 编译器还会进行类型推断.</li>
<li><strong>进行必要的编译期计算</strong>. SysY 中支持使用常量表达式作为数组定义时的长度, 而我们在生成 IR 之前, 必须知道数组的长度 (SysY 不支持 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Variable-length_array">VLA</a>), 这就要求编译器必须能在编译的时候算出常量表达式的值, 同时对那些无法计算的常量表达式报错. 对于某些支持元编程的语言, 这一步可能会非常复杂.</li>
</ul>
<p>至此, 我们就能得到一个语法正确, 语义清晰的 AST 表示了.</p>
<p>编译器通常不会直接通过扫描 AST 来生成目标代码 (汇编)——当然这么做也不是不可以, 因为从定义上讲, AST 也是一种 “中间表示”. 只不过, AST 在形式上更接近源语言, 而且其中可能会包含一些更为高级的语义, 例如分支/循环, 甚至结构体/类等等, 这些内容要一步到位变成汇编还是比较复杂的.</p>
<p>所以, 编译器通常会将 AST 转换为另一种形式的数据结构, 我们把它称作 IR. IR 的抽象层次比 AST 更低, 但又不至于低到汇编代码的程度. 在此基础上, 无论是直接把 IR 进一步转换为汇编代码, 还是在 IR 之上做出一些优化, 都相对更容易.</p>
<p>有了 IR 的存在, 我们也可以大幅降低编译器的开发成本: 假设我们想开发 MM 种语言的编译器, 要求它们能把输入编译成 NN 种指令系统的目标代码, 在没有统一的 IR 的情况下, 我们需要开发 M \times NM×N 个相关模块. 如果我们先把所有源语言都转换到同一种 IR, 然后再将这种 IR 翻译为不同的目标代码, 我们就只需要开发 M + NM+N 个相关模块.</p>
<p>现实世界的确存在这样的操作, 例如 <a target="_blank" rel="noopener" href="https://llvm.org/docs/">LLVM IR</a> 就是一种被广泛使用的 IR. 有很多语言的编译器实现, 例如 Rust, Swift, Julia, 都会将源语言翻译到 LLVM IR. 同时, LLVM IR 可被生成为 x86, ARM, RISC-V 等一系列指令系统的目标代码. 此时, 编译器的前后端是完全解耦的, 两部分可以各自维护, 十分方便.</p>
<p>此外, IR 也可以极大地方便开发者调试自己的编译器. 在编译实践中, 你的编译器对于同一个 SysY 文件的输入, 既可以输出 Koopa IR, 也可以输出 RISC-V. 你可以借助相关测试工具来测试这两部分的正确性, 进而定位你的编译器到底是在前端/中端部分出了问题, 还是在后端的部分出了问题.</p>
<p>编译器进行的最后一步操作, 就是将 IR 转换为目标代码, 也就是目标指令系统的汇编代码. 通常情况下, 这一步通常要做以下几件事:</p>
<ol>
<li><strong>指令选择:</strong> 决定 IR 中的指令应该被翻译为哪些目标指令系统的指令. 例如前文的 Koopa IR 程序中出现的 <code>lt</code> 指令可以被翻译为 RISC-V 中的 <code>slt</code>/<code>slti</code> 指令.</li>
<li><strong>寄存器分配:</strong> 决定 IR 中的值和指令系统中寄存器的对应关系. 例如前文的 Koopa IR 程序中的 <code>@x</code>, <code>%cond</code>, <code>%0</code> 等等, 它们最终可能会被放在 RISC-V 的某些寄存器中. 由于指令系统中寄存器的数量通常是有限的 (RISC-V 中只有 32 个整数通用寄存器, 且它们并不都能用来存放数据), 某些值还可能会被分配在内存中.</li>
<li><strong>指令调度:</strong> 决定 IR 生成的指令序列最终的顺序如何. 我们通常希望编译器能生成一个最优化的指令序列, 它可以最大程度地利用目标平台的微结构特性, 这样生成的程序的性能就会很高. 例如编译器可能会穿插调度访存指令和其他指令, 以求减少访存导致的停顿.</li>
</ol>
<p>EBNF, 即 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Extended_Backus–Naur_form">Extended Backus–Naur Form</a>, 扩展巴科斯范式, 可以用来描述编程语言的语法. 基于 SysY 的 EBNF, 我们可以从开始符号出发, 推导出任何一个符合 SysY 语法定义的 SysY 程序. </p>
<p>makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># C++ 模式</span></span><br><span class="line">flex -o 文件名.lex.cpp 文件名.l</span><br><span class="line">bison -d -o 文件名.tab.cpp 文件名.y   <span class="comment"># 此时 bison 还会生成 `文件名.tab.hpp`</span></span><br><span class="line"><span class="comment"># C 模式</span></span><br><span class="line">flex -o 文件名.lex.c 文件名.l</span><br><span class="line">bison -d -o 文件名.tab.c 文件名.y     <span class="comment"># 此时 bison 还会生成 `文件名.tab.h`</span></span><br></pre></td></tr></table></figure>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%option noyywrap</span></span><br><span class="line"><span class="comment">%option nounput</span></span><br><span class="line"><span class="comment">%option noinput</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="params">#</span>include &lt;cstdlib&gt;</span><br><span class="line"><span class="params">#</span>include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">// 因为 Flex 会用到 Bison 中关于 token 的定义</span><br><span class="line">// 所以需要 include Bison 生成的头文件</span><br><span class="line"><span class="params">#</span>include &quot;sysy.tab.hpp&quot;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line"><span class="comment">%&#125;</span></span><br><span class="line"></span><br><span class="line">/* 空白符和注释 */</span><br><span class="line">WhiteSpace    [ <span class="keyword">\t</span><span class="keyword">\n</span><span class="keyword">\r</span>]*</span><br><span class="line">LineComment   &quot;//&quot;.*<span class="built_in">$</span></span><br><span class="line"></span><br><span class="line">/* 标识符 */</span><br><span class="line">Identifier    [a-zA-Z<span class="built_in">_</span>][a-zA-Z0-9<span class="built_in">_</span>]*</span><br><span class="line"></span><br><span class="line">/* 整数字面量 */</span><br><span class="line">Decimal       [1-9][0-9]*</span><br><span class="line">Octal         0[0-7]*</span><br><span class="line">Hexadecimal   0[xX][0-9a-fA-F]+</span><br><span class="line"></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br><span class="line">&#123;WhiteSpace&#125;    &#123; /* 忽略, 不做任何操作 */ &#125;</span><br><span class="line">&#123;LineComment&#125;   &#123; /* 忽略, 不做任何操作 */ &#125;</span><br><span class="line"></span><br><span class="line">&quot;int&quot;           &#123; return INT; &#125;</span><br><span class="line">&quot;return&quot;        &#123; return RETURN; &#125;</span><br><span class="line"></span><br><span class="line">&#123;Identifier&#125;    &#123; yylval.str<span class="built_in">_</span>val = new string(yytext); return IDENT; &#125;</span><br><span class="line"></span><br><span class="line">&#123;Decimal&#125;       &#123; yylval.int<span class="built_in">_</span>val = strtol(yytext, nullptr, 0); return INT<span class="built_in">_</span>CONST; &#125;</span><br><span class="line">&#123;Octal&#125;         &#123; yylval.int<span class="built_in">_</span>val = strtol(yytext, nullptr, 0); return INT<span class="built_in">_</span>CONST; &#125;</span><br><span class="line">&#123;Hexadecimal&#125;   &#123; yylval.int<span class="built_in">_</span>val = strtol(yytext, nullptr, 0); return INT<span class="built_in">_</span>CONST; &#125;</span><br><span class="line"></span><br><span class="line">.               &#123; return yytext[0]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>文件最开头我们设置了一些选项, 你可以 RTFM 这些选项的含义. 如果不设置这些选项, Flex 就会要求我们在代码里定义一些额外的东西, 但我们实际上用不到这些东西.</li>
<li>第二部分声明了必要的头文件, 然后是经典的 <code>using namespace std</code>.</li>
<li>第三部分定义了一些正则表达式的规则, 比如空白符, 行注释等等. 这些规则其实直接写在第四部分也可以, 但那样太乱了, 还是给它们起个名字比较好理解一些.</li>
<li>第四部分定义了 lexer 的行为:<ul>
<li>遇到空白符和注释就跳过.</li>
<li>遇到 <code>int</code>, <code>return</code> 这种关键字就返回对应的 token.</li>
<li>遇到标识符就把标识符存起来, 然后返回对应的 token. <code>yytext</code> 代表 lexer 当前匹配到的字符串的内容, 它的类型是 <code>char *</code>, 在此处对应读取到的一个标识符. <code>yylval</code> 用来向 parser 传递 lexer 读取到的内容, <code>str_val</code> 和之后的 <code>int_val</code> 是我们在 Bison 文件中定义的字段, 之后再解释.</li>
<li>遇到整数字面量, 先把读取到的字符串转换成整数, 然后存起来, 并返回对应的 token.</li>
<li>遇到单个字符, 就直接返回单个字符作为 token. <code>.</code> 这个正则表达式会匹配任意单个字符, 而 <code>yytext[0]</code> 实际上读取了目前匹配到的这个字符. 在 Flex/Bison 中, token 实际就是整数, 之前出现的 <code>INT</code>, <code>RETURN</code>, <code>IDENT</code> 等, 其实是 Bison 根据我们的定义生成的枚举 (<code>enum</code>). 所以此处相当于, 我们取了当前匹配到的字符, 然后把它转成了整数, 交给 Bison 生成的 parser 处理. 在 Bison 里, 我们可以直接通过写字符 (比如 <code>&#39;(&#39;</code>), 来表示我们希望匹配 lexer 返回的一个字符转换得到的 token.</li>
</ul>
</li>
</ul>
<p>由于在<strong>union</strong>里也不允许存放带有构造函数、析构函数和复制构造函数等的类的对象，但是可以存放对应的类对象指针。</p>
<h1 id="pragma-once一般由编译器提供保证：同一个文件不会被包含多次。这里所说的”同一个文件”是指物理上的一个文件，而不是指内容相同的两个文件。无法对一个头文件中的一段代码作-pragma-once声明，而只能针对文件。此方式不会出现宏名碰撞引发的奇怪问题，大型项目的编译速度也因此提供了一些。缺点是如果某个头文件有多份拷贝，此方法不能保证它们不被重复包含。在C-C-中，-pragma-once是一个非标准但是被广泛支持的方式。"><a href="#pragma-once一般由编译器提供保证：同一个文件不会被包含多次。这里所说的”同一个文件”是指物理上的一个文件，而不是指内容相同的两个文件。无法对一个头文件中的一段代码作-pragma-once声明，而只能针对文件。此方式不会出现宏名碰撞引发的奇怪问题，大型项目的编译速度也因此提供了一些。缺点是如果某个头文件有多份拷贝，此方法不能保证它们不被重复包含。在C-C-中，-pragma-once是一个非标准但是被广泛支持的方式。" class="headerlink" title="pragma once一般由编译器提供保证：同一个文件不会被包含多次。这里所说的”同一个文件”是指物理上的一个文件，而不是指内容相同的两个文件。无法对一个头文件中的一段代码作#pragma once声明，而只能针对文件。此方式不会出现宏名碰撞引发的奇怪问题，大型项目的编译速度也因此提供了一些。缺点是如果某个头文件有多份拷贝，此方法不能保证它们不被重复包含。在C/C++中，#pragma once是一个非标准但是被广泛支持的方式。"></a>pragma once一般由编译器提供保证：同一个文件不会被包含多次。这里所说的”同一个文件”是指物理上的一个文件，而不是指内容相同的两个文件。无法对一个头文件中的一段代码作#pragma once声明，而只能针对文件。此方式不会出现宏名碰撞引发的奇怪问题，大型项目的编译速度也因此提供了一些。缺点是如果某个头文件有多份拷贝，此方法不能保证它们不被重复包含。在C/C++中，#pragma once是一个非标准但是被广泛支持的方式。</h1><pre><code>    #pragma once方式产生于#ifndef之后。#ifndef方式受C/C++语言标准的支持，不受编译器的任何限制；而#pragma once方式有些编译器不支持(较老编译器不支持，如GCC 3.4版本之前不支持#pragmaonce)，兼容性不够好。#ifndef可以针对一个文件中的部分代码，而#pragma once只能针对整个文件。相对而言，#ifndef更加灵活，兼容性好，#pragma once操作简单，效率高。
</code></pre><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%code requires &#123;</span></span><br><span class="line">  <span class="params">#</span>include &lt;memory&gt;</span><br><span class="line">  <span class="params">#</span>include &lt;string&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">%&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="params">#</span>include &lt;iostream&gt;</span><br><span class="line"><span class="params">#</span>include &lt;memory&gt;</span><br><span class="line"><span class="params">#</span>include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">// 声明 lexer 函数和错误处理函数</span><br><span class="line">int yylex();</span><br><span class="line">void yyerror(std::unique<span class="built_in">_</span>ptr&lt;std::string&gt; <span class="built_in">&amp;</span>ast, const char *s);</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line"><span class="comment">%&#125;</span></span><br><span class="line"></span><br><span class="line">// 定义 parser 函数和错误处理函数的附加参数</span><br><span class="line">// 我们需要返回一个字符串作为 AST, 所以我们把附加参数定义成字符串的智能指针</span><br><span class="line">// 解析完成后, 我们要手动修改这个参数, 把它设置成解析得到的字符串</span><br><span class="line"><span class="comment">%parse-param &#123; std::unique_ptr&lt;std::string&gt; &amp;ast &#125;</span></span><br><span class="line"></span><br><span class="line">// yylval 的定义, 我们把它定义成了一个联合体 (union)</span><br><span class="line">// 因为 token 的值有的是字符串指针, 有的是整数</span><br><span class="line">// 之前我们在 lexer 中用到的 str<span class="built_in">_</span>val 和 int<span class="built_in">_</span>val 就是在这里被定义的</span><br><span class="line">// 至于为什么要用字符串指针而不直接用 string 或者 unique<span class="built_in">_</span>ptr&lt;string&gt;?</span><br><span class="line">// 请自行 STFW 在 union 里写一个带析构函数的类会出现什么情况</span><br><span class="line"><span class="comment">%union &#123;</span></span><br><span class="line">  std::string *str<span class="built_in">_</span>val;</span><br><span class="line">  int int<span class="built_in">_</span>val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// lexer 返回的所有 token 种类的声明</span><br><span class="line">// 注意 IDENT 和 INT<span class="built_in">_</span>CONST 会返回 token 的值, 分别对应 str<span class="built_in">_</span>val 和 int<span class="built_in">_</span>val</span><br><span class="line"><span class="comment">%token INT RETURN</span></span><br><span class="line"><span class="comment">%token &lt;str_val&gt; IDENT</span></span><br><span class="line"><span class="comment">%token &lt;int_val&gt; INT_CONST</span></span><br><span class="line"></span><br><span class="line">// 非终结符的类型定义</span><br><span class="line"><span class="comment">%type &lt;str_val&gt; FuncDef FuncType Block Stmt Number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br><span class="line">// 开始符, CompUnit ::= FuncDef, 大括号后声明了解析完成后 parser 要做的事情</span><br><span class="line">// 之前我们定义了 FuncDef 会返回一个 str<span class="built_in">_</span>val, 也就是字符串指针</span><br><span class="line">// 而 parser 一旦解析完 CompUnit, 就说明所有的 token 都被解析了, 即解析结束了</span><br><span class="line">// 此时我们应该把 FuncDef 返回的结果收集起来, 作为 AST 传给调用 parser 的函数</span><br><span class="line">// <span class="built_in">$</span>1 指代规则里第一个符号的返回值, 也就是 FuncDef 的返回值</span><br><span class="line">CompUnit</span><br><span class="line">  : FuncDef &#123;</span><br><span class="line">    ast = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>1);</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">// FuncDef ::= FuncType IDENT &#x27;(&#x27; &#x27;)&#x27; Block;</span><br><span class="line">// 我们这里可以直接写 &#x27;(&#x27; 和 &#x27;)&#x27;, 因为之前在 lexer 里已经处理了单个字符的情况</span><br><span class="line">// 解析完成后, 把这些符号的结果收集起来, 然后拼成一个新的字符串, 作为结果返回</span><br><span class="line">// <span class="built_in">$</span><span class="built_in">$</span> 表示非终结符的返回值, 我们可以通过给这个符号赋值的方法来返回结果</span><br><span class="line">// 你可能会问, FuncType, IDENT 之类的结果已经是字符串指针了</span><br><span class="line">// 为什么还要用 unique<span class="built_in">_</span>ptr 接住它们, 然后再解引用, 把它们拼成另一个字符串指针呢</span><br><span class="line">// 因为所有的字符串指针都是我们 new 出来的, new 出来的内存一定要 delete</span><br><span class="line">// 否则会发生内存泄漏, 而 unique<span class="built_in">_</span>ptr 这种智能指针可以自动帮我们 delete</span><br><span class="line">// 虽然此处你看不出用 unique<span class="built_in">_</span>ptr 和手动 delete 的区别, 但当我们定义了 AST 之后</span><br><span class="line">// 这种写法会省下很多内存管理的负担</span><br><span class="line">FuncDef</span><br><span class="line">  : FuncType IDENT &#x27;(&#x27; &#x27;)&#x27; Block &#123;</span><br><span class="line">    auto type = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>1);</span><br><span class="line">    auto ident = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>2);</span><br><span class="line">    auto block = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>5);</span><br><span class="line">    <span class="built_in">$</span><span class="built_in">$</span> = new string(*type + &quot; &quot; + *ident + &quot;() &quot; + *block);</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">// 同上, 不再解释</span><br><span class="line">FuncType</span><br><span class="line">  : INT &#123;</span><br><span class="line">    <span class="built_in">$</span><span class="built_in">$</span> = new string(&quot;int&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">Block</span><br><span class="line">  : &#x27;&#123;&#x27; Stmt &#x27;&#125;&#x27; &#123;</span><br><span class="line">    auto stmt = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>2);</span><br><span class="line">    <span class="built_in">$</span><span class="built_in">$</span> = new string(&quot;&#123; &quot; + *stmt + &quot; &#125;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">Stmt</span><br><span class="line">  : RETURN Number &#x27;;&#x27; &#123;</span><br><span class="line">    auto number = unique<span class="built_in">_</span>ptr&lt;string&gt;(<span class="built_in">$</span>2);</span><br><span class="line">    <span class="built_in">$</span><span class="built_in">$</span> = new string(&quot;return &quot; + *number + &quot;;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">Number</span><br><span class="line">  : INT<span class="built_in">_</span>CONST &#123;</span><br><span class="line">    <span class="built_in">$</span><span class="built_in">$</span> = new string(to<span class="built_in">_</span>string(<span class="built_in">$</span>1));</span><br><span class="line">  &#125;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line"><span class="comment">%%</span></span><br><span class="line"></span><br><span class="line">// 定义错误处理函数, 其中第二个参数是错误信息</span><br><span class="line">// parser 如果发生错误 (例如输入的程序出现了语法错误), 就会调用这个函数</span><br><span class="line">void yyerror(unique<span class="built_in">_</span>ptr&lt;string&gt; <span class="built_in">&amp;</span>ast, const char *s) &#123;</span><br><span class="line">  cerr &lt;&lt; &quot;error: &quot; &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置一些必要的选项, 比如 <code>%code requires</code>.</li>
<li>引用头文件, 声明 lexer 函数和错误处理函数. 如果不声明这些函数的话, parser 会找不到 Flex 中定义的 lexer, 也没办法正常报错.</li>
<li>定义 parser 函数的参数. Bison 生成的 parser 函数返回类型一定是 <code>int</code>, 所以我们没办法通过返回值返回 AST, 所以只能通过参数来返回 AST 了. 当然你也可以通过全局变量来返回 AST, 但, 那样做很 dirty (如果你接触过函数式编程或了解软件工程技术的话).</li>
<li>定义了 <code>yylval</code>, token 和非终结符的类型.</li>
<li>定义了语法规则, 同时定义了 parser 解析完语法规则之后执行的操作.</li>
<li>定义了错误处理函数.</li>
</ul>
<p>这里主要涉及到flex和bison的知识,这个可能要看一会.</p>
<h3 id="设计AST"><a href="#设计AST" class="headerlink" title="设计AST"></a>设计AST</h3><p>设计 AST 这件事其实很简单, 你首先要知道:</p>
<ol>
<li>AST 保留了程序语法的结构.</li>
<li>AST 是为了方便程序的处理而存在的, 不存在什么设计规范</li>
</ol>
<p>注意%token是终结符,而其他的是非终结符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%type &lt;str_val&gt; FuncDef FuncType Block Stmt Number</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> *str_val;</span><br><span class="line">  <span class="keyword">int</span> int_val;</span><br><span class="line">  BaseAST *ast_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改yylval类型.</p>
<p>生成了AST后,继续生成IR.</p>
<p>一旦完成了 IR 的生成, 你的编译器就已经初步成型了. 因为有一些基础设施的存在, 比如 LLVM IR, 现代的很多编译器都只会进行到 IR 生成这一步, 然后把后续的工作交给这些基础设施完成.</p>
<ul>
<li>编译器首先会对源代码做词法/语法分析, 生成 AST.</li>
<li>然后在 AST 上进行语义分析, 建立符号表, 做类型检查, 报告语义错误, 等等.</li>
<li>接着, 遍历语义分析后的 AST, 生成 IR.</li>
</ul>
<p>我们会在每章的<a target="_blank" rel="noopener" href="https://pku-minic.github.io/online-doc/#/lv1-main/">开头</a>给出本章涉及内容的语法规范和语义规范. 一个功能完备的编译器应该能够检查输入程序是否符合语义规范, 并在发生语义错误时报错.</p>
<p>不过, 在课程实践中, 所有的测试用例均为符合语法/语义规范的 SysY 程序. <strong>我们不要求你编写的编译器具备处理语法/语义错误的能力, 也不会考察这些内容.</strong> 但我们希望学有余力的同学, 能够在自己的编译器中检查这些问题, 并对其作出合适的处理, 比如像 <code>clang</code> 或 <code>rustc</code> 一样, 给出精确到行列的错误信息, 甚至具备忽略错误继续扫描, 以及对错误给出修改建议的高级功能.</p>
<p>Koopa IR 中, 最大的单位是 <code>Program</code>, 它代表一个 Koopa IR 程序. <code>Program</code> 由若干全局变量 (<code>Value</code>) 和函数 (<code>Function</code>) 构成. <code>Function</code> 又由若干基本块 (<code>BasicBlock</code>) 构成, 基本块中是一系列指令, 指令也是 <code>Value</code>. 所以 Koopa IR 程序的结构如下所示:</p>
<ul>
<li>```<br>Program<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-<span class="ruby"> 全局变量列表:</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line">  -<span class="ruby"> <span class="string">`Value`</span> <span class="number">1</span>.</span></span><br><span class="line"><span class="ruby"></span>  -<span class="ruby"> <span class="string">`Value`</span> <span class="number">2</span>.</span></span><br><span class="line"><span class="ruby"></span>  -<span class="ruby"> …</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line">-<span class="ruby"> 函数列表:</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line">  -<span class="ruby"> <span class="string">``</span><span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="ruby"></span></span>    Function</span><br></pre></td></tr></table></figure>
</li>
</ul>
<pre><code>  1.

  - 基本块列表:

    - ```
      BasicBlock
      <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">           </span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">          1.</span></span><br><span class="line"></span><br><span class="line">          - 指令列表:</span><br><span class="line"><span class="bullet">            -</span> <span class="code">`Value`</span> 1.</span><br><span class="line"><span class="bullet">            -</span> <span class="code">`Value`</span> 2.</span><br><span class="line"><span class="bullet">            -</span> …</span><br><span class="line"></span><br><span class="line"><span class="bullet">        -</span> <span class="code">`BasicBlock`</span> 2.</span><br><span class="line"></span><br><span class="line"><span class="bullet">        -</span> …</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="code">`Function`</span> 2.</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> …</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**各类常量:**</span> 整数常量 (<span class="code">`Integer`</span>), 零初始化器 (<span class="code">`ZeroInit`</span>), 等等.</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**参数引用:**</span> 函数参数引用 (<span class="code">`FuncArgRef`</span>) 等, 用来指代传入的参数.</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**内存分配:**</span> 全局内存分配 (<span class="code">`GlobalAlloc`</span>, 所有的全局变量都是这个玩意) 和局部内存分配 (<span class="code">`Alloc`</span>).</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**访存指令:**</span> 加载 (<span class="code">`Load`</span>) 和存储 (<span class="code">`Store`</span>).</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**指针运算:**</span> <span class="code">`GetPtr`</span> 和 <span class="code">`GetElemPtr`</span>.</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**二元运算:**</span> <span class="code">`Binary`</span>, 比如加减乘除模/比较之类的运算都属于此类.</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**控制转移:**</span> 条件分支 (<span class="code">`Branch`</span>) 和无条件跳转 (<span class="code">`Jump`</span>).</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**函数相关:**</span> 函数调用 (<span class="code">`Call`</span>) 和函数返回 (<span class="code">`Return`</span>).</span><br><span class="line"></span><br><span class="line">目标很明确了:</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 我们应该生成一个 Koopa IR 程序.</span><br><span class="line"><span class="bullet">2.</span> 程序中有一个名字叫 <span class="code">`main`</span> 的函数.</span><br><span class="line"><span class="bullet">3.</span> 函数里有一个入口基本块.</span><br><span class="line"><span class="bullet">4.</span> 基本块里有一条返回指令.</span><br><span class="line"><span class="bullet">5.</span> 返回指令的返回值就是 SysY 里 <span class="code">`return`</span> 语句后跟的值, 也就是一个整数常量.</span><br><span class="line"></span><br><span class="line"> Koopa IR 目前有两种形式:</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> <span class="strong">**文本形式:**</span> 就是你在前文见到的字符串形式, 方便人类阅读.</span><br><span class="line"><span class="bullet">2.</span> <span class="strong">**内存形式:**</span> 即数据结构的形式, 你可以把它理解为另一种 “AST”, 方便程序处理.</span><br><span class="line"></span><br><span class="line">你的编译器输出的文本形式 IR, 最终会被 Koopa IR 的相关工具 (比如 <span class="code">`koopac`</span>) 读取, 变成内存形式的 IR, 然后作进一步处理. Koopa IR 的框架也提供了在两种形式的 IR 之间互相转换的接口.</span><br><span class="line"></span><br><span class="line">所以, 考虑到上述情况, 你有以下几种生成 IR 的思路:</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 遍历 AST, 输出文本形式的 IR. 这样最简单, 适用于任何语言实现的编译器.</span><br><span class="line"><span class="bullet">-</span> 调用 Koopa IR 框架提供的接口. 使用 Rust 的同学可以尝试, 详见 Koopa IR 框架的 [<span class="string">crates.io</span>](<span class="link">https://crates.io/crates/koopa</span>) 以及[<span class="string">文档</span>](<span class="link">https://docs.rs/koopa</span>).</span><br><span class="line"><span class="bullet">-</span> 像定义 AST 一样定义表示 Koopa IR 的数据结构 (比如指令/基本块/函数等等), 然后遍历 AST 输出这种结构, 再遍历这种结构输出字符串.</span><br><span class="line"><span class="bullet">-</span> 对于使用 C/C++ 的同学, 在上一条的基础上, 你可以考虑把这种结构转换成 raw program, 然后使用 <span class="code">`libkoopa`</span> 中的相关接口, 将 raw program 转换成其他形式的 Koopa IR 程序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第一种思路可能是大部分同学会采用的思路, 因为它相当简单且直观, 实现难度很低. 但其缺点是, 你在生成目标代码之前, 不得不再次将文本形式的 Koopa IR 转换成某种数据结构——这相当于再写一个编译器. 否则, 你的程序几乎无法直接基于文本形式 IR 生成汇编.</span><br><span class="line"></span><br><span class="line">不过好在, 我们为大家提供了能够处理 Koopa IR 的库, 你可以使用其中的实现, 来将文本形式的 IR 转换为内存形式.</span><br><span class="line"></span><br><span class="line"><span class="code">```c</span></span><br><span class="line"><span class="code">// 解析字符串 str, 得到 Koopa IR 程序</span></span><br><span class="line"><span class="code">koopa_program_t program;</span></span><br><span class="line"><span class="code">koopa_error_code_t ret = koopa_parse_from_string(str, &amp;program);</span></span><br><span class="line"><span class="code">assert(ret == KOOPA_EC_SUCCESS);  // 确保解析时没有出错</span></span><br><span class="line"><span class="code">// 创建一个 raw program builder, 用来构建 raw program</span></span><br><span class="line"><span class="code">koopa_raw_program_builder_t builder = koopa_new_raw_program_builder();</span></span><br><span class="line"><span class="code">// 将 Koopa IR 程序转换为 raw program</span></span><br><span class="line"><span class="code">koopa_raw_program_t raw = koopa_build_raw_program(builder, program);</span></span><br><span class="line"><span class="code">// 释放 Koopa IR 程序占用的内存</span></span><br><span class="line"><span class="code">koopa_delete_program(program);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">// 处理 raw program</span></span><br><span class="line"><span class="code">// ...</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">// 处理完成, 释放 raw program builder 占用的内存</span></span><br><span class="line"><span class="code">// 注意, raw program 中所有的指针指向的内存均为 raw program builder 的内存</span></span><br><span class="line"><span class="code">// 所以不要在 raw program 处理完毕之前释放 builder</span></span><br><span class="line"><span class="code">koopa_delete_raw_program_builder(builder);</span></span><br></pre></td></tr></table></figure>
</code></pre><ul>
<li>最上层是 <code>koopa_raw_program_t</code>, 也就是 <code>Program</code>.</li>
<li>之下是全局变量定义列表和函数定义列表.<ul>
<li>在 raw program 中, 列表的类型是 <code>koopa_raw_slice_t</code>.</li>
<li>本质上这是一个指针数组, 其中的 <code>buffer</code> 字段记录了指针数组的地址 (类型是 <code>const void **</code>), <code>len</code> 字段记录了指针数组的长度, <code>kind</code> 字段记录了数组元素是何种类型的指针</li>
<li>在访问时, 你可以通过 <code>slice.buffer[i]</code> 拿到列表元素的指针, 然后通过判断 <code>kind</code> 来决定把这个指针转换成什么类型.</li>
</ul>
</li>
<li><code>koopa_raw_function_t</code> 代表函数, 其中是基本块列表.</li>
<li><code>koopa_raw_basic_block_t</code> 代表基本块, 其中是指令列表.</li>
<li><code>koopa_raw_value_t</code> 代表全局变量, 或者基本块中的指令.</li>
</ul>
<p>现在卡在了ast生成IR,根据教程貌似需要遍历ast.也就是遍历类似树的结构.当然方法也不知这一种.我从网上copy了一份代码阅读阅读.</p>
<h3 id="代码鉴赏"><a href="#代码鉴赏" class="headerlink" title="代码鉴赏"></a>代码鉴赏</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*****************************************************</span></span><br><span class="line"><span class="comment"> *  Definition of the AST nodes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Please read the description of each class for details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Keltin Leung </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __MIND_AST__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MIND_AST__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;define.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// the prefix of an ast attribution</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ATTR(x) ast_attr_##x##_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mind &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIND_AST_DEFINED</span></span><br><span class="line"><span class="keyword">namespace</span> ast &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The base class of all AST nodes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Don&#x27;t instantiate this class.</span></span><br><span class="line"><span class="comment"> *       Please read the description of the subclasses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ASTNode</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// types of the AST nodes</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">        ADD_EXPR,</span><br><span class="line">        AND_EXPR,</span><br><span class="line">        ASSIGN_EXPR,</span><br><span class="line">        BOOL_CONST,</span><br><span class="line">        BIT_NOT_EXPR,</span><br><span class="line">        BOOL_TYPE,</span><br><span class="line">        BREAK_STMT,</span><br><span class="line">        CONTINUE_STMT,</span><br><span class="line">        CALL_EXPR,</span><br><span class="line">        COMP_STMT,</span><br><span class="line">        DIV_EXPR,</span><br><span class="line">        EQU_EXPR,</span><br><span class="line">        EMPTY_STMT,</span><br><span class="line">        EXPR_STMT,</span><br><span class="line">        FUNC_DEFN,</span><br><span class="line">        GEQ_EXPR,</span><br><span class="line">        GRT_EXPR,</span><br><span class="line">        IF_STMT,</span><br><span class="line">        IF_EXPR,</span><br><span class="line">        INT_CONST,</span><br><span class="line">        INT_TYPE,</span><br><span class="line">        LEQ_EXPR,</span><br><span class="line">        LES_EXPR,</span><br><span class="line">        LVALUE_EXPR,</span><br><span class="line">        MOD_EXPR,</span><br><span class="line">        MUL_EXPR,</span><br><span class="line">        NEG_EXPR,</span><br><span class="line">        NEQ_EXPR,</span><br><span class="line">        NOT_EXPR,</span><br><span class="line">        OR_EXPR,</span><br><span class="line">        PROGRAM,</span><br><span class="line">        RETURN_STMT,</span><br><span class="line">        SUB_EXPR,</span><br><span class="line">        VAR_DECL,</span><br><span class="line">        VAR_REF,</span><br><span class="line">        WHILE_STMT,</span><br><span class="line">        FOR_STMT,</span><br><span class="line">        FOD,</span><br><span class="line">        INDEX_EXPR</span><br><span class="line">    &#125; NodeType; <span class="comment">// 定义了一个，枚举类型  ast节点类型 </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// names of each kind of the AST nodes</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *node_name[];  </span><br><span class="line">    <span class="comment">// kind of this node</span></span><br><span class="line">    NodeType kind;  <span class="comment">//上面声明的节点类型</span></span><br><span class="line">    <span class="comment">// position in the source text</span></span><br><span class="line">    Location *loc; <span class="comment">//在另一各文件中声明的  是一个结构体 有构造函数  表示ast节点位置</span></span><br><span class="line">    <span class="comment">// for subclass constructors only</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setBasicInfo</span><span class="params">(NodeType, Location *)</span></span>; <span class="comment">//she</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// gets the node kind</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> NodeType <span class="title">getKind</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">    <span class="comment">// gets the location</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Location *<span class="title">getLocation</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">    <span class="comment">// prints to the specified output stream</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">    <span class="comment">// for Visitor</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// remember: let alone the memory deallocation stuff</span></span><br><span class="line">    <span class="keyword">virtual</span> ~ASTNode(<span class="keyword">void</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> *   it is purely an interface.</span></span><br><span class="line"><span class="comment"> * IMPLEMENTATION:</span></span><br><span class="line"><span class="comment"> *   IntType, BoolType, ArrayType</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Type</span> :</span> <span class="keyword">public</span> ASTNode &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function">type::Type *<span class="title">ATTR</span><span class="params">(type)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> *   it is purely an interface.</span></span><br><span class="line"><span class="comment"> * IMPLEMENTATION:</span></span><br><span class="line"><span class="comment"> *   AssignStmt, ReturnStmt,</span></span><br><span class="line"><span class="comment"> *   IfStmt, WhileStmt,</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Statement</span> :</span> <span class="keyword">public</span> ASTNode &#123; <span class="comment">/* pure interface */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an expression.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> *   it is purely an interface.</span></span><br><span class="line"><span class="comment"> * IMPLEMENTATION:</span></span><br><span class="line"><span class="comment"> *   ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    EmptyStmt(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Expr</span> :</span> <span class="keyword">public</span> ASTNode &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function">type::Type *<span class="title">ATTR</span><span class="params">(type)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">    <span class="function">tac::Temp <span class="title">ATTR</span><span class="params">(val)</span></span>;    <span class="comment">// for tac generation</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a left-value expression (lvalue).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> *   it is purely an interface.</span></span><br><span class="line"><span class="comment"> * IMPLEMENTATION:</span></span><br><span class="line"><span class="comment"> *   VarRef, ArrayRef</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lvalue</span> :</span> <span class="keyword">public</span> ASTNode &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">        SIMPLE_VAR, <span class="comment">// referencing simple variable</span></span><br><span class="line">        ARRAY_ELE   <span class="comment">// referencing array element</span></span><br><span class="line">    &#125; ATTR(lv_kind);</span><br><span class="line"></span><br><span class="line">    <span class="function">type::Type *<span class="title">ATTR</span><span class="params">(type)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a program.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (program [ FUNC_1 FUNC_2 ... FUNC_N ])</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Program</span> :</span> <span class="keyword">public</span> ASTNode &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Program(ASTNode *first, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//   FuncList* functions;</span></span><br><span class="line">    <span class="comment">//   VarList* globals;</span></span><br><span class="line">    FuncOrGlobalList *func_and_globals;</span><br><span class="line">    <span class="function">symb::Function *<span class="title">ATTR</span><span class="params">(main)</span></span>;       <span class="comment">// for semantic analysis</span></span><br><span class="line">    <span class="function">scope::GlobalScope *<span class="title">ATTR</span><span class="params">(gscope)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a variable declaration.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (var NAME TYPE)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VarDecl</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    VarDecl(<span class="built_in">std</span>::<span class="built_in">string</span> name, Type *type, Location *l);</span><br><span class="line">    VarDecl(<span class="built_in">std</span>::<span class="built_in">string</span> name, Type *type, DimList *dim, Location *l);</span><br><span class="line"></span><br><span class="line">    VarDecl(<span class="built_in">std</span>::<span class="built_in">string</span> name, Type *type, Expr *init, Location *l);</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line">    Type *type;</span><br><span class="line">    Expr *init;</span><br><span class="line">    DimList *dim;</span><br><span class="line"></span><br><span class="line">    <span class="function">symb::Variable *<span class="title">ATTR</span><span class="params">(sym)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuncDefn</span> :</span> <span class="keyword">public</span> ASTNode &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    FuncDefn(<span class="built_in">std</span>::<span class="built_in">string</span> name, Type *type, VarList *formals, StmtList *stmts,</span><br><span class="line">             Location *l);</span><br><span class="line">    FuncDefn(<span class="built_in">std</span>::<span class="built_in">string</span> name, Type *type, VarList *formals, EmptyStmt *empty,</span><br><span class="line">             Location *l);</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line">    Type *ret_type;</span><br><span class="line">    VarList *formals;</span><br><span class="line">    StmtList *stmts;</span><br><span class="line">    <span class="keyword">bool</span> forward_decl; <span class="comment">// is this FuncDefn a forward declaration or full</span></span><br><span class="line">                       <span class="comment">// definition?</span></span><br><span class="line">    <span class="function">symb::Function *<span class="title">ATTR</span><span class="params">(sym)</span></span>; <span class="comment">// for semantic analysis</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    CallExpr(ExprList *expr_list, <span class="built_in">std</span>::<span class="built_in">string</span> func, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> func;</span><br><span class="line">    ExprList *expr_list;</span><br><span class="line">    <span class="function">symb::Function *<span class="title">ATTR</span><span class="params">(sym)</span></span>; <span class="comment">// for tac generation</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    IndexExpr(Expr *, ExprList *, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    ExprList *expr_list;</span><br><span class="line">    <span class="function">DimList *<span class="title">ATTR</span><span class="params">(dim)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuncOrGlobal</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    FuncOrGlobal(FuncDefn *f, VarDecl *d) &#123;</span><br><span class="line">        func = f;</span><br><span class="line">        decl = d;</span><br><span class="line">    &#125;</span><br><span class="line">    FuncDefn *func; <span class="comment">// assert ( func == NULL xor decl == NULL)</span></span><br><span class="line">    VarDecl *decl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOD</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    FOD(FuncList *f, VarList *d) &#123;</span><br><span class="line">        func = f;</span><br><span class="line">        decl = d;</span><br><span class="line">    &#125;</span><br><span class="line">    FuncList *func;</span><br><span class="line">    VarList *decl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing the integer type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (itype)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntType</span> :</span> <span class="keyword">public</span> Type &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    IntType(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing the Boolean type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (btype)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoolType</span> :</span> <span class="keyword">public</span> Type &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    BoolType(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an assignment statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (assign LEFT RIGHT)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssignExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    AssignExpr(Lvalue *left, Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Lvalue *left;</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a return statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (return EXPR)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReturnStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ReturnStmt(Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a while statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (while CONDITION LOOP_BODY) </span></span><br><span class="line"><span class="comment"> *   //(for INIT COND UPDATE LOOP_BODY)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhileStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    WhileStmt(Expr *cond, Statement *loop_body, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *condition;</span><br><span class="line">    Statement *loop_body;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a for statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (while CONDITION LOOP_BODY) </span></span><br><span class="line"><span class="comment"> *   //(for INIT COND UPDATE LOOP_BODY)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ForStmt(Statement *init, Expr *cond, Expr *update, Statement *loop_body, Location *l);</span><br><span class="line">    ForStmt(Expr *init, Expr *cond, Expr *update, Statement *loop_body, Location *l);</span><br><span class="line">    ForStmt(Expr *first_condition, Statement *loop_body, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *condition, *update, *first_condition;</span><br><span class="line">    Statement *loop_body;</span><br><span class="line">    ASTNode *init;</span><br><span class="line">    <span class="function">scope::Scope *<span class="title">ATTR</span><span class="params">(scope)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an comp statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   ( &#123; StmtList &#125; )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    CompStmt(StmtList *stmts, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    StmtList *stmts;</span><br><span class="line"></span><br><span class="line">    <span class="function">scope::Scope *<span class="title">ATTR</span><span class="params">(scope)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing an if statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (if CONDITION TRUE_BRANCH FALSE_BRANCH)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IfStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    IfStmt(Expr *cond, Statement *true_branch, Statement *false_branch,</span><br><span class="line">           Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *condition;</span><br><span class="line">    Statement *true_brch;</span><br><span class="line">    Statement *false_brch;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an expression statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (expr EXPR)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExprStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ExprStmt(Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BreakStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    BreakStmt(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContinueStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ContinueStmt(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContStmt</span> :</span> <span class="keyword">public</span> Statement &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ContStmt(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing the reference to a variable.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment"> *   (object == NULL) means there is no receiver.</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (varref VAR_NAME OBJECT_EXPR)</span></span><br><span class="line"><span class="comment"> *   (varref VAR_NAME ())</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VarRef</span> :</span> <span class="keyword">public</span> Lvalue &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//	  VarRef (Expr* object, SID var_name,Location* l);</span></span><br><span class="line">    VarRef(<span class="built_in">std</span>::<span class="built_in">string</span> var_name, Location *l);</span><br><span class="line">    VarRef(<span class="built_in">std</span>::<span class="built_in">string</span> var_name, IndexExpr *expr, Location* l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *owner; <span class="comment">// only to pass compilation, not used</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> var;</span><br><span class="line">    IndexExpr *expr;</span><br><span class="line"></span><br><span class="line">    <span class="function">symb::Variable *<span class="title">ATTR</span><span class="params">(sym)</span></span>; <span class="comment">// for tac generation</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PointerRef</span> :</span> <span class="keyword">public</span> Lvalue &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    PointerRef(Expr *pointer, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *pointer;</span><br><span class="line"></span><br><span class="line">    <span class="function">symb::Variable *<span class="title">ATTR</span><span class="params">(sym)</span></span>; <span class="comment">// for tac generation</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an expression of lvalue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (lvalue REFERENCE)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LvalueExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    LvalueExpr(Lvalue *lv, Location *l);</span><br><span class="line">    <span class="comment">//   LvalueExpr (Lvalue* lv, Expr* rv,</span></span><br><span class="line">    <span class="comment">// 			  Location* l);</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Lvalue *lvalue;</span><br><span class="line">    <span class="comment">// Expr* 	 rvalue;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing an integer constant .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (iconst VALUE)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntConst</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    IntConst(<span class="keyword">int</span> value, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a Boolean constant .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (bconst VALUE)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoolConst</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    BoolConst(<span class="keyword">bool</span> value, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">bool</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing the null expression .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (null)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    NullExpr(Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an addition.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (add EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    AddExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a substraction.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (sub EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    SubExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a multiplcation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (mul EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MulExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    MulExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a division.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (div EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DivExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    DivExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a modular operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (mod EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    ModExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing a greater-than comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (grt EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GrtExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    GrtExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a greater-than-or-equal-to comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (geq EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeqExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    GeqExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a less-than comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (les EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LesExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    LesExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a less-than-or-equal-to comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (leq EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeqExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    LeqExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing an equivalence comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (equ EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EquExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    EquExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing an non-equivalence comparision.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (neq EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NeqExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    NeqExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a logical-and operation .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (and EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    AndExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a logical-or operation .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (and EXPR1 EXPR2)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    OrExpr(Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e1;</span><br><span class="line">    Expr *e2;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IfExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    IfExpr(Expr *cond, Expr *e1, Expr *e2, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *condition;</span><br><span class="line">    Expr *true_brch;</span><br><span class="line">    Expr *false_brch;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Node representing a negating operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (neg EXPR)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NegExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    NegExpr(Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing a logical-not operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (not EXPR)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    NotExpr(Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Node representing a bitwise-not operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SERIALIZED FORM:</span></span><br><span class="line"><span class="comment"> *   (bitnot EXPR)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitNotExpr</span> :</span> <span class="keyword">public</span> Expr &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    BitNotExpr(Expr *e, Location *l);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Expr *e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">bool</span> print_decorated_ast;</span><br><span class="line">&#125; <span class="comment">// namespace ast</span></span><br><span class="line">&#125; <span class="comment">// namespace mind</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __MIND_AST__</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*****************************************************</span></span><br><span class="line"><span class="comment"> *  Implementation of the &quot;ASTNode&quot; abstract class.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Keltin Leung </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ast/ast.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;config.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;location.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;options.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> mind;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> mind::ast;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Names of the AST nodes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  <span class="doctag">NOTE:</span> The order of node_name&#x27;s must be the same with that of NodeType&#x27;s.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ASTNode::node_name[] = &#123;<span class="string">&quot;add&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;and&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;assign&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;bconst&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;bitnot&quot;</span>,</span><br><span class="line"></span><br><span class="line">                                    <span class="string">&quot;btype&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;break&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;continue&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;call&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;comp&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;div&quot;</span>,</span><br><span class="line"></span><br><span class="line">                                    <span class="string">&quot;equ&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;expr&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;func&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;geq&quot;</span>,</span><br><span class="line"></span><br><span class="line">                                    <span class="string">&quot;grt&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;if&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;if&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;iconst&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;itype&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;leq&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;les&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;lvalue&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;mod&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;mul&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;neg&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;neq&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;not&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;or&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;program&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;return&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;sub&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;var&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;varref&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;while&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;for&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;FuncOrDecl&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;index&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Whether to print the decorated abstract syntax tree.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">bool</span> print_decorated_ast = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Sets the basic information of a node.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    k     - the node kind</span></span><br><span class="line"><span class="comment"> *    l     - position in the source text</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ASTNode::setBasicInfo</span><span class="params">(NodeType k, Location *l)</span> </span>&#123;</span><br><span class="line">    kind = k;</span><br><span class="line">    loc = l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Gets the node kind.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the node kind</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ASTNode::NodeType <span class="title">ASTNode::getKind</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> kind; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Gets the source text location of this node</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the source text location</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Location *<span class="title">ASTNode::getLocation</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> loc; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Dumps this node to an output stream.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ASTNode::dumpTo</span><span class="params">(<span class="built_in">std</span>::ostream &amp;os)</span> </span>&#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; node_name[kind];</span><br><span class="line">    <span class="keyword">if</span> (Option::getLevel() != Option::PARSER)</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; (&quot;</span> &lt;&lt; loc-&gt;line &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; loc-&gt;col &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    incIndent(os);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Outputs an ASTNode.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> *    p     - the ASTNode</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, ASTNode *p) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">        os &lt;&lt; <span class="string">&quot;!!NULL!!&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        p-&gt;dumpTo(os);</span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*  Outputs a FuncList.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> *    l     - the Func list</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, FuncList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        FuncList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Outputs a VarList.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> *    l     - the VarDecl list</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, VarList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        VarList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Outputs a StmtList.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> *    l     - the Statement list</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, StmtList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        StmtList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line"></span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Outputs an ExprList .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  PARAMETERS:</span></span><br><span class="line"><span class="comment"> *    os    - the output stream</span></span><br><span class="line"><span class="comment"> *    l     - the Expr list</span></span><br><span class="line"><span class="comment"> *  RETURNS:</span></span><br><span class="line"><span class="comment"> *    the output stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, ExprList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        ExprList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, DimList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        DimList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::ostream &amp;mind::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;os, FuncOrGlobalList *l) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!l-&gt;empty()) &#123;</span><br><span class="line">        incIndent(os);</span><br><span class="line">        os &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">        FuncOrGlobalList::iterator it = l-&gt;begin();</span><br><span class="line">        os &lt;&lt; *it;</span><br><span class="line">        <span class="keyword">while</span> (++it != l-&gt;end()) &#123;</span><br><span class="line"></span><br><span class="line">            newLine(os);</span><br><span class="line">            os &lt;&lt; *it;</span><br><span class="line">        &#125;</span><br><span class="line">        decIndent(os);</span><br><span class="line">        newLine(os);</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*****************************************************</span></span><br><span class="line"><span class="comment"> *  Definition of the AST visitor pattern.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  It is only an interface (we provide an empty body</span></span><br><span class="line"><span class="comment"> *  just to make your life easier..).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Keltin Leung </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __MIND_VISITOR__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MIND_VISITOR__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ast/ast.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mind &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ast &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  AST Visitor Pattern.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  HOW TO USE:</span></span><br><span class="line"><span class="comment"> *    1. Create a subclass of Visitor;</span></span><br><span class="line"><span class="comment"> *    2. Implement visit(ast::Program*)  (required);</span></span><br><span class="line"><span class="comment"> *    3. Implement the other visiting functions as you need;</span></span><br><span class="line"><span class="comment"> *    4. We provide an empty function body (&#123;  &#125;) instead of</span></span><br><span class="line"><span class="comment"> *       setting it pure (= 0) so that you do not need to</span></span><br><span class="line"><span class="comment"> *       implement all the functions as you do with a pure</span></span><br><span class="line"><span class="comment"> *       interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Visitor</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Expressions</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(CallExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(AddExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(AndExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(AssignExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IfExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(OrExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(BoolConst *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(DivExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(EquExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(GeqExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(GrtExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(NeqExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IntConst *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(LeqExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(LesExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(LvalueExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ModExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(MulExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(NegExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(NotExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(BitNotExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(SubExpr *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IndexExpr *)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lvalues</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(VarRef *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// Types</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(BoolType *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IntType *)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Statements</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ExprStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(CompStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(WhileStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ForStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(EmptyStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(BreakStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ContinueStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IfStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ReturnStmt *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// Declarations</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Program *)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(FuncDefn *)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(VarDecl *)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~Visitor() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="comment">// namespace ast</span></span><br><span class="line">&#125; <span class="comment">// namespace mind</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __MIND_VISITOR__</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>新找到一个项目,<a href="git@github.com:DoctorWkt/acwj.git">journey to compiler</a></p>
<p>这个比较好一点,我尝试照着这个做一下.可能要分几个专题.</p>
<h3 id="lexical-scanning"><a href="#lexical-scanning" class="headerlink" title="lexical scanning"></a>lexical scanning</h3><p>首先开始词法分析,主要是识别+ - * /和字面数字</p>
<blockquote>
<p>However, there will be times when we need to “put back” a character if we have read too far ahead in the input stream. We also want to track what line we are currently on so that we can print the line number in our debug messages. All of this is done by the <code>next()</code> function:</p>
</blockquote>
<p><img data-src="https://s2.loli.net/2022/05/30/kIOan4cNbL839Kf.png" alt="大致流程" style="zoom:67%;" /></p>
<h3 id="parser"><a href="#parser" class="headerlink" title="parser"></a>parser</h3><p>语法分析设计到BNF或者EBNF.需要设计AST.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AST node types</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  A_ADD, A_SUBTRACT, A_MULTIPLY, A_DIVIDE, A_INTLIT</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Abstract Syntax Tree structure</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> op;                               <span class="comment">// &quot;Operation&quot; to be performed on this tree</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> *<span class="title">left</span>;</span>                 <span class="comment">// Left and right child trees</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> *<span class="title">right</span>;</span></span><br><span class="line">  <span class="keyword">int</span> intvalue;                         <span class="comment">// For A_INTLIT, the integer value</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>defs文件新增ASTnode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> &#123;</span></span><br><span class="line">  <span class="comment">// op to be performed on this tree</span></span><br><span class="line">  <span class="comment">// e.g. A_ADD</span></span><br><span class="line">  <span class="keyword">int</span> op;</span><br><span class="line">  <span class="comment">// left and right child tree</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> *<span class="title">left</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> *<span class="title">right</span>;</span></span><br><span class="line">  <span class="keyword">int</span> intvalue; <span class="comment">//for integer</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>增加产生ast节点函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ASTnode *<span class="title">binexpr</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ASTnode</span> *<span class="title">n</span>, *<span class="title">left</span>, *<span class="title">right</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nodetype;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 左值</span></span><br><span class="line">  <span class="comment">// Get the integer literal on the left.</span></span><br><span class="line">  <span class="comment">// Fetch the next token at the same time.</span></span><br><span class="line">  left = primary();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (Token.token == _EOF)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> left;</span><br><span class="line">  &#125;</span><br><span class="line">  nodetype = tok2aop(Token.token);</span><br><span class="line"></span><br><span class="line">  scan(&amp;Token);</span><br><span class="line">  <span class="comment">// 创建右值</span></span><br><span class="line">  right = binexpr();</span><br><span class="line"></span><br><span class="line">  n = mkastnode(nodetype, left, right, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及对于ast节点赋值的一些操作.</p>
<p>还需要遍历树结构,这里采用先序遍历.</p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/EQ1024/p/15660909.html">Docker -v | volume 挂载宿主机目录导致容器内文件被覆盖问题 - 二柒席地而坐 - 博客园 (cnblogs.com)</a></p>

    </div>

    
    
    
    <div>
	
     <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
     
   </div>
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\10\03\socket学习\" rel="bookmark">socket学习</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\06\12\数据结构noj-3\" rel="bookmark">数据结构noj_3</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\05\17\数据结构noj_2\" rel="bookmark">数据结构noj_2</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\05\10\哈夫曼编-译码\" rel="bookmark">哈夫曼编/译码</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\04\29\关于指针和函数\" rel="bookmark">关于指针和函数</a></div>
    </li>
  </ul>

        <div class="reward-container">
  <div>感谢阅读.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Sekyoro 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Sekyoro
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.sekyoro.top/2022/05/06/write-a-compiler-by-yourself/" title="write_a_compiler_by_yourself">https://www.sekyoro.top/2022/05/06/write-a-compiler-by-yourself/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wxqrcode.png">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/website.png">
            <span class="icon">
              <i class="fa fa-user"></i>
            </span>

            <span class="label">PersonalWebsite</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/c/" rel="tag"><i class="fa fa-tag"></i> c</a>
              <a href="/tags/compiler/" rel="tag"><i class="fa fa-tag"></i> compiler</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/02/html%E7%B2%BE%E5%AD%A6/" rel="prev" title="html精学">
      <i class="fa fa-chevron-left"></i> html精学
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/30/acwj-01/" rel="next" title="acwj_01">
      acwj_01 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
		  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123"
     crossorigin="anonymous"></script>
<!-- 评论区 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4034523802263123"
     data-ad-slot="6333657257"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81MzE5Ny8yOTY3Mg=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
	
  <aside class="sidebar">
    <div class="sidebar-inner">
      	   
          <!-- canvas粒子时钟 -->
          <div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        

<!-- require APlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
	  
		
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B"><span class="nav-number">1.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">编译器结构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pragma-once%E4%B8%80%E8%88%AC%E7%94%B1%E7%BC%96%E8%AF%91%E5%99%A8%E6%8F%90%E4%BE%9B%E4%BF%9D%E8%AF%81%EF%BC%9A%E5%90%8C%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E4%B8%8D%E4%BC%9A%E8%A2%AB%E5%8C%85%E5%90%AB%E5%A4%9A%E6%AC%A1%E3%80%82%E8%BF%99%E9%87%8C%E6%89%80%E8%AF%B4%E7%9A%84%E2%80%9D%E5%90%8C%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E2%80%9D%E6%98%AF%E6%8C%87%E7%89%A9%E7%90%86%E4%B8%8A%E7%9A%84%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%8C%87%E5%86%85%E5%AE%B9%E7%9B%B8%E5%90%8C%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E3%80%82%E6%97%A0%E6%B3%95%E5%AF%B9%E4%B8%80%E4%B8%AA%E5%A4%B4%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E4%B8%80%E6%AE%B5%E4%BB%A3%E7%A0%81%E4%BD%9C-pragma-once%E5%A3%B0%E6%98%8E%EF%BC%8C%E8%80%8C%E5%8F%AA%E8%83%BD%E9%92%88%E5%AF%B9%E6%96%87%E4%BB%B6%E3%80%82%E6%AD%A4%E6%96%B9%E5%BC%8F%E4%B8%8D%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%AE%8F%E5%90%8D%E7%A2%B0%E6%92%9E%E5%BC%95%E5%8F%91%E7%9A%84%E5%A5%87%E6%80%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E7%9A%84%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E4%B9%9F%E5%9B%A0%E6%AD%A4%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%BA%9B%E3%80%82%E7%BC%BA%E7%82%B9%E6%98%AF%E5%A6%82%E6%9E%9C%E6%9F%90%E4%B8%AA%E5%A4%B4%E6%96%87%E4%BB%B6%E6%9C%89%E5%A4%9A%E4%BB%BD%E6%8B%B7%E8%B4%9D%EF%BC%8C%E6%AD%A4%E6%96%B9%E6%B3%95%E4%B8%8D%E8%83%BD%E4%BF%9D%E8%AF%81%E5%AE%83%E4%BB%AC%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E5%8C%85%E5%90%AB%E3%80%82%E5%9C%A8C-C-%E4%B8%AD%EF%BC%8C-pragma-once%E6%98%AF%E4%B8%80%E4%B8%AA%E9%9D%9E%E6%A0%87%E5%87%86%E4%BD%86%E6%98%AF%E8%A2%AB%E5%B9%BF%E6%B3%9B%E6%94%AF%E6%8C%81%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82"><span class="nav-number"></span> <span class="nav-text">pragma once一般由编译器提供保证：同一个文件不会被包含多次。这里所说的”同一个文件”是指物理上的一个文件，而不是指内容相同的两个文件。无法对一个头文件中的一段代码作#pragma once声明，而只能针对文件。此方式不会出现宏名碰撞引发的奇怪问题，大型项目的编译速度也因此提供了一些。缺点是如果某个头文件有多份拷贝，此方法不能保证它们不被重复包含。在C&#x2F;C++中，#pragma once是一个非标准但是被广泛支持的方式。</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1AST"><span class="nav-number">0.1.</span> <span class="nav-text">设计AST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E9%89%B4%E8%B5%8F"><span class="nav-number">0.2.</span> <span class="nav-text">代码鉴赏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Update"><span class="nav-number">1.</span> <span class="nav-text">Update</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lexical-scanning"><span class="nav-number">1.1.</span> <span class="nav-text">lexical scanning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parser"><span class="nav-number">1.2.</span> <span class="nav-text">parser</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#misc"><span class="nav-number">2.</span> <span class="nav-text">misc</span></a></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sekyoro"
      src="https://i.loli.net/2021/05/17/YqoavnXdGTpPO9R.jpg">
  <p class="site-author-name" itemprop="name">Sekyoro</p>
  <div class="site-description" itemprop="description">什么也无法舍弃的人，什么也做不了.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">104</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">138</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="http://proanimer.com/" title="Personal Website → http:&#x2F;&#x2F;proanimer.com" rel="noopener" target="_blank"><i class="fab fa-internet-explorer fa-fw"></i>Personal Website</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/drowning-in-codes" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;drowning-in-codes" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:bukalala174@gmail.com" title="E-Mail → mailto:bukalala174@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://mp.weixin.qq.com/s?__biz=Mzg3ODY1MDkzMg==&mid=2247483770&idx=1&sn=fdf88faab01d5c219ac609570a21c9d6&chksm=cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&token=1096259873&lang=zh_CN#rd" title="wxPublicAccount → https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;Mzg3ODY1MDkzMg&#x3D;&#x3D;&amp;mid&#x3D;2247483770&amp;idx&#x3D;1&amp;sn&#x3D;fdf88faab01d5c219ac609570a21c9d6&amp;chksm&#x3D;cf113221f866bb373938cfca03cf095ff4fe1e4dc37d68ef5de4cd4876ee1260fca0c015a4d6&amp;token&#x3D;1096259873&amp;lang&#x3D;zh_CN#rd" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>wxPublicAccount</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/aqwca" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;aqwca" rel="noopener" target="_blank"><i class="fa fa-handshake fa-fw"></i>CSDN</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://myqhs.top/" title="http:&#x2F;&#x2F;myqhs.top&#x2F;" rel="noopener" target="_blank">myqhs</a>
        </li>
    </ul>
  </div>

      </div>

<meting-js
	id="6856787487"
	server="netease"
	type="playlist"
	order="random"
	>
</meting-js>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="//music.163.com/outchain/player?type=0&id=6856787487&auto=0&height=90"></iframe>
		<br/>
		<script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=xQdGTxqARTBiNIwX2aUban-ixkj2s6VaZQWo-aVCgY8&cl=ffffff&w=a"></script>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
	 
	 <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4034523802263123"
     crossorigin="anonymous"></script>
<!-- 边栏 -->

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4034523802263123"
     data-ad-slot="6549565089"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
	 
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
	 
	
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
  


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Wed Apr 08 2020 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sekyoro</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">582k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:49</span>
</div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

<div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("04/08/2021 20:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>










<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




    <div id="pjax">
  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

    </div>  
<!-- hexo injector body_end start --><script src='/js/outdate.js'></script><!-- hexo injector body_end end --><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>